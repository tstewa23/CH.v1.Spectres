{"version":3,"file":"excalibur.min.js","mappings":"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l7F,IAAIo7F,EAAcC,EACnC,ECpDK,SAASC,KACd,IAOE,MAAMC,EAAO,KACL,EAER/iH,OAAOiX,IAAI4P,iBAAiB,OAAQk8F,GACpC/iH,OAAOiX,IAAIm7C,oBAAoB,OAAQ2wD,EACzC,CAAE,SACA,OAAO,CACT,CACA,OAAO,CACT,EFVA,SAAYR,GAEV,wBACA,wBACA,4BACA,8BACA,gBAGA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,gBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBACA,kBAEA,gBAEA,gCACA,kBACA,oBAGA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,WACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cACA,cAGA,gBACA,kBACA,gBACA,wBACA,gBAGA,oBACA,sBACA,YACA,sBACA,wBACA,sBACA,4BACA,4BACA,8BACA,gBACA,sBACA,wBACA,wBACA,0BACA,gBACA,YAEA,oBACA,sBACA,0BAGA,kBACA,YACA,cACA,cACA,kBACA,sBACA,kBAGA,eACA,mBACA,mBACA,qBAEA,oBACA,wBACA,wBACA,0BAGA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,oBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBACA,iBAEA,qBACA,wBAEA,6BACA,gCAEA,2BACA,8BAEA,yBACA,4BAEA,+BACA,kCAEA,+BACA,kCAKA,eACA,kBACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,UACA,YACA,YACA,YACA,YACA,YACA,YACA,YACA,YACA,YACA,YACA,YACA,4BACA,0BACA,gBAEA,6BACD,CAlND,CAAY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D31I,KAAK60I,SAASx6H,OAASra,KAAKutE,QAAQioE,aAAaE,UACjD,MAAM6B,EAAOv3I,KAAK60I,SAASn7H,WAAW,MACtC69H,SAAAA,EAAM/pH,UACJxtB,KAAKo3I,cACLp3I,KAAKo3I,cAAcj9H,MAAQna,KAAKutE,QAAQioE,aAAaG,YACrD,EACA31I,KAAK60I,SAAS16H,MACdna,KAAK60I,SAASx6H,OACd,EACA,EACAra,KAAK60I,SAAS16H,MACdna,KAAK60I,SAASx6H,QAIhBra,KAAK80I,SAAS36H,MAAQna,KAAKutE,QAAQioE,aAAaC,WAChDz1I,KAAK80I,SAASz6H,OAASra,KAAKutE,QAAQioE,aAAan7H,OAASra,KAAKutE,QAAQioE,aAAaE,UAAY11I,KAAKutE,QAAQioE,aAAaI,aAC1H,MAAM4B,EAAOx3I,KAAK80I,SAASp7H,WAAW,MACtC89H,SAAAA,EAAMhqH,UACJxtB,KAAKo3I,cACL,EACAp3I,KAAKutE,QAAQioE,aAAaE,UAC1B11I,KAAK80I,SAAS36H,MACdna,KAAK80I,SAASz6H,OACd,EACA,EACAra,KAAK80I,SAAS36H,MACdna,KAAK80I,SAASz6H,QAIhBra,KAAK+0I,SAAS56H,MAAQna,KAAKutE,QAAQioE,aAAar7H,MAAQna,KAAKutE,QAAQioE,aAAaC,WAAaz1I,KAAKutE,QAAQioE,aAAaG,YACzH31I,KAAK+0I,SAAS16H,OAASra,KAAKutE,QAAQioE,aAAan7H,OAASra,KAAKutE,QAAQioE,aAAaE,UAAY11I,KAAKutE,QAAQioE,aAAaI,aAC1H,MAAM6B,EAAOz3I,KAAK+0I,SAASr7H,WAAW,MACtC+9H,SAAAA,EAAMjqH,UACJxtB,KAAKo3I,cACLp3I,KAAKutE,QAAQioE,aAAaC,WAC1Bz1I,KAAKutE,QAAQioE,aAAaE,UAC1B11I,KAAK+0I,SAAS56H,MACdna,KAAK+0I,SAAS16H,OACd,EACA,EACAra,KAAK+0I,SAAS56H,MACdna,KAAK+0I,SAAS16H,QAIhBra,KAAKg1I,SAAS76H,MAAQna,KAAKutE,QAAQioE,aAAaG,YAChD31I,KAAKg1I,SAAS36H,OAASra,KAAKutE,QAAQioE,aAAan7H,OAASra,KAAKutE,QAAQioE,aAAaE,UAAY11I,KAAKutE,QAAQioE,aAAaI,aAC1H,MAAM8B,EAAO13I,KAAKg1I,SAASt7H,WAAW,MACtCg+H,SAAAA,EAAMlqH,UACJxtB,KAAKo3I,cAELp3I,KAAKutE,QAAQioE,aAAar7H,MAAQna,KAAKutE,QAAQioE,aAAaG,YAC5D31I,KAAKutE,QAAQioE,aAAaE,UAC1B11I,KAAKg1I,SAAS76H,MACdna,KAAKg1I,SAAS36H,OACd,EACA,EACAra,KAAKg1I,SAAS76H,MACdna,KAAKg1I,SAAS36H,QAIhBra,KAAKi1I,SAAS96H,MAAQna,KAAKutE,QAAQioE,aAAaC,WAChDz1I,KAAKi1I,SAAS56H,OAASra,KAAKutE,QAAQioE,aAAaI,aACjD,MAAM+B,EAAO33I,KAAKi1I,SAASv7H,WAAW,MACtCi+H,SAAAA,EAAMnqH,UACJxtB,KAAKo3I,cACL,EACAp3I,KAAKutE,QAAQioE,aAAan7H,OAASra,KAAKutE,QAAQioE,aAAaI,aAC7D51I,KAAKi1I,SAAS96H,MACdna,KAAKi1I,SAAS56H,OACd,EACA,EACAra,KAAKi1I,SAAS96H,MACdna,KAAKi1I,SAAS56H,QAIhBra,KAAKk1I,SAAS/6H,MAAQna,KAAKutE,QAAQioE,aAAar7H,MAAQna,KAAKutE,QAAQioE,aAAaC,WAAaz1I,KAAKutE,QAAQioE,aAAaG,YACzH31I,KAAKk1I,SAAS76H,OAASra,KAAKutE,QAAQioE,aAAaI,aACjD,MAAMgC,EAAO53I,KAAKk1I,SAASx7H,WAAW,MACtCk+H,SAAAA,EAAMpqH,UACJxtB,KAAKo3I,cACLp3I,KAAKutE,QAAQioE,aAAaC,WAC1Bz1I,KAAKutE,QAAQioE,aAAan7H,OAASra,KAAKutE,QAAQioE,aAAaI,aAC7D51I,KAAKk1I,SAAS/6H,MACdna,KAAKk1I,SAAS76H,OACd,EACA,EACAra,KAAKk1I,SAAS/6H,MACdna,KAAKk1I,SAAS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","sources":["webpack://ex/webpack/universalModuleDefinition","webpack://ex/./Director/Loader.css","webpack://ex/./Util/Toaster.css","webpack://ex/../../node_modules/css-loader/dist/runtime/api.js","webpack://ex/../../node_modules/css-loader/dist/runtime/sourceMaps.js","webpack://ex/webpack/bootstrap","webpack://ex/webpack/runtime/compat get default export","webpack://ex/webpack/runtime/define property getters","webpack://ex/webpack/runtime/hasOwnProperty shorthand","webpack://ex/webpack/runtime/make namespace object","webpack://ex/./Input/PointerScope.ts","webpack://ex/./Math/rotation-type.ts","webpack://ex/./Polyfill.ts","webpack://ex/./Flags.ts","webpack://ex/./Id.ts","webpack://ex/./Util/Future.ts","webpack://ex/./EventEmitter.ts","webpack://ex/./Math/Random.ts","webpack://ex/./Math/util.ts","webpack://ex/./Math/vector.ts","webpack://ex/./Color.ts","webpack://ex/./Util/Log.ts","webpack://ex/./Collision/Side.ts","webpack://ex/./Math/matrix.ts","webpack://ex/./Collision/BoundingBox.ts","webpack://ex/./Util/Util.ts","webpack://ex/./Math/affine-matrix.ts","webpack://ex/./Util/RentalPool.ts","webpack://ex/./Graphics/Context/transform-stack.ts","webpack://ex/./Graphics/Context/state-stack.ts","webpack://ex/./Resources/Resource.ts","webpack://ex/./Util/Watch.ts","webpack://ex/./Graphics/Graphic.ts","webpack://ex/./Graphics/Sprite.ts","webpack://ex/./Graphics/Filtering.ts","webpack://ex/./Graphics/Wrapping.ts","webpack://ex/./Graphics/Context/texture-loader.ts","webpack://ex/./Graphics/ImageSource.ts","webpack://ex/./Graphics/SpriteFont.ts","webpack://ex/./Graphics/TiledSprite.ts","webpack://ex/./Graphics/SpriteSheet.ts","webpack://ex/./Graphics/Context/debug-text.ts","webpack://ex/./Graphics/Context/debug-font.png","webpack://ex/./Graphics/Context/render-source.ts","webpack://ex/./Graphics/Context/render-target.ts","webpack://ex/./Graphics/Context/webgl-util.ts","webpack://ex/./Graphics/Context/shader.ts","webpack://ex/./Graphics/Context/vertex-buffer.ts","webpack://ex/./Graphics/Context/vertex-layout.ts","webpack://ex/./Graphics/GraphicsDiagnostics.ts","webpack://ex/./Graphics/Context/line-renderer/line-renderer.ts","webpack://ex/./Graphics/Context/line-renderer/line-vertex.glsl","webpack://ex/./Graphics/Context/line-renderer/line-fragment.glsl","webpack://ex/./Graphics/Context/point-renderer/point-renderer.ts","webpack://ex/./Graphics/Context/point-renderer/point-vertex.glsl","webpack://ex/./Graphics/Context/point-renderer/point-fragment.glsl","webpack://ex/./Graphics/Context/screen-pass-painter/screen-pass-painter.ts","webpack://ex/./Graphics/Context/screen-pass-painter/screen-vertex.glsl","webpack://ex/./Graphics/Context/screen-pass-painter/screen-fragment.glsl","webpack://ex/./Graphics/Context/quad-index-buffer.ts","webpack://ex/./Graphics/Context/image-renderer/image-renderer.ts","webpack://ex/./Graphics/Context/image-renderer/image-renderer.frag.glsl","webpack://ex/./Graphics/Context/image-renderer/image-renderer.vert.glsl","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.ts","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.frag.glsl","webpack://ex/./Graphics/Context/rectangle-renderer/rectangle-renderer.vert.glsl","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.ts","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.frag.glsl","webpack://ex/./Graphics/Context/circle-renderer/circle-renderer.vert.glsl","webpack://ex/./Util/Pool.ts","webpack://ex/./Graphics/Context/draw-call.ts","webpack://ex/./Graphics/Context/material.ts","webpack://ex/./Graphics/Context/material-renderer/material-renderer.ts","webpack://ex/./Math/coord-plane.ts","webpack://ex/./Graphics/Animation.ts","webpack://ex/./Math/vector-view.ts","webpack://ex/./Math/watch-vector.ts","webpack://ex/./Math/transform.ts","webpack://ex/./EntityComponentSystem/Component.ts","webpack://ex/./Util/Observable.ts","webpack://ex/./EntityComponentSystem/Components/TransformComponent.ts","webpack://ex/./Graphics/GraphicsGroup.ts","webpack://ex/./Graphics/Raster.ts","webpack://ex/./Graphics/FontCommon.ts","webpack://ex/./Events.ts","webpack://ex/./Util/DrawUtil.ts","webpack://ex/./Graphics/FontTextInstance.ts","webpack://ex/./Graphics/FontCache.ts","webpack://ex/./Graphics/Font.ts","webpack://ex/./Graphics/Text.ts","webpack://ex/./Graphics/GraphicsComponent.ts","webpack://ex/./EntityComponentSystem/Entity.ts","webpack://ex/./EntityComponentSystem/Components/MotionComponent.ts","webpack://ex/./Collision/Integrator.ts","webpack://ex/./Particles/Particles.ts","webpack://ex/./Graphics/Context/particle-renderer/particle-renderer.ts","webpack://ex/./Graphics/Context/particle-renderer/particle-vertex.glsl","webpack://ex/./Graphics/Context/particle-renderer/particle-fragment.glsl","webpack://ex/./Graphics/Context/image-renderer-v2/image-renderer-v2.ts","webpack://ex/./Graphics/Context/image-renderer-v2/image-renderer-v2.frag.glsl","webpack://ex/./Graphics/Context/image-renderer-v2/image-renderer-v2.vert.glsl","webpack://ex/./Graphics/Context/ExcaliburGraphicsContextWebGL.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContext2DCanvas.ts","webpack://ex/./Screen.ts","webpack://ex/./Resources/Sound/AudioContext.ts","webpack://ex/./Util/WebAudio.ts","webpack://ex/./Graphics/Canvas.ts","webpack://ex/./Interfaces/AudioImplementation.ts","webpack://ex/./Util/StateMachine.ts","webpack://ex/./Resources/Sound/WebAudioInstance.ts","webpack://ex/./Events/MediaEvents.ts","webpack://ex/./Util/Sound.ts","webpack://ex/./Resources/Sound/Sound.ts","webpack://ex/./Director/DefaultLoader.ts","webpack://ex/./Director/Loader.ts","webpack://ex/./Director/Loader.logo.png","webpack://ex/./Util/Detector.ts","webpack://ex/./Collision/CollisionType.ts","webpack://ex/./Collision/SolverStrategy.ts","webpack://ex/./Collision/Solver/ContactBias.ts","webpack://ex/./Collision/Group/CollisionGroupManager.ts","webpack://ex/./Collision/Group/CollisionGroup.ts","webpack://ex/./Collision/Detection/Pair.ts","webpack://ex/./Math/projection.ts","webpack://ex/./Collision/Detection/DynamicTree.ts","webpack://ex/./Math/ray.ts","webpack://ex/./Collision/Detection/DynamicTreeCollisionProcessor.ts","webpack://ex/./Collision/Colliders/Collider.ts","webpack://ex/./Collision/Detection/SpatialPartitionStrategy.ts","webpack://ex/./Collision/PhysicsConfig.ts","webpack://ex/./Collision/Colliders/CompositeCollider.ts","webpack://ex/./Math/line-segment.ts","webpack://ex/./Collision/Colliders/ClosestLineJumpTable.ts","webpack://ex/./Collision/Colliders/CircleCollider.ts","webpack://ex/./Collision/Detection/CollisionContact.ts","webpack://ex/./Collision/Colliders/SeparatingAxis.ts","webpack://ex/./Collision/Colliders/CollisionJumpTable.ts","webpack://ex/./Collision/Colliders/EdgeCollider.ts","webpack://ex/./Graphics/Debug.ts","webpack://ex/./Collision/Colliders/PolygonCollider.ts","webpack://ex/./Collision/Colliders/Shape.ts","webpack://ex/./Collision/ColliderComponent.ts","webpack://ex/./Collision/BodyComponent.ts","webpack://ex/./Graphics/Rectangle.ts","webpack://ex/./Graphics/Circle.ts","webpack://ex/./Input/PointerComponent.ts","webpack://ex/./Util/EasingFunctions.ts","webpack://ex/./Actions/ActionQueue.ts","webpack://ex/./Actions/Action.ts","webpack://ex/./Actions/Action/Repeat.ts","webpack://ex/./Actions/Action/RepeatForever.ts","webpack://ex/./Math/lerp.ts","webpack://ex/./Actions/Action/MoveBy.ts","webpack://ex/./Actions/Action/MoveTo.ts","webpack://ex/./Actions/Action/RotateTo.ts","webpack://ex/./Actions/Action/RotateBy.ts","webpack://ex/./Actions/Action/ScaleTo.ts","webpack://ex/./Actions/Action/ScaleBy.ts","webpack://ex/./Actions/Action/CallMethod.ts","webpack://ex/./Actions/Action/EaseTo.ts","webpack://ex/./Actions/Action/EaseBy.ts","webpack://ex/./Actions/Action/Blink.ts","webpack://ex/./Actions/Action/Fade.ts","webpack://ex/./Actions/Action/Delay.ts","webpack://ex/./Actions/Action/Die.ts","webpack://ex/./Actions/Action/Follow.ts","webpack://ex/./Actions/Action/Meet.ts","webpack://ex/./Actions/Action/Flash.ts","webpack://ex/./Math/bezier-curve.ts","webpack://ex/./Actions/Action/CurveTo.ts","webpack://ex/./Actions/Action/CurveBy.ts","webpack://ex/./Actions/ActionContext.ts","webpack://ex/./Actions/ActionsComponent.ts","webpack://ex/./Actor.ts","webpack://ex/./ScreenElement.ts","webpack://ex/./Timer.ts","webpack://ex/./Graphics/ParallaxComponent.ts","webpack://ex/./Graphics/DebugGraphicsComponent.ts","webpack://ex/./Input/PointerEventsToObjectDispatcher.ts","webpack://ex/./TileMap/TileMap.ts","webpack://ex/./Camera.ts","webpack://ex/./Trigger.ts","webpack://ex/./EntityComponentSystem/Priority.ts","webpack://ex/./EntityComponentSystem/System.ts","webpack://ex/./EntityComponentSystem/EntityManager.ts","webpack://ex/./EntityComponentSystem/Query.ts","webpack://ex/./EntityComponentSystem/TagQuery.ts","webpack://ex/./EntityComponentSystem/QueryManager.ts","webpack://ex/./EntityComponentSystem/SystemManager.ts","webpack://ex/./EntityComponentSystem/World.ts","webpack://ex/./Collision/MotionSystem.ts","webpack://ex/./Collision/Solver/ArcadeSolver.ts","webpack://ex/./Collision/Solver/ContactConstraintPoint.ts","webpack://ex/./Collision/Solver/RealisticSolver.ts","webpack://ex/./Collision/CollisionSystem.ts","webpack://ex/./Graphics/TransformInterpolation.ts","webpack://ex/./Graphics/GraphicsSystem.ts","webpack://ex/./Debug/DebugSystem.ts","webpack://ex/./Collision/Detection/SparseHashGrid.ts","webpack://ex/./Input/PointerSystem.ts","webpack://ex/./Actions/ActionsSystem.ts","webpack://ex/./TileMap/IsometricEntityComponent.ts","webpack://ex/./TileMap/IsometricEntitySystem.ts","webpack://ex/./Graphics/OffscreenSystem.ts","webpack://ex/./Collision/Detection/SparseHashGridCollisionProcessor.ts","webpack://ex/./Collision/PhysicsWorld.ts","webpack://ex/./Input/Gamepad.ts","webpack://ex/./Input/Keyboard.ts","webpack://ex/./Input/InputMapper.ts","webpack://ex/./Util/IFrame.ts","webpack://ex/./Math/global-coordinates.ts","webpack://ex/./Input/PointerEvent.ts","webpack://ex/./Input/WheelEvent.ts","webpack://ex/./Input/PointerAbstraction.ts","webpack://ex/./Input/WheelDeltaMode.ts","webpack://ex/./Input/NativePointerButton.ts","webpack://ex/./Input/PointerButton.ts","webpack://ex/./Input/PointerType.ts","webpack://ex/./Input/PointerEventReceiver.ts","webpack://ex/./Input/InputHost.ts","webpack://ex/./Scene.ts","webpack://ex/./Graphics/PostProcessor/ColorBlindnessMode.ts","webpack://ex/./Graphics/PostProcessor/ScreenShader.ts","webpack://ex/./Graphics/PostProcessor/ColorBlindnessPostProcessor.ts","webpack://ex/./Graphics/PostProcessor/color-blind-fragment.glsl","webpack://ex/./Debug/DebugFlags.ts","webpack://ex/./Debug/DebugConfig.ts","webpack://ex/./Util/Browser.ts","webpack://ex/./Graphics/Context/ExcaliburGraphicsContext.ts","webpack://ex/./Util/Fps.ts","webpack://ex/./Util/Clock.ts","webpack://ex/./Util/Toaster.ts","webpack://ex/./Director/Director.ts","webpack://ex/./Context.ts","webpack://ex/./GarbageCollector.ts","webpack://ex/./Engine.ts","webpack://ex/./Particles/EmitterType.ts","webpack://ex/./Label.ts","webpack://ex/./Particles/ParticleEmitter.ts","webpack://ex/./Util/Assert.ts","webpack://ex/./Particles/GpuParticleRenderer.ts","webpack://ex/./Particles/GpuParticleEmitter.ts","webpack://ex/./TileMap/IsometricMap.ts","webpack://ex/./Actions/Action/ActionSequence.ts","webpack://ex/./Actions/Action/ParallelActions.ts","webpack://ex/./Collision/Detection/QuadTree.ts","webpack://ex/./Interfaces/LifecycleEvents.ts","webpack://ex/./Resources/Gif.ts","webpack://ex/./Resources/Font.ts","webpack://ex/./Util/Coroutine.ts","webpack://ex/./Director/Transition.ts","webpack://ex/./Director/FadeInOut.ts","webpack://ex/./Director/CrossFade.ts","webpack://ex/./Director/Slide.ts","webpack://ex/./Graphics/Line.ts","webpack://ex/./Graphics/Polygon.ts","webpack://ex/./Graphics/NineSlice.ts","webpack://ex/./Graphics/TiledAnimation.ts","webpack://ex/./Util/Decorators.ts","webpack://ex/./Util/Semaphore.ts","webpack://ex/./index.ts"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ex\"] = factory();\n\telse\n\t\troot[\"ex\"] = factory();\n})(self, () => {\nreturn ","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, `/* Buttons styles start */\r\n\r\nbutton#excalibur-play {\r\n  display: inline-block;\r\n  position: relative;\r\n  z-index: 999;\r\n  border-radius: 6px;\r\n  border: none;\r\n  /*border: 3px solid;\r\n    border-color: white;\r\n    box-shadow: 0 0 10px #ccc;*/\r\n  padding: 1rem 1.5rem 1rem 4rem;\r\n  margin: 0;\r\n  text-decoration: none;\r\n  background: #00b233;\r\n  color: #ffffff;\r\n  font-family: sans-serif;\r\n  font-size: 2rem;\r\n  white-space: nowrap;\r\n  line-height: 1;\r\n  cursor: pointer;\r\n  text-align: center;\r\n  transition:\r\n    background 250ms ease-in-out,\r\n    transform 150ms ease;\r\n  -webkit-appearance: none;\r\n  -moz-appearance: none;\r\n\r\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r\n  animation: excalibur-button-fadein 200ms;\r\n}\r\n\r\n/*\r\nbutton#excalibur-play {\r\n  display: none;\r\n}*/\r\n\r\nbutton#excalibur-play:after {\r\n  position: absolute;\r\n  content: '';\r\n  border: 8px solid;\r\n  border-color: transparent transparent transparent white;\r\n  left: 35px;\r\n  top: 24px;\r\n  width: 0;\r\n  height: 0;\r\n}\r\n\r\nbutton#excalibur-play:before {\r\n  position: absolute;\r\n  content: '';\r\n  border: 3px solid;\r\n  left: 19px;\r\n  top: 14px;\r\n  border-radius: 20px;\r\n  width: 30px;\r\n  height: 30px;\r\n}\r\n\r\nbutton#excalibur-play:hover,\r\nbutton#excalibur-play:focus {\r\n  background: #00982c;\r\n}\r\n\r\nbutton#excalibur-play:focus {\r\n  outline: 1px solid #fff;\r\n  outline-offset: -4px;\r\n}\r\n\r\nbutton#excalibur-play:active {\r\n  transform: scale(0.99);\r\n}\r\n\r\n@keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Firefox < 16 */\r\n@-moz-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Safari, Chrome and Opera > 12.1 */\r\n@-webkit-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Internet Explorer */\r\n@-ms-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n/* Opera < 12.1 */\r\n@-o-keyframes excalibur-button-fadein {\r\n  from {\r\n    opacity: 0;\r\n  }\r\n  to {\r\n    opacity: 1;\r\n  }\r\n}\r\n`, \"\",{\"version\":3,\"sources\":[\"webpack://./Director/Loader.css\"],\"names\":[],\"mappings\":\"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF\",\"sourcesContent\":[\"/* Buttons styles start */\\r\\n\\r\\nbutton#excalibur-play {\\r\\n  display: inline-block;\\r\\n  position: relative;\\r\\n  z-index: 999;\\r\\n  border-radius: 6px;\\r\\n  border: none;\\r\\n  /*border: 3px solid;\\r\\n    border-color: white;\\r\\n    box-shadow: 0 0 10px #ccc;*/\\r\\n  padding: 1rem 1.5rem 1rem 4rem;\\r\\n  margin: 0;\\r\\n  text-decoration: none;\\r\\n  background: #00b233;\\r\\n  color: #ffffff;\\r\\n  font-family: sans-serif;\\r\\n  font-size: 2rem;\\r\\n  white-space: nowrap;\\r\\n  line-height: 1;\\r\\n  cursor: pointer;\\r\\n  text-align: center;\\r\\n  transition:\\r\\n    background 250ms ease-in-out,\\r\\n    transform 150ms ease;\\r\\n  -webkit-appearance: none;\\r\\n  -moz-appearance: none;\\r\\n\\r\\n  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\\r\\n  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\\r\\n  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\\r\\n  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\\r\\n  animation: excalibur-button-fadein 200ms;\\r\\n}\\r\\n\\r\\n/*\\r\\nbutton#excalibur-play {\\r\\n  display: none;\\r\\n}*/\\r\\n\\r\\nbutton#excalibur-play:after {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 8px solid;\\r\\n  border-color: transparent transparent transparent white;\\r\\n  left: 35px;\\r\\n  top: 24px;\\r\\n  width: 0;\\r\\n  height: 0;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:before {\\r\\n  position: absolute;\\r\\n  content: '';\\r\\n  border: 3px solid;\\r\\n  left: 19px;\\r\\n  top: 14px;\\r\\n  border-radius: 20px;\\r\\n  width: 30px;\\r\\n  height: 30px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:hover,\\r\\nbutton#excalibur-play:focus {\\r\\n  background: #00982c;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:focus {\\r\\n  outline: 1px solid #fff;\\r\\n  outline-offset: -4px;\\r\\n}\\r\\n\\r\\nbutton#excalibur-play:active {\\r\\n  transform: scale(0.99);\\r\\n}\\r\\n\\r\\n@keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Firefox < 16 */\\r\\n@-moz-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Safari, Chrome and Opera > 12.1 */\\r\\n@-webkit-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Internet Explorer */\\r\\n@-ms-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\\r\\n/* Opera < 12.1 */\\r\\n@-o-keyframes excalibur-button-fadein {\\r\\n  from {\\r\\n    opacity: 0;\\r\\n  }\\r\\n  to {\\r\\n    opacity: 1;\\r\\n  }\\r\\n}\\r\\n\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","// Imports\nimport ___CSS_LOADER_API_SOURCEMAP_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/sourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, `#ex-toast-container {\r\n  position: absolute;\r\n  height: 0;\r\n  min-width: 50%;\r\n  left: 50%;\r\n  top: 0;\r\n}\r\n\r\n.ex-toast-message {\r\n  left: -50%;\r\n  position: relative;\r\n  display: flex;\r\n  justify-content: space-between;\r\n\r\n  padding: 10px;\r\n  margin-top: 5px;\r\n  font-size: 18px;\r\n  font-family: sans-serif;\r\n  border-radius: 6px;\r\n  border: 3px solid #b7b779;\r\n  background-color: rgb(253, 253, 192);\r\n}\r\n\r\n.ex-toast-message button {\r\n  align-self: flex-start;\r\n}\r\n`, \"\",{\"version\":3,\"sources\":[\"webpack://./Util/Toaster.css\"],\"names\":[],\"mappings\":\"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB\",\"sourcesContent\":[\"#ex-toast-container {\\r\\n  position: absolute;\\r\\n  height: 0;\\r\\n  min-width: 50%;\\r\\n  left: 50%;\\r\\n  top: 0;\\r\\n}\\r\\n\\r\\n.ex-toast-message {\\r\\n  left: -50%;\\r\\n  position: relative;\\r\\n  display: flex;\\r\\n  justify-content: space-between;\\r\\n\\r\\n  padding: 10px;\\r\\n  margin-top: 5px;\\r\\n  font-size: 18px;\\r\\n  font-family: sans-serif;\\r\\n  border-radius: 6px;\\r\\n  border: 3px solid #b7b779;\\r\\n  background-color: rgb(253, 253, 192);\\r\\n}\\r\\n\\r\\n.ex-toast-message button {\\r\\n  align-self: flex-start;\\r\\n}\\r\\n\"],\"sourceRoot\":\"\"}]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","\"use strict\";\n\n/*\n  MIT License http://www.opensource.org/licenses/mit-license.php\n  Author Tobias Koppers @sokra\n*/\nmodule.exports = function (cssWithMappingToString) {\n  var list = [];\n\n  // return the list of modules as css string\n  list.toString = function toString() {\n    return this.map(function (item) {\n      var content = \"\";\n      var needLayer = typeof item[5] !== \"undefined\";\n      if (item[4]) {\n        content += \"@supports (\".concat(item[4], \") {\");\n      }\n      if (item[2]) {\n        content += \"@media \".concat(item[2], \" {\");\n      }\n      if (needLayer) {\n        content += \"@layer\".concat(item[5].length > 0 ? \" \".concat(item[5]) : \"\", \" {\");\n      }\n      content += cssWithMappingToString(item);\n      if (needLayer) {\n        content += \"}\";\n      }\n      if (item[2]) {\n        content += \"}\";\n      }\n      if (item[4]) {\n        content += \"}\";\n      }\n      return content;\n    }).join(\"\");\n  };\n\n  // import a list of modules into the list\n  list.i = function i(modules, media, dedupe, supports, layer) {\n    if (typeof modules === \"string\") {\n      modules = [[null, modules, undefined]];\n    }\n    var alreadyImportedModules = {};\n    if (dedupe) {\n      for (var k = 0; k < this.length; k++) {\n        var id = this[k][0];\n        if (id != null) {\n          alreadyImportedModules[id] = true;\n        }\n      }\n    }\n    for (var _k = 0; _k < modules.length; _k++) {\n      var item = [].concat(modules[_k]);\n      if (dedupe && alreadyImportedModules[item[0]]) {\n        continue;\n      }\n      if (typeof layer !== \"undefined\") {\n        if (typeof item[5] === \"undefined\") {\n          item[5] = layer;\n        } else {\n          item[1] = \"@layer\".concat(item[5].length > 0 ? \" \".concat(item[5]) : \"\", \" {\").concat(item[1], \"}\");\n          item[5] = layer;\n        }\n      }\n      if (media) {\n        if (!item[2]) {\n          item[2] = media;\n        } else {\n          item[1] = \"@media \".concat(item[2], \" {\").concat(item[1], \"}\");\n          item[2] = media;\n        }\n      }\n      if (supports) {\n        if (!item[4]) {\n          item[4] = \"\".concat(supports);\n        } else {\n          item[1] = \"@supports (\".concat(item[4], \") {\").concat(item[1], \"}\");\n          item[4] = supports;\n        }\n      }\n      list.push(item);\n    }\n  };\n  return list;\n};","\"use strict\";\n\nmodule.exports = function (item) {\n  var content = item[1];\n  var cssMapping = item[3];\n  if (!cssMapping) {\n    return content;\n  }\n  if (typeof btoa === \"function\") {\n    var base64 = btoa(unescape(encodeURIComponent(JSON.stringify(cssMapping))));\n    var data = \"sourceMappingURL=data:application/json;charset=utf-8;base64,\".concat(base64);\n    var sourceMapping = \"/*# \".concat(data, \" */\");\n    return [content].concat([sourceMapping]).join(\"\\n\");\n  }\n  return [content].join(\"\\n\");\n};","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\tid: moduleId,\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","/**\n * Determines the scope of handling mouse/touch events.\n */\n\nexport enum PointerScope {\n  /**\n   * Handle events on the `canvas` element only. Events originating outside the\n   * `canvas` will not be handled.\n   */\n  Canvas = 'Canvas',\n\n  /**\n   * Handles events on the entire document. All events will be handled by Excalibur.\n   */\n  Document = 'Document'\n}\n","/**\r\n * An enum that describes the strategies that rotation actions can use\r\n */\r\nexport enum RotationType {\r\n  /**\r\n   * Rotation via `ShortestPath` will use the smallest angle\r\n   * between the starting and ending points. This strategy is the default behavior.\r\n   */\r\n  ShortestPath = 'shortest-path',\r\n  /**\r\n   * Rotation via `LongestPath` will use the largest angle\r\n   * between the starting and ending points.\r\n   */\r\n  LongestPath = 'longest-path',\r\n  /**\r\n   * Rotation via `Clockwise` will travel in a clockwise direction,\r\n   * regardless of the starting and ending points.\r\n   */\r\n  Clockwise = 'clockwise',\r\n  /**\r\n   * Rotation via `CounterClockwise` will travel in a counterclockwise direction,\r\n   * regardless of the starting and ending points.\r\n   */\r\n  CounterClockwise = 'counter-clockwise'\r\n}\r\n","/**\r\n * Polyfill adding function\r\n */\r\nexport function polyfill() {\r\n  /* istanbul ignore next */\r\n  if (typeof window === 'undefined') {\r\n    window = <any>{\r\n      audioContext: function () {\r\n        return;\r\n      }\r\n    };\r\n  }\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !window.requestAnimationFrame) {\r\n    (<any>window).requestAnimationFrame =\r\n      (<any>window).webkitRequestAnimationFrame ||\r\n      (<any>window).mozRequestAnimationFrame ||\r\n      function (callback: Function) {\r\n        window.setInterval(callback, 1000 / 60);\r\n      };\r\n  }\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !window.cancelAnimationFrame) {\r\n    (<any>window).cancelAnimationFrame =\r\n      (<any>window).webkitCancelAnimationFrame ||\r\n      (<any>window).mozCancelAnimationFrame ||\r\n      function () {\r\n        return;\r\n      };\r\n  }\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !(<any>window).AudioContext) {\r\n    if ((<any>window).webkitAudioContext) {\r\n      const ctx = (<any>window).webkitAudioContext;\r\n      const replaceMe = ctx.prototype.decodeAudioData;\r\n      (<any>window).webkitAudioContext.prototype.decodeAudioData = function (arrayBuffer: ArrayBuffer) {\r\n        return new Promise((resolve, reject) => {\r\n          replaceMe.call(this, arrayBuffer, resolve, reject);\r\n        });\r\n      };\r\n    }\r\n\r\n    (<any>window).AudioContext =\r\n      (<any>window).AudioContext ||\r\n      (<any>window).webkitAudioContext ||\r\n      (<any>window).mozAudioContext ||\r\n      (<any>window).msAudioContext ||\r\n      (<any>window).oAudioContext;\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !(<any>window).devicePixelRatio) {\r\n    (<any>window).devicePixelRatio = window.devicePixelRatio || 1;\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  if (typeof window !== 'undefined' && !(window as any).requestIdleCallback) {\r\n    // Adapted from https://developer.chrome.com/blog/using-requestidlecallback#checking_for_requestidlecallback\r\n    (window as any).requestIdleCallback =\r\n      window.requestIdleCallback ||\r\n      function (cb: (args: any) => any) {\r\n        const start = Date.now();\r\n        return setTimeout(function () {\r\n          cb({\r\n            didTimeout: false,\r\n            timeRemaining: function () {\r\n              return Math.max(0, 50 - (Date.now() - start));\r\n            }\r\n          });\r\n        }, 1);\r\n      };\r\n\r\n    (window as any).cancelIdleCallback =\r\n      window.cancelIdleCallback ||\r\n      function (id: any) {\r\n        clearTimeout(id);\r\n      };\r\n  }\r\n}\r\n","/**\r\n * Flags is a feature flag implementation for Excalibur. They can only be operated **before {@apilink Engine} construction**\r\n * after which they are frozen and are read-only.\r\n *\r\n * Flags are used to enable experimental or preview features in Excalibur.\r\n */\r\nexport class Flags {\r\n  private static _FROZEN = false;\r\n  private static _FLAGS: Record<string, boolean> = {};\r\n\r\n  /**\r\n   * Force excalibur to load the Canvas 2D graphics context fallback\r\n   * @warning not all features of excalibur are supported in the Canvas 2D fallback\r\n   */\r\n  public static useCanvasGraphicsContext() {\r\n    Flags.enable('use-canvas-context');\r\n  }\r\n\r\n  /**\r\n   * Force excalibur to use the less optimized image renderer\r\n   */\r\n  public static useLegacyImageRenderer() {\r\n    Flags.enable('use-legacy-image-renderer');\r\n  }\r\n\r\n  /**\r\n   * Freeze all flag modifications making them readonly\r\n   */\r\n  public static freeze() {\r\n    Flags._FROZEN = true;\r\n  }\r\n\r\n  /**\r\n   * Resets internal flag state, not meant to be called by users. Only used for testing.\r\n   *\r\n   * Calling this in your game is UNSUPPORTED\r\n   * @internal\r\n   */\r\n  public static _reset() {\r\n    Flags._FROZEN = false;\r\n    Flags._FLAGS = {};\r\n  }\r\n  /**\r\n   * Enable a specific feature flag by name. **Note: can only be set before {@apilink Engine} constructor time**\r\n   * @param flagName\r\n   */\r\n  public static enable(flagName: string): void {\r\n    if (this._FROZEN) {\r\n      throw Error('Feature flags can only be enabled before Engine constructor time');\r\n    }\r\n    Flags._FLAGS[flagName] = true;\r\n  }\r\n\r\n  /**\r\n   * Disable a specific feature flag by name. **Note: can only be set before {@apilink Engine} constructor time**\r\n   * @param flagName\r\n   */\r\n  public static disable(flagName: string): void {\r\n    if (this._FROZEN) {\r\n      throw Error('Feature flags can only be disabled before Engine constructor time');\r\n    }\r\n    Flags._FLAGS[flagName] = false;\r\n  }\r\n\r\n  /**\r\n   * Check if a flag is enabled. If the flag is disabled or does not exist `false` is returned\r\n   * @param flagName\r\n   */\r\n  public static isEnabled(flagName: string): boolean {\r\n    return !!Flags._FLAGS[flagName];\r\n  }\r\n\r\n  /**\r\n   * Show a list of currently known flags\r\n   */\r\n  public static show(): string[] {\r\n    return Object.keys(Flags._FLAGS);\r\n  }\r\n}\r\n","export type Id<T extends string> = {\r\n  type: T;\r\n  value: number;\r\n};\r\n\r\n/**\r\n * Create a branded ID type from a number\r\n */\r\nexport function createId<T extends string>(type: T, value: number): Id<T> {\r\n  return { type, value };\r\n}\r\n","/**\r\n * Future is a wrapper around a native browser Promise to allow resolving/rejecting at any time\r\n */\r\nexport class Future<T> {\r\n  // Code from StephenCleary https://gist.github.com/StephenCleary/ba50b2da419c03b9cba1d20cb4654d5e\r\n  private _resolver: (value: T) => void;\r\n  private _rejecter: (error: Error) => void;\r\n  private _isCompleted: boolean = false;\r\n\r\n  constructor() {\r\n    this.promise = new Promise((resolve, reject) => {\r\n      this._resolver = resolve;\r\n      this._rejecter = reject;\r\n    });\r\n  }\r\n\r\n  public readonly promise: Promise<T>;\r\n\r\n  public get isCompleted(): boolean {\r\n    return this._isCompleted;\r\n  }\r\n\r\n  public resolve(value: T): void {\r\n    if (this._isCompleted) {\r\n      return;\r\n    }\r\n    this._isCompleted = true;\r\n    this._resolver(value);\r\n  }\r\n\r\n  public reject(error: Error): void {\r\n    if (this._isCompleted) {\r\n      return;\r\n    }\r\n    this._isCompleted = true;\r\n    this._rejecter(error);\r\n  }\r\n}\r\n","export type EventMap = Record<string, any>;\r\nexport type EventKey<T extends EventMap> = string & keyof T;\r\nexport type Handler<EventType> = (event: EventType) => void;\r\n\r\n/**\r\n * Interface that represents a handle to a subscription that can be closed\r\n */\r\nexport interface Subscription {\r\n  /**\r\n   * Removes the associated event handler, synonymous with events.off(...);\r\n   */\r\n  close(): void;\r\n}\r\n\r\n/**\r\n * Excalibur's typed event emitter, this allows events to be sent with any string to Type mapping\r\n */\r\nexport class EventEmitter<TEventMap extends EventMap = any> {\r\n  private _paused = false;\r\n  private _empty = true;\r\n  private _listeners: Record<string, Handler<any>[]> = {};\r\n  private _listenersOnce: Record<string, Handler<any>[]> = {};\r\n  private _pipes: EventEmitter<any>[] = [];\r\n\r\n  /**\r\n   * Removes all listeners and pipes\r\n   */\r\n  clear() {\r\n    this._listeners = {};\r\n    this._listenersOnce = {};\r\n    this._pipes.length = 0;\r\n    this._empty = true;\r\n  }\r\n\r\n  on<TEventName extends EventKey<TEventMap>>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription;\r\n  on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  on<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription {\r\n    this._empty = false;\r\n    this._listeners[eventName] = this._listeners[eventName] ?? [];\r\n    this._listeners[eventName].push(handler);\r\n    return {\r\n      close: () => this.off(eventName, handler)\r\n    };\r\n  }\r\n\r\n  once<TEventName extends EventKey<TEventMap>>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription;\r\n  once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  once<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): Subscription {\r\n    this._empty = false;\r\n    this._listenersOnce[eventName] = this._listenersOnce[eventName] ?? [];\r\n    this._listenersOnce[eventName].push(handler);\r\n    return {\r\n      close: () => this.off(eventName, handler)\r\n    };\r\n  }\r\n\r\n  off<TEventName extends EventKey<TEventMap>>(eventName: TEventName, handler: Handler<TEventMap[TEventName]>): void;\r\n  off(eventName: string, handler: Handler<unknown>): void;\r\n  off(eventName: string): void;\r\n  off<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, handler?: Handler<TEventMap[TEventName]>): void {\r\n    if (handler) {\r\n      const newListeners = this._listeners[eventName]?.filter((h) => h !== handler);\r\n      this._listeners[eventName] = newListeners;\r\n\r\n      const newOnceListeners = this._listenersOnce[eventName]?.filter((h) => h !== handler);\r\n      this._listenersOnce[eventName] = newOnceListeners;\r\n    } else {\r\n      delete this._listeners[eventName];\r\n    }\r\n  }\r\n\r\n  emit<TEventName extends EventKey<TEventMap>>(eventName: TEventName, event: TEventMap[TEventName]): void;\r\n  emit(eventName: string, event?: any): void;\r\n  emit<TEventName extends EventKey<TEventMap> | string>(eventName: TEventName, event?: TEventMap[TEventName]): void {\r\n    if (this._empty) {\r\n      return;\r\n    }\r\n    if (this._paused) {\r\n      return;\r\n    }\r\n    const listeners = this._listeners[eventName];\r\n    if (listeners) {\r\n      for (let i = 0; i < listeners.length; i++) {\r\n        listeners[i](event);\r\n      }\r\n    }\r\n    const onces = this._listenersOnce[eventName];\r\n    this._listenersOnce[eventName] = [];\r\n    if (onces) {\r\n      for (let i = 0; i < onces.length; i++) {\r\n        onces[i](event);\r\n      }\r\n    }\r\n    for (let i = 0; i < this._pipes.length; i++) {\r\n      this._pipes[i].emit(eventName, event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Replay events from this emitter to another\r\n   * @param emitter\r\n   */\r\n  pipe(emitter: EventEmitter<any>): Subscription {\r\n    if (this === emitter) {\r\n      throw Error('Cannot pipe to self');\r\n    }\r\n    this._empty = false;\r\n    this._pipes.push(emitter);\r\n    return {\r\n      close: () => {\r\n        const i = this._pipes.indexOf(emitter);\r\n        if (i > -1) {\r\n          this._pipes.splice(i, 1);\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Remove any piped emitters\r\n   * @param emitter\r\n   */\r\n  unpipe(emitter: EventEmitter<any>): void {\r\n    const i = this._pipes.indexOf(emitter);\r\n    if (i > -1) {\r\n      this._pipes.splice(i, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Paused event emitters do not emit events\r\n   */\r\n  pause(): void {\r\n    this._paused = true;\r\n  }\r\n\r\n  /**\r\n   * Unpaused event emitter do emit events\r\n   */\r\n  unpause(): void {\r\n    this._paused = false;\r\n  }\r\n}\r\n","/**\r\n * @module\r\n * Pseudo-Random Utility\r\n *\r\n * A pseudo-random utility to add seeded random support for help in\r\n * generating things like terrain or reproducible randomness. Uses the\r\n * [Mersenne Twister](https://en.wikipedia.org/wiki/Mersenne_Twister) algorithm.\r\n */\r\n\r\n/**\r\n * 32-bit mask\r\n */\r\nconst BITMASK32: number = 0xffffffff;\r\n\r\n/**\r\n * Pseudo-random number generator following the Mersenne_Twister algorithm. Given a seed this generator will produce the same sequence\r\n * of numbers each time it is called.\r\n * See https://en.wikipedia.org/wiki/Mersenne_Twister for more details.\r\n * Uses the MT19937-32 (2002) implementation documented here http://www.math.sci.hiroshima-u.ac.jp/~m-mat/MT/MT2002/emt19937ar.html\r\n *\r\n * Api inspired by http://chancejs.com/# https://github.com/chancejs/chancejs\r\n */\r\nexport class Random {\r\n  // Separation point of one one word, the number of bits in the lower bitmask 0 <= r <= w-1\r\n  private _lowerMask: number = 0x7fffffff; // 31 bits same as _r\r\n  private _upperMask: number = 0x80000000; // 34 high bits\r\n\r\n  // Word size, 64 bits\r\n  private _w: number = 32;\r\n\r\n  // Degree of recurrence\r\n  private _n: number = 624;\r\n\r\n  // Middle word, an offset used in the recurrence defining the series x, 1<=m<n\r\n  private _m: number = 397;\r\n  // coefficients of teh rational normal form twist matrix\r\n  private _a: number = 0x9908b0df;\r\n\r\n  // tempering bit shifts and masks\r\n  private _u: number = 11;\r\n  private _s: number = 7;\r\n  private _b: number = 0x9d2c5680;\r\n  private _t: number = 15;\r\n  private _c: number = 0xefc60000;\r\n  private _l: number = 18;\r\n  private _f: number = 1812433253;\r\n\r\n  private _mt: number[];\r\n\r\n  private _index: number;\r\n\r\n  /**\r\n   * If no seed is specified, the Date.now() is used\r\n   */\r\n  constructor(public seed?: number) {\r\n    this._mt = new Array<number>(this._n);\r\n    // need to mask to support higher bit machines\r\n    this._mt[0] = (seed || Date.now()) >>> 0;\r\n\r\n    for (let i = 1; i < this._n; i++) {\r\n      const s = this._mt[i - 1] ^ (this._mt[i - 1] >>> (this._w - 2));\r\n      // numbers are bigger than the JS max safe int, add in 16-bit chunks to prevent IEEE rounding errors on high bits\r\n      this._mt[i] = (((this._f * ((s & 0xffff0000) >>> 16)) << 16) + this._f * (s & 0xffff) + i) >>> 0;\r\n    }\r\n    this._index = this._n;\r\n  }\r\n\r\n  /**\r\n   * Apply the twist\r\n   */\r\n  private _twist(): void {\r\n    const mag01 = [0x0, this._a];\r\n    let y = 0,\r\n      i = 0;\r\n    for (; i < this._n - this._m; i++) {\r\n      y = (this._mt[i] & this._upperMask) | (this._mt[i + 1] & this._lowerMask);\r\n      this._mt[i] = this._mt[i + this._m] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\r\n    }\r\n    for (; i < this._n - 1; i++) {\r\n      y = (this._mt[i] & this._upperMask) | (this._mt[i + 1] & this._lowerMask);\r\n      this._mt[i] = this._mt[i + (this._m - this._n)] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\r\n    }\r\n    y = (this._mt[this._n - 1] & this._upperMask) | (this._mt[0] & this._lowerMask);\r\n    this._mt[this._n - 1] = this._mt[this._m - 1] ^ (y >>> 1) ^ (mag01[y & 0x1] & BITMASK32);\r\n\r\n    this._index = 0;\r\n  }\r\n\r\n  /**\r\n   * Return next 32 bit integer number in sequence\r\n   */\r\n  public nextInt(): number {\r\n    if (this._index >= this._n) {\r\n      this._twist();\r\n    }\r\n\r\n    let y = this._mt[this._index++];\r\n\r\n    y ^= y >>> this._u;\r\n    y ^= (y << this._s) & this._b;\r\n    y ^= (y << this._t) & this._c;\r\n    y ^= y >>> this._l;\r\n\r\n    return y >>> 0;\r\n  }\r\n\r\n  /**\r\n   * Return a random floating point number between [0, 1)\r\n   */\r\n  public next(): number {\r\n    return this.nextInt() * (1.0 / 4294967296.0); // divided by 2^32\r\n  }\r\n\r\n  /**\r\n   * Return a random floating point in range [min, max) min is included, max is not included\r\n   */\r\n  public floating(min: number, max: number): number {\r\n    return (max - min) * this.next() + min;\r\n  }\r\n\r\n  /**\r\n   * Return a random integer in range [min, max] min is included, max is included.\r\n   * Implemented with rejection sampling, see https://medium.com/@betable/tifu-by-using-math-random-f1c308c4fd9d#.i13tdiu5a\r\n   */\r\n  public integer(min: number, max: number): number {\r\n    return Math.floor((max - min + 1) * this.next() + min);\r\n  }\r\n\r\n  /**\r\n   * Returns true or false randomly with 50/50 odds by default.\r\n   * By default the likelihood of returning a true is .5 (50%).\r\n   * @param likelihood takes values between [0, 1]\r\n   */\r\n  public bool(likelihood: number = 0.5): boolean {\r\n    return this.next() <= likelihood;\r\n  }\r\n\r\n  /**\r\n   * Returns one element from an array at random\r\n   */\r\n  public pickOne<T>(array: Array<T>): T {\r\n    return array[this.integer(0, array.length - 1)];\r\n  }\r\n\r\n  /**\r\n   * Returns a new array random picking elements from the original\r\n   * @param array Original array to pick from\r\n   * @param numPicks can be any positive number\r\n   * @param allowDuplicates indicates whether the returned set is allowed duplicates (it does not mean there will always be duplicates\r\n   * just that it is possible)\r\n   */\r\n  public pickSet<T>(array: Array<T>, numPicks: number, allowDuplicates: boolean = false): Array<T> {\r\n    if (allowDuplicates) {\r\n      return this._pickSetWithDuplicates(array, numPicks);\r\n    } else {\r\n      return this._pickSetWithoutDuplicates(array, numPicks);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a new array randomly picking elements in the original (not reused)\r\n   * @param array Array to pick elements out of\r\n   * @param numPicks must be less than or equal to the number of elements in the array.\r\n   */\r\n  private _pickSetWithoutDuplicates<T>(array: Array<T>, numPicks: number): Array<T> {\r\n    if (numPicks > array.length || numPicks < 0) {\r\n      throw new Error('Invalid number of elements to pick, must pick a value 0 < n <= length');\r\n    }\r\n    if (numPicks === array.length) {\r\n      return array;\r\n    }\r\n\r\n    const result: Array<T> = new Array<T>(numPicks);\r\n    let currentPick = 0;\r\n    const tempArray = array.slice(0);\r\n    while (currentPick < numPicks) {\r\n      const index = this.integer(0, tempArray.length - 1);\r\n      result[currentPick++] = tempArray[index];\r\n      tempArray.splice(index, 1);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns a new array random picking elements from the original allowing duplicates\r\n   * @param array Array to pick elements out of\r\n   * @param numPicks can be any positive number\r\n   */\r\n  private _pickSetWithDuplicates<T>(array: Array<T>, numPicks: number): Array<T> {\r\n    // Typescript numbers are all floating point, so do we add check for int? (or floor the input?)\r\n    if (numPicks < 0) {\r\n      throw new Error('Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT');\r\n    }\r\n    const result = new Array<T>(numPicks);\r\n    for (let i = 0; i < numPicks; i++) {\r\n      result[i] = this.pickOne(array);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns a new array that has its elements shuffled. Using the Fisher/Yates method\r\n   * https://en.wikipedia.org/wiki/Fisher%E2%80%93Yates_shuffle\r\n   */\r\n  public shuffle<T>(array: Array<T>): Array<T> {\r\n    const tempArray = array.slice(0);\r\n    let swap: T;\r\n    for (let i = 0; i < tempArray.length - 2; i++) {\r\n      const randomIndex = this.integer(i, tempArray.length - 1);\r\n      swap = tempArray[i];\r\n      tempArray[i] = tempArray[randomIndex];\r\n      tempArray[randomIndex] = swap;\r\n    }\r\n\r\n    return tempArray;\r\n  }\r\n\r\n  /**\r\n   * Generate a list of random integer numbers\r\n   * @param length the length of the final array\r\n   * @param min the minimum integer number to generate inclusive\r\n   * @param max the maximum integer number to generate inclusive\r\n   */\r\n  public range(length: number, min: number, max: number): Array<number> {\r\n    const result: Array<number> = new Array(length);\r\n    for (let i = 0; i < length; i++) {\r\n      result[i] = this.integer(min, max);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d4 dice roll\r\n   */\r\n  public d4() {\r\n    return this.integer(1, 4);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d6 dice roll\r\n   */\r\n  public d6() {\r\n    return this.integer(1, 6);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d8 dice roll\r\n   */\r\n  public d8() {\r\n    return this.integer(1, 8);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d10 dice roll\r\n   */\r\n  public d10() {\r\n    return this.integer(1, 10);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d12 dice roll\r\n   */\r\n  public d12() {\r\n    return this.integer(1, 12);\r\n  }\r\n\r\n  /**\r\n   * Returns the result of a d20 dice roll\r\n   */\r\n  public d20() {\r\n    return this.integer(1, 20);\r\n  }\r\n}\r\n","import { Random } from './Random';\r\n\r\n/**\r\n * Two PI constant\r\n */\r\nexport const TwoPI: number = Math.PI * 2;\r\n\r\n/**\r\n * Returns the fractional part of a number\r\n * @param x\r\n */\r\nexport function frac(x: number): number {\r\n  if (x >= 0) {\r\n    return x - Math.floor(x);\r\n  } else {\r\n    return x - Math.ceil(x);\r\n  }\r\n}\r\n\r\n/**\r\n * Returns the sign of a number, if 0 returns 0\r\n */\r\nexport function sign(val: number): number {\r\n  if (val === 0) {\r\n    return 0;\r\n  }\r\n  return val < 0 ? -1 : 1;\r\n}\r\n\r\n/**\r\n * Clamps a value between a min and max inclusive\r\n */\r\nexport function clamp(val: number, min: number, max: number) {\r\n  return Math.min(Math.max(min, val), max);\r\n}\r\n\r\n/**\r\n * Approximately equals\r\n */\r\nexport function approximatelyEqual(val1: number, val2: number, tolerance: number) {\r\n  // https://dev.to/alldanielscott/how-to-compare-numbers-correctly-in-javascript-1l4i\r\n  return Math.abs(val1 - val2) < tolerance;\r\n}\r\n\r\n/**\r\n * Convert an angle to be the equivalent in the range [0, 2PI)\r\n */\r\nexport function canonicalizeAngle(angle: number): number {\r\n  let tmpAngle = angle;\r\n  if (angle >= TwoPI) {\r\n    while (tmpAngle >= TwoPI) {\r\n      tmpAngle -= TwoPI;\r\n    }\r\n  }\r\n\r\n  if (angle < 0) {\r\n    while (tmpAngle < 0) {\r\n      tmpAngle += TwoPI;\r\n    }\r\n  }\r\n  return tmpAngle;\r\n}\r\n\r\n/**\r\n * Convert radians to degrees\r\n */\r\nexport function toDegrees(radians: number): number {\r\n  return (180 / Math.PI) * radians;\r\n}\r\n\r\n/**\r\n * Convert degrees to radians\r\n */\r\nexport function toRadians(degrees: number): number {\r\n  return (degrees / 180) * Math.PI;\r\n}\r\n\r\n/**\r\n * Generate a range of numbers\r\n * For example: range(0, 5) -> [0, 1, 2, 3, 4, 5]\r\n * @param from inclusive\r\n * @param to inclusive\r\n */\r\nexport const range = (from: number, to: number) => Array.from(new Array(to - from + 1), (_x, i) => i + from);\r\n\r\n/**\r\n * Find a random floating point number in range\r\n */\r\nexport function randomInRange(min: number, max: number, random: Random = new Random()): number {\r\n  return random ? random.floating(min, max) : min + Math.random() * (max - min);\r\n}\r\n\r\n/**\r\n * Find a random integer in a range\r\n */\r\nexport function randomIntInRange(min: number, max: number, random: Random = new Random()): number {\r\n  return random ? random.integer(min, max) : Math.round(randomInRange(min, max));\r\n}\r\n","import { Clonable } from '../Interfaces/Clonable';\r\nimport { RotationType } from './rotation-type';\r\nimport { canonicalizeAngle, clamp, TwoPI } from './util';\r\n\r\n/**\r\n * A 2D vector on a plane.\r\n */\r\n\r\nexport class Vector implements Clonable<Vector> {\r\n  /**\r\n   * Get or set the vector equals epsilon, by default 0.001 meaning vectors within that tolerance on x or y will be considered equal.\r\n   */\r\n  public static EQUALS_EPSILON = 0.001;\r\n  /**\r\n   * A (0, 0) vector\r\n   */\r\n  public static get Zero() {\r\n    return new Vector(0, 0);\r\n  }\r\n\r\n  /**\r\n   * A (1, 1) vector\r\n   */\r\n  public static get One() {\r\n    return new Vector(1, 1);\r\n  }\r\n\r\n  /**\r\n   * A (0.5, 0.5) vector\r\n   */\r\n  public static get Half() {\r\n    return new Vector(0.5, 0.5);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing up (0, -1)\r\n   */\r\n  public static get Up() {\r\n    return new Vector(0, -1);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing down (0, 1)\r\n   */\r\n  public static get Down() {\r\n    return new Vector(0, 1);\r\n  }\r\n\r\n  /**\r\n   * A unit vector pointing left (-1, 0)\r\n   */\r\n  public static get Left() {\r\n    return new Vector(-1, 0);\r\n  }\r\n  /**\r\n   * A unit vector pointing right (1, 0)\r\n   */\r\n  public static get Right() {\r\n    return new Vector(1, 0);\r\n  }\r\n\r\n  /**\r\n   * Returns a vector of unit length in the direction of the specified angle in Radians.\r\n   * @param angle The angle to generate the vector\r\n   */\r\n  public static fromAngle(angle: number) {\r\n    return new Vector(Math.cos(angle), Math.sin(angle));\r\n  }\r\n\r\n  /**\r\n   * Checks if vector is not null, undefined, or if any of its components are NaN or Infinity.\r\n   */\r\n  public static isValid(vec: Vector) {\r\n    if (vec === null || vec === undefined) {\r\n      return false;\r\n    }\r\n    if (isNaN(vec.x) || isNaN(vec.y)) {\r\n      return false;\r\n    }\r\n\r\n    if (vec.x === Infinity || vec.y === Infinity || vec.x === -Infinity || vec.y === -Infinity) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Calculates distance between two Vectors\r\n   * @param vec1\r\n   * @param vec2\r\n   */\r\n  public static distance(vec1: Vector, vec2: Vector) {\r\n    return Math.sqrt(Math.pow(vec1.x - vec2.x, 2) + Math.pow(vec1.y - vec2.y, 2));\r\n  }\r\n\r\n  public static min(vec1: Vector, vec2: Vector) {\r\n    return new Vector(Math.min(vec1.x, vec2.x), Math.min(vec1.y, vec2.y));\r\n  }\r\n\r\n  public static max(vec1: Vector, vec2: Vector) {\r\n    return new Vector(Math.max(vec1.x, vec2.x), Math.max(vec1.y, vec2.y));\r\n  }\r\n\r\n  /**\r\n   * @param x  X component of the Vector\r\n   * @param y  Y component of the Vector\r\n   */\r\n  constructor(x: number, y: number) {\r\n    this._x = x;\r\n    this._y = y;\r\n  }\r\n\r\n  protected _x = 0;\r\n  /**\r\n   * Get the x component of the vector\r\n   */\r\n  public get x(): number {\r\n    return this._x;\r\n  }\r\n\r\n  /**\r\n   * Set the x component, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful setting components on shared vectors, mutating shared vectors can cause hard to find bugs**\r\n   */\r\n  public set x(val: number) {\r\n    this._x = val;\r\n  }\r\n\r\n  protected _y = 0;\r\n  /**\r\n   * Get the y component of the vector\r\n   */\r\n  public get y(): number {\r\n    return this._y;\r\n  }\r\n\r\n  /**\r\n   * Set the y component, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful setting components on shared vectors, mutating shared vectors can cause hard to find bugs**\r\n   */\r\n  public set y(val: number) {\r\n    this._y = val;\r\n  }\r\n\r\n  /**\r\n   * Sets the x and y components at once, THIS MUTATES the current vector. It is usually better to create a new vector.\r\n   * @warning **Be very careful using this, mutating vectors can cause hard to find bugs**\r\n   */\r\n  setTo(x: number, y: number) {\r\n    (this.x as number) = x;\r\n    (this.y as number) = y;\r\n  }\r\n\r\n  /**\r\n   * Compares this point against another and tests for equality\r\n   * @param vector The other point to compare to\r\n   * @param tolerance Amount of euclidean distance off we are willing to tolerate\r\n   */\r\n  public equals(vector: Vector, tolerance: number = Vector.EQUALS_EPSILON): boolean {\r\n    return Math.abs(this.x - vector.x) <= tolerance && Math.abs(this.y - vector.y) <= tolerance;\r\n  }\r\n\r\n  /**\r\n   * The distance to another vector. If no other Vector is specified, this will return the {@apilink magnitude}.\r\n   * @param v  The other vector. Leave blank to use origin vector.\r\n   */\r\n  public distance(v?: Vector): number {\r\n    if (!v) {\r\n      return Math.sqrt(this.x * this.x + this.y * this.y);\r\n    }\r\n    const deltaX = this.x - v.x;\r\n    const deltaY = this.y - v.y;\r\n    return Math.sqrt(deltaX * deltaX + deltaY * deltaY);\r\n  }\r\n\r\n  public squareDistance(v?: Vector): number {\r\n    if (!v) {\r\n      v = Vector.Zero;\r\n    }\r\n    const deltaX = this.x - v.x;\r\n    const deltaY = this.y - v.y;\r\n    return deltaX * deltaX + deltaY * deltaY;\r\n  }\r\n\r\n  /**\r\n   * Clamps the current vector's magnitude mutating it\r\n   * @param magnitude\r\n   */\r\n  public clampMagnitude(magnitude: number): Vector {\r\n    const size = this.magnitude;\r\n    const newSize = clamp(size, 0, magnitude);\r\n    this.magnitude = newSize;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * The size (magnitude) of the Vector\r\n   * @deprecated Will be removed in v1, use Vector.magnitude\r\n   */\r\n  public get size(): number {\r\n    return this.distance();\r\n  }\r\n\r\n  /**\r\n   * Setting the size mutates the current vector\r\n   * @warning Can be used to set the size of the vector, **be very careful using this, mutating vectors can cause hard to find bugs**\r\n   * @deprecated Will be removed in v1, use Vector.magnitude\r\n   */\r\n  public set size(newLength: number) {\r\n    const v = this.normalize().scale(newLength);\r\n    this.setTo(v.x, v.y);\r\n  }\r\n\r\n  /**\r\n   * The magnitude (length) of the Vector\r\n   */\r\n  public get magnitude(): number {\r\n    return this.distance();\r\n  }\r\n\r\n  /**\r\n   * Setting the size mutates the current vector\r\n   * @warning Can be used to set the size of the vector, **be very careful using this, mutating vectors can cause hard to find bugs**\r\n   */\r\n  public set magnitude(newMagnitude: number) {\r\n    this.normalize().scale(newMagnitude, this);\r\n  }\r\n\r\n  /**\r\n   * Normalizes a non-zero vector to have a magnitude of 1. Zero vectors return a new zero vector.\r\n   */\r\n  public normalize(): Vector {\r\n    const distance = this.distance();\r\n    if (distance === 0) {\r\n      return Vector.Zero;\r\n    }\r\n\r\n    return new Vector(this.x / distance, this.y / distance);\r\n  }\r\n\r\n  /**\r\n   * Returns the average (midpoint) between the current point and the specified\r\n   */\r\n  public average(vec: Vector): Vector {\r\n    return this.add(vec).scale(0.5);\r\n  }\r\n\r\n  /**\r\n   * Scales a vector's by a factor of size\r\n   * @param size  The factor to scale the magnitude by\r\n   * @param dest  Optionally provide a destination vector for the result\r\n   */\r\n  public scale(scale: Vector, dest?: Vector): Vector;\r\n  public scale(size: number, dest?: Vector): Vector;\r\n  public scale(sizeOrScale: number | Vector, dest?: Vector): Vector {\r\n    const result = dest || new Vector(0, 0);\r\n    if (sizeOrScale instanceof Vector) {\r\n      result.x = this.x * sizeOrScale.x;\r\n      result.y = this.y * sizeOrScale.y;\r\n    } else {\r\n      result.x = this.x * sizeOrScale;\r\n      result.y = this.y * sizeOrScale;\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Adds one vector to another\r\n   * @param v The vector to add\r\n   * @param dest Optionally copy the result into a provided vector\r\n   */\r\n  public add(v: Vector, dest?: Vector): Vector {\r\n    if (dest) {\r\n      dest.x = this.x + v.x;\r\n      dest.y = this.y + v.y;\r\n      return dest;\r\n    }\r\n    return new Vector(this.x + v.x, this.y + v.y);\r\n  }\r\n\r\n  /**\r\n   * Subtracts a vector from another, if you subtract vector `B.sub(A)` the resulting vector points from A -> B\r\n   * @param v The vector to subtract\r\n   */\r\n  public sub(v: Vector, dest?: Vector): Vector {\r\n    const result = dest || new Vector(0, 0);\r\n    const x = this.x - v.x;\r\n    const y = this.y - v.y;\r\n    result.x = x;\r\n    result.y = y;\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Adds one vector to this one modifying the original\r\n   * @param v The vector to add\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public addEqual(v: Vector): Vector {\r\n    this.setTo(this.x + v.x, this.y + v.y);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Subtracts a vector from this one modifying the original\r\n   * @param v The vector to subtract\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public subEqual(v: Vector): Vector {\r\n    this.setTo(this.x - v.x, this.y - v.y);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Scales this vector by a factor of size and modifies the original\r\n   * @warning Be very careful using this, mutating vectors can cause hard to find bugs\r\n   */\r\n  public scaleEqual(size: number): Vector {\r\n    this.setTo(this.x * size, this.y * size);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Performs a dot product with another vector\r\n   * @param v  The vector to dot\r\n   */\r\n  public dot(v: Vector): number {\r\n    return this.x * v.x + this.y * v.y;\r\n  }\r\n\r\n  /**\r\n   * Performs a 2D cross product with scalar. 2D cross products with a scalar return a vector.\r\n   * @param v  The scalar to cross\r\n   */\r\n  public cross(v: number): Vector;\r\n  /**\r\n   * Performs a 2D cross product with another vector. 2D cross products return a scalar value not a vector.\r\n   * @param v  The vector to cross\r\n   */\r\n  public cross(v: Vector): number;\r\n  public cross(v: any): any {\r\n    if (v instanceof Vector) {\r\n      return this.x * v.y - this.y * v.x;\r\n    } else if (typeof v === 'number') {\r\n      return new Vector(v * this.y, -v * this.x);\r\n    }\r\n  }\r\n\r\n  static cross(num: number, vec: Vector): Vector {\r\n    return new Vector(-num * vec.y, num * vec.x);\r\n  }\r\n\r\n  /**\r\n   * Returns the perpendicular vector to this one\r\n   */\r\n  public perpendicular(): Vector {\r\n    return new Vector(this.y, -this.x);\r\n  }\r\n\r\n  /**\r\n   * Returns the normal vector to this one, same as the perpendicular of length 1\r\n   */\r\n  public normal(): Vector {\r\n    return this.perpendicular().normalize();\r\n  }\r\n\r\n  /**\r\n   * Negate the current vector\r\n   */\r\n  public negate(): Vector {\r\n    return this.scale(-1);\r\n  }\r\n\r\n  /**\r\n   * Returns the angle of this vector, in range [0, 2*PI)\r\n   */\r\n  public toAngle(): number {\r\n    return canonicalizeAngle(Math.atan2(this.y, this.x));\r\n  }\r\n\r\n  /**\r\n   * Returns the difference in radians between the angle of this vector and given angle,\r\n   * using the given rotation type.\r\n   * @param angle in radians to which the vector has to be rotated, using {@apilink rotate}\r\n   * @param rotationType what {@apilink RotationType} to use for the rotation\r\n   * @returns the angle by which the vector needs to be rotated to match the given angle\r\n   */\r\n  public angleBetween(angle: number, rotationType: RotationType): number {\r\n    const startAngleRadians = this.toAngle();\r\n    const endAngleRadians = canonicalizeAngle(angle);\r\n    let rotationClockwise = 0;\r\n    let rotationAntiClockwise = 0;\r\n    if (endAngleRadians > startAngleRadians) {\r\n      rotationClockwise = endAngleRadians - startAngleRadians;\r\n    } else {\r\n      rotationClockwise = (TwoPI - startAngleRadians + endAngleRadians) % TwoPI;\r\n    }\r\n    rotationAntiClockwise = (rotationClockwise - TwoPI) % TwoPI;\r\n    switch (rotationType) {\r\n      case RotationType.ShortestPath:\r\n        if (Math.abs(rotationClockwise) < Math.abs(rotationAntiClockwise)) {\r\n          return rotationClockwise;\r\n        } else {\r\n          return rotationAntiClockwise;\r\n        }\r\n      case RotationType.LongestPath:\r\n        if (Math.abs(rotationClockwise) > Math.abs(rotationAntiClockwise)) {\r\n          return rotationClockwise;\r\n        } else {\r\n          return rotationAntiClockwise;\r\n        }\r\n      case RotationType.Clockwise:\r\n        return rotationClockwise;\r\n      case RotationType.CounterClockwise:\r\n        return rotationAntiClockwise;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rotates the current vector around a point by a certain angle in radians.\r\n   * Positive angle means rotation clockwise.\r\n   */\r\n  public rotate(angle: number, anchor?: Vector, dest?: Vector): Vector {\r\n    const result = dest || new Vector(0, 0);\r\n    if (!anchor) {\r\n      anchor = new Vector(0, 0);\r\n    }\r\n    const sinAngle = Math.sin(angle);\r\n    const cosAngle = Math.cos(angle);\r\n    const x = cosAngle * (this.x - anchor.x) - sinAngle * (this.y - anchor.y) + anchor.x;\r\n    const y = sinAngle * (this.x - anchor.x) + cosAngle * (this.y - anchor.y) + anchor.y;\r\n    result.x = x;\r\n    result.y = y;\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Creates new vector that has the same values as the previous.\r\n   */\r\n  public clone(dest?: Vector): Vector {\r\n    const v = dest ?? new Vector(0, 0);\r\n    v.x = this.x;\r\n    v.y = this.y;\r\n    return v;\r\n  }\r\n\r\n  /**\r\n   * Returns a string representation of the vector.\r\n   */\r\n  public toString(fixed?: number): string {\r\n    if (fixed) {\r\n      return `(${this.x.toFixed(fixed)}, ${this.y.toFixed(fixed)})`;\r\n    }\r\n    return `(${this.x}, ${this.y})`;\r\n  }\r\n}\r\n\r\n/**\r\n * Shorthand for creating new Vectors - returns a new Vector instance with the\r\n * provided X and Y components.\r\n * @param x  X component of the Vector\r\n * @param y  Y component of the Vector\r\n */\r\nexport function vec(x: number, y: number): Vector {\r\n  return new Vector(x, y);\r\n}\r\n","/**\r\n * Provides standard colors (e.g. {@apilink Color.Black})\r\n * but you can also create custom colors using RGB, HSL, or Hex. Also provides\r\n * useful color operations like {@apilink Color.lighten}, {@apilink Color.darken}, and more.\r\n */\r\nexport class Color {\r\n  /**\r\n   * Red channel\r\n   */\r\n  public r: number;\r\n  /**\r\n   * Green channel\r\n   */\r\n  public g: number;\r\n  /**\r\n   * Blue channel\r\n   */\r\n  public b: number;\r\n  /**\r\n   * Alpha channel (between 0 and 1)\r\n   */\r\n  public a: number;\r\n\r\n  /**\r\n   * Hue\r\n   */\r\n  public h: number;\r\n  /**\r\n   * Saturation\r\n   */\r\n  public s: number;\r\n  /**\r\n   * Lightness\r\n   */\r\n  public l: number;\r\n\r\n  /**\r\n   * Creates a new instance of Color from an r, g, b, a\r\n   * @param r  The red component of color (0-255)\r\n   * @param g  The green component of color (0-255)\r\n   * @param b  The blue component of color (0-255)\r\n   * @param a  The alpha component of color (0-1.0)\r\n   */\r\n  constructor(r: number, g: number, b: number, a?: number) {\r\n    this.r = r;\r\n    this.g = g;\r\n    this.b = b;\r\n    this.a = a != null ? a : 1;\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from an r, g, b, a\r\n   * @param r  The red component of color (0-255)\r\n   * @param g  The green component of color (0-255)\r\n   * @param b  The blue component of color (0-255)\r\n   * @param a  The alpha component of color (0-1.0)\r\n   */\r\n  public static fromRGB(r: number, g: number, b: number, a?: number): Color {\r\n    return new Color(r, g, b, a);\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from a rgb string\r\n   * @param string  CSS color string of the form rgba(255, 255, 255, 1) or rgb(255, 255, 255)\r\n   */\r\n  public static fromRGBString(string: string): Color {\r\n    const rgbaRegEx: RegExp = /^rgba?\\((\\d+),\\s*(\\d+),\\s*(\\d+)(?:,\\s*(\\d+(?:\\.\\d+)?))?\\)/i;\r\n    let match = null;\r\n    if ((match = string.match(rgbaRegEx))) {\r\n      const r = parseInt(match[1], 10);\r\n      const g = parseInt(match[2], 10);\r\n      const b = parseInt(match[3], 10);\r\n      let a = 1;\r\n      if (match[4]) {\r\n        a = parseFloat(match[4]);\r\n      }\r\n      return new Color(r, g, b, a);\r\n    } else {\r\n      throw new Error('Invalid rgb/a string: ' + string);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from a hex string\r\n   * @param hex  CSS color string of the form #ffffff, the alpha component is optional\r\n   */\r\n  public static fromHex(hex: string): Color {\r\n    const hexRegEx: RegExp = /^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;\r\n    let match = null;\r\n    if ((match = hex.match(hexRegEx))) {\r\n      const r = parseInt(match[1], 16);\r\n      const g = parseInt(match[2], 16);\r\n      const b = parseInt(match[3], 16);\r\n      let a = 1;\r\n      if (match[4]) {\r\n        a = parseInt(match[4], 16) / 255;\r\n      }\r\n      return new Color(r, g, b, a);\r\n    } else {\r\n      throw new Error('Invalid hex string: ' + hex);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Creates a new instance of Color from hsla values\r\n   * @param h  Hue is represented [0-1]\r\n   * @param s  Saturation is represented [0-1]\r\n   * @param l  Luminance is represented [0-1]\r\n   * @param a  Alpha is represented [0-1]\r\n   */\r\n  public static fromHSL(h: number, s: number, l: number, a: number = 1.0): Color {\r\n    const temp = new HSLColor(h, s, l, a);\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Lightens the current color by a specified amount\r\n   * @param factor  The amount to lighten by [0-1]\r\n   */\r\n  public lighten(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.l += (1 - temp.l) * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Darkens the current color by a specified amount\r\n   * @param factor  The amount to darken by [0-1]\r\n   */\r\n  public darken(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.l -= temp.l * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Saturates the current color by a specified amount\r\n   * @param factor  The amount to saturate by [0-1]\r\n   */\r\n  public saturate(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.s += temp.s * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Desaturates the current color by a specified amount\r\n   * @param factor  The amount to desaturate by [0-1]\r\n   */\r\n  public desaturate(factor: number = 0.1): Color {\r\n    const temp = HSLColor.fromRGBA(this.r, this.g, this.b, this.a);\r\n    temp.s -= temp.s * factor;\r\n    return temp.toRGBA();\r\n  }\r\n\r\n  /**\r\n   * Multiplies a color by another, results in a darker color\r\n   * @param color  The other color\r\n   */\r\n  public multiply(color: Color): Color {\r\n    const newR = (((color.r / 255) * this.r) / 255) * 255;\r\n    const newG = (((color.g / 255) * this.g) / 255) * 255;\r\n    const newB = (((color.b / 255) * this.b) / 255) * 255;\r\n    const newA = color.a * this.a;\r\n    return new Color(newR, newG, newB, newA);\r\n  }\r\n\r\n  /**\r\n   * Screens a color by another, results in a lighter color\r\n   * @param color  The other color\r\n   */\r\n  public screen(color: Color): Color {\r\n    const color1 = color.invert();\r\n    const color2 = color.invert();\r\n    return color1.multiply(color2).invert();\r\n  }\r\n\r\n  /**\r\n   * Inverts the current color\r\n   */\r\n  public invert(): Color {\r\n    return new Color(255 - this.r, 255 - this.g, 255 - this.b, 1.0 - this.a);\r\n  }\r\n\r\n  /**\r\n   * Averages the current color with another\r\n   * @param color  The other color\r\n   */\r\n  public average(color: Color): Color {\r\n    const newR = (color.r + this.r) / 2;\r\n    const newG = (color.g + this.g) / 2;\r\n    const newB = (color.b + this.b) / 2;\r\n    const newA = (color.a + this.a) / 2;\r\n    return new Color(newR, newG, newB, newA);\r\n  }\r\n\r\n  public equal(color: Color): boolean {\r\n    return this.toString() === color.toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a CSS string representation of a color.\r\n   * @param format Color representation, accepts: rgb, hsl, or hex\r\n   */\r\n  public toString(format: 'rgb' | 'hsl' | 'hex' = 'rgb') {\r\n    switch (format) {\r\n      case 'rgb':\r\n        return this.toRGBA();\r\n      case 'hsl':\r\n        return this.toHSLA();\r\n      case 'hex':\r\n        return this.toHex();\r\n      default:\r\n        throw new Error('Invalid Color format');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns Hex Value of a color component\r\n   * @param c color component\r\n   * @see https://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb\r\n   */\r\n  private _componentToHex(c: number) {\r\n    // Handle negative and fractional numbers\r\n    const hex = Math.max(Math.round(c), 0).toString(16);\r\n    return hex.length === 1 ? '0' + hex : hex;\r\n  }\r\n\r\n  /**\r\n   * Return Hex representation of a color.\r\n   */\r\n  public toHex() {\r\n    let hexRepresentation = '#' + this._componentToHex(this.r) + this._componentToHex(this.g) + this._componentToHex(this.b);\r\n    if (this.a !== 1) {\r\n      hexRepresentation += this._componentToHex(this.a * 255);\r\n    }\r\n    return hexRepresentation;\r\n  }\r\n\r\n  /**\r\n   * Return RGBA representation of a color.\r\n   */\r\n  public toRGBA() {\r\n    const result = String(this.r.toFixed(0)) + ', ' + String(this.g.toFixed(0)) + ', ' + String(this.b.toFixed(0));\r\n    if (this.a !== undefined || this.a !== null) {\r\n      return 'rgba(' + result + ', ' + String(this.a) + ')';\r\n    }\r\n    return 'rgb(' + result + ')';\r\n  }\r\n\r\n  /**\r\n   * Return HSLA representation of a color.\r\n   */\r\n  public toHSLA() {\r\n    return HSLColor.fromRGBA(this.r, this.g, this.b, this.a).toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a CSS string representation of a color.\r\n   */\r\n  public fillStyle() {\r\n    return this.toString();\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of the current color.\r\n   */\r\n  public clone(dest?: Color): Color {\r\n    const result = dest || new Color(this.r, this.g, this.b, this.a);\r\n    result.r = this.r;\r\n    result.g = this.g;\r\n    result.b = this.b;\r\n    result.a = this.a;\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Black (#000000)\r\n   */\r\n  public static get Black(): Color {\r\n    return Color.fromHex('#000000');\r\n  }\r\n\r\n  /**\r\n   * White (#FFFFFF)\r\n   */\r\n  public static get White(): Color {\r\n    return Color.fromHex('#FFFFFF');\r\n  }\r\n\r\n  /**\r\n   * Gray (#808080)\r\n   */\r\n  public static get Gray(): Color {\r\n    return Color.fromHex('#808080');\r\n  }\r\n\r\n  /**\r\n   * Light gray (#D3D3D3)\r\n   */\r\n  public static get LightGray(): Color {\r\n    return Color.fromHex('#D3D3D3');\r\n  }\r\n\r\n  /**\r\n   * Dark gray (#A9A9A9)\r\n   */\r\n  public static get DarkGray(): Color {\r\n    return Color.fromHex('#A9A9A9');\r\n  }\r\n\r\n  /**\r\n   * Yellow (#FFFF00)\r\n   */\r\n  public static get Yellow(): Color {\r\n    return Color.fromHex('#FFFF00');\r\n  }\r\n\r\n  /**\r\n   * Orange (#FFA500)\r\n   */\r\n  public static get Orange(): Color {\r\n    return Color.fromHex('#FFA500');\r\n  }\r\n\r\n  /**\r\n   * Red (#FF0000)\r\n   */\r\n  public static get Red(): Color {\r\n    return Color.fromHex('#FF0000');\r\n  }\r\n\r\n  /**\r\n   * Vermilion (#FF5B31)\r\n   */\r\n  public static get Vermilion(): Color {\r\n    return Color.fromHex('#FF5B31');\r\n  }\r\n\r\n  /**\r\n   * Rose (#FF007F)\r\n   */\r\n  public static get Rose(): Color {\r\n    return Color.fromHex('#FF007F');\r\n  }\r\n\r\n  /**\r\n   * Pink (#FFC0CB)\r\n   */\r\n  public static get Pink(): Color {\r\n    return Color.fromHex('#FFC0CB');\r\n  }\r\n\r\n  /**\r\n   * Magenta (#FF00FF)\r\n   */\r\n  public static get Magenta(): Color {\r\n    return Color.fromHex('#FF00FF');\r\n  }\r\n\r\n  /**\r\n   * Violet (#7F00FF)\r\n   */\r\n  public static get Violet(): Color {\r\n    return Color.fromHex('#7F00FF');\r\n  }\r\n\r\n  /**\r\n   * Purple (#800080)\r\n   */\r\n  public static get Purple(): Color {\r\n    return Color.fromHex('#800080');\r\n  }\r\n\r\n  /**\r\n   * Blue (#0000FF)\r\n   */\r\n  public static get Blue(): Color {\r\n    return Color.fromHex('#0000FF');\r\n  }\r\n\r\n  /**\r\n   * Azure (#007FFF)\r\n   */\r\n  public static get Azure(): Color {\r\n    return Color.fromHex('#007FFF');\r\n  }\r\n\r\n  /**\r\n   * Cyan (#00FFFF)\r\n   */\r\n  public static get Cyan(): Color {\r\n    return Color.fromHex('#00FFFF');\r\n  }\r\n\r\n  /**\r\n   * Viridian (#59978F)\r\n   */\r\n  public static get Viridian(): Color {\r\n    return Color.fromHex('#59978F');\r\n  }\r\n\r\n  /**\r\n   * Teal (#008080)\r\n   */\r\n  public static get Teal(): Color {\r\n    return Color.fromHex('#008080');\r\n  }\r\n\r\n  /**\r\n   * Green (#00FF00)\r\n   */\r\n  public static get Green(): Color {\r\n    return Color.fromHex('#00FF00');\r\n  }\r\n\r\n  /**\r\n   * Chartreuse (#7FFF00)\r\n   */\r\n  public static get Chartreuse(): Color {\r\n    return Color.fromHex('#7FFF00');\r\n  }\r\n\r\n  /**\r\n   * Transparent (#FFFFFF00)\r\n   */\r\n  public static get Transparent(): Color {\r\n    return Color.fromHex('#FFFFFF00');\r\n  }\r\n\r\n  /**\r\n   * ExcaliburBlue (#176BAA)\r\n   */\r\n  public static get ExcaliburBlue(): Color {\r\n    return Color.fromHex('#176BAA');\r\n  }\r\n\r\n  /**\r\n   * Brown (#964B00)\r\n   */\r\n  public static get Brown(): Color {\r\n    return Color.fromHex('#964B00');\r\n  }\r\n}\r\n\r\n/**\r\n * Internal HSL Color representation\r\n *\r\n * http://en.wikipedia.org/wiki/HSL_and_HSV\r\n * http://axonflux.com/handy-rgb-to-hsl-and-rgb-to-hsv-color-model-c\r\n */\r\nclass HSLColor {\r\n  constructor(\r\n    public h: number,\r\n    public s: number,\r\n    public l: number,\r\n    public a: number\r\n  ) {}\r\n\r\n  public static hue2rgb(p: number, q: number, t: number): number {\r\n    if (t < 0) {\r\n      t += 1;\r\n    }\r\n    if (t > 1) {\r\n      t -= 1;\r\n    }\r\n    if (t < 1 / 6) {\r\n      return p + (q - p) * 6 * t;\r\n    }\r\n    if (t < 1 / 2) {\r\n      return q;\r\n    }\r\n    if (t < 2 / 3) {\r\n      return p + (q - p) * (2 / 3 - t) * 6;\r\n    }\r\n    return p;\r\n  }\r\n\r\n  public static fromRGBA(r: number, g: number, b: number, a: number): HSLColor {\r\n    r /= 255;\r\n    g /= 255;\r\n    b /= 255;\r\n    const max = Math.max(r, g, b),\r\n      min = Math.min(r, g, b);\r\n    let h, s;\r\n    const l = (max + min) / 2;\r\n\r\n    if (max === min) {\r\n      h = s = 0; // achromatic\r\n    } else {\r\n      const d = max - min;\r\n      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);\r\n      switch (max) {\r\n        case r:\r\n          h = (g - b) / d + (g < b ? 6 : 0);\r\n          break;\r\n        case g:\r\n          h = (b - r) / d + 2;\r\n          break;\r\n        case b:\r\n          h = (r - g) / d + 4;\r\n          break;\r\n      }\r\n      h /= 6;\r\n    }\r\n\r\n    return new HSLColor(h, s, l, a);\r\n  }\r\n\r\n  public toRGBA(): Color {\r\n    let r: number, g: number, b: number;\r\n\r\n    if (this.s === 0) {\r\n      r = g = b = this.l; // achromatic\r\n    } else {\r\n      const q = this.l < 0.5 ? this.l * (1 + this.s) : this.l + this.s - this.l * this.s;\r\n      const p = 2 * this.l - q;\r\n      r = HSLColor.hue2rgb(p, q, this.h + 1 / 3);\r\n      g = HSLColor.hue2rgb(p, q, this.h);\r\n      b = HSLColor.hue2rgb(p, q, this.h - 1 / 3);\r\n    }\r\n\r\n    return new Color(r * 255, g * 255, b * 255, this.a);\r\n  }\r\n\r\n  public toString(): string {\r\n    const h = this.h.toFixed(0),\r\n      s = this.s.toFixed(0),\r\n      l = this.l.toFixed(0),\r\n      a = this.a.toFixed(0);\r\n    return `hsla(${h}, ${s}, ${l}, ${a})`;\r\n  }\r\n}\r\n","/* eslint-disable no-console */\r\n\r\nimport { Engine } from '../Engine';\r\nimport { vec } from '../Math/vector';\r\nimport { Color } from '../Color';\r\n\r\n/**\r\n * Logging level that Excalibur will tag\r\n */\r\nexport enum LogLevel {\r\n  Debug,\r\n  Info,\r\n  Warn,\r\n  Error,\r\n  Fatal\r\n}\r\n\r\n/**\r\n * Static singleton that represents the logging facility for Excalibur.\r\n * Excalibur comes built-in with a {@apilink ConsoleAppender} and {@apilink ScreenAppender}.\r\n * Derive from {@apilink Appender} to create your own logging appenders.\r\n */\r\nexport class Logger {\r\n  private static _INSTANCE: Logger = null;\r\n  private _appenders: Appender[] = [];\r\n\r\n  constructor() {\r\n    if (Logger._INSTANCE) {\r\n      throw new Error('Logger is a singleton');\r\n    }\r\n    Logger._INSTANCE = this;\r\n    // Default console appender\r\n    Logger._INSTANCE.addAppender(new ConsoleAppender());\r\n    return Logger._INSTANCE;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the default logging level. Excalibur will only log\r\n   * messages if equal to or above this level. Default: {@apilink LogLevel.Info}\r\n   */\r\n  public defaultLevel: LogLevel = LogLevel.Info;\r\n\r\n  /**\r\n   * Gets the current static instance of Logger\r\n   */\r\n  public static getInstance(): Logger {\r\n    if (Logger._INSTANCE == null) {\r\n      Logger._INSTANCE = new Logger();\r\n    }\r\n    return Logger._INSTANCE;\r\n  }\r\n\r\n  /**\r\n   * Adds a new {@apilink Appender} to the list of appenders to write to\r\n   */\r\n  public addAppender(appender: Appender): void {\r\n    this._appenders.push(appender);\r\n  }\r\n\r\n  /**\r\n   * Clears all appenders from the logger\r\n   */\r\n  public clearAppenders(): void {\r\n    this._appenders.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Logs a message at a given LogLevel\r\n   * @param level  The LogLevel`to log the message at\r\n   * @param args   An array of arguments to write to an appender\r\n   */\r\n  private _log(level: LogLevel, args: any[]): void {\r\n    if (level == null) {\r\n      level = this.defaultLevel;\r\n    }\r\n\r\n    const len = this._appenders.length;\r\n\r\n    for (let i = 0; i < len; i++) {\r\n      if (level >= this.defaultLevel) {\r\n        this._appenders[i].log(level, args);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _logOnceSet = new Set<any>();\r\n  private _logOnce(level: LogLevel, args: any[]): void {\r\n    const serialized = level + args.join('+');\r\n    if (this._logOnceSet.has(serialized)) {\r\n      return;\r\n    } else {\r\n      this._logOnceSet.add(serialized);\r\n      this._log(level, args);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the {@apilink LogLevel.Debug} level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public debug(...args: any[]): void {\r\n    this._log(LogLevel.Debug, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the {@apilink LogLevel.Fatal} level, if it sees the same args again it wont log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public debugOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Debug, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the {@apilink LogLevel.Info} level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public info(...args: any[]): void {\r\n    this._log(LogLevel.Info, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the {@apilink LogLevel.Info} level, if it sees the same args again it wont log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public infoOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Info, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the {@apilink LogLevel.Warn} level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public warn(...args: any[]): void {\r\n    this._log(LogLevel.Warn, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the {@apilink LogLevel.Warn} level, if it sees the same args again it won't log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public warnOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Warn, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the {@apilink LogLevel.Error} level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public error(...args: any[]): void {\r\n    this._log(LogLevel.Error, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the {@apilink LogLevel.Error} level, if it sees the same args again it won't log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public errorOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Error, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message at the {@apilink LogLevel.Fatal} level\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public fatal(...args: any[]): void {\r\n    this._log(LogLevel.Fatal, args);\r\n  }\r\n\r\n  /**\r\n   * Writes a log message once at the {@apilink LogLevel.Fatal} level, if it sees the same args again it won't log\r\n   * @param args  Accepts any number of arguments\r\n   */\r\n  public fatalOnce(...args: any[]): void {\r\n    this._logOnce(LogLevel.Fatal, args);\r\n  }\r\n}\r\n\r\n/**\r\n * Contract for any log appender (such as console/screen)\r\n */\r\nexport interface Appender {\r\n  /**\r\n   * Logs a message at the given {@apilink LogLevel}\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  log(level: LogLevel, args: any[]): void;\r\n}\r\n\r\n/**\r\n * Console appender for browsers (i.e. `console.log`)\r\n */\r\nexport class ConsoleAppender implements Appender {\r\n  /**\r\n   * Logs a message at the given {@apilink LogLevel}\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  public log(level: LogLevel, args: any[]): void {\r\n    // Check for console support\r\n    if (!console && !console.log && console.warn && console.error) {\r\n      // todo maybe do something better than nothing\r\n      return;\r\n    }\r\n\r\n    // Create a new console args array\r\n    const consoleArgs: any[] = [];\r\n    consoleArgs.unshift.apply(consoleArgs, args);\r\n    consoleArgs.unshift('[' + LogLevel[level] + '] : ');\r\n\r\n    if (level < LogLevel.Warn) {\r\n      // Call .log for Debug/Info\r\n      if (console.log.apply) {\r\n        // this is required on some older browsers that don't support apply on console.log :(\r\n        console.log.apply(console, consoleArgs);\r\n      } else {\r\n        console.log(consoleArgs.join(' '));\r\n      }\r\n    } else if (level < LogLevel.Error) {\r\n      // Call .warn for Warn\r\n      if (console.warn.apply) {\r\n        console.warn.apply(console, consoleArgs);\r\n      } else {\r\n        console.warn(consoleArgs.join(' '));\r\n      }\r\n    } else {\r\n      // Call .error for Error/Fatal\r\n      if (console.error.apply) {\r\n        console.error.apply(console, consoleArgs);\r\n      } else {\r\n        console.error(consoleArgs.join(' '));\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport interface ScreenAppenderOptions {\r\n  engine: Engine;\r\n  /**\r\n   * Optionally set the width of the overlay canvas\r\n   */\r\n  width?: number;\r\n  /**\r\n   * Optionally set the height of the overlay canvas\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Adjust the text offset from the left side of the screen\r\n   */\r\n  xPos?: number;\r\n  /**\r\n   * Provide a text color\r\n   */\r\n  color?: Color;\r\n  /**\r\n   * Optionally set the CSS zindex of the overlay canvas\r\n   */\r\n  zIndex?: number;\r\n}\r\n\r\n/**\r\n * On-screen (canvas) appender\r\n */\r\nexport class ScreenAppender implements Appender {\r\n  private _messages: string[] = [];\r\n  public canvas: HTMLCanvasElement;\r\n  private _ctx: CanvasRenderingContext2D;\r\n  private _pos = 10;\r\n  private _color = Color.Black;\r\n  private _options: ScreenAppenderOptions;\r\n  constructor(options: ScreenAppenderOptions) {\r\n    this._options = options;\r\n    this.canvas = <HTMLCanvasElement>document.createElement('canvas');\r\n    this._ctx = this.canvas.getContext('2d')!;\r\n    this.canvas.style.position = 'absolute';\r\n    this.canvas.style.zIndex = options.zIndex?.toString() ?? '99';\r\n    document.body.appendChild(this.canvas);\r\n    this._positionScreenAppenderCanvas();\r\n    options.engine.screen.events.on('resize', () => {\r\n      this._positionScreenAppenderCanvas();\r\n    });\r\n  }\r\n\r\n  private _positionScreenAppenderCanvas() {\r\n    const options = this._options;\r\n    this.canvas.width = options.width ?? options.engine.screen.resolution.width;\r\n    this.canvas.height = options.height ?? options.engine.screen.resolution.height;\r\n    this.canvas.style.position = 'absolute';\r\n    const pagePos = options.engine.screen.screenToPageCoordinates(vec(0, 0));\r\n    this.canvas.style.left = pagePos.x + 'px';\r\n    this.canvas.style.top = pagePos.y + 'px';\r\n    this._pos = options.xPos ?? this._pos;\r\n    this._color = options.color ?? this._color;\r\n  }\r\n\r\n  /**\r\n   * Logs a message at the given {@apilink LogLevel}\r\n   * @param level  Level to log at\r\n   * @param args   Arguments to log\r\n   */\r\n  public log(level: LogLevel, args: any[]): void {\r\n    const message = args.join(',');\r\n\r\n    this._ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n\r\n    this._messages.unshift('[' + LogLevel[level] + '] : ' + message);\r\n\r\n    let pos = 10;\r\n\r\n    this._messages = this._messages.slice(0, 1000);\r\n    for (let i = 0; i < this._messages.length; i++) {\r\n      this._ctx.fillStyle = this._color.toRGBA();\r\n      this._ctx.fillText(this._messages[i], this._pos, pos);\r\n      pos += 10;\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\n\r\n/**\r\n * An enum that describes the sides of an axis aligned box for collision\r\n */\r\nexport enum Side {\r\n  None = 'None',\r\n  Top = 'Top',\r\n  Bottom = 'Bottom',\r\n  Left = 'Left',\r\n  Right = 'Right'\r\n}\r\n\r\nexport module Side {\r\n  /**\r\n   * Returns the opposite side from the current\r\n   */\r\n  export function getOpposite(side: Side): Side {\r\n    if (side === Side.Top) {\r\n      return Side.Bottom;\r\n    }\r\n    if (side === Side.Bottom) {\r\n      return Side.Top;\r\n    }\r\n    if (side === Side.Left) {\r\n      return Side.Right;\r\n    }\r\n    if (side === Side.Right) {\r\n      return Side.Left;\r\n    }\r\n\r\n    return Side.None;\r\n  }\r\n\r\n  /**\r\n   * Given a vector, return the Side most in that direction\r\n   */\r\n  export function fromDirection(direction: Vector): Side {\r\n    if (Math.abs(direction.x) >= Math.abs(direction.y)) {\r\n      if (direction.x <= 0) {\r\n        return Side.Left;\r\n      }\r\n\r\n      return Side.Right;\r\n    }\r\n\r\n    if (direction.y <= 0) {\r\n      return Side.Top;\r\n    }\r\n\r\n    return Side.Bottom;\r\n  }\r\n}\r\n","import { sign } from './util';\r\nimport { Vector, vec } from './vector';\r\nimport { canonicalizeAngle } from './util';\r\n\r\nexport enum MatrixLocations {\r\n  X = 12,\r\n  Y = 13\r\n}\r\n\r\n/**\r\n * Excalibur Matrix helper for 4x4 matrices\r\n *\r\n * Useful for webgl 4x4 matrices\r\n */\r\nexport class Matrix {\r\n  /**\r\n   *  4x4 matrix in column major order\r\n   *\r\n   * |         |         |          |          |\r\n   * | ------- | ------- | -------- | -------- |\r\n   * | data[0] | data[4] | data[8]  | data[12] |\r\n   * | data[1] | data[5] | data[9]  | data[13] |\r\n   * | data[2] | data[6] | data[10] | data[14] |\r\n   * | data[3] | data[7] | data[11] | data[15] |\r\n   *\r\n   */\r\n  public data: Float32Array = new Float32Array(16);\r\n\r\n  /**\r\n   * Creates an orthographic (flat non-perspective) projection\r\n   * https://en.wikipedia.org/wiki/Orthographic_projection\r\n   * @param left\r\n   * @param right\r\n   * @param bottom\r\n   * @param top\r\n   * @param near\r\n   * @param far\r\n   */\r\n  public static ortho(left: number, right: number, bottom: number, top: number, near: number, far: number): Matrix {\r\n    const mat = new Matrix();\r\n    mat.data[0] = 2 / (right - left);\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 2 / (top - bottom);\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = -2 / (far - near);\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = -(right + left) / (right - left);\r\n    mat.data[13] = -(top + bottom) / (top - bottom);\r\n    mat.data[14] = -(far + near) / (far - near);\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a new Matrix with the same data as the current 4x4\r\n   */\r\n  public clone(dest?: Matrix): Matrix {\r\n    const mat = dest || new Matrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = this.data[2];\r\n    mat.data[3] = this.data[3];\r\n\r\n    mat.data[4] = this.data[4];\r\n    mat.data[5] = this.data[5];\r\n    mat.data[6] = this.data[6];\r\n    mat.data[7] = this.data[7];\r\n\r\n    mat.data[8] = this.data[8];\r\n    mat.data[9] = this.data[9];\r\n    mat.data[10] = this.data[10];\r\n    mat.data[11] = this.data[11];\r\n\r\n    mat.data[12] = this.data[12];\r\n    mat.data[13] = this.data[13];\r\n    mat.data[14] = this.data[14];\r\n    mat.data[15] = this.data[15];\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Converts the current matrix into a DOMMatrix\r\n   *\r\n   * This is useful when working with the browser Canvas context\r\n   * @returns {DOMMatrix} DOMMatrix\r\n   */\r\n  public toDOMMatrix(): DOMMatrix {\r\n    return new DOMMatrix([...this.data]);\r\n  }\r\n\r\n  public static fromFloat32Array(data: Float32Array) {\r\n    const matrix = new Matrix();\r\n    matrix.data = data;\r\n    return matrix;\r\n  }\r\n\r\n  /**\r\n   * Creates a new identity matrix (a matrix that when applied does nothing)\r\n   */\r\n  public static identity(): Matrix {\r\n    const mat = new Matrix();\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 1;\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = 0;\r\n    mat.data[13] = 0;\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Resets the current matrix to the identity matrix, mutating it\r\n   * @returns {Matrix} Current matrix as identity\r\n   */\r\n  public reset(): Matrix {\r\n    const mat = this;\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 1;\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = 0;\r\n    mat.data[13] = 0;\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new translation matrix at the specified 3d point\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public static translation(x: number, y: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[12] = x;\r\n    mat.data[13] = y;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new scaling matrix with the specified scaling factor\r\n   * @param sx\r\n   * @param sy\r\n   */\r\n  public static scale(sx: number, sy: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[0] = sx;\r\n    mat.data[5] = sy;\r\n    mat.data[10] = 1;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new rotation matrix with the specified angle in radians\r\n   * @param angle\r\n   */\r\n  public static rotation(angle: number): Matrix {\r\n    const mat = Matrix.identity();\r\n    mat.data[0] = Math.cos(angle);\r\n    mat.data[4] = -Math.sin(angle);\r\n    mat.data[1] = Math.sin(angle);\r\n    mat.data[5] = Math.cos(angle);\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Multiply the current matrix by a vector producing a new vector\r\n   * @param vector\r\n   * @param dest\r\n   */\r\n  multiply(vector: Vector, dest?: Vector): Vector;\r\n  /**\r\n   * Multiply the current matrix by another matrix producing a new matrix\r\n   * @param matrix\r\n   * @param dest\r\n   */\r\n  multiply(matrix: Matrix, dest?: Matrix): Matrix;\r\n  multiply(vectorOrMatrix: Vector | Matrix, dest?: Vector | Matrix): Vector | Matrix {\r\n    if (vectorOrMatrix instanceof Vector) {\r\n      const result = (dest as Vector) || new Vector(0, 0);\r\n      const vector = vectorOrMatrix;\r\n      // these shenanigans are to allow dest and vector to be the same instance\r\n      const resultX = vector.x * this.data[0] + vector.y * this.data[4] + this.data[12];\r\n      const resultY = vector.x * this.data[1] + vector.y * this.data[5] + this.data[13];\r\n\r\n      result.x = resultX;\r\n      result.y = resultY;\r\n      return result;\r\n    } else {\r\n      const result = (dest as Matrix) || new Matrix();\r\n      const other = vectorOrMatrix;\r\n      const a11 = this.data[0];\r\n      const a21 = this.data[1];\r\n      const a31 = this.data[2];\r\n      const a41 = this.data[3];\r\n\r\n      const a12 = this.data[4];\r\n      const a22 = this.data[5];\r\n      const a32 = this.data[6];\r\n      const a42 = this.data[7];\r\n\r\n      const a13 = this.data[8];\r\n      const a23 = this.data[9];\r\n      const a33 = this.data[10];\r\n      const a43 = this.data[11];\r\n\r\n      const a14 = this.data[12];\r\n      const a24 = this.data[13];\r\n      const a34 = this.data[14];\r\n      const a44 = this.data[15];\r\n\r\n      const b11 = other.data[0];\r\n      const b21 = other.data[1];\r\n      const b31 = other.data[2];\r\n      const b41 = other.data[3];\r\n\r\n      const b12 = other.data[4];\r\n      const b22 = other.data[5];\r\n      const b32 = other.data[6];\r\n      const b42 = other.data[7];\r\n\r\n      const b13 = other.data[8];\r\n      const b23 = other.data[9];\r\n      const b33 = other.data[10];\r\n      const b43 = other.data[11];\r\n\r\n      const b14 = other.data[12];\r\n      const b24 = other.data[13];\r\n      const b34 = other.data[14];\r\n      const b44 = other.data[15];\r\n\r\n      result.data[0] = a11 * b11 + a12 * b21 + a13 * b31 + a14 * b41;\r\n      result.data[1] = a21 * b11 + a22 * b21 + a23 * b31 + a24 * b41;\r\n      result.data[2] = a31 * b11 + a32 * b21 + a33 * b31 + a34 * b41;\r\n      result.data[3] = a41 * b11 + a42 * b21 + a43 * b31 + a44 * b41;\r\n\r\n      result.data[4] = a11 * b12 + a12 * b22 + a13 * b32 + a14 * b42;\r\n      result.data[5] = a21 * b12 + a22 * b22 + a23 * b32 + a24 * b42;\r\n      result.data[6] = a31 * b12 + a32 * b22 + a33 * b32 + a34 * b42;\r\n      result.data[7] = a41 * b12 + a42 * b22 + a43 * b32 + a44 * b42;\r\n\r\n      result.data[8] = a11 * b13 + a12 * b23 + a13 * b33 + a14 * b43;\r\n      result.data[9] = a21 * b13 + a22 * b23 + a23 * b33 + a24 * b43;\r\n      result.data[10] = a31 * b13 + a32 * b23 + a33 * b33 + a34 * b43;\r\n      result.data[11] = a41 * b13 + a42 * b23 + a43 * b33 + a44 * b43;\r\n\r\n      result.data[12] = a11 * b14 + a12 * b24 + a13 * b34 + a14 * b44;\r\n      result.data[13] = a21 * b14 + a22 * b24 + a23 * b34 + a24 * b44;\r\n      result.data[14] = a31 * b14 + a32 * b24 + a33 * b34 + a34 * b44;\r\n      result.data[15] = a41 * b14 + a42 * b24 + a43 * b34 + a44 * b44;\r\n\r\n      const s = this.getScale();\r\n      result._scaleSignX = sign(s.x) * sign(result._scaleSignX);\r\n      result._scaleSignY = sign(s.y) * sign(result._scaleSignY);\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Applies translation to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    const a13 = this.data[8];\r\n    const a23 = this.data[9];\r\n    const a33 = this.data[10];\r\n    const a43 = this.data[11];\r\n\r\n    const a14 = this.data[12];\r\n    const a24 = this.data[13];\r\n    const a34 = this.data[14];\r\n    const a44 = this.data[15];\r\n\r\n    // Doesn't change z\r\n    const z = 0;\r\n    const w = 1;\r\n    this.data[12] = a11 * x + a12 * y + a13 * z + a14 * w;\r\n    this.data[13] = a21 * x + a22 * y + a23 * z + a24 * w;\r\n    this.data[14] = a31 * x + a32 * y + a33 * z + a34 * w;\r\n    this.data[15] = a41 * x + a42 * y + a43 * z + a44 * w;\r\n\r\n    return this;\r\n  }\r\n\r\n  public setPosition(x: number, y: number) {\r\n    this.data[12] = x;\r\n    this.data[13] = y;\r\n  }\r\n\r\n  public getPosition(): Vector {\r\n    return vec(this.data[12], this.data[13]);\r\n  }\r\n\r\n  /**\r\n   * Applies rotation to the current matrix mutating it\r\n   * @param angle in Radians\r\n   */\r\n  rotate(angle: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * a11 + sine * a12;\r\n    this.data[1] = cosine * a21 + sine * a22;\r\n    this.data[2] = cosine * a31 + sine * a32;\r\n    this.data[3] = cosine * a41 + sine * a42;\r\n\r\n    this.data[4] = cosine * a12 - sine * a11;\r\n    this.data[5] = cosine * a22 - sine * a21;\r\n    this.data[6] = cosine * a32 - sine * a31;\r\n    this.data[7] = cosine * a42 - sine * a41;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies scaling to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    const a31 = this.data[2];\r\n    const a41 = this.data[3];\r\n\r\n    const a12 = this.data[4];\r\n    const a22 = this.data[5];\r\n    const a32 = this.data[6];\r\n    const a42 = this.data[7];\r\n\r\n    this.data[0] = a11 * x;\r\n    this.data[1] = a21 * x;\r\n    this.data[2] = a31 * x;\r\n    this.data[3] = a41 * x;\r\n\r\n    this.data[4] = a12 * y;\r\n    this.data[5] = a22 * y;\r\n    this.data[6] = a32 * y;\r\n    this.data[7] = a42 * y;\r\n\r\n    return this;\r\n  }\r\n\r\n  public setRotation(angle: number) {\r\n    const currentScale = this.getScale();\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * currentScale.x;\r\n    this.data[1] = sine * currentScale.y;\r\n    this.data[4] = -sine * currentScale.x;\r\n    this.data[5] = cosine * currentScale.y;\r\n  }\r\n\r\n  public getRotation(): number {\r\n    const angle = Math.atan2(this.data[1] / this.getScaleY(), this.data[0] / this.getScaleX());\r\n    return canonicalizeAngle(angle);\r\n  }\r\n\r\n  public getScaleX(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const xscale = vec(this.data[0], this.data[4]).magnitude;\r\n    return this._scaleSignX * xscale;\r\n  }\r\n\r\n  public getScaleY(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const yscale = vec(this.data[1], this.data[5]).magnitude;\r\n    return this._scaleSignY * yscale;\r\n  }\r\n\r\n  /**\r\n   * Get the scale of the matrix\r\n   */\r\n  public getScale(): Vector {\r\n    return vec(this.getScaleX(), this.getScaleY());\r\n  }\r\n\r\n  private _scaleX = 1;\r\n  private _scaleSignX = 1;\r\n  public setScaleX(val: number) {\r\n    if (this._scaleX === val) {\r\n      return;\r\n    }\r\n\r\n    this._scaleSignX = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const xscale = vec(this.data[0] * this._scaleSignX, this.data[4] * this._scaleSignX).normalize();\r\n    this.data[0] = xscale.x * val;\r\n    this.data[4] = xscale.y * val;\r\n    this._scaleX = val;\r\n  }\r\n\r\n  private _scaleY = 1;\r\n  private _scaleSignY = 1;\r\n  public setScaleY(val: number) {\r\n    if (this._scaleY === val) {\r\n      return;\r\n    }\r\n    this._scaleSignY = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const yscale = vec(this.data[1] * this._scaleSignY, this.data[5] * this._scaleSignY).normalize();\r\n    this.data[1] = yscale.x * val;\r\n    this.data[5] = yscale.y * val;\r\n    this._scaleY = val;\r\n  }\r\n\r\n  public setScale(scale: Vector) {\r\n    this.setScaleX(scale.x);\r\n    this.setScaleY(scale.y);\r\n  }\r\n\r\n  /**\r\n   * Determinant of the upper left 2x2 matrix\r\n   */\r\n  public getBasisDeterminant() {\r\n    return this.data[0] * this.data[5] - this.data[1] * this.data[4];\r\n  }\r\n\r\n  /**\r\n   * Return the affine inverse, optionally store it in a target matrix.\r\n   *\r\n   * It's recommended you call .reset() the target unless you know what you're doing\r\n   * @param target\r\n   */\r\n  public getAffineInverse(target?: Matrix): Matrix {\r\n    // See http://negativeprobability.blogspot.com/2011/11/affine-transformations-and-their.html\r\n    // See https://www.mathsisfun.com/algebra/matrix-inverse.html\r\n    // Since we are actually only doing 2D transformations we can use this hack\r\n    // We don't actually use the 3rd or 4th dimension\r\n\r\n    const det = this.getBasisDeterminant();\r\n    const inverseDet = 1 / det; // todo zero check\r\n    const a = this.data[0];\r\n    const b = this.data[4];\r\n    const c = this.data[1];\r\n    const d = this.data[5];\r\n\r\n    const m = target || Matrix.identity();\r\n    // inverts rotation and scale\r\n    m.data[0] = d * inverseDet;\r\n    m.data[1] = -c * inverseDet;\r\n    m.data[4] = -b * inverseDet;\r\n    m.data[5] = a * inverseDet;\r\n\r\n    const tx = this.data[12];\r\n    const ty = this.data[13];\r\n    // invert translation\r\n    // transform translation into the matrix basis created by rot/scale\r\n    m.data[12] = -(tx * m.data[0] + ty * m.data[4]);\r\n    m.data[13] = -(tx * m.data[1] + ty * m.data[5]);\r\n\r\n    return m;\r\n  }\r\n\r\n  public isIdentity(): boolean {\r\n    return (\r\n      this.data[0] === 1 &&\r\n      this.data[1] === 0 &&\r\n      this.data[2] === 0 &&\r\n      this.data[3] === 0 &&\r\n      this.data[4] === 0 &&\r\n      this.data[5] === 1 &&\r\n      this.data[6] === 0 &&\r\n      this.data[7] === 0 &&\r\n      this.data[8] === 0 &&\r\n      this.data[9] === 0 &&\r\n      this.data[10] === 1 &&\r\n      this.data[11] === 0 &&\r\n      this.data[12] === 0 &&\r\n      this.data[13] === 0 &&\r\n      this.data[14] === 0 &&\r\n      this.data[15] === 1\r\n    );\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\n[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]\r\n[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]\r\n[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]\r\n[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]\r\n`;\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Ray } from '../Math/ray';\r\nimport { Color } from '../Color';\r\nimport { Side } from './Side';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { AffineMatrix } from '../Math/affine-matrix';\r\n\r\nexport interface BoundingBoxOptions {\r\n  left: number;\r\n  right: number;\r\n  top: number;\r\n  bottom: number;\r\n}\r\n\r\n/**\r\n * Axis Aligned collision primitive for Excalibur.\r\n */\r\nexport class BoundingBox {\r\n  public top: number;\r\n  public right: number;\r\n  public bottom: number;\r\n  public left: number;\r\n\r\n  /**\r\n   * Constructor allows passing of either an object with all coordinate components,\r\n   * or the coordinate components passed separately.\r\n   * @param leftOrOptions    Either x coordinate of the left edge or an options object\r\n   * containing the four coordinate components.\r\n   * @param top     y coordinate of the top edge\r\n   * @param right   x coordinate of the right edge\r\n   * @param bottom  y coordinate of the bottom edge\r\n   */\r\n  constructor(leftOrOptions: number | BoundingBoxOptions = 0, top: number = 0, right: number = 0, bottom: number = 0) {\r\n    if (typeof leftOrOptions === 'object') {\r\n      this.left = leftOrOptions.left;\r\n      this.top = leftOrOptions.top;\r\n      this.right = leftOrOptions.right;\r\n      this.bottom = leftOrOptions.bottom;\r\n    } else if (typeof leftOrOptions === 'number') {\r\n      this.left = leftOrOptions;\r\n      this.top = top;\r\n      this.right = right;\r\n      this.bottom = bottom;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a new instance of {@apilink BoundingBox} that is a copy of the current instance\r\n   */\r\n  public clone(dest?: BoundingBox): BoundingBox {\r\n    const result = dest || new BoundingBox(0, 0, 0, 0);\r\n    result.left = this.left;\r\n    result.right = this.right;\r\n    result.top = this.top;\r\n    result.bottom = this.bottom;\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Resets the bounds to a zero width/height box\r\n   */\r\n  public reset(): void {\r\n    this.left = 0;\r\n    this.top = 0;\r\n    this.bottom = 0;\r\n    this.right = 0;\r\n  }\r\n\r\n  /**\r\n   * Given bounding box A & B, returns the side relative to A when intersection is performed.\r\n   * @param intersection Intersection vector between 2 bounding boxes\r\n   */\r\n  public static getSideFromIntersection(intersection: Vector): Side {\r\n    if (!intersection) {\r\n      return Side.None;\r\n    }\r\n    if (intersection) {\r\n      if (Math.abs(intersection.x) > Math.abs(intersection.y)) {\r\n        if (intersection.x < 0) {\r\n          return Side.Right;\r\n        }\r\n        return Side.Left;\r\n      } else {\r\n        if (intersection.y < 0) {\r\n          return Side.Bottom;\r\n        }\r\n        return Side.Top;\r\n      }\r\n    }\r\n    return Side.None;\r\n  }\r\n\r\n  public static fromPoints(points: Vector[]): BoundingBox {\r\n    let minX = Infinity;\r\n    let minY = Infinity;\r\n    let maxX = -Infinity;\r\n    let maxY = -Infinity;\r\n    for (let i = 0; i < points.length; i++) {\r\n      if (points[i].x < minX) {\r\n        minX = points[i].x;\r\n      }\r\n      if (points[i].x > maxX) {\r\n        maxX = points[i].x;\r\n      }\r\n      if (points[i].y < minY) {\r\n        minY = points[i].y;\r\n      }\r\n      if (points[i].y > maxY) {\r\n        maxY = points[i].y;\r\n      }\r\n    }\r\n    return new BoundingBox(minX, minY, maxX, maxY);\r\n  }\r\n\r\n  /**\r\n   * Creates a bounding box from a width and height\r\n   * @param width\r\n   * @param height\r\n   * @param anchor Default Vector.Half\r\n   * @param pos Default Vector.Zero\r\n   */\r\n  public static fromDimension(width: number, height: number, anchor: Vector = Vector.Half, pos: Vector = Vector.Zero) {\r\n    return new BoundingBox(\r\n      -width * anchor.x + pos.x,\r\n      -height * anchor.y + pos.y,\r\n      width - width * anchor.x + pos.x,\r\n      height - height * anchor.y + pos.y\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Returns the calculated width of the bounding box\r\n   */\r\n  public get width() {\r\n    return this.right - this.left;\r\n  }\r\n\r\n  /**\r\n   * Returns the calculated height of the bounding box\r\n   */\r\n  public get height() {\r\n    return this.bottom - this.top;\r\n  }\r\n\r\n  /**\r\n   * Return whether the bounding box has zero dimensions in height,width or both\r\n   */\r\n  public hasZeroDimensions() {\r\n    return this.width === 0 || this.height === 0;\r\n  }\r\n\r\n  /**\r\n   * Returns the center of the bounding box\r\n   */\r\n  public get center(): Vector {\r\n    return new Vector((this.left + this.right) / 2, (this.top + this.bottom) / 2);\r\n  }\r\n\r\n  public get topLeft(): Vector {\r\n    return new Vector(this.left, this.top);\r\n  }\r\n\r\n  public get bottomRight(): Vector {\r\n    return new Vector(this.right, this.bottom);\r\n  }\r\n\r\n  public get topRight(): Vector {\r\n    return new Vector(this.right, this.top);\r\n  }\r\n\r\n  public get bottomLeft(): Vector {\r\n    return new Vector(this.left, this.bottom);\r\n  }\r\n\r\n  public translate(pos: Vector): BoundingBox {\r\n    return new BoundingBox(this.left + pos.x, this.top + pos.y, this.right + pos.x, this.bottom + pos.y);\r\n  }\r\n\r\n  /**\r\n   * Rotates a bounding box by and angle and around a point, if no point is specified (0, 0) is used by default. The resulting bounding\r\n   * box is also axis-align. This is useful when a new axis-aligned bounding box is needed for rotated geometry.\r\n   */\r\n  public rotate(angle: number, point: Vector = Vector.Zero): BoundingBox {\r\n    const points = this.getPoints().map((p) => p.rotate(angle, point));\r\n    return BoundingBox.fromPoints(points);\r\n  }\r\n\r\n  /**\r\n   * Scale a bounding box by a scale factor, optionally provide a point\r\n   * @param scale\r\n   * @param point\r\n   */\r\n  public scale(scale: Vector, point: Vector = Vector.Zero): BoundingBox {\r\n    const shifted = this.translate(point);\r\n    return new BoundingBox(shifted.left * scale.x, shifted.top * scale.y, shifted.right * scale.x, shifted.bottom * scale.y);\r\n  }\r\n\r\n  /**\r\n   * Transform the axis aligned bounding box by a {@apilink Matrix}, producing a new axis aligned bounding box\r\n   * @param matrix\r\n   */\r\n  public transform(matrix: AffineMatrix) {\r\n    // inlined these calculations to not use vectors would speed it up slightly\r\n    // const matFirstColumn = vec(matrix.data[0], matrix.data[1]);\r\n    // const xa = matFirstColumn.scale(this.left);\r\n    const xa1 = matrix.data[0] * this.left;\r\n    const xa2 = matrix.data[1] * this.left;\r\n\r\n    // const xb = matFirstColumn.scale(this.right);\r\n    const xb1 = matrix.data[0] * this.right;\r\n    const xb2 = matrix.data[1] * this.right;\r\n\r\n    // const matSecondColumn = vec(matrix.data[2], matrix.data[3]);\r\n    // const ya = matSecondColumn.scale(this.top);\r\n    const ya1 = matrix.data[2] * this.top;\r\n    const ya2 = matrix.data[3] * this.top;\r\n\r\n    // const yb = matSecondColumn.scale(this.bottom);\r\n    const yb1 = matrix.data[2] * this.bottom;\r\n    const yb2 = matrix.data[3] * this.bottom;\r\n\r\n    const matrixPos = matrix.getPosition();\r\n    // const topLeft = Vector.min(xa, xb).add(Vector.min(ya, yb)).add(matrixPos);\r\n    // const bottomRight = Vector.max(xa, xb).add(Vector.max(ya, yb)).add(matrixPos);\r\n    const left = Math.min(xa1, xb1) + Math.min(ya1, yb1) + matrixPos.x;\r\n    const top = Math.min(xa2, xb2) + Math.min(ya2, yb2) + matrixPos.y;\r\n    const right = Math.max(xa1, xb1) + Math.max(ya1, yb1) + matrixPos.x;\r\n    const bottom = Math.max(xa2, xb2) + Math.max(ya2, yb2) + matrixPos.y;\r\n\r\n    return new BoundingBox({\r\n      left, //: topLeft.x,\r\n      top, //: topLeft.y,\r\n      right, //: bottomRight.x,\r\n      bottom //: bottomRight.y\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the perimeter of the bounding box\r\n   */\r\n  public getPerimeter(): number {\r\n    const wx = this.width;\r\n    const wy = this.height;\r\n    return 2 * (wx + wy);\r\n  }\r\n\r\n  // Cache bounding box point returns\r\n  private _points: Vector[] = [];\r\n  private _left?: number;\r\n  private _right?: number;\r\n  private _top?: number;\r\n  private _bottom?: number;\r\n\r\n  /**\r\n   * Returns the world space points that make up the corners of the bounding box as a polygon\r\n   */\r\n  public getPoints(): Vector[] {\r\n    if (this._left !== this.left || this._right !== this.right || this._top !== this.top || this._bottom !== this.bottom) {\r\n      this._points.length = 0;\r\n      this._points.push(new Vector(this.left, this.top));\r\n      this._points.push(new Vector(this.right, this.top));\r\n      this._points.push(new Vector(this.right, this.bottom));\r\n      this._points.push(new Vector(this.left, this.bottom));\r\n      this._left = this.left;\r\n      this._right = this.right;\r\n      this._top = this.top;\r\n      this._bottom = this.bottom;\r\n    }\r\n    return this._points;\r\n  }\r\n\r\n  /**\r\n   * Determines whether a ray intersects with a bounding box\r\n   */\r\n  public rayCast(ray: Ray, farClipDistance = Infinity): boolean {\r\n    // algorithm from https://tavianator.com/fast-branchless-raybounding-box-intersections/\r\n    let tMin = -Infinity;\r\n    let tMax = +Infinity;\r\n\r\n    const xInv = ray.dir.x === 0 ? Number.MAX_VALUE : 1 / ray.dir.x;\r\n    const yInv = ray.dir.y === 0 ? Number.MAX_VALUE : 1 / ray.dir.y;\r\n\r\n    const tx1 = (this.left - ray.pos.x) * xInv;\r\n    const tx2 = (this.right - ray.pos.x) * xInv;\r\n    tMin = Math.min(tx1, tx2);\r\n    tMax = Math.max(tx1, tx2);\r\n\r\n    const ty1 = (this.top - ray.pos.y) * yInv;\r\n    const ty2 = (this.bottom - ray.pos.y) * yInv;\r\n    tMin = Math.max(tMin, Math.min(ty1, ty2));\r\n    tMax = Math.min(tMax, Math.max(ty1, ty2));\r\n\r\n    return tMax >= Math.max(0, tMin) && tMin < farClipDistance;\r\n  }\r\n\r\n  public rayCastTime(ray: Ray, farClipDistance = Infinity): number {\r\n    // algorithm from https://tavianator.com/fast-branchless-raybounding-box-intersections/\r\n    let tMin = -Infinity;\r\n    let tMax = +Infinity;\r\n\r\n    const xInv = ray.dir.x === 0 ? Number.MAX_VALUE : 1 / ray.dir.x;\r\n    const yInv = ray.dir.y === 0 ? Number.MAX_VALUE : 1 / ray.dir.y;\r\n\r\n    const tx1 = (this.left - ray.pos.x) * xInv;\r\n    const tx2 = (this.right - ray.pos.x) * xInv;\r\n    tMin = Math.min(tx1, tx2);\r\n    tMax = Math.max(tx1, tx2);\r\n\r\n    const ty1 = (this.top - ray.pos.y) * yInv;\r\n    const ty2 = (this.bottom - ray.pos.y) * yInv;\r\n    tMin = Math.max(tMin, Math.min(ty1, ty2));\r\n    tMax = Math.min(tMax, Math.max(ty1, ty2));\r\n\r\n    if (tMax >= Math.max(0, tMin) && tMin < farClipDistance) {\r\n      return tMin;\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  /**\r\n   * Tests whether a point is contained within the bounding box\r\n   * @param p  The point to test\r\n   */\r\n  public contains(p: Vector): boolean;\r\n\r\n  /**\r\n   * Tests whether another bounding box is totally contained in this one\r\n   * @param bb  The bounding box to test\r\n   */\r\n  public contains(bb: BoundingBox): boolean;\r\n  public contains(val: any): boolean {\r\n    if (val instanceof Vector) {\r\n      return this.left <= val.x && this.top <= val.y && val.y <= this.bottom && val.x <= this.right;\r\n    } else if (val instanceof BoundingBox) {\r\n      return this.left <= val.left && this.top <= val.top && val.bottom <= this.bottom && val.right <= this.right;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Combines this bounding box and another together returning a new bounding box\r\n   * @param other  The bounding box to combine\r\n   */\r\n  public combine(other: BoundingBox, dest?: BoundingBox): BoundingBox {\r\n    const compositeBB = dest || new BoundingBox(0, 0, 0, 0);\r\n    const left = Math.min(this.left, other.left);\r\n    const top = Math.min(this.top, other.top);\r\n    const right = Math.max(this.right, other.right);\r\n    const bottom = Math.max(this.bottom, other.bottom);\r\n    compositeBB.left = left;\r\n    compositeBB.top = top;\r\n    compositeBB.right = right;\r\n    compositeBB.bottom = bottom;\r\n    return compositeBB;\r\n  }\r\n\r\n  public get dimensions(): Vector {\r\n    return new Vector(this.width, this.height);\r\n  }\r\n\r\n  /**\r\n   * Returns true if the bounding boxes overlap.\r\n   * @param other\r\n   * @param epsilon Optionally specify a small epsilon (default 0) as amount of overlap to ignore as overlap.\r\n   * This epsilon is useful in stable collision simulations.\r\n   */\r\n  public overlaps(other: BoundingBox, epsilon?: number): boolean {\r\n    const e = epsilon || 0;\r\n    if (other.hasZeroDimensions()) {\r\n      return this.contains(other);\r\n    }\r\n    if (this.hasZeroDimensions()) {\r\n      return other.contains(this);\r\n    }\r\n    const totalBoundingBox = this.combine(other);\r\n    return totalBoundingBox.width + e < other.width + this.width && totalBoundingBox.height + e < other.height + this.height;\r\n  }\r\n\r\n  /**\r\n   * Test wether this bounding box intersects with another returning\r\n   * the intersection vector that can be used to resolve the collision. If there\r\n   * is no intersection null is returned.\r\n   * @param other  Other {@apilink BoundingBox} to test intersection with\r\n   * @returns A Vector in the direction of the current BoundingBox, this <- other\r\n   */\r\n  public intersect(other: BoundingBox): Vector {\r\n    const totalBoundingBox = this.combine(other);\r\n\r\n    // If the total bounding box is less than or equal the sum of the 2 bounds then there is collision\r\n    if (\r\n      totalBoundingBox.width < other.width + this.width &&\r\n      totalBoundingBox.height < other.height + this.height &&\r\n      !totalBoundingBox.dimensions.equals(other.dimensions) &&\r\n      !totalBoundingBox.dimensions.equals(this.dimensions)\r\n    ) {\r\n      // collision\r\n      let overlapX = 0;\r\n      // right edge is between the other's left and right edge\r\n      /**\r\n       *     +-this-+\r\n       *     |      |\r\n       *     |    +-other-+\r\n       *     +----|-+     |\r\n       *          |       |\r\n       *          +-------+\r\n       *         <---\r\n       *          ^ overlap\r\n       */\r\n      if (this.right >= other.left && this.right <= other.right) {\r\n        overlapX = other.left - this.right;\r\n        // right edge is past the other's right edge\r\n        /**\r\n         *     +-other-+\r\n         *     |       |\r\n         *     |    +-this-+\r\n         *     +----|--+   |\r\n         *          |      |\r\n         *          +------+\r\n         *          --->\r\n         *          ^ overlap\r\n         */\r\n      } else {\r\n        overlapX = other.right - this.left;\r\n      }\r\n\r\n      let overlapY = 0;\r\n      // top edge is between the other's top and bottom edge\r\n      /**\r\n       *     +-other-+\r\n       *     |       |\r\n       *     |    +-this-+   | <- overlap\r\n       *     +----|--+   |   |\r\n       *          |      |  \\ /\r\n       *          +------+   '\r\n       */\r\n      if (this.top <= other.bottom && this.top >= other.top) {\r\n        overlapY = other.bottom - this.top;\r\n        // top edge is above the other top edge\r\n        /**\r\n         *     +-this-+         .\r\n         *     |      |        / \\\r\n         *     |    +-other-+   | <- overlap\r\n         *     +----|-+     |   |\r\n         *          |       |\r\n         *          +-------+\r\n         */\r\n      } else {\r\n        overlapY = other.top - this.bottom;\r\n      }\r\n\r\n      if (Math.abs(overlapX) < Math.abs(overlapY)) {\r\n        return new Vector(overlapX, 0);\r\n      } else {\r\n        return new Vector(0, overlapY);\r\n      }\r\n      // Case of total containment of one bounding box by another\r\n    } else if (totalBoundingBox.dimensions.equals(other.dimensions) || totalBoundingBox.dimensions.equals(this.dimensions)) {\r\n      let overlapX = 0;\r\n      // this is wider than the other\r\n      if (this.width - other.width >= 0) {\r\n        // This right edge is closest to the others right edge\r\n        if (this.right - other.right <= other.left - this.left) {\r\n          overlapX = other.left - this.right;\r\n          // This left edge is closest to the others left edge\r\n        } else {\r\n          overlapX = other.right - this.left;\r\n        }\r\n        // other is wider than this\r\n      } else {\r\n        // This right edge is closest to the others right edge\r\n        if (other.right - this.right <= this.left - other.left) {\r\n          overlapX = this.left - other.right;\r\n          // This left edge is closest to the others left edge\r\n        } else {\r\n          overlapX = this.right - other.left;\r\n        }\r\n      }\r\n\r\n      let overlapY = 0;\r\n      // this is taller than other\r\n      if (this.height - other.height >= 0) {\r\n        // The bottom edge is closest to the others bottom edge\r\n        if (this.bottom - other.bottom <= other.top - this.top) {\r\n          overlapY = other.top - this.bottom;\r\n        } else {\r\n          overlapY = other.bottom - this.top;\r\n        }\r\n        // other is taller than this\r\n      } else {\r\n        // The bottom edge is closest to the others bottom edge\r\n        if (other.bottom - this.bottom <= this.top - other.top) {\r\n          overlapY = this.top - other.bottom;\r\n        } else {\r\n          overlapY = this.bottom - other.top;\r\n        }\r\n      }\r\n\r\n      if (Math.abs(overlapX) < Math.abs(overlapY)) {\r\n        return new Vector(overlapX, 0);\r\n      } else {\r\n        return new Vector(0, overlapY);\r\n      }\r\n    } else {\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Test whether the bounding box has intersected with another bounding box, returns the side of the current bb that intersected.\r\n   * @param bb The other actor to test\r\n   */\r\n  public intersectWithSide(bb: BoundingBox): Side {\r\n    const intersect = this.intersect(bb);\r\n    return BoundingBox.getSideFromIntersection(intersect);\r\n  }\r\n\r\n  /**\r\n   * Draw a debug bounding box\r\n   * @param ex\r\n   * @param color\r\n   */\r\n  public draw(ex: ExcaliburGraphicsContext, color: Color = Color.Yellow) {\r\n    ex.debug.drawRect(this.left, this.top, this.width, this.height, { color });\r\n  }\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { Clock } from './Clock';\r\nimport { Future } from './Future';\r\n\r\n/**\r\n * Find the screen position of an HTML element\r\n */\r\nexport function getPosition(el: HTMLElement): Vector {\r\n  // do we need the scroll too? technically the offset method before did that\r\n  if (el && el.getBoundingClientRect) {\r\n    const rect = el.getBoundingClientRect();\r\n    return vec(rect.x + window.scrollX, rect.y + window.scrollY);\r\n  }\r\n  return Vector.Zero;\r\n}\r\n\r\n/**\r\n * Add an item to an array list if it doesn't already exist. Returns true if added, false if not and already exists in the array.\r\n * @deprecated Will be removed in v0.26.0\r\n */\r\nexport function addItemToArray<T>(item: T, array: T[]): boolean {\r\n  if (array.indexOf(item) === -1) {\r\n    array.push(item);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Remove an item from an list\r\n * @deprecated Will be removed in v0.26.0\r\n */\r\nexport function removeItemFromArray<T>(item: T, array: T[]): boolean {\r\n  let index = -1;\r\n  if ((index = array.indexOf(item)) > -1) {\r\n    array.splice(index, 1);\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\n/**\r\n * See if an array contains something\r\n */\r\nexport function contains(array: Array<any>, obj: any): boolean {\r\n  for (let i = 0; i < array.length; i++) {\r\n    if (array[i] === obj) {\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Used for exhaustive checks at compile time\r\n */\r\nexport function fail(message: never): never {\r\n  throw new Error(message);\r\n}\r\n\r\n/**\r\n * Create a promise that resolves after a certain number of milliseconds\r\n *\r\n * It is strongly recommended you pass the excalibur clock so delays are bound to the\r\n * excalibur clock which would be unaffected by stop/pause.\r\n * @param milliseconds\r\n * @param clock\r\n */\r\nexport function delay(milliseconds: number, clock?: Clock): Promise<void> {\r\n  const future = new Future<void>();\r\n  const schedule = clock?.schedule.bind(clock) ?? setTimeout;\r\n  schedule(() => {\r\n    future.resolve();\r\n  }, milliseconds);\r\n  return future.promise;\r\n}\r\n\r\n/**\r\n * Remove keys from object literals\r\n * @param object\r\n * @param keys\r\n */\r\nexport function omit<TObject extends Object, Keys extends keyof TObject>(object: TObject, keys: Keys[]) {\r\n  const newObj: Omit<TObject, Keys> = {} as any;\r\n  for (const key in object) {\r\n    if (!keys.includes(key as any)) {\r\n      (newObj as any)[key] = object[key];\r\n    }\r\n  }\r\n  return newObj;\r\n}\r\n\r\n/**\r\n * Simple object check.\r\n * @param item\r\n */\r\nexport function isObject(item: any): item is object {\r\n  return item && typeof item === 'object' && !Array.isArray(item);\r\n}\r\n\r\n/**\r\n * Deep merge two objects.\r\n * @param target\r\n * @param sources\r\n */\r\nexport function mergeDeep<T extends object>(target: T, ...sources: T[]) {\r\n  if (!sources.length) {\r\n    return target;\r\n  }\r\n  const source = sources.shift();\r\n\r\n  if (isObject(target) && isObject(source)) {\r\n    for (const key in source) {\r\n      if (isObject(source[key])) {\r\n        if (!target[key]) {\r\n          Object.assign(target, { [key]: {} });\r\n        }\r\n        mergeDeep(target[key] as any, source[key]);\r\n      } else {\r\n        Object.assign(target, { [key]: source[key] });\r\n      }\r\n    }\r\n  }\r\n\r\n  return mergeDeep(target, ...sources);\r\n}\r\n","import { Matrix } from './matrix';\r\nimport { canonicalizeAngle, sign } from './util';\r\nimport { vec, Vector } from './vector';\r\n\r\nexport class AffineMatrix {\r\n  /**\r\n   * |         |         |          |\r\n   * | ------- | ------- | -------- |\r\n   * | data[0] | data[2] | data[4]  |\r\n   * | data[1] | data[3] | data[5]  |\r\n   * |   0     |    0    |    1     |\r\n   */\r\n  public data = new Float64Array(6);\r\n\r\n  /**\r\n   * Converts the current matrix into a DOMMatrix\r\n   *\r\n   * This is useful when working with the browser Canvas context\r\n   * @returns {DOMMatrix} DOMMatrix\r\n   */\r\n  public toDOMMatrix(): DOMMatrix {\r\n    return new DOMMatrix([...this.data]);\r\n  }\r\n\r\n  public static identity(): AffineMatrix {\r\n    const mat = new AffineMatrix();\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 1;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 0;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new translation matrix at the specified 3d point\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public static translation(x: number, y: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[4] = x;\r\n    mat.data[5] = y;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new scaling matrix with the specified scaling factor\r\n   * @param sx\r\n   * @param sy\r\n   */\r\n  public static scale(sx: number, sy: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[0] = sx;\r\n    mat.data[3] = sy;\r\n    mat._scale[0] = sx;\r\n    mat._scale[1] = sy;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a brand new rotation matrix with the specified angle in radians\r\n   * @param angle\r\n   */\r\n  public static rotation(angle: number): AffineMatrix {\r\n    const mat = AffineMatrix.identity();\r\n    mat.data[0] = Math.cos(angle);\r\n    mat.data[1] = Math.sin(angle);\r\n    mat.data[2] = -Math.sin(angle);\r\n    mat.data[3] = Math.cos(angle);\r\n    return mat;\r\n  }\r\n\r\n  public setPosition(x: number, y: number) {\r\n    this.data[4] = x;\r\n    this.data[5] = y;\r\n  }\r\n\r\n  public getPosition(): Vector {\r\n    return vec(this.data[4], this.data[5]);\r\n  }\r\n\r\n  /**\r\n   * Applies rotation to the current matrix mutating it\r\n   * @param angle in Radians\r\n   */\r\n  rotate(angle: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * a11 + sine * a12;\r\n    this.data[1] = cosine * a21 + sine * a22;\r\n\r\n    this.data[2] = cosine * a12 - sine * a11;\r\n    this.data[3] = cosine * a22 - sine * a21;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies translation to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n    // const a31 = 0;\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n    // const a32 = 0;\r\n\r\n    const a13 = this.data[4];\r\n    const a23 = this.data[5];\r\n    // const a33 = 1;\r\n\r\n    // Doesn't change z\r\n    this.data[4] = a11 * x + a12 * y + a13;\r\n    this.data[5] = a21 * x + a22 * y + a23;\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Applies scaling to the current matrix mutating it\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number) {\r\n    const a11 = this.data[0];\r\n    const a21 = this.data[1];\r\n\r\n    const a12 = this.data[2];\r\n    const a22 = this.data[3];\r\n\r\n    this.data[0] = a11 * x;\r\n    this.data[1] = a21 * x;\r\n\r\n    this.data[2] = a12 * y;\r\n    this.data[3] = a22 * y;\r\n\r\n    this._scale[0] = x;\r\n    this._scale[1] = y;\r\n    this._scaleSignX = sign(x);\r\n    this._scaleSignY = sign(y);\r\n    return this;\r\n  }\r\n\r\n  public determinant() {\r\n    return this.data[0] * this.data[3] - this.data[1] * this.data[2];\r\n  }\r\n\r\n  /**\r\n   * Return the affine inverse, optionally store it in a target matrix.\r\n   *\r\n   * It's recommended you call .reset() the target unless you know what you're doing\r\n   * @param target\r\n   */\r\n  public inverse(target?: AffineMatrix): AffineMatrix {\r\n    // See http://negativeprobability.blogspot.com/2011/11/affine-transformations-and-their.html\r\n    // See https://www.mathsisfun.com/algebra/matrix-inverse.html\r\n    // Since we are actually only doing 2D transformations we can use this hack\r\n    // We don't actually use the 3rd or 4th dimension\r\n\r\n    const det = this.determinant();\r\n    let inverseDet = det; // default to a zero matrix if we have a singular matrix\r\n    if (det !== 0) {\r\n      inverseDet = 1 / det;\r\n    }\r\n    const a = this.data[0];\r\n    const b = this.data[2];\r\n    const c = this.data[1];\r\n    const d = this.data[3];\r\n\r\n    const m = target || AffineMatrix.identity();\r\n    // inverts rotation and scale\r\n    m.data[0] = d * inverseDet;\r\n    m.data[1] = -c * inverseDet;\r\n    m.data[2] = -b * inverseDet;\r\n    m.data[3] = a * inverseDet;\r\n\r\n    const tx = this.data[4];\r\n    const ty = this.data[5];\r\n    // invert translation\r\n    // transform translation into the matrix basis created by rot/scale\r\n    m.data[4] = -(tx * m.data[0] + ty * m.data[2]);\r\n    m.data[5] = -(tx * m.data[1] + ty * m.data[3]);\r\n\r\n    return m;\r\n  }\r\n\r\n  /**\r\n   * Multiply the current matrix by a vector producing a new vector\r\n   * @param vector\r\n   * @param dest\r\n   */\r\n  multiply(vector: Vector, dest?: Vector): Vector;\r\n  /**\r\n   * Multiply the current matrix by another matrix producing a new matrix\r\n   * @param matrix\r\n   * @param dest\r\n   */\r\n  multiply(matrix: AffineMatrix, dest?: AffineMatrix): AffineMatrix;\r\n  multiply(vectorOrMatrix: Vector | AffineMatrix, dest?: Vector | AffineMatrix): Vector | AffineMatrix {\r\n    if (vectorOrMatrix instanceof Vector) {\r\n      const result = (dest as Vector) || new Vector(0, 0);\r\n      const vector = vectorOrMatrix;\r\n      // these shenanigans are to allow dest and vector to be the same instance\r\n      const resultX = vector.x * this.data[0] + vector.y * this.data[2] + this.data[4];\r\n      const resultY = vector.x * this.data[1] + vector.y * this.data[3] + this.data[5];\r\n\r\n      result.x = resultX;\r\n      result.y = resultY;\r\n      return result;\r\n    } else {\r\n      const result = (dest as AffineMatrix) || new AffineMatrix();\r\n      const other = vectorOrMatrix;\r\n      const a11 = this.data[0];\r\n      const a21 = this.data[1];\r\n      //  const a31 = 0;\r\n\r\n      const a12 = this.data[2];\r\n      const a22 = this.data[3];\r\n      //  const a32 = 0;\r\n\r\n      const a13 = this.data[4];\r\n      const a23 = this.data[5];\r\n      //  const a33 = 1;\r\n\r\n      const b11 = other.data[0];\r\n      const b21 = other.data[1];\r\n      //  const b31 = 0;\r\n\r\n      const b12 = other.data[2];\r\n      const b22 = other.data[3];\r\n      //  const b32 = 0;\r\n\r\n      const b13 = other.data[4];\r\n      const b23 = other.data[5];\r\n      //  const b33 = 1;\r\n\r\n      result.data[0] = a11 * b11 + a12 * b21; // + a13 * b31; // zero\r\n      result.data[1] = a21 * b11 + a22 * b21; // + a23 * b31; // zero\r\n\r\n      result.data[2] = a11 * b12 + a12 * b22; // + a13 * b32; // zero\r\n      result.data[3] = a21 * b12 + a22 * b22; // + a23 * b32; // zero\r\n\r\n      result.data[4] = a11 * b13 + a12 * b23 + a13; // * b33; // one\r\n      result.data[5] = a21 * b13 + a22 * b23 + a23; // * b33; // one\r\n\r\n      const signX = this._scaleSignX;\r\n      const signY = this._scaleSignY;\r\n      result._scaleSignX = signX * sign(result._scaleSignX);\r\n      result._scaleSignY = signY * sign(result._scaleSignY);\r\n\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Packed array of length 8, that contains 4 vertices, with 2 components each\r\n   * So: [x0, y0, x1, y1, x2, y2, x3, y3]\r\n   * @param quad\r\n   */\r\n  multiplyQuadInPlace(quad: number[]) {\r\n    const resultTopLeftX = quad[0] * this.data[0] + quad[1] * this.data[2] + this.data[4];\r\n    const resultTopLeftY = quad[0] * this.data[1] + quad[1] * this.data[3] + this.data[5];\r\n    quad[0] = resultTopLeftX;\r\n    quad[1] = resultTopLeftY;\r\n\r\n    const resultTopRightX = quad[2] * this.data[0] + quad[3] * this.data[2] + this.data[4];\r\n    const resultTopRightY = quad[2] * this.data[1] + quad[3] * this.data[3] + this.data[5];\r\n    quad[2] = resultTopRightX;\r\n    quad[3] = resultTopRightY;\r\n\r\n    const resultBottomLeftX = quad[4] * this.data[0] + quad[5] * this.data[2] + this.data[4];\r\n    const resultBottomLeftY = quad[4] * this.data[1] + quad[5] * this.data[3] + this.data[5];\r\n    quad[4] = resultBottomLeftX;\r\n    quad[5] = resultBottomLeftY;\r\n\r\n    const resultBottomRightX = quad[6] * this.data[0] + quad[7] * this.data[2] + this.data[4];\r\n    const resultBottomRightY = quad[6] * this.data[1] + quad[7] * this.data[3] + this.data[5];\r\n    quad[6] = resultBottomRightX;\r\n    quad[7] = resultBottomRightY;\r\n  }\r\n\r\n  to4x4() {\r\n    const mat = new Matrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 0;\r\n\r\n    mat.data[4] = this.data[2];\r\n    mat.data[5] = this.data[3];\r\n    mat.data[6] = 0;\r\n    mat.data[7] = 0;\r\n\r\n    mat.data[8] = 0;\r\n    mat.data[9] = 0;\r\n    mat.data[10] = 1;\r\n    mat.data[11] = 0;\r\n\r\n    mat.data[12] = this.data[4];\r\n    mat.data[13] = this.data[5];\r\n    mat.data[14] = 0;\r\n    mat.data[15] = 1;\r\n    return mat;\r\n  }\r\n\r\n  public setRotation(angle: number) {\r\n    const currentScale = this.getScale();\r\n    const sine = Math.sin(angle);\r\n    const cosine = Math.cos(angle);\r\n\r\n    this.data[0] = cosine * currentScale.x;\r\n    this.data[1] = sine * currentScale.y;\r\n    this.data[2] = -sine * currentScale.x;\r\n    this.data[3] = cosine * currentScale.y;\r\n  }\r\n\r\n  public getRotation(): number {\r\n    const angle = Math.atan2(this.data[1] / this.getScaleY(), this.data[0] / this.getScaleX());\r\n    return canonicalizeAngle(angle);\r\n  }\r\n\r\n  public getScaleX(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const xScaleSq = this.data[0] * this.data[0] + this.data[2] * this.data[2];\r\n    if (xScaleSq === 1.0) {\r\n      // usually there isn't scale so we can avoid a sqrt\r\n      return this._scaleSignX;\r\n    }\r\n    return this._scaleSignX * Math.sqrt(xScaleSq);\r\n  }\r\n\r\n  public getScaleY(): number {\r\n    // absolute scale of the matrix (we lose sign so need to add it back)\r\n    const yScaleSq = this.data[1] * this.data[1] + this.data[3] * this.data[3];\r\n    if (yScaleSq === 1.0) {\r\n      // usually there isn't scale so we can avoid a sqrt\r\n      return this._scaleSignY;\r\n    }\r\n    return this._scaleSignY * Math.sqrt(yScaleSq);\r\n  }\r\n\r\n  /**\r\n   * Get the scale of the matrix\r\n   */\r\n  public getScale(): Vector {\r\n    return vec(this.getScaleX(), this.getScaleY());\r\n  }\r\n\r\n  private _scale = new Float64Array([1, 1]);\r\n  private _scaleSignX = 1;\r\n  public setScaleX(val: number) {\r\n    if (val === this._scale[0]) {\r\n      return;\r\n    }\r\n    this._scaleSignX = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const xscale = vec(this.data[0] * this._scaleSignX, this.data[2] * this._scaleSignX).normalize();\r\n    this.data[0] = xscale.x * val;\r\n    this.data[2] = xscale.y * val;\r\n    this._scale[0] = val;\r\n  }\r\n\r\n  private _scaleSignY = 1;\r\n  public setScaleY(val: number) {\r\n    if (val === this._scale[1]) {\r\n      return;\r\n    }\r\n    this._scaleSignY = sign(val);\r\n    // negative scale acts like a 180 rotation, so flip\r\n    const yscale = vec(this.data[1] * this._scaleSignY, this.data[3] * this._scaleSignY).normalize();\r\n    this.data[1] = yscale.x * val;\r\n    this.data[3] = yscale.y * val;\r\n    this._scale[1] = val;\r\n  }\r\n\r\n  public setScale(scale: Vector) {\r\n    this.setScaleX(scale.x);\r\n    this.setScaleY(scale.y);\r\n  }\r\n\r\n  public isIdentity(): boolean {\r\n    return this.data[0] === 1 && this.data[1] === 0 && this.data[2] === 0 && this.data[3] === 1 && this.data[4] === 0 && this.data[5] === 0;\r\n  }\r\n\r\n  /**\r\n   * Resets the current matrix to the identity matrix, mutating it\r\n   * @returns {AffineMatrix} Current matrix as identity\r\n   */\r\n  public reset(): AffineMatrix {\r\n    const mat = this;\r\n    mat.data[0] = 1;\r\n    mat.data[1] = 0;\r\n\r\n    mat.data[2] = 0;\r\n    mat.data[3] = 1;\r\n\r\n    mat.data[4] = 0;\r\n    mat.data[5] = 0;\r\n    return mat;\r\n  }\r\n\r\n  /**\r\n   * Creates a new Matrix with the same data as the current {@apilink AffineMatrix}\r\n   */\r\n  public clone(dest?: AffineMatrix): AffineMatrix {\r\n    const mat = dest || new AffineMatrix();\r\n    mat.data[0] = this.data[0];\r\n    mat.data[1] = this.data[1];\r\n    mat.data[2] = this.data[2];\r\n    mat.data[3] = this.data[3];\r\n    mat.data[4] = this.data[4];\r\n    mat.data[5] = this.data[5];\r\n    mat._scaleSignX = this._scaleSignX;\r\n    mat._scaleSignY = this._scaleSignY;\r\n    return mat;\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\n[${this.data[0]} ${this.data[2]} ${this.data[4]}]\r\n[${this.data[1]} ${this.data[3]} ${this.data[5]}]\r\n[0 0 1]\r\n`;\r\n  }\r\n}\r\n","export class RentalPool<T> {\r\n  private _pool: T[] = [];\r\n  private _size: number = 0;\r\n  constructor(\r\n    public builder: () => T,\r\n    public cleaner: (used: T) => T,\r\n    preAllocate: number = 1\r\n  ) {\r\n    this.grow(preAllocate);\r\n  }\r\n\r\n  /**\r\n   * Grow the pool size by an amount\r\n   * @param amount\r\n   */\r\n  grow(amount: number): void {\r\n    if (amount > 0) {\r\n      this._size += amount;\r\n      for (let i = 0; i < amount; i++) {\r\n        this._pool.push(this.builder());\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Rent an object from the pool, optionally clean it. If not cleaned previous state may be set.\r\n   *\r\n   * The pool will automatically double if depleted\r\n   * @param clean\r\n   */\r\n  rent(clean: boolean = false): T {\r\n    if (this._pool.length === 0) {\r\n      this.grow(this._size);\r\n    }\r\n\r\n    return clean ? this.cleaner(this._pool.pop()) : this._pool.pop();\r\n  }\r\n\r\n  /**\r\n   * Return an object to the pool\r\n   * @param object\r\n   */\r\n  return(object: T): void {\r\n    this._pool.push(object);\r\n  }\r\n}\r\n","import { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { RentalPool } from '../../Util/RentalPool';\r\n\r\nexport class TransformStack {\r\n  private _pool = new RentalPool(\r\n    () => AffineMatrix.identity(),\r\n    (mat) => mat.reset(),\r\n    100\r\n  );\r\n  private _transforms: AffineMatrix[] = [];\r\n\r\n  private _currentTransform: AffineMatrix = this._pool.rent(true);\r\n\r\n  public save(): void {\r\n    this._transforms.push(this._currentTransform);\r\n    this._currentTransform = this._currentTransform.clone(this._pool.rent());\r\n  }\r\n\r\n  public restore(): void {\r\n    this._pool.return(this._currentTransform);\r\n    this._currentTransform = this._transforms.pop()!;\r\n  }\r\n\r\n  public translate(x: number, y: number): AffineMatrix {\r\n    return this._currentTransform.translate(x, y);\r\n  }\r\n\r\n  public rotate(angle: number): AffineMatrix {\r\n    return this._currentTransform.rotate(angle);\r\n  }\r\n\r\n  public scale(x: number, y: number): AffineMatrix {\r\n    return this._currentTransform.scale(x, y);\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentTransform.reset();\r\n  }\r\n\r\n  public set current(matrix: AffineMatrix) {\r\n    this._currentTransform = matrix;\r\n  }\r\n\r\n  public get current(): AffineMatrix {\r\n    return this._currentTransform;\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { RentalPool } from '../../Util/RentalPool';\r\nimport { ExcaliburGraphicsContextState } from './ExcaliburGraphicsContext';\r\nimport { Material } from './material';\r\n\r\nexport class ContextState implements ExcaliburGraphicsContextState {\r\n  opacity: number = 1;\r\n  z: number = 0;\r\n  tint: Color | null | undefined = Color.White;\r\n  material: Material | null | undefined = null;\r\n}\r\n\r\nexport class StateStack {\r\n  private _pool = new RentalPool<ContextState>(\r\n    () => new ContextState(),\r\n    (s) => {\r\n      s.opacity = 1;\r\n      s.z = 0;\r\n      s.tint = Color.White;\r\n      s.material = null;\r\n      return s;\r\n    },\r\n    100\r\n  );\r\n  public current: ExcaliburGraphicsContextState = this._pool.rent(true);\r\n  private _states: ExcaliburGraphicsContextState[] = [];\r\n\r\n  private _cloneState(dest: ContextState) {\r\n    dest.opacity = this.current.opacity;\r\n    dest.z = this.current.z;\r\n    dest.tint = this.current.tint?.clone();\r\n    dest.material = this.current.material; // TODO is this going to cause problems when cloning\r\n    return dest;\r\n  }\r\n\r\n  public save(): void {\r\n    this._states.push(this.current);\r\n    this.current = this._cloneState(this._pool.rent());\r\n  }\r\n\r\n  public restore(): void {\r\n    this._pool.return(this.current);\r\n    this.current = this._states.pop()!;\r\n  }\r\n}\r\n","import { Loadable } from '../Interfaces/Loadable';\r\nimport { Logger } from '../Util/Log';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport type ResourceEvents = {\r\n  complete: any;\r\n  load: ProgressEvent<XMLHttpRequestEventTarget>;\r\n  loadstart: ProgressEvent<XMLHttpRequestEventTarget>;\r\n  progress: ProgressEvent<XMLHttpRequestEventTarget>;\r\n  error: ProgressEvent<XMLHttpRequestEventTarget>;\r\n};\r\n\r\nexport const ResourceEvents = {\r\n  Complete: 'complete',\r\n  Load: 'load',\r\n  LoadStart: 'loadstart',\r\n  Progress: 'progress',\r\n  Error: 'error'\r\n};\r\n\r\n/**\r\n * The {@apilink Resource} type allows games built in Excalibur to load generic resources.\r\n * For any type of remote resource it is recommended to use {@apilink Resource} for preloading.\r\n */\r\nexport class Resource<T> implements Loadable<T> {\r\n  public data: T = null;\r\n  public logger: Logger = Logger.getInstance();\r\n  public events = new EventEmitter();\r\n\r\n  /**\r\n   * @param path          Path to the remote resource\r\n   * @param responseType  The type to expect as a response: \"\" | \"arraybuffer\" | \"blob\" | \"document\" | \"json\" | \"text\";\r\n   * @param bustCache     Whether or not to cache-bust requests\r\n   */\r\n  constructor(\r\n    public path: string,\r\n    public responseType: '' | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text',\r\n    public bustCache: boolean = false\r\n  ) {}\r\n\r\n  /**\r\n   * Returns true if the Resource is completely loaded and is ready\r\n   * to be drawn.\r\n   */\r\n  public isLoaded(): boolean {\r\n    return this.data !== null;\r\n  }\r\n\r\n  private _cacheBust(uri: string): string {\r\n    const query: RegExp = /\\?\\w*=\\w*/;\r\n    if (query.test(uri)) {\r\n      uri += '&__=' + Date.now();\r\n    } else {\r\n      uri += '?__=' + Date.now();\r\n    }\r\n    return uri;\r\n  }\r\n  /**\r\n   * Begin loading the resource and returns a promise to be resolved on completion\r\n   */\r\n  public load(): Promise<T> {\r\n    return new Promise((resolve, reject) => {\r\n      // Exit early if we already have data\r\n      if (this.data !== null) {\r\n        this.logger.debug('Already have data for resource', this.path);\r\n        this.events.emit('complete', this.data as any);\r\n        resolve(this.data);\r\n        return;\r\n      }\r\n\r\n      const request = new XMLHttpRequest();\r\n      request.open('GET', this.bustCache ? this._cacheBust(this.path) : this.path, true);\r\n      request.responseType = this.responseType;\r\n      request.addEventListener('loadstart', (e) => this.events.emit('loadstart', e as any));\r\n      request.addEventListener('progress', (e) => this.events.emit('progress', e as any));\r\n      request.addEventListener('error', (e) => this.events.emit('error', e as any));\r\n      request.addEventListener('load', (e) => this.events.emit('load', e as any));\r\n      request.addEventListener('load', () => {\r\n        // XHR on file:// success status is 0, such as with PhantomJS\r\n        if (request.status !== 0 && request.status !== 200) {\r\n          this.logger.error('Failed to load resource ', this.path, ' server responded with error code', request.status);\r\n          this.events.emit('error', request.response);\r\n          reject(new Error(request.statusText));\r\n          return;\r\n        }\r\n\r\n        if (request.response instanceof Blob && request.response.type === 'text/html') {\r\n          const errorText = `Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!\r\n\r\nCheck your server configuration, for example Vite serves static files from the /public folder`;\r\n          this.events.emit('error', request.response);\r\n          reject(new Error(errorText));\r\n          return;\r\n        }\r\n\r\n        this.data = request.response;\r\n        this.events.emit('complete', this.data as any);\r\n        this.logger.debug('Completed loading resource', this.path);\r\n        resolve(this.data);\r\n      });\r\n      request.send();\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Watch an object with a proxy, only fires if property value is different\r\n */\r\nexport function watch<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, {\r\n      set: (obj, prop, value) => {\r\n        // The default behavior to store the value\r\n        if ((obj as any)[prop] !== value) {\r\n          (obj as any)[prop] = value;\r\n          // Avoid watching private junk\r\n          if (typeof prop === 'string') {\r\n            if (prop[0] !== '_') {\r\n              change(obj);\r\n            }\r\n          }\r\n        }\r\n        // Indicate success\r\n        return true;\r\n      },\r\n      get: (obj, prop) => {\r\n        if (prop !== '__isProxy') {\r\n          return (obj as any)[prop];\r\n        }\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n  return type;\r\n}\r\n\r\nconst createHandler = <T>(path: string[] = [], change: (type: T) => any, typeType: T) => ({\r\n  get: (target: T, key: string): any => {\r\n    if (key === '__isProxy') {\r\n      return true;\r\n    }\r\n    if (typeof (target as any)[key] === 'object' && (target as any)[key] != null) {\r\n      return new Proxy((target as any)[key], createHandler<any>([...path, key as string], change, typeType));\r\n    }\r\n    return (target as any)[key];\r\n  },\r\n  set: (target: T, key: string, value: any) => {\r\n    if (typeof key === 'string') {\r\n      if (key[0] !== '_') {\r\n        change(typeType);\r\n      }\r\n    }\r\n    (target as any)[key] = value;\r\n    return true;\r\n  }\r\n});\r\n\r\n/**\r\n *\r\n */\r\nexport function watchDeep<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, createHandler<T>([], change, type));\r\n  }\r\n  return type;\r\n}\r\n\r\n/**\r\n * Watch an object with a proxy, fires change on any property value change\r\n */\r\nexport function watchAny<T extends object>(type: T, change: (type: T) => any): T {\r\n  if (!type) {\r\n    return type;\r\n  }\r\n  if ((type as any).__isProxy === undefined) {\r\n    // expando hack to mark a proxy\r\n    return new Proxy(type, {\r\n      set: (obj, prop, value) => {\r\n        // The default behavior to store the value\r\n        (obj as any)[prop] = value;\r\n        // Avoid watching private junk\r\n        if (typeof prop === 'string') {\r\n          if (prop[0] !== '_') {\r\n            change(obj);\r\n          }\r\n        }\r\n\r\n        // Indicate success\r\n        return true;\r\n      },\r\n      get: (obj, prop) => {\r\n        if (prop !== '__isProxy') {\r\n          return (obj as any)[prop];\r\n        }\r\n        return true;\r\n      }\r\n    });\r\n  }\r\n  return type;\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { watch } from '../Util/Watch';\r\nimport { AffineMatrix } from '../Math/affine-matrix';\r\n\r\nexport interface GraphicOptions {\r\n  /**\r\n   * The width of the graphic\r\n   */\r\n  width?: number;\r\n  /**\r\n   * The height of the graphic\r\n   */\r\n  height?: number;\r\n  /**\r\n   * Should the graphic be flipped horizontally\r\n   */\r\n  flipHorizontal?: boolean;\r\n  /**\r\n   * Should the graphic be flipped vertically\r\n   */\r\n  flipVertical?: boolean;\r\n  /**\r\n   * The rotation of the graphic\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * The scale of the graphic\r\n   */\r\n  scale?: Vector;\r\n  /**\r\n   * The opacity of the graphic between (0 -1)\r\n   */\r\n  opacity?: number;\r\n  /**\r\n   * The tint of the graphic, this color will be multiplied by the original pixel colors\r\n   */\r\n  tint?: Color;\r\n  /**\r\n   * The origin of the drawing in pixels to use when applying transforms, by default it will be the center of the image in pixels\r\n   */\r\n  origin?: Vector;\r\n}\r\n\r\n/**\r\n * A Graphic is the base Excalibur primitive for something that can be drawn to the {@apilink ExcaliburGraphicsContext}.\r\n * {@apilink Sprite}, {@apilink Animation}, {@apilink GraphicsGroup}, {@apilink Canvas}, {@apilink Rectangle}, {@apilink Circle}, and {@apilink Polygon} all derive from the\r\n * {@apilink Graphic} abstract class.\r\n *\r\n * Implementors of a Graphic must override the abstract {@apilink Graphic._drawImage} method to render an image to the graphics context. Graphic\r\n * handles all the position, rotation, and scale transformations in {@apilink Graphic._preDraw} and {@apilink Graphic._postDraw}\r\n */\r\nexport abstract class Graphic {\r\n  private static _ID: number = 0;\r\n  readonly id = Graphic._ID++;\r\n\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public tint?: Color;\r\n\r\n  private _transformStale = true;\r\n  public isStale() {\r\n    return this._transformStale;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets wether to show debug information about the graphic\r\n   */\r\n  public showDebug: boolean = false;\r\n\r\n  private _flipHorizontal = false;\r\n  /**\r\n   * Gets or sets the flipHorizontal, which will flip the graphic horizontally (across the y axis)\r\n   */\r\n  public get flipHorizontal(): boolean {\r\n    return this._flipHorizontal;\r\n  }\r\n\r\n  public set flipHorizontal(value: boolean) {\r\n    this._flipHorizontal = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _flipVertical = false;\r\n  /**\r\n   * Gets or sets the flipVertical, which will flip the graphic vertically (across the x axis)\r\n   */\r\n  public get flipVertical(): boolean {\r\n    return this._flipVertical;\r\n  }\r\n\r\n  public set flipVertical(value: boolean) {\r\n    this._flipVertical = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _rotation = 0;\r\n  /**\r\n   * Gets or sets the rotation of the graphic\r\n   */\r\n  public get rotation(): number {\r\n    return this._rotation;\r\n  }\r\n\r\n  public set rotation(value: number) {\r\n    this._rotation = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  /**\r\n   * Gets or sets the opacity of the graphic, 0 is transparent, 1 is solid (opaque).\r\n   */\r\n  public opacity: number = 1;\r\n\r\n  private _scale = Vector.One;\r\n  /**\r\n   * Gets or sets the scale of the graphic, this affects the width and\r\n   */\r\n  public get scale() {\r\n    return this._scale;\r\n  }\r\n\r\n  public set scale(value: Vector) {\r\n    this._scale = watch(value, () => {\r\n      this._transformStale = true;\r\n    });\r\n    this._transformStale = true;\r\n  }\r\n\r\n  private _origin?: Vector;\r\n  /**\r\n   * Gets or sets the origin of the graphic, if not set the center of the graphic is the origin\r\n   */\r\n  public get origin(): Vector | undefined {\r\n    return this._origin;\r\n  }\r\n\r\n  public set origin(value: Vector | undefined) {\r\n    if (value) {\r\n      this._origin = watch(value, () => {\r\n        this._transformStale = true;\r\n      });\r\n    }\r\n    this._transformStale = true;\r\n  }\r\n\r\n  constructor(options?: GraphicOptions) {\r\n    if (options) {\r\n      this.origin = options.origin ?? this.origin;\r\n      this.flipHorizontal = options.flipHorizontal ?? this.flipHorizontal;\r\n      this.flipVertical = options.flipVertical ?? this.flipVertical;\r\n      this.rotation = options.rotation ?? this.rotation;\r\n      this.opacity = options.opacity ?? this.opacity;\r\n      this.scale = options.scale ?? this.scale;\r\n      this.tint = options.tint ?? this.tint;\r\n      if (options.width) {\r\n        this._width = options.width;\r\n      }\r\n\r\n      if (options.height) {\r\n        this._height = options.height;\r\n      }\r\n    }\r\n  }\r\n\r\n  public cloneGraphicOptions(): GraphicOptions {\r\n    return {\r\n      width: this.width / this.scale.x,\r\n      height: this.height / this.scale.y,\r\n      origin: this.origin ? this.origin.clone() : undefined,\r\n      flipHorizontal: this.flipHorizontal,\r\n      flipVertical: this.flipVertical,\r\n      rotation: this.rotation,\r\n      opacity: this.opacity,\r\n      scale: this.scale ? this.scale.clone() : undefined,\r\n      tint: this.tint ? this.tint.clone() : undefined\r\n    };\r\n  }\r\n\r\n  private _width: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the width of the graphic (always positive)\r\n   */\r\n  public get width() {\r\n    return Math.abs(this._width * this.scale.x);\r\n  }\r\n\r\n  private _height: number = 0;\r\n\r\n  /**\r\n   * Gets or sets the height of the graphic (always positive)\r\n   */\r\n  public get height() {\r\n    return Math.abs(this._height * this.scale.y);\r\n  }\r\n\r\n  public set width(value: number) {\r\n    this._width = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  public set height(value: number) {\r\n    this._height = value;\r\n    this._transformStale = true;\r\n  }\r\n\r\n  /**\r\n   * Gets a copy of the bounds in pixels occupied by the graphic on the the screen. This includes scale.\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return BoundingBox.fromDimension(this.width, this.height, Vector.Zero);\r\n  }\r\n\r\n  /**\r\n   * Draw the whole graphic to the context including transform\r\n   * @param ex The excalibur graphics context\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public draw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    this._preDraw(ex, x, y);\r\n    this._drawImage(ex, 0, 0);\r\n    this._postDraw(ex);\r\n  }\r\n\r\n  /**\r\n   * Meant to be overridden by the graphic implementation to draw the underlying image (HTMLCanvasElement or HTMLImageElement)\r\n   * to the graphics context without transform. Transformations like position, rotation, and scale are handled by {@apilink Graphic._preDraw}\r\n   * and {@apilink Graphic._postDraw}\r\n   * @param ex The excalibur graphics context\r\n   * @param x\r\n   * @param y\r\n   */\r\n  protected abstract _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void;\r\n\r\n  /**\r\n   * Apply affine transformations to the graphics context to manipulate the graphic before {@apilink Graphic._drawImage}\r\n   * @param ex\r\n   * @param x\r\n   * @param y\r\n   */\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    ex.save();\r\n    ex.translate(x, y);\r\n    if (this._transformStale) {\r\n      this.transform.reset();\r\n      this.transform.scale(Math.abs(this.scale.x), Math.abs(this.scale.y));\r\n      this._rotate(this.transform);\r\n      this._flip(this.transform);\r\n      this._transformStale = false;\r\n    }\r\n    ex.multiply(this.transform);\r\n    // it is important to multiply alphas so graphics respect the current context\r\n    ex.opacity = ex.opacity * this.opacity;\r\n    if (this.tint) {\r\n      ex.tint = this.tint;\r\n    }\r\n  }\r\n\r\n  protected _rotate(ex: ExcaliburGraphicsContext | AffineMatrix) {\r\n    const scaleDirX = this.scale.x > 0 ? 1 : -1;\r\n    const scaleDirY = this.scale.y > 0 ? 1 : -1;\r\n    const origin = this.origin ?? vec(this.width / 2, this.height / 2);\r\n    ex.translate(origin.x, origin.y);\r\n    ex.rotate(this.rotation);\r\n    // This is for handling direction changes 1 or -1, that way we don't have mismatched translates()\r\n    ex.scale(scaleDirX, scaleDirY);\r\n    ex.translate(-origin.x, -origin.y);\r\n  }\r\n\r\n  protected _flip(ex: ExcaliburGraphicsContext | AffineMatrix) {\r\n    if (this.flipHorizontal) {\r\n      ex.translate(this.width / this.scale.x, 0);\r\n      ex.scale(-1, 1);\r\n    }\r\n\r\n    if (this.flipVertical) {\r\n      ex.translate(0, this.height / this.scale.y);\r\n      ex.scale(1, -1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply any additional work after {@apilink Graphic._drawImage} and restore the context state.\r\n   * @param ex\r\n   */\r\n  protected _postDraw(ex: ExcaliburGraphicsContext): void {\r\n    if (this.showDebug) {\r\n      ex.debug.drawRect(0, 0, this.width, this.height);\r\n    }\r\n    ex.restore();\r\n  }\r\n\r\n  /**\r\n   * Returns a new instance of the graphic that has the same properties\r\n   */\r\n  abstract clone(): Graphic;\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ImageSource } from './ImageSource';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Logger } from '../Util/Log';\r\n\r\nexport type SourceView = { x: number; y: number; width: number; height: number };\r\nexport type DestinationSize = { width: number; height: number };\r\n\r\nexport interface SpriteOptions {\r\n  /**\r\n   * Image to create a sprite from\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * By default the source is the entire dimension of the {@apilink ImageSource}\r\n   */\r\n  sourceView?: { x: number; y: number; width: number; height: number };\r\n  /**\r\n   * By default the size of the final sprite is the size of the {@apilink ImageSource}\r\n   */\r\n  destSize?: { width: number; height: number };\r\n}\r\n\r\nexport class Sprite extends Graphic {\r\n  private _logger = Logger.getInstance();\r\n  public image: ImageSource;\r\n  public sourceView: SourceView;\r\n  public destSize: DestinationSize;\r\n  private _dirty = true;\r\n\r\n  public static from(image: ImageSource, options?: Omit<GraphicOptions & SpriteOptions, 'image'>): Sprite {\r\n    return new Sprite({\r\n      image,\r\n      ...options\r\n    });\r\n  }\r\n\r\n  constructor(options: GraphicOptions & SpriteOptions) {\r\n    super(options);\r\n    this.image = options.image;\r\n    const { width, height } = options;\r\n    this.sourceView = options.sourceView ?? { x: 0, y: 0, width: width ?? 0, height: height ?? 0 };\r\n    this.destSize = options.destSize ?? { width: width ?? 0, height: height ?? 0 };\r\n    this._updateSpriteDimensions();\r\n    // Fire when loaded\r\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n    this.image.ready.then(() => {\r\n      this._updateSpriteDimensions();\r\n    });\r\n  }\r\n\r\n  public override get width(): number {\r\n    return Math.abs(this.destSize.width * this.scale.x);\r\n  }\r\n\r\n  public override get height(): number {\r\n    return Math.abs(this.destSize.height * this.scale.y);\r\n  }\r\n\r\n  public override set width(newWidth: number) {\r\n    newWidth /= Math.abs(this.scale.x);\r\n    this.destSize.width = newWidth;\r\n    super.width = Math.ceil(this.destSize.width);\r\n  }\r\n\r\n  public override set height(newHeight: number) {\r\n    newHeight /= Math.abs(this.scale.y);\r\n    this.destSize.height = newHeight;\r\n    super.height = Math.ceil(this.destSize.height);\r\n  }\r\n\r\n  private _updateSpriteDimensions() {\r\n    const { width: nativeWidth, height: nativeHeight } = this.image;\r\n    // This code uses || to avoid 0's\r\n    // If the source is not specified, use the native dimension\r\n    this.sourceView.width = this.sourceView?.width || nativeWidth;\r\n    this.sourceView.height = this.sourceView?.height || nativeHeight;\r\n\r\n    // If the destination is not specified, use the source if specified, then native\r\n    this.destSize.width = this.destSize?.width || this.sourceView?.width || nativeWidth;\r\n    this.destSize.height = this.destSize?.height || this.sourceView?.height || nativeHeight;\r\n\r\n    this.width = Math.ceil(this.destSize.width) * this.scale.x;\r\n    this.height = Math.ceil(this.destSize.height) * this.scale.y;\r\n  }\r\n\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.image.isLoaded() && this._dirty) {\r\n      this._dirty = false;\r\n      this._updateSpriteDimensions();\r\n    }\r\n    super._preDraw(ex, x, y);\r\n  }\r\n\r\n  public _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.image.isLoaded()) {\r\n      ex.drawImage(\r\n        this.image.image,\r\n        this.sourceView.x,\r\n        this.sourceView.y,\r\n        this.sourceView.width,\r\n        this.sourceView.height,\r\n        x,\r\n        y,\r\n        this.destSize.width,\r\n        this.destSize.height\r\n      );\r\n    } else {\r\n      this._logger.warnOnce(\r\n        `ImageSource ${this.image.path}` +\r\n          ` is not yet loaded and won't be drawn. Please call .load() or include in a Loader.\\n\\n` +\r\n          `Read https://excaliburjs.com/docs/imagesource for more information.`\r\n      );\r\n    }\r\n  }\r\n\r\n  public clone(): Sprite {\r\n    return new Sprite({\r\n      image: this.image,\r\n      sourceView: { ...this.sourceView },\r\n      destSize: { ...this.destSize },\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n}\r\n","/**\r\n * Describes the different image filtering modes\r\n */\r\nexport enum ImageFiltering {\r\n  /**\r\n   * Pixel is useful when you do not want smoothing aka antialiasing applied to your graphics.\r\n   *\r\n   * Useful for Pixel art aesthetics.\r\n   */\r\n  Pixel = 'Pixel',\r\n\r\n  /**\r\n   * Blended is useful when you have high resolution artwork and would like it blended and smoothed\r\n   */\r\n  Blended = 'Blended'\r\n}\r\n\r\n/**\r\n * Parse the image filtering attribute value, if it doesn't match returns null\r\n */\r\nexport function parseImageFiltering(val: string): ImageFiltering | undefined {\r\n  switch (val) {\r\n    case ImageFiltering.Pixel:\r\n      return ImageFiltering.Pixel;\r\n    case ImageFiltering.Blended:\r\n      return ImageFiltering.Blended;\r\n    default:\r\n      return undefined;\r\n  }\r\n}\r\n","/**\r\n * Describes the different image wrapping modes\r\n */\r\nexport enum ImageWrapping {\r\n  Clamp = 'Clamp',\r\n\r\n  Repeat = 'Repeat',\r\n\r\n  Mirror = 'Mirror'\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function parseImageWrapping(val: string): ImageWrapping {\r\n  switch (val) {\r\n    case ImageWrapping.Clamp:\r\n      return ImageWrapping.Clamp;\r\n    case ImageWrapping.Repeat:\r\n      return ImageWrapping.Repeat;\r\n    case ImageWrapping.Mirror:\r\n      return ImageWrapping.Mirror;\r\n    default:\r\n      return ImageWrapping.Clamp;\r\n  }\r\n}\r\n","import { GarbageCollector } from '../../GarbageCollector';\r\nimport { Logger } from '../../Util/Log';\r\nimport { ImageFiltering } from '../Filtering';\r\nimport { ImageSourceOptions, ImageWrapConfiguration } from '../ImageSource';\r\nimport { ImageWrapping } from '../Wrapping';\r\nimport { HTMLImageSource } from './ExcaliburGraphicsContext';\r\n\r\n/**\r\n * Manages loading image sources into webgl textures, a unique id is associated with all sources\r\n */\r\nexport class TextureLoader {\r\n  private static _LOGGER = Logger.getInstance();\r\n\r\n  constructor(\r\n    gl: WebGL2RenderingContext,\r\n    private _garbageCollector?: {\r\n      garbageCollector: GarbageCollector;\r\n      collectionInterval: number;\r\n    }\r\n  ) {\r\n    this._gl = gl;\r\n    TextureLoader._MAX_TEXTURE_SIZE = gl.getParameter(gl.MAX_TEXTURE_SIZE);\r\n    if (this._garbageCollector) {\r\n      TextureLoader._LOGGER.debug('WebGL Texture collection interval:', this._garbageCollector.collectionInterval);\r\n      this._garbageCollector.garbageCollector?.registerCollector('texture', this._garbageCollector.collectionInterval, this._collect);\r\n    }\r\n  }\r\n\r\n  public dispose() {\r\n    for (const [image] of this._textureMap) {\r\n      this.delete(image);\r\n    }\r\n    this._textureMap.clear();\r\n    this._gl = null as any;\r\n  }\r\n\r\n  /**\r\n   * Sets the default filtering for the Excalibur texture loader, default {@apilink ImageFiltering.Blended}\r\n   */\r\n  public static filtering: ImageFiltering = ImageFiltering.Blended;\r\n  public static wrapping: ImageWrapConfiguration = { x: ImageWrapping.Clamp, y: ImageWrapping.Clamp };\r\n\r\n  private _gl: WebGL2RenderingContext;\r\n\r\n  private _textureMap = new Map<HTMLImageSource, WebGLTexture>();\r\n\r\n  private static _MAX_TEXTURE_SIZE: number = 4096;\r\n\r\n  /**\r\n   * Get the WebGL Texture from a source image\r\n   * @param image\r\n   */\r\n  public get(image: HTMLImageSource): WebGLTexture {\r\n    return this._textureMap.get(image)!;\r\n  }\r\n\r\n  /**\r\n   * Returns whether a source image has been loaded as a texture\r\n   * @param image\r\n   */\r\n  public has(image: HTMLImageSource): boolean {\r\n    return this._textureMap.has(image)!;\r\n  }\r\n\r\n  /**\r\n   * Loads a graphic into webgl and returns it's texture info, a webgl context must be previously registered\r\n   * @param image Source graphic\r\n   * @param options {ImageSourceOptions} Optionally configure the ImageFiltering and ImageWrapping mode to apply to the loaded texture\r\n   * @param forceUpdate Optionally force a texture to be reloaded, useful if the source graphic has changed\r\n   */\r\n  public load(image: HTMLImageSource, options?: ImageSourceOptions, forceUpdate = false): WebGLTexture | null {\r\n    // Ignore loading if webgl is not registered\r\n    const gl = this._gl;\r\n    if (!gl) {\r\n      return null;\r\n    }\r\n\r\n    const { filtering, wrapping } = { ...options };\r\n\r\n    let tex: WebGLTexture | null = null;\r\n    // If reuse the texture if it's from the same source\r\n    if (this.has(image)) {\r\n      tex = this.get(image);\r\n    }\r\n\r\n    // Update existing webgl texture and return early\r\n    if (tex) {\r\n      if (forceUpdate) {\r\n        gl.bindTexture(gl.TEXTURE_2D, tex);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n      }\r\n      this._garbageCollector?.garbageCollector.touch(image);\r\n      return tex;\r\n    }\r\n\r\n    // No texture exists create a new one\r\n    tex = gl.createTexture();\r\n\r\n    // TODO implement texture gc with weakmap and timer\r\n    TextureLoader.checkImageSizeSupportedAndLog(image);\r\n\r\n    gl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n    gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, true);\r\n\r\n    let wrappingConfig: ImageWrapConfiguration | undefined;\r\n    if (wrapping) {\r\n      if (typeof wrapping === 'string') {\r\n        wrappingConfig = {\r\n          x: wrapping,\r\n          y: wrapping\r\n        };\r\n      } else {\r\n        wrappingConfig = {\r\n          x: wrapping.x,\r\n          y: wrapping.y\r\n        };\r\n      }\r\n    }\r\n    const { x: xWrap, y: yWrap } = wrappingConfig ?? TextureLoader.wrapping;\r\n    switch (xWrap) {\r\n      case ImageWrapping.Clamp:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        break;\r\n      case ImageWrapping.Repeat:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\r\n        break;\r\n      case ImageWrapping.Mirror:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.MIRRORED_REPEAT);\r\n        break;\r\n      default:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    }\r\n    switch (yWrap) {\r\n      case ImageWrapping.Clamp:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        break;\r\n      case ImageWrapping.Repeat:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\r\n        break;\r\n      case ImageWrapping.Mirror:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.MIRRORED_REPEAT);\r\n        break;\r\n      default:\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n    }\r\n\r\n    // NEAREST for pixel art, LINEAR for hi-res\r\n    const filterMode = filtering ?? TextureLoader.filtering;\r\n\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filterMode === ImageFiltering.Pixel ? gl.NEAREST : gl.LINEAR);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filterMode === ImageFiltering.Pixel ? gl.NEAREST : gl.LINEAR);\r\n\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n\r\n    this._textureMap.set(image, tex!);\r\n    this._garbageCollector?.garbageCollector.addCollectableResource('texture', image);\r\n    return tex;\r\n  }\r\n\r\n  public delete(image: HTMLImageSource): void {\r\n    // Ignore loading if webgl is not registered\r\n    const gl = this._gl;\r\n    if (!gl) {\r\n      return;\r\n    }\r\n\r\n    if (this.has(image)) {\r\n      const texture = this.get(image);\r\n      if (texture) {\r\n        this._textureMap.delete(image);\r\n        gl.deleteTexture(texture);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Takes an image and returns if it meets size criteria for hardware\r\n   * @param image\r\n   * @returns if the image will be supported at runtime\r\n   */\r\n  public static checkImageSizeSupportedAndLog(image: HTMLImageSource) {\r\n    const originalSrc = image.dataset.originalSrc ?? 'internal canvas bitmap';\r\n    if (image.width > TextureLoader._MAX_TEXTURE_SIZE || image.height > TextureLoader._MAX_TEXTURE_SIZE) {\r\n      TextureLoader._LOGGER.error(\r\n        `The image [${originalSrc}] provided to Excalibur is too large for the device's maximum texture size of ` +\r\n          `(${TextureLoader._MAX_TEXTURE_SIZE}x${TextureLoader._MAX_TEXTURE_SIZE}) please resize to an image ` +\r\n          `for excalibur to render properly.\\n\\nImages will likely render as black rectangles.\\n\\n` +\r\n          `Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`\r\n      );\r\n      return false;\r\n    } else if (image.width > 4096 || image.height > 4096) {\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits\r\n      TextureLoader._LOGGER.warn(\r\n        `The image [${originalSrc}] provided to excalibur is too large may not work on all mobile devices, ` +\r\n          `it is recommended you resize images to a maximum (4096x4096).\\n\\n` +\r\n          `Images will likely render as black rectangles on some mobile platforms.\\n\\n` +\r\n          `Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`\r\n      );\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Looks for textures that haven't been drawn in a while\r\n   */\r\n  private _collect = (image: HTMLImageSource) => {\r\n    if (this._gl) {\r\n      const name = image.dataset.originalSrc ?? image.constructor.name;\r\n      TextureLoader._LOGGER.debug(`WebGL Texture for ${name} collected`);\r\n      this.delete(image);\r\n      return true;\r\n    }\r\n    return false;\r\n  };\r\n}\r\n","import { Resource } from '../Resources/Resource';\r\nimport { Sprite, SpriteOptions } from './Sprite';\r\nimport { Loadable } from '../Interfaces/Index';\r\nimport { Logger } from '../Util/Log';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { Future } from '../Util/Future';\r\nimport { TextureLoader } from '../Graphics/Context/texture-loader';\r\nimport { ImageWrapping } from './Wrapping';\r\nimport { GraphicOptions } from './Graphic';\r\n\r\nexport interface ImageSourceOptions {\r\n  filtering?: ImageFiltering;\r\n  wrapping?: ImageWrapConfiguration | ImageWrapping;\r\n  bustCache?: boolean;\r\n}\r\n\r\nexport interface ImageWrapConfiguration {\r\n  x: ImageWrapping;\r\n  y: ImageWrapping;\r\n}\r\n\r\nexport const ImageSourceAttributeConstants = {\r\n  Filtering: 'filtering',\r\n  WrappingX: 'wrapping-x',\r\n  WrappingY: 'wrapping-y'\r\n} as const;\r\n\r\nexport class ImageSource implements Loadable<HTMLImageElement> {\r\n  private _logger = Logger.getInstance();\r\n  private _resource: Resource<Blob>;\r\n  public filtering?: ImageFiltering;\r\n  public wrapping?: ImageWrapConfiguration;\r\n\r\n  /**\r\n   * The original size of the source image in pixels\r\n   */\r\n  public get width() {\r\n    return this.image.naturalWidth;\r\n  }\r\n\r\n  /**\r\n   * The original height of the source image in pixels\r\n   */\r\n  public get height() {\r\n    return this.image.naturalHeight;\r\n  }\r\n\r\n  private _src?: string;\r\n  /**\r\n   * Returns true if the Texture is completely loaded and is ready\r\n   * to be drawn.\r\n   */\r\n  public isLoaded(): boolean {\r\n    if (!this._src) {\r\n      // this boosts speed of access\r\n      this._src = this.data.src;\r\n    }\r\n    return !!this._src;\r\n  }\r\n\r\n  /**\r\n   * Access to the underlying html image element\r\n   */\r\n  public data: HTMLImageElement = new Image();\r\n  public get image(): HTMLImageElement {\r\n    return this.data;\r\n  }\r\n\r\n  private _readyFuture = new Future<HTMLImageElement>();\r\n  /**\r\n   * Promise the resolves when the image is loaded and ready for use, does not initiate loading\r\n   */\r\n  public ready: Promise<HTMLImageElement> = this._readyFuture.promise;\r\n\r\n  public readonly path: string;\r\n\r\n  /**\r\n   * The path to the image, can also be a data url like 'data:image/'\r\n   * @param pathOrBase64 {string} Path to the image resource relative from the HTML document hosting the game, or absolute\r\n   * @param options\r\n   */\r\n  constructor(pathOrBase64: string, options?: ImageSourceOptions);\r\n  /**\r\n   * The path to the image, can also be a data url like 'data:image/'\r\n   * @param pathOrBase64 {string} Path to the image resource relative from the HTML document hosting the game, or absolute\r\n   * @param bustCache {boolean} Should excalibur add a cache busting querystring?\r\n   * @param filtering {ImageFiltering} Optionally override the image filtering set by {@apilink EngineOptions.antialiasing}\r\n   */\r\n  constructor(pathOrBase64: string, bustCache: boolean, filtering?: ImageFiltering);\r\n  constructor(pathOrBase64: string, bustCacheOrOptions: boolean | ImageSourceOptions | undefined, filtering?: ImageFiltering) {\r\n    this.path = pathOrBase64;\r\n    let bustCache: boolean | undefined = false;\r\n    let wrapping: ImageWrapConfiguration | ImageWrapping | undefined;\r\n    if (typeof bustCacheOrOptions === 'boolean') {\r\n      bustCache = bustCacheOrOptions;\r\n    } else {\r\n      ({ filtering, wrapping, bustCache } = { ...bustCacheOrOptions });\r\n    }\r\n    this._resource = new Resource(pathOrBase64, 'blob', bustCache);\r\n    this.filtering = filtering ?? this.filtering;\r\n    if (typeof wrapping === 'string') {\r\n      this.wrapping = {\r\n        x: wrapping,\r\n        y: wrapping\r\n      };\r\n    } else {\r\n      this.wrapping = wrapping ?? this.wrapping;\r\n    }\r\n    if (pathOrBase64.endsWith('.gif')) {\r\n      this._logger.warn(\r\n        `Use the ex.Gif type to load gifs, you may have mixed results with ${pathOrBase64} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an ImageSource from and HTML <image> tag element\r\n   * @param image\r\n   */\r\n  static fromHtmlImageElement(image: HTMLImageElement, options?: ImageSourceOptions) {\r\n    const imageSource = new ImageSource('');\r\n    imageSource._src = 'image-element';\r\n    imageSource.data = image;\r\n    imageSource.data.setAttribute('data-original-src', 'image-element');\r\n\r\n    if (options?.filtering) {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.Filtering, options?.filtering);\r\n    } else {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.Filtering, ImageFiltering.Blended);\r\n    }\r\n\r\n    if (options?.wrapping) {\r\n      let wrapping: ImageWrapConfiguration;\r\n      if (typeof options.wrapping === 'string') {\r\n        wrapping = {\r\n          x: options.wrapping,\r\n          y: options.wrapping\r\n        };\r\n      } else {\r\n        wrapping = {\r\n          x: options.wrapping.x,\r\n          y: options.wrapping.y\r\n        };\r\n      }\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingX, wrapping.x);\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingY, wrapping.y);\r\n    } else {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingX, ImageWrapping.Clamp);\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingY, ImageWrapping.Clamp);\r\n    }\r\n\r\n    TextureLoader.checkImageSizeSupportedAndLog(image);\r\n    imageSource._readyFuture.resolve(image);\r\n    return imageSource;\r\n  }\r\n\r\n  static fromHtmlCanvasElement(image: HTMLCanvasElement, options?: ImageSourceOptions): ImageSource {\r\n    const imageSource = new ImageSource('');\r\n    imageSource._src = 'canvas-element-blob';\r\n    imageSource.data.setAttribute('data-original-src', 'canvas-element-blob');\r\n\r\n    if (options?.filtering) {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.Filtering, options?.filtering);\r\n    } else {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.Filtering, ImageFiltering.Blended);\r\n    }\r\n\r\n    if (options?.wrapping) {\r\n      let wrapping: ImageWrapConfiguration;\r\n      if (typeof options.wrapping === 'string') {\r\n        wrapping = {\r\n          x: options.wrapping,\r\n          y: options.wrapping\r\n        };\r\n      } else {\r\n        wrapping = {\r\n          x: options.wrapping.x,\r\n          y: options.wrapping.y\r\n        };\r\n      }\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingX, wrapping.x);\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingY, wrapping.y);\r\n    } else {\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingX, ImageWrapping.Clamp);\r\n      imageSource.data.setAttribute(ImageSourceAttributeConstants.WrappingY, ImageWrapping.Clamp);\r\n    }\r\n\r\n    TextureLoader.checkImageSizeSupportedAndLog(image);\r\n\r\n    image.toBlob((blob) => {\r\n      // TODO throw? if blob null?\r\n      const url = URL.createObjectURL(blob!);\r\n      imageSource.image.onload = () => {\r\n        // no longer need to read the blob so it's revoked\r\n        URL.revokeObjectURL(url);\r\n        imageSource.data = imageSource.image;\r\n        imageSource._readyFuture.resolve(imageSource.image);\r\n      };\r\n      imageSource.image.src = url;\r\n    });\r\n\r\n    return imageSource;\r\n  }\r\n\r\n  static fromSvgString(svgSource: string, options?: ImageSourceOptions) {\r\n    const blob = new Blob([svgSource], { type: 'image/svg+xml' });\r\n    const url = URL.createObjectURL(blob);\r\n    return new ImageSource(url, options);\r\n  }\r\n\r\n  /**\r\n   * Should excalibur add a cache busting querystring? By default false.\r\n   * Must be set before loading\r\n   */\r\n  public get bustCache() {\r\n    return this._resource.bustCache;\r\n  }\r\n\r\n  public set bustCache(val: boolean) {\r\n    this._resource.bustCache = val;\r\n  }\r\n\r\n  /**\r\n   * Begins loading the image and returns a promise that resolves when the image is loaded\r\n   */\r\n  async load(): Promise<HTMLImageElement> {\r\n    if (this.isLoaded()) {\r\n      return this.data;\r\n    }\r\n    try {\r\n      // Load base64 or blob if needed\r\n      let url: string;\r\n      if (!this.path.includes('data:image/')) {\r\n        const blob = await this._resource.load();\r\n        url = URL.createObjectURL(blob);\r\n      } else {\r\n        url = this.path;\r\n      }\r\n\r\n      // Decode the image\r\n      const image = new Image();\r\n      // Use Image.onload over Image.decode()\r\n      // https://bugs.chromium.org/p/chromium/issues/detail?id=1055828#c7\r\n      // Otherwise chrome will throw still Image.decode() failures for large textures\r\n      const loadedFuture = new Future<void>();\r\n      image.onload = () => loadedFuture.resolve();\r\n      image.src = url;\r\n      image.setAttribute('data-original-src', this.path);\r\n\r\n      await loadedFuture.promise;\r\n\r\n      // Set results\r\n      // We defer loading the texture into webgl until the first draw that way we avoid a singleton\r\n      // and for the multi-engine case the texture needs to be created in EACH webgl context to work\r\n      // See image-renderer.ts draw()\r\n      this.data = image;\r\n\r\n      // emit warning if potentially too big\r\n      TextureLoader.checkImageSizeSupportedAndLog(this.data);\r\n    } catch (error: any) {\r\n      throw `Error loading ImageSource from path '${this.path}' with error [${error.message}]`;\r\n    }\r\n    // Do a bad thing to pass the filtering as an attribute\r\n    this.data.setAttribute(ImageSourceAttributeConstants.Filtering, this.filtering as any); // TODO fix type\r\n    this.data.setAttribute(ImageSourceAttributeConstants.WrappingX, this.wrapping?.x ?? ImageWrapping.Clamp);\r\n    this.data.setAttribute(ImageSourceAttributeConstants.WrappingY, this.wrapping?.y ?? ImageWrapping.Clamp);\r\n\r\n    // todo emit complete\r\n    this._readyFuture.resolve(this.data);\r\n    return this.data;\r\n  }\r\n\r\n  /**\r\n   * Build a sprite from this ImageSource\r\n   */\r\n  public toSprite(options?: Omit<GraphicOptions & SpriteOptions, 'image'>): Sprite {\r\n    return Sprite.from(this, options);\r\n  }\r\n\r\n  /**\r\n   * Unload images from memory\r\n   */\r\n  unload(): void {\r\n    this.data = new Image();\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Logger } from '../Util/Log';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { FontRenderer } from './FontCommon';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { Sprite } from './Sprite';\r\nimport { SpriteSheet } from './SpriteSheet';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\n\r\nexport interface SpriteFontOptions {\r\n  /**\r\n   * Alphabet string in spritesheet order (default is row column order)\r\n   * example: 'abcdefghijklmnopqrstuvwxyz'\r\n   */\r\n  alphabet: string;\r\n  /**\r\n   * {@apilink SpriteSheet} to source character sprites from\r\n   */\r\n  spriteSheet: SpriteSheet;\r\n  /**\r\n   * Optionally ignore case in the supplied text;\r\n   */\r\n  caseInsensitive?: boolean;\r\n  /**\r\n   * Optionally override the text line height, useful for multiline text. If unset will use default.\r\n   */\r\n  lineHeight?: number | undefined;\r\n  /**\r\n   * Optionally adjust the spacing between character sprites\r\n   */\r\n  spacing?: number;\r\n  /**\r\n   * Optionally specify a \"shadow\"\r\n   */\r\n  shadow?: { offset: Vector };\r\n}\r\n\r\nexport class SpriteFont extends Graphic implements FontRenderer {\r\n  private _text: string = '';\r\n  public alphabet: string = '';\r\n  public spriteSheet: SpriteSheet;\r\n\r\n  public shadow?: { offset: Vector } = undefined;\r\n  public caseInsensitive = false;\r\n  public spacing: number = 0;\r\n  public lineHeight: number | undefined = undefined;\r\n\r\n  private _logger = Logger.getInstance();\r\n\r\n  constructor(options: SpriteFontOptions & GraphicOptions) {\r\n    super(options);\r\n    const { alphabet, spriteSheet, caseInsensitive, spacing, shadow, lineHeight } = options;\r\n    this.alphabet = alphabet;\r\n    this.spriteSheet = spriteSheet;\r\n    this.caseInsensitive = caseInsensitive ?? this.caseInsensitive;\r\n    this.spacing = spacing ?? this.spacing;\r\n    this.shadow = shadow ?? this.shadow;\r\n    this.lineHeight = lineHeight ?? this.lineHeight;\r\n  }\r\n\r\n  private _getCharacterSprites(text: string): Sprite[] {\r\n    const results: Sprite[] = [];\r\n    // handle case insensitive\r\n    const textToRender = this.caseInsensitive ? text.toLocaleLowerCase() : text;\r\n    const alphabet = this.caseInsensitive ? this.alphabet.toLocaleLowerCase() : this.alphabet;\r\n\r\n    // for each letter in text\r\n    for (let letterIndex = 0; letterIndex < textToRender.length; letterIndex++) {\r\n      // find the sprite index in alphabet , if there is an error pick the first\r\n      const letter = textToRender[letterIndex];\r\n      let spriteIndex = alphabet.indexOf(letter);\r\n      if (spriteIndex === -1) {\r\n        spriteIndex = 0;\r\n        this._logger.warnOnce(`SpriteFont - Cannot find letter '${letter}' in configured alphabet '${alphabet}'.`);\r\n        this._logger.warnOnce('There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged.');\r\n      }\r\n\r\n      const letterSprite = this.spriteSheet.sprites[spriteIndex];\r\n      if (letterSprite) {\r\n        results.push(letterSprite);\r\n      } else {\r\n        this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${letter}' at index '${spriteIndex}' in configured SpriteSheet`);\r\n        this._logger.warnOnce('There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged.');\r\n      }\r\n    }\r\n    return results;\r\n  }\r\n\r\n  public measureText(text: string, maxWidth?: number): BoundingBox {\r\n    const lines = this._getLinesFromText(text, maxWidth);\r\n    const maxWidthLine = lines.reduce((a, b) => {\r\n      return a.length > b.length ? a : b;\r\n    });\r\n    const sprites = this._getCharacterSprites(maxWidthLine);\r\n    let width = 0;\r\n    let height = 0;\r\n    for (const sprite of sprites) {\r\n      width += sprite.width + this.spacing;\r\n      height = Math.max(height, sprite.height);\r\n    }\r\n    return BoundingBox.fromDimension(width * this.scale.x, height * lines.length * this.scale.y, Vector.Zero);\r\n  }\r\n\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number, maxWidth?: number): void {\r\n    let xCursor = 0;\r\n    let yCursor = 0;\r\n    let height = 0;\r\n    const lines = this._getLinesFromText(this._text, maxWidth);\r\n    for (const line of lines) {\r\n      for (const sprite of this._getCharacterSprites(line)) {\r\n        // draw it in the right spot and increase the cursor by sprite width\r\n        sprite.draw(ex, x + xCursor, y + yCursor);\r\n        xCursor += sprite.width + this.spacing;\r\n        height = Math.max(height, sprite.height);\r\n      }\r\n      xCursor = 0;\r\n      yCursor += this.lineHeight ?? height;\r\n    }\r\n  }\r\n\r\n  render(ex: ExcaliburGraphicsContext, text: string, _color: any, x: number, y: number, maxWidth?: number) {\r\n    // SpriteFont doesn't support _color, yet...\r\n    this._text = text;\r\n    const bounds = this.measureText(text, maxWidth);\r\n    this.width = bounds.width;\r\n    this.height = bounds.height;\r\n    if (this.shadow) {\r\n      ex.save();\r\n      ex.translate(this.shadow.offset.x, this.shadow.offset.y);\r\n      this._preDraw(ex, x, y);\r\n      this._drawImage(ex, 0, 0, maxWidth);\r\n      this._postDraw(ex);\r\n      ex.restore();\r\n    }\r\n\r\n    this._preDraw(ex, x, y);\r\n    this._drawImage(ex, 0, 0, maxWidth);\r\n    this._postDraw(ex);\r\n  }\r\n\r\n  clone(): SpriteFont {\r\n    return new SpriteFont({\r\n      alphabet: this.alphabet,\r\n      spriteSheet: this.spriteSheet,\r\n      spacing: this.spacing\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Return array of lines split based on the \\n character, and the maxWidth? constraint\r\n   * @param text\r\n   * @param maxWidth\r\n   */\r\n  private _cachedText?: string;\r\n  private _cachedLines?: string[];\r\n  private _cachedRenderWidth?: number;\r\n  private _getLinesFromText(text: string, maxWidth?: number) {\r\n    if (this._cachedText === text && this._cachedRenderWidth === maxWidth && this._cachedLines?.length) {\r\n      return this._cachedLines;\r\n    }\r\n\r\n    const lines = text.split('\\n');\r\n\r\n    if (maxWidth == null) {\r\n      return lines;\r\n    }\r\n\r\n    // If the current line goes past the maxWidth, append a new line without modifying the underlying text.\r\n    for (let i = 0; i < lines.length; i++) {\r\n      let line = lines[i];\r\n      let newLine = '';\r\n      // Note: we subtract the spacing to counter the initial padding on the left side.\r\n      if (this.measureText(line).width > maxWidth) {\r\n        while (this.measureText(line).width > maxWidth) {\r\n          newLine = line[line.length - 1] + newLine;\r\n          line = line.slice(0, -1); // Remove last character from line\r\n        }\r\n\r\n        // Update the array with our new values\r\n        lines[i] = line;\r\n        lines[i + 1] = newLine;\r\n      }\r\n    }\r\n\r\n    this._cachedText = text;\r\n    this._cachedLines = lines;\r\n    this._cachedRenderWidth = maxWidth;\r\n\r\n    return lines;\r\n  }\r\n}\r\n","import { Future } from '../Util/Future';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { GraphicOptions } from './Graphic';\r\nimport { ImageSource, ImageWrapConfiguration } from './ImageSource';\r\nimport { SourceView, Sprite } from './Sprite';\r\nimport { ImageWrapping } from './Wrapping';\r\n\r\nexport interface TiledSpriteOptions {\r\n  image: ImageSource;\r\n  /**\r\n   * Source view into the {@link ImageSource image}\r\n   */\r\n  sourceView?: SourceView;\r\n  /**\r\n   * Optionally override {@link ImageFiltering filtering}\r\n   */\r\n  filtering?: ImageFiltering;\r\n  /**\r\n   * Optionally override {@link ImageWrapping wrapping} , default wrapping is Repeat for TiledSprite\r\n   */\r\n  wrapping?: ImageWrapConfiguration | ImageWrapping;\r\n  /**\r\n   * Total width in pixels for the tiling to take place over\r\n   */\r\n  width: number;\r\n  /**\r\n   * Total height in pixels for the tiling to take place over\r\n   */\r\n  height: number;\r\n}\r\n\r\nexport class TiledSprite extends Sprite {\r\n  private _ready = new Future<void>();\r\n  public ready = this._ready.promise;\r\n  private _options: TiledSpriteOptions & GraphicOptions;\r\n  constructor(options: TiledSpriteOptions & GraphicOptions) {\r\n    super({\r\n      image: options.image,\r\n      sourceView: options.sourceView,\r\n      destSize: { width: options.width, height: options.height },\r\n      flipHorizontal: options.flipHorizontal,\r\n      flipVertical: options.flipVertical,\r\n      rotation: options.rotation,\r\n      scale: options.scale,\r\n      opacity: options.opacity,\r\n      tint: options.tint,\r\n      origin: options.origin\r\n    });\r\n    this._options = options;\r\n\r\n    if (this.image.isLoaded()) {\r\n      this._applyTiling();\r\n    } else {\r\n      this.image.ready.then(() => this._applyTiling());\r\n    }\r\n  }\r\n\r\n  public static fromSprite(sprite: Sprite, options?: Partial<Omit<TiledSpriteOptions & GraphicOptions, 'image'>>): TiledSprite {\r\n    return new TiledSprite({\r\n      sourceView: { ...sprite.sourceView },\r\n      width: sprite.width,\r\n      height: sprite.height,\r\n      ...options,\r\n      image: sprite.image\r\n    });\r\n  }\r\n\r\n  private _applyTiling() {\r\n    const { width, height, filtering, wrapping } = { ...this._options };\r\n    const spriteCanvas = document.createElement('canvas')!;\r\n    spriteCanvas.width = this.sourceView.width;\r\n    spriteCanvas.height = this.sourceView.height;\r\n    const spriteCtx = spriteCanvas.getContext('2d')!;\r\n    // prettier-ignore\r\n    spriteCtx.drawImage(\r\n        this.image.image,\r\n        this.sourceView.x, this.sourceView.y,\r\n        this.sourceView.width, this.sourceView.height,\r\n        0, 0,\r\n        this.sourceView.width, this.sourceView.height);\r\n\r\n    // prettier-ignore\r\n    const tiledImageSource = ImageSource.fromHtmlCanvasElement(spriteCanvas, {\r\n        wrapping: wrapping ?? ImageWrapping.Repeat,\r\n        filtering\r\n      });\r\n    if (width) {\r\n      this.destSize.width = width;\r\n      this.sourceView.width = width;\r\n    }\r\n    if (height) {\r\n      this.destSize.height = height;\r\n      this.sourceView.height = height;\r\n    }\r\n    this.sourceView.x = 0;\r\n    this.sourceView.y = 0;\r\n    this.image = tiledImageSource;\r\n    // this._ready.resolve();\r\n    this.image.ready.then(() => this._ready.resolve());\r\n  }\r\n}\r\n","import { ImageSource } from './ImageSource';\r\nimport { SourceView, Sprite } from './Sprite';\r\nimport { GraphicOptions } from './Graphic';\r\nimport { TiledSprite, TiledSpriteOptions } from './TiledSprite';\r\n\r\n/**\r\n * Specify sprite sheet spacing options, useful if your sprites are not tightly packed\r\n * and have space between them.\r\n */\r\nexport interface SpriteSheetSpacingDimensions {\r\n  /**\r\n   * The starting point to offset and start slicing the sprite sheet from the top left of the image.\r\n   * Default is (0, 0)\r\n   */\r\n  originOffset?: { x?: number; y?: number };\r\n\r\n  /**\r\n   * The margin between sprites.\r\n   * Default is (0, 0)\r\n   */\r\n  margin?: { x?: number; y?: number };\r\n}\r\n\r\n/**\r\n * Sprite sheet options for slicing up images\r\n */\r\nexport interface SpriteSheetGridOptions {\r\n  /**\r\n   * Source image to use for each sprite\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * Grid definition for the sprite sheet\r\n   */\r\n  grid: {\r\n    /**\r\n     * Number of rows in the sprite sheet\r\n     */\r\n    rows: number;\r\n    /**\r\n     * Number of columns in the sprite sheet\r\n     */\r\n    columns: number;\r\n    /**\r\n     * Width of each individual sprite\r\n     */\r\n    spriteWidth: number;\r\n    /**\r\n     * Height of each individual sprite\r\n     */\r\n    spriteHeight: number;\r\n  };\r\n  /**\r\n   * Optionally specify any spacing information between sprites\r\n   */\r\n  spacing?: SpriteSheetSpacingDimensions;\r\n}\r\n\r\nexport interface SpriteSheetSparseOptions {\r\n  /**\r\n   * Source image to use for each sprite\r\n   */\r\n  image: ImageSource;\r\n  /**\r\n   * List of source view rectangles to create a sprite sheet from\r\n   */\r\n  sourceViews: SourceView[];\r\n}\r\n\r\nexport interface SpriteSheetOptions {\r\n  /**\r\n   * Source sprites for the sprite sheet\r\n   */\r\n  sprites: Sprite[];\r\n  /**\r\n   * Optionally specify the number of rows in a sprite sheet (default 1 row)\r\n   */\r\n  rows?: number;\r\n  /**\r\n   * Optionally specify the number of columns in a sprite sheet (default sprites.length)\r\n   */\r\n  columns?: number;\r\n}\r\n\r\nexport interface GetSpriteOptions extends GraphicOptions {}\r\n\r\n/**\r\n * Represents a collection of sprites from a source image with some organization in a grid\r\n */\r\nexport class SpriteSheet {\r\n  public readonly sprites: Sprite[] = [];\r\n  public readonly rows: number;\r\n  public readonly columns: number;\r\n\r\n  /**\r\n   * Build a new sprite sheet from a list of sprites\r\n   *\r\n   * Use {@apilink SpriteSheet.fromImageSource} to create a SpriteSheet from an {@apilink ImageSource} organized in a grid\r\n   * @param options\r\n   */\r\n  constructor(options: SpriteSheetOptions) {\r\n    const { sprites, rows, columns } = options;\r\n    this.sprites = sprites;\r\n    this.rows = rows ?? 1;\r\n    this.columns = columns ?? this.sprites.length;\r\n  }\r\n\r\n  /**\r\n   * Find a sprite by their x/y integer coordinates in the SpriteSheet, for example `getSprite(0, 0)` is the {@apilink Sprite} in the top-left\r\n   * and `getSprite(1, 0)` is the sprite one to the right.\r\n   * @param x\r\n   * @param y\r\n   */\r\n  public getSprite(x: number, y: number, options?: GetSpriteOptions): Sprite {\r\n    if (x >= this.columns || x < 0) {\r\n      throw Error(`No sprite exists in the SpriteSheet at (${x}, ${y}), x: ${x} should be between 0 and ${this.columns - 1} columns`);\r\n    }\r\n    if (y >= this.rows || y < 0) {\r\n      throw Error(`No sprite exists in the SpriteSheet at (${x}, ${y}), y: ${y} should be between 0 and ${this.rows - 1} rows`);\r\n    }\r\n    const spriteIndex = x + y * this.columns;\r\n    const sprite = this.sprites[spriteIndex];\r\n    if (sprite) {\r\n      if (options) {\r\n        const spriteWithOptions = sprite.clone();\r\n        spriteWithOptions.flipHorizontal = options.flipHorizontal ?? spriteWithOptions.flipHorizontal;\r\n        spriteWithOptions.flipVertical = options.flipVertical ?? spriteWithOptions.flipVertical;\r\n        spriteWithOptions.width = options.width ?? spriteWithOptions.width;\r\n        spriteWithOptions.height = options.height ?? spriteWithOptions.height;\r\n        spriteWithOptions.rotation = options.rotation ?? spriteWithOptions.rotation;\r\n        spriteWithOptions.scale = options.scale ?? spriteWithOptions.scale;\r\n        spriteWithOptions.opacity = options.opacity ?? spriteWithOptions.opacity;\r\n        spriteWithOptions.tint = options.tint ?? spriteWithOptions.tint;\r\n        spriteWithOptions.origin = options.origin ?? spriteWithOptions.origin;\r\n        return spriteWithOptions;\r\n      }\r\n      return sprite;\r\n    }\r\n    throw Error(`Invalid sprite coordinates (${x}, ${y})`);\r\n  }\r\n\r\n  /**\r\n   * Find a sprite by their x/y integer coordinates in the SpriteSheet and configures tiling to repeat by default,\r\n   * for example `getTiledSprite(0, 0)` is the {@apilink TiledSprite} in the top-left\r\n   * and `getTiledSprite(1, 0)` is the sprite one to the right.\r\n   *\r\n   * Example:\r\n   *\r\n   * ```typescript\r\n   * spriteSheet.getTiledSprite(1, 0, {\r\n   * width: game.screen.width,\r\n   * height: 200,\r\n   * wrapping: {\r\n   * x: ex.ImageWrapping.Repeat,\r\n   * y: ex.ImageWrapping.Clamp\r\n   * }\r\n   * });\r\n   * ```\r\n   * @param x\r\n   * @param y\r\n   * @param options\r\n   */\r\n  public getTiledSprite(x: number, y: number, options?: Partial<Omit<TiledSpriteOptions & GraphicOptions, 'image'>>): TiledSprite {\r\n    if (x >= this.columns || x < 0) {\r\n      throw Error(`No sprite exists in the SpriteSheet at (${x}, ${y}), x: ${x} should be between 0 and ${this.columns - 1} columns`);\r\n    }\r\n    if (y >= this.rows || y < 0) {\r\n      throw Error(`No sprite exists in the SpriteSheet at (${x}, ${y}), y: ${y} should be between 0 and ${this.rows - 1} rows`);\r\n    }\r\n    const spriteIndex = x + y * this.columns;\r\n    const sprite = this.sprites[spriteIndex];\r\n    if (sprite) {\r\n      return TiledSprite.fromSprite(sprite, options);\r\n    }\r\n    throw Error(`Invalid sprite coordinates (${x}, ${y})`);\r\n  }\r\n\r\n  /**\r\n   * Create a sprite sheet from a sparse set of {@apilink SourceView} rectangles\r\n   * @param options\r\n   */\r\n  public static fromImageSourceWithSourceViews(options: SpriteSheetSparseOptions): SpriteSheet {\r\n    const sprites: Sprite[] = options.sourceViews.map((sourceView) => {\r\n      return new Sprite({\r\n        image: options.image,\r\n        sourceView\r\n      });\r\n    });\r\n    return new SpriteSheet({ sprites });\r\n  }\r\n\r\n  /**\r\n   * Create a SpriteSheet from an {@apilink ImageSource} organized in a grid\r\n   *\r\n   * Example:\r\n   * ```\r\n   * const spriteSheet = SpriteSheet.fromImageSource({\r\n   *   image: imageSource,\r\n   *   grid: {\r\n   *     rows: 5,\r\n   *     columns: 2,\r\n   *     spriteWidth: 32, // pixels\r\n   *     spriteHeight: 32 // pixels\r\n   *   },\r\n   *   // Optionally specify spacing\r\n   *   spacing: {\r\n   *     // pixels from the top left to start the sprite parsing\r\n   *     originOffset: {\r\n   *       x: 5,\r\n   *       y: 5\r\n   *     },\r\n   *     // pixels between each sprite while parsing\r\n   *     margin: {\r\n   *       x: 1,\r\n   *       y: 1\r\n   *     }\r\n   *   }\r\n   * })\r\n   * ```\r\n   * @param options\r\n   */\r\n  public static fromImageSource(options: SpriteSheetGridOptions): SpriteSheet {\r\n    const sprites: Sprite[] = [];\r\n    options.spacing = options.spacing ?? {};\r\n    const {\r\n      image,\r\n      grid: { rows, columns: cols, spriteWidth, spriteHeight },\r\n      spacing: { originOffset, margin }\r\n    } = options;\r\n    const offsetDefaults = { x: 0, y: 0, ...originOffset };\r\n    const marginDefaults = { x: 0, y: 0, ...margin };\r\n    for (let x = 0; x < cols; x++) {\r\n      for (let y = 0; y < rows; y++) {\r\n        sprites[x + y * cols] = new Sprite({\r\n          image: image,\r\n          sourceView: {\r\n            x: x * spriteWidth + marginDefaults.x * x + offsetDefaults.x,\r\n            y: y * spriteHeight + marginDefaults.y * y + offsetDefaults.y,\r\n            width: spriteWidth,\r\n            height: spriteHeight\r\n          },\r\n          destSize: { height: spriteHeight, width: spriteWidth }\r\n        });\r\n      }\r\n    }\r\n    return new SpriteSheet({\r\n      sprites: sprites,\r\n      rows: rows,\r\n      columns: cols\r\n    });\r\n  }\r\n\r\n  public clone(): SpriteSheet {\r\n    return new SpriteSheet({\r\n      sprites: this.sprites.map((sprite) => sprite.clone()),\r\n      rows: this.rows,\r\n      columns: this.columns\r\n    });\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext } from '../Context/ExcaliburGraphicsContext';\r\nimport { ImageSource } from '../ImageSource';\r\nimport { SpriteFont } from '../SpriteFont';\r\nimport { SpriteSheet } from '../SpriteSheet';\r\nimport { Vector } from '../../Math/vector';\r\nimport debugFont from './debug-font.png';\r\n\r\n/**\r\n * Internal debug text helper\r\n */\r\nexport class DebugText {\r\n  constructor() {\r\n    // We fire and forget, we don't care if it's loaded or not\r\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n    this.load();\r\n  }\r\n\r\n  /**\r\n   * base64 font\r\n   */\r\n  public readonly fontSheet = debugFont;\r\n  public size: number = 16;\r\n  private _imageSource!: ImageSource;\r\n  private _spriteSheet!: SpriteSheet;\r\n  private _spriteFont!: SpriteFont;\r\n  public load() {\r\n    this._imageSource = new ImageSource(this.fontSheet);\r\n    return this._imageSource.load().then(() => {\r\n      this._spriteSheet = SpriteSheet.fromImageSource({\r\n        image: this._imageSource,\r\n        grid: {\r\n          rows: 4,\r\n          columns: 16,\r\n          spriteWidth: 16,\r\n          spriteHeight: 16\r\n        }\r\n      });\r\n      this._spriteFont = new SpriteFont({\r\n        alphabet: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!\\'&.\"?-()+# ',\r\n        caseInsensitive: true,\r\n        spriteSheet: this._spriteSheet,\r\n        spacing: -6\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Writes debug text using the built in sprint font\r\n   * @param ctx\r\n   * @param text\r\n   * @param pos\r\n   */\r\n  public write(ctx: ExcaliburGraphicsContext, text: string, pos: Vector) {\r\n    if (this._imageSource.isLoaded()) {\r\n      this._spriteFont.render(ctx, text, null, pos.x, pos.y);\r\n    }\r\n  }\r\n}\r\n","export default \"data:image/png;base64,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\"","export class RenderSource {\r\n  constructor(\r\n    private _gl: WebGLRenderingContext,\r\n    private _texture: WebGLTexture\r\n  ) {}\r\n\r\n  public use() {\r\n    const gl = this._gl;\r\n    gl.activeTexture(gl.TEXTURE0);\r\n    gl.bindTexture(gl.TEXTURE_2D, this._texture);\r\n  }\r\n\r\n  public disable() {\r\n    const gl = this._gl;\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n  }\r\n}\r\n","import { RenderSource } from './render-source';\r\n\r\ndeclare global {\r\n  interface WebGL2RenderingContext {\r\n    /**\r\n     * Experimental only in chrome\r\n     */\r\n    drawingBufferFormat?: number;\r\n  }\r\n}\r\n\r\nexport interface RenderTargetOptions {\r\n  gl: WebGL2RenderingContext;\r\n  width: number;\r\n  height: number;\r\n  transparency: boolean;\r\n  /**\r\n   * Optionally enable render buffer multisample anti-aliasing\r\n   *\r\n   * By default false\r\n   */\r\n  antialias?: boolean;\r\n  /**\r\n   * Optionally specify number of anti-aliasing samples to use\r\n   *\r\n   * By default the max for the platform is used if antialias is on.\r\n   */\r\n  samples?: number;\r\n}\r\n\r\nexport class RenderTarget {\r\n  width: number;\r\n  height: number;\r\n  transparency: boolean;\r\n  antialias: boolean = false;\r\n  samples: number = 1;\r\n  private _gl: WebGL2RenderingContext;\r\n  public readonly bufferFormat: number;\r\n  constructor(options: RenderTargetOptions) {\r\n    this._gl = options.gl;\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.transparency = options.transparency;\r\n    this.antialias = options.antialias ?? this.antialias;\r\n    this.samples = options.samples ?? this._gl.getParameter(this._gl.MAX_SAMPLES);\r\n\r\n    const gl = this._gl;\r\n    // Determine current context format for blitting later needs to match\r\n    if (gl.drawingBufferFormat) {\r\n      this.bufferFormat = gl.drawingBufferFormat;\r\n    } else {\r\n      // Documented in webgl spec\r\n      // https://registry.khronos.org/webgl/specs/latest/1.0/\r\n      if (this.transparency) {\r\n        this.bufferFormat = gl.RGBA8;\r\n      } else {\r\n        this.bufferFormat = gl.RGB8;\r\n      }\r\n    }\r\n\r\n    this._setupRenderBuffer();\r\n    this._setupFramebuffer();\r\n  }\r\n\r\n  setResolution(width: number, height: number) {\r\n    const gl = this._gl;\r\n    this.width = width;\r\n    this.height = height;\r\n\r\n    // update backing texture size\r\n    gl.bindTexture(gl.TEXTURE_2D, this._frameTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n\r\n    // update render buffer size\r\n    if (this._renderBuffer) {\r\n      gl.bindRenderbuffer(gl.RENDERBUFFER, this._renderBuffer);\r\n      gl.renderbufferStorageMultisample(\r\n        gl.RENDERBUFFER,\r\n        Math.min(this.samples, gl.getParameter(gl.MAX_SAMPLES)),\r\n        this.bufferFormat,\r\n        this.width,\r\n        this.height\r\n      );\r\n    }\r\n  }\r\n\r\n  private _renderBuffer!: WebGLRenderbuffer;\r\n  public get renderBuffer() {\r\n    return this._renderBuffer;\r\n  }\r\n  private _renderFrameBuffer!: WebGLFramebuffer;\r\n  public get renderFrameBuffer() {\r\n    return this._renderFrameBuffer;\r\n  }\r\n\r\n  private _frameBuffer!: WebGLFramebuffer;\r\n  public get frameBuffer() {\r\n    return this._frameBuffer;\r\n  }\r\n  private _frameTexture!: WebGLTexture;\r\n  public get frameTexture() {\r\n    return this._frameTexture;\r\n  }\r\n\r\n  private _setupRenderBuffer() {\r\n    if (this.antialias) {\r\n      const gl = this._gl;\r\n      // Render buffers can be used as an input to a shader\r\n      this._renderBuffer = gl.createRenderbuffer()!;\r\n      this._renderFrameBuffer = gl.createFramebuffer()!;\r\n      gl.bindRenderbuffer(gl.RENDERBUFFER, this._renderBuffer);\r\n      gl.renderbufferStorageMultisample(\r\n        gl.RENDERBUFFER,\r\n        Math.min(this.samples, gl.getParameter(gl.MAX_SAMPLES)),\r\n        this.bufferFormat,\r\n        this.width,\r\n        this.height\r\n      );\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, this._renderFrameBuffer);\r\n      gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.RENDERBUFFER, this._renderBuffer);\r\n    }\r\n  }\r\n\r\n  private _setupFramebuffer() {\r\n    // Allocates frame buffer\r\n    const gl = this._gl;\r\n    this._frameTexture = gl.createTexture()!;\r\n    gl.bindTexture(gl.TEXTURE_2D, this._frameTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n\r\n    // set the filtering so we don't need mips\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n\r\n    // attach the texture as the first color attachment\r\n    const attachmentPoint = gl.COLOR_ATTACHMENT0;\r\n\r\n    // After this bind all draw calls will draw to this framebuffer texture\r\n    this._frameBuffer = gl.createFramebuffer()!;\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, attachmentPoint, gl.TEXTURE_2D, this._frameTexture, 0);\r\n\r\n    // Reset after initialized\r\n    this.disable();\r\n  }\r\n\r\n  public toRenderSource() {\r\n    if (this.renderBuffer) {\r\n      this.blitRenderBufferToFrameBuffer();\r\n    }\r\n    const source = new RenderSource(this._gl, this._frameTexture);\r\n    return source;\r\n  }\r\n\r\n  public blitToScreen() {\r\n    const gl = this._gl;\r\n    // set to size of canvas's drawingBuffer\r\n    if (this._renderBuffer) {\r\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this.renderFrameBuffer);\r\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, null);\r\n      gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 1.0, 1.0]);\r\n      gl.blitFramebuffer(0, 0, this.width, this.height, 0, 0, this.width, this.height, gl.COLOR_BUFFER_BIT, gl.LINEAR);\r\n    } else {\r\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this.frameBuffer);\r\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, null);\r\n      gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 1.0, 1.0]);\r\n      gl.blitFramebuffer(0, 0, this.width, this.height, 0, 0, this.width, this.height, gl.COLOR_BUFFER_BIT, gl.LINEAR);\r\n    }\r\n  }\r\n\r\n  public blitRenderBufferToFrameBuffer() {\r\n    if (this._renderBuffer) {\r\n      const gl = this._gl;\r\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, this.renderFrameBuffer);\r\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, this.frameBuffer);\r\n      gl.clearBufferfv(gl.COLOR, 0, [0.0, 0.0, 1.0, 1.0]);\r\n      gl.blitFramebuffer(0, 0, this.width, this.height, 0, 0, this.width, this.height, gl.COLOR_BUFFER_BIT, gl.LINEAR);\r\n    }\r\n  }\r\n\r\n  public copyToTexture(texture: WebGLTexture) {\r\n    const gl = this._gl;\r\n    if (this._renderBuffer) {\r\n      this.blitRenderBufferToFrameBuffer();\r\n    }\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n    gl.copyTexImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 0, 0, this.width, this.height, 0);\r\n  }\r\n\r\n  /**\r\n   * When called, all drawing gets redirected to this render target\r\n   */\r\n  public use() {\r\n    const gl = this._gl;\r\n    if (this.antialias) {\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, this._renderFrameBuffer);\r\n    } else {\r\n      gl.bindFramebuffer(gl.FRAMEBUFFER, this._frameBuffer);\r\n    }\r\n\r\n    // very important to set the viewport to the size of the framebuffer texture\r\n    gl.viewport(0, 0, this.width, this.height);\r\n  }\r\n\r\n  /**\r\n   * When called, all drawing is sent back to the canvas\r\n   */\r\n  public disable() {\r\n    const gl = this._gl;\r\n    // passing null switches rendering back to the canvas\r\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n  }\r\n}\r\n","/**\r\n * Return the size of the GlType in bytes\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getGlTypeSizeBytes(gl: WebGLRenderingContext, type: number): number {\r\n  switch (type) {\r\n    case gl.INT:\r\n    case gl.UNSIGNED_INT:\r\n    case gl.FLOAT:\r\n      return 4;\r\n    case gl.SHORT:\r\n      return 2;\r\n    case gl.UNSIGNED_SHORT:\r\n      return 2;\r\n    case gl.BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_BYTE:\r\n      return 1;\r\n    default:\r\n      return 1;\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if an attribute is present in vertex source\r\n */\r\nexport function isAttributeInSource(source: string, variable: string) {\r\n  const attributeRegexTemplate = `(?<type>[a-z0-9]+)\\\\s+${variable};`;\r\n  const regex = new RegExp(attributeRegexTemplate, 'g');\r\n  const matches = regex.exec(source);\r\n  return matches?.length! > 0;\r\n}\r\n\r\n/**\r\n * Attempt to discern the glType of an attribute from vertex source\r\n * @param gl\r\n * @param source\r\n * @param variable\r\n */\r\nexport function getGLTypeFromSource(gl: WebGLRenderingContext, source: string, variable: string) {\r\n  const attributeRegexTemplate = `(?<type>[a-z0-9]+)\\\\s+${variable};`;\r\n  const regex = new RegExp(attributeRegexTemplate, 'g');\r\n  const matches = regex.exec(source);\r\n  const type = matches?.groups?.type;\r\n\r\n  switch (type) {\r\n    case 'float':\r\n    case 'vec2':\r\n    case 'vec3':\r\n    case 'vec4':\r\n      return gl.FLOAT;\r\n    case 'int':\r\n    case 'ivec2':\r\n    case 'ivec3':\r\n    case 'ivec4':\r\n      return gl.INT;\r\n    case 'uint':\r\n    case 'uvec2':\r\n    case 'uvec3':\r\n    case 'uvec4':\r\n      return gl.UNSIGNED_INT;\r\n    case 'bool':\r\n    case 'bvec2':\r\n    case 'bvec3':\r\n    case 'bvec4':\r\n      return gl.BOOL;\r\n    case 'short':\r\n      return gl.SHORT;\r\n    case 'ushort':\r\n      return gl.UNSIGNED_SHORT;\r\n    case 'ubyte':\r\n      return gl.UNSIGNED_BYTE;\r\n    case 'byte':\r\n      return gl.BYTE;\r\n    default:\r\n      return gl.FLOAT;\r\n  }\r\n}\r\n\r\n/**\r\n * Based on the type return the number of attribute components\r\n *\r\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getAttributeComponentSize(gl: WebGLRenderingContext, type: number): number {\r\n  switch (type) {\r\n    case gl.LOW_FLOAT:\r\n    case gl.HIGH_FLOAT:\r\n    case gl.FLOAT:\r\n      return 1;\r\n    case gl.FLOAT_VEC2:\r\n      return 2;\r\n    case gl.FLOAT_VEC3:\r\n      return 3;\r\n    case gl.FLOAT_VEC4:\r\n      return 4;\r\n    case gl.BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_BYTE:\r\n      return 1;\r\n    case gl.UNSIGNED_SHORT:\r\n    case gl.SHORT:\r\n      return 1;\r\n    default:\r\n      return 1;\r\n  }\r\n}\r\n\r\n/**\r\n * Based on the attribute return the corresponding supported attrib pointer type\r\n * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n * @param gl\r\n * @param type\r\n */\r\nexport function getAttributePointerType(gl: WebGLRenderingContext, type: number) {\r\n  switch (type) {\r\n    case gl.LOW_FLOAT:\r\n    case gl.HIGH_FLOAT:\r\n    case gl.FLOAT:\r\n    case gl.FLOAT_VEC2:\r\n    case gl.FLOAT_VEC3:\r\n    case gl.FLOAT_VEC4:\r\n      return gl.FLOAT;\r\n    case gl.BYTE:\r\n      return gl.BYTE;\r\n    case gl.UNSIGNED_BYTE:\r\n      return gl.UNSIGNED_BYTE;\r\n    case gl.SHORT:\r\n      return gl.SHORT;\r\n    case gl.UNSIGNED_SHORT:\r\n      return gl.UNSIGNED_SHORT;\r\n    default:\r\n      return gl.FLOAT;\r\n  }\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function getMaxShaderComplexity(gl: WebGL2RenderingContext, numIfs: number): number {\r\n  const assembleTestShader = (numIfs: number) => {\r\n    const testShader = `#version 300 es\r\n    precision mediump float;\r\n    out vec4 fragColor;\r\n    void main() {\r\n      float index = 1.01;\r\n      %%complexity%%\r\n    }`;\r\n    let testComplexity = '';\r\n    for (let i = 0; i < numIfs; i++) {\r\n      if (i === 0) {\r\n        testComplexity += `if (index <= ${i}.5) {\\n`;\r\n      } else {\r\n        testComplexity += `   else if (index <= ${i}.5) {\\n`;\r\n      }\r\n\r\n      testComplexity += `      fragColor = vec4(1.0);\\n`;\r\n      testComplexity += `   }\\n`;\r\n    }\r\n    return testShader.replace('%%complexity%%', testComplexity);\r\n  };\r\n\r\n  let canCompile = false;\r\n  do {\r\n    const test = assembleTestShader(numIfs);\r\n\r\n    const shader = gl.createShader(gl.FRAGMENT_SHADER)!;\r\n    gl.shaderSource(shader, test);\r\n    gl.compileShader(shader);\r\n\r\n    canCompile = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n    if (!canCompile) {\r\n      numIfs = (numIfs / 2) | 0;\r\n    }\r\n  } while (!canCompile);\r\n  return numIfs;\r\n}\r\n","import { AffineMatrix, Color, Logger, Vector } from '../..';\r\nimport { Matrix } from '../../Math/matrix';\r\nimport { getAttributeComponentSize, getAttributePointerType } from './webgl-util';\r\n\r\n/**\r\n * List of the possible glsl uniform types\r\n */\r\nexport type UniformTypeNames =\r\n  | 'uniform1f'\r\n  | 'uniform1i'\r\n  | 'uniform2f'\r\n  | 'uniform2i'\r\n  | 'uniform3f'\r\n  | 'uniform3i'\r\n  | 'uniform4f'\r\n  | 'uniform4i'\r\n  | 'uniform1fv'\r\n  | 'uniform1iv'\r\n  | 'uniform2fv'\r\n  | 'uniform2iv'\r\n  | 'uniform3fv'\r\n  | 'uniform3iv'\r\n  | 'uniform4fv'\r\n  | 'uniform4iv'\r\n  | 'uniformMatrix2fv'\r\n  | 'uniformMatrix3fv'\r\n  | 'uniformMatrix4fv';\r\n\r\ntype RemoveFirstFromTuple<T extends any[]> = T['length'] extends 0\r\n  ? []\r\n  : ((...b: T) => void) extends (a: any, ...b: infer I) => void\r\n    ? I\r\n    : [];\r\n\r\ntype UniformParameters<TUniformType extends UniformTypeNames> = RemoveFirstFromTuple<Parameters<WebGLRenderingContext[TUniformType]>>;\r\n\r\nexport interface UniformDefinition {\r\n  name: string;\r\n  glType: number;\r\n  location: WebGLUniformLocation;\r\n}\r\n\r\nexport interface VertexAttributeDefinition {\r\n  /**\r\n   * string name of the attribute in the shader program, commonly `a_nameofmyvariable`\r\n   */\r\n  name: string;\r\n  /**\r\n   * Number of components for a given attribute\r\n   * Must be 1, 2, 3, or 4\r\n   *\r\n   * For example a vec4 attribute would be `4` floats, so 4\r\n   */\r\n  size: number;\r\n  /**\r\n   * Supported types in webgl 1\r\n   * * gl.BYTE\r\n   * * gl.SHORT\r\n   * * gl.UNSIGNED_BYTE\r\n   * * gl.UNSIGNED_SHORT\r\n   * * gl.FLOAT\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/vertexAttribPointer\r\n   */\r\n  glType: number;\r\n  /**\r\n   * Is the attribute normalized between (0-1)\r\n   */\r\n  normalized: boolean;\r\n  /**\r\n   * Location index in the shader program\r\n   */\r\n  location: number;\r\n}\r\n\r\nexport interface ShaderOptions {\r\n  /**\r\n   * WebGL2RenderingContext this layout will be attached to, these cannot be reused across webgl contexts.\r\n   */\r\n  gl: WebGL2RenderingContext;\r\n  /**\r\n   * Vertex shader source code in glsl #version 300 es\r\n   */\r\n  vertexSource: string;\r\n  /**\r\n   * Fragment shader source code in glsl #version 300 es\r\n   */\r\n  fragmentSource: string;\r\n\r\n  onPreLink?: (program: WebGLProgram) => void;\r\n  onPostCompile?: (shader: Shader) => void;\r\n}\r\n\r\nexport class Shader {\r\n  private static _ACTIVE_SHADER_INSTANCE: Shader | null = null;\r\n  private _logger = Logger.getInstance();\r\n  private _gl: WebGL2RenderingContext;\r\n  public program!: WebGLProgram;\r\n  public uniforms: { [variableName: string]: UniformDefinition } = {};\r\n  public attributes: { [variableName: string]: VertexAttributeDefinition } = {};\r\n  private _compiled = false;\r\n  public readonly vertexSource: string;\r\n  public readonly fragmentSource: string;\r\n  private _onPreLink?: (program: WebGLProgram) => void;\r\n  private _onPostCompile?: (shader: Shader) => void;\r\n\r\n  public get compiled() {\r\n    return this._compiled;\r\n  }\r\n\r\n  /**\r\n   * Create a shader program in excalibur\r\n   * @param options specify shader vertex and fragment source\r\n   */\r\n  constructor(options: ShaderOptions) {\r\n    const { gl, vertexSource, fragmentSource, onPreLink, onPostCompile } = options;\r\n    this._gl = gl;\r\n    this.vertexSource = vertexSource;\r\n    this.fragmentSource = fragmentSource;\r\n    this._onPreLink = onPreLink;\r\n    this._onPostCompile = onPostCompile;\r\n  }\r\n\r\n  dispose() {\r\n    const gl = this._gl;\r\n    gl.deleteProgram(this.program);\r\n    this._gl = null as any;\r\n  }\r\n\r\n  /**\r\n   * Binds the shader program\r\n   */\r\n  use() {\r\n    const gl = this._gl;\r\n    gl.useProgram(this.program);\r\n    Shader._ACTIVE_SHADER_INSTANCE = this;\r\n  }\r\n\r\n  isCurrentlyBound() {\r\n    return Shader._ACTIVE_SHADER_INSTANCE === this;\r\n  }\r\n\r\n  /**\r\n   * Compile the current shader against a webgl context\r\n   */\r\n  compile(): WebGLProgram {\r\n    const gl = this._gl;\r\n    const vertexShader = this._compileShader(gl, this.vertexSource, gl.VERTEX_SHADER);\r\n    const fragmentShader = this._compileShader(gl, this.fragmentSource, gl.FRAGMENT_SHADER);\r\n    this.program = this._createProgram(gl, vertexShader, fragmentShader);\r\n\r\n    const attributes = this.getAttributes();\r\n    for (const attribute of attributes) {\r\n      this.attributes[attribute.name] = attribute;\r\n    }\r\n    const uniforms = this.getUniforms();\r\n    for (const uniform of uniforms) {\r\n      this.uniforms[uniform.name] = uniform;\r\n    }\r\n\r\n    this._compiled = true;\r\n    if (this._onPostCompile) {\r\n      this._onPostCompile(this);\r\n    }\r\n    return this.program;\r\n  }\r\n\r\n  getUniforms(): UniformDefinition[] {\r\n    const gl = this._gl;\r\n    const uniformCount = gl.getProgramParameter(this.program, gl.ACTIVE_UNIFORMS);\r\n    const uniforms: UniformDefinition[] = [];\r\n    for (let i = 0; i < uniformCount; i++) {\r\n      const uniform = gl.getActiveUniform(this.program, i)!;\r\n      const uniformLocation = gl.getUniformLocation(this.program, uniform.name)!;\r\n      uniforms.push({\r\n        name: uniform.name,\r\n        glType: uniform.type,\r\n        location: uniformLocation\r\n      });\r\n    }\r\n    return uniforms;\r\n  }\r\n\r\n  getAttributes(): VertexAttributeDefinition[] {\r\n    const gl = this._gl;\r\n    const attributeCount = gl.getProgramParameter(this.program, gl.ACTIVE_ATTRIBUTES);\r\n    const attributes: VertexAttributeDefinition[] = [];\r\n    for (let i = 0; i < attributeCount; i++) {\r\n      const attribute = gl.getActiveAttrib(this.program, i)!;\r\n      const attributeLocation = gl.getAttribLocation(this.program, attribute.name);\r\n      attributes.push({\r\n        name: attribute.name,\r\n        glType: getAttributePointerType(gl, attribute.type),\r\n        size: getAttributeComponentSize(gl, attribute.type),\r\n        location: attributeLocation,\r\n        normalized: false\r\n      });\r\n    }\r\n    return attributes;\r\n  }\r\n\r\n  /**\r\n   * Set a texture in a gpu texture slot\r\n   * @param slotNumber\r\n   * @param texture\r\n   */\r\n  setTexture(slotNumber: number, texture: WebGLTexture) {\r\n    const gl = this._gl;\r\n    gl.activeTexture(gl.TEXTURE0 + slotNumber);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n  }\r\n\r\n  /**\r\n   * Set an integer uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformInt(name: string, value: number) {\r\n    this.setUniform('uniform1i', name, ~~value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformInt(name: string, value: number): boolean {\r\n    return this.trySetUniform('uniform1i', name, ~~value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer array uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformIntArray(name: string, value: number[]) {\r\n    this.setUniform('uniform1iv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set an integer array uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformIntArray(name: string, value: number[]): boolean {\r\n    return this.trySetUniform('uniform1iv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a boolean uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformBoolean(name: string, value: boolean) {\r\n    this.setUniform('uniform1i', name, value ? 1 : 0);\r\n  }\r\n\r\n  /**\r\n   * Set a boolean uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformBoolean(name: string, value: boolean): boolean {\r\n    return this.trySetUniform('uniform1i', name, value ? 1 : 0);\r\n  }\r\n\r\n  /**\r\n   * Set a float uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloat(name: string, value: number) {\r\n    this.setUniform('uniform1f', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a float uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloat(name: string, value: number): boolean {\r\n    return this.trySetUniform('uniform1f', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a float array uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatArray(name: string, value: number[]) {\r\n    this.setUniform('uniform1fv', name, value);\r\n  }\r\n  /**\r\n   * Set a float array uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloatArray(name: string, value: number[]): boolean {\r\n    return this.trySetUniform('uniform1fv', name, value);\r\n  }\r\n\r\n  /**\r\n   * Set a {@apilink Vector} uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatVector(name: string, value: Vector) {\r\n    this.setUniform('uniform2f', name, value.x, value.y);\r\n  }\r\n\r\n  /**\r\n   * Set a {@apilink Vector} uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloatVector(name: string, value: Vector): boolean {\r\n    return this.trySetUniform('uniform2f', name, value.x, value.y);\r\n  }\r\n\r\n  /**\r\n   * Set a {@apilink Color} uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformFloatColor(name: string, value: Color) {\r\n    this.setUniform('uniform4f', name, value.r / 255, value.g / 255, value.b / 255, value.a);\r\n  }\r\n\r\n  /**\r\n   * Set a {@apilink Color} uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformFloatColor(name: string, value: Color): boolean {\r\n    return this.trySetUniform('uniform4f', name, value.r / 255, value.g / 255, value.b / 255, value.a);\r\n  }\r\n\r\n  /**\r\n   * Set an {@apilink Matrix} uniform for the current shader\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  setUniformMatrix(name: string, value: Matrix) {\r\n    this.setUniform('uniformMatrix4fv', name, false, value.data);\r\n  }\r\n\r\n  setUniformAffineMatrix(name: string, value: AffineMatrix) {\r\n    this.setUniform('uniformMatrix4fv', name, false, [\r\n      value.data[0],\r\n      value.data[1],\r\n      0,\r\n      0,\r\n\r\n      value.data[2],\r\n      value.data[3],\r\n      0,\r\n      0,\r\n\r\n      0,\r\n      0,\r\n      1,\r\n      0,\r\n\r\n      value.data[4],\r\n      value.data[5],\r\n      0,\r\n      1\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Set an {@apilink Matrix} uniform for the current shader, WILL NOT THROW on error.\r\n   *\r\n   * **Important** Must call ex.Shader.use() before setting a uniform!\r\n   * @param name\r\n   * @param value\r\n   */\r\n  trySetUniformMatrix(name: string, value: Matrix): boolean {\r\n    return this.trySetUniform('uniformMatrix4fv', name, false, value.data);\r\n  }\r\n\r\n  /**\r\n   * Set any available uniform type in webgl\r\n   *\r\n   * For example setUniform('uniformMatrix2fv', 'u_my2x2_mat`, ...);\r\n   */\r\n  setUniform<TUniformType extends UniformTypeNames>(uniformType: TUniformType, name: string, ...value: UniformParameters<TUniformType>) {\r\n    if (!this._compiled) {\r\n      throw Error(`Must compile shader before setting a uniform ${uniformType}:${name}`);\r\n    }\r\n    if (!this.isCurrentlyBound()) {\r\n      throw Error(\r\n        'Currently accessed shader instance is not the current active shader in WebGL,' +\r\n          ' must call `shader.use()` before setting uniforms'\r\n      );\r\n    }\r\n    const gl = this._gl;\r\n    const location = gl.getUniformLocation(this.program, name);\r\n    if (location) {\r\n      const args = [location, ...value];\r\n      (this._gl as any)[uniformType].apply(this._gl, args);\r\n    } else {\r\n      throw Error(\r\n        `Uniform ${uniformType}:${name} doesn\\'t exist or is not used in the shader source code,` +\r\n          ' unused uniforms are optimized away by most browsers'\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set any available uniform type in webgl. Will try to set the uniform, will return false if the uniform didn't exist,\r\n   * true if it was set.\r\n   *\r\n   * WILL NOT THROW on error\r\n   *\r\n   * For example setUniform('uniformMatrix2fv', 'u_my2x2_mat`, ...);\r\n   *\r\n   */\r\n  trySetUniform<TUniformType extends UniformTypeNames>(\r\n    uniformType: TUniformType,\r\n    name: string,\r\n    ...value: UniformParameters<TUniformType>\r\n  ): boolean {\r\n    if (!this._compiled) {\r\n      this._logger.warn(`Must compile shader before setting a uniform ${uniformType}:${name}`);\r\n      return false;\r\n    }\r\n    if (!this.isCurrentlyBound()) {\r\n      this._logger.warn(\r\n        'Currently accessed shader instance is not the current active shader in WebGL,' +\r\n          ' must call `shader.use()` before setting uniforms'\r\n      );\r\n      return false;\r\n    }\r\n    const gl = this._gl;\r\n    const location = gl.getUniformLocation(this.program, name);\r\n    if (location) {\r\n      const args = [location, ...value];\r\n      (this._gl as any)[uniformType].apply(this._gl, args);\r\n    } else {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private _createProgram(gl: WebGLRenderingContext, vertexShader: WebGLShader, fragmentShader: WebGLShader): WebGLProgram {\r\n    const program = gl.createProgram();\r\n    if (program === null) {\r\n      throw Error('Could not create graphics shader program');\r\n    }\r\n\r\n    // attach the shaders.\r\n    gl.attachShader(program, vertexShader);\r\n    gl.attachShader(program, fragmentShader);\r\n\r\n    if (this._onPreLink) {\r\n      this._onPreLink(program);\r\n    }\r\n\r\n    // link the program.\r\n    gl.linkProgram(program);\r\n\r\n    const success = gl.getProgramParameter(program, gl.LINK_STATUS);\r\n    if (!success) {\r\n      throw Error(`Could not link the program: [${gl.getProgramInfoLog(program)}]`);\r\n    }\r\n\r\n    return program;\r\n  }\r\n\r\n  private _compileShader(gl: WebGLRenderingContext, source: string, type: number): WebGLShader {\r\n    const typeName = gl.VERTEX_SHADER === type ? 'vertex' : 'fragment';\r\n    const shader = gl.createShader(type);\r\n    if (shader === null) {\r\n      throw Error(`Could not build shader: [${source}]`);\r\n    }\r\n\r\n    gl.shaderSource(shader, source);\r\n    gl.compileShader(shader);\r\n\r\n    const success = gl.getShaderParameter(shader, gl.COMPILE_STATUS);\r\n    if (!success) {\r\n      const errorInfo = gl.getShaderInfoLog(shader);\r\n      throw Error(`Could not compile ${typeName} shader:\\n\\n${errorInfo}${this._processSourceForError(source, errorInfo!)}`);\r\n    }\r\n    return shader;\r\n  }\r\n\r\n  private _processSourceForError(source: string, errorInfo: string) {\r\n    if (!source) {\r\n      return errorInfo;\r\n    }\r\n    const lines = source.split('\\n');\r\n    const errorLineStart = errorInfo.search(/\\d:\\d/);\r\n    const errorLineEnd = errorInfo.indexOf(' ', errorLineStart);\r\n    const [_, error2] = errorInfo\r\n      .slice(errorLineStart, errorLineEnd)\r\n      .split(':')\r\n      .map((v) => Number(v));\r\n    for (let i = 0; i < lines.length; i++) {\r\n      lines[i] = `${i + 1}: ${lines[i]}${error2 === i + 1 ? ' <----- ERROR!' : ''}`;\r\n    }\r\n\r\n    return '\\n\\nSource:\\n' + lines.join('\\n');\r\n  }\r\n}\r\n","export interface VertexBufferOptions {\r\n  /**\r\n   * WebGL2RenderingContext this layout will be attached to, these cannot be reused across contexts.\r\n   */\r\n  gl: WebGL2RenderingContext;\r\n  /**\r\n   * Size in number of floats, so [4.2, 4.0, 2.1] is size = 3\r\n   *\r\n   * Ignored if data is passed directly\r\n   */\r\n  size?: number;\r\n  /**\r\n   * If the vertices never change switching 'static' can be more efficient on the gpu\r\n   *\r\n   * Default is 'dynamic'\r\n   */\r\n  type?: 'static' | 'dynamic';\r\n\r\n  /**\r\n   * Optionally pass pre-seeded data, size parameter is ignored\r\n   */\r\n  data?: Float32Array;\r\n}\r\n\r\n/**\r\n * Helper around vertex buffer to simplify creating and uploading geometry\r\n *\r\n * Under the hood uses Float32Array\r\n */\r\nexport class VertexBuffer {\r\n  private _gl: WebGL2RenderingContext;\r\n\r\n  /**\r\n   * Access to the webgl buffer handle\r\n   */\r\n  public readonly buffer: WebGLBuffer;\r\n  /**\r\n   * Access to the raw data of the vertex buffer\r\n   */\r\n  public readonly bufferData: Float32Array;\r\n\r\n  /**\r\n   * If the vertices never change switching 'static' can be more efficient on the gpu\r\n   *\r\n   * Default is 'dynamic'\r\n   */\r\n  public type: 'static' | 'dynamic' = 'dynamic';\r\n\r\n  constructor(options: VertexBufferOptions) {\r\n    const { gl, size, type, data } = options;\r\n    this._gl = gl;\r\n    this.buffer = this._gl.createBuffer()!;\r\n    if (!data && !size) {\r\n      throw Error('Must either provide data or a size to the VertexBuffer');\r\n    }\r\n\r\n    if (!data) {\r\n      this.bufferData = new Float32Array(size!);\r\n    } else {\r\n      this.bufferData = data;\r\n    }\r\n    this.type = type ?? this.type;\r\n    // Allocate buffer\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n    gl.bufferData(gl.ARRAY_BUFFER, this.bufferData, this.type === 'static' ? gl.STATIC_DRAW : gl.DYNAMIC_DRAW);\r\n  }\r\n\r\n  /**\r\n   * Bind this vertex buffer\r\n   */\r\n  bind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n  }\r\n\r\n  unbind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n  }\r\n\r\n  /**\r\n   * Upload vertex buffer geometry to the GPU\r\n   */\r\n  upload(count?: number) {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this.buffer);\r\n    if (count) {\r\n      gl.bufferSubData(gl.ARRAY_BUFFER, 0, this.bufferData, 0, count);\r\n    } else {\r\n      // TODO always use bufferSubData? need to perf test it\r\n      gl.bufferData(gl.ARRAY_BUFFER, this.bufferData, this.type === 'static' ? gl.STATIC_DRAW : gl.DYNAMIC_DRAW);\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    const gl = this._gl;\r\n    gl.deleteBuffer(this.buffer);\r\n    this._gl = null as any;\r\n  }\r\n}\r\n","import { Logger } from '../..';\r\nimport { Shader, VertexAttributeDefinition } from './shader';\r\nimport { VertexBuffer } from './vertex-buffer';\r\nimport { getGLTypeFromSource, getGlTypeSizeBytes, isAttributeInSource } from './webgl-util';\r\n\r\nexport interface VertexLayoutOptions {\r\n  /**\r\n   * WebGL2RenderingContext this layout will be attached to, these cannot be reused across contexts.\r\n   */\r\n  gl: WebGL2RenderingContext;\r\n  /**\r\n   * Shader that this layout will be for, if null you must set a shader before using it.\r\n   */\r\n  shader?: Shader;\r\n  /**\r\n   * Vertex buffer to use for vertex data\r\n   */\r\n  vertexBuffer: VertexBuffer;\r\n  /**\r\n   * Starting index for the attribute pointer\r\n   */\r\n  attributePointerStartIndex?: number;\r\n  /**\r\n   * Specify the attributes that will exist in the vertex buffer\r\n   *\r\n   * **Important** must specify them in the order that they will be in the vertex buffer!!\r\n   */\r\n  attributes: [name: string, numberOfComponents: number, type?: 'int' | 'matrix' | 'float'][];\r\n  /**\r\n   * Optionally suppress any warnings out of vertex layouts\r\n   *\r\n   * **BEWARE** this may cause you to have issues go unnoticed\r\n   */\r\n  suppressWarnings?: boolean;\r\n}\r\n\r\n/**\r\n * Helper around creating vertex attributes in a given {@apilink VertexBuffer}, this is useful for describing\r\n * the memory layout for your vertices inside a particular buffer\r\n *\r\n * Note: This helper assumes interleaved attributes in one {@apilink VertexBuffer}, not many.\r\n *\r\n * Working with `gl.vertexAttribPointer` can be tricky, and this attempts to double check you\r\n */\r\nexport class VertexLayout {\r\n  private _gl: WebGL2RenderingContext;\r\n  private _logger = Logger.getInstance();\r\n  private _suppressWarnings = false;\r\n  private _shader: Shader;\r\n  private _layout: VertexAttributeDefinition[] = [];\r\n  private _attributes: [name: string, numberOfComponents: number, type?: 'int' | 'matrix' | 'float'][] = [];\r\n  private _vertexBuffer: VertexBuffer;\r\n  private _vao!: WebGLVertexArrayObject;\r\n\r\n  public get vertexBuffer() {\r\n    return this._vertexBuffer;\r\n  }\r\n\r\n  public get attributes(): readonly [name: string, numberOfComponents: number, type?: 'int' | 'matrix' | 'float'][] {\r\n    return this._attributes;\r\n  }\r\n\r\n  constructor(options: VertexLayoutOptions) {\r\n    const { gl, shader, vertexBuffer, attributes, suppressWarnings } = options;\r\n    this._gl = gl;\r\n    this._vertexBuffer = vertexBuffer;\r\n    this._attributes = attributes;\r\n    this._shader = shader!;\r\n    this._suppressWarnings = suppressWarnings!;\r\n    if (shader) {\r\n      this.initialize();\r\n    }\r\n  }\r\n\r\n  private _vertexTotalSizeBytes = 0;\r\n  /**\r\n   * Total number of bytes that the vertex will take up\r\n   */\r\n  public get totalVertexSizeBytes(): number {\r\n    return this._vertexTotalSizeBytes;\r\n  }\r\n\r\n  public set shader(shader: Shader) {\r\n    if (shader && this._shader !== shader) {\r\n      this._shader = shader;\r\n      this.initialize();\r\n    }\r\n  }\r\n\r\n  public get shader() {\r\n    return this._shader;\r\n  }\r\n\r\n  private _initialized = false;\r\n\r\n  /**\r\n   * Layouts need shader locations and must be bound to a shader\r\n   */\r\n  initialize() {\r\n    if (this._initialized) {\r\n      return;\r\n    }\r\n    if (!this._shader) {\r\n      return;\r\n    }\r\n\r\n    if (!this._shader.compiled) {\r\n      throw Error('Shader not compiled, shader must be compiled before defining a vertex layout');\r\n    }\r\n    this._vertexTotalSizeBytes = 0;\r\n    this._layout.length = 0;\r\n    const shaderAttributes = this._shader.attributes;\r\n    for (const attribute of this._attributes) {\r\n      const attrib = shaderAttributes[attribute[0]];\r\n      if (!attrib) {\r\n        if (!isAttributeInSource(this._shader.vertexSource, attribute[0])) {\r\n          throw Error(\r\n            `The attribute named: ${attribute[0]} size ${attribute[1]}` +\r\n              ` not found in the shader source code:\\n ${this._shader.vertexSource}`\r\n          );\r\n        }\r\n\r\n        if (!this._suppressWarnings) {\r\n          this._logger.warn(\r\n            `The attribute named: ${attribute[0]} size ${attribute[1]}` +\r\n              ` not found in the compiled shader. This is possibly a bug:\\n` +\r\n              ` 1. Not a bug, but should remove unused code - attribute \"${attribute[0]}\" is unused in` +\r\n              ` vertex/fragment and has been automatically removed by glsl compiler.\\n` +\r\n              ` 2. Definitely a bug, attribute \"${attribute[0]}\" in layout has been mistyped or is missing` +\r\n              ` in shader, check vertex/fragment source.`\r\n          );\r\n        }\r\n\r\n        const glType = getGLTypeFromSource(this._gl, this._shader.vertexSource, attribute[0]);\r\n\r\n        // Unused attribute placeholder\r\n        this._layout.push({\r\n          name: attribute[0],\r\n          glType,\r\n          size: attribute[1],\r\n          location: -1,\r\n          normalized: false\r\n        });\r\n      }\r\n      if (attrib) {\r\n        if (attrib.size !== attribute[1]) {\r\n          throw Error(\r\n            `VertexLayout size definition for attribute: [${attribute[0]}, ${attribute[1]}],` +\r\n              ` doesn\\'t match shader source size ${attrib.size}:\\n ${this._shader.vertexSource}`\r\n          );\r\n        }\r\n        this._layout.push(attrib);\r\n      }\r\n    }\r\n\r\n    // calc size\r\n    let componentsPerVertex = 0;\r\n    for (const vertAttribute of this._layout) {\r\n      const typeSize = getGlTypeSizeBytes(this._gl, vertAttribute.glType);\r\n      this._vertexTotalSizeBytes += typeSize * vertAttribute.size;\r\n      componentsPerVertex += vertAttribute.size;\r\n    }\r\n\r\n    if (this._vertexBuffer.bufferData.length % componentsPerVertex !== 0) {\r\n      this._logger.warn(\r\n        `The vertex component size (${componentsPerVertex})  does NOT divide evenly into the specified vertex buffer` +\r\n          ` (${this._vertexBuffer.bufferData.length})`\r\n      );\r\n    }\r\n\r\n    // create VAO\r\n    const gl = this._gl;\r\n    this._vao = gl.createVertexArray()!;\r\n    gl.bindVertexArray(this._vao);\r\n    this._vertexBuffer.bind();\r\n\r\n    let offset = 0;\r\n    for (const vert of this._layout) {\r\n      // skip unused attributes\r\n      if (vert.location !== -1) {\r\n        if (vert.glType === gl.INT) {\r\n          gl.vertexAttribIPointer(vert.location, vert.size, vert.glType, this.totalVertexSizeBytes, offset);\r\n        } else {\r\n          gl.vertexAttribPointer(vert.location, vert.size, vert.glType, vert.normalized, this.totalVertexSizeBytes, offset);\r\n        }\r\n        gl.enableVertexAttribArray(vert.location);\r\n      }\r\n      offset += getGlTypeSizeBytes(gl, vert.glType) * vert.size;\r\n    }\r\n    gl.bindVertexArray(null);\r\n    this._vertexBuffer.unbind();\r\n\r\n    this._initialized = true;\r\n  }\r\n\r\n  /**\r\n   * Bind this layout with it's associated vertex buffer\r\n   * @param uploadBuffer Optionally indicate you wish to upload the buffer to the GPU associated with this layout\r\n   */\r\n  use(uploadBuffer = false, count?: number) {\r\n    if (!this._shader) {\r\n      throw Error('No shader is associated with this vertex layout, a shader must be set');\r\n    }\r\n\r\n    const gl = this._gl;\r\n    if (!this._shader.isCurrentlyBound()) {\r\n      throw Error('Shader associated with this vertex layout is not active! Call shader.use() before layout.use()');\r\n    }\r\n    this._vertexBuffer.bind();\r\n    if (uploadBuffer) {\r\n      this._vertexBuffer.upload(count);\r\n    }\r\n    gl.bindVertexArray(this._vao);\r\n  }\r\n}\r\n","export class GraphicsDiagnostics {\n  public static DrawCallCount: number = 0;\n  public static DrawnImagesCount: number = 0;\n  public static clear(): void {\n    GraphicsDiagnostics.DrawCallCount = 0;\n    GraphicsDiagnostics.DrawnImagesCount = 0;\n  }\n}\n","import { vec, Vector } from '../../../Math/vector';\r\nimport { Color } from '../../../Color';\r\nimport lineVertexSource from './line-vertex.glsl';\r\nimport lineFragmentSource from './line-fragment.glsl';\r\nimport { ExcaliburGraphicsContextWebGL } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader, VertexBuffer, VertexLayout } from '../..';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\n\r\nexport interface LineOptions {\r\n  color?: Color;\r\n  width?: number;\r\n}\r\n\r\nexport class LineRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.line';\r\n  public priority: number = 0;\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _gl!: WebGL2RenderingContext;\r\n  private _shader!: Shader;\r\n  private _maxLines: number = 10922;\r\n  private _vertexBuffer!: VertexBuffer;\r\n  private _layout!: VertexLayout;\r\n  private _vertexIndex = 0;\r\n  private _lineCount = 0;\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: lineVertexSource,\r\n      fragmentSource: lineFragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._shader.use();\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    this._vertexBuffer = new VertexBuffer({\r\n      gl,\r\n      size: 6 * 2 * this._maxLines,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      vertexBuffer: this._vertexBuffer,\r\n      shader: this._shader,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_color', 4]\r\n      ]\r\n    });\r\n  }\r\n\r\n  public dispose() {\r\n    this._vertexBuffer.dispose();\r\n    this._shader.dispose();\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  private _startScratch = vec(0, 0);\r\n  private _endScratch = vec(0, 0);\r\n  draw(start: Vector, end: Vector, color: Color): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._lineCount++;\r\n\r\n    const transform = this._context.getTransform();\r\n    const finalStart = transform.multiply(start, this._startScratch);\r\n    const finalEnd = transform.multiply(end, this._endScratch);\r\n\r\n    const vertexBuffer = this._vertexBuffer.bufferData;\r\n    // Start\r\n    vertexBuffer[this._vertexIndex++] = finalStart.x;\r\n    vertexBuffer[this._vertexIndex++] = finalStart.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n\r\n    // End\r\n    vertexBuffer[this._vertexIndex++] = finalEnd.x;\r\n    vertexBuffer[this._vertexIndex++] = finalEnd.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._lineCount >= this._maxLines) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._lineCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._lineCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use(true);\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    gl.drawArrays(gl.LINES, 0, this._lineCount * 2); // 2 verts per line\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._lineCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // reset\r\n    this._vertexIndex = 0;\r\n    this._lineCount = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\nin vec4 a_color;\\r\\n\\r\\nout lowp vec4 v_color;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Passthrough the color\\r\\n   v_color = a_color;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// Color\\r\\nin lowp vec4 v_color;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  fragColor = v_color;\\r\\n}\";","import pointVertexSource from './point-vertex.glsl';\r\nimport pointFragmentSource from './point-fragment.glsl';\r\nimport { Vector } from '../../../Math/vector';\r\nimport { Color } from '../../../Color';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\n\r\nexport class PointRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.point';\r\n  public priority: number = 0;\r\n  private _shader!: Shader;\r\n  private _maxPoints: number = 10922;\r\n  private _buffer!: VertexBuffer;\r\n  private _layout!: VertexLayout;\r\n  private _gl!: WebGLRenderingContext;\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _pointCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: pointVertexSource,\r\n      fragmentSource: pointFragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 7 * this._maxPoints,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_color', 4],\r\n        ['a_size', 1]\r\n      ]\r\n    });\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._shader.dispose();\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  draw(point: Vector, color: Color, size: number): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._pointCount++;\r\n\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const finalPoint = transform.multiply(point);\r\n\r\n    if (snapToPixel) {\r\n      finalPoint.x = ~~(finalPoint.x + pixelSnapEpsilon);\r\n      finalPoint.y = ~~(finalPoint.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    const vertexBuffer = this._buffer.bufferData;\r\n    vertexBuffer[this._vertexIndex++] = finalPoint.x;\r\n    vertexBuffer[this._vertexIndex++] = finalPoint.y;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a * opacity;\r\n    vertexBuffer[this._vertexIndex++] = size * Math.max(transform.getScaleX(), transform.getScaleY());\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._pointCount >= this._maxPoints) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._pointCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._pointCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use(true);\r\n\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    gl.drawArrays(gl.POINTS, 0, this._pointCount);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._pointCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    this._pointCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\nin vec4 a_color;\\r\\nin float a_size;\\r\\nout lowp vec4 v_color;\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main() {\\r\\n  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n  gl_PointSize = a_size * 2.0;\\r\\n  v_color = a_color;\\r\\n}\";","export default \"#version 300 es\\r\\n\\r\\nprecision mediump float;\\r\\nin lowp vec4 v_color;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  float r = 0.0, delta = 0.0, alpha = 1.0;\\r\\n  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\\r\\n  r = dot(cxy, cxy);\\r\\n\\r\\n  delta = fwidth(r);\\r\\n  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\\r\\n  // \\\"premultiply\\\" the color by alpha\\r\\n  vec4 color = v_color;\\r\\n  color.a = color.a * alpha;\\r\\n  color.rgb = color.rgb * color.a;\\r\\n  fragColor = color;\\r\\n}\";","import screenVertex from './screen-vertex.glsl';\r\nimport screenFragment from './screen-fragment.glsl';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport { PostProcessor } from '../../PostProcessor/PostProcessor';\r\n\r\n/**\r\n * This is responsible for painting the entire screen during the render passes\r\n */\r\nexport class ScreenPassPainter {\r\n  private _gl: WebGLRenderingContext;\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  constructor(gl: WebGL2RenderingContext) {\r\n    this._gl = gl;\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: screenVertex,\r\n      fragmentSource: screenFragment\r\n    });\r\n    this._shader.compile();\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      type: 'static',\r\n      // clip space quad + uv since we don't need a camera\r\n      data: new Float32Array([\r\n        -1, -1, 0, 0, -1, 1, 0, 1, 1, -1, 1, 0,\r\n\r\n        1, -1, 1, 0, -1, 1, 0, 1, 1, 1, 1, 1\r\n      ])\r\n    });\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_texcoord', 2]\r\n      ]\r\n    });\r\n    this._buffer.upload();\r\n  }\r\n\r\n  renderWithPostProcessor(postprocessor: PostProcessor): void {\r\n    const gl = this._gl;\r\n    const shader = postprocessor.getShader();\r\n    shader.use();\r\n    postprocessor.getLayout().use();\r\n    gl.activeTexture(gl.TEXTURE0);\r\n    shader.trySetUniformInt('u_image', 0);\r\n    if (postprocessor.onDraw) {\r\n      postprocessor.onDraw();\r\n    }\r\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n  }\r\n\r\n  renderToScreen(): void {\r\n    const gl = this._gl;\r\n    this._shader.use();\r\n    this._layout.use();\r\n    gl.drawArrays(gl.TRIANGLES, 0, 6);\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\nin vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\nvoid main() {\\r\\n  gl_Position = vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n  // Pass the texcoord to the fragment shader.\\r\\n  v_texcoord = a_texcoord;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// Passed in from the vertex shader.\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// The texture.\\r\\nuniform sampler2D u_texture;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n   fragColor = texture(u_texture, v_texcoord);\\r\\n}\";","import { Logger } from '../..';\r\n\r\n/**\r\n * Helper that defines and index buffer for quad geometry\r\n *\r\n * Index buffers allow you to save space in vertex buffers when you share vertices in geometry\r\n * it is almost always worth it in terms of performance to use an index buffer.\r\n */\r\nexport class QuadIndexBuffer {\r\n  private _gl: WebGL2RenderingContext;\r\n  private _logger: Logger = Logger.getInstance();\r\n  /**\r\n   * Access to the webgl buffer handle\r\n   */\r\n  public buffer: WebGLBuffer;\r\n  /**\r\n   * Access to the raw data of the index buffer\r\n   */\r\n  public bufferData: Uint16Array | Uint32Array;\r\n  /**\r\n   * Depending on the browser this is either gl.UNSIGNED_SHORT or gl.UNSIGNED_INT\r\n   */\r\n  public bufferGlType!: number;\r\n\r\n  /**\r\n   * @param gl WebGL2RenderingContext this layout will be attached to, these cannot be reused across contexts.\r\n   * @param numberOfQuads Specify the max number of quads you want to draw\r\n   * @param useUint16 Optionally force a uint16 buffer\r\n   */\r\n  constructor(gl: WebGL2RenderingContext, numberOfQuads: number, useUint16?: boolean) {\r\n    this._gl = gl;\r\n    this.buffer = gl.createBuffer()!;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n\r\n    const totalVertices = numberOfQuads * 6;\r\n\r\n    if (!useUint16) {\r\n      this.bufferData = new Uint32Array(totalVertices);\r\n    } else {\r\n      // fall back to using gl.UNSIGNED_SHORT or tell the user they are out of luck\r\n      const maxUint16 = 65_535;\r\n      const maxUint16Index = Math.floor((maxUint16 - 1) / 4); // max quads\r\n\r\n      this.bufferGlType = gl.UNSIGNED_SHORT;\r\n      this.bufferData = new Uint16Array(totalVertices);\r\n      // TODO Should we error if this happens?? maybe not might crash mid game\r\n      if (numberOfQuads > maxUint16Index) {\r\n        this._logger.warn(\r\n          `Total quads exceeds hardware index buffer limit (uint16), max(${maxUint16Index}) requested quads(${numberOfQuads})`\r\n        );\r\n      }\r\n    }\r\n\r\n    let currentQuad = 0;\r\n    for (let i = 0; i < totalVertices; i += 6) {\r\n      // first triangle\r\n      this.bufferData[i + 0] = currentQuad + 0;\r\n      this.bufferData[i + 1] = currentQuad + 1;\r\n      this.bufferData[i + 2] = currentQuad + 2;\r\n      // second triangle\r\n      this.bufferData[i + 3] = currentQuad + 2;\r\n      this.bufferData[i + 4] = currentQuad + 1;\r\n      this.bufferData[i + 5] = currentQuad + 3;\r\n      currentQuad += 4;\r\n    }\r\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.bufferData, gl.STATIC_DRAW);\r\n  }\r\n\r\n  public get size() {\r\n    return this.bufferData.length;\r\n  }\r\n\r\n  /**\r\n   * Upload data to the GPU\r\n   */\r\n  public upload() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, this.bufferData, gl.STATIC_DRAW);\r\n  }\r\n\r\n  /**\r\n   * Bind this index buffer\r\n   */\r\n  public bind() {\r\n    const gl = this._gl;\r\n    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.buffer);\r\n  }\r\n\r\n  public dispose() {\r\n    const gl = this._gl;\r\n    gl.deleteBuffer(this.buffer);\r\n    this._gl = null as any;\r\n  }\r\n}\r\n","import { Color } from '../../../Color';\r\nimport { sign } from '../../../Math/util';\r\nimport { parseImageFiltering } from '../../Filtering';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ImageSourceAttributeConstants } from '../../ImageSource';\r\nimport { parseImageWrapping } from '../../Wrapping';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\nimport { getMaxShaderComplexity } from '../webgl-util';\r\nimport frag from './image-renderer.frag.glsl';\r\nimport vert from './image-renderer.vert.glsl';\r\n\r\nexport interface ImageRendererOptions {\r\n  pixelArtSampler: boolean;\r\n  uvPadding: number;\r\n}\r\n\r\nexport class ImageRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.image';\r\n  public priority: number = 0;\r\n\r\n  public readonly pixelArtSampler: boolean;\r\n  public readonly uvPadding: number;\r\n\r\n  private _maxImages: number = 10922; // max(uint16) / 6 verts\r\n  private _maxTextures: number = 0;\r\n\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _gl!: WebGLRenderingContext;\r\n  private _shader!: Shader;\r\n  private _buffer!: VertexBuffer;\r\n  private _layout!: VertexLayout;\r\n  private _quads!: QuadIndexBuffer;\r\n\r\n  // Per flush vars\r\n  private _imageCount: number = 0;\r\n  private _textures: WebGLTexture[] = [];\r\n  private _textureIndex = 0;\r\n  private _textureToIndex = new Map<WebGLTexture, number>();\r\n  private _images = new Set<HTMLImageSource>();\r\n  private _vertexIndex: number = 0;\r\n\r\n  constructor(options: ImageRendererOptions) {\r\n    this.pixelArtSampler = options.pixelArtSampler;\r\n    this.uvPadding = options.uvPadding;\r\n  }\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // Transform shader source\r\n    // FIXME: PIXEL 6 complains `ERROR: Expression too complex.` if we use it's reported max texture units, 125 seems to work for now...\r\n    const maxTexture = gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);\r\n    const maxComplexity = getMaxShaderComplexity(gl, maxTexture);\r\n    this._maxTextures = Math.min(maxTexture, maxComplexity);\r\n    const transformedFrag = this._transformFragmentSource(frag, this._maxTextures);\r\n    // Compile shader\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: transformedFrag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n    // Initialize texture slots to [0, 1, 2, 3, 4, .... maxGPUTextures]\r\n    this._shader.setUniformIntArray(\r\n      'u_textures',\r\n      [...Array(this._maxTextures)].map((_, i) => i)\r\n    );\r\n\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 12 * 4 * this._maxImages, // 12 components * 4 verts\r\n      type: 'dynamic'\r\n    });\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_opacity', 1],\r\n        ['a_res', 2],\r\n        ['a_texcoord', 2],\r\n        ['a_textureIndex', 1],\r\n        ['a_tint', 4]\r\n      ]\r\n    });\r\n\r\n    // Setup index buffer\r\n    this._quads = new QuadIndexBuffer(gl, this._maxImages, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._shader.dispose();\r\n    this._textures.length = 0;\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  private _transformFragmentSource(source: string, maxTextures: number): string {\r\n    let newSource = source.replace('%%count%%', maxTextures.toString());\r\n    let texturePickerBuilder = '';\r\n    for (let i = 0; i < maxTextures; i++) {\r\n      if (i === 0) {\r\n        texturePickerBuilder += `if (v_textureIndex <= ${i}.5) {\\n`;\r\n      } else {\r\n        texturePickerBuilder += `   else if (v_textureIndex <= ${i}.5) {\\n`;\r\n      }\r\n      texturePickerBuilder += `      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;\\n`;\r\n      texturePickerBuilder += `      color = texture(u_textures[${i}], uv);\\n`;\r\n      texturePickerBuilder += `   }\\n`;\r\n    }\r\n    newSource = newSource.replace('%%texture_picker%%', texturePickerBuilder);\r\n    return newSource;\r\n  }\r\n\r\n  private _addImageAsTexture(image: HTMLImageSource) {\r\n    if (this._images.has(image)) {\r\n      return;\r\n    }\r\n    const maybeFiltering = image.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : undefined;\r\n    const wrapX = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingX) as any);\r\n    const wrapY = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingY) as any);\r\n\r\n    const force = image.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._context.textureLoader.load(\r\n      image,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force\r\n    )!;\r\n    // remove force attribute after upload\r\n    image.removeAttribute('forceUpload');\r\n    if (this._textures.indexOf(texture) === -1) {\r\n      this._textures.push(texture);\r\n      this._textureToIndex.set(texture, this._textureIndex++);\r\n      this._images.add(image);\r\n    }\r\n  }\r\n\r\n  private _bindTextures(gl: WebGLRenderingContext) {\r\n    // Bind textures in the correct order\r\n    for (let i = 0; i < this._maxTextures; i++) {\r\n      gl.activeTexture(gl.TEXTURE0 + i);\r\n      gl.bindTexture(gl.TEXTURE_2D, this._textures[i] || this._textures[0]);\r\n    }\r\n  }\r\n\r\n  private _getTextureIdForImage(image: HTMLImageSource) {\r\n    if (image) {\r\n      const maybeTexture = this._context.textureLoader.get(image);\r\n      return this._textureToIndex.get(maybeTexture) ?? -1; //this._textures.indexOf(maybeTexture);\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._imageCount >= this._maxImages) {\r\n      return true;\r\n    }\r\n    if (this._textures.length >= this._maxTextures) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private _imageToWidth = new Map<HTMLImageSource, number>();\r\n  private _getImageWidth(image: HTMLImageSource) {\r\n    let maybeWidth = this._imageToWidth.get(image);\r\n    if (maybeWidth === undefined) {\r\n      maybeWidth = image.width;\r\n      this._imageToWidth.set(image, maybeWidth);\r\n    }\r\n    return maybeWidth;\r\n  }\r\n\r\n  private _imageToHeight = new Map<HTMLImageSource, number>();\r\n  private _getImageHeight(image: HTMLImageSource) {\r\n    let maybeHeight = this._imageToHeight.get(image);\r\n    if (maybeHeight === undefined) {\r\n      maybeHeight = image.height;\r\n      this._imageToHeight.set(image, maybeHeight);\r\n    }\r\n    return maybeHeight;\r\n  }\r\n\r\n  private _view = [0, 0, 0, 0];\r\n  private _dest = [0, 0];\r\n  private _quad = [0, 0, 0, 0, 0, 0, 0, 0];\r\n  private _defaultTint = Color.White;\r\n  draw(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._imageCount++;\r\n    // This creates and uploads the texture if not already done\r\n    this._addImageAsTexture(image);\r\n    const maybeImageWidth = this._getImageWidth(image);\r\n    const maybeImageHeight = this._getImageHeight(image);\r\n\r\n    let width = maybeImageWidth || swidth || 0;\r\n    let height = maybeImageHeight || sheight || 0;\r\n    this._view[0] = 0;\r\n    this._view[1] = 0;\r\n    this._view[2] = swidth ?? maybeImageWidth ?? 0;\r\n    this._view[3] = sheight ?? maybeImageHeight ?? 0;\r\n    this._dest[0] = sx ?? 1;\r\n    this._dest[1] = sy ?? 1;\r\n    // If destination is specified, update view and dest\r\n    if (dx !== undefined && dy !== undefined && dwidth !== undefined && dheight !== undefined) {\r\n      this._view[0] = sx ?? 1;\r\n      this._view[1] = sy ?? 1;\r\n      this._view[2] = swidth ?? maybeImageWidth ?? 0;\r\n      this._view[3] = sheight ?? maybeImageHeight ?? 0;\r\n      this._dest[0] = dx;\r\n      this._dest[1] = dy;\r\n      width = dwidth;\r\n      height = dheight;\r\n    }\r\n\r\n    sx = this._view[0];\r\n    sy = this._view[1];\r\n    const sw = this._view[2];\r\n    const sh = this._view[3];\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    // top left\r\n    this._quad[0] = this._dest[0];\r\n    this._quad[1] = this._dest[1];\r\n\r\n    // top right\r\n    this._quad[2] = this._dest[0] + width;\r\n    this._quad[3] = this._dest[1];\r\n\r\n    // bottom left\r\n    this._quad[4] = this._dest[0];\r\n    this._quad[5] = this._dest[1] + height;\r\n\r\n    // bottom right\r\n    this._quad[6] = this._dest[0] + width;\r\n    this._quad[7] = this._dest[1] + height;\r\n\r\n    transform.multiplyQuadInPlace(this._quad);\r\n\r\n    if (snapToPixel) {\r\n      this._quad[0] = ~~(this._quad[0] + sign(this._quad[0]) * pixelSnapEpsilon);\r\n      this._quad[1] = ~~(this._quad[1] + sign(this._quad[1]) * pixelSnapEpsilon);\r\n\r\n      this._quad[2] = ~~(this._quad[2] + sign(this._quad[2]) * pixelSnapEpsilon);\r\n      this._quad[3] = ~~(this._quad[3] + sign(this._quad[3]) * pixelSnapEpsilon);\r\n\r\n      this._quad[4] = ~~(this._quad[4] + sign(this._quad[4]) * pixelSnapEpsilon);\r\n      this._quad[5] = ~~(this._quad[5] + sign(this._quad[5]) * pixelSnapEpsilon);\r\n\r\n      this._quad[6] = ~~(this._quad[6] + sign(this._quad[6]) * pixelSnapEpsilon);\r\n      this._quad[7] = ~~(this._quad[7] + sign(this._quad[7]) * pixelSnapEpsilon);\r\n    }\r\n\r\n    const tint = this._context.tint || this._defaultTint;\r\n\r\n    const textureId = this._getTextureIdForImage(image);\r\n    const imageWidth = maybeImageWidth || width;\r\n    const imageHeight = maybeImageHeight || height;\r\n\r\n    const uvx0 = (sx + this.uvPadding) / imageWidth;\r\n    const uvy0 = (sy + this.uvPadding) / imageHeight;\r\n    const uvx1 = (sx + sw - this.uvPadding) / imageWidth;\r\n    const uvy1 = (sy + sh - this.uvPadding) / imageHeight;\r\n\r\n    const txWidth = maybeImageWidth;\r\n    const txHeight = maybeImageHeight;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = this._quad[0];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[1];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = this._quad[4];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[5];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = this._quad[2];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[3];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = this._quad[6];\r\n    vertexBuffer[this._vertexIndex++] = this._quad[7];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._imageCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._imageCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true, 4 * 12 * this._imageCount); // 4 verts * 12 components\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Turn on pixel art aa sampler\r\n    this._shader.setUniformBoolean('u_pixelart', this.pixelArtSampler);\r\n\r\n    // Bind textures to\r\n    this._bindTextures(gl);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._imageCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._imageCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._imageCount = 0;\r\n    this._vertexIndex = 0;\r\n    this._textures.length = 0;\r\n    this._textureIndex = 0;\r\n    this._textureToIndex.clear();\r\n    this._images.clear();\r\n    this._imageToWidth.clear();\r\n    this._imageToHeight.clear();\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// Texture index\\r\\nin lowp float v_textureIndex;\\r\\n\\r\\n// Textures in the current draw\\r\\nuniform sampler2D u_textures[%%count%%];\\r\\n\\r\\nuniform bool u_pixelart;\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nin vec4 v_tint;\\r\\n\\r\\nin vec2 v_res;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\n// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\\r\\nvec2 uv_iq(in vec2 uv, in vec2 texture_size) {\\r\\n  vec2 pixel = uv * texture_size;\\r\\n  \\r\\n  vec2 seam=floor(pixel+.5);\\r\\n  vec2 dudv=fwidth(pixel);\\r\\n  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\\r\\n  \\r\\n  return pixel/texture_size;\\r\\n}\\r\\n\\r\\nvoid main(){\\r\\n  // In order to support the most efficient sprite batching, we have multiple\\r\\n  // textures loaded into the gpu (usually 8) this picker logic skips over textures\\r\\n  // that do not apply to a particular sprite.\\r\\n  \\r\\n  vec4 color=vec4(1.,0,0,1.);\\r\\n  \\r\\n  // GLSL is templated out to pick the right texture and set the vec4 color\\r\\n  %%texture_picker%%\\r\\n  \\r\\n  color.rgb=color.rgb*v_opacity;\\r\\n  color.a=color.a*v_opacity;\\r\\n  fragColor=color*v_tint;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// Opacity\\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\n// Texture res\\r\\nin vec2 a_res;\\r\\nout vec2 v_res;\\r\\n\\r\\n// Texture number\\r\\nin lowp float a_textureIndex;\\r\\nout lowp float v_textureIndex;\\r\\n\\r\\nin vec4 a_tint;\\r\\nout vec4 v_tint;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main(){\\r\\n  // Set the vertex position using the ortho transform matrix\\r\\n  gl_Position=u_matrix*vec4(a_position,0.,1.);\\r\\n  \\r\\n  // Pass through the Opacity to the fragment shader\\r\\n  v_opacity=a_opacity;\\r\\n  // Pass through the UV coord to the fragment shader\\r\\n  v_texcoord=a_texcoord;\\r\\n\\r\\n  v_res = a_res;\\r\\n\\r\\n  // Pass through the texture number to the fragment shader\\r\\n  v_textureIndex=a_textureIndex;\\r\\n  // Pass through the tint\\r\\n  v_tint=a_tint;\\r\\n}\";","import { Color } from '../../../Color';\r\nimport { vec, Vector } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nimport frag from './rectangle-renderer.frag.glsl';\r\nimport vert from './rectangle-renderer.vert.glsl';\r\n\r\nexport class RectangleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.rectangle';\r\n  public priority: number = 0;\r\n\r\n  private _maxRectangles: number = 10922; // max(uint16) / 6 verts\r\n\r\n  private _shader!: Shader;\r\n  private _gl!: WebGLRenderingContext;\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _buffer!: VertexBuffer;\r\n  private _layout!: VertexLayout;\r\n  private _quads!: QuadIndexBuffer;\r\n  private _rectangleCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: frag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 16 * 4 * this._maxRectangles,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_size', 2],\r\n        ['a_opacity', 1],\r\n        ['a_color', 4],\r\n        ['a_strokeColor', 4],\r\n        ['a_strokeThickness', 1]\r\n      ]\r\n    });\r\n    this._quads = new QuadIndexBuffer(gl, this._maxRectangles, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._shader.dispose();\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._rectangleCount >= this._maxRectangles) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  draw(...args: any[]): void {\r\n    if (args[0] instanceof Vector && args[1] instanceof Vector) {\r\n      this.drawLine.apply(this, args as any);\r\n    } else {\r\n      this.drawRectangle.apply(this, args as any);\r\n    }\r\n  }\r\n\r\n  private _transparent = Color.Transparent;\r\n  private _scratch1 = vec(0, 0);\r\n  private _scratch2 = vec(0, 0);\r\n  private _scratch3 = vec(0, 0);\r\n  private _scratch4 = vec(0, 0);\r\n  drawLine(start: Vector, end: Vector, color: Color, thickness: number = 1) {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._rectangleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const dir = end.sub(start);\r\n    const length = dir.magnitude;\r\n    const normal = dir.normalize().perpendicular();\r\n    const halfThick = thickness / 2;\r\n\r\n    /**\r\n     *    +---------------------^----------------------+\r\n     *    |                     | (normal)             |\r\n     *   (startX, startY)------------------>(endX, endY)\r\n     *    |                                            |\r\n     *    + -------------------------------------------+\r\n     */\r\n    const startTop = transform.multiply(normal.scale(halfThick, this._scratch1).add(start, this._scratch1), this._scratch1);\r\n    const startBottom = transform.multiply(normal.scale(-halfThick, this._scratch2).add(start, this._scratch2), this._scratch2);\r\n    const endTop = transform.multiply(normal.scale(halfThick, this._scratch3).add(end, this._scratch3), this._scratch3);\r\n    const endBottom = transform.multiply(normal.scale(-halfThick, this._scratch4).add(end, this._scratch4), this._scratch4);\r\n\r\n    if (snapToPixel) {\r\n      startTop.x = ~~(startTop.x + pixelSnapEpsilon);\r\n      startTop.y = ~~(startTop.y + pixelSnapEpsilon);\r\n\r\n      endTop.x = ~~(endTop.x + pixelSnapEpsilon);\r\n      endTop.y = ~~(endTop.y + pixelSnapEpsilon);\r\n\r\n      startBottom.x = ~~(startBottom.x + pixelSnapEpsilon);\r\n      startBottom.y = ~~(startBottom.y + pixelSnapEpsilon);\r\n\r\n      endBottom.x = ~~(endBottom.x + pixelSnapEpsilon);\r\n      endBottom.y = ~~(endBottom.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO uv could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    const stroke = this._transparent;\r\n    const strokeThickness = 0;\r\n    const width = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = startTop.x;\r\n    vertexBuffer[this._vertexIndex++] = startTop.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = startBottom.x;\r\n    vertexBuffer[this._vertexIndex++] = startBottom.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = endTop.x;\r\n    vertexBuffer[this._vertexIndex++] = endTop.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = endBottom.x;\r\n    vertexBuffer[this._vertexIndex++] = endBottom.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = length;\r\n    vertexBuffer[this._vertexIndex++] = thickness;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / width;\r\n  }\r\n\r\n  drawRectangle(\r\n    pos: Vector,\r\n    width: number,\r\n    height: number,\r\n    color: Color,\r\n    stroke: Color = Color.Transparent,\r\n    strokeThickness: number = 0\r\n  ): void {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._rectangleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const topLeft = transform.multiply(pos.add(vec(0, 0)));\r\n    const topRight = transform.multiply(pos.add(vec(width, 0)));\r\n    const bottomRight = transform.multiply(pos.add(vec(width, height)));\r\n    const bottomLeft = transform.multiply(pos.add(vec(0, height)));\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO uv could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._rectangleCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._rectangleCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._rectangleCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._rectangleCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._rectangleCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\n\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_uv;\\r\\n\\r\\nin vec2 v_size; // in pixels\\r\\n\\r\\n// Color coord to blend with image\\r\\nin lowp vec4 v_color;\\r\\n\\r\\n// Stroke color if used\\r\\nin lowp vec4 v_strokeColor;\\r\\n\\r\\n// Stroke thickness if used\\r\\nin lowp float v_strokeThickness; // in pixels\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\\r\\n    vec2 uv = v_uv;\\r\\n    vec2 fragCoord = uv * v_size;\\r\\n    float maxX = v_size.x - v_strokeThickness;\\r\\n    float minX = v_strokeThickness;\\r\\n    float maxY = v_size.y - v_strokeThickness;\\r\\n    float minY = v_strokeThickness;\\r\\n\\r\\n    if (fragCoord.x < maxX && fragCoord.x > minX &&\\r\\n        fragCoord.y < maxY && fragCoord.y > minY) {\\r\\n      fragColor = v_color;\\r\\n    } else {\\r\\n      fragColor = v_strokeColor;\\r\\n    }\\r\\n    fragColor.a *= v_opacity;\\r\\n    fragColor.rgb *= fragColor.a;\\r\\n\\r\\n    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\\r\\n    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\\r\\n\\r\\n    // float fHalfBorderDist      = 0.0;\\r\\n    // float fHalfBorderThickness = 0.0;\\r\\n\\r\\n    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \\r\\n    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\\r\\n    // {\\r\\n    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\\r\\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\\r\\n    // }\\r\\n    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \\r\\n    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\\r\\n    // {\\r\\n    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\\r\\n    //     fHalfBorderThickness = v_strokeThickness / 2.0;\\r\\n    // }\\r\\n    // else\\r\\n    // {\\r\\n    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\\r\\n    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\\r\\n    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\\r\\n        \\r\\n    //     float ellipse_ab    = v_radius-v_strokeThickness;\\r\\n    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\\r\\n    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \\r\\n            \\r\\n    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\\r\\n    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\\r\\n    // }\\r\\n\\r\\n    // vec4 v4FromColor = v_strokeColor;\\r\\n    // v4FromColor.rgb *= v4FromColor.a;\\r\\n    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\\r\\n    // if (fHalfBorderDist < 0.0) {\\r\\n    //     v4ToColor = v_color;\\r\\n    //     v4ToColor.rgb *= v4ToColor.a;\\r\\n    // }\\r\\n\\r\\n    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\\r\\n\\r\\n    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\\r\\n    // gl_FragColor = finalColor;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_uv;\\r\\nout vec2 v_uv;\\r\\n\\r\\nin vec2 a_size;\\r\\nout vec2 v_size;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\nin vec4 a_color;\\r\\nout vec4 v_color;\\r\\n\\r\\nin vec4 a_strokeColor;\\r\\nout vec4 v_strokeColor;\\r\\n\\r\\nin float a_strokeThickness;\\r\\nout float v_strokeThickness;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through UV coords\\r\\n   v_uv = a_uv;\\r\\n   // Pass through size\\r\\n   v_size = a_size;\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the color to the fragment shader\\r\\n   v_color = a_color;\\r\\n   // Pass through the stroke color to the fragment shader\\r\\n   v_strokeColor = a_strokeColor;\\r\\n   // Pass through the stroke thickenss to the fragment shader\\r\\n   v_strokeThickness = a_strokeThickness;\\r\\n}\";","import { Color } from '../../../Color';\r\nimport { vec, Vector } from '../../../Math/vector';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nimport frag from './circle-renderer.frag.glsl';\r\nimport vert from './circle-renderer.vert.glsl';\r\n\r\nexport class CircleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.circle';\r\n  public priority: number = 0;\r\n\r\n  private _maxCircles: number = 10922; // max(uint16) / 6 verts\r\n\r\n  private _shader!: Shader;\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _gl!: WebGLRenderingContext;\r\n  private _buffer!: VertexBuffer;\r\n  private _layout!: VertexLayout;\r\n  private _quads!: QuadIndexBuffer;\r\n\r\n  private _circleCount: number = 0;\r\n  private _vertexIndex: number = 0;\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: frag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 14 * 4 * this._maxCircles,\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_opacity', 1],\r\n        ['a_color', 4],\r\n        ['a_strokeColor', 4],\r\n        ['a_strokeThickness', 1]\r\n      ]\r\n    });\r\n\r\n    this._quads = new QuadIndexBuffer(gl, this._maxCircles, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._shader.dispose();\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._circleCount >= this._maxCircles) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  draw(pos: Vector, radius: number, color: Color, stroke: Color = Color.Transparent, strokeThickness: number = 0): void {\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n    this._circleCount++;\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n\r\n    const topLeft = transform.multiply(pos.add(vec(-radius, -radius)));\r\n    const topRight = transform.multiply(pos.add(vec(radius, -radius)));\r\n    const bottomRight = transform.multiply(pos.add(vec(radius, radius)));\r\n    const bottomLeft = transform.multiply(pos.add(vec(-radius, radius)));\r\n\r\n    if (snapToPixel) {\r\n      topLeft.x = ~~(topLeft.x + pixelSnapEpsilon);\r\n      topLeft.y = ~~(topLeft.y + pixelSnapEpsilon);\r\n\r\n      topRight.x = ~~(topRight.x + pixelSnapEpsilon);\r\n      topRight.y = ~~(topRight.y + pixelSnapEpsilon);\r\n\r\n      bottomLeft.x = ~~(bottomLeft.x + pixelSnapEpsilon);\r\n      bottomLeft.y = ~~(bottomLeft.y + pixelSnapEpsilon);\r\n\r\n      bottomRight.x = ~~(bottomRight.x + pixelSnapEpsilon);\r\n      bottomRight.y = ~~(bottomRight.y + pixelSnapEpsilon);\r\n    }\r\n\r\n    // TODO UV could be static vertex buffer\r\n    const uvx0 = 0;\r\n    const uvy0 = 0;\r\n    const uvx1 = 1;\r\n    const uvy1 = 1;\r\n\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[this._vertexIndex++] = topLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = topLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[this._vertexIndex++] = topRight.x;\r\n    vertexBuffer[this._vertexIndex++] = topRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[this._vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = color.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = color.a;\r\n    vertexBuffer[this._vertexIndex++] = stroke.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = stroke.a;\r\n    vertexBuffer[this._vertexIndex++] = strokeThickness / radius;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._circleCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._circleCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._layout.use(true);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Bind index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw all the quads\r\n    gl.drawElements(gl.TRIANGLES, this._circleCount * 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._circleCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    // Reset\r\n    this._circleCount = 0;\r\n    this._vertexIndex = 0;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision highp float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_uv;\\r\\n\\r\\n// Color coord to blend with image\\r\\nin lowp vec4 v_color;\\r\\n\\r\\n// Stroke color if used\\r\\nin lowp vec4 v_strokeColor;\\r\\n\\r\\n// Stroke thickness if used\\r\\nin lowp float v_strokeThickness;\\r\\n\\r\\n// Opacity\\r\\nin float v_opacity;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  // make (0, 0) the center the uv \\r\\n  vec2 uv = v_uv * 2.0 - 1.0;\\r\\n\\r\\n  vec4 color = v_color;\\r\\n  vec4 strokeColor = v_strokeColor;\\r\\n\\r\\n  // circle border is at radius 1.0 \\r\\n  // dist is > 0 when inside the circle \\r\\n  float d = length(uv);\\r\\n  float dist = 1.0 - length(uv);\\r\\n\\r\\n  // Fade based on fwidth\\r\\n  float fade = fwidth(dot(uv, uv));\\r\\n\\r\\n  // if dist is greater than 0 step to 1;\\r\\n  // when we cross this 0 threshold add a smooth fade\\r\\n  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\\r\\n\\r\\n  // if dist is greater than the stroke thickness step to 1\\r\\n  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\\r\\n\\r\\n  strokeColor.a *= fill * stroke;\\r\\n  strokeColor.rgb *= strokeColor.a;\\r\\n\\r\\n  color.a *= fill * (1.0 - stroke);\\r\\n  color.rgb *= color.a;\\r\\n\\r\\n  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\\r\\n  finalColor.rgb = finalColor.rgb * v_opacity;\\r\\n  finalColor.a = finalColor.a * v_opacity;\\r\\n  fragColor = finalColor;\\r\\n}\";","export default \"#version 300 es\\r\\nin vec2 a_position;\\r\\n\\r\\n// UV coordinate\\r\\nin vec2 a_uv;\\r\\nout vec2 v_uv;\\r\\n\\r\\n// Opacity \\r\\nin float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\nin vec4 a_color;\\r\\nout vec4 v_color;\\r\\n\\r\\nin vec4 a_strokeColor;\\r\\nout vec4 v_strokeColor;\\r\\n\\r\\nin float a_strokeThickness;\\r\\nout float v_strokeThickness;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\n\\r\\nvoid main() {\\r\\n   // Set the vertex position using the ortho transform matrix\\r\\n   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\\r\\n\\r\\n   // Pass through UV coords\\r\\n   v_uv = a_uv;\\r\\n   // Pass through the Opacity to the fragment shader\\r\\n   v_opacity = a_opacity;\\r\\n   // Pass through the color to the fragment shader\\r\\n   v_color = a_color;\\r\\n   // Pass through the stroke color to the fragment shader\\r\\n   v_strokeColor = a_strokeColor;\\r\\n   // Pass through the stroke thickenss to the fragment shader\\r\\n   v_strokeThickness = a_strokeThickness;\\r\\n}\";","import { Logger } from '../Util/Log';\r\nexport class Pool<Type> {\r\n  public totalAllocations = 0;\r\n  public index = 0;\r\n  public objects: Type[] = [];\r\n  public disableWarnings = false;\r\n  private _logger = Logger.getInstance();\r\n\r\n  constructor(\r\n    public builder: () => Type,\r\n    public recycler?: (instance: Type) => Type,\r\n    public maxObjects: number = 100\r\n  ) {}\r\n\r\n  dispose() {\r\n    this.objects.length = 0;\r\n  }\r\n\r\n  preallocate() {\r\n    for (let i = 0; i < this.maxObjects; i++) {\r\n      this.objects[i] = this.builder();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Use many instances out of the in the context and return all to the pool.\r\n   *\r\n   * By returning values out of the context they will be un-hooked from the pool and are free to be passed to consumers\r\n   * @param context\r\n   */\r\n  using(context: (pool: Pool<Type>) => Type[] | void) {\r\n    const result = context(this);\r\n    if (result) {\r\n      return this.done(...result);\r\n    }\r\n    return this.done();\r\n  }\r\n\r\n  /**\r\n   * Use a single instance out of th pool and immediately return it to the pool\r\n   * @param context\r\n   */\r\n  borrow(context: (object: Type) => void) {\r\n    const object = this.get();\r\n    context(object);\r\n    this.index--;\r\n  }\r\n\r\n  /**\r\n   * Retrieve a value from the pool, will allocate a new instance if necessary or recycle from the pool\r\n   */\r\n  get(): Type {\r\n    if (this.index === this.maxObjects) {\r\n      if (!this.disableWarnings) {\r\n        this._logger.warn('Max pooled objects reached, possible memory leak? Doubling');\r\n      }\r\n      this.maxObjects = this.maxObjects * 2;\r\n    }\r\n\r\n    if (this.objects[this.index]) {\r\n      // Pool has an available object already constructed\r\n      if (this.recycler) {\r\n        return this.recycler(this.objects[this.index++]);\r\n      }\r\n      return this.objects[this.index++];\r\n    } else {\r\n      // New allocation\r\n      this.totalAllocations++;\r\n      const object = (this.objects[this.index++] = this.builder());\r\n      return object;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Signals we are done with the pool objects for now, Reclaims all objects in the pool.\r\n   *\r\n   * If a list of pooled objects is passed to done they are un-hooked from the pool and are free\r\n   * to be passed to consumers\r\n   * @param objects A list of object to separate from the pool\r\n   */\r\n  done(...objects: Type[]): Type[];\r\n  done(): void;\r\n  done(...objects: Type[]): Type[] | void {\r\n    // All objects in pool now considered \"free\"\r\n    this.index = 0;\r\n    for (const object of objects) {\r\n      const poolIndex = this.objects.indexOf(object);\r\n      // Build a new object to take the pool place\r\n      this.objects[poolIndex] = (this as any).builder();\r\n      this.totalAllocations++;\r\n    }\r\n    return objects;\r\n  }\r\n}\r\n","import { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContextState } from './ExcaliburGraphicsContext';\r\n\r\nexport class DrawCall {\r\n  public z: number = 0;\r\n  public priority: number = 0;\r\n  public renderer: string = '';\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public state: ExcaliburGraphicsContextState = {\r\n    z: 0,\r\n    opacity: 1,\r\n    tint: Color.White,\r\n    material: null\r\n  };\r\n  public args: any[] = new Array(10);\r\n}\r\n","import { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from './ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL } from './ExcaliburGraphicsContextWebGL';\r\nimport { Shader } from './shader';\r\nimport { Logger } from '../../Util/Log';\r\nimport { ImageSource, ImageSourceAttributeConstants } from '../ImageSource';\r\nimport { ImageFiltering, parseImageFiltering } from '../Filtering';\r\nimport { parseImageWrapping } from '../Wrapping';\r\n\r\nexport interface MaterialOptions {\r\n  /**\r\n   * Name the material for debugging\r\n   */\r\n  name?: string;\r\n\r\n  /**\r\n   * Excalibur graphics context to create the material (only WebGL is supported at the moment)\r\n   */\r\n  graphicsContext?: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Optionally specify a vertex shader\r\n   *\r\n   * If none supplied the default will be used\r\n   *\r\n   * ```\r\n   *  #version 300 es\r\n   *  // vertex position in local space\r\n   *  in vec2 a_position;\r\n   *  in vec2 a_uv;\r\n   *  out vec2 v_uv;\r\n   *  // orthographic projection matrix\r\n   *  uniform mat4 u_matrix;\r\n   *  // world space transform matrix\r\n   *  uniform mat4 u_transform;\r\n   *  void main() {\r\n   *    // Set the vertex position using the ortho & transform matrix\r\n   *    gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);\r\n   *    // Pass through the UV coord to the fragment shader\r\n   *    v_uv = a_uv;\r\n   *  }\r\n   * ```\r\n   */\r\n  vertexSource?: string;\r\n\r\n  /**\r\n   * Add custom fragment shader\r\n   *\r\n   * *Note: Excalibur image alpha's are pre-multiplied\r\n   *\r\n   * Pre-built varyings:\r\n   *\r\n   * * `in vec2 v_uv` - UV coordinate\r\n   * * `in vec2 v_screenuv` - UV coordinate\r\n   *\r\n   * Pre-built uniforms:\r\n   *\r\n   * * `uniform sampler2D u_graphic` - The current graphic displayed by the GraphicsComponent\r\n   * * `uniform vec2 u_resolution` - The current resolution of the screen\r\n   * * `uniform vec2 u_size;` - The current size of the graphic\r\n   * * `uniform vec4 u_color` - The current color of the material\r\n   * * `uniform float u_opacity` - The current opacity of the graphics context\r\n   *\r\n   */\r\n  fragmentSource: string;\r\n\r\n  /**\r\n   * Add custom color, by default ex.Color.Transparent\r\n   */\r\n  color?: Color;\r\n\r\n  /**\r\n   * Add additional images to the material, you are limited by the GPU's maximum texture slots\r\n   *\r\n   * Specify a dictionary of uniform sampler names to ImageSource\r\n   */\r\n  images?: Record<string, ImageSource>;\r\n}\r\n\r\nconst defaultVertexSource = `#version 300 es\r\nin vec2 a_position;\r\n\r\nin vec2 a_uv;\r\nout vec2 v_uv;\r\n\r\nin vec2 a_screenuv;\r\nout vec2 v_screenuv;\r\n\r\nuniform mat4 u_matrix;\r\nuniform mat4 u_transform;\r\n\r\nvoid main() {\r\n  // Set the vertex position using the ortho & transform matrix\r\n  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);\r\n\r\n  // Pass through the UV coord to the fragment shader\r\n  v_uv = a_uv;\r\n  v_screenuv = a_screenuv;\r\n}\r\n`;\r\n\r\nexport interface MaterialImageOptions {\r\n  filtering?: ImageFiltering;\r\n}\r\n\r\nexport class Material {\r\n  private _logger = Logger.getInstance();\r\n  private _name: string;\r\n  private _shader!: Shader;\r\n  private _color: Color = Color.Transparent;\r\n  private _initialized = false;\r\n  private _fragmentSource: string;\r\n  private _vertexSource: string;\r\n\r\n  private _images = new Map<string, ImageSource>();\r\n  private _textures = new Map<ImageSource, WebGLTexture>();\r\n  private _maxTextureSlots!: number;\r\n  private _graphicsContext!: ExcaliburGraphicsContextWebGL;\r\n\r\n  constructor(options: MaterialOptions) {\r\n    const { color, name, vertexSource, fragmentSource, graphicsContext, images } = options;\r\n    this._name = name ?? 'anonymous material';\r\n    this._vertexSource = vertexSource ?? defaultVertexSource;\r\n    this._fragmentSource = fragmentSource;\r\n    this._color = color ?? this._color;\r\n    if (!graphicsContext) {\r\n      throw Error(`Material ${name} must be provided an excalibur webgl graphics context`);\r\n    }\r\n    if (graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      this._graphicsContext = graphicsContext;\r\n      this._initialize(graphicsContext);\r\n    } else {\r\n      this._logger.warn(`Material ${name} was created in 2D Canvas mode, currently only WebGL is supported`);\r\n    }\r\n\r\n    if (images) {\r\n      for (const key in images) {\r\n        this.addImageSource(key, images[key]);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _initialize(graphicsContextWebGL: ExcaliburGraphicsContextWebGL) {\r\n    if (this._initialized) {\r\n      return;\r\n    }\r\n    const gl = graphicsContextWebGL.__gl;\r\n    // max texture slots - 2 for the graphic texture and screen texture\r\n    this._maxTextureSlots = gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS) - 2;\r\n    this._shader = graphicsContextWebGL.createShader({\r\n      vertexSource: this._vertexSource,\r\n      fragmentSource: this._fragmentSource\r\n    });\r\n    this._shader.compile();\r\n    this._initialized = true;\r\n  }\r\n\r\n  get color(): Color {\r\n    return this._color;\r\n  }\r\n\r\n  set color(c: Color) {\r\n    this._color = c;\r\n  }\r\n\r\n  get name() {\r\n    return this._name ?? 'anonymous material';\r\n  }\r\n\r\n  get isUsingScreenTexture() {\r\n    return this._fragmentSource.includes('u_screen_texture');\r\n  }\r\n\r\n  update(callback: (shader: Shader) => any) {\r\n    if (this._shader) {\r\n      this._shader.use();\r\n      callback(this._shader);\r\n    }\r\n  }\r\n\r\n  getShader(): Shader | null {\r\n    return this._shader;\r\n  }\r\n\r\n  addImageSource(textureUniformName: string, image: ImageSource) {\r\n    if (this._images.size < this._maxTextureSlots) {\r\n      this._images.set(textureUniformName, image);\r\n    } else {\r\n      this._logger.warn(\r\n        `Max number texture slots ${this._maxTextureSlots} have been reached for material \"${this.name}\", ` +\r\n          `no more textures will be uploaded due to hardware constraints.`\r\n      );\r\n    }\r\n  }\r\n\r\n  removeImageSource(textureName: string) {\r\n    const image = this._images.get(textureName);\r\n    this._graphicsContext.textureLoader.delete(image!.image);\r\n    this._images.delete(textureName);\r\n  }\r\n\r\n  private _loadImageSource(image: ImageSource) {\r\n    const imageElement = image.image;\r\n    const maybeFiltering = imageElement.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : undefined;\r\n    const wrapX = parseImageWrapping(imageElement.getAttribute(ImageSourceAttributeConstants.WrappingX) as any);\r\n    const wrapY = parseImageWrapping(imageElement.getAttribute(ImageSourceAttributeConstants.WrappingY) as any);\r\n\r\n    const force = imageElement.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._graphicsContext.textureLoader.load(\r\n      imageElement,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force\r\n    );\r\n    // remove force attribute after upload\r\n    imageElement.removeAttribute('forceUpload');\r\n    if (!this._textures.has(image)) {\r\n      this._textures.set(image, texture!);\r\n    }\r\n\r\n    return texture;\r\n  }\r\n\r\n  uploadAndBind(gl: WebGL2RenderingContext, startingTextureSlot: number = 2) {\r\n    let textureSlot = startingTextureSlot;\r\n    for (const [textureName, image] of this._images.entries()) {\r\n      if (!image.isLoaded()) {\r\n        this._logger.warnOnce(\r\n          `Image named ${textureName} in material ${this.name} not loaded, nothing will be uploaded to the shader.` +\r\n            ` Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`\r\n        );\r\n        continue;\r\n      } // skip unloaded images, maybe warn\r\n      const texture = this._loadImageSource(image);\r\n\r\n      gl.activeTexture(gl.TEXTURE0 + textureSlot);\r\n      gl.bindTexture(gl.TEXTURE_2D, texture);\r\n      this._shader.trySetUniformInt(textureName, textureSlot);\r\n\r\n      textureSlot++;\r\n    }\r\n  }\r\n\r\n  use() {\r\n    if (this._initialized) {\r\n      // bind the shader\r\n      this._shader.use();\r\n      // Apply standard uniforms\r\n      this._shader.trySetUniformFloatColor('u_color', this._color);\r\n    } else {\r\n      throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`);\r\n    }\r\n  }\r\n}\r\n","import { vec } from '../../../Math/vector';\r\nimport { parseImageFiltering } from '../../Filtering';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ImageSourceAttributeConstants } from '../../ImageSource';\r\nimport { parseImageWrapping } from '../../Wrapping';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL } from '../ExcaliburGraphicsContextWebGL';\r\nimport { QuadIndexBuffer } from '../quad-index-buffer';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { VertexLayout } from '../vertex-layout';\r\n\r\nexport class MaterialRenderer implements RendererPlugin {\r\n  public readonly type: string = 'ex.material';\r\n  public priority: number = 0;\r\n  // private _maxTextures = 8;\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _gl!: WebGL2RenderingContext;\r\n  private _textures: WebGLTexture[] = [];\r\n  private _quads: any;\r\n  private _buffer!: VertexBuffer;\r\n  private _layout!: VertexLayout;\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      size: 6 * 4, // 6 components * 4 verts\r\n      type: 'dynamic'\r\n    });\r\n\r\n    // Setup a vertex layout/buffer to the material\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2],\r\n        ['a_screenuv', 2]\r\n      ],\r\n      suppressWarnings: true\r\n    });\r\n\r\n    // Setup index buffer\r\n    this._quads = new QuadIndexBuffer(gl, 1, true);\r\n  }\r\n\r\n  public dispose() {\r\n    this._buffer.dispose();\r\n    this._quads.dispose();\r\n    this._textures.length = 0;\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  draw(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    const gl = this._gl;\r\n\r\n    // Extract context info\r\n    const material = this._context.material;\r\n    if (!material) {\r\n      return;\r\n    }\r\n\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n\r\n    // material shader\r\n    const shader = material.getShader()!;\r\n\r\n    // construct geometry, or hold on to it in the material?\r\n    // geometry primitive for drawing rectangles?\r\n    // update data\r\n    const vertexBuffer = this._layout.vertexBuffer.bufferData;\r\n    let vertexIndex = 0;\r\n\r\n    let width = image?.width || swidth || 0;\r\n    let height = image?.height || sheight || 0;\r\n    let view = [0, 0, swidth ?? image?.width ?? 0, sheight ?? image?.height ?? 0];\r\n    let dest = [sx ?? 1, sy ?? 1];\r\n    // If destination is specified, update view and dest\r\n    if (dx !== undefined && dy !== undefined && dwidth !== undefined && dheight !== undefined) {\r\n      view = [sx ?? 1, sy ?? 1, swidth ?? image?.width ?? 0, sheight ?? image?.height ?? 0];\r\n      dest = [dx, dy];\r\n      width = dwidth;\r\n      height = dheight;\r\n    }\r\n\r\n    sx = view[0];\r\n    sy = view[1];\r\n    const sw = view[2];\r\n    const sh = view[3];\r\n\r\n    const topLeft = vec(dest[0], dest[1]);\r\n    const topRight = vec(dest[0] + width, dest[1]);\r\n    const bottomLeft = vec(dest[0], dest[1] + height);\r\n    const bottomRight = vec(dest[0] + width, dest[1] + height);\r\n\r\n    const imageWidth = image.width || width;\r\n    const imageHeight = image.height || height;\r\n\r\n    const uvx0 = sx / imageWidth;\r\n    const uvy0 = sy / imageHeight;\r\n    const uvx1 = (sx + sw - 0.01) / imageWidth;\r\n    const uvy1 = (sy + sh - 0.01) / imageHeight;\r\n\r\n    const topLeftScreen = transform.getPosition();\r\n    const bottomRightScreen = topLeftScreen.add(bottomRight);\r\n    const screenUVX0 = topLeftScreen.x / this._context.width;\r\n    const screenUVY0 = topLeftScreen.y / this._context.height;\r\n    const screenUVX1 = bottomRightScreen.x / this._context.width;\r\n    const screenUVY1 = bottomRightScreen.y / this._context.height;\r\n\r\n    // (0, 0) - 0\r\n    vertexBuffer[vertexIndex++] = topLeft.x;\r\n    vertexBuffer[vertexIndex++] = topLeft.y;\r\n    vertexBuffer[vertexIndex++] = uvx0;\r\n    vertexBuffer[vertexIndex++] = uvy0;\r\n    vertexBuffer[vertexIndex++] = screenUVX0;\r\n    vertexBuffer[vertexIndex++] = screenUVY0;\r\n\r\n    // (0, 1) - 1\r\n    vertexBuffer[vertexIndex++] = bottomLeft.x;\r\n    vertexBuffer[vertexIndex++] = bottomLeft.y;\r\n    vertexBuffer[vertexIndex++] = uvx0;\r\n    vertexBuffer[vertexIndex++] = uvy1;\r\n    vertexBuffer[vertexIndex++] = screenUVX0;\r\n    vertexBuffer[vertexIndex++] = screenUVY1;\r\n\r\n    // (1, 0) - 2\r\n    vertexBuffer[vertexIndex++] = topRight.x;\r\n    vertexBuffer[vertexIndex++] = topRight.y;\r\n    vertexBuffer[vertexIndex++] = uvx1;\r\n    vertexBuffer[vertexIndex++] = uvy0;\r\n    vertexBuffer[vertexIndex++] = screenUVX1;\r\n    vertexBuffer[vertexIndex++] = screenUVY0;\r\n\r\n    // (1, 1) - 3\r\n    vertexBuffer[vertexIndex++] = bottomRight.x;\r\n    vertexBuffer[vertexIndex++] = bottomRight.y;\r\n    vertexBuffer[vertexIndex++] = uvx1;\r\n    vertexBuffer[vertexIndex++] = uvy1;\r\n    vertexBuffer[vertexIndex++] = screenUVX1;\r\n    vertexBuffer[vertexIndex++] = screenUVY1;\r\n\r\n    // This creates and uploads the texture if not already done\r\n    const texture = this._addImageAsTexture(image);\r\n\r\n    // apply material\r\n    material.use();\r\n\r\n    this._layout.shader = shader!;\r\n    // apply layout and geometry\r\n    this._layout.use(true);\r\n\r\n    // apply time in ms since the page (performance.now())\r\n    shader.trySetUniformFloat('u_time_ms', performance.now());\r\n\r\n    // apply opacity\r\n    shader.trySetUniformFloat('u_opacity', opacity);\r\n\r\n    // apply resolution\r\n    shader.trySetUniformFloatVector('u_resolution', vec(this._context.width, this._context.height));\r\n\r\n    // apply graphic resolution\r\n    shader.trySetUniformFloatVector('u_graphic_resolution', vec(imageWidth, imageHeight));\r\n\r\n    // apply size\r\n    shader.trySetUniformFloatVector('u_size', vec(sw, sh));\r\n\r\n    // apply orthographic projection\r\n    shader.trySetUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // apply geometry transform\r\n    shader.trySetUniformMatrix('u_transform', transform.to4x4());\r\n\r\n    // bind graphic image texture 'uniform sampler2D u_graphic;'\r\n    gl.activeTexture(gl.TEXTURE0 + 0);\r\n    gl.bindTexture(gl.TEXTURE_2D, texture);\r\n    shader.trySetUniformInt('u_graphic', 0);\r\n\r\n    // bind the screen texture\r\n    gl.activeTexture(gl.TEXTURE0 + 1);\r\n    gl.bindTexture(gl.TEXTURE_2D, this._context.materialScreenTexture);\r\n    shader.trySetUniformInt('u_screen_texture', 1);\r\n\r\n    // bind any additional textures in the material\r\n    material.uploadAndBind(gl);\r\n\r\n    // bind quad index buffer\r\n    this._quads.bind();\r\n\r\n    // Draw a single quad\r\n    gl.drawElements(gl.TRIANGLES, 6, this._quads.bufferGlType, 0);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount++;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n  }\r\n\r\n  private _addImageAsTexture(image: HTMLImageSource) {\r\n    const maybeFiltering = image.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : undefined;\r\n    const wrapX = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingX) as any);\r\n    const wrapY = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingY) as any);\r\n\r\n    const force = image.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._context.textureLoader.load(\r\n      image,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force\r\n    )!;\r\n    // remove force attribute after upload\r\n    image.removeAttribute('forceUpload');\r\n    if (this._textures.indexOf(texture) === -1) {\r\n      this._textures.push(texture);\r\n    }\r\n\r\n    return texture;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return false;\r\n  }\r\n  flush(): void {\r\n    // flush does not do anything, material renderer renders immediately per draw\r\n  }\r\n}\r\n","/**\r\n * Enum representing the coordinate plane for the position 2D vector in the {@apilink TransformComponent}\r\n */\r\nexport enum CoordPlane {\r\n  /**\r\n   * The world coordinate plane (default) represents world space, any entities drawn with world\r\n   * space move when the camera moves.\r\n   */\r\n  World = 'world',\r\n  /**\r\n   * The screen coordinate plane represents screen space, entities drawn in screen space are pinned\r\n   * to screen coordinates ignoring the camera.\r\n   */\r\n  Screen = 'screen'\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { GetSpriteOptions, SpriteSheet } from './SpriteSheet';\r\nimport { Logger } from '../Util/Log';\r\nimport { clamp } from '../Math/util';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport interface HasTick {\r\n  /**\r\n   *\r\n   * @param elapsed The amount of real world time in milliseconds that has elapsed that must be updated in the animation\r\n   * @param idempotencyToken Optional idempotencyToken prevents a ticking animation from updating twice per frame\r\n   */\r\n  tick(elapsed: number, idempotencyToken?: number): void;\r\n}\r\n\r\nexport enum AnimationDirection {\r\n  /**\r\n   * Animation is playing forwards\r\n   */\r\n  Forward = 'forward',\r\n  /**\r\n   * Animation is playing backwards\r\n   */\r\n  Backward = 'backward'\r\n}\r\n\r\nexport enum AnimationStrategy {\r\n  /**\r\n   * Animation ends without displaying anything\r\n   */\r\n  End = 'end',\r\n  /**\r\n   * Animation loops to the first frame after the last frame\r\n   */\r\n  Loop = 'loop',\r\n  /**\r\n   * Animation plays to the last frame, then backwards to the first frame, then repeats\r\n   */\r\n  PingPong = 'pingpong',\r\n  /**\r\n   * Animation ends stopping on the last frame\r\n   */\r\n  Freeze = 'freeze'\r\n}\r\n\r\n/**\r\n * Frame of animation\r\n */\r\nexport interface Frame {\r\n  /**\r\n   * Optionally specify a graphic to show, no graphic shows an empty frame\r\n   */\r\n  graphic?: Graphic;\r\n  /**\r\n   * Optionally specify the number of ms the frame should be visible, overrides the animation duration (default 100 ms)\r\n   */\r\n  duration?: number;\r\n}\r\n\r\nexport interface FrameEvent extends Frame {\r\n  frameIndex: number;\r\n}\r\n\r\n/**\r\n * Animation options for building an animation via constructor.\r\n */\r\nexport interface AnimationOptions {\r\n  /**\r\n   * List of frames in the order you wish to play them\r\n   */\r\n  frames: Frame[];\r\n  /**\r\n   * Optionally set a positive speed multiplier on the animation.\r\n   *\r\n   * By default 1, meaning 1x speed. If set to 2, it will play the animation twice as fast.\r\n   */\r\n  speed?: number;\r\n  /**\r\n   * Optionally reverse the direction of play\r\n   */\r\n  reverse?: boolean;\r\n  /**\r\n   * Optionally specify a default frame duration in ms (Default is 100)\r\n   */\r\n  frameDuration?: number;\r\n  /**\r\n   * Optionally specify a total duration of the animation in ms to calculate each frame's duration\r\n   */\r\n  totalDuration?: number;\r\n  /**\r\n   * Optionally specify the {@apilink AnimationStrategy} for the Animation\r\n   */\r\n  strategy?: AnimationStrategy;\r\n}\r\n\r\nexport type AnimationEvents = {\r\n  frame: FrameEvent;\r\n  loop: Animation;\r\n  end: Animation;\r\n};\r\n\r\nexport const AnimationEvents = {\r\n  Frame: 'frame',\r\n  Loop: 'loop',\r\n  End: 'end'\r\n};\r\n\r\nexport interface FromSpriteSheetOptions {\r\n  /**\r\n   * {@apilink SpriteSheet} to source the animation frames from\r\n   */\r\n  spriteSheet: SpriteSheet;\r\n  /**\r\n   * The list of (x, y) positions of sprites in the {@apilink SpriteSheet} of each frame, for example (0, 0)\r\n   * is the the top left sprite, (0, 1) is the sprite directly below that, and so on.\r\n   *\r\n   * You may optionally specify a duration for the frame in milliseconds as well, this will override\r\n   * the default duration.\r\n   */\r\n  frameCoordinates: { x: number; y: number; duration?: number; options?: GetSpriteOptions }[];\r\n  /**\r\n   * Optionally specify a default duration for frames in milliseconds\r\n   * @deprecated use `durationPerFrame`\r\n   */\r\n  durationPerFrameMs?: number;\r\n  /**\r\n   * Optionally specify a default duration for frames in milliseconds\r\n   */\r\n  durationPerFrame?: number;\r\n  /**\r\n   * Optionally set a positive speed multiplier on the animation.\r\n   *\r\n   * By default 1, meaning 1x speed. If set to 2, it will play the animation twice as fast.\r\n   */\r\n  speed?: number;\r\n  /**\r\n   * Optionally specify the animation strategy for this animation, by default animations loop {@apilink AnimationStrategy.Loop}\r\n   */\r\n  strategy?: AnimationStrategy;\r\n  /**\r\n   * Optionally specify the animation should be reversed\r\n   */\r\n  reverse?: boolean;\r\n}\r\n\r\n/**\r\n * Create an Animation given a list of {@apilink Frame | `frames`} in {@apilink AnimationOptions}\r\n *\r\n * To create an Animation from a {@apilink SpriteSheet}, use {@apilink Animation.fromSpriteSheet}\r\n */\r\nexport class Animation extends Graphic implements HasTick {\r\n  private static _LOGGER = Logger.getInstance();\r\n  public events = new EventEmitter<AnimationEvents>();\r\n  public frames: Frame[] = [];\r\n  public strategy: AnimationStrategy = AnimationStrategy.Loop;\r\n  public frameDuration: number = 100;\r\n\r\n  private _idempotencyToken = -1;\r\n\r\n  private _firstTick = true;\r\n  private _currentFrame = 0;\r\n  private _timeLeftInFrame = 0;\r\n  private _pingPongDirection = 1;\r\n  private _done = false;\r\n  private _playing = true;\r\n  private _speed = 1;\r\n\r\n  constructor(options: GraphicOptions & AnimationOptions) {\r\n    super(options);\r\n    this.frames = options.frames;\r\n    this.speed = options.speed ?? this.speed;\r\n    this.strategy = options.strategy ?? this.strategy;\r\n    this.frameDuration = options.totalDuration ? options.totalDuration / this.frames.length : options.frameDuration ?? this.frameDuration;\r\n    if (options.reverse) {\r\n      this.reverse();\r\n    }\r\n    this.goToFrame(0);\r\n  }\r\n\r\n  public clone(): Animation {\r\n    return new Animation({\r\n      frames: this.frames.map((f) => ({ ...f })),\r\n      frameDuration: this.frameDuration,\r\n      speed: this.speed,\r\n      reverse: this._reversed,\r\n      strategy: this.strategy,\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n\r\n  public override get width(): number {\r\n    const maybeFrame = this.currentFrame;\r\n    if (maybeFrame && maybeFrame.graphic) {\r\n      return Math.abs(maybeFrame.graphic.width * this.scale.x);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  public override get height(): number {\r\n    const maybeFrame = this.currentFrame;\r\n    if (maybeFrame && maybeFrame.graphic) {\r\n      return Math.abs(maybeFrame.graphic.height * this.scale.y);\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Create an Animation from a {@apilink SpriteSheet}, a list of indices into the sprite sheet, a duration per frame\r\n   * and optional {@apilink AnimationStrategy}\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const spriteSheet = SpriteSheet.fromImageSource({...});\r\n   *\r\n   * const anim = Animation.fromSpriteSheet(spriteSheet, range(0, 5), 200, AnimationStrategy.Loop);\r\n   * ```\r\n   * @param spriteSheet ex.SpriteSheet\r\n   * @param spriteSheetIndex 0 based index from left to right, top down (row major order) of the ex.SpriteSheet\r\n   * @param durationPerFrame duration per frame in milliseconds\r\n   * @param strategy Optional strategy, default AnimationStrategy.Loop\r\n   */\r\n  public static fromSpriteSheet(\r\n    spriteSheet: SpriteSheet,\r\n    spriteSheetIndex: number[],\r\n    durationPerFrame: number,\r\n    strategy: AnimationStrategy = AnimationStrategy.Loop\r\n  ): Animation {\r\n    const maxIndex = spriteSheet.sprites.length - 1;\r\n    const invalidIndices = spriteSheetIndex.filter((index) => index < 0 || index > maxIndex);\r\n    if (invalidIndices.length) {\r\n      Animation._LOGGER.warn(\r\n        `Indices into SpriteSheet were provided that don\\'t exist: ${invalidIndices.join(',')} no frame will be shown`\r\n      );\r\n    }\r\n    return new Animation({\r\n      frames: spriteSheet.sprites\r\n        .filter((_, index) => spriteSheetIndex.indexOf(index) > -1)\r\n        .map((f) => ({\r\n          graphic: f,\r\n          duration: durationPerFrame\r\n        })),\r\n      strategy: strategy\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create an {@apilink Animation} from a {@apilink SpriteSheet} given a list of coordinates\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const spriteSheet = SpriteSheet.fromImageSource({...});\r\n   *\r\n   * const anim = Animation.fromSpriteSheetCoordinates({\r\n   *  spriteSheet,\r\n   *  frameCoordinates: [\r\n   *    {x: 0, y: 5, duration: 100, options { flipHorizontal: true }},\r\n   *    {x: 1, y: 5, duration: 200},\r\n   *    {x: 2, y: 5},\r\n   *    {x: 3, y: 5}\r\n   *  ],\r\n   *  strategy: AnimationStrategy.PingPong\r\n   * });\r\n   * ```\r\n   * @param options\r\n   * @returns Animation\r\n   */\r\n  public static fromSpriteSheetCoordinates(options: FromSpriteSheetOptions): Animation {\r\n    const { spriteSheet, frameCoordinates, durationPerFrame, durationPerFrameMs, speed, strategy, reverse } = options;\r\n    const defaultDuration = durationPerFrame ?? durationPerFrameMs ?? 100;\r\n    const frames: Frame[] = [];\r\n    for (const coord of frameCoordinates) {\r\n      const { x, y, duration, options } = coord;\r\n      const sprite = spriteSheet.getSprite(x, y, options);\r\n      if (sprite) {\r\n        frames.push({\r\n          graphic: sprite,\r\n          duration: duration ?? defaultDuration\r\n        });\r\n      } else {\r\n        Animation._LOGGER.warn(\r\n          `Skipping frame! SpriteSheet does not have coordinate (${x}, ${y}), please check your SpriteSheet to confirm that sprite exists`\r\n        );\r\n      }\r\n    }\r\n\r\n    return new Animation({\r\n      frames,\r\n      strategy,\r\n      speed,\r\n      reverse\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Current animation speed\r\n   *\r\n   * 1 meaning normal 1x speed.\r\n   * 2 meaning 2x speed and so on.\r\n   */\r\n  public get speed(): number {\r\n    return this._speed;\r\n  }\r\n\r\n  /**\r\n   * Current animation speed\r\n   *\r\n   * 1 meaning normal 1x speed.\r\n   * 2 meaning 2x speed and so on.\r\n   */\r\n  public set speed(val: number) {\r\n    this._speed = clamp(Math.abs(val), 0, Infinity);\r\n  }\r\n\r\n  /**\r\n   * Returns the current Frame of the animation\r\n   *\r\n   * Use {@apilink Animation.currentFrameIndex} to get the frame number and\r\n   * {@apilink Animation.goToFrame} to set the current frame index\r\n   */\r\n  public get currentFrame(): Frame | null {\r\n    if (this._currentFrame >= 0 && this._currentFrame < this.frames.length) {\r\n      return this.frames[this._currentFrame];\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the current frame index of the animation\r\n   *\r\n   * Use {@apilink Animation.currentFrame} to grab the current {@apilink Frame} object\r\n   */\r\n  public get currentFrameIndex(): number {\r\n    return this._currentFrame;\r\n  }\r\n\r\n  /**\r\n   * Returns the amount of time in milliseconds left in the current frame\r\n   */\r\n  public get currentFrameTimeLeft(): number {\r\n    return this._timeLeftInFrame;\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation is playing\r\n   */\r\n  public get isPlaying(): boolean {\r\n    return this._playing;\r\n  }\r\n\r\n  private _reversed = false;\r\n\r\n  public get isReversed() {\r\n    return this._reversed;\r\n  }\r\n\r\n  /**\r\n   * Reverses the play direction of the Animation, this preserves the current frame\r\n   */\r\n  public reverse(): void {\r\n    // Don't mutate with the original frame list, create a copy\r\n    this.frames = this.frames.slice().reverse();\r\n    this._reversed = !this._reversed;\r\n  }\r\n\r\n  /**\r\n   * Returns the current play direction of the animation\r\n   */\r\n  public get direction(): AnimationDirection {\r\n    // Keep logically consistent with ping-pong direction\r\n    // If ping-pong is forward = 1 and reversed is true then we are logically reversed\r\n    const reversed = this._reversed && this._pingPongDirection === 1 ? true : false;\r\n    return reversed ? AnimationDirection.Backward : AnimationDirection.Forward;\r\n  }\r\n\r\n  /**\r\n   * Plays or resumes the animation from the current frame\r\n   */\r\n  public play(): void {\r\n    this._playing = true;\r\n  }\r\n\r\n  /**\r\n   * Pauses the animation on the current frame\r\n   */\r\n  public pause(): void {\r\n    this._playing = false;\r\n    this._firstTick = true; // firstTick must be set to emit the proper frame event\r\n  }\r\n\r\n  /**\r\n   * Reset the animation back to the beginning, including if the animation were done\r\n   */\r\n  public reset(): void {\r\n    this._done = false;\r\n    this._firstTick = true;\r\n    this._currentFrame = 0;\r\n    this._timeLeftInFrame = this.frameDuration;\r\n    const maybeFrame = this.frames[this._currentFrame];\r\n    if (maybeFrame) {\r\n      this._timeLeftInFrame = maybeFrame?.duration || this.frameDuration;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation can end\r\n   */\r\n  public get canFinish(): boolean {\r\n    switch (this.strategy) {\r\n      case AnimationStrategy.End:\r\n      case AnimationStrategy.Freeze: {\r\n        return true;\r\n      }\r\n      default: {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns `true` if the animation is done, for looping type animations\r\n   * `ex.AnimationStrategy.PingPong` and `ex.AnimationStrategy.Loop` this will always return `false`\r\n   *\r\n   * See the `ex.Animation.canFinish()` method to know if an animation type can end\r\n   */\r\n  public get done(): boolean {\r\n    return this._done;\r\n  }\r\n\r\n  /**\r\n   * Jump the animation immediately to a specific frame if it exists\r\n   *\r\n   * Optionally specify an override for the duration of the frame, useful for\r\n   * keeping multiple animations in sync with one another.\r\n   * @param frameNumber\r\n   * @param duration\r\n   */\r\n  public goToFrame(frameNumber: number, duration?: number) {\r\n    this._currentFrame = frameNumber;\r\n    this._timeLeftInFrame = duration ?? this.frameDuration;\r\n    const maybeFrame = this.frames[this._currentFrame];\r\n    if (maybeFrame && !this._done) {\r\n      this._timeLeftInFrame = duration ?? (maybeFrame?.duration || this.frameDuration);\r\n      this.events.emit('frame', { ...maybeFrame, frameIndex: this.currentFrameIndex });\r\n    }\r\n  }\r\n\r\n  private _nextFrame(): number {\r\n    const currentFrame = this._currentFrame;\r\n    if (this._done) {\r\n      return currentFrame;\r\n    }\r\n    let next = -1;\r\n\r\n    switch (this.strategy) {\r\n      case AnimationStrategy.Loop: {\r\n        next = (currentFrame + 1) % this.frames.length;\r\n        if (next === 0) {\r\n          this.events.emit('loop', this);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.End: {\r\n        next = currentFrame + 1;\r\n        if (next >= this.frames.length) {\r\n          this._done = true;\r\n          this._currentFrame = this.frames.length;\r\n          this.events.emit('end', this);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.Freeze: {\r\n        next = clamp(currentFrame + 1, 0, this.frames.length - 1);\r\n        if (next >= this.frames.length - 1) {\r\n          this._done = true;\r\n          this.events.emit('end', this);\r\n        }\r\n        break;\r\n      }\r\n      case AnimationStrategy.PingPong: {\r\n        if (currentFrame + this._pingPongDirection >= this.frames.length) {\r\n          this._pingPongDirection = -1;\r\n          this.events.emit('loop', this);\r\n        }\r\n\r\n        if (currentFrame + this._pingPongDirection < 0) {\r\n          this._pingPongDirection = 1;\r\n          this.events.emit('loop', this);\r\n        }\r\n\r\n        next = currentFrame + (this._pingPongDirection % this.frames.length);\r\n        break;\r\n      }\r\n    }\r\n    return next;\r\n  }\r\n\r\n  /**\r\n   * Called internally by Excalibur to update the state of the animation potential update the current frame\r\n   * @param elapsed Milliseconds elapsed\r\n   * @param idempotencyToken Prevents double ticking in a frame by passing a unique token to the frame\r\n   */\r\n  public tick(elapsed: number, idempotencyToken: number = 0): void {\r\n    if (this._idempotencyToken === idempotencyToken) {\r\n      return;\r\n    }\r\n    this._idempotencyToken = idempotencyToken;\r\n    if (!this._playing) {\r\n      return;\r\n    }\r\n\r\n    // if it's the first frame emit frame event\r\n    if (this._firstTick) {\r\n      this._firstTick = false;\r\n      this.events.emit('frame', { ...this.currentFrame, frameIndex: this.currentFrameIndex });\r\n    }\r\n\r\n    this._timeLeftInFrame -= elapsed * this._speed;\r\n    if (this._timeLeftInFrame <= 0) {\r\n      this.goToFrame(this._nextFrame());\r\n    }\r\n  }\r\n\r\n  protected _drawImage(ctx: ExcaliburGraphicsContext, x: number, y: number) {\r\n    if (this.currentFrame && this.currentFrame.graphic) {\r\n      this.currentFrame.graphic.draw(ctx, x, y);\r\n    }\r\n  }\r\n}\r\n","import { Vector } from './vector';\n\nexport interface VectorViewOptions {\n  getX: () => number;\n  getY: () => number;\n  setX: (x: number) => void;\n  setY: (y: number) => void;\n}\nexport class VectorView extends Vector {\n  private _getX: () => number;\n  private _getY: () => number;\n  private _setX: (x: number) => void;\n  private _setY: (y: number) => void;\n  constructor(options: VectorViewOptions) {\n    super(0, 0);\n    this._getX = options.getX;\n    this._getY = options.getY;\n    this._setX = options.setX;\n    this._setY = options.setY;\n  }\n  public get x() {\n    return (this._x = this._getX());\n  }\n\n  public set x(val) {\n    this._setX(val);\n    this._x = val;\n  }\n\n  public get y() {\n    return (this._y = this._getY());\n  }\n  public set y(val) {\n    this._setY(val);\n    this._y = val;\n  }\n}\n","import { Vector } from './vector';\r\n\r\n/**\r\n * Wraps a vector and watches for changes in the x/y, modifies the original vector.\r\n */\r\nexport class WatchVector extends Vector {\r\n  constructor(\r\n    public original: Vector,\r\n    public change: (x: number, y: number) => any\r\n  ) {\r\n    super(original.x, original.y);\r\n  }\r\n  public get x() {\r\n    return (this._x = this.original.x);\r\n  }\r\n\r\n  public set x(newX: number) {\r\n    if (newX !== this._x) {\r\n      this.change(newX, this._y);\r\n      this._x = this.original.x = newX;\r\n    }\r\n  }\r\n\r\n  public get y() {\r\n    return (this._y = this.original.y);\r\n  }\r\n\r\n  public set y(newY: number) {\r\n    if (newY !== this._y) {\r\n      this.change(this._x, newY);\r\n      this._y = this.original.y = newY;\r\n    }\r\n  }\r\n\r\n  override setTo(x: number, y: number): void {\r\n    this.x = x;\r\n    this.y = y;\r\n  }\r\n}\r\n","import { AffineMatrix } from './affine-matrix';\r\nimport { canonicalizeAngle, sign } from './util';\r\nimport { vec, Vector } from './vector';\r\nimport { VectorView } from './vector-view';\r\nimport { WatchVector } from './watch-vector';\r\n\r\nexport class Transform {\r\n  private _parent: Transform | null = null;\r\n  get parent() {\r\n    return this._parent;\r\n  }\r\n  set parent(transform: Transform | null) {\r\n    if (this._parent) {\r\n      const index = this._parent._children.indexOf(this);\r\n      if (index > -1) {\r\n        this._parent._children.splice(index, 1);\r\n      }\r\n    }\r\n    this._parent = transform;\r\n    if (this._parent) {\r\n      this._parent._children.push(this);\r\n    }\r\n    this.flagDirty();\r\n  }\r\n  get children(): readonly Transform[] {\r\n    return this._children;\r\n  }\r\n  private _children: Transform[] = [];\r\n\r\n  private _pos: Vector = new WatchVector(vec(0, 0), () => {\r\n    this.flagDirty();\r\n  });\r\n  set pos(v: Vector) {\r\n    this._pos.x = v.x;\r\n    this._pos.y = v.y;\r\n  }\r\n  get pos() {\r\n    return this._pos;\r\n  }\r\n\r\n  set globalPos(v: Vector) {\r\n    let localPos = v.clone();\r\n    if (this.parent) {\r\n      localPos = this.parent.inverse.multiply(v);\r\n    }\r\n    if (!localPos.equals(this._pos)) {\r\n      this._pos = localPos;\r\n      this.flagDirty();\r\n    }\r\n  }\r\n  private _globalPos = new VectorView({\r\n    getX: () => this.matrix.data[4],\r\n    getY: () => this.matrix.data[5],\r\n    setX: (x) => {\r\n      if (this.parent) {\r\n        const { x: newX } = this.parent.inverse.multiply(vec(x, this.pos.y));\r\n        this.pos.x = newX;\r\n      } else {\r\n        this.pos.x = x;\r\n      }\r\n      if (x !== this.matrix.data[4]) {\r\n        this.flagDirty();\r\n      }\r\n    },\r\n    setY: (y) => {\r\n      if (this.parent) {\r\n        const { y: newY } = this.parent.inverse.multiply(vec(this.pos.x, y));\r\n        this.pos.y = newY;\r\n      } else {\r\n        this.pos.y = y;\r\n      }\r\n      if (y !== this.matrix.data[5]) {\r\n        this.flagDirty();\r\n      }\r\n    }\r\n  });\r\n  get globalPos() {\r\n    return this._globalPos;\r\n  }\r\n\r\n  private _rotation: number = 0;\r\n  set rotation(rotation: number) {\r\n    const canonRotation = canonicalizeAngle(rotation);\r\n    if (canonRotation !== this._rotation) {\r\n      this.flagDirty();\r\n    }\r\n    this._rotation = canonRotation;\r\n  }\r\n  get rotation() {\r\n    return this._rotation;\r\n  }\r\n\r\n  set globalRotation(rotation: number) {\r\n    let inverseRotation = 0;\r\n    if (this.parent) {\r\n      inverseRotation = this.parent.globalRotation;\r\n    }\r\n    const canonRotation = canonicalizeAngle(rotation + inverseRotation);\r\n    if (canonRotation !== this._rotation) {\r\n      this.flagDirty();\r\n    }\r\n    this._rotation = canonRotation;\r\n  }\r\n\r\n  get globalRotation() {\r\n    if (this.parent) {\r\n      return this.matrix.getRotation();\r\n    }\r\n    return this.rotation;\r\n  }\r\n\r\n  private _scale: Vector = new WatchVector(vec(1, 1), () => {\r\n    this.flagDirty();\r\n  });\r\n  set scale(v: Vector) {\r\n    this._scale.x = v.x;\r\n    this._scale.y = v.y;\r\n  }\r\n  get scale() {\r\n    return this._scale;\r\n  }\r\n\r\n  set globalScale(v: Vector) {\r\n    let inverseScale = vec(1, 1);\r\n    if (this.parent) {\r\n      inverseScale = this.parent.globalScale;\r\n    }\r\n    this.scale = v.scale(vec(1 / inverseScale.x, 1 / inverseScale.y));\r\n  }\r\n\r\n  private _globalScale = new VectorView({\r\n    getX: () => (this.parent ? this.matrix.getScaleX() : this.scale.x),\r\n    getY: () => (this.parent ? this.matrix.getScaleY() : this.scale.y),\r\n    setX: (x) => {\r\n      if (this.parent) {\r\n        const globalScaleX = this.parent.globalScale.x;\r\n        this.scale.x = x / globalScaleX;\r\n      } else {\r\n        this.scale.x = x;\r\n      }\r\n    },\r\n    setY: (y) => {\r\n      if (this.parent) {\r\n        const globalScaleY = this.parent.globalScale.y;\r\n        this.scale.y = y / globalScaleY;\r\n      } else {\r\n        this.scale.y = y;\r\n      }\r\n    }\r\n  });\r\n  get globalScale() {\r\n    return this._globalScale;\r\n  }\r\n\r\n  private _z: number = 0;\r\n\r\n  set z(z: number) {\r\n    this._z = z;\r\n    this.flagDirty();\r\n  }\r\n\r\n  get z() {\r\n    return this._z;\r\n  }\r\n\r\n  set globalZ(z: number) {\r\n    if (this.parent) {\r\n      this.z = z - this.parent.globalZ;\r\n    } else {\r\n      this.z = z;\r\n    }\r\n  }\r\n\r\n  get globalZ() {\r\n    if (this.parent) {\r\n      return this.z + this.parent.globalZ;\r\n    }\r\n    return this.z;\r\n  }\r\n\r\n  private _isDirty = false;\r\n  private _isInverseDirty = false;\r\n  private _matrix = AffineMatrix.identity();\r\n  private _inverse = AffineMatrix.identity();\r\n\r\n  /**\r\n   * Calculates and returns the matrix representation of this transform\r\n   *\r\n   * Avoid mutating the matrix to update the transform, it is not the source of truth.\r\n   * Update the transform pos, rotation, scale.\r\n   */\r\n  public get matrix(): AffineMatrix {\r\n    if (this._isDirty) {\r\n      if (this.parent === null) {\r\n        this._calculateMatrix().clone(this._matrix);\r\n      } else {\r\n        this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix);\r\n      }\r\n      this._isDirty = false;\r\n    }\r\n    return this._matrix;\r\n  }\r\n\r\n  /**\r\n   * Calculates and returns the inverse matrix representation of this transform\r\n   */\r\n  public get inverse(): AffineMatrix {\r\n    if (this._isInverseDirty) {\r\n      this.matrix.inverse(this._inverse);\r\n      this._isInverseDirty = false;\r\n    }\r\n    return this._inverse;\r\n  }\r\n\r\n  private _scratch = AffineMatrix.identity();\r\n  private _calculateMatrix(): AffineMatrix {\r\n    this._scratch.data[0] = Math.cos(this._rotation);\r\n    this._scratch.data[1] = Math.sin(this._rotation);\r\n    this._scratch.data[2] = -Math.sin(this._rotation);\r\n    this._scratch.data[3] = Math.cos(this.rotation);\r\n    this._scratch.data[4] = this._pos.x;\r\n    this._scratch.data[5] = this._pos.y;\r\n    this._scratch.scale(this._scale.x, this._scale.y);\r\n    return this._scratch;\r\n  }\r\n\r\n  public flagDirty() {\r\n    this._isDirty = true;\r\n    this._isInverseDirty = true;\r\n    for (let i = 0; i < this._children.length; i++) {\r\n      this._children[i].flagDirty();\r\n    }\r\n  }\r\n\r\n  public apply(point: Vector): Vector {\r\n    return this.matrix.multiply(point);\r\n  }\r\n\r\n  public applyInverse(point: Vector): Vector {\r\n    return this.inverse.multiply(point);\r\n  }\r\n\r\n  public setTransform(pos: Vector, rotation: number, scale: Vector) {\r\n    this._pos.x = pos.x;\r\n    this._pos.y = pos.y;\r\n    this._rotation = canonicalizeAngle(rotation);\r\n    this._scale.x = scale.x;\r\n    this._scale.y = scale.y;\r\n    this.flagDirty();\r\n  }\r\n\r\n  /**\r\n   * Returns true if the transform has a negative x scale or y scale, but not both\r\n   */\r\n  public isMirrored(): boolean {\r\n    const signBitX = sign(this.scale.x) >>> 31;\r\n    const signBitY = sign(this.scale.y) >>> 31;\r\n    const mirrored = signBitX ^ signBitY;\r\n    return !!mirrored;\r\n  }\r\n\r\n  /**\r\n   * Clones the current transform\r\n   * **Warning does not clone the parent**\r\n   * @param dest\r\n   */\r\n  public clone(dest?: Transform): Transform {\r\n    const target = dest ?? new Transform();\r\n    this._pos.clone(target._pos);\r\n    target._z = this._z;\r\n    target._rotation = this._rotation;\r\n    this._scale.clone(target._scale);\r\n    target.flagDirty();\r\n    return target;\r\n  }\r\n\r\n  /**\r\n   * Clones but keeps the same parent reference\r\n   */\r\n  public cloneWithParent(dest?: Transform): Transform {\r\n    const target = dest ?? new Transform();\r\n    this._pos.clone(target._pos);\r\n    target._z = this._z;\r\n    target._rotation = this._rotation;\r\n    this._scale.clone(target._scale);\r\n    target.parent = this.parent;\r\n    target.flagDirty();\r\n    return target;\r\n  }\r\n\r\n  public toString(): string {\r\n    return this.matrix.toString();\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\n\r\n/**\r\n * Component Constructor Types\r\n */\r\nexport declare type ComponentCtor<TComponent extends Component = Component> = new (...args: any[]) => TComponent;\r\n\r\n/**\r\n *\r\n */\r\nexport function isComponentCtor(value: any): value is ComponentCtor<Component> {\r\n  return !!value && !!value.prototype && !!value.prototype.constructor;\r\n}\r\n\r\n/**\r\n * Type guard to check if a component implements clone\r\n * @param x\r\n */\r\nfunction hasClone(x: any): x is { clone(): any } {\r\n  return !!x?.clone;\r\n}\r\n\r\n/**\r\n * Components are containers for state in Excalibur, the are meant to convey capabilities that an Entity possesses\r\n *\r\n * Implementations of Component must have a zero-arg constructor to support dependencies\r\n *\r\n * ```typescript\r\n * class MyComponent extends ex.Component {\r\n *   // zero arg support required if you want to use component dependencies\r\n *   constructor(public optionalPos?: ex.Vector) {}\r\n * }\r\n * ```\r\n */\r\nexport abstract class Component {\r\n  // TODO maybe generate a unique id?\r\n\r\n  /**\r\n   * Optionally list any component types this component depends on\r\n   * If the owner entity does not have these components, new components will be added to the entity\r\n   *\r\n   * Only components with zero-arg constructors are supported as automatic component dependencies\r\n   */\r\n  readonly dependencies?: ComponentCtor[];\r\n\r\n  /**\r\n   * Current owning {@apilink Entity}, if any, of this component. Null if not added to any {@apilink Entity}\r\n   */\r\n  owner?: Entity = undefined;\r\n\r\n  /**\r\n   * Clones any properties on this component, if that property value has a `clone()` method it will be called\r\n   */\r\n  clone(): Component {\r\n    const newComponent = new (this.constructor as any)();\r\n    for (const prop in this) {\r\n      if (this.hasOwnProperty(prop)) {\r\n        const val = this[prop];\r\n        if (hasClone(val) && prop !== 'owner' && prop !== 'clone') {\r\n          newComponent[prop] = val.clone();\r\n        } else {\r\n          newComponent[prop] = val;\r\n        }\r\n      }\r\n    }\r\n    return newComponent;\r\n  }\r\n\r\n  /**\r\n   * Optional callback called when a component is added to an entity\r\n   */\r\n  onAdd?(owner: Entity): void;\r\n\r\n  /**\r\n   * Optional callback called when a component is removed from an entity\r\n   */\r\n  onRemove?(previousOwner: Entity): void;\r\n}\r\n","/**\n * Defines a generic message that can contain any data\n * @template T is the typescript Type of the data\n */\nexport interface Message<T> {\n  type: string;\n  data: T;\n}\n\n/**\n * Defines an interface for an observer to receive a message via a notify() method\n */\nexport interface Observer<T> {\n  notify(message: T): void;\n}\n\n/**\n * Defines an interface for something that might be an observer if a notify() is present\n */\nexport type MaybeObserver<T> = Partial<Observer<T>>;\n\n/**\n * Simple Observable implementation\n * @template T is the typescript Type that defines the data being observed\n */\nexport class Observable<T> {\n  public observers: Observer<T>[] = [];\n  public subscriptions: ((val: T) => any)[] = [];\n\n  /**\n   * Register an observer to listen to this observable\n   * @param observer\n   */\n  register(observer: Observer<T>) {\n    this.observers.push(observer);\n  }\n\n  /**\n   * Register a callback to listen to this observable\n   * @param func\n   */\n  subscribe(func: (val: T) => any) {\n    this.subscriptions.push(func);\n  }\n\n  /**\n   * Remove an observer from the observable\n   * @param observer\n   */\n  unregister(observer: Observer<T>) {\n    const i = this.observers.indexOf(observer);\n    if (i !== -1) {\n      this.observers.splice(i, 1);\n    }\n  }\n\n  /**\n   * Remove a callback that is listening to this observable\n   * @param func\n   */\n  unsubscribe(func: (val: T) => any) {\n    const i = this.subscriptions.indexOf(func);\n    if (i !== -1) {\n      this.subscriptions.splice(i, 1);\n    }\n  }\n\n  /**\n   * Broadcasts a message to all observers and callbacks\n   * @param message\n   */\n  notifyAll(message: T) {\n    const observersLength = this.observers.length;\n    for (let i = 0; i < observersLength; i++) {\n      this.observers[i].notify(message);\n    }\n    const subscriptionsLength = this.subscriptions.length;\n    for (let i = 0; i < subscriptionsLength; i++) {\n      this.subscriptions[i](message);\n    }\n  }\n\n  /**\n   * Removes all observers and callbacks\n   */\n  clear() {\n    this.observers.length = 0;\n    this.subscriptions.length = 0;\n  }\n}\n","import { Vector } from '../../Math/vector';\r\nimport { CoordPlane } from '../../Math/coord-plane';\r\nimport { Transform } from '../../Math/transform';\r\nimport { Component } from '../Component';\r\nimport { Entity } from '../Entity';\r\nimport { Observable } from '../../Util/Observable';\r\nimport { Logger } from '../../Util/Log';\r\n\r\nexport class TransformComponent extends Component {\r\n  private _logger = Logger.getInstance();\r\n  private _parentComponent: TransformComponent | null = null;\r\n  private _transform = new Transform();\r\n  public get() {\r\n    return this._transform;\r\n  }\r\n\r\n  private _addChildTransform = (child: Entity) => {\r\n    const childTxComponent = child.get(TransformComponent);\r\n    if (childTxComponent) {\r\n      childTxComponent._transform.parent = this._transform;\r\n      childTxComponent._parentComponent = this;\r\n    }\r\n  };\r\n  onAdd(owner: Entity): void {\r\n    for (const child of owner.children) {\r\n      this._addChildTransform(child);\r\n    }\r\n    owner.childrenAdded$.subscribe((child) => this._addChildTransform(child));\r\n    owner.childrenRemoved$.subscribe((child) => {\r\n      const childTxComponent = child.get(TransformComponent);\r\n      if (childTxComponent) {\r\n        childTxComponent._transform.parent = null;\r\n        childTxComponent._parentComponent = null;\r\n      }\r\n    });\r\n  }\r\n  onRemove(_previousOwner: Entity): void {\r\n    this._transform.parent = null;\r\n    this._parentComponent = null;\r\n  }\r\n\r\n  /**\r\n   * Observable that emits when the z index changes on this component\r\n   */\r\n  public zIndexChanged$ = new Observable<number>();\r\n\r\n  /**\r\n   * The z-index ordering of the entity, a higher values are drawn on top of lower values.\r\n   * For example z=99 would be drawn on top of z=0.\r\n   */\r\n  public get z(): number {\r\n    return this._transform.z;\r\n  }\r\n\r\n  public set z(val: number) {\r\n    const oldz = this._transform.z;\r\n    this._transform.z = val;\r\n    if (oldz !== val) {\r\n      this.zIndexChanged$.notifyAll(val);\r\n    }\r\n  }\r\n\r\n  public get globalZ() {\r\n    return this._transform.globalZ;\r\n  }\r\n\r\n  public set globalZ(z: number) {\r\n    this._transform.globalZ = z;\r\n  }\r\n\r\n  private _coordPlane = CoordPlane.World;\r\n  /**\r\n   * The {@apilink CoordPlane | `coordinate plane`} for this transform for the entity.\r\n   */\r\n  public get coordPlane() {\r\n    if (this._parentComponent) {\r\n      return this._parentComponent.coordPlane;\r\n    }\r\n    return this._coordPlane;\r\n  }\r\n\r\n  public set coordPlane(value: CoordPlane) {\r\n    if (!this._parentComponent) {\r\n      this._coordPlane = value;\r\n    } else {\r\n      this._logger.warn(\r\n        `Cannot set coordinate plane on child entity ${this.owner?.name}, children inherit their coordinate plane from their parents.`\r\n      );\r\n    }\r\n  }\r\n\r\n  get pos() {\r\n    return this._transform.pos;\r\n  }\r\n  set pos(v: Vector) {\r\n    this._transform.pos = v;\r\n  }\r\n\r\n  get globalPos() {\r\n    return this._transform.globalPos;\r\n  }\r\n  set globalPos(v: Vector) {\r\n    this._transform.globalPos = v;\r\n  }\r\n\r\n  get rotation() {\r\n    return this._transform.rotation;\r\n  }\r\n  set rotation(rotation) {\r\n    this._transform.rotation = rotation;\r\n  }\r\n\r\n  get globalRotation() {\r\n    return this._transform.globalRotation;\r\n  }\r\n  set globalRotation(rotation) {\r\n    this._transform.globalRotation = rotation;\r\n  }\r\n\r\n  get scale() {\r\n    return this._transform.scale;\r\n  }\r\n  set scale(v: Vector) {\r\n    this._transform.scale = v;\r\n  }\r\n\r\n  get globalScale() {\r\n    return this._transform.globalScale;\r\n  }\r\n  set globalScale(v: Vector) {\r\n    this._transform.globalScale = v;\r\n  }\r\n\r\n  applyInverse(v: Vector) {\r\n    return this._transform.applyInverse(v);\r\n  }\r\n\r\n  apply(v: Vector) {\r\n    return this._transform.apply(v);\r\n  }\r\n\r\n  clone(): TransformComponent {\r\n    const component = new TransformComponent();\r\n    component._transform = this._transform.clone();\r\n    return component;\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { Animation, HasTick } from './Animation';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Logger } from '../Util/Log';\r\n\r\nexport interface GraphicsGroupingOptions {\r\n  members: (GraphicsGrouping | Graphic)[];\r\n  /**\r\n   * Default true, GraphicsGroup will use the anchor to position all the graphics based on their combined bounds\r\n   *\r\n   * Setting to false will ignore anchoring from parent components and position the top left of all graphics at the actor's position,\r\n   * positioning graphics in the group is done with the `offset` property.\r\n   */\r\n  useAnchor?: boolean;\r\n}\r\n\r\nexport interface GraphicsGrouping {\r\n  offset: Vector;\r\n  graphic: Graphic;\r\n  /**\r\n   * Optionally disable this graphics bounds as part of group calculation, default true\r\n   * if unspecified\r\n   *\r\n   * You may want disable this if you're using text because their bounds will affect\r\n   * the centering of the whole group.\r\n   *\r\n   * **WARNING** having inaccurate bounds can cause offscreen culling issues.\r\n   */\r\n  useBounds?: boolean;\r\n}\r\n\r\nexport class GraphicsGroup extends Graphic implements HasTick {\r\n  private _logger = Logger.getInstance();\r\n  public useAnchor: boolean = true;\r\n  public members: (GraphicsGrouping | Graphic)[] = [];\r\n\r\n  constructor(options: GraphicsGroupingOptions & GraphicOptions) {\r\n    super(options);\r\n    this.members = options.members;\r\n    this.useAnchor = options.useAnchor ?? this.useAnchor;\r\n    this._updateDimensions();\r\n  }\r\n\r\n  public clone(): GraphicsGroup {\r\n    return new GraphicsGroup({\r\n      members: [...this.members],\r\n      ...this.cloneGraphicOptions()\r\n    });\r\n  }\r\n\r\n  private _updateDimensions(): BoundingBox {\r\n    const bb = this.localBounds;\r\n    this.width = bb.width;\r\n    this.height = bb.height;\r\n    return bb;\r\n  }\r\n\r\n  public get localBounds(): BoundingBox {\r\n    const bb = new BoundingBox();\r\n    for (const member of this.members) {\r\n      if (member instanceof Graphic) {\r\n        member.localBounds.combine(bb, bb);\r\n      } else {\r\n        const { graphic, offset: pos, useBounds } = member;\r\n        const shouldUseBounds = useBounds === undefined ? true : useBounds;\r\n        if (graphic) {\r\n          if (shouldUseBounds) {\r\n            graphic.localBounds.translate(pos).combine(bb, bb);\r\n          }\r\n        } else {\r\n          this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(member)}.`);\r\n        }\r\n      }\r\n    }\r\n    return bb;\r\n  }\r\n\r\n  private _isAnimationOrGroup(graphic: Graphic): graphic is Animation | GraphicsGroup {\r\n    return graphic instanceof Animation || graphic instanceof GraphicsGroup;\r\n  }\r\n\r\n  public tick(elapsed: number, idempotencyToken?: number) {\r\n    for (const member of this.members) {\r\n      let graphic: Graphic;\r\n      if (member instanceof Graphic) {\r\n        graphic = member;\r\n      } else {\r\n        graphic = member.graphic;\r\n      }\r\n      if (this._isAnimationOrGroup(graphic)) {\r\n        graphic.tick(elapsed, idempotencyToken);\r\n      }\r\n    }\r\n  }\r\n\r\n  public reset() {\r\n    for (const member of this.members) {\r\n      let graphic: Graphic;\r\n      if (member instanceof Graphic) {\r\n        graphic = member;\r\n      } else {\r\n        graphic = member.graphic;\r\n      }\r\n      if (this._isAnimationOrGroup(graphic)) {\r\n        graphic.reset();\r\n      }\r\n    }\r\n  }\r\n\r\n  protected _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    this._updateDimensions();\r\n    super._preDraw(ex, this.useAnchor ? x : 0, this.useAnchor ? y : 0);\r\n  }\r\n\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    const pos = Vector.Zero;\r\n    for (const member of this.members) {\r\n      let graphic: Graphic;\r\n      if (member instanceof Graphic) {\r\n        graphic = member;\r\n      } else {\r\n        graphic = member.graphic;\r\n        member.offset.clone(pos);\r\n      }\r\n      if (!graphic) {\r\n        continue;\r\n      }\r\n      ex.save();\r\n      ex.translate(x, y);\r\n      graphic.draw(ex, pos.x, pos.y);\r\n      if (this.showDebug) {\r\n        /* istanbul ignore next */\r\n        ex.debug.drawRect(0, 0, this.width, this.height);\r\n      }\r\n      ex.restore();\r\n    }\r\n  }\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { watch } from '../Util/Watch';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { omit } from '../Util/Util';\r\n\r\nexport interface RasterOptions extends GraphicOptions {\r\n  /**\r\n   * Optionally specify a quality number, which is how much to scale the internal Raster. Default is 1.\r\n   *\r\n   * For example if the quality is set to 2, it doubles the internal raster bitmap in memory.\r\n   *\r\n   * Adjusting this value can be useful if you are working with small rasters.\r\n   */\r\n  quality?: number;\r\n  /**\r\n   * Optionally specify \"smoothing\" if you want antialiasing to apply to the raster's bitmap context, by default `false`\r\n   */\r\n  smoothing?: boolean;\r\n\r\n  /**\r\n   * Optionally specify the color of the raster's bitmap context, by default {@apilink Color.Black}\r\n   */\r\n  color?: Color;\r\n\r\n  /**\r\n   * Optionally specify the stroke color of the raster's bitmap context, by default undefined\r\n   */\r\n  strokeColor?: Color;\r\n\r\n  /**\r\n   * Optionally specify the line width of the raster's bitmap, by default 1 pixel\r\n   */\r\n  lineWidth?: number;\r\n\r\n  /**\r\n   * Optionally specify the line dash of the raster's bitmap, by default `[]` which means none\r\n   */\r\n  lineDash?: number[];\r\n\r\n  /**\r\n   * Optionally specify the line end style, default is \"butt\".\r\n   */\r\n  lineCap?: 'butt' | 'round' | 'square';\r\n\r\n  /**\r\n   * Optionally specify the padding to apply to the bitmap\r\n   */\r\n  padding?: number;\r\n\r\n  /**\r\n   * Optionally specify what image filtering mode should be used, {@apilink ImageFiltering.Pixel} for pixel art,\r\n   * {@apilink ImageFiltering.Blended} for hi-res art\r\n   *\r\n   * By default unset, rasters defer to the engine antialiasing setting\r\n   */\r\n  filtering?: ImageFiltering;\r\n}\r\n\r\n/**\r\n * A Raster is a Graphic that needs to be first painted to a HTMLCanvasElement before it can be drawn to the\r\n * {@apilink ExcaliburGraphicsContext}. This is useful for generating custom images using the 2D canvas api.\r\n *\r\n * Implementors must implement the {@apilink Raster.execute} method to rasterize their drawing.\r\n */\r\nexport abstract class Raster extends Graphic {\r\n  public filtering?: ImageFiltering;\r\n  public lineCap: 'butt' | 'round' | 'square' = 'butt';\r\n  public quality: number = 1;\r\n\r\n  public _bitmap: HTMLCanvasElement;\r\n  protected _ctx: CanvasRenderingContext2D;\r\n  private _dirty: boolean = true;\r\n\r\n  constructor(options?: RasterOptions) {\r\n    super(omit({ ...options }, ['width', 'height'])); // rasters do some special sauce with width/height\r\n    if (options) {\r\n      this.quality = options.quality ?? this.quality;\r\n      this.color = options.color ?? Color.Black;\r\n      this.strokeColor = options?.strokeColor;\r\n      this.smoothing = options.smoothing ?? this.smoothing;\r\n      this.lineWidth = options.lineWidth ?? this.lineWidth;\r\n      this.lineDash = options.lineDash ?? this.lineDash;\r\n      this.lineCap = options.lineCap ?? this.lineCap;\r\n      this.padding = options.padding ?? this.padding;\r\n      this.filtering = options.filtering ?? this.filtering;\r\n    }\r\n    this._bitmap = document.createElement('canvas');\r\n    // get the default canvas width/height as a fallback\r\n    const bitmapWidth = options?.width ?? this._bitmap.width;\r\n    const bitmapHeight = options?.height ?? this._bitmap.height;\r\n    this.width = bitmapWidth;\r\n    this.height = bitmapHeight;\r\n    const maybeCtx = this._bitmap.getContext('2d');\r\n    if (!maybeCtx) {\r\n      /* istanbul ignore next */\r\n      throw new Error('Browser does not support 2d canvas drawing, cannot create Raster graphic');\r\n    } else {\r\n      this._ctx = maybeCtx;\r\n    }\r\n  }\r\n\r\n  public cloneRasterOptions(): RasterOptions {\r\n    return {\r\n      color: this.color ? this.color.clone() : undefined,\r\n      strokeColor: this.strokeColor ? this.strokeColor.clone() : undefined,\r\n      smoothing: this.smoothing,\r\n      lineWidth: this.lineWidth,\r\n      lineDash: this.lineDash,\r\n      lineCap: this.lineCap,\r\n      quality: this.quality,\r\n      padding: this.padding\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Gets whether the graphic is dirty, this means there are changes that haven't been re-rasterized\r\n   */\r\n  public get dirty() {\r\n    return this._dirty;\r\n  }\r\n\r\n  /**\r\n   * Flags the graphic as dirty, meaning it must be re-rasterized before draw.\r\n   * This should be called any time the graphics state changes such that it affects the outputted drawing\r\n   */\r\n  public flagDirty() {\r\n    this._dirty = true;\r\n  }\r\n\r\n  private _originalWidth?: number;\r\n  /**\r\n   * Gets or sets the current width of the Raster graphic. Setting the width will cause the raster\r\n   * to be flagged dirty causing a re-raster on the next draw.\r\n   *\r\n   * Any `padding`s or `quality` set will be factored into the width\r\n   */\r\n  public get width() {\r\n    return Math.abs(this._getTotalWidth() * this.scale.x);\r\n  }\r\n  public set width(value: number) {\r\n    value /= Math.abs(this.scale.x);\r\n    this._bitmap.width = value;\r\n    this._originalWidth = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _originalHeight?: number;\r\n  /**\r\n   * Gets or sets the current height of the Raster graphic. Setting the height will cause the raster\r\n   * to be flagged dirty causing a re-raster on the next draw.\r\n   *\r\n   * Any `padding` or `quality` set will be factored into the height\r\n   */\r\n  public get height() {\r\n    return Math.abs(this._getTotalHeight() * this.scale.y);\r\n  }\r\n\r\n  public set height(value: number) {\r\n    value /= Math.abs(this.scale.y);\r\n    this._bitmap.height = value;\r\n    this._originalHeight = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _getTotalWidth() {\r\n    return ((this._originalWidth ?? this._bitmap.width) + this.padding * 2) * 1;\r\n  }\r\n\r\n  private _getTotalHeight() {\r\n    return ((this._originalHeight ?? this._bitmap.height) + this.padding * 2) * 1;\r\n  }\r\n\r\n  /**\r\n   * Returns the local bounds of the Raster including the padding\r\n   */\r\n  public get localBounds() {\r\n    return BoundingBox.fromDimension(this._getTotalWidth() * this.scale.x, this._getTotalHeight() * this.scale.y, Vector.Zero);\r\n  }\r\n\r\n  private _smoothing: boolean = false;\r\n  /**\r\n   * Gets or sets the smoothing (anti-aliasing of the graphic). Setting the height will cause the raster\r\n   * to be flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get smoothing() {\r\n    return this._smoothing;\r\n  }\r\n  public set smoothing(value: boolean) {\r\n    this._smoothing = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _color: Color = watch(Color.Black, () => this.flagDirty());\r\n  /**\r\n   * Gets or sets the fillStyle of the Raster graphic. Setting the fillStyle will cause the raster to be\r\n   * flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get color() {\r\n    return this._color;\r\n  }\r\n  public set color(value) {\r\n    this.flagDirty();\r\n    this._color = watch(value, () => this.flagDirty());\r\n  }\r\n\r\n  private _strokeColor: Color | undefined;\r\n  /**\r\n   * Gets or sets the strokeStyle of the Raster graphic. Setting the strokeStyle will cause the raster to be\r\n   * flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get strokeColor() {\r\n    return this._strokeColor;\r\n  }\r\n  public set strokeColor(value: Color | undefined) {\r\n    this.flagDirty();\r\n    if (value) {\r\n      this._strokeColor = watch(value, () => this.flagDirty());\r\n    }\r\n  }\r\n\r\n  private _lineWidth: number = 1;\r\n  /**\r\n   * Gets or sets the line width of the Raster graphic. Setting the lineWidth will cause the raster to be\r\n   * flagged dirty causing a re-raster on the next draw.\r\n   */\r\n  public get lineWidth() {\r\n    return this._lineWidth;\r\n  }\r\n  public set lineWidth(value) {\r\n    this._lineWidth = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _lineDash: number[] = [];\r\n  public get lineDash() {\r\n    return this._lineDash;\r\n  }\r\n\r\n  public set lineDash(value) {\r\n    this._lineDash = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _padding: number = 0;\r\n  public get padding() {\r\n    return this._padding;\r\n  }\r\n\r\n  public set padding(value: number) {\r\n    this._padding = value;\r\n    this.flagDirty();\r\n  }\r\n\r\n  /**\r\n   * Rasterize the graphic to a bitmap making it usable as in excalibur. Rasterize is called automatically if\r\n   * the graphic is {@apilink Raster.dirty} on the next {@apilink Graphic.draw} call\r\n   */\r\n  public rasterize(): void {\r\n    this._dirty = false;\r\n    this._ctx.clearRect(0, 0, this._getTotalWidth(), this._getTotalHeight());\r\n    this._ctx.save();\r\n    this._applyRasterProperties(this._ctx);\r\n    this.execute(this._ctx);\r\n    this._ctx.restore();\r\n  }\r\n\r\n  protected _applyRasterProperties(ctx: CanvasRenderingContext2D) {\r\n    this._bitmap.width = this._getTotalWidth() * this.quality;\r\n    this._bitmap.height = this._getTotalHeight() * this.quality;\r\n    // Do a bad thing to pass the filtering as an attribute\r\n    this._bitmap.setAttribute('filtering', this.filtering as any);\r\n    this._bitmap.setAttribute('forceUpload', 'true');\r\n    ctx.scale(this.quality, this.quality);\r\n    ctx.translate(this.padding, this.padding);\r\n    ctx.imageSmoothingEnabled = this.smoothing;\r\n    ctx.lineWidth = this.lineWidth;\r\n    ctx.setLineDash(this.lineDash ?? ctx.getLineDash());\r\n    ctx.lineCap = this.lineCap;\r\n    ctx.strokeStyle = this.strokeColor?.toString() ?? '';\r\n    ctx.fillStyle = this.color?.toString();\r\n  }\r\n\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    if (this._dirty) {\r\n      this.rasterize();\r\n    }\r\n    ex.scale(1 / this.quality, 1 / this.quality);\r\n    ex.drawImage(this._bitmap, x, y);\r\n  }\r\n\r\n  /**\r\n   * Executes drawing implementation of the graphic, this is where the specific drawing code for the graphic\r\n   * should be implemented. Once `rasterize()` the graphic can be drawn to the {@apilink ExcaliburGraphicsContext} via `draw(...)`\r\n   * @param ctx Canvas to draw the graphic to\r\n   */\r\n  abstract execute(ctx: CanvasRenderingContext2D): void;\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\n\r\n/**\r\n * Enum representing the different font size units\r\n * https://developer.mozilla.org/en-US/docs/Web/CSS/font-size\r\n */\r\nexport enum FontUnit {\r\n  /**\r\n   * Em is a scalable unit, 1 em is equal to the current font size of the current element, parent elements can effect em values\r\n   */\r\n  Em = 'em',\r\n  /**\r\n   * Rem is similar to the Em, it is a scalable unit. 1 rem is equal to the font size of the root element\r\n   */\r\n  Rem = 'rem',\r\n  /**\r\n   * Pixel is a unit of length in screen pixels\r\n   */\r\n  Px = 'px',\r\n  /**\r\n   * Point is a physical unit length (1/72 of an inch)\r\n   */\r\n  Pt = 'pt',\r\n  /**\r\n   * Percent is a scalable unit similar to Em, the only difference is the Em units scale faster when Text-Size stuff\r\n   */\r\n  Percent = '%'\r\n}\r\n\r\n/**\r\n * Enum representing the different horizontal text alignments\r\n */\r\nexport enum TextAlign {\r\n  /**\r\n   * The text is left-aligned.\r\n   */\r\n  Left = 'left',\r\n  /**\r\n   * The text is right-aligned.\r\n   */\r\n  Right = 'right',\r\n  /**\r\n   * The text is centered.\r\n   */\r\n  Center = 'center',\r\n  /**\r\n   * The text is aligned at the normal start of the line (left-aligned for left-to-right locales,\r\n   * right-aligned for right-to-left locales).\r\n   */\r\n  Start = 'start',\r\n  /**\r\n   * The text is aligned at the normal end of the line (right-aligned for left-to-right locales,\r\n   * left-aligned for right-to-left locales).\r\n   */\r\n  End = 'end'\r\n}\r\n\r\n/**\r\n * Enum representing the different baseline text alignments\r\n */\r\nexport enum BaseAlign {\r\n  /**\r\n   * The text baseline is the top of the em square.\r\n   */\r\n  Top = 'top',\r\n  /**\r\n   * The text baseline is the hanging baseline.  Currently unsupported; this will act like\r\n   * alphabetic.\r\n   */\r\n  Hanging = 'hanging',\r\n  /**\r\n   * The text baseline is the middle of the em square.\r\n   */\r\n  Middle = 'middle',\r\n  /**\r\n   * The text baseline is the normal alphabetic baseline.\r\n   */\r\n  Alphabetic = 'alphabetic',\r\n  /**\r\n   * The text baseline is the ideographic baseline; this is the bottom of\r\n   * the body of the characters, if the main body of characters protrudes\r\n   * beneath the alphabetic baseline.  Currently unsupported; this will\r\n   * act like alphabetic.\r\n   */\r\n  Ideographic = 'ideographic',\r\n  /**\r\n   * The text baseline is the bottom of the bounding box.  This differs\r\n   * from the ideographic baseline in that the ideographic baseline\r\n   * doesn't consider descenders.\r\n   */\r\n  Bottom = 'bottom'\r\n}\r\n\r\n/**\r\n * Enum representing the different possible font styles\r\n */\r\nexport enum FontStyle {\r\n  Normal = 'normal',\r\n  Italic = 'italic',\r\n  Oblique = 'oblique'\r\n}\r\n\r\n/**\r\n * Enum representing the text direction, useful for other languages, or writing text in reverse\r\n */\r\nexport enum Direction {\r\n  LeftToRight = 'ltr',\r\n  RightToLeft = 'rtl'\r\n}\r\n\r\n/**\r\n * Font rendering option\r\n */\r\nexport interface FontOptions {\r\n  /**\r\n   * Optionally the size of the font in the specified {@apilink FontUnit} by default 10.\r\n   */\r\n  size?: number;\r\n  /**\r\n   * Optionally specify unit to measure fonts in, by default Pixels\r\n   */\r\n  unit?: FontUnit;\r\n  /**\r\n   * Optionally specify the font family, by default 'sans-serif'\r\n   */\r\n  family?: string;\r\n  /**\r\n   * Optionally specify the font style, by default Normal\r\n   */\r\n  style?: FontStyle;\r\n  /**\r\n   * Optionally set whether the font is bold, by default false\r\n   */\r\n  bold?: boolean;\r\n  /**\r\n   * Optionally specify the text align, by default Left\r\n   */\r\n  textAlign?: TextAlign;\r\n  /**\r\n   * Optionally specify the text base align, by default Alphabetic\r\n   */\r\n  baseAlign?: BaseAlign;\r\n  /**\r\n   * Optionally specify the text direction, by default LeftToRight\r\n   */\r\n  direction?: Direction;\r\n  /**\r\n   * Optionally override the text line height in pixels, useful for multiline text. If unset will use default.\r\n   */\r\n  lineHeight?: number | undefined;\r\n  /**\r\n   * Optionally specify the quality of the text bitmap, it is a multiplier on the size size, by default 2.\r\n   * Higher quality text has a higher memory impact\r\n   */\r\n  quality?: number;\r\n  /**\r\n   * Optionally specify a text shadow, by default none is specified\r\n   */\r\n  shadow?: {\r\n    blur?: number;\r\n    offset?: Vector;\r\n    color?: Color;\r\n  };\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface FontRenderer {\r\n  measureText(text: string): BoundingBox;\r\n  render(ex: ExcaliburGraphicsContext, text: string, color: Color, x: number, y: number): void;\r\n}\r\n","import { Scene } from './Scene';\r\nimport { Vector } from './Math/vector';\r\nimport { Actor } from './Actor';\r\nimport { Trigger } from './Trigger';\r\nimport { FrameStats } from './Debug';\r\nimport { Engine } from './Engine';\r\nimport { TileMap } from './TileMap';\r\nimport { Side } from './Collision/Side';\r\nimport { CollisionContact } from './Collision/Detection/CollisionContact';\r\nimport { Collider } from './Collision/Colliders/Collider';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { OnInitialize, OnPreUpdate, OnPostUpdate, SceneActivationContext, OnAdd, OnRemove } from './Interfaces/LifecycleEvents';\r\nimport { ExcaliburGraphicsContext } from './Graphics';\r\nimport { Axes, Buttons, Gamepad } from './Input/Gamepad';\r\nimport { Action } from './Actions/Action';\r\n\r\nexport enum EventTypes {\r\n  Kill = 'kill',\r\n  PreKill = 'prekill',\r\n  PostKill = 'postkill',\r\n\r\n  PreDraw = 'predraw',\r\n  PostDraw = 'postdraw',\r\n\r\n  PreDebugDraw = 'predebugdraw',\r\n  PostDebugDraw = 'postdebugdraw',\r\n\r\n  PreUpdate = 'preupdate',\r\n  PostUpdate = 'postupdate',\r\n\r\n  PreFrame = 'preframe',\r\n  PostFrame = 'postframe',\r\n\r\n  PreCollision = 'precollision',\r\n  CollisionStart = 'collisionstart',\r\n  CollisionEnd = 'collisionend',\r\n  PostCollision = 'postcollision',\r\n\r\n  Initialize = 'initialize',\r\n  Activate = 'activate',\r\n  Deactivate = 'deactivate',\r\n\r\n  ExitViewport = 'exitviewport',\r\n  EnterViewport = 'enterviewport',\r\n\r\n  ExitTrigger = 'exit',\r\n  EnterTrigger = 'enter',\r\n\r\n  Connect = 'connect',\r\n  Disconnect = 'disconnect',\r\n  Button = 'button',\r\n  Axis = 'axis',\r\n\r\n  Visible = 'visible',\r\n  Hidden = 'hidden',\r\n  Start = 'start',\r\n  Stop = 'stop',\r\n\r\n  PointerUp = 'pointerup',\r\n  PointerDown = 'pointerdown',\r\n  PointerMove = 'pointermove',\r\n  PointerEnter = 'pointerenter',\r\n  PointerLeave = 'pointerleave',\r\n  PointerCancel = 'pointercancel',\r\n  PointerWheel = 'pointerwheel',\r\n\r\n  Up = 'up',\r\n  Down = 'down',\r\n  Move = 'move',\r\n  Enter = 'enter',\r\n  Leave = 'leave',\r\n  Cancel = 'cancel',\r\n  Wheel = 'wheel',\r\n\r\n  Press = 'press',\r\n  Release = 'release',\r\n  Hold = 'hold',\r\n\r\n  PointerDragStart = 'pointerdragstart',\r\n  PointerDragEnd = 'pointerdragend',\r\n  PointerDragEnter = 'pointerdragenter',\r\n  PointerDragLeave = 'pointerdragleave',\r\n  PointerDragMove = 'pointerdragmove',\r\n\r\n  ActionStart = 'actionstart',\r\n  ActionComplete = 'actioncomplete',\r\n\r\n  Add = 'add',\r\n  Remove = 'remove'\r\n}\r\n\r\n/* istanbul ignore next */\r\n/* compiler only: these are internal to lib */\r\nexport type kill = 'kill';\r\nexport type prekill = 'prekill';\r\nexport type postkill = 'postkill';\r\n\r\nexport type predraw = 'predraw';\r\nexport type postdraw = 'postdraw';\r\n\r\nexport type predebugdraw = 'predebugdraw';\r\nexport type postdebugdraw = 'postdebugdraw';\r\n\r\nexport type preupdate = 'preupdate';\r\nexport type postupdate = 'postupdate';\r\n\r\nexport type preframe = 'preframe';\r\nexport type postframe = 'postframe';\r\n\r\nexport type precollision = 'precollision';\r\nexport type collisionstart = 'collisionstart';\r\nexport type collisionend = 'collisionend';\r\nexport type postcollision = 'postcollision';\r\n\r\nexport type initialize = 'initialize';\r\nexport type activate = 'activate';\r\nexport type deactivate = 'deactivate';\r\n\r\nexport type exitviewport = 'exitviewport';\r\nexport type enterviewport = 'enterviewport';\r\n\r\nexport type exittrigger = 'exit';\r\nexport type entertrigger = 'enter';\r\n\r\nexport type connect = 'connect';\r\nexport type disconnect = 'disconnect';\r\nexport type button = 'button';\r\nexport type axis = 'axis';\r\n\r\nexport type subscribe = 'subscribe';\r\nexport type unsubscribe = 'unsubscribe';\r\n\r\nexport type visible = 'visible';\r\nexport type hidden = 'hidden';\r\nexport type start = 'start';\r\nexport type stop = 'stop';\r\n\r\nexport type pointerup = 'pointerup';\r\nexport type pointerdown = 'pointerdown';\r\nexport type pointermove = 'pointermove';\r\nexport type pointerenter = 'pointerenter';\r\nexport type pointerleave = 'pointerleave';\r\nexport type pointercancel = 'pointercancel';\r\nexport type pointerwheel = 'pointerwheel';\r\n\r\nexport type up = 'up';\r\nexport type down = 'down';\r\nexport type move = 'move';\r\nexport type enter = 'enter';\r\nexport type leave = 'leave';\r\nexport type cancel = 'cancel';\r\nexport type wheel = 'wheel';\r\n\r\nexport type press = 'press';\r\nexport type release = 'release';\r\nexport type hold = 'hold';\r\n\r\nexport type pointerdragstart = 'pointerdragstart';\r\nexport type pointerdragend = 'pointerdragend';\r\nexport type pointerdragenter = 'pointerdragenter';\r\nexport type pointerdragleave = 'pointerdragleave';\r\nexport type pointerdragmove = 'pointerdragmove';\r\n\r\nexport type add = 'add';\r\nexport type remove = 'remove';\r\n\r\n/**\r\n * Base event type in Excalibur that all other event types derive from. Not all event types are thrown on all Excalibur game objects,\r\n * some events are unique to a type, others are not.\r\n *\r\n */\r\nexport class GameEvent<T, U = T> {\r\n  /**\r\n   * Target object for this event.\r\n   */\r\n  public target: T;\r\n\r\n  /**\r\n   * Other target object for this event\r\n   */\r\n  public other: U | null = null;\r\n\r\n  /**\r\n   * If set to false, prevents event from propagating to other actors. If true it will be propagated\r\n   * to all actors that apply.\r\n   */\r\n  public get bubbles(): boolean {\r\n    return this._bubbles;\r\n  }\r\n\r\n  public set bubbles(value: boolean) {\r\n    this._bubbles = value;\r\n  }\r\n\r\n  private _bubbles: boolean = true;\r\n  /**\r\n   * Prevents event from bubbling\r\n   */\r\n  public stopPropagation() {\r\n    this.bubbles = false;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'kill' event is emitted on actors when it is killed. The target is the actor that was killed.\r\n */\r\nexport class KillEvent extends GameEvent<Entity> {\r\n  constructor(public self: Entity) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'prekill' event is emitted directly before an actor is killed.\r\n */\r\nexport class PreKillEvent extends GameEvent<Actor> {\r\n  constructor(public self: Actor) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postkill' event is emitted directly after the actor is killed.\r\n */\r\nexport class PostKillEvent extends GameEvent<Actor> {\r\n  constructor(public self: Actor) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'start' event is emitted on engine when has started and is ready for interaction.\r\n */\r\nexport class GameStartEvent extends GameEvent<Engine> {\r\n  constructor(public self: Engine) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'stop' event is emitted on engine when has been stopped and will no longer take input, update or draw.\r\n */\r\nexport class GameStopEvent extends GameEvent<Engine> {\r\n  constructor(public self: Engine) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'predraw' event is emitted on actors, scenes, and engine before drawing starts. Actors' predraw happens inside their graphics\r\n * transform so that all drawing takes place with the actor as the origin.\r\n *\r\n */\r\nexport class PreDrawEvent extends GameEvent<Entity | Scene | Engine | TileMap> {\r\n  constructor(\r\n    public ctx: ExcaliburGraphicsContext,\r\n    public elapsed: number,\r\n    public self: Entity | Scene | Engine | TileMap\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postdraw' event is emitted on actors, scenes, and engine after drawing finishes. Actors' postdraw happens inside their graphics\r\n * transform so that all drawing takes place with the actor as the origin.\r\n *\r\n */\r\nexport class PostDrawEvent extends GameEvent<Entity | Scene | Engine | TileMap> {\r\n  constructor(\r\n    public ctx: ExcaliburGraphicsContext,\r\n    public elapsed: number,\r\n    public self: Entity | Scene | Engine | TileMap\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'pretransformdraw' event is emitted on actors/entities before any graphics transforms have taken place.\r\n * Useful if you need to completely customize the draw or modify the transform before drawing in the draw step (for example needing\r\n * latest camera positions)\r\n *\r\n */\r\nexport class PreTransformDrawEvent extends GameEvent<Entity> {\r\n  constructor(\r\n    public ctx: ExcaliburGraphicsContext,\r\n    public elapsed: number,\r\n    public self: Entity\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'posttransformdraw' event is emitted on actors/entities after all graphics have been draw and transforms reset.\r\n * Useful if you need to completely custom the draw after everything is done.\r\n *\r\n */\r\nexport class PostTransformDrawEvent extends GameEvent<Entity> {\r\n  constructor(\r\n    public ctx: ExcaliburGraphicsContext,\r\n    public elapsed: number,\r\n    public self: Entity\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'predebugdraw' event is emitted on actors, scenes, and engine before debug drawing starts.\r\n */\r\nexport class PreDebugDrawEvent extends GameEvent<Entity | Actor | Scene | Engine> {\r\n  constructor(\r\n    public ctx: ExcaliburGraphicsContext,\r\n    public self: Entity | Actor | Scene | Engine\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postdebugdraw' event is emitted on actors, scenes, and engine after debug drawing starts.\r\n */\r\nexport class PostDebugDrawEvent extends GameEvent<Entity | Actor | Scene | Engine> {\r\n  constructor(\r\n    public ctx: ExcaliburGraphicsContext,\r\n    public self: Entity | Actor | Scene | Engine\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'preupdate' event is emitted on actors, scenes, camera, and engine before the update starts.\r\n */\r\nexport class PreUpdateEvent<T extends OnPreUpdate = Entity> extends GameEvent<T> {\r\n  constructor(\r\n    public engine: Engine,\r\n    public elapsed: number,\r\n    public self: T\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postupdate' event is emitted on actors, scenes, camera, and engine after the update ends.\r\n */\r\nexport class PostUpdateEvent<T extends OnPostUpdate = Entity> extends GameEvent<T> {\r\n  constructor(\r\n    public engine: Engine,\r\n    public elapsed: number,\r\n    public self: T\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'preframe' event is emitted on the engine, before the frame begins.\r\n */\r\nexport class PreFrameEvent extends GameEvent<Engine> {\r\n  constructor(\r\n    public engine: Engine,\r\n    public prevStats: FrameStats\r\n  ) {\r\n    super();\r\n    this.target = engine;\r\n  }\r\n}\r\n\r\n/**\r\n * The 'postframe' event is emitted on the engine, after a frame ends.\r\n */\r\nexport class PostFrameEvent extends GameEvent<Engine> {\r\n  constructor(\r\n    public engine: Engine,\r\n    public stats: FrameStats\r\n  ) {\r\n    super();\r\n    this.target = engine;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received when a gamepad is connected to Excalibur. {@apilink Gamepads} receives this event.\r\n */\r\nexport class GamepadConnectEvent extends GameEvent<Gamepad> {\r\n  constructor(\r\n    public index: number,\r\n    public gamepad: Gamepad\r\n  ) {\r\n    super();\r\n    this.target = gamepad;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received when a gamepad is disconnected from Excalibur. {@apilink Gamepads} receives this event.\r\n */\r\nexport class GamepadDisconnectEvent extends GameEvent<Gamepad> {\r\n  constructor(\r\n    public index: number,\r\n    public gamepad: Gamepad\r\n  ) {\r\n    super();\r\n    this.target = gamepad;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad button event. See {@apilink Gamepads} for information on responding to controller input. {@apilink Gamepad} instances receive this event;\r\n */\r\nexport class GamepadButtonEvent extends GameEvent<Gamepad> {\r\n  /**\r\n   * @param button  The Gamepad {@apilink Buttons} if not known by excalibur {@apilink Buttons.Unknown} is returned, use index to disambiguate.\r\n   * @param index   The canonical index of the gamepad button from the system\r\n   * @param value   A numeric value between 0 and 1\r\n   * @param self    Reference to the gamepad\r\n   */\r\n  constructor(\r\n    /**\r\n     * The Gamepad {@apilink Buttons} if not known by excalibur {@apilink Buttons.Unknown} is returned, use index to disambiguate.\r\n     */\r\n    public button: Buttons,\r\n    /**\r\n     * The canonical index of the gamepad button from the system\r\n     */\r\n    public index: number,\r\n    /**\r\n     * A numeric value between 0 and 1\r\n     */\r\n    public value: number,\r\n    /**\r\n     * Reference to the gamepad\r\n     */\r\n    public self: Gamepad\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad axis event. See {@apilink Gamepads} for information on responding to controller input. {@apilink Gamepad} instances receive this event;\r\n */\r\nexport class GamepadAxisEvent extends GameEvent<Gamepad> {\r\n  /**\r\n   * @param axis  The Gamepad axis\r\n   * @param value A numeric value between -1 and 1\r\n   * @param self Reference to the gamepad\r\n   */\r\n  constructor(\r\n    /**\r\n     * The Gamepad {@apilink Axis}\r\n     */\r\n    public axis: Axes,\r\n    /**\r\n     * A numeric value between -1 and 1, 0 is the neutral axis position.\r\n     */\r\n    public value: number,\r\n    /**\r\n     * Reference to the gamepad\r\n     */\r\n    public self: Gamepad\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received by the {@apilink Engine} when the browser window is visible on a screen.\r\n */\r\nexport class VisibleEvent extends GameEvent<Engine> {\r\n  constructor(public self: Engine) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event received by the {@apilink Engine} when the browser window is hidden from all screens.\r\n */\r\nexport class HiddenEvent extends GameEvent<Engine> {\r\n  constructor(public self: Engine) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor | `actor`} when a collision will occur this frame if it resolves\r\n */\r\nexport class PreCollisionEvent<T extends Collider = Collider> extends GameEvent<T> {\r\n  /**\r\n   * @param self          The actor the event was thrown on\r\n   * @param other         The actor that will collided with the current actor\r\n   * @param side          The side that will be collided with the current actor\r\n   * @param intersection  Intersection vector\r\n   */\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public intersection: Vector,\r\n    public contact: CollisionContact\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor | `actor`} when a collision has been resolved (body reacted) this frame\r\n */\r\nexport class PostCollisionEvent<T extends Collider = Collider> extends GameEvent<T> {\r\n  /**\r\n   * @param self          The actor the event was thrown on\r\n   * @param other         The actor that did collide with the current actor\r\n   * @param side          The side that did collide with the current actor\r\n   * @param intersection  Intersection vector\r\n   */\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public intersection: Vector,\r\n    public contact: CollisionContact\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\nexport class ContactStartEvent<T extends Collider = Collider> {\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public contact: CollisionContact\r\n  ) {}\r\n}\r\n\r\nexport class ContactEndEvent<T extends Collider = Collider> {\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public lastContact: CollisionContact\r\n  ) {}\r\n}\r\n\r\nexport class CollisionPreSolveEvent<T extends Collider = Collider> {\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public intersection: Vector,\r\n    public contact: CollisionContact\r\n  ) {}\r\n}\r\n\r\nexport class CollisionPostSolveEvent<T extends Collider = Collider> {\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public intersection: Vector,\r\n    public contact: CollisionContact\r\n  ) {}\r\n}\r\n\r\n/**\r\n * Event thrown the first time an {@apilink Actor | `actor`} collides with another, after an actor is in contact normal collision events are fired.\r\n */\r\nexport class CollisionStartEvent<T extends Collider = Collider> extends GameEvent<T> {\r\n  /**\r\n   *\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public contact: CollisionContact\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown when the {@apilink Actor | `actor`} is no longer colliding with another\r\n */\r\nexport class CollisionEndEvent<T extends Collider = Collider> extends GameEvent<T> {\r\n  /**\r\n   *\r\n   */\r\n  constructor(\r\n    public self: T,\r\n    public other: T,\r\n    public side: Side,\r\n    public lastContact: CollisionContact\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor}, {@apilink Scene}, and {@apilink Engine} only once before the first update call\r\n */\r\nexport class InitializeEvent<T extends OnInitialize = Entity> extends GameEvent<T> {\r\n  /**\r\n   * @param engine  The reference to the current engine\r\n   */\r\n  constructor(\r\n    public engine: Engine,\r\n    public self: T\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on a {@apilink Scene} on activation\r\n */\r\nexport class ActivateEvent<TData = undefined> extends GameEvent<Scene> {\r\n  /**\r\n   * @param context  The context for the scene activation\r\n   */\r\n  constructor(\r\n    public context: SceneActivationContext<TData>,\r\n    public self: Scene\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on a {@apilink Scene} on deactivation\r\n */\r\nexport class DeactivateEvent extends GameEvent<Scene> {\r\n  /**\r\n   * @param context  The context for the scene deactivation\r\n   */\r\n  constructor(\r\n    public context: SceneActivationContext<never>,\r\n    public self: Scene\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor} when the graphics bounds completely leaves the screen.\r\n */\r\nexport class ExitViewPortEvent extends GameEvent<Entity> {\r\n  constructor(public self: Entity) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor} when any part of the graphics bounds are on screen.\r\n */\r\nexport class EnterViewPortEvent extends GameEvent<Entity> {\r\n  constructor(public self: Entity) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\nexport class EnterTriggerEvent extends GameEvent<Trigger> {\r\n  constructor(\r\n    public self: Trigger,\r\n    public entity: Entity\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\nexport class ExitTriggerEvent extends GameEvent<Trigger> {\r\n  constructor(\r\n    public self: Trigger,\r\n    public entity: Entity\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor} when an action starts.\r\n */\r\nexport class ActionStartEvent extends GameEvent<Entity> {\r\n  constructor(\r\n    public action: Action,\r\n    public self: Entity\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an {@apilink Actor} when an action completes.\r\n */\r\nexport class ActionCompleteEvent extends GameEvent<Entity> {\r\n  constructor(\r\n    public action: Action,\r\n    public self: Entity\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when an Actor added to scene.\r\n */\r\nexport class AddEvent<T extends OnAdd> extends GameEvent<T> {\r\n  constructor(\r\n    public engine: Engine,\r\n    public self: T\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n\r\n/**\r\n * Event thrown on an [[Actor]] when an Actor removed from scene.\r\n */\r\nexport class RemoveEvent<T extends OnRemove> extends GameEvent<T> {\r\n  constructor(\r\n    public engine: Engine,\r\n    public self: T\r\n  ) {\r\n    super();\r\n    this.target = self;\r\n  }\r\n}\r\n","import { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\n\r\n/**\r\n * A canvas linecap style. \"butt\" is the default flush style, \"round\" is a semi-circle cap with a radius half the width of\r\n * the line, and \"square\" is a rectangle that is an equal width and half height cap.\r\n */\r\nexport type LineCapStyle = 'butt' | 'round' | 'square';\r\n\r\n/* istanbul ignore next */\r\n/**\r\n * Draw a line on canvas context\r\n * @param ctx The canvas context\r\n * @param color The color of the line\r\n * @param x1 The start x coordinate\r\n * @param y1 The start y coordinate\r\n * @param x2 The ending x coordinate\r\n * @param y2 The ending y coordinate\r\n * @param thickness The line thickness\r\n * @param cap The {@apilink LineCapStyle} (butt, round, or square)\r\n */\r\nexport function line(\r\n  ctx: CanvasRenderingContext2D,\r\n  color: Color = Color.Red,\r\n  x1: number,\r\n  y1: number,\r\n  x2: number,\r\n  y2: number,\r\n  thickness: number = 1,\r\n  cap: LineCapStyle = 'butt'\r\n) {\r\n  ctx.save();\r\n  ctx.beginPath();\r\n  ctx.lineWidth = thickness;\r\n  ctx.lineCap = cap;\r\n  ctx.strokeStyle = color.toString();\r\n  ctx.moveTo(x1, y1);\r\n  ctx.lineTo(x2, y2);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n  ctx.restore();\r\n}\r\n\r\n/* istanbul ignore next */\r\n/**\r\n * Draw the vector as a point onto the canvas.\r\n */\r\nexport function point(ctx: CanvasRenderingContext2D, color: Color = Color.Red, point: Vector): void {\r\n  ctx.beginPath();\r\n  ctx.strokeStyle = color.toString();\r\n  ctx.arc(point.x, point.y, 5, 0, Math.PI * 2);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n}\r\n\r\n/**\r\n * Draw the vector as a line onto the canvas starting a origin point.\r\n */\r\n/* istanbul ignore next */\r\n/**\r\n *\r\n */\r\nexport function vector(ctx: CanvasRenderingContext2D, color: Color, origin: Vector, vector: Vector, scale: number = 1.0): void {\r\n  const c = color ? color.toString() : 'blue';\r\n  const v = vector.scale(scale);\r\n  ctx.beginPath();\r\n  ctx.strokeStyle = c;\r\n  ctx.moveTo(origin.x, origin.y);\r\n  ctx.lineTo(origin.x + v.x, origin.y + v.y);\r\n  ctx.closePath();\r\n  ctx.stroke();\r\n}\r\n\r\n/**\r\n * Represents border radius values\r\n */\r\nexport interface BorderRadius {\r\n  /**\r\n   * Top-left\r\n   */\r\n  tl: number;\r\n  /**\r\n   * Top-right\r\n   */\r\n  tr: number;\r\n  /**\r\n   * Bottom-right\r\n   */\r\n  br: number;\r\n  /**\r\n   * Bottom-left\r\n   */\r\n  bl: number;\r\n}\r\n\r\n/**\r\n * Draw a round rectangle on a canvas context\r\n * @param ctx The canvas context\r\n * @param x The top-left x coordinate\r\n * @param y The top-left y coordinate\r\n * @param width The width of the rectangle\r\n * @param height The height of the rectangle\r\n * @param radius The border radius of the rectangle\r\n * @param stroke The {@apilink Color} to stroke rectangle with\r\n * @param fill The {@apilink Color} to fill rectangle with\r\n */\r\nexport function roundRect(\r\n  ctx: CanvasRenderingContext2D,\r\n  x: number,\r\n  y: number,\r\n  width: number,\r\n  height: number,\r\n  radius: number | BorderRadius = 5,\r\n  stroke: Color | null = Color.White,\r\n  fill: Color | null = null\r\n) {\r\n  let br: BorderRadius;\r\n\r\n  if (typeof radius === 'number') {\r\n    br = { tl: radius, tr: radius, br: radius, bl: radius };\r\n  } else {\r\n    const defaultRadius: BorderRadius = { tl: 0, tr: 0, br: 0, bl: 0 };\r\n\r\n    for (const prop in defaultRadius) {\r\n      if (defaultRadius.hasOwnProperty(prop)) {\r\n        const side = <keyof BorderRadius>prop;\r\n        br[side] = radius[side] || defaultRadius[side];\r\n      }\r\n    }\r\n  }\r\n\r\n  ctx.beginPath();\r\n  ctx.moveTo(x + br.tl, y);\r\n  ctx.lineTo(x + width - br.tr, y);\r\n  ctx.quadraticCurveTo(x + width, y, x + width, y + br.tr);\r\n  ctx.lineTo(x + width, y + height - br.br);\r\n  ctx.quadraticCurveTo(x + width, y + height, x + width - br.br, y + height);\r\n  ctx.lineTo(x + br.bl, y + height);\r\n  ctx.quadraticCurveTo(x, y + height, x, y + height - br.bl);\r\n  ctx.lineTo(x, y + br.tl);\r\n  ctx.quadraticCurveTo(x, y, x + br.tl, y);\r\n  ctx.closePath();\r\n\r\n  if (fill) {\r\n    ctx.fillStyle = fill.toString();\r\n    ctx.fill();\r\n  }\r\n\r\n  if (stroke) {\r\n    ctx.strokeStyle = stroke.toString();\r\n    ctx.stroke();\r\n  }\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function circle(\r\n  ctx: CanvasRenderingContext2D,\r\n  x: number,\r\n  y: number,\r\n  radius: number,\r\n  stroke: Color = Color.White,\r\n  fill: Color = null\r\n) {\r\n  ctx.beginPath();\r\n  ctx.arc(x, y, radius, 0, Math.PI * 2);\r\n  ctx.closePath();\r\n\r\n  if (fill) {\r\n    ctx.fillStyle = fill.toString();\r\n    ctx.fill();\r\n  }\r\n\r\n  if (stroke) {\r\n    ctx.strokeStyle = stroke.toString();\r\n    ctx.stroke();\r\n  }\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { line } from '../Util/DrawUtil';\r\nimport { ExcaliburGraphicsContextWebGL } from './Context/ExcaliburGraphicsContextWebGL';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Font } from './Font';\r\n\r\nexport class FontTextInstance {\r\n  public canvas: HTMLCanvasElement;\r\n  public ctx: CanvasRenderingContext2D;\r\n  private _textFragments: { x: number; y: number; canvas: HTMLCanvasElement }[] = [];\r\n  public dimensions: BoundingBox;\r\n  public disposed: boolean = false;\r\n  private _lastHashCode: string;\r\n\r\n  constructor(\r\n    public readonly font: Font,\r\n    public readonly text: string,\r\n    public readonly color: Color,\r\n    public readonly maxWidth?: number\r\n  ) {\r\n    this.canvas = document.createElement('canvas');\r\n    const ctx = this.canvas.getContext('2d');\r\n    if (!ctx) {\r\n      throw new Error('Unable to create FontTextInstance, internal canvas failed to create');\r\n    }\r\n    this.ctx = ctx;\r\n    this.dimensions = this.measureText(text);\r\n    this._setDimension(this.dimensions, this.ctx);\r\n    this._lastHashCode = this.getHashCode();\r\n  }\r\n\r\n  measureText(text: string, maxWidth?: number): BoundingBox {\r\n    if (this.disposed) {\r\n      throw Error('Accessing disposed text instance! ' + this.text);\r\n    }\r\n    let lines = null;\r\n    if (maxWidth != null) {\r\n      lines = this._getLinesFromText(text, maxWidth);\r\n    } else {\r\n      lines = text.split('\\n');\r\n    }\r\n\r\n    const maxWidthLine = lines.reduce((a, b) => {\r\n      return a.length > b.length ? a : b;\r\n    });\r\n\r\n    this._applyFont(this.ctx); // font must be applied to the context to measure it\r\n    const metrics = this.ctx.measureText(maxWidthLine);\r\n    let textHeight = Math.abs(metrics.actualBoundingBoxAscent) + Math.abs(metrics.actualBoundingBoxDescent);\r\n\r\n    // TODO line height makes the text bounds wonky\r\n    const lineAdjustedHeight = textHeight * lines.length;\r\n    textHeight = lineAdjustedHeight;\r\n    const bottomBounds = lineAdjustedHeight - Math.abs(metrics.actualBoundingBoxAscent);\r\n    const x = 0;\r\n    const y = 0;\r\n    const measurement = new BoundingBox({\r\n      left: x - Math.abs(metrics.actualBoundingBoxLeft) - this.font.padding,\r\n      top: y - Math.abs(metrics.actualBoundingBoxAscent) - this.font.padding,\r\n      bottom: y + bottomBounds + this.font.padding,\r\n      right: x + Math.abs(metrics.actualBoundingBoxRight) + this.font.padding\r\n    });\r\n\r\n    return measurement;\r\n  }\r\n\r\n  private _setDimension(textBounds: BoundingBox, bitmap: CanvasRenderingContext2D) {\r\n    let lineHeightRatio = 1;\r\n    if (this.font.lineHeight) {\r\n      lineHeightRatio = this.font.lineHeight / this.font.size;\r\n    }\r\n    // Changing the width and height clears the context properties\r\n    // We double the bitmap width to account for all possible alignment\r\n    // We scale by \"quality\" so we render text without jaggies\r\n    bitmap.canvas.width = (textBounds.width + this.font.padding * 2) * 2 * this.font.quality;\r\n    bitmap.canvas.height = (textBounds.height + this.font.padding * 2) * 2 * this.font.quality * lineHeightRatio;\r\n  }\r\n\r\n  public static getHashCode(font: Font, text: string, color?: Color) {\r\n    const hash =\r\n      text +\r\n      '__hashcode__' +\r\n      font.fontString +\r\n      font.showDebug +\r\n      font.textAlign +\r\n      font.baseAlign +\r\n      font.direction +\r\n      font.lineHeight +\r\n      JSON.stringify(font.shadow) +\r\n      (font.padding.toString() +\r\n        font.smoothing.toString() +\r\n        font.lineWidth.toString() +\r\n        font.lineDash.toString() +\r\n        font.strokeColor?.toString() +\r\n        (color ? color.toString() : font.color.toString()));\r\n    return hash;\r\n  }\r\n\r\n  getHashCode(includeColor: boolean = true) {\r\n    return FontTextInstance.getHashCode(this.font, this.text, includeColor ? this.color : undefined);\r\n  }\r\n\r\n  protected _applyRasterProperties(ctx: CanvasRenderingContext2D) {\r\n    ctx.translate(this.font.padding, this.font.padding);\r\n    ctx.imageSmoothingEnabled = this.font.smoothing;\r\n    ctx.lineWidth = this.font.lineWidth;\r\n    ctx.setLineDash(this.font.lineDash ?? ctx.getLineDash());\r\n    ctx.strokeStyle = this.font.strokeColor?.toString() ?? '';\r\n    ctx.fillStyle = this.color.toString();\r\n  }\r\n\r\n  private _applyFont(ctx: CanvasRenderingContext2D) {\r\n    ctx.resetTransform();\r\n    ctx.translate(this.font.padding + ctx.canvas.width / 2, this.font.padding + ctx.canvas.height / 2);\r\n    ctx.scale(this.font.quality, this.font.quality);\r\n    ctx.textAlign = this.font.textAlign;\r\n    ctx.textBaseline = this.font.baseAlign;\r\n    ctx.font = this.font.fontString;\r\n    ctx.direction = this.font.direction;\r\n\r\n    if (this.font.shadow) {\r\n      if (this.font.shadow.color) {\r\n        ctx.shadowColor = this.font.shadow.color.toString();\r\n      }\r\n      if (this.font.shadow.blur) {\r\n        ctx.shadowBlur = this.font.shadow.blur;\r\n      }\r\n      if (this.font.shadow.offset) {\r\n        ctx.shadowOffsetX = this.font.shadow.offset.x;\r\n        ctx.shadowOffsetY = this.font.shadow.offset.y;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _drawText(ctx: CanvasRenderingContext2D, lines: string[], lineHeight: number): void {\r\n    this._applyRasterProperties(ctx);\r\n    this._applyFont(ctx);\r\n\r\n    for (let i = 0; i < lines.length; i++) {\r\n      const line = lines[i];\r\n      if (this.color) {\r\n        ctx.fillText(line, 0, i * lineHeight);\r\n      }\r\n\r\n      if (this.font.strokeColor) {\r\n        ctx.strokeText(line, 0, i * lineHeight);\r\n      }\r\n    }\r\n\r\n    if (this.font.showDebug) {\r\n      // Horizontal line\r\n      /* istanbul ignore next */\r\n      line(ctx, Color.Green, -ctx.canvas.width / 2, 0, ctx.canvas.width / 2, 0, 2);\r\n      // Vertical line\r\n      /* istanbul ignore next */\r\n      line(ctx, Color.Red, 0, -ctx.canvas.height / 2, 0, ctx.canvas.height / 2, 2);\r\n    }\r\n  }\r\n\r\n  private _splitTextBitmap(bitmap: CanvasRenderingContext2D) {\r\n    const textImages: { x: number; y: number; canvas: HTMLCanvasElement }[] = [];\r\n    let currentX = 0;\r\n    let currentY = 0;\r\n    // 4k is the max for mobile devices\r\n    const width = Math.min(4096, bitmap.canvas.width);\r\n    const height = Math.min(4096, bitmap.canvas.height);\r\n\r\n    // Splits the original bitmap into 4k max chunks\r\n    while (currentX < bitmap.canvas.width) {\r\n      while (currentY < bitmap.canvas.height) {\r\n        // create new bitmap\r\n        const canvas = document.createElement('canvas');\r\n        canvas.width = width;\r\n        canvas.height = height;\r\n        const ctx = canvas.getContext('2d');\r\n        if (!ctx) {\r\n          throw new Error('Unable to split internal FontTextInstance bitmap, failed to create internal canvas');\r\n        }\r\n\r\n        // draw current slice to new bitmap in < 4k chunks\r\n        ctx.drawImage(bitmap.canvas, currentX, currentY, width, height, 0, 0, width, height);\r\n\r\n        textImages.push({ x: currentX, y: currentY, canvas });\r\n        currentY += height;\r\n      }\r\n      currentX += width;\r\n      currentY = 0;\r\n    }\r\n    return textImages;\r\n  }\r\n\r\n  public flagDirty() {\r\n    this._dirty = true;\r\n  }\r\n  private _dirty = true;\r\n  private _ex?: ExcaliburGraphicsContext;\r\n  public render(ex: ExcaliburGraphicsContext, x: number, y: number, maxWidth?: number) {\r\n    if (this.disposed) {\r\n      throw Error('Accessing disposed text instance! ' + this.text);\r\n    }\r\n    this._ex = ex;\r\n    const hashCode = this.getHashCode();\r\n    if (this._lastHashCode !== hashCode) {\r\n      this._dirty = true;\r\n    }\r\n\r\n    // Calculate image chunks\r\n    if (this._dirty) {\r\n      this.dimensions = this.measureText(this.text, maxWidth);\r\n      this._setDimension(this.dimensions, this.ctx);\r\n      const lines = this._getLinesFromText(this.text, maxWidth);\r\n      const lineHeight = this.font.lineHeight ?? this.dimensions.height / lines.length;\r\n\r\n      // draws the text to the main bitmap\r\n      this._drawText(this.ctx, lines, lineHeight);\r\n\r\n      // clear any out old fragments\r\n      if (ex instanceof ExcaliburGraphicsContextWebGL) {\r\n        for (const frag of this._textFragments) {\r\n          ex.textureLoader.delete(frag.canvas);\r\n        }\r\n      }\r\n\r\n      // splits to < 4k fragments for large text\r\n      this._textFragments = this._splitTextBitmap(this.ctx);\r\n\r\n      if (ex instanceof ExcaliburGraphicsContextWebGL) {\r\n        for (const frag of this._textFragments) {\r\n          ex.textureLoader.load(frag.canvas, { filtering: this.font.filtering }, true);\r\n        }\r\n      }\r\n      this._lastHashCode = hashCode;\r\n      this._dirty = false;\r\n    }\r\n\r\n    // draws the bitmap fragments to excalibur graphics context\r\n    for (const frag of this._textFragments) {\r\n      ex.drawImage(\r\n        frag.canvas,\r\n        0,\r\n        0,\r\n        frag.canvas.width,\r\n        frag.canvas.height,\r\n        frag.x / this.font.quality + x - this.ctx.canvas.width / this.font.quality / 2,\r\n        frag.y / this.font.quality + y - this.ctx.canvas.height / this.font.quality / 2,\r\n        frag.canvas.width / this.font.quality,\r\n        frag.canvas.height / this.font.quality\r\n      );\r\n    }\r\n  }\r\n\r\n  dispose() {\r\n    this.disposed = true;\r\n    this.dimensions = undefined as any;\r\n    this.canvas = undefined as any;\r\n    this.ctx = undefined as any;\r\n    if (this._ex instanceof ExcaliburGraphicsContextWebGL) {\r\n      for (const frag of this._textFragments) {\r\n        this._ex.textureLoader.delete(frag.canvas);\r\n      }\r\n    }\r\n    this._textFragments.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Return array of lines split based on the \\n character, and the maxWidth? constraint\r\n   * @param text\r\n   * @param maxWidth\r\n   */\r\n  private _cachedText?: string;\r\n  private _cachedLines?: string[];\r\n  private _cachedRenderWidth?: number;\r\n  private _getLinesFromText(text: string, maxWidth?: number): string[] {\r\n    if (this._cachedText === text && this._cachedRenderWidth === maxWidth && this._cachedLines?.length) {\r\n      return this._cachedLines;\r\n    }\r\n\r\n    const lines = text.split('\\n');\r\n\r\n    if (maxWidth == null) {\r\n      return lines;\r\n    }\r\n\r\n    // If the current line goes past the maxWidth, append a new line without modifying the underlying text.\r\n    for (let i = 0; i < lines.length; i++) {\r\n      let line = lines[i];\r\n      let newLine = '';\r\n      if (this.measureText(line).width > maxWidth) {\r\n        while (this.measureText(line).width > maxWidth) {\r\n          newLine = line[line.length - 1] + newLine;\r\n          line = line.slice(0, -1); // Remove last character from line\r\n        }\r\n\r\n        // Update the array with our new values\r\n        lines[i] = line;\r\n        lines[i + 1] = newLine;\r\n      }\r\n    }\r\n\r\n    this._cachedText = text;\r\n    this._cachedLines = lines;\r\n    this._cachedRenderWidth = maxWidth;\r\n\r\n    return lines;\r\n  }\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { Logger } from '../Util/Log';\r\nimport { Font } from './Font';\r\nimport { FontTextInstance } from './FontTextInstance';\r\n\r\nexport class FontCache {\r\n  public static FONT_TIMEOUT = 500;\r\n  private static _LOGGER = Logger.getInstance();\r\n  private static _TEXT_USAGE = new Map<FontTextInstance, number>();\r\n  private static _TEXT_CACHE = new Map<string, FontTextInstance>();\r\n  private static _MEASURE_CACHE = new Map<string, BoundingBox>();\r\n\r\n  static measureText(text: string, font: Font, maxWidth?: number): BoundingBox {\r\n    const hash = FontTextInstance.getHashCode(font, text);\r\n    if (FontCache._MEASURE_CACHE.has(hash)) {\r\n      return FontCache._MEASURE_CACHE.get(hash)!;\r\n    }\r\n    FontCache._LOGGER.debug('Font text measurement cache miss');\r\n    const measurement = font.measureTextWithoutCache(text, maxWidth);\r\n    FontCache._MEASURE_CACHE.set(hash, measurement);\r\n    return measurement;\r\n  }\r\n\r\n  static getTextInstance(text: string, font: Font, color: Color): FontTextInstance {\r\n    const hash = FontTextInstance.getHashCode(font, text, color);\r\n    let textInstance = FontCache._TEXT_CACHE.get(hash);\r\n    if (!textInstance) {\r\n      textInstance = new FontTextInstance(font, text, color);\r\n      FontCache._TEXT_CACHE.set(hash, textInstance);\r\n      FontCache._LOGGER.debug('Font text instance cache miss');\r\n    }\r\n\r\n    // Cache the bitmap for certain amount of time\r\n    FontCache._TEXT_USAGE.set(textInstance, performance.now());\r\n\r\n    return textInstance;\r\n  }\r\n\r\n  static checkAndClearCache() {\r\n    const deferred: FontTextInstance[] = [];\r\n    const currentHashCodes = new Set<string>();\r\n    for (const [textInstance, time] of FontCache._TEXT_USAGE.entries()) {\r\n      // if bitmap hasn't been used in 100 ms clear it\r\n      if (time + FontCache.FONT_TIMEOUT < performance.now()) {\r\n        FontCache._LOGGER.debug(`Text cache entry timed out ${textInstance.text}`);\r\n        deferred.push(textInstance);\r\n        textInstance.dispose();\r\n      } else {\r\n        const hash = textInstance.getHashCode(false);\r\n        currentHashCodes.add(hash);\r\n      }\r\n    }\r\n    // Deferred removal of text instances\r\n    deferred.forEach((t) => {\r\n      FontCache._TEXT_USAGE.delete(t);\r\n    });\r\n\r\n    // Regenerate text instance cache\r\n    this._TEXT_CACHE.clear();\r\n    for (const [textInstance] of this._TEXT_USAGE.entries()) {\r\n      this._TEXT_CACHE.set(textInstance.getHashCode(), textInstance);\r\n    }\r\n\r\n    // Regenerated measurement cache\r\n    const newTextMeasurementCache = new Map<string, BoundingBox>();\r\n    for (const current of currentHashCodes) {\r\n      if (FontCache._MEASURE_CACHE.has(current)) {\r\n        newTextMeasurementCache.set(current, FontCache._MEASURE_CACHE.get(current)!);\r\n      }\r\n    }\r\n    this._MEASURE_CACHE.clear();\r\n    this._MEASURE_CACHE = newTextMeasurementCache;\r\n  }\r\n\r\n  public static get cacheSize() {\r\n    return FontCache._TEXT_USAGE.size;\r\n  }\r\n\r\n  /**\r\n   * Force clear all cached text bitmaps\r\n   */\r\n  public static clearCache() {\r\n    for (const [textInstance] of FontCache._TEXT_USAGE.entries()) {\r\n      textInstance.dispose();\r\n    }\r\n    FontCache._TEXT_USAGE.clear();\r\n    FontCache._TEXT_CACHE.clear();\r\n    FontCache._MEASURE_CACHE.clear();\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Color } from '../Color';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BaseAlign, Direction, FontOptions, FontStyle, FontUnit, TextAlign, FontRenderer } from './FontCommon';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { RasterOptions } from './Raster';\r\nimport { ImageFiltering } from './Filtering';\r\nimport { FontTextInstance } from './FontTextInstance';\r\nimport { FontCache } from './FontCache';\r\n/**\r\n * Represents a system or web font in Excalibur\r\n *\r\n * If no options specified, the system sans-serif 10 pixel is used\r\n *\r\n * If loading a custom web font be sure to have the font loaded before you use it https://erikonarheim.com/posts/dont-test-fonts/\r\n */\r\nexport class Font extends Graphic implements FontRenderer {\r\n  /**\r\n   * Set the font filtering mode, by default set to {@apilink ImageFiltering.Blended} regardless of the engine default smoothing\r\n   *\r\n   * If you have a pixel style font that may be a reason to switch this to {@apilink ImageFiltering.Pixel}\r\n   */\r\n  public filtering: ImageFiltering = ImageFiltering.Blended;\r\n  constructor(options: FontOptions & GraphicOptions & RasterOptions = {}) {\r\n    super(options); // <- Graphics properties\r\n\r\n    // Raster properties\r\n    this.smoothing = options?.smoothing ?? this.smoothing;\r\n    this.padding = options?.padding ?? this.padding;\r\n    this.color = options?.color ?? this.color;\r\n    this.strokeColor = options?.strokeColor ?? this.strokeColor;\r\n    this.lineDash = options?.lineDash ?? this.lineDash;\r\n    this.lineWidth = options?.lineWidth ?? this.lineWidth;\r\n    this.filtering = options?.filtering ?? this.filtering;\r\n\r\n    // Font specific properties\r\n    this.family = options?.family ?? this.family;\r\n    this.style = options?.style ?? this.style;\r\n    this.bold = options?.bold ?? this.bold;\r\n    this.size = options?.size ?? this.size;\r\n    this.unit = options?.unit ?? this.unit;\r\n    this.textAlign = options?.textAlign ?? this.textAlign;\r\n    this.baseAlign = options?.baseAlign ?? this.baseAlign;\r\n    this.direction = options?.direction ?? this.direction;\r\n    this.lineHeight = options?.lineHeight ?? this.lineHeight;\r\n    this.quality = options?.quality ?? this.quality;\r\n    if (options?.shadow) {\r\n      this.shadow = {};\r\n      this.shadow.blur = options.shadow.blur ?? this.shadow.blur;\r\n      this.shadow.offset = options.shadow.offset ?? this.shadow.offset;\r\n      this.shadow.color = options.shadow.color ?? this.shadow.color;\r\n    }\r\n  }\r\n\r\n  public clone() {\r\n    return new Font({\r\n      ...this.cloneGraphicOptions(),\r\n      size: this.size,\r\n      unit: this.unit,\r\n      family: this.family,\r\n      style: this.style,\r\n      bold: this.bold,\r\n      textAlign: this.textAlign,\r\n      baseAlign: this.baseAlign,\r\n      direction: this.direction,\r\n      shadow: this.shadow\r\n        ? {\r\n            blur: this.shadow.blur,\r\n            offset: this.shadow.offset,\r\n            color: this.shadow.color\r\n          }\r\n        : undefined\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Font quality determines the size of the underlying raster text, higher quality means less jagged edges.\r\n   * If quality is set to 1, then just enough raster bitmap is generated to render the text.\r\n   *\r\n   * You can think of quality as how zoomed in to the text you can get before seeing jagged edges.\r\n   *\r\n   * (Default 2)\r\n   */\r\n  public quality = 2;\r\n\r\n  // Raster properties for fonts\r\n  public padding = 2;\r\n  public smoothing = false;\r\n  public lineWidth = 1;\r\n  public lineDash: number[] = [];\r\n  public color: Color = Color.Black;\r\n  public strokeColor?: Color;\r\n\r\n  public family: string = 'sans-serif';\r\n  public style: FontStyle = FontStyle.Normal;\r\n  public bold: boolean = false;\r\n  public unit: FontUnit = FontUnit.Px;\r\n  public textAlign: TextAlign = TextAlign.Left;\r\n  public baseAlign: BaseAlign = BaseAlign.Top;\r\n  public direction: Direction = Direction.LeftToRight;\r\n  /**\r\n   * Font line height in pixels, default line height if unset\r\n   */\r\n  public lineHeight: number | undefined = undefined;\r\n  public size: number = 10;\r\n  public shadow?: { blur?: number; offset?: Vector; color?: Color };\r\n\r\n  public get fontString() {\r\n    return `${this.style} ${this.bold ? 'bold' : ''} ${this.size}${this.unit} ${this.family}`;\r\n  }\r\n\r\n  private _textBounds: BoundingBox = new BoundingBox();\r\n\r\n  public get localBounds(): BoundingBox {\r\n    return this._textBounds;\r\n  }\r\n\r\n  protected _drawImage(_ex: ExcaliburGraphicsContext, _x: number, _y: number) {\r\n    // TODO weird vestigial drawimage\r\n  }\r\n\r\n  protected _rotate(ex: ExcaliburGraphicsContext) {\r\n    // TODO this needs to change depending on the bounding box...\r\n    const origin = this.origin ?? this._textBounds.center;\r\n    ex.translate(origin.x, origin.y);\r\n    ex.rotate(this.rotation);\r\n    ex.translate(-origin.x, -origin.y);\r\n  }\r\n\r\n  protected _flip(ex: ExcaliburGraphicsContext) {\r\n    if (this.flipHorizontal) {\r\n      ex.translate(this._textBounds.width / this.scale.x, 0);\r\n      ex.scale(-1, 1);\r\n    }\r\n\r\n    if (this.flipVertical) {\r\n      ex.translate(0, -this._textBounds.height / 2 / this.scale.y);\r\n      ex.scale(1, -1);\r\n    }\r\n  }\r\n\r\n  private _textMeasurement = new FontTextInstance(this, '', Color.Black);\r\n\r\n  public measureTextWithoutCache(text: string, maxWidth?: number) {\r\n    return this._textMeasurement.measureText(text, maxWidth);\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox that is the total size of the text including multiple lines\r\n   *\r\n   * Does not include any padding or adjustment\r\n   * @param text\r\n   * @returns BoundingBox\r\n   */\r\n  public measureText(text: string, maxWidth?: number): BoundingBox {\r\n    return FontCache.measureText(text, this, maxWidth);\r\n  }\r\n\r\n  protected _postDraw(ex: ExcaliburGraphicsContext): void {\r\n    ex.restore();\r\n  }\r\n\r\n  public render(ex: ExcaliburGraphicsContext, text: string, colorOverride: Color, x: number, y: number, maxWidth?: number) {\r\n    const textInstance = FontCache.getTextInstance(text, this, colorOverride);\r\n\r\n    // Apply affine transformations\r\n    this._textBounds = textInstance.dimensions;\r\n    this._preDraw(ex, x, y);\r\n\r\n    textInstance.render(ex, x, y, maxWidth);\r\n\r\n    this._postDraw(ex);\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { SpriteFont } from './SpriteFont';\r\nimport { Graphic, GraphicOptions } from './Graphic';\r\nimport { Color } from '../Color';\r\nimport { Font } from './Font';\r\n\r\nexport interface TextOptions {\r\n  /**\r\n   * Text to draw\r\n   */\r\n  text: string;\r\n\r\n  /**\r\n   * Optionally override the font color, currently unsupported by SpriteFont\r\n   */\r\n  color?: Color;\r\n\r\n  /**\r\n   * Optionally specify a font, if none specified a default font is used (System sans-serif 10 pixel)\r\n   */\r\n  font?: Font | SpriteFont;\r\n\r\n  /**\r\n   * Optionally specify a maximum width in pixels for our text, and wrap to the next line if needed.\r\n   */\r\n  maxWidth?: number;\r\n}\r\n\r\n/**\r\n * Represent Text graphics in excalibur\r\n *\r\n * Useful for in game labels, ui, or overlays\r\n */\r\nexport class Text extends Graphic {\r\n  public color?: Color;\r\n  public maxWidth?: number;\r\n  constructor(options: TextOptions & GraphicOptions) {\r\n    super(options);\r\n    // This order is important font, color, then text\r\n    this.font = options.font ?? new Font();\r\n    this.color = options.color ?? this.color;\r\n    this.text = options.text;\r\n    this.maxWidth = options.maxWidth;\r\n  }\r\n\r\n  public clone(): Text {\r\n    return new Text({\r\n      text: this.text.slice(),\r\n      color: this.color?.clone() ?? Color.Black,\r\n      font: this.font.clone(),\r\n      maxWidth: this.maxWidth\r\n    });\r\n  }\r\n\r\n  private _text: string = '';\r\n  public get text() {\r\n    return this._text;\r\n  }\r\n\r\n  public set text(value: string) {\r\n    this._text = value;\r\n    this._calculateDimension();\r\n  }\r\n\r\n  private _font!: Font | SpriteFont;\r\n  public get font(): Font | SpriteFont {\r\n    return this._font;\r\n  }\r\n  public set font(font: Font | SpriteFont) {\r\n    this._font = font;\r\n  }\r\n\r\n  private _textWidth: number = 0;\r\n\r\n  public get width() {\r\n    if (this._textWidth === 0) {\r\n      this._calculateDimension();\r\n    }\r\n    return this._textWidth * this.scale.x;\r\n  }\r\n\r\n  private _textHeight: number = 0;\r\n  public get height() {\r\n    if (this._textHeight === 0) {\r\n      this._calculateDimension();\r\n    }\r\n    return this._textHeight * this.scale.y;\r\n  }\r\n\r\n  private _calculateDimension() {\r\n    const { width, height } = this.font.measureText(this._text, this.maxWidth);\r\n    this._textWidth = width;\r\n    this._textHeight = height;\r\n  }\r\n\r\n  public get localBounds(): BoundingBox {\r\n    return this.font.measureText(this._text, this.maxWidth).scale(this.scale);\r\n  }\r\n\r\n  protected override _rotate(_ex: ExcaliburGraphicsContext) {\r\n    // None this is delegated to font\r\n    // This override erases the default behavior\r\n  }\r\n\r\n  protected override _flip(_ex: ExcaliburGraphicsContext) {\r\n    // None this is delegated to font\r\n    // This override erases the default behavior\r\n  }\r\n\r\n  protected override _preDraw(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this.isStale() || this.font.isStale()) {\r\n      this.font.flipHorizontal = this.flipHorizontal;\r\n      this.font.flipVertical = this.flipVertical;\r\n      this.font.rotation = this.rotation;\r\n      this.font.origin = this.origin;\r\n      this.font.opacity = this.opacity;\r\n    }\r\n    this.font.tint = this.tint;\r\n    super._preDraw(ex, x, y);\r\n  }\r\n\r\n  protected override _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number) {\r\n    let color = Color.Black;\r\n    if (this.font instanceof Font) {\r\n      color = this.color ?? this.font.color;\r\n    }\r\n\r\n    const { width, height } = this.font.measureText(this._text, this.maxWidth);\r\n    this._textWidth = width;\r\n    this._textHeight = height;\r\n\r\n    this.font.render(ex, this._text, color, x, y, this.maxWidth);\r\n\r\n    if (this.font.showDebug) {\r\n      ex.debug.drawRect(x - width, y - height, width * 2, height * 2);\r\n      if (this.maxWidth != null) {\r\n        ex.debug.drawRect(x, y, this.maxWidth, this.height, {\r\n          color: Color.Yellow\r\n        });\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { Graphic } from './Graphic';\r\nimport { HasTick } from './Animation';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { BoundingBox } from '../Collision/Index';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Material } from './Context/material';\r\nimport { Logger } from '../Util/Log';\r\nimport { WatchVector } from '../Math/watch-vector';\r\nimport { TransformComponent } from '../EntityComponentSystem';\r\nimport { GraphicsGroup } from '../Graphics/GraphicsGroup';\r\nimport { Color } from '../Color';\r\nimport { Raster } from './Raster';\r\nimport { Text } from './Text';\r\n\r\n/**\r\n * Type guard for checking if a Graphic HasTick (used for graphics that change over time like animations)\r\n * @param graphic\r\n */\r\nexport function hasGraphicsTick(graphic: Graphic): graphic is Graphic & HasTick {\r\n  return !!(graphic as unknown as HasTick).tick;\r\n}\r\nexport interface GraphicsShowOptions {\r\n  offset?: Vector;\r\n  anchor?: Vector;\r\n}\r\n\r\nexport interface GraphicsComponentOptions {\r\n  onPostDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPreDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPreTransformDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  onPostTransformDraw?: (ex: ExcaliburGraphicsContext, elapsed: number) => void;\r\n\r\n  /**\r\n   * Name of current graphic to use\r\n   */\r\n  current?: string;\r\n\r\n  /**\r\n   * Optionally set the color of the graphics component\r\n   */\r\n  color?: Color;\r\n\r\n  /**\r\n   * Optionally set a material to use on the graphic\r\n   */\r\n  material?: Material;\r\n\r\n  /**\r\n   * Optionally copy instances of graphics by calling .clone(), you may set this to false to avoid sharing graphics when added to the\r\n   * component for performance reasons. By default graphics are not copied and are shared when added to the component.\r\n   */\r\n  copyGraphics?: boolean;\r\n\r\n  /**\r\n   * Optional visible flag, if the graphics component is not visible it will not be displayed\r\n   */\r\n  visible?: boolean;\r\n\r\n  /**\r\n   * Optional opacity\r\n   */\r\n  opacity?: number;\r\n\r\n  /**\r\n   * List of graphics and optionally the options per graphic\r\n   */\r\n  graphics?: { [graphicName: string]: Graphic | { graphic: Graphic; options?: GraphicsShowOptions | undefined } };\r\n\r\n  /**\r\n   * Optional offset in absolute pixels to shift all graphics in this component from each graphic's anchor (default is top left corner)\r\n   */\r\n  offset?: Vector;\r\n\r\n  /**\r\n   * Optional anchor\r\n   */\r\n  anchor?: Vector;\r\n}\r\n\r\n/**\r\n * Component to manage drawings, using with the position component\r\n */\r\nexport class GraphicsComponent extends Component {\r\n  private _logger = Logger.getInstance();\r\n\r\n  private _current: string = 'default';\r\n  private _graphics: Record<string, Graphic> = {};\r\n  private _options: Record<string, GraphicsShowOptions | undefined> = {};\r\n\r\n  public material: Material | null = null;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, but before graphics component graphics have been drawn\r\n   */\r\n  public onPreDraw?: (ctx: ExcaliburGraphicsContext, elapsed: number) => void;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, and after graphics component graphics has been drawn\r\n   */\r\n  public onPostDraw?: (ctx: ExcaliburGraphicsContext, elapsed: number) => void;\r\n\r\n  /**\r\n   * Draws before the entity transform has been applied before any any graphics component drawing\r\n   */\r\n  public onPreTransformDraw?: (ctx: ExcaliburGraphicsContext, elapsed: number) => void;\r\n\r\n  /**\r\n   * Draws after the entity transform has been applied, and after all graphics component drawing\r\n   */\r\n  public onPostTransformDraw?: (ctx: ExcaliburGraphicsContext, elapsed: number) => void;\r\n  private _color?: Color;\r\n\r\n  /**\r\n   * Sets or gets wether any drawing should be visible in this component\r\n   * @deprecated use isVisible\r\n   */\r\n  public get visible(): boolean {\r\n    return this.isVisible;\r\n  }\r\n\r\n  /**\r\n   * Sets or gets wether any drawing should be visible in this component\r\n   * @deprecated use isVisible\r\n   */\r\n  public set visible(val: boolean) {\r\n    this.isVisible = val;\r\n  }\r\n\r\n  /**\r\n   * Sets or gets wether any drawing should be visible in this component\r\n   */\r\n  public isVisible: boolean = true;\r\n\r\n  /**\r\n   * Optionally force the graphic onscreen, default false. Not recommend to use for perf reasons, only if you known what you're doing.\r\n   */\r\n  public forceOnScreen: boolean = false;\r\n\r\n  /**\r\n   * Sets or gets wither all drawings should have an opacity applied\r\n   */\r\n  public opacity: number = 1;\r\n\r\n  private _offset: Vector = new WatchVector(Vector.Zero, () => this.recalculateBounds());\r\n\r\n  /**\r\n   * Offset to apply to graphics by default\r\n   */\r\n  public get offset(): Vector {\r\n    return this._offset;\r\n  }\r\n  public set offset(value: Vector) {\r\n    this._offset = new WatchVector(value, () => this.recalculateBounds());\r\n    this.recalculateBounds();\r\n  }\r\n\r\n  private _anchor: Vector = new WatchVector(Vector.Half, () => this.recalculateBounds());\r\n\r\n  /**\r\n   * Anchor to apply to graphics by default\r\n   */\r\n  public get anchor(): Vector {\r\n    return this._anchor;\r\n  }\r\n  public set anchor(value: Vector) {\r\n    this._anchor = new WatchVector(value, () => this.recalculateBounds());\r\n    this.recalculateBounds();\r\n  }\r\n\r\n  /**\r\n   * Sets the color of the actor's current graphic\r\n   */\r\n  public get color(): Color | undefined {\r\n    return this._color;\r\n  }\r\n  public set color(v: Color | undefined) {\r\n    if (v) {\r\n      this._color = v.clone();\r\n      const currentGraphic = this.graphics.current;\r\n      if (currentGraphic instanceof Raster || currentGraphic instanceof Text) {\r\n        currentGraphic.color = this._color;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Flip all graphics horizontally along the y-axis\r\n   */\r\n  public flipHorizontal: boolean = false;\r\n\r\n  /**\r\n   * Flip all graphics vertically along the x-axis\r\n   */\r\n  public flipVertical: boolean = false;\r\n\r\n  /**\r\n   * If set to true graphics added to the component will be copied. This can effect performance, but is useful if you don't want\r\n   * changes to a graphic to effect all the places it is used.\r\n   */\r\n  public copyGraphics: boolean = false;\r\n\r\n  constructor(options?: GraphicsComponentOptions) {\r\n    super();\r\n    // Defaults\r\n    options = {\r\n      visible: this.isVisible,\r\n      graphics: {},\r\n      ...options\r\n    };\r\n\r\n    const {\r\n      current,\r\n      anchor,\r\n      color,\r\n      opacity,\r\n      visible,\r\n      graphics,\r\n      offset,\r\n      copyGraphics,\r\n      onPreDraw,\r\n      onPostDraw,\r\n      onPreTransformDraw,\r\n      onPostTransformDraw\r\n    } = options;\r\n\r\n    for (const [key, graphicOrOptions] of Object.entries(graphics as GraphicsComponentOptions)) {\r\n      if (graphicOrOptions instanceof Graphic) {\r\n        this._graphics[key] = graphicOrOptions;\r\n      } else {\r\n        this._graphics[key] = graphicOrOptions.graphic;\r\n        this._options[key] = graphicOrOptions.options;\r\n      }\r\n    }\r\n\r\n    this.offset = offset ?? this.offset;\r\n    this.opacity = opacity ?? this.opacity;\r\n    this.anchor = anchor ?? this.anchor;\r\n    this.color = color ?? this.color;\r\n    this.copyGraphics = copyGraphics ?? this.copyGraphics;\r\n    this.onPreDraw = onPreDraw ?? this.onPreDraw;\r\n    this.onPostDraw = onPostDraw ?? this.onPostDraw;\r\n    this.onPreDraw = onPreTransformDraw ?? this.onPreTransformDraw;\r\n    this.onPostTransformDraw = onPostTransformDraw ?? this.onPostTransformDraw;\r\n    this.isVisible = !!visible;\r\n    this._current = current ?? this._current;\r\n    if (current && this._graphics[current]) {\r\n      this.use(current);\r\n    }\r\n  }\r\n\r\n  public getGraphic(name: string): Graphic | undefined {\r\n    return this._graphics[name];\r\n  }\r\n  public getOptions(name: string): GraphicsShowOptions | undefined {\r\n    return this._options[name];\r\n  }\r\n\r\n  /**\r\n   * Get registered graphics names\r\n   */\r\n  public getNames(): string[] {\r\n    return Object.keys(this._graphics);\r\n  }\r\n\r\n  /**\r\n   * Returns the currently displayed graphic\r\n   */\r\n  public get current(): Graphic | undefined {\r\n    return this._graphics[this._current];\r\n  }\r\n\r\n  /**\r\n   * Returns the currently displayed graphic offsets\r\n   */\r\n  public get currentOptions(): GraphicsShowOptions | undefined {\r\n    return this._options[this._current];\r\n  }\r\n\r\n  /**\r\n   * Returns all graphics associated with this component\r\n   */\r\n  public get graphics(): { [graphicName: string]: Graphic } {\r\n    return this._graphics;\r\n  }\r\n\r\n  /**\r\n   * Returns all graphics options associated with this component\r\n   */\r\n  public get options(): { [graphicName: string]: GraphicsShowOptions | undefined } {\r\n    return this._options;\r\n  }\r\n\r\n  /**\r\n   * Adds a named graphic to this component, if the name is \"default\" or not specified, it will be shown by default without needing to call\r\n   * @param graphic\r\n   */\r\n  public add(graphic: Graphic, options?: GraphicsShowOptions): Graphic;\r\n  public add(name: string, graphic: Graphic, options?: GraphicsShowOptions): Graphic;\r\n  public add(nameOrGraphic: string | Graphic, graphicOrOptions?: Graphic | GraphicsShowOptions, options?: GraphicsShowOptions): Graphic {\r\n    let name = 'default';\r\n    let graphicToSet: Graphic | null = null;\r\n    let optionsToSet: GraphicsShowOptions | undefined = undefined;\r\n    if (typeof nameOrGraphic === 'string' && graphicOrOptions instanceof Graphic) {\r\n      name = nameOrGraphic;\r\n      graphicToSet = graphicOrOptions;\r\n      optionsToSet = options;\r\n    }\r\n    if (nameOrGraphic instanceof Graphic && !(graphicOrOptions instanceof Graphic)) {\r\n      graphicToSet = nameOrGraphic;\r\n      optionsToSet = graphicOrOptions;\r\n    }\r\n\r\n    if (!graphicToSet) {\r\n      throw new Error('Need to provide a graphic or valid graphic string');\r\n    }\r\n    this._graphics[name] = this.copyGraphics ? graphicToSet.clone() : graphicToSet;\r\n    this._options[name] = this.copyGraphics ? { ...optionsToSet } : optionsToSet;\r\n    if (name === 'default') {\r\n      this.use('default');\r\n    }\r\n    return graphicToSet;\r\n  }\r\n\r\n  /**\r\n   * Removes a registered graphic, if the removed graphic is the current it will switch to the default\r\n   * @param name\r\n   */\r\n  public remove(name: string) {\r\n    delete this._graphics[name];\r\n    delete this._options[name];\r\n    if (this._current === name) {\r\n      this._current = 'default';\r\n      this.recalculateBounds();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Use a graphic only, will set the default graphic. Returns the new {@apilink Graphic}\r\n   *\r\n   * Optionally override the stored options\r\n   * @param nameOrGraphic\r\n   * @param options\r\n   */\r\n  public use<T extends Graphic = Graphic>(nameOrGraphic: string | T, options?: GraphicsShowOptions): T {\r\n    if (nameOrGraphic instanceof Graphic) {\r\n      let graphic = nameOrGraphic as Graphic;\r\n      if (this.copyGraphics) {\r\n        graphic = nameOrGraphic.clone();\r\n      }\r\n      this._current = 'default';\r\n      this._graphics[this._current] = graphic;\r\n      this._options[this._current] = options;\r\n    } else {\r\n      this._current = nameOrGraphic;\r\n      this._options[this._current] = options;\r\n      if (!(this._current in this._graphics)) {\r\n        this._logger.warn(\r\n          `Graphic ${this._current} is not registered with the graphics component owned by ${this.owner?.name}. Nothing will be drawn.`\r\n        );\r\n      }\r\n    }\r\n    this.recalculateBounds();\r\n    return this.current as T;\r\n  }\r\n\r\n  /**\r\n   * Hide currently shown graphic\r\n   */\r\n  public hide(): void {\r\n    this._current = 'ex.none';\r\n  }\r\n\r\n  private _localBounds?: BoundingBox;\r\n  public set localBounds(bounds: BoundingBox) {\r\n    this._localBounds = bounds;\r\n  }\r\n\r\n  public recalculateBounds() {\r\n    let bb = new BoundingBox();\r\n    const graphic = this._graphics[this._current];\r\n    const options = this._options[this._current];\r\n\r\n    if (!graphic) {\r\n      this._localBounds = bb;\r\n      return;\r\n    }\r\n\r\n    let anchor = this.anchor;\r\n    let offset = this.offset;\r\n    if (options?.anchor) {\r\n      anchor = options.anchor;\r\n    }\r\n    if (options?.offset) {\r\n      offset = options.offset;\r\n    }\r\n    const bounds = graphic.localBounds;\r\n    const offsetX = -bounds.width * anchor.x + offset.x;\r\n    const offsetY = -bounds.height * anchor.y + offset.y;\r\n    if (graphic instanceof GraphicsGroup && !graphic.useAnchor) {\r\n      bb = graphic?.localBounds.combine(bb);\r\n    } else {\r\n      bb = graphic?.localBounds.translate(vec(offsetX, offsetY)).combine(bb);\r\n    }\r\n    this._localBounds = bb;\r\n  }\r\n\r\n  /**\r\n   * Get local bounds of graphics component\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    if (!this._localBounds || this._localBounds.hasZeroDimensions()) {\r\n      this.recalculateBounds();\r\n    }\r\n    return this._localBounds as BoundingBox; // recalc guarantees type\r\n  }\r\n\r\n  /**\r\n   * Get world bounds of graphics component\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    let bounds = this.localBounds;\r\n    if (this.owner) {\r\n      const tx = this.owner.get(TransformComponent);\r\n      if (tx) {\r\n        bounds = bounds.transform(tx.get().matrix);\r\n      }\r\n    }\r\n    return bounds;\r\n  }\r\n\r\n  /**\r\n   * Update underlying graphics if necessary, called internally\r\n   * @param elapsed\r\n   * @internal\r\n   */\r\n  public update(elapsed: number, idempotencyToken: number = 0) {\r\n    const graphic = this.current;\r\n    if (graphic && hasGraphicsTick(graphic)) {\r\n      graphic.tick(elapsed, idempotencyToken);\r\n    }\r\n  }\r\n\r\n  public clone(): GraphicsComponent {\r\n    const graphics = new GraphicsComponent();\r\n    graphics._graphics = { ...this._graphics };\r\n    graphics._options = { ...this._options };\r\n    graphics.offset = this.offset.clone();\r\n    if (this.color) {\r\n      graphics.color = this.color.clone();\r\n    }\r\n    graphics.opacity = this.opacity;\r\n    graphics.anchor = this.anchor.clone();\r\n    graphics.copyGraphics = this.copyGraphics;\r\n    graphics.onPreDraw = this.onPreDraw;\r\n    graphics.onPostDraw = this.onPostDraw;\r\n    graphics.isVisible = this.isVisible;\r\n\r\n    return graphics;\r\n  }\r\n}\r\n","import { Component, ComponentCtor, isComponentCtor } from './Component';\r\n\r\nimport { Observable, Message } from '../Util/Observable';\r\nimport { OnInitialize, OnPreUpdate, OnPostUpdate, OnAdd, OnRemove } from '../Interfaces/LifecycleEvents';\r\nimport { Engine } from '../Engine';\r\nimport { InitializeEvent, PreUpdateEvent, PostUpdateEvent, AddEvent, RemoveEvent } from '../Events';\r\nimport { KillEvent } from '../Events';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { Scene } from '../Scene';\r\nimport { removeItemFromArray } from '../Util/Util';\r\nimport { MaybeKnownComponent } from './Types';\r\nimport { Logger } from '../Util/Log';\r\n\r\n/**\r\n * Interface holding an entity component pair\r\n */\r\nexport interface EntityComponent {\r\n  component: Component;\r\n  entity: Entity;\r\n}\r\n\r\n/**\r\n * AddedComponent message\r\n */\r\nexport class AddedComponent implements Message<EntityComponent> {\r\n  readonly type: 'Component Added' = 'Component Added';\r\n  constructor(public data: EntityComponent) {}\r\n}\r\n\r\n/**\r\n * Type guard to know if message is f an Added Component\r\n */\r\nexport function isAddedComponent(x: Message<EntityComponent>): x is AddedComponent {\r\n  return !!x && x.type === 'Component Added';\r\n}\r\n\r\n/**\r\n * RemovedComponent message\r\n */\r\nexport class RemovedComponent implements Message<EntityComponent> {\r\n  readonly type: 'Component Removed' = 'Component Removed';\r\n  constructor(public data: EntityComponent) {}\r\n}\r\n\r\n/**\r\n * Type guard to know if message is for a Removed Component\r\n */\r\nexport function isRemovedComponent(x: Message<EntityComponent>): x is RemovedComponent {\r\n  return !!x && x.type === 'Component Removed';\r\n}\r\n\r\n/**\r\n * Built in events supported by all entities\r\n */\r\nexport type EntityEvents = {\r\n  initialize: InitializeEvent;\r\n  //@ts-ignore\r\n  add: AddEvent;\r\n  //@ts-ignore\r\n  remove: RemoveEvent;\r\n  preupdate: PreUpdateEvent;\r\n  postupdate: PostUpdateEvent;\r\n  kill: KillEvent;\r\n};\r\n\r\nexport const EntityEvents = {\r\n  Add: 'add',\r\n  Remove: 'remove',\r\n  Initialize: 'initialize',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  Kill: 'kill'\r\n} as const;\r\n\r\nexport interface EntityOptions<TComponents extends Component> {\r\n  name?: string;\r\n  components?: TComponents[];\r\n  silenceWarnings?: boolean;\r\n}\r\n\r\n/**\r\n * An Entity is the base type of anything that can have behavior in Excalibur, they are part of the built in entity component system\r\n *\r\n * Entities can be strongly typed with the components they contain\r\n *\r\n * ```typescript\r\n * const entity = new Entity<ComponentA | ComponentB>();\r\n * entity.components.a; // Type ComponentA\r\n * entity.components.b; // Type ComponentB\r\n * ```\r\n */\r\nexport class Entity<TKnownComponents extends Component = any> implements OnInitialize, OnPreUpdate, OnPostUpdate, OnAdd, OnRemove {\r\n  private static _ID = 0;\r\n  /**\r\n   * The unique identifier for the entity\r\n   */\r\n  public id: number = Entity._ID++;\r\n\r\n  public name = `Entity#${this.id}`;\r\n\r\n  /**\r\n   * Listen to or emit events for an entity\r\n   */\r\n  public events = new EventEmitter<EntityEvents>();\r\n  private _tags = new Set<string>();\r\n  public componentAdded$ = new Observable<Component>();\r\n  public componentRemoved$ = new Observable<Component>();\r\n  public tagAdded$ = new Observable<string>();\r\n  public tagRemoved$ = new Observable<string>();\r\n  /**\r\n   * Current components on the entity\r\n   *\r\n   * **Do not modify**\r\n   *\r\n   * Use addComponent/removeComponent otherwise the ECS will not be notified of changes.\r\n   */\r\n  public readonly components = new Map<Function, Component>();\r\n  public componentValues: Component[] = [];\r\n  private _componentsToRemove: ComponentCtor[] = [];\r\n\r\n  constructor(options: EntityOptions<TKnownComponents>);\r\n  constructor(components?: TKnownComponents[], name?: string);\r\n  constructor(componentsOrOptions?: TKnownComponents[] | EntityOptions<TKnownComponents>, name?: string) {\r\n    let componentsToAdd!: TKnownComponents[];\r\n    let nameToAdd: string | undefined;\r\n    let silence = false;\r\n    if (Array.isArray(componentsOrOptions)) {\r\n      componentsToAdd = componentsOrOptions;\r\n      nameToAdd = name;\r\n    } else if (componentsOrOptions && typeof componentsOrOptions === 'object') {\r\n      const { components, name, silenceWarnings } = componentsOrOptions;\r\n      componentsToAdd = components ?? [];\r\n      nameToAdd = name;\r\n      silence = !!silenceWarnings;\r\n    }\r\n    if (nameToAdd) {\r\n      this.name = nameToAdd;\r\n    }\r\n    if (componentsToAdd) {\r\n      for (const component of componentsToAdd) {\r\n        this.addComponent(component);\r\n      }\r\n    }\r\n\r\n    if (process.env.NODE_ENV === 'development') {\r\n      if (!silence) {\r\n        setTimeout(() => {\r\n          if (!this.scene && !this.isInitialized) {\r\n            Logger.getInstance().warn(`Entity \"${this.name || this.id}\" was not added to a scene.`);\r\n          }\r\n        }, 5000);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * The current scene that the entity is in, if any\r\n   */\r\n  public scene: Scene | null = null;\r\n\r\n  /**\r\n   * Whether this entity is active, if set to false it will be reclaimed\r\n   * @deprecated use isActive\r\n   */\r\n  public get active(): boolean {\r\n    return this.isActive;\r\n  }\r\n\r\n  /**\r\n   * Whether this entity is active, if set to false it will be reclaimed\r\n   * @deprecated use isActive\r\n   */\r\n  public set active(val: boolean) {\r\n    this.isActive = val;\r\n  }\r\n\r\n  /**\r\n   * Whether this entity is active, if set to false it will be reclaimed\r\n   */\r\n  public isActive: boolean = true;\r\n\r\n  /**\r\n   * Kill the entity, means it will no longer be updated. Kills are deferred to the end of the update.\r\n   * If parented it will be removed from the parent when killed.\r\n   */\r\n  public kill() {\r\n    if (this.isActive) {\r\n      this.isActive = false;\r\n      this.unparent();\r\n    }\r\n    this.emit('kill', new KillEvent(this));\r\n  }\r\n\r\n  public isKilled() {\r\n    return !this.isActive;\r\n  }\r\n\r\n  /**\r\n   * Specifically get the tags on the entity from {@apilink TagsComponent}\r\n   */\r\n  public get tags(): Set<string> {\r\n    return this._tags;\r\n  }\r\n\r\n  /**\r\n   * Check if a tag exists on the entity\r\n   * @param tag name to check for\r\n   */\r\n  public hasTag(tag: string): boolean {\r\n    return this._tags.has(tag);\r\n  }\r\n\r\n  /**\r\n   * Adds a tag to an entity\r\n   * @param tag\r\n   */\r\n  public addTag(tag: string): Entity<TKnownComponents> {\r\n    this._tags.add(tag);\r\n    this.tagAdded$.notifyAll(tag);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Removes a tag on the entity\r\n   *\r\n   * Removals are deferred until the end of update\r\n   * @param tag\r\n   */\r\n  public removeTag(tag: string): Entity<TKnownComponents> {\r\n    this._tags.delete(tag);\r\n    this.tagRemoved$.notifyAll(tag);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * The types of the components on the Entity\r\n   */\r\n  public get types(): ComponentCtor[] {\r\n    return Array.from(this.components.keys()) as ComponentCtor[];\r\n  }\r\n\r\n  /**\r\n   * Returns all component instances on entity\r\n   */\r\n  public getComponents(): Component[] {\r\n    return Array.from(this.components.values());\r\n  }\r\n\r\n  /**\r\n   * Verifies that an entity has all the required types\r\n   * @param requiredTypes\r\n   */\r\n  hasAll<TComponent extends Component>(requiredTypes: ComponentCtor<TComponent>[]): boolean {\r\n    for (let i = 0; i < requiredTypes.length; i++) {\r\n      if (!this.components.has(requiredTypes[i])) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Verifies that an entity has all the required tags\r\n   * @param requiredTags\r\n   */\r\n  hasAllTags(requiredTags: string[]): boolean {\r\n    for (let i = 0; i < requiredTags.length; i++) {\r\n      if (!this.tags.has(requiredTags[i])) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get<TComponent extends Component>(type: ComponentCtor<TComponent>): MaybeKnownComponent<TComponent, TKnownComponents> {\r\n    return this.components.get(type) as MaybeKnownComponent<TComponent, TKnownComponents>;\r\n  }\r\n\r\n  private _parent: Entity | null = null;\r\n  public get parent(): Entity | null {\r\n    return this._parent;\r\n  }\r\n\r\n  public childrenAdded$ = new Observable<Entity>();\r\n  public childrenRemoved$ = new Observable<Entity>();\r\n\r\n  private _children: Entity[] = [];\r\n  /**\r\n   * Get the direct children of this entity\r\n   */\r\n  public get children(): readonly Entity[] {\r\n    return this._children;\r\n  }\r\n\r\n  /**\r\n   * Unparents this entity, if there is a parent. Otherwise it does nothing.\r\n   */\r\n  public unparent() {\r\n    if (this._parent) {\r\n      this._parent.removeChild(this);\r\n      this._parent = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds an entity to be a child of this entity\r\n   * @param entity\r\n   */\r\n  public addChild(entity: Entity): Entity {\r\n    if (entity.parent === null) {\r\n      if (this.getAncestors().includes(entity)) {\r\n        throw new Error('Cycle detected, cannot add entity');\r\n      }\r\n      this._children.push(entity);\r\n      entity._parent = this;\r\n      this.childrenAdded$.notifyAll(entity);\r\n    } else {\r\n      throw new Error('Entity already has a parent, cannot add without unparenting');\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove an entity from children if it exists\r\n   * @param entity\r\n   */\r\n  public removeChild(entity: Entity): Entity {\r\n    if (entity.parent === this) {\r\n      removeItemFromArray(entity, this._children);\r\n      entity._parent = null;\r\n      this.childrenRemoved$.notifyAll(entity);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Removes all children from this entity\r\n   */\r\n  public removeAllChildren(): Entity {\r\n    // Avoid modifying the array issue by walking backwards\r\n    for (let i = this.children.length - 1; i >= 0; i--) {\r\n      this.removeChild(this.children[i]);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns a list of parent entities starting with the topmost parent. Includes the current entity.\r\n   */\r\n  public getAncestors(): Entity[] {\r\n    const result: Entity[] = [this];\r\n    let current = this.parent;\r\n    while (current) {\r\n      result.push(current);\r\n      current = current.parent;\r\n    }\r\n    return result.reverse();\r\n  }\r\n\r\n  /**\r\n   * Returns a list of all the entities that descend from this entity. Includes the current entity.\r\n   */\r\n  public getDescendants(): Entity[] {\r\n    let result: Entity[] = [this];\r\n    let queue: Entity[] = [this];\r\n    while (queue.length > 0) {\r\n      const curr = queue.pop();\r\n      if (curr) {\r\n        queue = queue.concat(curr.children);\r\n        result = result.concat(curr.children);\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Creates a deep copy of the entity and a copy of all its components\r\n   */\r\n  public clone(): Entity {\r\n    const newEntity = new Entity();\r\n    for (const c of this.types) {\r\n      const componentInstance = this.get(c);\r\n      if (componentInstance) {\r\n        newEntity.addComponent(componentInstance.clone());\r\n      }\r\n    }\r\n    for (const child of this.children) {\r\n      newEntity.addChild(child.clone());\r\n    }\r\n    return newEntity;\r\n  }\r\n\r\n  /**\r\n   * Adds a copy of all the components from another template entity as a \"prefab\"\r\n   * @param templateEntity Entity to use as a template\r\n   * @param force Force component replacement if it already exists on the target entity\r\n   */\r\n  public addTemplate(templateEntity: Entity, force: boolean = false): Entity {\r\n    for (const c of templateEntity.getComponents()) {\r\n      this.addComponent(c.clone(), force);\r\n    }\r\n    for (const child of templateEntity.children) {\r\n      this.addChild(child.clone().addTemplate(child));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  private _getClassHierarchyRoot(componentType: ComponentCtor): ComponentCtor {\r\n    let current = componentType;\r\n    let parent = Object.getPrototypeOf(current.prototype)?.constructor;\r\n\r\n    while (parent && parent !== Object && parent !== Component) {\r\n      current = parent;\r\n      parent = Object.getPrototypeOf(current.prototype)?.constructor;\r\n    }\r\n    return current;\r\n  }\r\n\r\n  /**\r\n   * Adds a component to the entity\r\n   * @param component Component or Entity to add copy of components from\r\n   * @param force Optionally overwrite any existing components of the same type\r\n   */\r\n  public addComponent<TComponent extends Component>(component: TComponent, force: boolean = false): Entity<TKnownComponents | TComponent> {\r\n    // if component already exists, skip if not forced\r\n    if (this.has(component.constructor as ComponentCtor)) {\r\n      if (force) {\r\n        // Remove existing component type if exists when forced\r\n        this.removeComponent(component.constructor as ComponentCtor, true);\r\n      } else {\r\n        // early exit component exits\r\n        return this as Entity<TKnownComponents | TComponent>;\r\n      }\r\n    }\r\n\r\n    // TODO circular dependencies will be a problem\r\n    if (component.dependencies && component.dependencies.length) {\r\n      for (const ctor of component.dependencies) {\r\n        this.addComponent(new ctor());\r\n      }\r\n    }\r\n\r\n    component.owner = this;\r\n    const rootComponent = this._getClassHierarchyRoot(component.constructor as ComponentCtor);\r\n    this.components.set(rootComponent, component);\r\n    this.components.set(component.constructor, component);\r\n    this.componentValues.push(component);\r\n    if (component.onAdd) {\r\n      component.onAdd(this);\r\n    }\r\n\r\n    this.componentAdded$.notifyAll(component);\r\n    return this as Entity<TKnownComponents | TComponent>;\r\n  }\r\n\r\n  /**\r\n   * Removes a component from the entity, by default removals are deferred to the end of entity update to avoid consistency issues\r\n   *\r\n   * Components can be force removed with the `force` flag, the removal is not deferred and happens immediately\r\n   * @param typeOrInstance\r\n   * @param force\r\n   */\r\n  public removeComponent<TComponent extends Component>(\r\n    typeOrInstance: ComponentCtor<TComponent> | TComponent,\r\n    force = false\r\n  ): Entity<Exclude<TKnownComponents, TComponent>> {\r\n    let type: ComponentCtor<TComponent>;\r\n    if (isComponentCtor(typeOrInstance)) {\r\n      type = typeOrInstance;\r\n    } else {\r\n      type = typeOrInstance.constructor as ComponentCtor<TComponent>;\r\n    }\r\n\r\n    if (force) {\r\n      const componentToRemove = this.components.get(type);\r\n      if (componentToRemove) {\r\n        this.componentRemoved$.notifyAll(componentToRemove);\r\n        componentToRemove.owner = undefined;\r\n        if (componentToRemove.onRemove) {\r\n          componentToRemove.onRemove(this);\r\n        }\r\n        const componentIndex = this.componentValues.indexOf(componentToRemove);\r\n        if (componentIndex > -1) {\r\n          this.componentValues.splice(componentIndex, 1);\r\n        }\r\n      }\r\n\r\n      const rootComponent = this._getClassHierarchyRoot(type);\r\n      this.components.delete(rootComponent);\r\n      this.components.delete(type); // remove after the notify to preserve typing\r\n    } else {\r\n      this._componentsToRemove.push(type);\r\n    }\r\n\r\n    return this as any;\r\n  }\r\n\r\n  public clearComponents() {\r\n    const components = this.types;\r\n    for (const c of components) {\r\n      this.removeComponent(c);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @hidden\r\n   * @internal\r\n   */\r\n  public processComponentRemoval() {\r\n    for (const type of this._componentsToRemove) {\r\n      this.removeComponent(type, true);\r\n    }\r\n    this._componentsToRemove.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Check if a component type exists\r\n   * @param type\r\n   */\r\n  public has<TComponent extends Component>(type: ComponentCtor<TComponent>): boolean {\r\n    return this.components.has(type);\r\n  }\r\n\r\n  private _isInitialized = false;\r\n  private _isAdded = false;\r\n\r\n  /**\r\n   * Gets whether the actor is Initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  public get isAdded(): boolean {\r\n    return this._isAdded;\r\n  }\r\n\r\n  /**\r\n   * Initializes this entity, meant to be called by the Scene before first update not by users of Excalibur.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this.onInitialize(engine);\r\n      this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds this Actor, meant to be called by the Scene when Actor is added.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   * @internal\r\n   */\r\n  public _add(engine: Engine) {\r\n    if (!this.isAdded && this.isActive) {\r\n      this.onAdd(engine);\r\n      this.events.emit('add', new AddEvent(engine, this));\r\n      this._isAdded = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes Actor, meant to be called by the Scene when Actor is added.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   * @internal\r\n   */\r\n  public _remove(engine: Engine) {\r\n    if (this.isAdded && !this.isActive) {\r\n      this.onRemove(engine);\r\n      this.events.emit('remove', new RemoveEvent(engine, this));\r\n      this._isAdded = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPreUpdate} lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, elapsed: number): void {\r\n    this.events.emit('preupdate', new PreUpdateEvent(engine, elapsed, this));\r\n    this.onPreUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPostUpdate} lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, elapsed: number): void {\r\n    this.events.emit('postupdate', new PostUpdateEvent(engine, elapsed, this));\r\n    this.onPostUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   * `onInitialize` is called before the first update of the entity. This method is meant to be\r\n   * overridden.\r\n   *\r\n   * Synonymous with the event handler `.on('initialize', (evt) => {...})`\r\n   */\r\n  public onInitialize(engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * `onAdd` is called when Actor is added to scene. This method is meant to be\r\n   * overridden.\r\n   *\r\n   * Synonymous with the event handler `.on('add', (evt) => {...})`\r\n   */\r\n  public onAdd(engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * `onRemove` is called when Actor is added to scene. This method is meant to be\r\n   * overridden.\r\n   *\r\n   * Synonymous with the event handler `.on('remove', (evt) => {...})`\r\n   */\r\n  public onRemove(engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before an entity is updated.\r\n   */\r\n  public onPreUpdate(engine: Engine, elapsed: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('postupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after an entity is updated.\r\n   */\r\n  public onPostUpdate(engine: Engine, elapsed: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   *\r\n   * Entity update lifecycle, called internally\r\n   * @internal\r\n   * @param engine\r\n   * @param elapsed\r\n   */\r\n  public update(engine: Engine, elapsed: number): void {\r\n    this._initialize(engine);\r\n    this._add(engine);\r\n    this._preupdate(engine, elapsed);\r\n    for (const child of this.children) {\r\n      child.update(engine, elapsed);\r\n    }\r\n    this._postupdate(engine, elapsed);\r\n    this._remove(engine);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, event: EntityEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, handler: Handler<EntityEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, handler: Handler<EntityEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<EntityEvents>>(eventName: TEventName, handler: Handler<EntityEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<EntityEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    if (handler) {\r\n      this.events.off(eventName, handler);\r\n    } else {\r\n      this.events.off(eventName);\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Component } from '../Component';\r\n\r\nexport interface Motion {\r\n  /**\r\n   * The velocity of an entity in pixels per second\r\n   */\r\n  vel: Vector;\r\n\r\n  /**\r\n   * The acceleration of entity in pixels per second^2\r\n   */\r\n  acc: Vector;\r\n\r\n  /**\r\n   * The scale rate of change in scale units per second\r\n   */\r\n  scaleFactor: Vector;\r\n\r\n  /**\r\n   * The angular velocity which is how quickly the entity is rotating in radians per second\r\n   */\r\n  angularVelocity: number;\r\n\r\n  /**\r\n   * The amount of torque applied to the entity, angular acceleration is torque * inertia\r\n   */\r\n  torque: number;\r\n\r\n  /**\r\n   * Inertia can be thought of as the resistance to motion\r\n   */\r\n  inertia: number;\r\n}\r\n\r\nexport class MotionComponent extends Component {\r\n  /**\r\n   * The velocity of an entity in pixels per second\r\n   */\r\n  public vel: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The acceleration of entity in pixels per second^2\r\n   */\r\n  public acc: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The scale rate of change in scale units per second\r\n   */\r\n  public scaleFactor: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The angular velocity which is how quickly the entity is rotating in radians per second\r\n   */\r\n  public angularVelocity = 0;\r\n\r\n  /**\r\n   * The amount of torque applied to the entity, angular acceleration is torque * inertia\r\n   */\r\n  public torque: number = 0;\r\n\r\n  /**\r\n   * Inertia can be thought of as the resistance to motion\r\n   */\r\n  public inertia: number = 1;\r\n}\r\n","import { Vector } from '../Math/vector';\nimport { TransformComponent } from '../EntityComponentSystem';\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\n\nexport class EulerIntegrator {\n  // Scratch vectors to avoid allocation\n  private static _POS = new Vector(0, 0);\n  private static _SCALE = new Vector(1, 1);\n\n  private static _ACC = new Vector(0, 0);\n  private static _VEL = new Vector(0, 0);\n  private static _VEL_ACC = new Vector(0, 0);\n  private static _SCALE_FACTOR = new Vector(0, 0);\n\n  static integrate(transform: TransformComponent, motion: MotionComponent, totalAcc: Vector, elapsed: number): void {\n    const seconds = elapsed / 1000;\n    // This code looks a little wild, but it's to avoid creating any new Vector instances\n    // integration is done in a tight loop so this is key to avoid GC'ing\n    motion.vel.addEqual(totalAcc.scale(seconds, EulerIntegrator._ACC));\n    transform.pos\n      .add(motion.vel.scale(seconds, EulerIntegrator._VEL), EulerIntegrator._POS)\n      .addEqual(totalAcc.scale(0.5 * seconds * seconds, EulerIntegrator._VEL_ACC));\n\n    motion.angularVelocity += motion.torque * (1.0 / motion.inertia) * seconds;\n    const rotation = transform.rotation + motion.angularVelocity * seconds;\n\n    transform.scale.add(motion.scaleFactor.scale(seconds, this._SCALE_FACTOR), EulerIntegrator._SCALE);\n    const tx = transform.get();\n    tx.setTransform(EulerIntegrator._POS, rotation, EulerIntegrator._SCALE);\n  }\n}\n","import { Engine } from '../Engine';\r\nimport { Color } from '../Color';\r\nimport { Vector, vec } from '../Math/vector';\r\nimport { Random } from '../Math/Random';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { clamp } from '../Math/util';\r\nimport { Graphic } from '../Graphics';\r\nimport { EmitterType } from './EmitterType';\r\nimport { MotionComponent } from '../EntityComponentSystem';\r\nimport { EulerIntegrator } from '../Collision/Integrator';\r\nimport type { ParticleEmitter } from './ParticleEmitter';\r\n\r\n/**\r\n/**\r\n * CPU Particle is used in a {@apilink ParticleEmitter}\r\n */\r\nexport class Particle extends Entity {\r\n  public static DefaultConfig: ParticleConfig = {\r\n    beginColor: Color.White,\r\n    endColor: Color.White,\r\n    life: 300,\r\n    fade: false,\r\n    size: 5,\r\n    graphic: undefined,\r\n    startSize: undefined,\r\n    endSize: undefined\r\n  };\r\n\r\n  public focus?: Vector;\r\n  public focusAccel?: number;\r\n  public beginColor: Color = Color.White;\r\n  public endColor: Color = Color.White;\r\n\r\n  // Life is counted in ms\r\n  public life: number = 300;\r\n  public fade: boolean = false;\r\n\r\n  // Color transitions\r\n  private _rRate: number = 1;\r\n  private _gRate: number = 1;\r\n  private _bRate: number = 1;\r\n  private _aRate: number = 0;\r\n  private _currentColor: Color = Color.White;\r\n\r\n  public size: number = 5;\r\n  public graphic?: Graphic;\r\n\r\n  public startSize?: number;\r\n  public endSize?: number;\r\n  public sizeRate: number = 0;\r\n\r\n  public visible = true;\r\n  public isOffscreen = false;\r\n\r\n  public transform: TransformComponent;\r\n  public motion: MotionComponent;\r\n  public graphics: GraphicsComponent;\r\n  public particleTransform = ParticleTransform.Global;\r\n\r\n  public name = `Particle#${this.id}`;\r\n\r\n  constructor(options: ParticleConfig) {\r\n    super({ silenceWarnings: true });\r\n    this.addComponent((this.transform = new TransformComponent()));\r\n    this.addComponent((this.motion = new MotionComponent()));\r\n    this.addComponent((this.graphics = new GraphicsComponent()));\r\n    this.configure(options);\r\n  }\r\n\r\n  private _emitter?: ParticleEmitter;\r\n  registerEmitter(emitter: ParticleEmitter) {\r\n    this._emitter = emitter;\r\n    if (this.particleTransform === ParticleTransform.Global) {\r\n      const globalPos = this._emitter.transform.globalPos;\r\n      this.transform.pos = this.transform.pos.add(globalPos);\r\n      this.motion.vel = this.motion.vel.rotate(this._emitter.transform.globalRotation);\r\n    }\r\n  }\r\n\r\n  configure(options: ParticleConfig) {\r\n    this.particleTransform = options.transform ?? this.particleTransform;\r\n    this.life = options.life ?? this.life;\r\n    this.fade = options.fade ?? this.fade;\r\n    this.size = options.size ?? this.size;\r\n    this.endColor = options.endColor ?? this.endColor.clone();\r\n    this.beginColor = options.beginColor ?? this.beginColor.clone();\r\n    this._currentColor = this.beginColor.clone();\r\n\r\n    this.graphic = options.graphic;\r\n    this.graphics.opacity = options.opacity ?? this.graphics.opacity;\r\n    this.transform.pos = options.pos ?? this.transform.pos;\r\n    this.transform.rotation = options.rotation ?? 0;\r\n    this.transform.scale = vec(1, 1);\r\n\r\n    this.motion.vel = options.vel ?? this.motion.vel;\r\n    this.motion.angularVelocity = options.angularVelocity ?? 0;\r\n    this.motion.acc = options.acc ?? this.motion.acc;\r\n\r\n    this._rRate = (this.endColor.r - this.beginColor.r) / this.life;\r\n    this._gRate = (this.endColor.g - this.beginColor.g) / this.life;\r\n    this._bRate = (this.endColor.b - this.beginColor.b) / this.life;\r\n    this._aRate = this.graphics.opacity / this.life;\r\n\r\n    this.startSize = options.startSize ?? 0;\r\n    this.endSize = options.endSize ?? 0;\r\n\r\n    if (this.endSize > 0 && this.startSize > 0) {\r\n      this.sizeRate = (this.endSize - this.startSize) / this.life;\r\n      this.size = this.startSize;\r\n    }\r\n    if (this.graphic) {\r\n      this.graphics.use(this.graphic);\r\n      this.graphics.onPostDraw = undefined;\r\n    } else {\r\n      this.graphics.localBounds = BoundingBox.fromDimension(this.size, this.size, Vector.Half);\r\n      this.graphics.onPostDraw = (ctx) => {\r\n        ctx.save();\r\n        ctx.debug.drawPoint(vec(0, 0), { color: this._currentColor, size: this.size });\r\n        ctx.restore();\r\n      };\r\n    }\r\n  }\r\n\r\n  public override kill() {\r\n    if (this._emitter?.isActive) {\r\n      this._emitter.removeParticle(this);\r\n    } else {\r\n      super.kill();\r\n    }\r\n  }\r\n\r\n  public update(engine: Engine, elapsed: number) {\r\n    this.life = this.life - elapsed;\r\n\r\n    if (this.life < 0) {\r\n      this.kill();\r\n    }\r\n\r\n    if (this.fade) {\r\n      this.graphics.opacity = clamp(this._aRate * this.life, 0.0001, 1);\r\n    }\r\n\r\n    if (this.startSize && this.endSize && this.startSize > 0 && this.endSize > 0) {\r\n      this.size = clamp(\r\n        this.sizeRate * elapsed + this.size,\r\n        Math.min(this.startSize, this.endSize),\r\n        Math.max(this.startSize, this.endSize)\r\n      );\r\n    }\r\n\r\n    this._currentColor.r = clamp(this._currentColor.r + this._rRate * elapsed, 0, 255);\r\n    this._currentColor.g = clamp(this._currentColor.g + this._gRate * elapsed, 0, 255);\r\n    this._currentColor.b = clamp(this._currentColor.b + this._bRate * elapsed, 0, 255);\r\n    this._currentColor.a = this.graphics.opacity;\r\n\r\n    let accel = this.motion.acc;\r\n    if (this.focus) {\r\n      accel = this.focus\r\n        .sub(this.transform.pos)\r\n        .normalize()\r\n        .scale(this.focusAccel || 0)\r\n        .scale(elapsed / 1000);\r\n    }\r\n    // Update transform and motion based on Euler linear algebra\r\n    EulerIntegrator.integrate(this.transform, this.motion, accel, elapsed);\r\n  }\r\n}\r\n\r\nexport interface ParticleConfig {\r\n  /**\r\n   * Optionally set the emitted particle transform style, {@apilink ParticleTransform.Global} is the default and emits particles as if\r\n   * they were world space objects, useful for most effects.\r\n   *\r\n   * If set to {@apilink ParticleTransform.Local} particles are children of the emitter and move relative to the emitter\r\n   * as they would in a parent/child actor relationship.\r\n   */\r\n  transform?: ParticleTransform;\r\n  /**\r\n   * Starting position of the particle\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Starting velocity of the particle\r\n   */\r\n  vel?: Vector;\r\n  /**\r\n   * Starting acceleration of the particle\r\n   */\r\n  acc?: Vector;\r\n  /**\r\n   * Starting angular velocity of the particle\r\n   */\r\n  angularVelocity?: number;\r\n  /**\r\n   * Starting rotation of the particle\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * Size of the particle in pixels\r\n   */\r\n  size?: number;\r\n  /**\r\n   * Optionally set a graphic\r\n   */\r\n  graphic?: Graphic;\r\n  /**\r\n   * Totally life of the particle in milliseconds\r\n   */\r\n  life?: number;\r\n  /**\r\n   * Starting opacity of the particle\r\n   */\r\n  opacity?: number;\r\n  /**\r\n   * Should the particle fade out to fully transparent over their life\r\n   */\r\n  fade?: boolean;\r\n\r\n  /**\r\n   * Ending color of the particle over its life\r\n   */\r\n  endColor?: Color;\r\n  /**\r\n   * Beginning color of the particle over its life\r\n   */\r\n  beginColor?: Color;\r\n\r\n  /**\r\n   * Set the start size when you want to change particle size over their life\r\n   */\r\n  startSize?: number;\r\n  /**\r\n   * Set the end size when you want to change particle size over their life\r\n   */\r\n  endSize?: number;\r\n\r\n  /**\r\n   * Smallest possible starting size of the particle\r\n   */\r\n  minSize?: number;\r\n  /**\r\n   * Largest possible starting size of the particle\r\n   */\r\n  maxSize?: number;\r\n  /**\r\n   * Minimum magnitude of the particle starting speed\r\n   */\r\n  minSpeed?: number;\r\n  /**\r\n   * Maximum magnitude of the particle starting speed\r\n   */\r\n  maxSpeed?: number;\r\n  /**\r\n   * Minimum angle to use for the particles starting rotation\r\n   */\r\n  minAngle?: number;\r\n  /**\r\n   * Maximum angle to use for the particles starting rotation\r\n   */\r\n  maxAngle?: number;\r\n\r\n  /**\r\n   * Gets or sets the optional focus where all particles should accelerate towards\r\n   *\r\n   * If the particle transform is global the focus is in world space, otherwise it is relative to the emitter\r\n   */\r\n  focus?: Vector;\r\n  /**\r\n   * Gets or sets the optional acceleration for focusing particles if a focus has been specified\r\n   */\r\n  focusAccel?: number;\r\n\r\n  /**\r\n   * Indicates whether particles should start with a random rotation\r\n   */\r\n  randomRotation?: boolean;\r\n}\r\n\r\nexport enum ParticleTransform {\r\n  /**\r\n   * {@apilink ParticleTransform.Global} is the default and emits particles as if\r\n   * they were world space objects, useful for most effects.\r\n   */\r\n  Global = 'global',\r\n  /**\r\n   * {@apilink ParticleTransform.Local} particles are children of the emitter and move relative to the emitter\r\n   * as they would in a parent/child actor relationship.\r\n   */\r\n  Local = 'local'\r\n}\r\n\r\nexport interface ParticleEmitterArgs {\r\n  particle?: ParticleConfig;\r\n  x?: number;\r\n  y?: number;\r\n  z?: number;\r\n  pos?: Vector;\r\n  width?: number;\r\n  height?: number;\r\n  /**\r\n   * Is emitting currently\r\n   */\r\n  isEmitting?: boolean;\r\n  /**\r\n   * Particles per second\r\n   */\r\n  emitRate?: number;\r\n  focus?: Vector;\r\n  focusAccel?: number;\r\n  /**\r\n   * Emitter shape\r\n   */\r\n  emitterType?: EmitterType;\r\n  /**\r\n   * Radius of the emitter if the emitter type is EmitterType.Circle\r\n   */\r\n  radius?: number;\r\n  random?: Random;\r\n}\r\n","import { ExcaliburGraphicsContextWebGL } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport particleVertexSource from './particle-vertex.glsl';\r\nimport particleFragmentSource from './particle-fragment.glsl';\r\nimport { GpuParticleRenderer } from '../../../Particles/GpuParticleRenderer';\r\nimport { vec } from '../../../Math/vector';\r\nimport { Color } from '../../../Color';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ImageSourceAttributeConstants } from '../../ImageSource';\r\nimport { parseImageWrapping } from '../../Wrapping';\r\nimport { parseImageFiltering } from '../../Filtering';\r\nimport { ParticleTransform } from '../../../Particles/Particles';\r\n\r\nexport class ParticleRenderer implements RendererPlugin {\r\n  public readonly type = 'ex.particle' as const;\r\n  public priority: number = 0;\r\n  private _gl!: WebGL2RenderingContext;\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _shader!: Shader;\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: particleVertexSource,\r\n      fragmentSource: particleFragmentSource,\r\n      onPreLink: (program) => {\r\n        gl.transformFeedbackVaryings(\r\n          program,\r\n          ['finalPosition', 'finalVelocity', 'finalRotation', 'finalAngularVelocity', 'finalLifeMs'],\r\n          gl.INTERLEAVED_ATTRIBS\r\n        );\r\n      }\r\n    });\r\n    this._shader.compile();\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n  }\r\n\r\n  private _getTexture(image: HTMLImageSource) {\r\n    const maybeFiltering = image.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : undefined;\r\n    const wrapX = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingX) as any);\r\n    const wrapY = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingY) as any);\r\n\r\n    const force = image.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._context.textureLoader.load(\r\n      image,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force\r\n    )!;\r\n    // remove force attribute after upload\r\n    image.removeAttribute('forceUpload');\r\n    return texture;\r\n  }\r\n\r\n  draw(renderer: GpuParticleRenderer, elapsed: number): void {\r\n    const gl = this._gl;\r\n\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n    const transform =\r\n      renderer.particle.transform === ParticleTransform.Local\r\n        ? this._context.getTransform()\r\n        : this._context.getTransform().multiply(renderer.emitter.transform.get().inverse);\r\n    this._shader.setUniformAffineMatrix('u_transform', transform);\r\n    this._shader.setUniformBoolean('fade', renderer.particle.fade ? true : false);\r\n    this._shader.setUniformBoolean('useTexture', renderer.particle.graphic ? true : false);\r\n    this._shader.setUniformFloat('maxLifeMs', renderer.particle.life ?? 2000);\r\n    this._shader.setUniformFloat('deltaMs', elapsed);\r\n    this._shader.setUniformFloatVector('gravity', renderer.particle.acc ?? vec(0, 0));\r\n    this._shader.setUniformFloatColor('beginColor', renderer.particle.beginColor ?? Color.Transparent);\r\n    this._shader.setUniformFloatColor('endColor', renderer.particle.endColor ?? Color.Transparent);\r\n\r\n    let startSize = renderer.particle.startSize ?? 0;\r\n    let endSize = renderer.particle.endSize ?? 0;\r\n    const size = renderer.particle.size ?? 0;\r\n    if (size > 0) {\r\n      startSize = size;\r\n      endSize = size;\r\n    }\r\n\r\n    this._shader.setUniformFloat('startSize', startSize ?? 10);\r\n    this._shader.setUniformFloat('endSize', endSize ?? 10);\r\n    this._shader.setUniformFloat('startOpacity', renderer.particle.opacity ?? 1);\r\n\r\n    if (renderer.particle.focus) {\r\n      this._shader.setUniformFloatVector('focus', renderer.particle.focus);\r\n      this._shader.setUniformFloat('focusAccel', renderer.particle.focusAccel ?? 0);\r\n    }\r\n\r\n    // Particle Graphic (only Sprites right now)\r\n    if (renderer.particle.graphic) {\r\n      const graphic = renderer.particle.graphic;\r\n\r\n      const texture = this._getTexture(graphic.image.image);\r\n\r\n      gl.activeTexture(gl.TEXTURE0);\r\n      gl.bindTexture(gl.TEXTURE_2D, texture);\r\n      this._shader.setUniformInt('graphic', 0);\r\n    }\r\n\r\n    // Collision Mask\r\n    // gl.activeTexture(gl.TEXTURE0 + 1);\r\n    // gl.bindTexture(gl.TEXTURE_2D, obstacleTex);\r\n    // gl.uniform1i(u_obstacle, 1);\r\n\r\n    renderer.draw(gl);\r\n  }\r\n  hasPendingDraws(): boolean {\r\n    return false;\r\n  }\r\n  flush(): void {\r\n    // pass\r\n  }\r\n  dispose(): void {\r\n    // pass\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\nuniform float deltaMs;\\r\\nuniform float maxLifeMs;\\r\\nuniform vec2 gravity;\\r\\nuniform vec2 focus;\\r\\nuniform float focusAccel;\\r\\nuniform mat4 u_matrix;\\r\\nuniform mat4 u_transform;\\r\\nuniform float startSize;\\r\\nuniform float endSize;\\r\\n// uniform sampler2D obstacle;\\r\\n\\r\\nlayout(location=0)in vec2 position;\\r\\nlayout(location=1)in vec2 velocity;\\r\\nlayout(location=2)in float rotation;\\r\\nlayout(location=3)in float angularVelocity;\\r\\nlayout(location=4)in float lifeMs;\\r\\n\\r\\n// TODO z index to handle buffer wrapping?\\r\\n\\r\\n// DO NOT RE-ORDER\\r\\nout vec2 finalPosition;\\r\\nout vec2 finalVelocity;\\r\\nout float finalRotation;\\r\\nout float finalAngularVelocity;\\r\\nout float finalLifeMs;\\r\\nvoid main(){\\r\\n  // Evolve particle\\r\\n  float seconds = deltaMs / 1000.;\\r\\n  // euler integration\\r\\n  // Weird artifact of re-using the same buffer layout for update/draw\\r\\n  // we need differently named variables\\r\\n  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\\r\\n  finalVelocity = velocity + finalGravity * seconds;\\r\\n  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\\r\\n  finalRotation = rotation + angularVelocity * seconds;\\r\\n  finalAngularVelocity = angularVelocity;\\r\\n  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\\r\\n\\r\\n  // Collision mask sampling\\r\\n  // vec2 samplePoint = finalPosition / vec2(width, height);\\r\\n  // vec4 collides = texture(obstacle, samplePoint);\\r\\n  // if (distance(collides,vec4(0.)) > .01) {\\r\\n  //   // non opaque means we collide! recalc final pos/vel\\r\\n  //   vec2 newVelocity = velocity * -.1;// lose energy\\r\\n  //   finalVelocity = newVelocity + gravity * seconds;\\r\\n  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\\r\\n  // }\\r\\n\\r\\n  float lifePercent = finalLifeMs / maxLifeMs;\\r\\n  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\\r\\n  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\\r\\n  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\\r\\n  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\\r\\n}\";","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\nuniform sampler2D graphic;\\r\\nuniform bool useTexture;\\r\\nuniform float maxLifeMs;\\r\\n\\r\\nuniform vec4 beginColor;\\r\\nuniform vec4 endColor;\\r\\nuniform bool fade;\\r\\nuniform float startOpacity;\\r\\n\\r\\nin float finalRotation;\\r\\nin float finalLifeMs;\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main(){\\r\\n\\r\\n  float lifePct = finalLifeMs / maxLifeMs;\\r\\n\\r\\n  if (useTexture) {\\r\\n    /** Draw texture */\\r\\n    if (lifePct <= 0.) discard;\\r\\n    float mid = .5;\\r\\n    float cosine = cos(finalRotation);\\r\\n    float sine = sin(finalRotation);\\r\\n    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\\r\\n                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\\r\\n    vec4 color = texture(graphic, rotated);\\r\\n    fragColor = color * (fade ? lifePct : 1.0);\\r\\n  } else {\\r\\n    /** Draw circle */\\r\\n    if (lifePct <= 0.) discard;\\r\\n    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\\r\\n    float dist = 1.0 - length(uv);\\r\\n    float edge = fwidth(dot(uv, uv));\\r\\n    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\\r\\n    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\\r\\n    fragColor.rgb = color;\\r\\n    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\\r\\n    fragColor.rgb *= fragColor.a;\\r\\n  }\\r\\n}\";","// import { Color } from '../../../Color';\r\n// import { parseImageFiltering } from '../../Filtering';\r\nimport { Color } from '../../../Color';\r\nimport { parseImageFiltering } from '../../Filtering';\r\nimport { GraphicsDiagnostics } from '../../GraphicsDiagnostics';\r\nimport { ImageSourceAttributeConstants } from '../../ImageSource';\r\nimport { parseImageWrapping } from '../../Wrapping';\r\n// import { ImageSourceAttributeConstants } from '../../ImageSource';\r\n// import { parseImageWrapping } from '../../Wrapping';\r\nimport { HTMLImageSource } from '../ExcaliburGraphicsContext';\r\nimport { ExcaliburGraphicsContextWebGL, pixelSnapEpsilon } from '../ExcaliburGraphicsContextWebGL';\r\nimport { RendererPlugin } from '../renderer';\r\nimport { Shader } from '../shader';\r\nimport { VertexBuffer } from '../vertex-buffer';\r\nimport { getMaxShaderComplexity } from '../webgl-util';\r\nimport frag from './image-renderer-v2.frag.glsl';\r\nimport vert from './image-renderer-v2.vert.glsl';\r\n\r\nexport interface ImageRendererOptions {\r\n  pixelArtSampler: boolean;\r\n  uvPadding: number;\r\n}\r\n\r\nexport class ImageRendererV2 implements RendererPlugin {\r\n  public readonly type = 'ex.image-v2';\r\n  public priority: number = 0;\r\n\r\n  public readonly pixelArtSampler: boolean;\r\n  public readonly uvPadding: number;\r\n\r\n  // TODO this could be bigger probably\r\n  private _maxImages: number = 20_000; // max(uint16) / 6 verts\r\n  private _maxTextures: number = 0;\r\n  private _components = 2 + 2 + 2 + 2 + 1 + 2 + 2 + 1 + 2 + 2 + 4;\r\n\r\n  private _context!: ExcaliburGraphicsContextWebGL;\r\n  private _gl!: WebGL2RenderingContext;\r\n  private _shader!: Shader;\r\n  private _transformData!: VertexBuffer;\r\n\r\n  // Per flush vars\r\n  private _imageCount: number = 0;\r\n  private _textures: WebGLTexture[] = [];\r\n  private _textureIndex = 0;\r\n  private _textureToIndex = new Map<WebGLTexture, number>();\r\n  private _images = new Set<HTMLImageSource>();\r\n  private _vertexIndex: number = 0;\r\n  private _quadMesh!: Float32Array;\r\n  private _meshBuffer!: WebGLBuffer;\r\n  private _vao!: WebGLVertexArrayObject;\r\n\r\n  constructor(options: ImageRendererOptions) {\r\n    this.pixelArtSampler = options.pixelArtSampler;\r\n    this.uvPadding = options.uvPadding;\r\n  }\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL): void {\r\n    this._gl = gl;\r\n    this._context = context;\r\n    // Transform shader source\r\n    const maxTexture = gl.getParameter(gl.MAX_TEXTURE_IMAGE_UNITS);\r\n    const maxComplexity = getMaxShaderComplexity(gl, maxTexture);\r\n    this._maxTextures = Math.min(maxTexture, maxComplexity);\r\n    const transformedFrag = this._transformFragmentSource(frag, this._maxTextures);\r\n    // Compile shader\r\n    this._shader = new Shader({\r\n      gl,\r\n      fragmentSource: transformedFrag,\r\n      vertexSource: vert\r\n    });\r\n    this._shader.compile();\r\n\r\n    // setup uniforms\r\n    this._shader.use();\r\n    this._shader.setUniformMatrix('u_matrix', context.ortho);\r\n    // Initialize texture slots to [0, 1, 2, 3, 4, .... maxGPUTextures]\r\n    this._shader.setUniformIntArray(\r\n      'u_textures',\r\n      [...Array(this._maxTextures)].map((_, i) => i)\r\n    );\r\n\r\n    this._vao = gl.createVertexArray()!;\r\n    gl.bindVertexArray(this._vao);\r\n    this._quadMesh = new Float32Array([\r\n      // pos       uv\r\n      0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0,\r\n\r\n      1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1\r\n    ]);\r\n    this._meshBuffer = gl.createBuffer()!;\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, this._meshBuffer);\r\n    gl.bufferData(gl.ARRAY_BUFFER, this._quadMesh, gl.STATIC_DRAW);\r\n    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 16, 0);\r\n    gl.enableVertexAttribArray(0);\r\n    gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 16, 8);\r\n    gl.enableVertexAttribArray(1);\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\n    // Setup memory layout\r\n    const components = this._components;\r\n    this._transformData = new VertexBuffer({\r\n      gl,\r\n      size: components * this._maxImages, // components * images\r\n      type: 'dynamic'\r\n    });\r\n\r\n    this._transformData.bind();\r\n\r\n    // attributes\r\n    let offset = 0;\r\n    let start = 2;\r\n    const bytesPerFloat = 4;\r\n    const totalSize = components * 4;\r\n\r\n    // a_offset vec2 - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(2);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_mat_column1 vec2 - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(3);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_mat_column2 vec2 - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(4);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_mat_column3 vec2 - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(5);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_opacity float - 1\r\n    gl.vertexAttribPointer(start++, 1, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(6);\r\n    offset += 1 * bytesPerFloat;\r\n\r\n    // a_res vec2 - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(7);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_size vec2 - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(8);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_texture_index - 1\r\n    gl.vertexAttribPointer(start++, 1, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(9);\r\n    offset += 1 * bytesPerFloat;\r\n\r\n    // a_uv_min - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(10);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_uv_max - 2\r\n    gl.vertexAttribPointer(start++, 2, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(11);\r\n    offset += 2 * bytesPerFloat;\r\n\r\n    // a_tint - 4\r\n    gl.vertexAttribPointer(start++, 4, gl.FLOAT, false, totalSize, offset);\r\n    gl.enableVertexAttribArray(12);\r\n    offset += 4 * bytesPerFloat;\r\n\r\n    gl.vertexAttribDivisor(2, 1);\r\n    gl.vertexAttribDivisor(3, 1);\r\n    gl.vertexAttribDivisor(4, 1);\r\n    gl.vertexAttribDivisor(5, 1);\r\n    gl.vertexAttribDivisor(6, 1);\r\n    gl.vertexAttribDivisor(7, 1);\r\n    gl.vertexAttribDivisor(8, 1);\r\n    gl.vertexAttribDivisor(9, 1);\r\n    gl.vertexAttribDivisor(10, 1);\r\n    gl.vertexAttribDivisor(11, 1);\r\n    gl.vertexAttribDivisor(12, 1);\r\n\r\n    gl.bindVertexArray(null);\r\n  }\r\n\r\n  private _bindData(gl: WebGL2RenderingContext) {\r\n    // Setup memory layout\r\n    const components = this._components;\r\n    this._transformData.bind();\r\n    this._transformData.upload(components * this._imageCount);\r\n\r\n    gl.bindVertexArray(this._vao);\r\n  }\r\n\r\n  public dispose() {\r\n    this._transformData.dispose();\r\n    this._shader.dispose();\r\n    this._textures.length = 0;\r\n    this._context = null as any;\r\n    this._gl = null as any;\r\n  }\r\n\r\n  private _transformFragmentSource(source: string, maxTextures: number): string {\r\n    let newSource = source.replace('%%count%%', maxTextures.toString());\r\n    let texturePickerBuilder = '';\r\n    for (let i = 0; i < maxTextures; i++) {\r\n      if (i === 0) {\r\n        texturePickerBuilder += `if (v_texture_index <= ${i}.5) {\\n`;\r\n      } else {\r\n        texturePickerBuilder += `   else if (v_texture_index <= ${i}.5) {\\n`;\r\n      }\r\n      texturePickerBuilder += `      color = texture(u_textures[${i}], uv);\\n`;\r\n      texturePickerBuilder += `   }\\n`;\r\n    }\r\n    newSource = newSource.replace('%%texture_picker%%', texturePickerBuilder);\r\n    return newSource;\r\n  }\r\n\r\n  private _addImageAsTexture(image: HTMLImageSource) {\r\n    if (this._images.has(image)) {\r\n      return;\r\n    }\r\n    const maybeFiltering = image.getAttribute(ImageSourceAttributeConstants.Filtering);\r\n    const filtering = maybeFiltering ? parseImageFiltering(maybeFiltering) : undefined;\r\n    const wrapX = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingX) as any);\r\n    const wrapY = parseImageWrapping(image.getAttribute(ImageSourceAttributeConstants.WrappingY) as any);\r\n\r\n    const force = image.getAttribute('forceUpload') === 'true' ? true : false;\r\n    const texture = this._context.textureLoader.load(\r\n      image,\r\n      {\r\n        filtering,\r\n        wrapping: { x: wrapX, y: wrapY }\r\n      },\r\n      force\r\n    )!;\r\n    // remove force attribute after upload\r\n    image.removeAttribute('forceUpload');\r\n    if (this._textures.indexOf(texture) === -1) {\r\n      this._textures.push(texture);\r\n      this._textureToIndex.set(texture, this._textureIndex++);\r\n      this._images.add(image);\r\n    }\r\n  }\r\n\r\n  private _bindTextures(gl: WebGLRenderingContext) {\r\n    // Bind textures in the correct order\r\n    const max = Math.min(this._textureIndex, this._maxTextures);\r\n    for (let i = 0; i < max; i++) {\r\n      gl.activeTexture(gl.TEXTURE0 + i);\r\n      gl.bindTexture(gl.TEXTURE_2D, this._textures[i] || this._textures[0]);\r\n    }\r\n  }\r\n\r\n  private _getTextureIdForImage(image: HTMLImageSource) {\r\n    if (image) {\r\n      const maybeTexture = this._context.textureLoader.get(image);\r\n      return this._textureToIndex.get(maybeTexture) ?? -1; //this._textures.indexOf(maybeTexture);\r\n    }\r\n    return -1;\r\n  }\r\n\r\n  private _isFull() {\r\n    if (this._imageCount >= this._maxImages) {\r\n      return true;\r\n    }\r\n    if (this._textures.length >= this._maxTextures) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private _imageToWidth = new Map<HTMLImageSource, number>();\r\n  private _getImageWidth(image: HTMLImageSource) {\r\n    let maybeWidth = this._imageToWidth.get(image);\r\n    if (maybeWidth === undefined) {\r\n      maybeWidth = image.width;\r\n      this._imageToWidth.set(image, maybeWidth);\r\n    }\r\n    return maybeWidth;\r\n  }\r\n\r\n  private _imageToHeight = new Map<HTMLImageSource, number>();\r\n  private _getImageHeight(image: HTMLImageSource) {\r\n    let maybeHeight = this._imageToHeight.get(image);\r\n    if (maybeHeight === undefined) {\r\n      maybeHeight = image.height;\r\n      this._imageToHeight.set(image, maybeHeight);\r\n    }\r\n    return maybeHeight;\r\n  }\r\n\r\n  private _view = [0, 0, 0, 0];\r\n  private _dest = [0, 0];\r\n  private _defaultTint = Color.White;\r\n  draw(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    // Force a render if the batch is full\r\n    if (this._isFull()) {\r\n      this.flush();\r\n    }\r\n\r\n    this._imageCount++;\r\n    // This creates and uploads the texture if not already done\r\n    this._addImageAsTexture(image);\r\n    const maybeImageWidth = this._getImageWidth(image);\r\n    const maybeImageHeight = this._getImageHeight(image);\r\n\r\n    let width = maybeImageWidth || swidth || 0;\r\n    let height = maybeImageHeight || sheight || 0;\r\n    this._view[0] = 0;\r\n    this._view[1] = 0;\r\n    this._view[2] = swidth ?? maybeImageWidth ?? 0;\r\n    this._view[3] = sheight ?? maybeImageHeight ?? 0;\r\n    this._dest[0] = sx ?? 1;\r\n    this._dest[1] = sy ?? 1;\r\n    // If destination is specified, update view and dest\r\n    if (dx !== undefined && dy !== undefined && dwidth !== undefined && dheight !== undefined) {\r\n      this._view[0] = sx ?? 1;\r\n      this._view[1] = sy ?? 1;\r\n      this._view[2] = swidth ?? maybeImageWidth ?? 0;\r\n      this._view[3] = sheight ?? maybeImageHeight ?? 0;\r\n      this._dest[0] = dx;\r\n      this._dest[1] = dy;\r\n      width = dwidth;\r\n      height = dheight;\r\n    }\r\n\r\n    sx = this._view[0];\r\n    sy = this._view[1];\r\n    const sw = this._view[2];\r\n    const sh = this._view[3];\r\n\r\n    // transform based on current context\r\n    const transform = this._context.getTransform();\r\n    const opacity = this._context.opacity;\r\n    const snapToPixel = this._context.snapToPixel;\r\n    if (snapToPixel) {\r\n      this._dest[0] = ~~(this._dest[0] + pixelSnapEpsilon);\r\n      this._dest[1] = ~~(this._dest[1] + pixelSnapEpsilon);\r\n    }\r\n\r\n    const tint = this._context.tint || this._defaultTint;\r\n\r\n    const textureId = this._getTextureIdForImage(image);\r\n    const imageWidth = maybeImageWidth || width;\r\n    const imageHeight = maybeImageHeight || height;\r\n\r\n    const uvx0 = (sx + this.uvPadding) / imageWidth;\r\n    const uvy0 = (sy + this.uvPadding) / imageHeight;\r\n    const uvx1 = (sx + sw - this.uvPadding) / imageWidth;\r\n    const uvy1 = (sy + sh - this.uvPadding) / imageHeight;\r\n\r\n    const txWidth = maybeImageWidth;\r\n    const txHeight = maybeImageHeight;\r\n\r\n    // update data\r\n    const vertexBuffer = this._transformData.bufferData;\r\n    vertexBuffer[this._vertexIndex++] = this._dest[0];\r\n    vertexBuffer[this._vertexIndex++] = this._dest[1];\r\n    vertexBuffer[this._vertexIndex++] = transform.data[0];\r\n    vertexBuffer[this._vertexIndex++] = transform.data[1];\r\n    vertexBuffer[this._vertexIndex++] = transform.data[2];\r\n    vertexBuffer[this._vertexIndex++] = transform.data[3];\r\n    vertexBuffer[this._vertexIndex++] = transform.data[4];\r\n    vertexBuffer[this._vertexIndex++] = transform.data[5];\r\n    vertexBuffer[this._vertexIndex++] = opacity;\r\n    vertexBuffer[this._vertexIndex++] = width;\r\n    vertexBuffer[this._vertexIndex++] = height;\r\n    vertexBuffer[this._vertexIndex++] = txWidth;\r\n    vertexBuffer[this._vertexIndex++] = txHeight;\r\n    vertexBuffer[this._vertexIndex++] = textureId;\r\n    vertexBuffer[this._vertexIndex++] = uvx0;\r\n    vertexBuffer[this._vertexIndex++] = uvy0;\r\n    vertexBuffer[this._vertexIndex++] = uvx1;\r\n    vertexBuffer[this._vertexIndex++] = uvy1;\r\n    vertexBuffer[this._vertexIndex++] = tint.r / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.g / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.b / 255;\r\n    vertexBuffer[this._vertexIndex++] = tint.a;\r\n  }\r\n\r\n  hasPendingDraws(): boolean {\r\n    return this._imageCount !== 0;\r\n  }\r\n\r\n  flush(): void {\r\n    // nothing to draw early exit\r\n    if (this._imageCount === 0) {\r\n      return;\r\n    }\r\n\r\n    const gl = this._gl;\r\n\r\n    // Bind the shader\r\n    this._shader.use();\r\n\r\n    // Bind the memory layout and upload data\r\n    this._bindData(gl);\r\n\r\n    // Update ortho matrix uniform\r\n    this._shader.setUniformMatrix('u_matrix', this._context.ortho);\r\n\r\n    // Turn on pixel art aa sampler\r\n    this._shader.setUniformBoolean('u_pixelart', this.pixelArtSampler);\r\n\r\n    // Bind textures to\r\n    this._bindTextures(gl);\r\n\r\n    // Draw all the quads\r\n    gl.drawArraysInstanced(gl.TRIANGLES, 0, 6, this._imageCount);\r\n\r\n    GraphicsDiagnostics.DrawnImagesCount += this._imageCount;\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n\r\n    gl.bindVertexArray(null);\r\n    // Reset\r\n    this._imageCount = 0;\r\n    this._vertexIndex = 0;\r\n    this._textures.length = 0;\r\n    this._textureIndex = 0;\r\n    this._textureToIndex.clear();\r\n    this._images.clear();\r\n    this._imageToWidth.clear();\r\n    this._imageToHeight.clear();\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n\\r\\n// UV coord\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// Textures in the current draw\\r\\nuniform sampler2D u_textures[%%count%%];\\r\\n\\r\\nuniform bool u_pixelart;\\r\\n\\r\\nin float v_texture_index;\\r\\n\\r\\nin float v_opacity;\\r\\n\\r\\nin vec4 v_tint;\\r\\n\\r\\n// texture resolution\\r\\nin vec2 v_res;\\r\\n\\r\\nin vec2 v_size;\\r\\n\\r\\nin vec2 v_uv_min;\\r\\nin vec2 v_uv_max;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\n// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\\r\\nvec2 uv_iq(in vec2 uv, in vec2 texture_size) {\\r\\n  vec2 pixel = uv * texture_size;\\r\\n\\r\\n  vec2 seam=floor(pixel+.5);\\r\\n  vec2 dudv=fwidth(pixel);\\r\\n  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\\r\\n\\r\\n  return pixel/texture_size;\\r\\n}\\r\\n\\r\\nfloat lerp(float from, float to, float rel){\\r\\n  return ((1. - rel) * from) + (rel * to);\\r\\n}\\r\\n\\r\\nfloat invLerp(float from, float to, float value){\\r\\n  return (value - from) / (to - from);\\r\\n}\\r\\n\\r\\nfloat remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\\r\\n  float rel = invLerp(origFrom, origTo, value);\\r\\n  return lerp(targetFrom, targetTo, rel);\\r\\n}\\r\\n\\r\\nvoid main(){\\r\\n  // In order to support the most efficient sprite batching, we have multiple\\r\\n  // textures loaded into the gpu (usually 8) this picker logic skips over textures\\r\\n  // that do not apply to a particular sprite.\\r\\n\\r\\n  vec4 color=vec4(1.,0,0,1.);\\r\\n  vec2 remapped_uv = v_texcoord;\\r\\n  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\\r\\n  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\\r\\n  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\\r\\n\\r\\n  // GLSL is templated out to pick the right texture and set the vec4 color\\r\\n  %%texture_picker%%\\r\\n\\r\\n  color.rgb = color.rgb * v_opacity;\\r\\n  color.a = color.a * v_opacity;\\r\\n  fragColor = color * v_tint;\\r\\n}\";","export default \"#version 300 es\\r\\nlayout(location=0) in vec2 pos;\\r\\nlayout(location=1) in vec2 a_texcoord;\\r\\nout vec2 v_texcoord;\\r\\n\\r\\nlayout(location=2) in vec2 a_offset;\\r\\nlayout(location=3) in vec2 a_mat_column1;\\r\\nlayout(location=4) in vec2 a_mat_column2;\\r\\nlayout(location=5) in vec2 a_mat_column3;\\r\\n\\r\\nlayout(location=6) in float a_opacity;\\r\\nout float v_opacity;\\r\\n\\r\\n// Texture resolution (could be bigger than a_size)\\r\\nlayout(location=7) in vec2 a_res;\\r\\nout vec2 v_res;\\r\\n\\r\\n// Final size of graphic\\r\\nlayout(location=8) in vec2 a_size;\\r\\nout vec2 v_size;\\r\\n\\r\\nlayout(location=9) in lowp float a_texture_index;\\r\\nout lowp float v_texture_index;\\r\\n\\r\\nlayout(location=10) in vec2 a_uv_min;\\r\\nout vec2 v_uv_min;\\r\\n\\r\\nlayout(location=11) in vec2 a_uv_max;\\r\\nout vec2 v_uv_max;\\r\\n\\r\\nlayout(location=12) in vec4 a_tint;\\r\\nout vec4 v_tint;\\r\\n\\r\\nuniform mat4 u_matrix;\\r\\n\\r\\nvoid main(){\\r\\n  mat4 world_mat = mat4(\\r\\n    a_mat_column1.x, a_mat_column1.y, 0., 0.,\\r\\n    a_mat_column2.x, a_mat_column2.y, 0., 0.,\\r\\n    0.             , 0.             , 1., 0.,\\r\\n    a_mat_column3.x, a_mat_column3.y, 0., 1.\\r\\n  );\\r\\n\\r\\n  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\\r\\n  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\\r\\n\\r\\n  v_opacity = a_opacity;\\r\\n  v_texcoord = a_texcoord;\\r\\n  v_uv_min = a_uv_min;\\r\\n  v_uv_max = a_uv_max;\\r\\n  v_res = a_res;\\r\\n  v_size = a_size;\\r\\n  v_texture_index = a_texture_index;\\r\\n  v_tint = a_tint;\\r\\n}\";","import {\r\n  ExcaliburGraphicsContext,\r\n  LineGraphicsOptions,\r\n  RectGraphicsOptions,\r\n  PointGraphicsOptions,\r\n  ExcaliburGraphicsContextOptions,\r\n  DebugDraw,\r\n  HTMLImageSource\r\n} from './ExcaliburGraphicsContext';\r\n\r\nimport { Matrix } from '../../Math/matrix';\r\nimport { TransformStack } from './transform-stack';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { StateStack } from './state-stack';\r\nimport { Logger } from '../../Util/Log';\r\nimport { DebugText } from './debug-text';\r\nimport { Resolution } from '../../Screen';\r\nimport { RenderTarget } from './render-target';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { TextureLoader } from './texture-loader';\r\nimport { RendererPlugin } from './renderer';\r\n\r\n// renderers\r\nimport { LineRenderer } from './line-renderer/line-renderer';\r\nimport { PointRenderer } from './point-renderer/point-renderer';\r\nimport { ScreenPassPainter } from './screen-pass-painter/screen-pass-painter';\r\nimport { ImageRenderer } from './image-renderer/image-renderer';\r\nimport { RectangleRenderer } from './rectangle-renderer/rectangle-renderer';\r\nimport { CircleRenderer } from './circle-renderer/circle-renderer';\r\nimport { Pool } from '../../Util/Pool';\r\nimport { DrawCall } from './draw-call';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Material, MaterialOptions } from './material';\r\nimport { MaterialRenderer } from './material-renderer/material-renderer';\r\nimport { Shader, ShaderOptions } from './shader';\r\nimport { GarbageCollector } from '../../GarbageCollector';\r\nimport { ParticleRenderer } from './particle-renderer/particle-renderer';\r\nimport { ImageRendererV2 } from './image-renderer-v2/image-renderer-v2';\r\nimport { Flags } from '../../Flags';\r\n\r\nexport const pixelSnapEpsilon = 0.0001;\r\n\r\nclass ExcaliburGraphicsContextWebGLDebug implements DebugDraw {\r\n  private _debugText = new DebugText();\r\n  constructor(private _webglCtx: ExcaliburGraphicsContextWebGL) {}\r\n\r\n  /**\r\n   * Draw a debugging rectangle to the context\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number, rectOptions: RectGraphicsOptions = { color: Color.Black }): void {\r\n    this.drawLine(vec(x, y), vec(x + width, y), { ...rectOptions });\r\n    this.drawLine(vec(x + width, y), vec(x + width, y + height), { ...rectOptions });\r\n    this.drawLine(vec(x + width, y + height), vec(x, y + height), { ...rectOptions });\r\n    this.drawLine(vec(x, y + height), vec(x, y), { ...rectOptions });\r\n  }\r\n\r\n  /**\r\n   * Draw a debugging line to the context\r\n   * @param start\r\n   * @param end\r\n   * @param lineOptions\r\n   */\r\n  drawLine(start: Vector, end: Vector, lineOptions?: LineGraphicsOptions): void {\r\n    this._webglCtx.draw<LineRenderer>('ex.line', start, end, lineOptions?.color ?? Color.Black);\r\n  }\r\n\r\n  /**\r\n   * Draw a debugging point to the context\r\n   * @param point\r\n   * @param pointOptions\r\n   */\r\n  drawPoint(point: Vector, pointOptions: PointGraphicsOptions = { color: Color.Black, size: 5 }): void {\r\n    this._webglCtx.draw<PointRenderer>('ex.point', point, pointOptions.color, pointOptions.size);\r\n  }\r\n\r\n  drawText(text: string, pos: Vector) {\r\n    this._debugText.write(this._webglCtx, text, pos);\r\n  }\r\n}\r\n\r\nexport interface WebGLGraphicsContextInfo {\r\n  transform: TransformStack;\r\n  state: StateStack;\r\n  ortho: Matrix;\r\n  context: ExcaliburGraphicsContextWebGL;\r\n}\r\n\r\nexport interface ExcaliburGraphicsContextWebGLOptions extends ExcaliburGraphicsContextOptions {\r\n  context?: WebGL2RenderingContext;\r\n  garbageCollector?: { garbageCollector: GarbageCollector; collectionInterval: number };\r\n  handleContextLost?: (e: Event) => void;\r\n  handleContextRestored?: (e: Event) => void;\r\n}\r\n\r\nexport class ExcaliburGraphicsContextWebGL implements ExcaliburGraphicsContext {\r\n  private _logger = Logger.getInstance();\r\n  private _renderers: Map<string, RendererPlugin> = new Map<string, RendererPlugin>();\r\n  private _lazyRenderersFactory: Map<string, () => RendererPlugin> = new Map<string, () => RendererPlugin>();\r\n  public imageRenderer: 'ex.image' | 'ex.image-v2' = Flags.isEnabled('use-legacy-image-renderer') ? 'ex.image' : 'ex.image-v2';\r\n  private _isDrawLifecycle = false;\r\n  public useDrawSorting = true;\r\n\r\n  private _drawCallPool = new Pool<DrawCall>(() => new DrawCall(), undefined, 4000);\r\n\r\n  private _drawCallIndex = 0;\r\n  private _drawCalls: DrawCall[] = new Array(4000).fill(null);\r\n\r\n  // Main render target\r\n  private _renderTarget!: RenderTarget;\r\n\r\n  // Quad boundary MSAA\r\n  private _msaaTarget!: RenderTarget;\r\n\r\n  // Postprocessing is a tuple with 2 render targets, these are flip-flopped during the postprocessing process\r\n  private _postProcessTargets: RenderTarget[] = [];\r\n\r\n  private _screenRenderer!: ScreenPassPainter;\r\n\r\n  private _postprocessors: PostProcessor[] = [];\r\n  /**\r\n   * Meant for internal use only. Access the internal context at your own risk and no guarantees this will exist in the future.\r\n   * @internal\r\n   */\r\n  public __gl: WebGL2RenderingContext;\r\n\r\n  private _transform = new TransformStack();\r\n  private _state = new StateStack();\r\n  private _ortho!: Matrix;\r\n\r\n  /**\r\n   * Snaps the drawing x/y coordinate to the nearest whole pixel\r\n   */\r\n  public snapToPixel: boolean = false;\r\n\r\n  /**\r\n   * Native context smoothing\r\n   */\r\n  public readonly smoothing: boolean = false;\r\n\r\n  /**\r\n   * Whether the pixel art sampler is enabled for smooth sub pixel anti-aliasing\r\n   */\r\n  public readonly pixelArtSampler: boolean = false;\r\n\r\n  /**\r\n   * UV padding in pixels to use in internal image rendering to prevent texture bleed\r\n   *\r\n   */\r\n  public uvPadding = 0.01;\r\n\r\n  public backgroundColor: Color = Color.ExcaliburBlue;\r\n\r\n  public textureLoader: TextureLoader;\r\n\r\n  public materialScreenTexture!: WebGLTexture | null;\r\n\r\n  public get z(): number {\r\n    return this._state.current.z;\r\n  }\r\n\r\n  public set z(value: number) {\r\n    this._state.current.z = value;\r\n  }\r\n\r\n  public get opacity(): number {\r\n    return this._state.current.opacity;\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    this._state.current.opacity = value;\r\n  }\r\n\r\n  public get tint(): Color | undefined | null {\r\n    return this._state.current.tint;\r\n  }\r\n\r\n  public set tint(color: Color | undefined | null) {\r\n    this._state.current.tint = color;\r\n  }\r\n\r\n  public get width() {\r\n    return this.__gl.canvas.width;\r\n  }\r\n\r\n  public get height() {\r\n    return this.__gl.canvas.height;\r\n  }\r\n\r\n  public get ortho(): Matrix {\r\n    return this._ortho;\r\n  }\r\n\r\n  /**\r\n   * Checks the underlying webgl implementation if the requested internal resolution is supported\r\n   * @param dim\r\n   */\r\n  public checkIfResolutionSupported(dim: Resolution): boolean {\r\n    // Slight hack based on this thread https://groups.google.com/g/webgl-dev-list/c/AHONvz3oQTo\r\n    let supported = true;\r\n    if (dim.width > 4096 || dim.height > 4096) {\r\n      supported = false;\r\n    }\r\n    return supported;\r\n  }\r\n\r\n  public readonly multiSampleAntialiasing: boolean = true;\r\n  public readonly samples?: number;\r\n  public readonly transparency: boolean = true;\r\n  private _isContextLost = false;\r\n\r\n  constructor(options: ExcaliburGraphicsContextWebGLOptions) {\r\n    const {\r\n      canvasElement,\r\n      context,\r\n      enableTransparency,\r\n      antialiasing,\r\n      uvPadding,\r\n      multiSampleAntialiasing,\r\n      pixelArtSampler,\r\n      powerPreference,\r\n      snapToPixel,\r\n      backgroundColor,\r\n      useDrawSorting,\r\n      garbageCollector,\r\n      handleContextLost,\r\n      handleContextRestored\r\n    } = options;\r\n    this.__gl =\r\n      context ??\r\n      (canvasElement.getContext('webgl2', {\r\n        antialias: antialiasing ?? this.smoothing,\r\n        premultipliedAlpha: false,\r\n        alpha: enableTransparency ?? this.transparency,\r\n        depth: false,\r\n        powerPreference: powerPreference ?? 'high-performance'\r\n      }) as WebGL2RenderingContext);\r\n    if (!this.__gl) {\r\n      throw Error('Failed to retrieve webgl context from browser');\r\n    }\r\n\r\n    if (handleContextLost) {\r\n      this.__gl.canvas.addEventListener('webglcontextlost', handleContextLost, false);\r\n    }\r\n\r\n    if (handleContextRestored) {\r\n      this.__gl.canvas.addEventListener('webglcontextrestored', handleContextRestored, false);\r\n    }\r\n\r\n    this.__gl.canvas.addEventListener('webglcontextlost', () => {\r\n      this._isContextLost = true;\r\n    });\r\n\r\n    this.__gl.canvas.addEventListener('webglcontextrestored', () => {\r\n      this._isContextLost = false;\r\n    });\r\n\r\n    this.textureLoader = new TextureLoader(this.__gl, garbageCollector);\r\n    this.snapToPixel = snapToPixel ?? this.snapToPixel;\r\n    this.smoothing = antialiasing ?? this.smoothing;\r\n    this.transparency = enableTransparency ?? this.transparency;\r\n    this.pixelArtSampler = pixelArtSampler ?? this.pixelArtSampler;\r\n    this.uvPadding = uvPadding ?? this.uvPadding;\r\n    this.multiSampleAntialiasing = typeof multiSampleAntialiasing === 'boolean' ? multiSampleAntialiasing : this.multiSampleAntialiasing;\r\n    this.samples = typeof multiSampleAntialiasing === 'object' ? multiSampleAntialiasing.samples : undefined;\r\n    this.backgroundColor = backgroundColor ?? this.backgroundColor;\r\n    this.useDrawSorting = useDrawSorting ?? this.useDrawSorting;\r\n    this._drawCallPool.disableWarnings = true;\r\n    this._drawCallPool.preallocate();\r\n    this._init();\r\n  }\r\n\r\n  private _disposed = false;\r\n  public dispose() {\r\n    if (!this._disposed) {\r\n      this._disposed = true;\r\n      this.textureLoader.dispose();\r\n      for (const renderer of this._renderers.values()) {\r\n        renderer.dispose();\r\n      }\r\n      this._renderers.clear();\r\n      this._drawCallPool.dispose();\r\n      this._drawCalls.length = 0;\r\n      this.__gl = null as any;\r\n    }\r\n  }\r\n\r\n  private _init() {\r\n    const gl = this.__gl;\r\n    // Setup viewport and view matrix\r\n    this._ortho = Matrix.ortho(0, gl.canvas.width, gl.canvas.height, 0, 400, -400);\r\n    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);\r\n\r\n    // Clear background\r\n    gl.clearColor(this.backgroundColor.r / 255, this.backgroundColor.g / 255, this.backgroundColor.b / 255, this.backgroundColor.a);\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n\r\n    // Enable alpha blending\r\n    // https://www.realtimerendering.com/blog/gpus-prefer-premultiplication/\r\n    gl.enable(gl.BLEND);\r\n    gl.blendEquation(gl.FUNC_ADD);\r\n    gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\r\n    gl.blendEquationSeparate(gl.FUNC_ADD, gl.FUNC_ADD);\r\n    gl.blendFuncSeparate(gl.ONE, gl.ONE_MINUS_SRC_ALPHA, gl.ONE, gl.ONE_MINUS_SRC_ALPHA);\r\n    gl.depthMask(false);\r\n    // Setup builtin renderers\r\n    this.register(\r\n      new ImageRenderer({\r\n        uvPadding: this.uvPadding,\r\n        pixelArtSampler: this.pixelArtSampler\r\n      })\r\n    );\r\n    this.register(new MaterialRenderer());\r\n    this.register(new RectangleRenderer());\r\n    this.register(new CircleRenderer());\r\n    this.register(new PointRenderer());\r\n    this.register(new LineRenderer());\r\n    this.lazyRegister<ParticleRenderer>('ex.particle', () => new ParticleRenderer());\r\n    this.register(\r\n      new ImageRendererV2({\r\n        uvPadding: this.uvPadding,\r\n        pixelArtSampler: this.pixelArtSampler\r\n      })\r\n    );\r\n\r\n    this.materialScreenTexture = gl.createTexture();\r\n    if (!this.materialScreenTexture) {\r\n      throw new Error('Could not create screen texture!');\r\n    }\r\n    gl.bindTexture(gl.TEXTURE_2D, this.materialScreenTexture);\r\n    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, this.width, this.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);\r\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);\r\n    gl.bindTexture(gl.TEXTURE_2D, null);\r\n\r\n    this._screenRenderer = new ScreenPassPainter(gl);\r\n\r\n    this._renderTarget = new RenderTarget({\r\n      gl,\r\n      transparency: this.transparency,\r\n      width: gl.canvas.width,\r\n      height: gl.canvas.height\r\n    });\r\n\r\n    this._postProcessTargets = [\r\n      new RenderTarget({\r\n        gl,\r\n        transparency: this.transparency,\r\n        width: gl.canvas.width,\r\n        height: gl.canvas.height\r\n      }),\r\n      new RenderTarget({\r\n        gl,\r\n        transparency: this.transparency,\r\n        width: gl.canvas.width,\r\n        height: gl.canvas.height\r\n      })\r\n    ];\r\n\r\n    this._msaaTarget = new RenderTarget({\r\n      gl,\r\n      transparency: this.transparency,\r\n      width: gl.canvas.width,\r\n      height: gl.canvas.height,\r\n      antialias: this.multiSampleAntialiasing,\r\n      samples: this.samples\r\n    });\r\n  }\r\n\r\n  public register<T extends RendererPlugin>(renderer: T) {\r\n    this._renderers.set(renderer.type, renderer);\r\n    renderer.initialize(this.__gl, this);\r\n  }\r\n\r\n  public lazyRegister<TRenderer extends RendererPlugin>(type: TRenderer['type'], renderer: () => TRenderer) {\r\n    this._lazyRenderersFactory.set(type, renderer);\r\n  }\r\n\r\n  public get(rendererName: string): RendererPlugin | undefined {\r\n    let maybeRenderer = this._renderers.get(rendererName);\r\n    if (!maybeRenderer) {\r\n      const lazyFactory = this._lazyRenderersFactory.get(rendererName);\r\n      if (lazyFactory) {\r\n        this._logger.debug('lazy init renderer:', rendererName);\r\n        maybeRenderer = lazyFactory();\r\n        this.register(maybeRenderer);\r\n      }\r\n    }\r\n    return maybeRenderer;\r\n  }\r\n\r\n  private _currentRenderer: RendererPlugin | undefined;\r\n\r\n  private _isCurrentRenderer(renderer: RendererPlugin): boolean {\r\n    if (!this._currentRenderer || this._currentRenderer === renderer) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public beginDrawLifecycle() {\r\n    this._isDrawLifecycle = true;\r\n  }\r\n\r\n  public endDrawLifecycle() {\r\n    this._isDrawLifecycle = false;\r\n  }\r\n\r\n  public draw<TRenderer extends RendererPlugin>(rendererName: TRenderer['type'], ...args: Parameters<TRenderer['draw']>) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      if (args.length > 9) {\r\n        throw new Error('Only 10 or less renderer arguments are supported!;');\r\n      }\r\n    }\r\n    if (!this._isDrawLifecycle) {\r\n      this._logger.warnOnce(\r\n        `Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.\\n` +\r\n          `If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`\r\n      );\r\n    }\r\n    if (this._isContextLost) {\r\n      this._logger.errorOnce(`Unable to draw ${rendererName}, the webgl context is lost`);\r\n      return;\r\n    }\r\n\r\n    const renderer = this.get(rendererName);\r\n    if (renderer) {\r\n      if (this.useDrawSorting) {\r\n        const drawCall = this._drawCallPool.get();\r\n        drawCall.z = this._state.current.z;\r\n        drawCall.priority = renderer.priority;\r\n        drawCall.renderer = rendererName;\r\n        this.getTransform().clone(drawCall.transform);\r\n        drawCall.state.z = this._state.current.z;\r\n        drawCall.state.opacity = this._state.current.opacity;\r\n        drawCall.state.tint = this._state.current.tint;\r\n        drawCall.state.material = this._state.current.material;\r\n        drawCall.args[0] = args[0];\r\n        drawCall.args[1] = args[1];\r\n        drawCall.args[2] = args[2];\r\n        drawCall.args[3] = args[3];\r\n        drawCall.args[4] = args[4];\r\n        drawCall.args[5] = args[5];\r\n        drawCall.args[6] = args[6];\r\n        drawCall.args[7] = args[7];\r\n        drawCall.args[8] = args[8];\r\n        drawCall.args[9] = args[9];\r\n        this._drawCalls[this._drawCallIndex++] = drawCall;\r\n      } else {\r\n        // Set the current renderer if not defined\r\n        if (!this._currentRenderer) {\r\n          this._currentRenderer = renderer;\r\n        }\r\n\r\n        if (!this._isCurrentRenderer(renderer)) {\r\n          // switching graphics means we must flush the previous\r\n          this._currentRenderer.flush();\r\n        }\r\n\r\n        // If we are still using the same renderer we can add to the current batch\r\n        renderer.draw(args[0], args[1], args[2], args[3], args[4], args[5], args[6], args[7], args[8], args[9]);\r\n\r\n        this._currentRenderer = renderer;\r\n      }\r\n    } else {\r\n      throw Error(`No renderer with name ${rendererName} has been registered`);\r\n    }\r\n  }\r\n\r\n  public resetTransform(): void {\r\n    this._transform.reset();\r\n  }\r\n\r\n  public updateViewport(resolution: Resolution): void {\r\n    const gl = this.__gl;\r\n    this._ortho = this._ortho = Matrix.ortho(0, resolution.width, resolution.height, 0, 400, -400);\r\n\r\n    this._renderTarget.setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._msaaTarget.setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._postProcessTargets[0].setResolution(gl.canvas.width, gl.canvas.height);\r\n    this._postProcessTargets[1].setResolution(gl.canvas.width, gl.canvas.height);\r\n  }\r\n\r\n  private _imageToWidth = new Map<HTMLImageSource, number>();\r\n  private _getImageWidth(image: HTMLImageSource) {\r\n    let maybeWidth = this._imageToWidth.get(image);\r\n    if (maybeWidth === undefined) {\r\n      maybeWidth = image.width;\r\n      this._imageToWidth.set(image, maybeWidth);\r\n    }\r\n    return maybeWidth;\r\n  }\r\n\r\n  private _imageToHeight = new Map<HTMLImageSource, number>();\r\n  private _getImageHeight(image: HTMLImageSource) {\r\n    let maybeHeight = this._imageToHeight.get(image);\r\n    if (maybeHeight === undefined) {\r\n      maybeHeight = image.height;\r\n      this._imageToHeight.set(image, maybeHeight);\r\n    }\r\n    return maybeHeight;\r\n  }\r\n\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    if (swidth === 0 || sheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (dwidth === 0 || dheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (this._getImageWidth(image) === 0 || this._getImageHeight(image) === 0) {\r\n      return; // zero dimension source exit early\r\n    }\r\n\r\n    if (!image) {\r\n      Logger.getInstance().warn('Cannot draw a null or undefined image');\r\n      // tslint:disable-next-line: no-console\r\n      if (console.trace) {\r\n        // tslint:disable-next-line: no-console\r\n        console.trace();\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (this._state.current.material) {\r\n      this.draw<MaterialRenderer>('ex.material', image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight);\r\n    } else {\r\n      if (this.imageRenderer === 'ex.image') {\r\n        this.draw<ImageRenderer>(this.imageRenderer, image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight);\r\n      } else {\r\n        this.draw<ImageRendererV2>(this.imageRenderer, image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight);\r\n      }\r\n    }\r\n  }\r\n\r\n  public drawLine(start: Vector, end: Vector, color: Color, thickness = 1) {\r\n    this.draw<RectangleRenderer>('ex.rectangle', start, end, color, thickness);\r\n  }\r\n\r\n  public drawRectangle(pos: Vector, width: number, height: number, color: Color, stroke?: Color, strokeThickness?: number) {\r\n    this.draw<RectangleRenderer>('ex.rectangle', pos, width, height, color, stroke, strokeThickness);\r\n  }\r\n\r\n  public drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number) {\r\n    this.draw<CircleRenderer>('ex.circle', pos, radius, color, stroke, thickness);\r\n  }\r\n\r\n  debug = new ExcaliburGraphicsContextWebGLDebug(this);\r\n\r\n  public save(): void {\r\n    this._transform.save();\r\n    this._state.save();\r\n  }\r\n\r\n  public restore(): void {\r\n    this._transform.restore();\r\n    this._state.restore();\r\n  }\r\n\r\n  public translate(x: number, y: number): void {\r\n    this._transform.translate(this.snapToPixel ? ~~(x + pixelSnapEpsilon) : x, this.snapToPixel ? ~~(y + pixelSnapEpsilon) : y);\r\n  }\r\n\r\n  public rotate(angle: number): void {\r\n    this._transform.rotate(angle);\r\n  }\r\n\r\n  public scale(x: number, y: number): void {\r\n    this._transform.scale(x, y);\r\n  }\r\n\r\n  public transform(matrix: AffineMatrix) {\r\n    this._transform.current = matrix;\r\n  }\r\n\r\n  public getTransform(): AffineMatrix {\r\n    return this._transform.current;\r\n  }\r\n\r\n  public multiply(m: AffineMatrix) {\r\n    this._transform.current.multiply(m, this._transform.current);\r\n  }\r\n\r\n  public addPostProcessor(postprocessor: PostProcessor) {\r\n    this._postprocessors.push(postprocessor);\r\n    postprocessor.initialize(this.__gl);\r\n  }\r\n\r\n  public removePostProcessor(postprocessor: PostProcessor) {\r\n    const index = this._postprocessors.indexOf(postprocessor);\r\n    if (index !== -1) {\r\n      this._postprocessors.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  public clearPostProcessors() {\r\n    this._postprocessors.length = 0;\r\n  }\r\n\r\n  private _totalPostProcessorTime = 0;\r\n  public updatePostProcessors(elapsed: number) {\r\n    for (const postprocessor of this._postprocessors) {\r\n      const shader = postprocessor.getShader();\r\n      shader.use();\r\n      const uniforms = shader.getUniforms();\r\n      this._totalPostProcessorTime += elapsed;\r\n\r\n      if (uniforms.find((u) => u.name === 'u_time_ms')) {\r\n        shader.setUniformFloat('u_time_ms', this._totalPostProcessorTime);\r\n      }\r\n      if (uniforms.find((u) => u.name === 'u_elapsed_ms')) {\r\n        shader.setUniformFloat('u_elapsed_ms', elapsed);\r\n      }\r\n      if (uniforms.find((u) => u.name === 'u_resolution')) {\r\n        shader.setUniformFloatVector('u_resolution', vec(this.width, this.height));\r\n      }\r\n\r\n      if (postprocessor.onUpdate) {\r\n        postprocessor.onUpdate(elapsed);\r\n      }\r\n    }\r\n  }\r\n\r\n  public set material(material: Material | null | undefined) {\r\n    this._state.current.material = material;\r\n  }\r\n\r\n  public get material(): Material | null | undefined {\r\n    return this._state.current.material;\r\n  }\r\n\r\n  /**\r\n   * Creates and initializes the material which compiles the internal shader\r\n   * @param options\r\n   * @returns Material\r\n   */\r\n  public createMaterial(options: Omit<MaterialOptions, 'graphicsContext'>): Material {\r\n    const material = new Material({ ...options, graphicsContext: this });\r\n    return material;\r\n  }\r\n\r\n  public createShader(options: Omit<ShaderOptions, 'gl'>): Shader {\r\n    const gl = this.__gl;\r\n    const { vertexSource, fragmentSource } = options;\r\n    const shader = new Shader({\r\n      gl,\r\n      vertexSource,\r\n      fragmentSource\r\n    });\r\n    shader.compile();\r\n    return shader;\r\n  }\r\n\r\n  clear() {\r\n    const gl = this.__gl;\r\n    const currentTarget = this.multiSampleAntialiasing ? this._msaaTarget : this._renderTarget;\r\n    currentTarget.use();\r\n    gl.clearColor(this.backgroundColor.r / 255, this.backgroundColor.g / 255, this.backgroundColor.b / 255, this.backgroundColor.a);\r\n    // Clear the context with the newly set color. This is\r\n    // the function call that actually does the drawing.\r\n    gl.clear(gl.COLOR_BUFFER_BIT);\r\n  }\r\n\r\n  /**\r\n   * Flushes all batched rendering to the screen\r\n   */\r\n  flush() {\r\n    if (this._isContextLost) {\r\n      this._logger.errorOnce(`Unable to flush the webgl context is lost`);\r\n      return;\r\n    }\r\n\r\n    // render target captures all draws and redirects to the render target\r\n    let currentTarget = this.multiSampleAntialiasing ? this._msaaTarget : this._renderTarget;\r\n    currentTarget.use();\r\n\r\n    if (this.useDrawSorting) {\r\n      // null out unused draw calls\r\n      for (let i = this._drawCallIndex; i < this._drawCalls.length; i++) {\r\n        this._drawCalls[i] = null as any;\r\n      }\r\n      // sort draw calls\r\n      // Find the original order of the first instance of the draw call\r\n      const originalSort = new Map<string, number>();\r\n      for (const [name] of this._renderers) {\r\n        let firstIndex = 0;\r\n        for (firstIndex = 0; firstIndex < this._drawCallIndex; firstIndex++) {\r\n          if (this._drawCalls[firstIndex].renderer === name) {\r\n            break;\r\n          }\r\n        }\r\n        originalSort.set(name, firstIndex);\r\n      }\r\n\r\n      this._drawCalls.sort((a, b) => {\r\n        if (a === null || b === null) {\r\n          return 0;\r\n        }\r\n        const zIndex = a.z - b.z;\r\n        const originalSortOrder = originalSort.get(a.renderer)! - originalSort.get(b.renderer)!;\r\n        const priority = a.priority - b.priority;\r\n        if (zIndex === 0) {\r\n          // sort by z first\r\n          if (priority === 0) {\r\n            // sort by priority\r\n            return originalSortOrder; // use the original order to inform draw call packing to maximally preserve painter order\r\n          }\r\n          return priority;\r\n        }\r\n        return zIndex;\r\n      });\r\n\r\n      const oldTransform = this._transform.current;\r\n      const oldState = this._state.current;\r\n\r\n      if (this._drawCalls.length && this._drawCallIndex) {\r\n        let currentRendererName = this._drawCalls[0].renderer;\r\n        let currentRenderer = this.get(currentRendererName);\r\n        for (let i = 0; i < this._drawCallIndex; i++) {\r\n          // hydrate the state for renderers\r\n          this._transform.current = this._drawCalls[i].transform;\r\n          this._state.current = this._drawCalls[i].state;\r\n\r\n          if (this._drawCalls[i].renderer !== currentRendererName) {\r\n            // switching graphics renderer means we must flush the previous\r\n            currentRenderer!.flush();\r\n            currentRendererName = this._drawCalls[i].renderer;\r\n            currentRenderer = this.get(currentRendererName);\r\n          }\r\n\r\n          // ! hack to grab screen texture before materials run because they might want it\r\n          if (currentRenderer instanceof MaterialRenderer && this.material?.isUsingScreenTexture) {\r\n            currentTarget.copyToTexture(this.materialScreenTexture!);\r\n            currentTarget.use();\r\n          }\r\n          // If we are still using the same renderer we can add to the current batch\r\n          currentRenderer!.draw(...this._drawCalls[i].args);\r\n        }\r\n        if (currentRenderer!.hasPendingDraws()) {\r\n          currentRenderer!.flush();\r\n        }\r\n      }\r\n\r\n      // reset state\r\n      this._transform.current = oldTransform;\r\n      this._state.current = oldState;\r\n\r\n      // reclaim draw calls\r\n      this._drawCallPool.done();\r\n      this._drawCallIndex = 0;\r\n      this._imageToHeight.clear();\r\n      this._imageToWidth.clear();\r\n    } else {\r\n      // This is the final flush at the moment to draw any leftover pending draw\r\n      for (const renderer of this._renderers.values()) {\r\n        if (renderer.hasPendingDraws()) {\r\n          renderer.flush();\r\n        }\r\n      }\r\n    }\r\n\r\n    currentTarget.disable();\r\n\r\n    // post process step\r\n    if (this._postprocessors.length > 0) {\r\n      currentTarget.toRenderSource().use();\r\n    }\r\n\r\n    // flip flop render targets for post processing\r\n    for (let i = 0; i < this._postprocessors.length; i++) {\r\n      currentTarget = this._postProcessTargets[i % 2];\r\n      this._postProcessTargets[i % 2].use();\r\n      this._screenRenderer.renderWithPostProcessor(this._postprocessors[i]);\r\n      this._postProcessTargets[i % 2].toRenderSource().use();\r\n    }\r\n\r\n    // Final blit to the screen\r\n    currentTarget.blitToScreen();\r\n  }\r\n}\r\n","import {\r\n  ExcaliburGraphicsContext,\r\n  LineGraphicsOptions,\r\n  PointGraphicsOptions,\r\n  ExcaliburGraphicsContextOptions,\r\n  DebugDraw,\r\n  HTMLImageSource\r\n} from './ExcaliburGraphicsContext';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { StateStack } from './state-stack';\r\nimport { GraphicsDiagnostics } from '../GraphicsDiagnostics';\r\nimport { DebugText } from './debug-text';\r\nimport { Resolution } from '../../Screen';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Material, MaterialOptions } from './material';\r\n\r\nconst pixelSnapEpsilon = 0.0001;\r\n\r\nclass ExcaliburGraphicsContext2DCanvasDebug implements DebugDraw {\r\n  private _debugText = new DebugText();\r\n  constructor(private _ex: ExcaliburGraphicsContext2DCanvas) {}\r\n  /**\r\n   * Draw a debug rectangle to the context\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.strokeStyle = 'red';\r\n    this._ex.__ctx.strokeRect(\r\n      this._ex.snapToPixel ? ~~(x + pixelSnapEpsilon) : x,\r\n      this._ex.snapToPixel ? ~~(y + pixelSnapEpsilon) : y,\r\n      this._ex.snapToPixel ? ~~(width + pixelSnapEpsilon) : width,\r\n      this._ex.snapToPixel ? ~~(height + pixelSnapEpsilon) : height\r\n    );\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawLine(start: Vector, end: Vector, lineOptions: LineGraphicsOptions = { color: Color.Black }): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.beginPath();\r\n    this._ex.__ctx.strokeStyle = lineOptions.color?.toString() ?? '';\r\n    this._ex.__ctx.moveTo(\r\n      this._ex.snapToPixel ? ~~(start.x + pixelSnapEpsilon) : start.x,\r\n      this._ex.snapToPixel ? ~~(start.y + pixelSnapEpsilon) : start.y\r\n    );\r\n    this._ex.__ctx.lineTo(\r\n      this._ex.snapToPixel ? ~~(end.x + pixelSnapEpsilon) : end.x,\r\n      this._ex.snapToPixel ? ~~(end.y + pixelSnapEpsilon) : end.y\r\n    );\r\n    this._ex.__ctx.lineWidth = 2;\r\n    this._ex.__ctx.stroke();\r\n    this._ex.__ctx.closePath();\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawPoint(point: Vector, pointOptions: PointGraphicsOptions = { color: Color.Black, size: 5 }): void {\r\n    this._ex.__ctx.save();\r\n    this._ex.__ctx.beginPath();\r\n    this._ex.__ctx.fillStyle = pointOptions.color.toString();\r\n    this._ex.__ctx.arc(\r\n      this._ex.snapToPixel ? ~~(point.x + pixelSnapEpsilon) : point.x,\r\n      this._ex.snapToPixel ? ~~(point.y + pixelSnapEpsilon) : point.y,\r\n      pointOptions.size,\r\n      0,\r\n      Math.PI * 2\r\n    );\r\n    this._ex.__ctx.fill();\r\n    this._ex.__ctx.closePath();\r\n    this._ex.__ctx.restore();\r\n  }\r\n\r\n  drawText(text: string, pos: Vector) {\r\n    this._debugText.write(this._ex, text, pos);\r\n  }\r\n}\r\n\r\nexport interface ExcaliburGraphicsContext2DOptions extends ExcaliburGraphicsContextOptions {\r\n  context?: CanvasRenderingContext2D;\r\n}\r\n\r\nexport class ExcaliburGraphicsContext2DCanvas implements ExcaliburGraphicsContext {\r\n  /**\r\n   * Meant for internal use only. Access the internal context at your own risk and no guarantees this will exist in the future.\r\n   * @internal\r\n   */\r\n  public __ctx!: CanvasRenderingContext2D;\r\n  public get width() {\r\n    return this.__ctx.canvas.width;\r\n  }\r\n\r\n  public get height() {\r\n    return this.__ctx.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Unused in Canvas implementation\r\n   */\r\n  public readonly useDrawSorting: boolean = false;\r\n\r\n  /**\r\n   * Unused in Canvas implementation\r\n   */\r\n  public z: number = 0;\r\n\r\n  public backgroundColor: Color = Color.ExcaliburBlue;\r\n\r\n  private _state = new StateStack();\r\n\r\n  public get opacity(): number {\r\n    return this._state.current.opacity;\r\n  }\r\n\r\n  public set opacity(value: number) {\r\n    this._state.current.opacity = value;\r\n  }\r\n\r\n  public get tint(): Color | null | undefined {\r\n    return this._state.current.tint;\r\n  }\r\n\r\n  public set tint(color: Color | null | undefined) {\r\n    this._state.current.tint = color;\r\n  }\r\n\r\n  public snapToPixel: boolean = false;\r\n\r\n  public get smoothing(): boolean {\r\n    return this.__ctx.imageSmoothingEnabled;\r\n  }\r\n\r\n  public set smoothing(value: boolean) {\r\n    this.__ctx.imageSmoothingEnabled = value;\r\n  }\r\n\r\n  constructor(options: ExcaliburGraphicsContext2DOptions) {\r\n    const { canvasElement, context, enableTransparency, snapToPixel, antialiasing: smoothing, backgroundColor } = options;\r\n    this.__ctx =\r\n      context ??\r\n      (canvasElement.getContext('2d', {\r\n        alpha: enableTransparency ?? true\r\n      }) as CanvasRenderingContext2D);\r\n    if (!this.__ctx) {\r\n      throw new Error('Cannot build new ExcaliburGraphicsContext2D for some reason!');\r\n    }\r\n    this.backgroundColor = backgroundColor ?? this.backgroundColor;\r\n    this.snapToPixel = snapToPixel ?? this.snapToPixel;\r\n    this.smoothing = smoothing ?? this.smoothing;\r\n  }\r\n\r\n  public resetTransform(): void {\r\n    this.__ctx.resetTransform();\r\n  }\r\n\r\n  public updateViewport(_resolution: Resolution): void {\r\n    // pass\r\n  }\r\n\r\n  /**\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate using the images width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate with a specific width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context specifying the source image coordinates (sx, sy, swidth, sheight)\r\n   * and to a specific destination on the context (dx, dy, dwidth, dheight)\r\n   */\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void {\r\n    if (swidth === 0 || sheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (dwidth === 0 || dheight === 0) {\r\n      return; // zero dimension dest exit early\r\n    } else if (image.width === 0 || image.height === 0) {\r\n      return; // zero dimension source exit early\r\n    }\r\n\r\n    this.__ctx.globalAlpha = this.opacity;\r\n    const args = [image, sx, sy, swidth, sheight, dx, dy, dwidth, dheight]\r\n      .filter((a) => a !== undefined)\r\n      .map((a) => (typeof a === 'number' && this.snapToPixel ? ~~a : a));\r\n    this.__ctx.drawImage.apply(this.__ctx, args as any);\r\n    GraphicsDiagnostics.DrawCallCount++;\r\n    GraphicsDiagnostics.DrawnImagesCount = 1;\r\n  }\r\n\r\n  public drawLine(start: Vector, end: Vector, color: Color, thickness = 1) {\r\n    this.__ctx.save();\r\n    this.__ctx.beginPath();\r\n    this.__ctx.strokeStyle = color.toString();\r\n    this.__ctx.moveTo(\r\n      this.snapToPixel ? ~~(start.x + pixelSnapEpsilon) : start.x,\r\n      this.snapToPixel ? ~~(start.y + pixelSnapEpsilon) : start.y\r\n    );\r\n    this.__ctx.lineTo(this.snapToPixel ? ~~(end.x + pixelSnapEpsilon) : end.x, this.snapToPixel ? ~~(end.y + pixelSnapEpsilon) : end.y);\r\n    this.__ctx.lineWidth = thickness;\r\n    this.__ctx.stroke();\r\n    this.__ctx.closePath();\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  public drawRectangle(pos: Vector, width: number, height: number, color: Color) {\r\n    this.__ctx.save();\r\n    this.__ctx.fillStyle = color.toString();\r\n    this.__ctx.fillRect(\r\n      this.snapToPixel ? ~~(pos.x + pixelSnapEpsilon) : pos.x,\r\n      this.snapToPixel ? ~~(pos.y + pixelSnapEpsilon) : pos.y,\r\n      this.snapToPixel ? ~~(width + pixelSnapEpsilon) : width,\r\n      this.snapToPixel ? ~~(height + pixelSnapEpsilon) : height\r\n    );\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  public drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number) {\r\n    this.__ctx.save();\r\n    this.__ctx.beginPath();\r\n    if (stroke) {\r\n      this.__ctx.strokeStyle = stroke.toString();\r\n    }\r\n    if (thickness) {\r\n      this.__ctx.lineWidth = thickness;\r\n    }\r\n    this.__ctx.fillStyle = color.toString();\r\n    this.__ctx.arc(\r\n      this.snapToPixel ? ~~(pos.x + pixelSnapEpsilon) : pos.x,\r\n      this.snapToPixel ? ~~(pos.y + pixelSnapEpsilon) : pos.y,\r\n      radius,\r\n      0,\r\n      Math.PI * 2\r\n    );\r\n    this.__ctx.fill();\r\n    if (stroke) {\r\n      this.__ctx.stroke();\r\n    }\r\n    this.__ctx.closePath();\r\n    this.__ctx.restore();\r\n  }\r\n\r\n  debug = new ExcaliburGraphicsContext2DCanvasDebug(this);\r\n\r\n  /**\r\n   * Save the current state of the canvas to the stack (transforms and opacity)\r\n   */\r\n  save(): void {\r\n    this.__ctx.save();\r\n    this._state.save();\r\n  }\r\n\r\n  /**\r\n   * Restore the state of the canvas from the stack\r\n   */\r\n  restore(): void {\r\n    this.__ctx.restore();\r\n    this._state.restore();\r\n  }\r\n\r\n  /**\r\n   * Translate the origin of the context by an x and y\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number): void {\r\n    this.__ctx.translate(this.snapToPixel ? ~~(x + pixelSnapEpsilon) : x, this.snapToPixel ? ~~(y + pixelSnapEpsilon) : y);\r\n  }\r\n\r\n  /**\r\n   * Rotate the context about the current origin\r\n   */\r\n  rotate(angle: number): void {\r\n    this.__ctx.rotate(angle);\r\n  }\r\n\r\n  /**\r\n   * Scale the context by an x and y factor\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number): void {\r\n    this.__ctx.scale(x, y);\r\n  }\r\n\r\n  public getTransform(): AffineMatrix {\r\n    throw new Error('Not implemented');\r\n  }\r\n\r\n  public multiply(_m: AffineMatrix): void {\r\n    this.__ctx.setTransform(this.__ctx.getTransform().multiply(_m.toDOMMatrix()));\r\n  }\r\n\r\n  public addPostProcessor(_postprocessor: PostProcessor) {\r\n    // pass\r\n  }\r\n\r\n  public removePostProcessor(_postprocessor: PostProcessor) {\r\n    // pass\r\n  }\r\n\r\n  public clearPostProcessors() {\r\n    // pass\r\n  }\r\n\r\n  public updatePostProcessors(elapsed: number) {\r\n    // pass\r\n  }\r\n\r\n  public beginDrawLifecycle() {\r\n    // pass\r\n  }\r\n\r\n  public endDrawLifecycle() {\r\n    // pass\r\n  }\r\n\r\n  public set material(material: Material | undefined | null) {\r\n    this._state.current.material = material;\r\n  }\r\n\r\n  public get material(): Material | undefined | null {\r\n    return this._state.current.material;\r\n  }\r\n\r\n  public createMaterial(options: Omit<MaterialOptions, 'graphicsContext'>): Material {\r\n    // pass\r\n    return null as any;\r\n  }\r\n\r\n  clear(): void {\r\n    // Clear frame\r\n    this.__ctx.clearRect(0, 0, this.width, this.height);\r\n    this.__ctx.fillStyle = this.backgroundColor.toString();\r\n    this.__ctx.fillRect(0, 0, this.width, this.height);\r\n    GraphicsDiagnostics.clear();\r\n  }\r\n\r\n  /**\r\n   * Flushes the batched draw calls to the screen\r\n   */\r\n  flush(): void {\r\n    // pass\r\n  }\r\n\r\n  dispose(): void {\r\n    this.__ctx = undefined as any;\r\n  }\r\n}\r\n","import { vec, Vector } from './Math/vector';\r\nimport { Logger } from './Util/Log';\r\nimport { Camera } from './Camera';\r\nimport { BrowserEvents } from './Util/Browser';\r\nimport { BoundingBox } from './Collision/Index';\r\nimport { ExcaliburGraphicsContext } from './Graphics/Context/ExcaliburGraphicsContext';\r\nimport { getPosition } from './Util/Util';\r\nimport { ExcaliburGraphicsContextWebGL } from './Graphics/Context/ExcaliburGraphicsContextWebGL';\r\nimport { ExcaliburGraphicsContext2DCanvas } from './Graphics/Context/ExcaliburGraphicsContext2DCanvas';\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\n/**\r\n * Enum representing the different display modes available to Excalibur.\r\n */\r\nexport enum DisplayMode {\r\n  /**\r\n   * Default, use a specified resolution for the game. Like 800x600 pixels for example.\r\n   */\r\n  Fixed = 'Fixed',\r\n\r\n  /**\r\n   * Fit the aspect ratio given by the game resolution within the container at all times will fill any gaps with canvas.\r\n   * The displayed area outside the aspect ratio is not guaranteed to be on the screen, only the {@apilink Screen.contentArea}\r\n   * is guaranteed to be on screen.\r\n   */\r\n  FitContainerAndFill = 'FitContainerAndFill',\r\n\r\n  /**\r\n   * Fit the aspect ratio given by the game resolution the screen at all times will fill the screen.\r\n   * This displayed area outside the aspect ratio is not guaranteed to be on the screen, only the {@apilink Screen.contentArea}\r\n   * is guaranteed to be on screen.\r\n   */\r\n  FitScreenAndFill = 'FitScreenAndFill',\r\n\r\n  /**\r\n   * Fit the viewport to the parent element maintaining aspect ratio given by the game resolution, but zooms in to avoid the black bars\r\n   * (letterbox) that would otherwise be present in {@apilink FitContainer}.\r\n   *\r\n   * **warning** This will clip some drawable area from the user because of the zoom,\r\n   * use {@apilink Screen.contentArea} to know the safe to draw area.\r\n   */\r\n  FitContainerAndZoom = 'FitContainerAndZoom',\r\n\r\n  /**\r\n   * Fit the viewport to the device screen maintaining aspect ratio given by the game resolution, but zooms in to avoid the black bars\r\n   * (letterbox) that would otherwise be present in {@apilink FitScreen}.\r\n   *\r\n   * **warning** This will clip some drawable area from the user because of the zoom,\r\n   * use {@apilink Screen.contentArea} to know the safe to draw area.\r\n   */\r\n  FitScreenAndZoom = 'FitScreenAndZoom',\r\n\r\n  /**\r\n   * Fit to screen using as much space as possible while maintaining aspect ratio and resolution.\r\n   * This is not the same as {@apilink Screen.enterFullscreen} but behaves in a similar way maintaining aspect ratio.\r\n   *\r\n   * You may want to center your game here is an example\r\n   * ```html\r\n   * <!-- html -->\r\n   * <body>\r\n   * <main>\r\n   *   <canvas id=\"game\"></canvas>\r\n   * </main>\r\n   * </body>\r\n   * ```\r\n   *\r\n   * ```css\r\n   * // css\r\n   * main {\r\n   *   display: flex;\r\n   *   align-items: center;\r\n   *   justify-content: center;\r\n   *   height: 100%;\r\n   *   width: 100%;\r\n   * }\r\n   * ```\r\n   */\r\n  FitScreen = 'FitScreen',\r\n\r\n  /**\r\n   * Fill the entire screen's css width/height for the game resolution dynamically. This means the resolution of the game will\r\n   * change dynamically as the window is resized. This is not the same as {@apilink Screen.enterFullscreen}\r\n   */\r\n  FillScreen = 'FillScreen',\r\n\r\n  /**\r\n   * Fit to parent element width/height using as much space as possible while maintaining aspect ratio and resolution.\r\n   */\r\n  FitContainer = 'FitContainer',\r\n\r\n  /**\r\n   * Use the parent DOM container's css width/height for the game resolution dynamically\r\n   */\r\n  FillContainer = 'FillContainer'\r\n}\r\n\r\n/**\r\n * Convenience class for quick resolutions\r\n * Mostly sourced from https://emulation.gametechwiki.com/index.php/Resolution\r\n */\r\nexport class Resolution {\r\n  /* istanbul ignore next */\r\n  public static get SVGA(): Resolution {\r\n    return { width: 800, height: 600 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get Standard(): Resolution {\r\n    return { width: 1920, height: 1080 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get Atari2600(): Resolution {\r\n    return { width: 160, height: 192 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get GameBoy(): Resolution {\r\n    return { width: 160, height: 144 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get GameBoyAdvance(): Resolution {\r\n    return { width: 240, height: 160 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get NintendoDS(): Resolution {\r\n    return { width: 256, height: 192 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get NES(): Resolution {\r\n    return { width: 256, height: 224 };\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public static get SNES(): Resolution {\r\n    return { width: 256, height: 244 };\r\n  }\r\n}\r\n\r\nexport type ViewportUnit = 'pixel' | 'percent';\r\n\r\nexport interface Resolution {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface ViewportDimension {\r\n  widthUnit?: ViewportUnit;\r\n  heightUnit?: ViewportUnit;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface ScreenOptions {\r\n  /**\r\n   * Canvas element to build a screen on\r\n   */\r\n  canvas: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Graphics context for the screen\r\n   */\r\n  context: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Browser abstraction\r\n   */\r\n  browser: BrowserEvents;\r\n  /**\r\n   * Optionally set antialiasing, defaults to true. If set to true, images will be smoothed\r\n   */\r\n  antialiasing?: boolean;\r\n\r\n  /**\r\n   * Optionally set the image rendering CSS hint on the canvas element, default is auto\r\n   */\r\n  canvasImageRendering?: 'auto' | 'pixelated';\r\n  /**\r\n   * Optionally override the pixel ratio to use for the screen, otherwise calculated automatically from the browser\r\n   */\r\n  pixelRatio?: number;\r\n  /**\r\n   * Optionally specify the actual pixel resolution in width/height pixels (also known as logical resolution), by default the\r\n   * resolution will be the same as the viewport. Resolution will be overridden by {@apilink DisplayMode.FillContainer} and\r\n   * {@apilink DisplayMode.FillScreen}.\r\n   */\r\n  resolution?: Resolution;\r\n  /**\r\n   * Visual viewport size in css pixel, if resolution is not specified it will be the same as the viewport\r\n   */\r\n  viewport: ViewportDimension;\r\n  /**\r\n   * Set the display mode of the screen, by default DisplayMode.Fixed.\r\n   */\r\n  displayMode?: DisplayMode;\r\n}\r\n\r\n/**\r\n * Fires when the screen resizes, useful if you have logic that needs to be aware of resolution/viewport constraints\r\n */\r\nexport interface ScreenResizeEvent {\r\n  /**\r\n   * Current viewport in css pixels of the screen\r\n   */\r\n  viewport: ViewportDimension;\r\n  /**\r\n   * Current resolution in world pixels of the screen\r\n   */\r\n  resolution: Resolution;\r\n}\r\n\r\n/**\r\n * Fires when the pixel ratio changes, useful to know if you've moved to a hidpi screen or back\r\n */\r\nexport interface PixelRatioChangeEvent {\r\n  /**\r\n   * Current pixel ratio of the screen\r\n   */\r\n  pixelRatio: number;\r\n}\r\n\r\n/**\r\n * Fires when the browser fullscreen api is successfully engaged or disengaged\r\n */\r\nexport interface FullScreenChangeEvent {\r\n  /**\r\n   * Current fullscreen state\r\n   */\r\n  fullscreen: boolean;\r\n}\r\n\r\n/**\r\n * Built in events supported by all entities\r\n */\r\nexport type ScreenEvents = {\r\n  /**\r\n   * Fires when the screen resizes, useful if you have logic that needs to be aware of resolution/viewport constraints\r\n   */\r\n  resize: ScreenResizeEvent;\r\n  /**\r\n   * Fires when the pixel ratio changes, useful to know if you've moved to a hidpi screen or back\r\n   */\r\n  pixelratio: PixelRatioChangeEvent;\r\n  /**\r\n   * Fires when the browser fullscreen api is successfully engaged or disengaged\r\n   */\r\n  fullscreen: FullScreenChangeEvent;\r\n};\r\n\r\nexport const ScreenEvents = {\r\n  ScreenResize: 'resize',\r\n  PixelRatioChange: 'pixelratio',\r\n  FullScreenChange: 'fullscreen'\r\n} as const;\r\n\r\n/**\r\n * The Screen handles all aspects of interacting with the screen for Excalibur.\r\n */\r\nexport class Screen {\r\n  public graphicsContext: ExcaliburGraphicsContext;\r\n  /**\r\n   * Listen to screen events {@apilink ScreenEvents}\r\n   */\r\n  public events = new EventEmitter<ScreenEvents>();\r\n  private _canvas: HTMLCanvasElement;\r\n  private _antialiasing: boolean = true;\r\n  private _canvasImageRendering: 'auto' | 'pixelated' = 'auto';\r\n  private _contentResolution: Resolution;\r\n  private _browser: BrowserEvents;\r\n  private _camera: Camera;\r\n  private _resolution: Resolution;\r\n  private _resolutionStack: Resolution[] = [];\r\n  private _viewport: ViewportDimension;\r\n  private _viewportStack: ViewportDimension[] = [];\r\n  private _pixelRatioOverride: number | null = null;\r\n  private _displayMode: DisplayMode;\r\n  private _isFullscreen = false;\r\n  private _mediaQueryList: MediaQueryList;\r\n  private _isDisposed = false;\r\n  private _logger = Logger.getInstance();\r\n  private _resizeObserver: ResizeObserver;\r\n\r\n  constructor(options: ScreenOptions) {\r\n    this.viewport = options.viewport;\r\n    this.resolution = options.resolution ?? { ...this.viewport };\r\n    this._contentResolution = this.resolution;\r\n    this._displayMode = options.displayMode ?? DisplayMode.Fixed;\r\n    this._canvas = options.canvas;\r\n    this.graphicsContext = options.context;\r\n    this._antialiasing = options.antialiasing ?? this._antialiasing;\r\n    this._canvasImageRendering = options.canvasImageRendering ?? this._canvasImageRendering;\r\n    this._browser = options.browser;\r\n    this._pixelRatioOverride = options.pixelRatio;\r\n\r\n    this._applyDisplayMode();\r\n\r\n    this._listenForPixelRatio();\r\n\r\n    this._canvas.addEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n    this.applyResolutionAndViewport();\r\n  }\r\n\r\n  private _listenForPixelRatio() {\r\n    if (this._mediaQueryList && !this._mediaQueryList.addEventListener) {\r\n      // Safari <=13.1 workaround, remove any existing handlers\r\n      this._mediaQueryList.removeListener(this._pixelRatioChangeHandler);\r\n    }\r\n    this._mediaQueryList = this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`);\r\n\r\n    // Safari <=13.1 workaround\r\n    if (this._mediaQueryList.addEventListener) {\r\n      this._mediaQueryList.addEventListener('change', this._pixelRatioChangeHandler, { once: true });\r\n    } else {\r\n      this._mediaQueryList.addListener(this._pixelRatioChangeHandler);\r\n    }\r\n  }\r\n\r\n  public dispose(): void {\r\n    if (!this._isDisposed) {\r\n      // Clean up handlers\r\n      this._isDisposed = true;\r\n      this.events.clear();\r\n      this._browser.window.off('resize', this._resizeHandler);\r\n      this._browser.window.clear();\r\n      if (this._resizeObserver) {\r\n        this._resizeObserver.disconnect();\r\n      }\r\n      this.parent.removeEventListener('resize', this._resizeHandler);\r\n      // Safari <=13.1 workaround\r\n      if (this._mediaQueryList.removeEventListener) {\r\n        this._mediaQueryList.removeEventListener('change', this._pixelRatioChangeHandler);\r\n      } else {\r\n        this._mediaQueryList.removeListener(this._pixelRatioChangeHandler);\r\n      }\r\n      this._canvas.removeEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n      this._canvas = null;\r\n    }\r\n  }\r\n\r\n  private _fullscreenChangeHandler = () => {\r\n    if (this._isDisposed) {\r\n      return;\r\n    }\r\n    this._isFullscreen = !this._isFullscreen;\r\n    this._logger.debug('Fullscreen Change', this._isFullscreen);\r\n    this.events.emit('fullscreen', {\r\n      fullscreen: this.isFullscreen\r\n    } satisfies FullScreenChangeEvent);\r\n  };\r\n\r\n  private _pixelRatioChangeHandler = () => {\r\n    if (this._isDisposed) {\r\n      return;\r\n    }\r\n    this._logger.debug('Pixel Ratio Change', window.devicePixelRatio);\r\n    this._listenForPixelRatio();\r\n    this._devicePixelRatio = this._calculateDevicePixelRatio();\r\n    this.applyResolutionAndViewport();\r\n\r\n    this.events.emit('pixelratio', {\r\n      pixelRatio: this.pixelRatio\r\n    } satisfies PixelRatioChangeEvent);\r\n  };\r\n\r\n  private _resizeHandler = () => {\r\n    if (this._isDisposed) {\r\n      return;\r\n    }\r\n    const parent = this.parent;\r\n    this._logger.debug('View port resized');\r\n    this._setResolutionAndViewportByDisplayMode(parent);\r\n    this.applyResolutionAndViewport();\r\n\r\n    // Emit resize event\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  };\r\n\r\n  private _calculateDevicePixelRatio() {\r\n    if (window.devicePixelRatio < 1) {\r\n      return 1;\r\n    }\r\n\r\n    const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n    return devicePixelRatio;\r\n  }\r\n\r\n  // Asking the window.devicePixelRatio is expensive we do it once\r\n  private _devicePixelRatio = this._calculateDevicePixelRatio();\r\n\r\n  /**\r\n   * Returns the computed pixel ratio, first using any override, then the device pixel ratio\r\n   */\r\n  public get pixelRatio(): number {\r\n    if (this._pixelRatioOverride) {\r\n      return this._pixelRatioOverride;\r\n    }\r\n\r\n    return this._devicePixelRatio;\r\n  }\r\n\r\n  /**\r\n   * This calculates the ratio between excalibur pixels and the HTML pixels.\r\n   *\r\n   * This is useful for scaling HTML UI so that it matches your game.\r\n   */\r\n  public get worldToPagePixelRatio(): number {\r\n    if (this._canvas) {\r\n      const pageOrigin = this.worldToPageCoordinates(Vector.Zero);\r\n      const pageDistance = this.worldToPageCoordinates(vec(1, 0)).sub(pageOrigin);\r\n      const pixelConversion = pageDistance.x;\r\n      return pixelConversion;\r\n    } else {\r\n      return 1;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or set the pixel ratio override\r\n   *\r\n   * You will need to call applyResolutionAndViewport() affect change on the screen\r\n   */\r\n  public get pixelRatioOverride(): number | undefined {\r\n    return this._pixelRatioOverride;\r\n  }\r\n\r\n  public set pixelRatioOverride(value: number | undefined) {\r\n    this._pixelRatioOverride = value;\r\n  }\r\n\r\n  public get isHiDpi() {\r\n    return this.pixelRatio !== 1;\r\n  }\r\n\r\n  public get displayMode(): DisplayMode {\r\n    return this._displayMode;\r\n  }\r\n\r\n  public get canvas(): HTMLCanvasElement {\r\n    return this._canvas;\r\n  }\r\n\r\n  public get parent(): HTMLElement | Window {\r\n    switch (this.displayMode) {\r\n      case DisplayMode.FillContainer:\r\n      case DisplayMode.FitContainer:\r\n      case DisplayMode.FitContainerAndFill:\r\n      case DisplayMode.FitContainerAndZoom:\r\n        return this.canvas.parentElement || document.body;\r\n      default:\r\n        return window;\r\n    }\r\n  }\r\n\r\n  public get resolution(): Resolution {\r\n    return this._resolution;\r\n  }\r\n\r\n  public set resolution(resolution: Resolution) {\r\n    this._resolution = resolution;\r\n  }\r\n\r\n  /**\r\n   * Returns screen dimensions in pixels or percentage\r\n   */\r\n  public get viewport(): ViewportDimension {\r\n    if (this._viewport) {\r\n      return this._viewport;\r\n    }\r\n    return this._resolution;\r\n  }\r\n\r\n  public set viewport(viewport: ViewportDimension) {\r\n    this._viewport = viewport;\r\n  }\r\n\r\n  public get aspectRatio() {\r\n    return this._resolution.width / this._resolution.height;\r\n  }\r\n\r\n  public get scaledWidth() {\r\n    return this._resolution.width * this.pixelRatio;\r\n  }\r\n\r\n  public get scaledHeight() {\r\n    return this._resolution.height * this.pixelRatio;\r\n  }\r\n\r\n  public setCurrentCamera(camera: Camera) {\r\n    this._camera = camera;\r\n  }\r\n\r\n  public pushResolutionAndViewport() {\r\n    this._resolutionStack.push(this.resolution);\r\n    this._viewportStack.push(this.viewport);\r\n\r\n    this.resolution = { ...this.resolution };\r\n    this.viewport = { ...this.viewport };\r\n  }\r\n\r\n  public peekViewport(): ViewportDimension {\r\n    return this._viewportStack[this._viewportStack.length - 1];\r\n  }\r\n\r\n  public peekResolution(): Resolution {\r\n    return this._resolutionStack[this._resolutionStack.length - 1];\r\n  }\r\n\r\n  public popResolutionAndViewport() {\r\n    if (this._resolutionStack.length && this._viewportStack.length) {\r\n      this.resolution = this._resolutionStack.pop();\r\n      this.viewport = this._viewportStack.pop();\r\n    }\r\n  }\r\n\r\n  public applyResolutionAndViewport() {\r\n    if (this.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\r\n      const scaledResolutionSupported = this.graphicsContext.checkIfResolutionSupported({\r\n        width: this.scaledWidth,\r\n        height: this.scaledHeight\r\n      });\r\n      if (!scaledResolutionSupported) {\r\n        this._logger.warnOnce(\r\n          `The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio})` +\r\n            ' are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly.' +\r\n            ' Try reducing the resolution or disabling Hi DPI scaling to avoid this' +\r\n            ' (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).'\r\n        );\r\n\r\n        // Attempt to recover if the user hasn't configured a specific ratio for up scaling\r\n        if (!this.pixelRatioOverride) {\r\n          let currentPixelRatio = Math.max(1, this.pixelRatio - 0.5);\r\n          let newResolutionSupported = false;\r\n          while (currentPixelRatio > 1 && !newResolutionSupported) {\r\n            currentPixelRatio = Math.max(1, currentPixelRatio - 0.5);\r\n            const width = this._resolution.width * currentPixelRatio;\r\n            const height = this._resolution.height * currentPixelRatio;\r\n            newResolutionSupported = this.graphicsContext.checkIfResolutionSupported({ width, height });\r\n          }\r\n          this.pixelRatioOverride = currentPixelRatio;\r\n          this._logger.warnOnce(\r\n            'Scaled resolution too big attempted recovery!' +\r\n              ` Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit.` +\r\n              ' Setting `ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.` ' +\r\n              ' (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).'\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    this._canvas.width = this.scaledWidth;\r\n    this._canvas.height = this.scaledHeight;\r\n\r\n    if (this._canvasImageRendering === 'auto') {\r\n      this._canvas.style.imageRendering = 'auto';\r\n    } else {\r\n      this._canvas.style.imageRendering = 'pixelated';\r\n      // Fall back to 'crisp-edges' if 'pixelated' is not supported\r\n      // Currently for firefox https://developer.mozilla.org/en-US/docs/Web/CSS/image-rendering\r\n      if (this._canvas.style.imageRendering === '') {\r\n        this._canvas.style.imageRendering = 'crisp-edges';\r\n      }\r\n    }\r\n\r\n    const widthUnit = this.viewport.widthUnit === 'percent' ? '%' : 'px';\r\n    const heightUnit = this.viewport.heightUnit === 'percent' ? '%' : 'px';\r\n\r\n    this._canvas.style.width = this.viewport.width + widthUnit;\r\n    this._canvas.style.height = this.viewport.height + heightUnit;\r\n\r\n    // After messing with the canvas width/height the graphics context is invalidated and needs to have some properties reset\r\n    this.graphicsContext.updateViewport(this.resolution);\r\n    this.graphicsContext.resetTransform();\r\n    this.graphicsContext.smoothing = this._antialiasing;\r\n    if (this.graphicsContext instanceof ExcaliburGraphicsContext2DCanvas) {\r\n      this.graphicsContext.scale(this.pixelRatio, this.pixelRatio);\r\n    }\r\n    // Add the excalibur world pixel to page pixel\r\n    document.documentElement.style.setProperty('--ex-pixel-ratio', this.worldToPagePixelRatio.toString());\r\n  }\r\n\r\n  /**\r\n   * Get or set screen antialiasing,\r\n   *\r\n   * If true smoothing is applied\r\n   */\r\n  public get antialiasing() {\r\n    return this._antialiasing;\r\n  }\r\n\r\n  /**\r\n   * Get or set screen antialiasing\r\n   */\r\n  public set antialiasing(isSmooth: boolean) {\r\n    this._antialiasing = isSmooth;\r\n    this.graphicsContext.smoothing = this._antialiasing;\r\n  }\r\n\r\n  /**\r\n   * Returns true if excalibur is fullscreen using the browser fullscreen api\r\n   * @deprecated use isFullscreen()\r\n   */\r\n  public get isFullScreen() {\r\n    return this._isFullscreen;\r\n  }\r\n\r\n  /**\r\n   * Returns true if excalibur is fullscreen using the browser fullscreen api\r\n   */\r\n  public get isFullscreen() {\r\n    return this._isFullscreen;\r\n  }\r\n\r\n  /**\r\n   * Requests to go fullscreen using the browser fullscreen api, requires user interaction to be successful.\r\n   * For example, wire this to a user click handler.\r\n   *\r\n   * Optionally specify a target element id to go fullscreen, by default the game canvas is used\r\n   * @param elementId\r\n   * @deprecated use enterFullscreen(...)\r\n   */\r\n  public goFullScreen(elementId?: string): Promise<void> {\r\n    return this.enterFullscreen(elementId);\r\n  }\r\n\r\n  /**\r\n   * Requests to enter fullscreen using the browser fullscreen api, requires user interaction to be successful.\r\n   * For example, wire this to a user click handler.\r\n   *\r\n   * Optionally specify a target element id to go fullscreen, by default the game canvas is used\r\n   * @param elementId\r\n   */\r\n  public enterFullscreen(elementId?: string): Promise<void> {\r\n    if (elementId) {\r\n      const maybeElement = document.getElementById(elementId);\r\n      // workaround for safari partial support\r\n      if (maybeElement?.requestFullscreen || (maybeElement as any)?.webkitRequestFullscreen) {\r\n        if (!maybeElement.getAttribute('ex-fullscreen-listener')) {\r\n          maybeElement.setAttribute('ex-fullscreen-listener', 'true');\r\n          maybeElement.addEventListener('fullscreenchange', this._fullscreenChangeHandler);\r\n        }\r\n        if (maybeElement.requestFullscreen) {\r\n          return maybeElement.requestFullscreen() ?? Promise.resolve();\r\n        } else if ((maybeElement as any).webkitRequestFullscreen) {\r\n          return (maybeElement as any).webkitRequestFullscreen() ?? Promise.resolve();\r\n        }\r\n      }\r\n    }\r\n    if (this._canvas?.requestFullscreen) {\r\n      return this._canvas?.requestFullscreen() ?? Promise.resolve();\r\n    } else if ((this._canvas as any).webkitRequestFullscreen) {\r\n      return (this._canvas as any).webkitRequestFullscreen() ?? Promise.resolve();\r\n    }\r\n    this._logger.warnOnce('Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones');\r\n    return Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Requests to exit fullscreen using the browser fullscreen api\r\n   * @deprecated use exitFullscreen()\r\n   */\r\n  public exitFullScreen(): Promise<void> {\r\n    return this.exitFullscreen();\r\n  }\r\n\r\n  public exitFullscreen(): Promise<void> {\r\n    return document.exitFullscreen();\r\n  }\r\n\r\n  private _viewportToPixels(viewport: ViewportDimension) {\r\n    return {\r\n      width: viewport.widthUnit === 'percent' ? this.canvas.offsetWidth : viewport.width,\r\n      height: viewport.heightUnit === 'percent' ? this.canvas.offsetHeight : viewport.height\r\n    } satisfies ViewportDimension;\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in normal html page space, for example from a pointer move event, and translates it to\r\n   * Excalibur screen space.\r\n   *\r\n   * Excalibur screen space starts at the top left (0, 0) corner of the viewport, and extends to the\r\n   * bottom right corner (resolutionX, resolutionY). When using *AndFill suffixed display modes screen space\r\n   * (0, 0) is the top left of the safe content area bounding box not the viewport.\r\n   * @param point\r\n   */\r\n  public pageToScreenCoordinates(point: Vector): Vector {\r\n    let newX = point.x;\r\n    let newY = point.y;\r\n\r\n    if (!this._isFullscreen) {\r\n      newX -= getPosition(this._canvas).x;\r\n      newY -= getPosition(this._canvas).y;\r\n    }\r\n\r\n    const viewport = this._viewportToPixels(this.viewport);\r\n\r\n    // if fullscreen api on it centers with black bars\r\n    // we need to adjust the screen to world coordinates in this case\r\n    if (this._isFullscreen) {\r\n      if (window.innerWidth / this.aspectRatio < window.innerHeight) {\r\n        const screenHeight = window.innerWidth / this.aspectRatio;\r\n        const screenMarginY = (window.innerHeight - screenHeight) / 2;\r\n        newY = ((newY - screenMarginY) / screenHeight) * viewport.height;\r\n        newX = (newX / window.innerWidth) * viewport.width;\r\n      } else {\r\n        const screenWidth = window.innerHeight * this.aspectRatio;\r\n        const screenMarginX = (window.innerWidth - screenWidth) / 2;\r\n        newX = ((newX - screenMarginX) / screenWidth) * viewport.width;\r\n        newY = (newY / window.innerHeight) * viewport.height;\r\n      }\r\n    }\r\n\r\n    newX = (newX / viewport.width) * this.resolution.width;\r\n    newY = (newY / viewport.height) * this.resolution.height;\r\n\r\n    // offset by content area\r\n    newX = newX - this.contentArea.left;\r\n    newY = newY - this.contentArea.top;\r\n\r\n    return new Vector(newX, newY);\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur screen space, and translates it to normal html page space. For example,\r\n   * this is where html elements might live if you want to position them relative to Excalibur.\r\n   *\r\n   * Excalibur screen space starts at the top left (0, 0) corner of the viewport, and extends to the\r\n   * bottom right corner (resolutionX, resolutionY)\r\n   * @param point\r\n   */\r\n  public screenToPageCoordinates(point: Vector): Vector {\r\n    let newX = point.x;\r\n    let newY = point.y;\r\n\r\n    // no need to offset by content area, drawing is already offset by this\r\n\r\n    const viewport = this._viewportToPixels(this.viewport);\r\n\r\n    newX = (newX / this.resolution.width) * viewport.width;\r\n    newY = (newY / this.resolution.height) * viewport.height;\r\n\r\n    if (this._isFullscreen) {\r\n      if (window.innerWidth / this.aspectRatio < window.innerHeight) {\r\n        const screenHeight = window.innerWidth / this.aspectRatio;\r\n        const screenMarginY = (window.innerHeight - screenHeight) / 2;\r\n        newY = (newY / viewport.height) * screenHeight + screenMarginY;\r\n        newX = (newX / viewport.width) * window.innerWidth;\r\n      } else {\r\n        const screenWidth = window.innerHeight * this.aspectRatio;\r\n        const screenMarginX = (window.innerWidth - screenWidth) / 2;\r\n        newX = (newX / viewport.width) * screenWidth + screenMarginX;\r\n        newY = (newY / viewport.height) * window.innerHeight;\r\n      }\r\n    }\r\n\r\n    if (!this._isFullscreen) {\r\n      newX += getPosition(this._canvas).x;\r\n      newY += getPosition(this._canvas).y;\r\n    }\r\n\r\n    return new Vector(newX, newY);\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur screen space, and translates it to Excalibur world space.\r\n   *\r\n   * World space is where {@apilink Entity | `entities`} in Excalibur live by default {@apilink CoordPlane.World}\r\n   * and extends infinitely out relative from the {@apilink Camera}.\r\n   * @param point  Screen coordinate to convert\r\n   */\r\n  public screenToWorldCoordinates(point: Vector): Vector {\r\n    // offset by content area\r\n    point = point.add(vec(this.contentArea.left, this.contentArea.top));\r\n\r\n    // the only difference between screen & world is the camera transform\r\n    if (this._camera) {\r\n      return this._camera.inverse.multiply(point);\r\n    }\r\n    return point.sub(vec(this.resolution.width / 2, this.resolution.height / 2));\r\n  }\r\n\r\n  /**\r\n   * Takes a coordinate in Excalibur world space, and translates it to Excalibur screen space.\r\n   *\r\n   * Screen space is where {@apilink ScreenElement | `screen elements`} and {@apilink Entity | `entities`} with {@apilink CoordPlane.Screen} live.\r\n   * @param point  World coordinate to convert\r\n   */\r\n  public worldToScreenCoordinates(point: Vector): Vector {\r\n    if (this._camera) {\r\n      return this._camera.transform.multiply(point);\r\n    }\r\n    return point.add(vec(this.resolution.width / 2, this.resolution.height / 2));\r\n  }\r\n\r\n  public pageToWorldCoordinates(point: Vector): Vector {\r\n    const screen = this.pageToScreenCoordinates(point);\r\n    return this.screenToWorldCoordinates(screen);\r\n  }\r\n\r\n  public worldToPageCoordinates(point: Vector): Vector {\r\n    const screen = this.worldToScreenCoordinates(point);\r\n    return this.screenToPageCoordinates(screen);\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen\r\n   * and the bottom right corner of the screen.\r\n   *\r\n   * World bounds are in world coordinates, useful for culling objects offscreen that are in world space\r\n   */\r\n  public getWorldBounds(): BoundingBox {\r\n    const bounds = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Half)\r\n      .scale(vec(1 / this._camera.zoom, 1 / this._camera.zoom))\r\n      .rotate(this._camera.rotation)\r\n      .translate(this._camera.drawPos);\r\n    return bounds;\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen and the bottom right corner of the screen.\r\n   *\r\n   * Screen bounds are in screen coordinates, useful for culling objects offscreen that are in screen space\r\n   */\r\n  public getScreenBounds(): BoundingBox {\r\n    const bounds = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero, Vector.Zero);\r\n    return bounds;\r\n  }\r\n\r\n  /**\r\n   * The width of the game canvas in pixels (physical width component of the\r\n   * resolution of the canvas element)\r\n   */\r\n  public get canvasWidth(): number {\r\n    return this.canvas.width;\r\n  }\r\n\r\n  /**\r\n   * Returns half width of the game canvas in pixels (half physical width component)\r\n   */\r\n  public get halfCanvasWidth(): number {\r\n    return this.canvas.width / 2;\r\n  }\r\n\r\n  /**\r\n   * The height of the game canvas in pixels, (physical height component of\r\n   * the resolution of the canvas element)\r\n   */\r\n  public get canvasHeight(): number {\r\n    return this.canvas.height;\r\n  }\r\n\r\n  /**\r\n   * Returns half height of the game canvas in pixels (half physical height component)\r\n   */\r\n  public get halfCanvasHeight(): number {\r\n    return this.canvas.height / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawWidth(): number {\r\n    if (this._camera) {\r\n      return this.resolution.width / this._camera.zoom;\r\n    }\r\n    return this.resolution.width;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get width(): number {\r\n    if (this._camera) {\r\n      return this.resolution.width / this._camera.zoom;\r\n    }\r\n    return this.resolution.width;\r\n  }\r\n\r\n  /**\r\n   * Returns half the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawWidth(): number {\r\n    return this.drawWidth / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawHeight(): number {\r\n    if (this._camera) {\r\n      return this.resolution.height / this._camera.zoom;\r\n    }\r\n    return this.resolution.height;\r\n  }\r\n\r\n  public get height(): number {\r\n    if (this._camera) {\r\n      return this.resolution.height / this._camera.zoom;\r\n    }\r\n    return this.resolution.height;\r\n  }\r\n\r\n  /**\r\n   * Returns half the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawHeight(): number {\r\n    return this.drawHeight / 2;\r\n  }\r\n\r\n  /**\r\n   * Returns screen center coordinates including zoom and device pixel ratio.\r\n   */\r\n  public get center(): Vector {\r\n    return vec(this.halfDrawWidth, this.halfDrawHeight);\r\n  }\r\n\r\n  /**\r\n   * Returns the content area in screen space where it is safe to place content\r\n   */\r\n  public get contentArea(): BoundingBox {\r\n    return this._contentArea;\r\n  }\r\n\r\n  /**\r\n   * Returns the unsafe area in screen space, this is the full screen and some space may not be onscreen.\r\n   */\r\n  public get unsafeArea(): BoundingBox {\r\n    return this._unsafeArea;\r\n  }\r\n\r\n  private _contentArea: BoundingBox = new BoundingBox();\r\n  private _unsafeArea: BoundingBox = new BoundingBox();\r\n\r\n  private _computeFit() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    if (window.innerWidth / aspect < window.innerHeight) {\r\n      adjustedWidth = window.innerWidth;\r\n      adjustedHeight = window.innerWidth / aspect;\r\n    } else {\r\n      adjustedWidth = window.innerHeight * aspect;\r\n      adjustedHeight = window.innerHeight;\r\n    }\r\n\r\n    this.viewport = {\r\n      width: adjustedWidth,\r\n      height: adjustedHeight\r\n    };\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n    this._unsafeArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitScreenAndFill() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n    this._computeFitAndFill(vw, vh);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitContainerAndFill() {\r\n    this.canvas.style.width = '100%';\r\n    this.canvas.style.height = '100%';\r\n\r\n    this._computeFitAndFill(this.canvas.offsetWidth, this.canvas.offsetHeight, {\r\n      width: 100,\r\n      widthUnit: 'percent',\r\n      height: 100,\r\n      heightUnit: 'percent'\r\n    });\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitAndFill(vw: number, vh: number, viewport?: ViewportDimension) {\r\n    this.viewport = viewport ?? {\r\n      width: vw,\r\n      height: vh\r\n    };\r\n    // if the current screen aspectRatio is less than the original aspectRatio\r\n    if (vw / vh <= this._contentResolution.width / this._contentResolution.height) {\r\n      // compute new resolution to match the original aspect ratio\r\n      this.resolution = {\r\n        width: (vw * this._contentResolution.width) / vw,\r\n        height: (((vw * this._contentResolution.width) / vw) * vh) / vw\r\n      };\r\n      const clip = (this.resolution.height - this._contentResolution.height) / 2;\r\n      this._contentArea = new BoundingBox({\r\n        top: clip,\r\n        left: 0,\r\n        right: this._contentResolution.width,\r\n        bottom: this.resolution.height - clip\r\n      });\r\n      this._unsafeArea = new BoundingBox({\r\n        top: -clip,\r\n        left: 0,\r\n        right: this._contentResolution.width,\r\n        bottom: this.resolution.height + clip\r\n      });\r\n    } else {\r\n      this.resolution = {\r\n        width: (((vh * this._contentResolution.height) / vh) * vw) / vh,\r\n        height: (vh * this._contentResolution.height) / vh\r\n      };\r\n      const clip = (this.resolution.width - this._contentResolution.width) / 2;\r\n      this._contentArea = new BoundingBox({\r\n        top: 0,\r\n        left: clip,\r\n        right: this.resolution.width - clip,\r\n        bottom: this._contentResolution.height\r\n      });\r\n      this._unsafeArea = new BoundingBox({\r\n        top: 0,\r\n        left: -clip,\r\n        right: this.resolution.width + clip,\r\n        bottom: this._contentResolution.height\r\n      });\r\n    }\r\n  }\r\n\r\n  private _computeFitScreenAndZoom() {\r\n    document.body.style.margin = '0px';\r\n    document.body.style.overflow = 'hidden';\r\n    this.canvas.style.position = 'absolute';\r\n\r\n    const vw = window.innerWidth;\r\n    const vh = window.innerHeight;\r\n\r\n    this._computeFitAndZoom(vw, vh);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitContainerAndZoom() {\r\n    this.canvas.style.width = '100%';\r\n    this.canvas.style.height = '100%';\r\n    this.canvas.style.position = 'relative';\r\n    const parent = this.canvas.parentElement;\r\n    parent.style.overflow = 'hidden';\r\n    const { offsetWidth: vw, offsetHeight: vh } = this.canvas;\r\n\r\n    this._computeFitAndZoom(vw, vh);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _computeFitAndZoom(vw: number, vh: number) {\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    if (vw / aspect < vh) {\r\n      adjustedWidth = vw;\r\n      adjustedHeight = vw / aspect;\r\n    } else {\r\n      adjustedWidth = vh * aspect;\r\n      adjustedHeight = vh;\r\n    }\r\n\r\n    const scaleX = vw / adjustedWidth;\r\n    const scaleY = vh / adjustedHeight;\r\n\r\n    const maxScaleFactor = Math.max(scaleX, scaleY);\r\n\r\n    const zoomedWidth = adjustedWidth * maxScaleFactor;\r\n    const zoomedHeight = adjustedHeight * maxScaleFactor;\r\n\r\n    // Center zoomed dimension if bigger than the screen\r\n    if (zoomedWidth > vw) {\r\n      this.canvas.style.left = -(zoomedWidth - vw) / 2 + 'px';\r\n    } else {\r\n      this.canvas.style.left = '';\r\n    }\r\n\r\n    if (zoomedHeight > vh) {\r\n      this.canvas.style.top = -(zoomedHeight - vh) / 2 + 'px';\r\n    } else {\r\n      this.canvas.style.top = '';\r\n    }\r\n\r\n    this.viewport = {\r\n      width: zoomedWidth,\r\n      height: zoomedHeight\r\n    };\r\n\r\n    const bounds = BoundingBox.fromDimension(this.viewport.width, this.viewport.height, Vector.Zero);\r\n    // return safe area\r\n    if (this.viewport.width > vw) {\r\n      const clip = ((this.viewport.width - vw) / this.viewport.width) * this.resolution.width;\r\n      bounds.top = 0;\r\n      bounds.left = clip / 2;\r\n      bounds.right = this.resolution.width - clip / 2;\r\n      bounds.bottom = this.resolution.height;\r\n    }\r\n\r\n    if (this.viewport.height > vh) {\r\n      const clip = ((this.viewport.height - vh) / this.viewport.height) * this.resolution.height;\r\n      bounds.top = clip / 2;\r\n      bounds.left = 0;\r\n      bounds.bottom = this.resolution.height - clip / 2;\r\n      bounds.right = this.resolution.width;\r\n    }\r\n    this._contentArea = bounds;\r\n  }\r\n\r\n  private _computeFitContainer() {\r\n    const aspect = this.aspectRatio;\r\n    let adjustedWidth = 0;\r\n    let adjustedHeight = 0;\r\n    let widthUnit: ViewportUnit = 'pixel';\r\n    let heightUnit: ViewportUnit = 'pixel';\r\n    const parent = this.canvas.parentElement;\r\n    if (parent.clientWidth / aspect < parent.clientHeight) {\r\n      this.canvas.style.width = '100%';\r\n      adjustedWidth = 100;\r\n      widthUnit = 'percent';\r\n      adjustedHeight = this.canvas.offsetWidth / aspect;\r\n    } else {\r\n      this.canvas.style.height = '100%';\r\n      adjustedHeight = 100;\r\n      heightUnit = 'percent';\r\n      adjustedWidth = this.canvas.offsetHeight * aspect;\r\n    }\r\n\r\n    this.viewport = {\r\n      width: adjustedWidth,\r\n      widthUnit,\r\n      height: adjustedHeight,\r\n      heightUnit\r\n    };\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n    this.events.emit('resize', {\r\n      resolution: this.resolution,\r\n      viewport: this.viewport\r\n    } satisfies ScreenResizeEvent);\r\n  }\r\n\r\n  private _applyDisplayMode() {\r\n    this._setResolutionAndViewportByDisplayMode(this.parent);\r\n\r\n    // watch resizing\r\n    if (this.parent instanceof Window) {\r\n      this._browser.window.on('resize', this._resizeHandler);\r\n    } else {\r\n      this._resizeObserver = new ResizeObserver(() => {\r\n        this._resizeHandler();\r\n      });\r\n      this._resizeObserver.observe(this.parent);\r\n    }\r\n    this.parent.addEventListener('resize', this._resizeHandler);\r\n  }\r\n\r\n  /**\r\n   * Sets the resolution and viewport based on the selected display mode.\r\n   */\r\n  private _setResolutionAndViewportByDisplayMode(parent: HTMLElement | Window) {\r\n    if (this.displayMode === DisplayMode.FillContainer) {\r\n      this.canvas.style.width = '100%';\r\n      this.canvas.style.height = '100%';\r\n      this.viewport = {\r\n        width: 100,\r\n        widthUnit: 'percent',\r\n        height: 100,\r\n        heightUnit: 'percent'\r\n      };\r\n      this.resolution = {\r\n        width: this.canvas.offsetWidth,\r\n        height: this.canvas.offsetHeight\r\n      };\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FillScreen) {\r\n      document.body.style.margin = '0px';\r\n      document.body.style.overflow = 'hidden';\r\n      this.resolution = {\r\n        width: (<Window>parent).innerWidth,\r\n        height: (<Window>parent).innerHeight\r\n      };\r\n\r\n      this.viewport = this.resolution;\r\n    }\r\n\r\n    this._contentArea = BoundingBox.fromDimension(this.resolution.width, this.resolution.height, Vector.Zero);\r\n\r\n    if (this.displayMode === DisplayMode.FitScreen) {\r\n      this._computeFit();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainer) {\r\n      this._computeFitContainer();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreenAndFill) {\r\n      this._computeFitScreenAndFill();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainerAndFill) {\r\n      this._computeFitContainerAndFill();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitScreenAndZoom) {\r\n      this._computeFitScreenAndZoom();\r\n    }\r\n\r\n    if (this.displayMode === DisplayMode.FitContainerAndZoom) {\r\n      this._computeFitContainerAndZoom();\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Internal class used to build instances of AudioContext\r\n */\r\n/* istanbul ignore next */\r\nexport class AudioContextFactory {\r\n  private static _INSTANCE?: AudioContext;\r\n\r\n  public static create(): AudioContext {\r\n    if (!this._INSTANCE) {\r\n      if ((<any>window).AudioContext || (<any>window).webkitAudioContext) {\r\n        this._INSTANCE = new AudioContext();\r\n      }\r\n    }\r\n\r\n    return this._INSTANCE!;\r\n  }\r\n}\r\n","import { AudioContextFactory } from '../Resources/Sound/AudioContext';\nimport { Logger } from './Log';\n\nexport interface LegacyWebAudioSource {\n  playbackState: string;\n  PLAYING_STATE: 'playing';\n  FINISHED_STATE: 'finished';\n}\n\n/**\n * Patch for detecting legacy web audio in browsers\n * @internal\n * @param source\n */\nfunction isLegacyWebAudioSource(source: any): source is LegacyWebAudioSource {\n  return !!source.playbackState;\n}\n\nexport class WebAudio {\n  private static _UNLOCKED: boolean = false;\n\n  /**\n   * Play an empty sound to unlock Safari WebAudio context. Call this function\n   * right after a user interaction event.\n   * @source https://paulbakaus.com/tutorials/html5/web-audio-on-ios/\n   */\n  static unlock(): Promise<boolean> {\n    const promise = new Promise<boolean>((resolve, reject) => {\n      if (WebAudio._UNLOCKED || !AudioContextFactory.create()) {\n        return resolve(true);\n      }\n      const unlockTimeoutTimer = setTimeout(() => {\n        Logger.getInstance().warn('Excalibur was unable to unlock the audio context, audio probably will not play in this browser.');\n        resolve(false);\n      }, 200);\n\n      const audioContext = AudioContextFactory.create();\n      audioContext.resume().then(\n        () => {\n          // create empty buffer and play it\n          const buffer = audioContext.createBuffer(1, 1, 22050);\n          const source = audioContext.createBufferSource();\n          let ended = false;\n\n          source.buffer = buffer;\n          source.connect(audioContext.destination);\n          source.onended = () => (ended = true);\n\n          source.start(0);\n\n          // by checking the play state after some time, we know if we're really unlocked\n          setTimeout(() => {\n            if (isLegacyWebAudioSource(source)) {\n              if (source.playbackState === source.PLAYING_STATE || source.playbackState === source.FINISHED_STATE) {\n                WebAudio._UNLOCKED = true;\n              }\n            } else {\n              if (audioContext.currentTime > 0 || ended) {\n                WebAudio._UNLOCKED = true;\n              }\n            }\n          }, 0);\n\n          clearTimeout(unlockTimeoutTimer);\n          resolve(true);\n        },\n        () => {\n          reject();\n        }\n      );\n    });\n\n    return promise;\n  }\n\n  static isUnlocked() {\n    return this._UNLOCKED;\n  }\n}\n","import { GraphicOptions } from './Graphic';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface CanvasOptions {\r\n  draw?: (ctx: CanvasRenderingContext2D) => void;\r\n  cache?: boolean;\r\n}\r\n\r\n/**\r\n * A canvas {@apilink Graphic} to provide an adapter between the 2D Canvas API and the {@apilink ExcaliburGraphicsContext}.\r\n *\r\n * The {@apilink Canvas} works by re-rastering a draw handler to a HTMLCanvasElement for every draw which is then passed\r\n * to the {@apilink ExcaliburGraphicsContext} implementation as a rendered image.\r\n *\r\n * **Low performance API**\r\n */\r\nexport class Canvas extends Raster {\r\n  /**\r\n   * Return the 2D graphics context of this canvas\r\n   */\r\n  public get ctx() {\r\n    return this._ctx;\r\n  }\r\n\r\n  constructor(private _options: GraphicOptions & RasterOptions & CanvasOptions = {}) {\r\n    super(_options);\r\n  }\r\n\r\n  public clone(): Canvas {\r\n    return new Canvas({\r\n      ...this._options,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this._options?.draw) {\r\n      this._options?.draw(ctx);\r\n    }\r\n    if (!this._options.cache) {\r\n      this.flagDirty();\r\n    }\r\n  }\r\n}\r\n","import { Audio } from './Audio';\r\n\r\nexport type ExResponseType = '' | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text';\r\n\r\nexport interface ExResponseTypesLookup {\r\n  [name: string]: ExResponseType;\r\n}\r\n\r\nexport class ExResponse {\r\n  public static type: ExResponseTypesLookup = {\r\n    any: '',\r\n    blob: 'blob',\r\n    json: 'json',\r\n    text: 'text',\r\n    document: 'document',\r\n    arraybuffer: 'arraybuffer'\r\n  };\r\n}\r\n\r\n/**\r\n * Represents an audio implementation like {@apilink WebAudioInstance}\r\n */\r\nexport interface AudioImplementation {\r\n  /**\r\n   * XHR response type\r\n   */\r\n  responseType: ExResponseType;\r\n\r\n  /**\r\n   * Processes raw data and transforms into sound data\r\n   */\r\n  processData(data: Blob | ArrayBuffer): Promise<string | AudioBuffer>;\r\n\r\n  /**\r\n   * Factory method that returns an instance of a played audio track\r\n   */\r\n  createInstance(data: string | AudioBuffer): Audio;\r\n}\r\n","export interface State<TData> {\r\n  name?: string;\r\n  transitions: string[];\r\n  onEnter?: (context: { from: string; eventData?: any; data: TData }) => boolean | void;\r\n  onState?: () => any;\r\n  onExit?: (context: { to: string; data: TData }) => boolean | void;\r\n  onUpdate?: (data: TData, elapsed: number) => any;\r\n}\r\n\r\nexport interface StateMachineDescription<TData = any> {\r\n  start: string;\r\n  states: { [name: string]: State<TData> };\r\n}\r\n\r\nexport type PossibleStates<TMachine> = TMachine extends StateMachineDescription ? Extract<keyof TMachine['states'], string> : never;\r\n\r\nexport interface StateMachineState<TData> {\r\n  data: TData;\r\n  currentState: string;\r\n}\r\n\r\nexport class StateMachine<TPossibleStates extends string, TData> {\r\n  public startState: State<TData>;\r\n  private _currentState: State<TData>;\r\n  public get currentState(): State<TData> {\r\n    return this._currentState;\r\n  }\r\n  public set currentState(state: State<TData>) {\r\n    this._currentState = state;\r\n  }\r\n  public states = new Map<string, State<TData>>();\r\n  public data: TData;\r\n\r\n  static create<TMachine extends StateMachineDescription<TData>, TData>(\r\n    machineDescription: TMachine,\r\n    data?: TData\r\n  ): StateMachine<PossibleStates<TMachine>, TData> {\r\n    const machine = new StateMachine<PossibleStates<TMachine>, TData>();\r\n    machine.data = data;\r\n    for (const stateName in machineDescription.states) {\r\n      machine.states.set(stateName as PossibleStates<TMachine>, {\r\n        name: stateName,\r\n        ...machineDescription.states[stateName]\r\n      });\r\n    }\r\n\r\n    // validate transitions are states\r\n    for (const state of machine.states.values()) {\r\n      for (const transitionState of state.transitions) {\r\n        if (transitionState === '*') {\r\n          continue;\r\n        }\r\n        if (!machine.states.has(transitionState)) {\r\n          throw Error(\r\n            `Invalid state machine, state [${state.name}] has a transition to another state that doesn't exist [${transitionState}]`\r\n          );\r\n        }\r\n      }\r\n    }\r\n    machine.currentState = machine.startState = machine.states.get(machineDescription.start);\r\n    return machine;\r\n  }\r\n\r\n  in(state: TPossibleStates): boolean {\r\n    return this.currentState.name === state;\r\n  }\r\n\r\n  go(stateName: TPossibleStates, eventData?: any): boolean {\r\n    if (this.currentState.transitions.includes(stateName) || this.currentState.transitions.includes('*')) {\r\n      const potentialNewState = this.states.get(stateName);\r\n      if (this.currentState.onExit) {\r\n        const canExit = this.currentState?.onExit({ to: potentialNewState.name, data: this.data });\r\n        if (canExit === false) {\r\n          return false;\r\n        }\r\n      }\r\n\r\n      if (potentialNewState?.onEnter) {\r\n        const canEnter = potentialNewState?.onEnter({ from: this.currentState.name, eventData, data: this.data });\r\n        if (canEnter === false) {\r\n          return false;\r\n        }\r\n      }\r\n      this.currentState = potentialNewState;\r\n      if (this.currentState?.onState) {\r\n        this.currentState.onState();\r\n      }\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  update(elapsed: number) {\r\n    if (this.currentState.onUpdate) {\r\n      this.currentState.onUpdate(this.data, elapsed);\r\n    }\r\n  }\r\n\r\n  save(saveKey: string) {\r\n    localStorage.setItem(\r\n      saveKey,\r\n      JSON.stringify({\r\n        currentState: this.currentState.name,\r\n        data: this.data\r\n      })\r\n    );\r\n  }\r\n\r\n  restore(saveKey: string) {\r\n    const state: StateMachineState<TData> = JSON.parse(localStorage.getItem(saveKey));\r\n    this.currentState = this.states.get(state.currentState);\r\n    this.data = state.data;\r\n  }\r\n}\r\n","import { StateMachine } from '../../Util/StateMachine';\r\nimport { Audio } from '../../Interfaces/Audio';\r\nimport { clamp } from '../../Math/util';\r\nimport { AudioContextFactory } from './AudioContext';\r\nimport { Future } from '../../Util/Future';\r\n\r\ninterface SoundState {\r\n  startedAt: number;\r\n  pausedAt: number;\r\n}\r\n\r\n/**\r\n * Internal class representing a Web Audio AudioBufferSourceNode instance\r\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API\r\n */\r\nexport class WebAudioInstance implements Audio {\r\n  private _instance!: AudioBufferSourceNode;\r\n  private _audioContext: AudioContext = AudioContextFactory.create();\r\n  private _volumeNode = this._audioContext.createGain();\r\n\r\n  private _playingFuture = new Future<boolean>();\r\n  private _stateMachine = StateMachine.create(\r\n    {\r\n      start: 'STOPPED',\r\n      states: {\r\n        PLAYING: {\r\n          onEnter: ({ data }) => {\r\n            // Buffer nodes are single use\r\n            this._createNewBufferSource();\r\n            this._handleEnd();\r\n            if (this.loop) {\r\n              // when looping don't set a duration\r\n              this._instance.start(0, data.pausedAt * this._playbackRate);\r\n            } else {\r\n              this._instance.start(0, data.pausedAt * this._playbackRate, this.duration);\r\n            }\r\n            data.startedAt = this._audioContext.currentTime - data.pausedAt;\r\n            data.pausedAt = 0;\r\n          },\r\n          onState: () => this._playStarted(),\r\n          onExit: ({ to }) => {\r\n            // If you've exited early only resolve if explicitly STOPPED\r\n            if (to === 'STOPPED') {\r\n              this._playingFuture.resolve(true);\r\n            }\r\n            // Whenever you're not playing... you stop!\r\n            this._instance.onended = null; // disconnect the wired on-end handler\r\n            this._instance.disconnect();\r\n            this._instance.stop(0);\r\n            this._instance = null as any;\r\n          },\r\n          transitions: ['STOPPED', 'PAUSED', 'SEEK']\r\n        },\r\n        SEEK: {\r\n          onEnter: ({ eventData: position, data }: { eventData?: number; data: SoundState }) => {\r\n            data.pausedAt = (position ?? 0) / this._playbackRate;\r\n            data.startedAt = 0;\r\n          },\r\n          transitions: ['*']\r\n        },\r\n        STOPPED: {\r\n          onEnter: ({ data }) => {\r\n            data.pausedAt = 0;\r\n            data.startedAt = 0;\r\n            this._playingFuture.resolve(true);\r\n          },\r\n          transitions: ['PLAYING', 'PAUSED', 'SEEK']\r\n        },\r\n        PAUSED: {\r\n          onEnter: ({ data }) => {\r\n            // Playback rate will be a scale factor of how fast/slow the audio is being played\r\n            // default is 1.0\r\n            // we need to invert it to get the time scale\r\n            data.pausedAt = this._audioContext.currentTime - data.startedAt;\r\n          },\r\n          transitions: ['PLAYING', 'STOPPED', 'SEEK']\r\n        }\r\n      }\r\n    },\r\n    {\r\n      startedAt: 0,\r\n      pausedAt: 0\r\n    } satisfies SoundState\r\n  );\r\n\r\n  private _createNewBufferSource() {\r\n    this._instance = this._audioContext.createBufferSource();\r\n    this._instance.buffer = this._src;\r\n    this._instance.loop = this.loop;\r\n    this._instance.playbackRate.value = this._playbackRate;\r\n    this._instance.connect(this._volumeNode);\r\n    this._volumeNode.connect(this._audioContext.destination);\r\n  }\r\n\r\n  private _handleEnd() {\r\n    if (!this.loop) {\r\n      this._instance.onended = () => {\r\n        this._playingFuture.resolve(true);\r\n      };\r\n    }\r\n  }\r\n\r\n  private _volume = 1;\r\n  private _loop = false;\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  private _playStarted: () => any = () => {};\r\n  public set loop(value: boolean) {\r\n    this._loop = value;\r\n\r\n    if (this._instance) {\r\n      this._instance.loop = value;\r\n      if (!this.loop) {\r\n        this._instance.onended = () => {\r\n          this._playingFuture.resolve(true);\r\n        };\r\n      }\r\n    }\r\n  }\r\n  public get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  public set volume(value: number) {\r\n    value = clamp(value, 0, 1.0);\r\n\r\n    this._volume = value;\r\n\r\n    if (this._stateMachine.in('PLAYING') && this._volumeNode.gain.setTargetAtTime) {\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/AudioParam/setTargetAtTime\r\n      // After each .1 seconds timestep, the target value will ~63.2% closer to the target value.\r\n      // This exponential ramp provides a more pleasant transition in gain\r\n      this._volumeNode.gain.setTargetAtTime(value, this._audioContext.currentTime, 0.1);\r\n    } else {\r\n      this._volumeNode.gain.value = value;\r\n    }\r\n  }\r\n  public get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  private _duration: number | undefined;\r\n  /**\r\n   * Returns the set duration to play, otherwise returns the total duration if unset\r\n   */\r\n  public get duration() {\r\n    return this._duration ?? this.getTotalPlaybackDuration();\r\n  }\r\n\r\n  /**\r\n   * Set the duration that this audio should play.\r\n   *\r\n   * Note: if you seek to a specific point the duration will start from that point, for example\r\n   *\r\n   * If you have a 10 second clip, seek to 5 seconds, then set the duration to 2, it will play the clip from 5-7 seconds.\r\n   */\r\n  public set duration(duration: number) {\r\n    this._duration = duration;\r\n  }\r\n\r\n  constructor(private _src: AudioBuffer) {\r\n    this._createNewBufferSource();\r\n  }\r\n\r\n  public isPlaying() {\r\n    return this._stateMachine.in('PLAYING');\r\n  }\r\n\r\n  public isPaused() {\r\n    return this._stateMachine.in('PAUSED') || this._stateMachine.in('SEEK');\r\n  }\r\n\r\n  public isStopped() {\r\n    return this._stateMachine.in('STOPPED');\r\n  }\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-empty-function\r\n  public play(playStarted: () => any = () => {}) {\r\n    this._playStarted = playStarted;\r\n    this._stateMachine.go('PLAYING');\r\n    return this._playingFuture.promise;\r\n  }\r\n\r\n  public pause() {\r\n    this._stateMachine.go('PAUSED');\r\n  }\r\n\r\n  public stop() {\r\n    this._stateMachine.go('STOPPED');\r\n  }\r\n\r\n  public seek(position: number) {\r\n    this._stateMachine.go('PAUSED');\r\n    this._stateMachine.go('SEEK', position);\r\n  }\r\n\r\n  public getTotalPlaybackDuration() {\r\n    return this._src.duration;\r\n  }\r\n\r\n  public getPlaybackPosition() {\r\n    const { pausedAt, startedAt } = this._stateMachine.data;\r\n    if (pausedAt) {\r\n      return pausedAt * this._playbackRate;\r\n    }\r\n    if (startedAt) {\r\n      return (this._audioContext.currentTime - startedAt) * this._playbackRate;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  private _playbackRate = 1.0;\r\n  public set playbackRate(playbackRate: number) {\r\n    this._instance.playbackRate.value = this._playbackRate = playbackRate;\r\n  }\r\n\r\n  public get playbackRate() {\r\n    return this._instance.playbackRate.value;\r\n  }\r\n}\r\n","import { GameEvent } from '../Events';\r\nimport { Sound } from '../Resources/Sound/Sound';\r\nimport { Actor } from '../Actor';\r\nimport { WebAudioInstance } from '../Resources/Sound/WebAudioInstance';\r\n\r\nexport class MediaEvent extends GameEvent<Sound> {\r\n  /**\r\n   * Media event cannot bubble\r\n   */\r\n  public set bubbles(_value: boolean) {\r\n    // stubbed\r\n  }\r\n  /**\r\n   * Media event cannot bubble\r\n   */\r\n  public get bubbles(): boolean {\r\n    return false;\r\n  }\r\n  /**\r\n   * Media event cannot bubble, so they have no path\r\n   */\r\n  protected get _path(): Actor[] {\r\n    return null;\r\n  }\r\n  /**\r\n   * Media event cannot bubble, so they have no path\r\n   */\r\n  protected set _path(_val: Actor[]) {\r\n    // stubbed\r\n  }\r\n\r\n  constructor(\r\n    public target: Sound,\r\n    protected _name: string = 'MediaEvent'\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * Prevents event from bubbling\r\n   */\r\n  public stopPropagation(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n  /**\r\n   * Action, that calls when event happens\r\n   */\r\n  public action(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n  /**\r\n   * Propagate event further through event path\r\n   */\r\n  public propagate(): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n\r\n  public layPath(_actor: Actor): void {\r\n    /**\r\n     * Stub\r\n     */\r\n  }\r\n}\r\n\r\nexport class NativeSoundEvent extends MediaEvent {\r\n  constructor(\r\n    target: Sound,\r\n    public track?: WebAudioInstance\r\n  ) {\r\n    super(target, 'NativeSoundEvent');\r\n  }\r\n}\r\n\r\nexport class NativeSoundProcessedEvent extends MediaEvent {\r\n  public data: string | AudioBuffer;\r\n\r\n  constructor(\r\n    target: Sound,\r\n    private _processedData: string | AudioBuffer\r\n  ) {\r\n    super(target, 'NativeSoundProcessedEvent');\r\n\r\n    this.data = this._processedData;\r\n  }\r\n}\r\n","import { Logger } from './Log';\n\n/**\n * Whether or not the browser can play this file as HTML5 Audio\n */\nexport function canPlayFile(file: string): boolean {\n  try {\n    const a = new Audio();\n    const filetype = /.*\\.([A-Za-z0-9]+)(?:(?:\\?|\\#).*)*$/;\n    const type = file.match(filetype)[1];\n    if (a.canPlayType('audio/' + type)) {\n      return true;\n    } else {\n      return false;\n    }\n  } catch (e) {\n    Logger.getInstance().warn('Cannot determine audio support, assuming no support for the Audio Tag', e);\n    return false;\n  }\n}\n","import { ExResponse } from '../../Interfaces/AudioImplementation';\r\nimport { Audio } from '../../Interfaces/Audio';\r\nimport { Engine } from '../../Engine';\r\nimport { Resource } from '../Resource';\r\nimport { WebAudioInstance } from './WebAudioInstance';\r\nimport { AudioContextFactory } from './AudioContext';\r\nimport { NativeSoundEvent, NativeSoundProcessedEvent } from '../../Events/MediaEvents';\r\nimport { canPlayFile } from '../../Util/Sound';\r\nimport { Loadable } from '../../Interfaces/Index';\r\nimport { Logger } from '../../Util/Log';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../../EventEmitter';\r\n\r\nexport type SoundEvents = {\r\n  volumechange: NativeSoundEvent;\r\n  processed: NativeSoundProcessedEvent;\r\n  pause: NativeSoundEvent;\r\n  stop: NativeSoundEvent;\r\n  playbackend: NativeSoundEvent;\r\n  resume: NativeSoundEvent;\r\n  playbackstart: NativeSoundEvent;\r\n};\r\n\r\nexport const SoundEvents = {\r\n  VolumeChange: 'volumechange',\r\n  Processed: 'processed',\r\n  Pause: 'pause',\r\n  Stop: 'stop',\r\n  PlaybackEnd: 'playbackend',\r\n  Resume: 'resume',\r\n  PlaybackStart: 'playbackstart'\r\n};\r\n\r\n/**\r\n * The {@apilink Sound} object allows games built in Excalibur to load audio\r\n * components, from soundtracks to sound effects. {@apilink Sound} is an {@apilink Loadable}\r\n * which means it can be passed to a {@apilink Loader} to pre-load before a game or level.\r\n */\r\nexport class Sound implements Audio, Loadable<AudioBuffer> {\r\n  public events = new EventEmitter<SoundEvents>();\r\n  public logger: Logger = Logger.getInstance();\r\n  public data!: AudioBuffer;\r\n  private _resource: Resource<ArrayBuffer>;\r\n  /**\r\n   * Indicates whether the clip should loop when complete\r\n   * @param value  Set the looping flag\r\n   */\r\n  public set loop(value: boolean) {\r\n    this._loop = value;\r\n\r\n    for (const track of this._tracks) {\r\n      track.loop = this._loop;\r\n    }\r\n\r\n    this.logger.debug('Set loop for all instances of sound', this.path, 'to', this._loop);\r\n  }\r\n  public get loop(): boolean {\r\n    return this._loop;\r\n  }\r\n\r\n  public set volume(value: number) {\r\n    this._volume = value;\r\n\r\n    for (const track of this._tracks) {\r\n      track.volume = this._volume;\r\n    }\r\n\r\n    this.events.emit('volumechange', new NativeSoundEvent(this));\r\n\r\n    this.logger.debug('Set loop for all instances of sound', this.path, 'to', this._volume);\r\n  }\r\n  public get volume(): number {\r\n    return this._volume;\r\n  }\r\n\r\n  private _duration: number | undefined;\r\n  /**\r\n   * Get the duration that this audio should play. If unset the total natural playback duration will be used.\r\n   */\r\n  public get duration(): number | undefined {\r\n    return this._duration;\r\n  }\r\n  /**\r\n   * Set the duration that this audio should play. If unset the total natural playback duration will be used.\r\n   *\r\n   * Note: if you seek to a specific point the duration will start from that point, for example\r\n   *\r\n   * If you have a 10 second clip, seek to 5 seconds, then set the duration to 2, it will play the clip from 5-7 seconds.\r\n   */\r\n  public set duration(duration: number | undefined) {\r\n    this._duration = duration;\r\n  }\r\n\r\n  /**\r\n   * Return array of Current AudioInstances playing or being paused\r\n   */\r\n  public get instances(): Audio[] {\r\n    return this._tracks;\r\n  }\r\n\r\n  public get path() {\r\n    return this._resource.path;\r\n  }\r\n\r\n  public set path(val: string) {\r\n    this._resource.path = val;\r\n  }\r\n\r\n  /**\r\n   * Should excalibur add a cache busting querystring? By default false.\r\n   * Must be set before loading\r\n   */\r\n  public get bustCache() {\r\n    return this._resource.bustCache;\r\n  }\r\n\r\n  public set bustCache(val: boolean) {\r\n    this._resource.bustCache = val;\r\n  }\r\n\r\n  private _loop = false;\r\n  private _volume = 1;\r\n  private _isStopped = false;\r\n  // private _isPaused = false;\r\n  private _tracks: Audio[] = [];\r\n  private _engine?: Engine;\r\n  private _wasPlayingOnHidden: boolean = false;\r\n  private _playbackRate = 1.0;\r\n  private _audioContext = AudioContextFactory.create();\r\n\r\n  /**\r\n   * @param paths A list of audio sources (clip.wav, clip.mp3, clip.ogg) for this audio clip. This is done for browser compatibility.\r\n   */\r\n  constructor(...paths: string[]) {\r\n    this._resource = new Resource('', ExResponse.type.arraybuffer);\r\n    /**\r\n     * Chrome : MP3, WAV, Ogg\r\n     * Firefox : WAV, Ogg,\r\n     * IE : MP3, WAV coming soon\r\n     * Safari MP3, WAV, Ogg\r\n     */\r\n    for (const path of paths) {\r\n      if (canPlayFile(path)) {\r\n        this.path = path;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!this.path) {\r\n      this.logger.warn('This browser does not support any of the audio files specified:', paths.join(', '));\r\n      this.logger.warn('Attempting to use', paths[0]);\r\n      this.path = paths[0]; // select the first specified\r\n    }\r\n  }\r\n\r\n  public isLoaded() {\r\n    return !!this.data;\r\n  }\r\n\r\n  public async load(): Promise<AudioBuffer> {\r\n    if (this.data) {\r\n      return this.data;\r\n    }\r\n    const arraybuffer = await this._resource.load();\r\n    const audiobuffer = await this.decodeAudio(arraybuffer.slice(0));\r\n    this._duration = this._duration ?? audiobuffer?.duration ?? undefined;\r\n    this.events.emit('processed', new NativeSoundProcessedEvent(this, audiobuffer));\r\n    return (this.data = audiobuffer);\r\n  }\r\n\r\n  public async decodeAudio(data: ArrayBuffer): Promise<AudioBuffer> {\r\n    try {\r\n      return await this._audioContext.decodeAudioData(data.slice(0));\r\n    } catch (e) {\r\n      this.logger.error(\r\n        'Unable to decode ' +\r\n          ' this browser may not fully support this format, or the file may be corrupt, ' +\r\n          'if this is an mp3 try removing id3 tags and album art from the file.'\r\n      );\r\n      return await Promise.reject();\r\n    }\r\n  }\r\n\r\n  public wireEngine(engine: Engine) {\r\n    if (engine) {\r\n      this._engine = engine;\r\n\r\n      this._engine.on('hidden', () => {\r\n        if (engine.pauseAudioWhenHidden && this.isPlaying()) {\r\n          this._wasPlayingOnHidden = true;\r\n          this.pause();\r\n        }\r\n      });\r\n\r\n      this._engine.on('visible', () => {\r\n        if (engine.pauseAudioWhenHidden && this._wasPlayingOnHidden) {\r\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n          this.play();\r\n          this._wasPlayingOnHidden = false;\r\n        }\r\n      });\r\n\r\n      this._engine.on('start', () => {\r\n        this._isStopped = false;\r\n      });\r\n\r\n      this._engine.on('stop', () => {\r\n        this.stop();\r\n        this._isStopped = true;\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns how many instances of the sound are currently playing\r\n   */\r\n  public instanceCount(): number {\r\n    return this._tracks.length;\r\n  }\r\n\r\n  /**\r\n   * Whether or not the sound is playing right now\r\n   */\r\n  public isPlaying(): boolean {\r\n    return this._tracks.some((t) => t.isPlaying());\r\n  }\r\n\r\n  public isPaused(): boolean {\r\n    return this._tracks.some((t) => t.isPaused());\r\n  }\r\n\r\n  public isStopped(): boolean {\r\n    return this._tracks.some((t) => t.isStopped());\r\n  }\r\n\r\n  /**\r\n   * Play the sound, returns a promise that resolves when the sound is done playing\r\n   * An optional volume argument can be passed in to play the sound. Max volume is 1.0\r\n   */\r\n  public play(volume?: number): Promise<boolean> {\r\n    if (!this.isLoaded()) {\r\n      this.logger.warn('Cannot start playing. Resource', this.path, 'is not loaded yet');\r\n\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    if (this._isStopped) {\r\n      this.logger.warn('Cannot start playing. Engine is in a stopped state.');\r\n      return Promise.resolve(false);\r\n    }\r\n\r\n    this.volume = volume || this.volume;\r\n\r\n    if (this.isPaused()) {\r\n      return this._resumePlayback();\r\n    } else {\r\n      return this._startPlayback();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop the sound, and do not rewind\r\n   */\r\n  public pause() {\r\n    if (!this.isPlaying()) {\r\n      return;\r\n    }\r\n\r\n    for (const track of this._tracks) {\r\n      track.pause();\r\n    }\r\n\r\n    this.events.emit('pause', new NativeSoundEvent(this));\r\n\r\n    this.logger.debug('Paused all instances of sound', this.path);\r\n  }\r\n\r\n  /**\r\n   * Stop the sound if it is currently playing and rewind the track. If the sound is not playing, rewinds the track.\r\n   */\r\n  public stop() {\r\n    for (const track of this._tracks) {\r\n      track.stop();\r\n    }\r\n\r\n    this.events.emit('stop', new NativeSoundEvent(this));\r\n\r\n    this._tracks.length = 0;\r\n    this.logger.debug('Stopped all instances of sound', this.path);\r\n  }\r\n\r\n  public get playbackRate(): number {\r\n    return this._playbackRate;\r\n  }\r\n\r\n  public set playbackRate(playbackRate: number) {\r\n    this._playbackRate = playbackRate;\r\n    this._tracks.forEach((t) => {\r\n      t.playbackRate = this._playbackRate;\r\n    });\r\n  }\r\n\r\n  public seek(position: number, trackId = 0) {\r\n    if (this._tracks.length === 0) {\r\n      this._getTrackInstance(this.data);\r\n    }\r\n\r\n    this._tracks[trackId].seek(position);\r\n  }\r\n\r\n  public getTotalPlaybackDuration() {\r\n    if (!this.isLoaded()) {\r\n      this.logger.warnOnce(\r\n        `Sound from ${this.path} is not loaded, cannot return total playback duration.` +\r\n          `Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`\r\n      );\r\n      return 0;\r\n    }\r\n    return this.data.duration;\r\n  }\r\n\r\n  /**\r\n   * Return the current playback time of the playing track in seconds from the start.\r\n   *\r\n   * Optionally specify the track to query if multiple are playing at once.\r\n   * @param trackId\r\n   */\r\n  public getPlaybackPosition(trackId = 0) {\r\n    if (this._tracks.length) {\r\n      return this._tracks[trackId].getPlaybackPosition();\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * Get Id of provided AudioInstance in current trackList\r\n   * @param track {@apilink Audio} which Id is to be given\r\n   */\r\n  public getTrackId(track: Audio): number {\r\n    return this._tracks.indexOf(track);\r\n  }\r\n\r\n  private async _resumePlayback(): Promise<boolean> {\r\n    if (this.isPaused()) {\r\n      const resumed: Promise<boolean>[] = [];\r\n      // ensure we resume *current* tracks (if paused)\r\n      for (const track of this._tracks) {\r\n        resumed.push(\r\n          track.play().then(() => {\r\n            this._tracks.splice(this.getTrackId(track), 1);\r\n            return true;\r\n          })\r\n        );\r\n      }\r\n\r\n      this.events.emit('resume', new NativeSoundEvent(this));\r\n\r\n      this.logger.debug('Resuming paused instances for sound', this.path, this._tracks);\r\n      // resolve when resumed tracks are done\r\n      await Promise.all(resumed);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Starts playback, returns a promise that resolves when playback is complete\r\n   */\r\n  private async _startPlayback(): Promise<boolean> {\r\n    const track = this._getTrackInstance(this.data);\r\n\r\n    const complete = await track.play(() => {\r\n      this.events.emit('playbackstart', new NativeSoundEvent(this, track));\r\n      this.logger.debug('Playing new instance for sound', this.path);\r\n    });\r\n\r\n    this.events.emit('playbackend', new NativeSoundEvent(this, track));\r\n\r\n    // cleanup any done tracks\r\n    const trackId = this.getTrackId(track);\r\n    if (trackId !== -1) {\r\n      this._tracks.splice(trackId, 1);\r\n    }\r\n\r\n    return complete;\r\n  }\r\n\r\n  private _getTrackInstance(data: AudioBuffer): WebAudioInstance {\r\n    const newTrack = new WebAudioInstance(data);\r\n\r\n    newTrack.loop = this.loop;\r\n    newTrack.volume = this.volume;\r\n    newTrack.duration = this.duration ?? 0;\r\n    newTrack.playbackRate = this._playbackRate;\r\n\r\n    this._tracks.push(newTrack);\r\n\r\n    return newTrack;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, event: SoundEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, handler: Handler<SoundEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, handler: Handler<SoundEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<SoundEvents>>(eventName: TEventName, handler: Handler<SoundEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<SoundEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler as any);\r\n  }\r\n}\r\n","import { WebAudio } from '../Util/WebAudio';\r\nimport { Engine } from '../Engine';\r\nimport { Loadable } from '../Interfaces/Loadable';\r\nimport { Canvas } from '../Graphics/Canvas';\r\nimport { ImageFiltering } from '../Graphics/Filtering';\r\nimport { clamp } from '../Math/util';\r\nimport { Sound } from '../Resources/Sound/Sound';\r\nimport { Future } from '../Util/Future';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { Color } from '../Color';\r\nimport { delay } from '../Util/Util';\r\n\r\nexport interface DefaultLoaderOptions {\r\n  /**\r\n   * List of loadables\r\n   */\r\n  loadables?: Loadable<any>[];\r\n}\r\n\r\nexport type LoaderEvents = {\r\n  // Add event types here\r\n  beforeload: void;\r\n  afterload: void;\r\n  useraction: void;\r\n  loadresourcestart: Loadable<any>;\r\n  loadresourceend: Loadable<any>;\r\n};\r\n\r\nexport const LoaderEvents = {\r\n  // Add event types here\r\n  BeforeLoad: 'beforeload',\r\n  AfterLoad: 'afterload',\r\n  UserAction: 'useraction',\r\n  LoadResourceStart: 'loadresourcestart',\r\n  LoadResourceEnd: 'loadresourceend'\r\n};\r\n\r\nexport type LoaderConstructor = new (...args: any[]) => DefaultLoader;\r\n/**\r\n * Returns true if the constructor is for an Excalibur Loader\r\n */\r\nexport function isLoaderConstructor(x: any): x is LoaderConstructor {\r\n  return !!x?.prototype && !!x?.prototype?.constructor?.name;\r\n}\r\n\r\nexport class DefaultLoader implements Loadable<Loadable<any>[]> {\r\n  public data!: Loadable<any>[];\r\n  public events = new EventEmitter<LoaderEvents>();\r\n  public canvas: Canvas = new Canvas({\r\n    filtering: ImageFiltering.Blended,\r\n    smoothing: true,\r\n    cache: false,\r\n    draw: this.onDraw.bind(this)\r\n  });\r\n  private _resources: Loadable<any>[] = [];\r\n  public get resources(): readonly Loadable<any>[] {\r\n    return this._resources;\r\n  }\r\n  private _numLoaded: number = 0;\r\n  public engine!: Engine;\r\n\r\n  /**\r\n   * @param options Optionally provide the list of resources you want to load at constructor time\r\n   */\r\n  constructor(options?: DefaultLoaderOptions) {\r\n    if (options && options.loadables?.length) {\r\n      this.addResources(options.loadables);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Called by the engine before loading\r\n   * @param engine\r\n   */\r\n  public onInitialize(engine: Engine) {\r\n    this.engine = engine;\r\n    this.canvas.width = this.engine.screen.resolution.width;\r\n    this.canvas.height = this.engine.screen.resolution.height;\r\n  }\r\n\r\n  /**\r\n   * Return a promise that resolves when the user interacts with the loading screen in some way, usually a click.\r\n   *\r\n   * It's important to implement this in order to unlock the audio context in the browser. Browsers automatically prevent\r\n   * audio from playing until the user performs an action.\r\n   *\r\n   */\r\n  public async onUserAction(): Promise<void> {\r\n    return await Promise.resolve();\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called directly before loading starts\r\n   */\r\n  public async onBeforeLoad() {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called after loading has completed\r\n   */\r\n  public async onAfterLoad() {\r\n    // override me\r\n    await delay(500, this.engine.clock); // avoid a flicker\r\n  }\r\n\r\n  /**\r\n   * Add a resource to the loader to load\r\n   * @param loadable  Resource to add\r\n   */\r\n  public addResource(loadable: Loadable<any>) {\r\n    this._resources.push(loadable);\r\n  }\r\n\r\n  /**\r\n   * Add a list of resources to the loader to load\r\n   * @param loadables  The list of resources to load\r\n   */\r\n  public addResources(loadables: Loadable<any>[]) {\r\n    let i = 0;\r\n    const len = loadables.length;\r\n\r\n    for (i; i < len; i++) {\r\n      this.addResource(loadables[i]);\r\n    }\r\n  }\r\n\r\n  public markResourceComplete(): void {\r\n    this._numLoaded++;\r\n  }\r\n\r\n  /**\r\n   * Returns the progress of the loader as a number between [0, 1] inclusive.\r\n   */\r\n  public get progress(): number {\r\n    const total = this._resources.length;\r\n    return total > 0 ? clamp(this._numLoaded, 0, total) / total : 1;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the loader has completely loaded all resources\r\n   */\r\n  public isLoaded() {\r\n    return this._numLoaded === this._resources.length;\r\n  }\r\n\r\n  private _totalTimeMs = 0;\r\n\r\n  /**\r\n   * Optionally override the onUpdate\r\n   * @param engine\r\n   * @param elapsed\r\n   */\r\n  onUpdate(engine: Engine, elapsed: number): void {\r\n    this._totalTimeMs += elapsed;\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Optionally override the onDraw\r\n   */\r\n  onDraw(ctx: CanvasRenderingContext2D) {\r\n    const seconds = this._totalTimeMs / 1000;\r\n\r\n    ctx.fillStyle = Color.Black.toRGBA();\r\n    ctx.fillRect(0, 0, this.engine.screen.resolution.width, this.engine.screen.resolution.height);\r\n\r\n    ctx.save();\r\n    ctx.translate(this.engine.screen.resolution.width / 2, this.engine.screen.resolution.height / 2);\r\n    const speed = seconds * 10;\r\n    ctx.strokeStyle = 'white';\r\n    ctx.lineWidth = 10;\r\n    ctx.lineCap = 'round';\r\n    ctx.arc(0, 0, 40, speed, speed + (Math.PI * 3) / 2);\r\n    ctx.stroke();\r\n\r\n    ctx.fillStyle = 'white';\r\n    ctx.font = '16px sans-serif';\r\n    const text = (this.progress * 100).toFixed(0) + '%';\r\n    const textbox = ctx.measureText(text);\r\n    const width = Math.abs(textbox.actualBoundingBoxLeft) + Math.abs(textbox.actualBoundingBoxRight);\r\n    const height = Math.abs(textbox.actualBoundingBoxAscent) + Math.abs(textbox.actualBoundingBoxDescent);\r\n    ctx.fillText(text, -width / 2, height / 2); // center\r\n    ctx.restore();\r\n  }\r\n\r\n  private _loadingFuture = new Future<void>();\r\n  public areResourcesLoaded() {\r\n    if (this._resources.length === 0) {\r\n      // special case no resources mean loaded;\r\n      return Promise.resolve();\r\n    }\r\n    return this._loadingFuture.promise;\r\n  }\r\n\r\n  /**\r\n   * Not meant to be overridden\r\n   *\r\n   * Begin loading all of the supplied resources, returning a promise\r\n   * that resolves when loading of all is complete AND the user has interacted with the loading screen\r\n   */\r\n  public async load(): Promise<Loadable<any>[]> {\r\n    await this.onBeforeLoad();\r\n    this.events.emit('beforeload');\r\n    this.canvas.flagDirty();\r\n\r\n    await Promise.all(\r\n      this._resources.map(async (r) => {\r\n        this.events.emit('loadresourcestart', r);\r\n        await r.load().finally(() => {\r\n          // capture progress\r\n          this._numLoaded++;\r\n          this.canvas.flagDirty();\r\n          this.events.emit('loadresourceend', r);\r\n        });\r\n      })\r\n    );\r\n\r\n    // Wire all sound to the engine\r\n    for (const resource of this._resources) {\r\n      if (resource instanceof Sound) {\r\n        resource.wireEngine(this.engine);\r\n      }\r\n    }\r\n\r\n    this._loadingFuture.resolve();\r\n    this.canvas.flagDirty();\r\n    // Unlock browser AudioContext in after user gesture\r\n    // See: https://github.com/excaliburjs/Excalibur/issues/262\r\n    // See: https://github.com/excaliburjs/Excalibur/issues/1031\r\n    await this.onUserAction();\r\n    this.events.emit('useraction');\r\n    await WebAudio.unlock();\r\n\r\n    await this.onAfterLoad();\r\n    this.events.emit('afterload');\r\n    return (this.data = this._resources);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, event: LoaderEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, handler: Handler<LoaderEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, handler: Handler<LoaderEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<LoaderEvents>>(eventName: TEventName, handler: Handler<LoaderEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<LoaderEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    (this.events as any).off(eventName, handler);\r\n  }\r\n}\r\n","import { Color } from '../Color';\r\nimport { Loadable } from '../Interfaces/Loadable';\r\nimport * as DrawUtil from '../Util/DrawUtil';\r\n\r\nimport logoImg from './Loader.logo.png';\r\nimport loaderCss from './Loader.css';\r\nimport { Vector } from '../Math/vector';\r\nimport { delay } from '../Util/Util';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { DefaultLoader, DefaultLoaderOptions } from './DefaultLoader';\r\nimport { Engine } from '../Engine';\r\nimport { Screen } from '../Screen';\r\nimport { Logger } from '../Util/Log';\r\nimport { Future } from '../Util/Future';\r\n\r\nexport interface LoaderOptions extends DefaultLoaderOptions {\r\n  /**\r\n   * Go fullscreen after loading and clicking play\r\n   */\r\n  fullscreenAfterLoad?: boolean;\r\n  /**\r\n   * Fullscreen container element or id\r\n   */\r\n  fullscreenContainer?: HTMLElement | string;\r\n}\r\n\r\n/**\r\n * Pre-loading assets\r\n *\r\n * The loader provides a mechanism to preload multiple resources at\r\n * one time. The loader must be passed to the engine in order to\r\n * trigger the loading progress bar.\r\n *\r\n * The {@apilink Loader} itself implements {@apilink Loadable} so you can load loaders.\r\n *\r\n * ## Example: Pre-loading resources for a game\r\n *\r\n * ```js\r\n * // create a loader\r\n * var loader = new ex.Loader();\r\n *\r\n * // create a resource dictionary (best practice is to keep a separate file)\r\n * var resources = {\r\n *   TextureGround: new ex.Texture(\"/images/textures/ground.png\"),\r\n *   SoundDeath: new ex.Sound(\"/sound/death.wav\", \"/sound/death.mp3\")\r\n * };\r\n *\r\n * // loop through dictionary and add to loader\r\n * for (var loadable in resources) {\r\n *   if (resources.hasOwnProperty(loadable)) {\r\n *     loader.addResource(resources[loadable]);\r\n *   }\r\n * }\r\n *\r\n * // start game\r\n * game.start(loader).then(function () {\r\n *   console.log(\"Game started!\");\r\n * });\r\n * ```\r\n *\r\n * ## Customize the Loader\r\n *\r\n * The loader can be customized to show different, text, logo, background color, and button.\r\n *\r\n * ```typescript\r\n * const loader = new ex.Loader([playerTexture]);\r\n *\r\n * // The loaders button text can simply modified using this\r\n * loader.playButtonText = 'Start the best game ever';\r\n *\r\n * // The logo can be changed by inserting a base64 image string here\r\n *\r\n * loader.logo = 'data:image/png;base64,iVBORw...';\r\n * loader.logoWidth = 15;\r\n * loader.logoHeight = 14;\r\n *\r\n * // The background color can be changed like so by supplying a valid CSS color string\r\n *\r\n * loader.backgroundColor = 'red'\r\n * loader.backgroundColor = '#176BAA'\r\n *\r\n * // To build a completely new button\r\n * loader.startButtonFactory = () => {\r\n *     let myButton = document.createElement('button');\r\n *     myButton.textContent = 'The best button';\r\n *     return myButton;\r\n * };\r\n *\r\n * engine.start(loader).then(() => {});\r\n * ```\r\n */\r\nexport class Loader extends DefaultLoader {\r\n  private _logger = Logger.getInstance();\r\n  private static _DEFAULT_LOADER_OPTIONS: LoaderOptions = {\r\n    loadables: [],\r\n    fullscreenAfterLoad: false,\r\n    fullscreenContainer: undefined\r\n  };\r\n  private _originalOptions: LoaderOptions = { loadables: [] };\r\n  public events = new EventEmitter();\r\n  public screen!: Screen;\r\n  private _playButtonShown: boolean = false;\r\n\r\n  // logo drawing stuff\r\n\r\n  // base64 string encoding of the excalibur logo (logo-white.png)\r\n  public logo = logoImg;\r\n  public logoWidth = 468;\r\n  public logoHeight = 118;\r\n  /**\r\n   * Positions the top left corner of the logo image\r\n   * If not set, the loader automatically positions the logo\r\n   */\r\n  public logoPosition!: Vector | null;\r\n  /**\r\n   * Positions the top left corner of the play button.\r\n   * If not set, the loader automatically positions the play button\r\n   */\r\n  public playButtonPosition!: Vector | null;\r\n  /**\r\n   * Positions the top left corner of the loading bar\r\n   * If not set, the loader automatically positions the loading bar\r\n   */\r\n  public loadingBarPosition!: Vector | null;\r\n\r\n  /**\r\n   * Gets or sets the color of the loading bar, default is {@apilink Color.White}\r\n   */\r\n  public loadingBarColor: Color = Color.White;\r\n\r\n  /**\r\n   * Gets or sets the background color of the loader as a hex string\r\n   */\r\n  public backgroundColor: string = '#176BAA';\r\n\r\n  protected _imageElement!: HTMLImageElement;\r\n  protected _imageLoaded: Future<void> = new Future();\r\n  protected get _image() {\r\n    if (!this._imageElement) {\r\n      this._imageElement = new Image();\r\n      this._imageElement.onload = () => this._imageLoaded.resolve();\r\n      this._imageElement.src = this.logo;\r\n    }\r\n\r\n    return this._imageElement;\r\n  }\r\n\r\n  public suppressPlayButton: boolean = false;\r\n  public get playButtonRootElement(): HTMLElement | null {\r\n    return this._playButtonRootElement;\r\n  }\r\n  public get playButtonElement(): HTMLButtonElement | null {\r\n    return this._playButtonElement;\r\n  }\r\n  protected _playButtonRootElement!: HTMLElement;\r\n  protected _playButtonElement!: HTMLButtonElement;\r\n  protected _styleBlock!: HTMLStyleElement;\r\n  /** Loads the css from Loader.css */\r\n  protected _playButtonStyles: string = loaderCss.toString();\r\n  protected get _playButton() {\r\n    const existingRoot = document.getElementById('excalibur-play-root');\r\n    if (existingRoot) {\r\n      this._playButtonRootElement = existingRoot;\r\n    }\r\n    if (!this._playButtonRootElement) {\r\n      this._playButtonRootElement = document.createElement('div');\r\n      this._playButtonRootElement.id = 'excalibur-play-root';\r\n      this._playButtonRootElement.style.position = 'absolute';\r\n      document.body.appendChild(this._playButtonRootElement);\r\n    }\r\n    if (!this._styleBlock) {\r\n      this._styleBlock = document.createElement('style');\r\n      this._styleBlock.textContent = this._playButtonStyles;\r\n      document.head.appendChild(this._styleBlock);\r\n    }\r\n    if (!this._playButtonElement) {\r\n      this._playButtonElement = this.startButtonFactory();\r\n      this._playButtonRootElement.appendChild(this._playButtonElement);\r\n    }\r\n    return this._playButtonElement;\r\n  }\r\n\r\n  /**\r\n   * Get/set play button text\r\n   */\r\n  public playButtonText: string = 'Play game';\r\n\r\n  /**\r\n   * Return a html button element for excalibur to use as a play button\r\n   */\r\n  public startButtonFactory = () => {\r\n    let buttonElement: HTMLButtonElement = document.getElementById('excalibur-play') as HTMLButtonElement;\r\n    if (!buttonElement) {\r\n      buttonElement = document.createElement('button');\r\n    }\r\n\r\n    buttonElement.id = 'excalibur-play';\r\n    buttonElement.textContent = this.playButtonText;\r\n    buttonElement.style.display = 'none';\r\n    return buttonElement;\r\n  };\r\n\r\n  /**\r\n   * @param options Optionally provide options to loader\r\n   */\r\n  constructor(options?: LoaderOptions);\r\n  /**\r\n   * @param loadables  Optionally provide the list of resources you want to load at constructor time\r\n   */\r\n  constructor(loadables?: Loadable<any>[]);\r\n  constructor(loadablesOrOptions?: Loadable<any>[] | LoaderOptions) {\r\n    const options = Array.isArray(loadablesOrOptions)\r\n      ? {\r\n          loadables: loadablesOrOptions\r\n        }\r\n      : loadablesOrOptions;\r\n    super(options);\r\n    this._originalOptions = { ...Loader._DEFAULT_LOADER_OPTIONS, ...options };\r\n  }\r\n\r\n  public override onInitialize(engine: Engine): void {\r\n    this.engine = engine;\r\n    this.screen = engine.screen;\r\n    this.canvas.width = this.engine.canvas.width;\r\n    this.canvas.height = this.engine.canvas.height;\r\n    this.screen.events.on('resize', () => {\r\n      this.canvas.width = this.engine.canvas.width;\r\n      this.canvas.height = this.engine.canvas.height;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Shows the play button and returns a promise that resolves when clicked\r\n   */\r\n  public async showPlayButton(): Promise<void> {\r\n    if (this.suppressPlayButton) {\r\n      this.hidePlayButton();\r\n      // Delay is to give the logo a chance to show, otherwise don't delay\r\n      await delay(500, this.engine?.clock);\r\n    } else {\r\n      const resizeHandler = () => {\r\n        try {\r\n          this._positionPlayButton();\r\n        } catch {\r\n          // swallow if can't position\r\n        }\r\n      };\r\n      if (this.engine?.browser) {\r\n        this.engine.browser.window.on('resize', resizeHandler);\r\n      }\r\n      this._playButtonShown = true;\r\n      this._playButton.style.display = 'block';\r\n      document.body.addEventListener('keyup', (evt: KeyboardEvent) => {\r\n        if (evt.key === 'Enter') {\r\n          this._playButton.click();\r\n        }\r\n      });\r\n      this._positionPlayButton();\r\n      const playButtonClicked = new Promise<void>((resolve) => {\r\n        const startButtonHandler = (e: Event) => {\r\n          // We want to stop propagation to keep bubbling to the engine pointer handlers\r\n          e.stopPropagation();\r\n          // Hide Button after click\r\n          this.hidePlayButton();\r\n          if (this.engine?.browser) {\r\n            this.engine.browser.window.off('resize', resizeHandler);\r\n          }\r\n\r\n          if (this._originalOptions.fullscreenAfterLoad) {\r\n            try {\r\n              this._logger.info('requesting fullscreen');\r\n              if (this._originalOptions.fullscreenContainer instanceof HTMLElement) {\r\n                this._originalOptions.fullscreenContainer.requestFullscreen();\r\n              } else {\r\n                this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer);\r\n              }\r\n            } catch (error) {\r\n              this._logger.error('could not go fullscreen', error);\r\n            }\r\n          }\r\n\r\n          resolve();\r\n        };\r\n        this._playButton.addEventListener('click', startButtonHandler);\r\n        this._playButton.addEventListener('touchend', startButtonHandler);\r\n        this._playButton.addEventListener('pointerup', startButtonHandler);\r\n        if (this.engine) {\r\n          this.engine.input.gamepads.once('button', () => startButtonHandler(new Event('button')));\r\n        }\r\n      });\r\n\r\n      return await playButtonClicked;\r\n    }\r\n  }\r\n\r\n  public hidePlayButton() {\r\n    this._playButtonShown = false;\r\n    this._playButton.style.display = 'none';\r\n  }\r\n\r\n  /**\r\n   * Clean up generated elements for the loader\r\n   */\r\n  public dispose() {\r\n    if (this._playButtonRootElement.parentElement) {\r\n      this._playButtonRootElement.removeChild(this._playButtonElement);\r\n      document.body.removeChild(this._playButtonRootElement);\r\n      document.head.removeChild(this._styleBlock);\r\n      this._playButtonRootElement = null as any;\r\n      this._playButtonElement = null as any;\r\n      this._styleBlock = null as any;\r\n    }\r\n  }\r\n\r\n  data!: Loadable<any>[];\r\n\r\n  public override async onUserAction(): Promise<void> {\r\n    // short delay in showing the button for aesthetics\r\n    await delay(200, this.engine?.clock);\r\n    this.canvas.flagDirty();\r\n    // show play button\r\n    await this.showPlayButton();\r\n  }\r\n\r\n  public override async onBeforeLoad(): Promise<void> {\r\n    this.screen.pushResolutionAndViewport();\r\n    this.screen.resolution = { width: this.canvas.width, height: this.canvas.height };\r\n    this.screen.applyResolutionAndViewport();\r\n    const image = this._image;\r\n    await this._imageLoaded.promise;\r\n    await image?.decode(); // decode logo if it exists\r\n  }\r\n\r\n  // eslint-disable-next-line require-await\r\n  public override async onAfterLoad(): Promise<void> {\r\n    this.screen.popResolutionAndViewport();\r\n    this.screen.applyResolutionAndViewport();\r\n    this.dispose();\r\n  }\r\n\r\n  private _positionPlayButton() {\r\n    if (this.engine) {\r\n      const { x: left, y: top, width: screenWidth, height: screenHeight } = this.engine.canvas.getBoundingClientRect();\r\n      if (this._playButtonRootElement) {\r\n        const buttonWidth = this._playButton.clientWidth;\r\n        const buttonHeight = this._playButton.clientHeight;\r\n        if (this.playButtonPosition) {\r\n          this._playButtonRootElement.style.left = `${this.playButtonPosition.x}px`;\r\n          this._playButtonRootElement.style.top = `${this.playButtonPosition.y}px`;\r\n        } else {\r\n          this._playButtonRootElement.style.left = `${left + screenWidth / 2 - buttonWidth / 2}px`;\r\n          this._playButtonRootElement.style.top = `${top + screenHeight / 2 - buttonHeight / 2 + 100}px`;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Loader draw function. Draws the default Excalibur loading screen.\r\n   * Override `logo`, `logoWidth`, `logoHeight` and `backgroundColor` properties\r\n   * to customize the drawing, or just override entire method.\r\n   */\r\n  public override onDraw(ctx: CanvasRenderingContext2D) {\r\n    const canvasHeight = this.engine.canvasHeight / this.engine.pixelRatio;\r\n    const canvasWidth = this.engine.canvasWidth / this.engine.pixelRatio;\r\n\r\n    this._positionPlayButton();\r\n\r\n    ctx.fillStyle = this.backgroundColor;\r\n    ctx.fillRect(0, 0, canvasWidth, canvasHeight);\r\n\r\n    let logoY = canvasHeight / 2;\r\n    const width = Math.min(this.logoWidth, canvasWidth * 0.75);\r\n    let logoX = canvasWidth / 2 - width / 2;\r\n\r\n    if (this.logoPosition) {\r\n      logoX = this.logoPosition.x;\r\n      logoY = this.logoPosition.y;\r\n    }\r\n\r\n    const imageHeight = Math.floor(width * (this.logoHeight / this.logoWidth)); // OG height/width factor\r\n    const oldAntialias = this.engine.screen.antialiasing;\r\n    this.engine.screen.antialiasing = true;\r\n    if (!this.logoPosition) {\r\n      ctx.drawImage(this._image, 0, 0, this.logoWidth, this.logoHeight, logoX, logoY - imageHeight - 20, width, imageHeight);\r\n    } else {\r\n      ctx.drawImage(this._image, 0, 0, this.logoWidth, this.logoHeight, logoX, logoY, width, imageHeight);\r\n    }\r\n\r\n    // loading box\r\n    if (!this.suppressPlayButton && this._playButtonShown) {\r\n      this.engine.screen.antialiasing = oldAntialias;\r\n      return;\r\n    }\r\n\r\n    let loadingX = logoX;\r\n    let loadingY = logoY;\r\n    if (this.loadingBarPosition) {\r\n      loadingX = this.loadingBarPosition.x;\r\n      loadingY = this.loadingBarPosition.y;\r\n    }\r\n\r\n    ctx.lineWidth = 2;\r\n    DrawUtil.roundRect(ctx, loadingX, loadingY, width, 20, 10, this.loadingBarColor);\r\n    const progress = width * this.progress;\r\n    const margin = 5;\r\n    const progressWidth = progress - margin * 2;\r\n    const height = 20 - margin * 2;\r\n    DrawUtil.roundRect(\r\n      ctx,\r\n      loadingX + margin,\r\n      loadingY + margin,\r\n      progressWidth > 10 ? progressWidth : 10,\r\n      height,\r\n      5,\r\n      null,\r\n      this.loadingBarColor\r\n    );\r\n    this.engine.screen.antialiasing = oldAntialias;\r\n  }\r\n}\r\n","export default \"data:image/png;base64,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\"","import { Logger } from './Log';\r\n/**\r\n * This is the list of features that will be used to log the supported\r\n * features to the console when Detector.logBrowserFeatures() is called.\r\n */\r\n\r\nconst REPORTED_FEATURES: { [key: string]: string } = {\r\n  webgl: 'WebGL',\r\n  webaudio: 'WebAudio',\r\n  gamepadapi: 'Gamepad API'\r\n};\r\n\r\n/**\r\n * Interface for detected browser features matrix\r\n */\r\nexport interface DetectedFeatures {\r\n  readonly canvas: boolean;\r\n  readonly arraybuffer: boolean;\r\n  readonly dataurl: boolean;\r\n  readonly objecturl: boolean;\r\n  readonly rgba: boolean;\r\n  readonly webaudio: boolean;\r\n  readonly webgl: boolean;\r\n  readonly gamepadapi: boolean;\r\n}\r\n\r\ninterface CriticalTests {\r\n  canvasSupport(): boolean;\r\n  arrayBufferSupport(): boolean;\r\n  dataUrlSupport(): boolean;\r\n  objectUrlSupport(): boolean;\r\n  rgbaSupport(): boolean;\r\n}\r\n\r\ninterface WarningTests {\r\n  webAudioSupport(): boolean;\r\n  webglSupport(): boolean;\r\n}\r\n\r\n/**\r\n * Excalibur internal feature detection helper class\r\n */\r\nexport class Detector {\r\n  private _features: DetectedFeatures = null;\r\n\r\n  public failedTests: string[] = [];\r\n\r\n  public constructor() {\r\n    this._features = this._loadBrowserFeatures();\r\n  }\r\n\r\n  /**\r\n   * Returns a map of currently supported browser features. This method\r\n   * treats the features as a singleton and will only calculate feature\r\n   * support if it has not previously been done.\r\n   */\r\n  public getBrowserFeatures(): DetectedFeatures {\r\n    if (this._features === null) {\r\n      this._features = this._loadBrowserFeatures();\r\n    }\r\n    return this._features;\r\n  }\r\n\r\n  /**\r\n   * Report on non-critical browser support for debugging purposes.\r\n   * Use native browser console colors for visibility.\r\n   */\r\n  public logBrowserFeatures(): void {\r\n    let msg = '%cSUPPORTED BROWSER FEATURES\\n==========================%c\\n';\r\n    const args = ['font-weight: bold; color: navy', 'font-weight: normal; color: inherit'];\r\n\r\n    const supported: any = this.getBrowserFeatures();\r\n    for (const feature of Object.keys(REPORTED_FEATURES)) {\r\n      if (supported[feature]) {\r\n        msg += '(%c\\u2713%c)'; // (✓)\r\n        args.push('font-weight: bold; color: green');\r\n        args.push('font-weight: normal; color: inherit');\r\n      } else {\r\n        msg += '(%c\\u2717%c)'; // (✗)\r\n        args.push('font-weight: bold; color: red');\r\n        args.push('font-weight: normal; color: inherit');\r\n      }\r\n\r\n      msg += ' ' + REPORTED_FEATURES[feature] + '\\n';\r\n    }\r\n\r\n    args.unshift(msg);\r\n    // eslint-disable-next-line no-console\r\n    console.log.apply(console, args);\r\n  }\r\n\r\n  /**\r\n   * Executes several IIFE's to get a constant reference to supported\r\n   * features within the current execution context.\r\n   */\r\n  private _loadBrowserFeatures(): DetectedFeatures {\r\n    return {\r\n      // IIFE to check canvas support\r\n      canvas: (() => {\r\n        return this._criticalTests.canvasSupport();\r\n      })(),\r\n\r\n      // IIFE to check arraybuffer support\r\n      arraybuffer: (() => {\r\n        return this._criticalTests.arrayBufferSupport();\r\n      })(),\r\n\r\n      // IIFE to check dataurl support\r\n      dataurl: (() => {\r\n        return this._criticalTests.dataUrlSupport();\r\n      })(),\r\n\r\n      // IIFE to check objecturl support\r\n      objecturl: (() => {\r\n        return this._criticalTests.objectUrlSupport();\r\n      })(),\r\n\r\n      // IIFE to check rgba support\r\n      rgba: (() => {\r\n        return this._criticalTests.rgbaSupport();\r\n      })(),\r\n\r\n      // IIFE to check webaudio support\r\n      webaudio: (() => {\r\n        return this._warningTest.webAudioSupport();\r\n      })(),\r\n\r\n      // IIFE to check webgl support\r\n      webgl: (() => {\r\n        return this._warningTest.webglSupport();\r\n      })(),\r\n\r\n      // IIFE to check gamepadapi support\r\n      gamepadapi: (() => {\r\n        return !!(<any>navigator).getGamepads;\r\n      })()\r\n    };\r\n  }\r\n\r\n  // critical browser features required for ex to run\r\n  private _criticalTests: CriticalTests = {\r\n    // Test canvas/2d context support\r\n    canvasSupport: function () {\r\n      const elem = document.createElement('canvas');\r\n      return !!(elem.getContext && elem.getContext('2d'));\r\n    },\r\n\r\n    // Test array buffer support ex uses for downloading binary data\r\n    arrayBufferSupport: function () {\r\n      const xhr = new XMLHttpRequest();\r\n      xhr.open('GET', '/');\r\n      try {\r\n        xhr.responseType = 'arraybuffer';\r\n      } catch (e) {\r\n        return false;\r\n      }\r\n      return xhr.responseType === 'arraybuffer';\r\n    },\r\n\r\n    // Test data urls ex uses for sprites\r\n    dataUrlSupport: function () {\r\n      const canvas = document.createElement('canvas');\r\n      return canvas.toDataURL('image/png').indexOf('data:image/png') === 0;\r\n    },\r\n\r\n    // Test object url support for loading\r\n    objectUrlSupport: function () {\r\n      return 'URL' in window && 'revokeObjectURL' in URL && 'createObjectURL' in URL;\r\n    },\r\n\r\n    // RGBA support for colors\r\n    rgbaSupport: function () {\r\n      const style = document.createElement('a').style;\r\n      style.cssText = 'background-color:rgba(150,255,150,.5)';\r\n      return ('' + style.backgroundColor).indexOf('rgba') > -1;\r\n    }\r\n  };\r\n\r\n  // warnings excalibur performance will be degraded\r\n  private _warningTest: WarningTests = {\r\n    webAudioSupport: function () {\r\n      return !!(\r\n        (<any>window).AudioContext ||\r\n        (<any>window).webkitAudioContext ||\r\n        (<any>window).mozAudioContext ||\r\n        (<any>window).msAudioContext ||\r\n        (<any>window).oAudioContext\r\n      );\r\n    },\r\n    webglSupport: function () {\r\n      const elem = document.createElement('canvas');\r\n      return !!(elem.getContext && elem.getContext('webgl'));\r\n    }\r\n  };\r\n\r\n  public test(): boolean {\r\n    // Critical test will for ex not to run\r\n    let failedCritical = false;\r\n    for (const test in this._criticalTests) {\r\n      if (!this._criticalTests[<keyof CriticalTests>test].call(this)) {\r\n        this.failedTests.push(test);\r\n        Logger.getInstance().error('Critical browser feature missing, Excalibur requires:', test);\r\n        failedCritical = true;\r\n      }\r\n    }\r\n    if (failedCritical) {\r\n      return false;\r\n    }\r\n\r\n    // Warning tests do not for ex to return false to compatibility\r\n    for (const warning in this._warningTest) {\r\n      if (!this._warningTest[<keyof WarningTests>warning]()) {\r\n        Logger.getInstance().warn('Warning browser feature missing, Excalibur will have reduced performance:', warning);\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","/**\n * An enum that describes the types of collisions bodies can participate in\n */\nexport enum CollisionType {\n  /**\n   * Bodies with the `PreventCollision` setting do not participate in any\n   * collisions and do not raise collision events.\n   */\n  PreventCollision = 'PreventCollision',\n  /**\n   * Bodies with the `Passive` setting only raise collision events, but are not\n   * influenced or moved by other bodies and do not influence or move other bodies.\n   * This is useful for use in trigger type behavior.\n   */\n  Passive = 'Passive',\n  /**\n   * Bodies with the `Active` setting raise collision events and participate\n   * in collisions with other bodies and will be push or moved by bodies sharing\n   * the `Active` or `Fixed` setting.\n   */\n  Active = 'Active',\n  /**\n   * Bodies with the `Fixed` setting raise collision events and participate in\n   * collisions with other bodies. Actors with the `Fixed` setting will not be\n   * pushed or moved by other bodies sharing the `Fixed`. Think of Fixed\n   * bodies as \"immovable/unstoppable\" objects. If two `Fixed` bodies meet they will\n   * not be pushed or moved by each other, they will not interact except to throw\n   * collision events.\n   */\n  Fixed = 'Fixed'\n}\n","/**\r\n * Possible collision resolution strategies\r\n *\r\n * The default is {@apilink SolverStrategy.Arcade} which performs simple axis aligned arcade style physics. This is useful for things\r\n * like platformers or top down games.\r\n *\r\n * More advanced rigid body physics are enabled by setting {@apilink SolverStrategy.Realistic} which allows for complicated\r\n * simulated physical interactions.\r\n */\r\nexport enum SolverStrategy {\r\n  Arcade = 'arcade',\r\n  Realistic = 'realistic'\r\n}\r\n","/**\r\n * Tells the Arcade collision solver to prefer certain contacts over others\r\n */\r\nexport enum ContactSolveBias {\r\n  None = 'none',\r\n  VerticalFirst = 'vertical-first',\r\n  HorizontalFirst = 'horizontal-first'\r\n}\r\n\r\n/**\r\n * Contact bias values\r\n */\r\nexport interface ContactBias {\r\n  vertical: number;\r\n  horizontal: number;\r\n}\r\n\r\n/**\r\n * Vertical First contact solve bias Used by the {@apilink ArcadeSolver} to sort contacts\r\n */\r\nexport const VerticalFirst: ContactBias = {\r\n  vertical: 1,\r\n  horizontal: 2\r\n} as const;\r\n\r\n/**\r\n * Horizontal First contact solve bias Used by the {@apilink ArcadeSolver} to sort contacts\r\n */\r\nexport const HorizontalFirst: ContactBias = {\r\n  horizontal: 1,\r\n  vertical: 2\r\n} as const;\r\n\r\n/**\r\n * None value, {@apilink ArcadeSolver} sorts contacts using distance by default\r\n */\r\nexport const None: ContactBias = {\r\n  horizontal: 0,\r\n  vertical: 0\r\n} as const;\r\n","import { CollisionGroup } from './CollisionGroup';\n\n/**\n * Static class for managing collision groups in excalibur, there is a maximum of 32 collision groups possible in excalibur\n */\nexport class CollisionGroupManager {\n  // using bitmasking the maximum number of groups is 32, because that is the highest 32bit integer that JS can present.\n  private static _STARTING_BIT = 0b1 | 0;\n  private static _MAX_GROUPS = 32;\n  private static _CURRENT_GROUP = 1;\n  private static _CURRENT_BIT = CollisionGroupManager._STARTING_BIT;\n  private static _GROUPS: Map<string, CollisionGroup> = new Map<string, CollisionGroup>();\n\n  /**\n   * Create a new named collision group up to a max of 32.\n   * @param name Name for the collision group\n   * @param mask Optionally provide your own 32-bit mask, if none is provide the manager will generate one\n   */\n  public static create(name: string, mask?: number) {\n    if (this._CURRENT_GROUP > this._MAX_GROUPS) {\n      throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);\n    }\n    if (this._GROUPS.get(name)) {\n      const existingGroup = this._GROUPS.get(name);\n      if (existingGroup.mask === mask) {\n        return existingGroup;\n      }\n      throw new Error(`Collision group ${name} already exists with a different mask!`);\n    }\n    const group = new CollisionGroup(name, this._CURRENT_BIT, mask !== undefined ? mask : ~this._CURRENT_BIT);\n    this._CURRENT_BIT = (this._CURRENT_BIT << 1) | 0;\n    this._CURRENT_GROUP++;\n    this._GROUPS.set(name, group);\n    return group;\n  }\n\n  /**\n   * Get all collision groups currently tracked by excalibur\n   */\n  public static get groups(): CollisionGroup[] {\n    return Array.from(this._GROUPS.values());\n  }\n\n  /**\n   * Get a collision group by it's name\n   * @param name\n   */\n  public static groupByName(name: string) {\n    return this._GROUPS.get(name);\n  }\n\n  /**\n   * Resets the managers internal group management state\n   */\n  public static reset() {\n    this._GROUPS = new Map<string, CollisionGroup>();\n    this._CURRENT_BIT = this._STARTING_BIT;\n    this._CURRENT_GROUP = 1;\n  }\n}\n","import { CollisionGroupManager } from './CollisionGroupManager';\r\n\r\n/**\r\n * CollisionGroups indicate like members that do not collide with each other. Use {@apilink CollisionGroupManager} to create {@apilink CollisionGroup}s\r\n *\r\n * For example:\r\n *\r\n * Players have collision group \"player\"\r\n *\r\n * ![Player Collision Group](/assets/images/docs/CollisionGroupsPlayer.png)\r\n *\r\n * Enemies have collision group \"enemy\"\r\n *\r\n * ![Enemy Collision Group](/assets/images/docs/CollisionGroupsEnemy.png)\r\n *\r\n * Blocks have collision group \"ground\"\r\n *\r\n * ![Ground collision group](/assets/images/docs/CollisionGroupsGround.png)\r\n *\r\n * Players don't collide with each other, but enemies and blocks. Likewise, enemies don't collide with each other but collide\r\n * with players and blocks.\r\n *\r\n * This is done with bitmasking, see the following pseudo-code\r\n *\r\n * PlayerGroup = `0b001`\r\n * PlayerGroupMask = `0b110`\r\n *\r\n * EnemyGroup = `0b010`\r\n * EnemyGroupMask = `0b101`\r\n *\r\n * BlockGroup = `0b100`\r\n * BlockGroupMask = `0b011`\r\n *\r\n * Should Players collide? No because the bitwise mask evaluates to 0\r\n * `(player1.group & player2.mask) === 0`\r\n * `(0b001 & 0b110) === 0`\r\n *\r\n * Should Players and Enemies collide? Yes because the bitwise mask is non-zero\r\n * `(player1.group & enemy1.mask) === 1`\r\n * `(0b001 & 0b101) === 1`\r\n *\r\n * Should Players and Blocks collide? Yes because the bitwise mask is non-zero\r\n * `(player1.group & blocks1.mask) === 1`\r\n * `(0b001 & 0b011) === 1`\r\n */\r\nexport class CollisionGroup {\r\n  /**\r\n   * The `All` {@apilink CollisionGroup} is a special group that collides with all other groups including itself,\r\n   * it is the default collision group on colliders.\r\n   */\r\n  public static All = new CollisionGroup('Collide with all groups', -1, -1);\r\n\r\n  private _name: string;\r\n  private _category: number;\r\n  private _mask: number;\r\n\r\n  /**\r\n   * STOP!!** It is preferred that {@apilink CollisionGroupManager.create} is used to create collision groups\r\n   *  unless you know how to construct the proper bitmasks. See https://github.com/excaliburjs/Excalibur/issues/1091 for more info.\r\n   * @param name Name of the collision group\r\n   * @param category 32 bit category for the group, should be a unique power of 2. For example `0b001` or `0b010`\r\n   * @param mask 32 bit mask of category, or `~category` generally. For a category of `0b001`, the mask would be `0b110`\r\n   */\r\n  constructor(name: string, category: number, mask: number) {\r\n    this._name = name;\r\n    this._category = category;\r\n    this._mask = mask;\r\n  }\r\n\r\n  /**\r\n   * Get the name of the collision group\r\n   */\r\n  public get name() {\r\n    return this._name;\r\n  }\r\n\r\n  /**\r\n   * Get the category of the collision group, a 32 bit number which should be a unique power of 2\r\n   */\r\n  public get category() {\r\n    return this._category;\r\n  }\r\n\r\n  /**\r\n   * Get the mask for this collision group\r\n   */\r\n  public get mask() {\r\n    return this._mask;\r\n  }\r\n\r\n  /**\r\n   * Evaluates whether 2 collision groups can collide\r\n   *\r\n   * This means the mask has the same bit set the other category and vice versa\r\n   * @param other  CollisionGroup\r\n   */\r\n  public canCollide(other: CollisionGroup): boolean {\r\n    const overlap1 = this.category & other.mask;\r\n    const overlap2 = this.mask & other.category;\r\n    return overlap1 !== 0 && overlap2 !== 0;\r\n  }\r\n\r\n  /**\r\n   * Inverts the collision group. For example, if before the group specified \"players\",\r\n   * inverting would specify all groups except players\r\n   * @returns CollisionGroup\r\n   */\r\n  public invert(): CollisionGroup {\r\n    const group = CollisionGroupManager.create('~(' + this.name + ')', ~this.mask | 0);\r\n    group._category = ~this.category;\r\n    return group;\r\n  }\r\n\r\n  /**\r\n   * Combine collision groups with each other. The new group includes all of the previous groups.\r\n   * @param collisionGroups\r\n   */\r\n  public static combine(collisionGroups: CollisionGroup[]) {\r\n    const combinedName = collisionGroups.map((c) => c.name).join('+');\r\n    const combinedCategory = collisionGroups.reduce((current, g) => g.category | current, 0b0);\r\n    const combinedMask = ~combinedCategory;\r\n\r\n    return CollisionGroupManager.create(combinedName, combinedMask);\r\n  }\r\n\r\n  /**\r\n   * Creates a collision group that collides with the listed groups\r\n   * @param collisionGroups\r\n   */\r\n  public static collidesWith(collisionGroups: CollisionGroup[]) {\r\n    const combinedName = `collidesWith(${collisionGroups.map((c) => c.name).join('+')})`;\r\n    const combinedMask = collisionGroups.reduce((current, g) => g.category | current, 0b0);\r\n    return CollisionGroupManager.create(combinedName, combinedMask);\r\n  }\r\n\r\n  public toString() {\r\n    return `\r\ncategory: ${this.category.toString(2).padStart(32, '0')}\r\nmask:     ${(this.mask >>> 0).toString(2).padStart(32, '0')}\r\n    `;\r\n  }\r\n}\r\n","import { CollisionContact } from './CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { Id } from '../../Id';\r\nimport { Collider } from '../Colliders/Collider';\r\n\r\n/**\r\n * Models a potential collision between 2 colliders\r\n */\r\nexport class Pair {\r\n  public id: string = null;\r\n  constructor(\r\n    public colliderA: Collider,\r\n    public colliderB: Collider\r\n  ) {\r\n    this.id = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n  }\r\n\r\n  /**\r\n   * Returns whether a it is allowed for 2 colliders in a Pair to collide\r\n   * @param colliderA\r\n   * @param colliderB\r\n   */\r\n  public static canCollide(colliderA: Collider, colliderB: Collider) {\r\n    // Prevent self collision\r\n    if (colliderA.id === colliderB.id) {\r\n      return false;\r\n    }\r\n\r\n    // Colliders with the same owner do not collide (composite colliders)\r\n    if (colliderA.owner && colliderB.owner && colliderA.owner.id === colliderB.owner.id) {\r\n      return false;\r\n    }\r\n\r\n    // if the pair has a member with zero dimension don't collide\r\n    if (colliderA.localBounds.hasZeroDimensions() || colliderB.localBounds.hasZeroDimensions()) {\r\n      return false;\r\n    }\r\n\r\n    const bodyA = colliderA?.owner?.get(BodyComponent);\r\n    const bodyB = colliderB?.owner?.get(BodyComponent);\r\n\r\n    // Body's needed for collision in the current state\r\n    // TODO can we collide without a body?\r\n    if (!bodyA || !bodyB) {\r\n      return false;\r\n    }\r\n\r\n    // If both are in the same collision group short circuit\r\n    if (!bodyA.group.canCollide(bodyB.group)) {\r\n      return false;\r\n    }\r\n\r\n    // if both are fixed short circuit\r\n    if (bodyA.collisionType === CollisionType.Fixed && bodyB.collisionType === CollisionType.Fixed) {\r\n      return false;\r\n    }\r\n\r\n    // if the either is prevent collision short circuit\r\n    if (bodyB.collisionType === CollisionType.PreventCollision || bodyA.collisionType === CollisionType.PreventCollision) {\r\n      return false;\r\n    }\r\n\r\n    // if either is dead short circuit\r\n    if (!bodyA.isActive || !bodyB.isActive) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Returns whether or not it is possible for the pairs to collide\r\n   */\r\n  public get canCollide(): boolean {\r\n    const colliderA = this.colliderA;\r\n    const colliderB = this.colliderB;\r\n    return Pair.canCollide(colliderA, colliderB);\r\n  }\r\n\r\n  /**\r\n   * Runs the collision intersection logic on the members of this pair\r\n   */\r\n  public collide(): CollisionContact[] {\r\n    return this.colliderA.collide(this.colliderB);\r\n  }\r\n\r\n  /**\r\n   * Check if the collider is part of the pair\r\n   * @param collider\r\n   */\r\n  public hasCollider(collider: Collider) {\r\n    return collider === this.colliderA || collider === this.colliderB;\r\n  }\r\n\r\n  /**\r\n   * Calculates the unique pair hash id for this collision pair (owning id)\r\n   */\r\n  public static calculatePairHash(idA: Id<'collider'>, idB: Id<'collider'>): string {\r\n    if (idA.value < idB.value) {\r\n      return `#${idA.value}+${idB.value}`;\r\n    } else {\r\n      return `#${idB.value}+${idA.value}`;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * A 1 dimensional projection on an axis, used to test overlaps\r\n */\r\n\r\nexport class Projection {\r\n  constructor(\r\n    public min: number,\r\n    public max: number\r\n  ) {}\r\n  public overlaps(projection: Projection): boolean {\r\n    return this.max > projection.min && projection.max > this.min;\r\n  }\r\n\r\n  public getOverlap(projection: Projection): number {\r\n    if (this.overlaps(projection)) {\r\n      if (this.max > projection.max) {\r\n        return projection.max - this.min;\r\n      } else {\r\n        return this.max - projection.min;\r\n      }\r\n    }\r\n    return 0;\r\n  }\r\n}\r\n","import { BoundingBox } from '../BoundingBox';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Id } from '../../Id';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { Color, ExcaliburGraphicsContext } from '../..';\r\nimport { DynamicTreeConfig } from '../PhysicsConfig';\r\n\r\n/**\r\n * Dynamic Tree Node used for tracking bounds within the tree\r\n */\r\nexport class TreeNode<T> {\r\n  public left: TreeNode<T>;\r\n  public right: TreeNode<T>;\r\n  public bounds: BoundingBox;\r\n  public height: number;\r\n  public data: T;\r\n  constructor(public parent?: TreeNode<T>) {\r\n    this.parent = parent || null;\r\n    this.data = null;\r\n    this.bounds = new BoundingBox();\r\n    this.left = null;\r\n    this.right = null;\r\n    this.height = 0;\r\n  }\r\n\r\n  public isLeaf(): boolean {\r\n    return !this.left && !this.right;\r\n  }\r\n}\r\n\r\nexport interface ColliderProxy<T> {\r\n  id: Id<'collider'>;\r\n  owner: T;\r\n  bounds: BoundingBox;\r\n}\r\n\r\n/**\r\n * The DynamicTrees provides a spatial partitioning data structure for quickly querying for overlapping bounding boxes for\r\n * all tracked bodies. The worst case performance of this is O(n*log(n)) where n is the number of bodies in the tree.\r\n *\r\n * Internally the bounding boxes are organized as a balanced binary tree of bounding boxes, where the leaf nodes are tracked bodies.\r\n * Every non-leaf node is a bounding box that contains child bounding boxes.\r\n */\r\nexport class DynamicTree<TProxy extends ColliderProxy<Entity>> {\r\n  public root: TreeNode<TProxy>;\r\n  public nodes: { [key: number]: TreeNode<TProxy> };\r\n  constructor(\r\n    private _config: Required<DynamicTreeConfig>,\r\n    public worldBounds: BoundingBox = new BoundingBox(-Number.MAX_VALUE, -Number.MAX_VALUE, Number.MAX_VALUE, Number.MAX_VALUE)\r\n  ) {\r\n    this.root = null;\r\n    this.nodes = {};\r\n  }\r\n\r\n  /**\r\n   * Inserts a node into the dynamic tree\r\n   */\r\n  private _insert(leaf: TreeNode<TProxy>): void {\r\n    // If there are no nodes in the tree, make this the root leaf\r\n    if (this.root === null) {\r\n      this.root = leaf;\r\n      this.root.parent = null;\r\n      return;\r\n    }\r\n\r\n    // Search the tree for a node that is not a leaf and find the best place to insert\r\n    const leafAABB = leaf.bounds;\r\n    let currentRoot = this.root;\r\n    while (!currentRoot.isLeaf()) {\r\n      const left = currentRoot.left;\r\n      const right = currentRoot.right;\r\n\r\n      const area = currentRoot.bounds.getPerimeter();\r\n      const combinedAABB = currentRoot.bounds.combine(leafAABB);\r\n      const combinedArea = combinedAABB.getPerimeter();\r\n\r\n      // Calculate cost heuristic for creating a new parent and leaf\r\n      const cost = 2 * combinedArea;\r\n\r\n      // Minimum cost of pushing the leaf down the tree\r\n      const inheritanceCost = 2 * (combinedArea - area);\r\n\r\n      // Cost of descending\r\n      let leftCost = 0;\r\n      const leftCombined = leafAABB.combine(left.bounds);\r\n      let newArea;\r\n      let oldArea;\r\n      if (left.isLeaf()) {\r\n        leftCost = leftCombined.getPerimeter() + inheritanceCost;\r\n      } else {\r\n        oldArea = left.bounds.getPerimeter();\r\n        newArea = leftCombined.getPerimeter();\r\n        leftCost = newArea - oldArea + inheritanceCost;\r\n      }\r\n\r\n      let rightCost = 0;\r\n      const rightCombined = leafAABB.combine(right.bounds);\r\n      if (right.isLeaf()) {\r\n        rightCost = rightCombined.getPerimeter() + inheritanceCost;\r\n      } else {\r\n        oldArea = right.bounds.getPerimeter();\r\n        newArea = rightCombined.getPerimeter();\r\n        rightCost = newArea - oldArea + inheritanceCost;\r\n      }\r\n\r\n      // cost is acceptable\r\n      if (cost < leftCost && cost < rightCost) {\r\n        break;\r\n      }\r\n\r\n      // Descend to the depths\r\n      if (leftCost < rightCost) {\r\n        currentRoot = left;\r\n      } else {\r\n        currentRoot = right;\r\n      }\r\n    }\r\n\r\n    // Create the new parent node and insert into the tree\r\n    const oldParent = currentRoot.parent;\r\n    const newParent = new TreeNode(oldParent);\r\n    newParent.bounds = leafAABB.combine(currentRoot.bounds);\r\n    newParent.height = currentRoot.height + 1;\r\n\r\n    if (oldParent !== null) {\r\n      // The sibling node was not the root\r\n      if (oldParent.left === currentRoot) {\r\n        oldParent.left = newParent;\r\n      } else {\r\n        oldParent.right = newParent;\r\n      }\r\n\r\n      newParent.left = currentRoot;\r\n      newParent.right = leaf;\r\n\r\n      currentRoot.parent = newParent;\r\n      leaf.parent = newParent;\r\n    } else {\r\n      // The sibling node was the root\r\n      newParent.left = currentRoot;\r\n      newParent.right = leaf;\r\n\r\n      currentRoot.parent = newParent;\r\n      leaf.parent = newParent;\r\n      this.root = newParent;\r\n    }\r\n\r\n    // Walk up the tree fixing heights and AABBs\r\n    let currentNode = leaf.parent;\r\n    while (currentNode) {\r\n      currentNode = this._balance(currentNode);\r\n\r\n      if (!currentNode.left) {\r\n        throw new Error('Parent of current leaf cannot have a null left child' + currentNode);\r\n      }\r\n      if (!currentNode.right) {\r\n        throw new Error('Parent of current leaf cannot have a null right child' + currentNode);\r\n      }\r\n\r\n      currentNode.height = 1 + Math.max(currentNode.left.height, currentNode.right.height);\r\n      currentNode.bounds = currentNode.left.bounds.combine(currentNode.right.bounds);\r\n\r\n      currentNode = currentNode.parent;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a node from the dynamic tree\r\n   */\r\n  private _remove(leaf: TreeNode<TProxy>) {\r\n    if (leaf === this.root) {\r\n      this.root = null;\r\n      return;\r\n    }\r\n\r\n    const parent = leaf.parent;\r\n    const grandParent = parent.parent;\r\n    let sibling: TreeNode<TProxy>;\r\n    if (parent.left === leaf) {\r\n      sibling = parent.right;\r\n    } else {\r\n      sibling = parent.left;\r\n    }\r\n\r\n    if (grandParent) {\r\n      if (grandParent.left === parent) {\r\n        grandParent.left = sibling;\r\n      } else {\r\n        grandParent.right = sibling;\r\n      }\r\n      sibling.parent = grandParent;\r\n\r\n      let currentNode = grandParent;\r\n      while (currentNode) {\r\n        currentNode = this._balance(currentNode);\r\n        currentNode.bounds = currentNode.left.bounds.combine(currentNode.right.bounds);\r\n        currentNode.height = 1 + Math.max(currentNode.left.height, currentNode.right.height);\r\n\r\n        currentNode = currentNode.parent;\r\n      }\r\n    } else {\r\n      this.root = sibling;\r\n      sibling.parent = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tracks a body in the dynamic tree\r\n   */\r\n  public trackCollider(collider: TProxy) {\r\n    const node = new TreeNode<TProxy>();\r\n    node.data = collider;\r\n    node.bounds = collider.bounds;\r\n    node.bounds.left -= 2;\r\n    node.bounds.top -= 2;\r\n    node.bounds.right += 2;\r\n    node.bounds.bottom += 2;\r\n    this.nodes[collider.id.value] = node;\r\n    this._insert(node);\r\n  }\r\n\r\n  /**\r\n   * Updates the dynamic tree given the current bounds of each body being tracked\r\n   */\r\n  public updateCollider(collider: TProxy) {\r\n    const node = this.nodes[collider.id.value];\r\n    if (!node) {\r\n      return false;\r\n    }\r\n    const b = collider.bounds;\r\n\r\n    // if the body is outside the world no longer update it\r\n    if (!this.worldBounds.contains(b)) {\r\n      Logger.getInstance().warn(\r\n        'Collider with id ' + collider.id.value + ' is outside the world bounds and will no longer be tracked for physics'\r\n      );\r\n      this.untrackCollider(collider);\r\n      return false;\r\n    }\r\n\r\n    if (node.bounds.contains(b)) {\r\n      return false;\r\n    }\r\n\r\n    this._remove(node);\r\n    b.left -= this._config.boundsPadding;\r\n    b.top -= this._config.boundsPadding;\r\n    b.right += this._config.boundsPadding;\r\n    b.bottom += this._config.boundsPadding;\r\n\r\n    // THIS IS CAUSING UNNECESSARY CHECKS\r\n    if (collider.owner) {\r\n      const body = collider.owner?.get(BodyComponent);\r\n      if (body) {\r\n        const multdx = ((body.vel.x * 32) / 1000) * this._config.velocityMultiplier;\r\n        const multdy = ((body.vel.y * 32) / 1000) * this._config.velocityMultiplier;\r\n\r\n        if (multdx < 0) {\r\n          b.left += multdx;\r\n        } else {\r\n          b.right += multdx;\r\n        }\r\n\r\n        if (multdy < 0) {\r\n          b.top += multdy;\r\n        } else {\r\n          b.bottom += multdy;\r\n        }\r\n      }\r\n    }\r\n\r\n    node.bounds = b;\r\n    this._insert(node);\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Untracks a body from the dynamic tree\r\n   */\r\n  public untrackCollider(collider: TProxy) {\r\n    const node = this.nodes[collider.id.value];\r\n    if (!node) {\r\n      return;\r\n    }\r\n    this._remove(node);\r\n    this.nodes[collider.id.value] = null;\r\n    delete this.nodes[collider.id.value];\r\n  }\r\n\r\n  /**\r\n   * Balances the tree about a node\r\n   */\r\n  private _balance(node: TreeNode<TProxy>) {\r\n    if (node === null) {\r\n      throw new Error('Cannot balance at null node');\r\n    }\r\n\r\n    if (node.isLeaf() || node.height < 2) {\r\n      return node;\r\n    }\r\n\r\n    const left = node.left;\r\n    const right = node.right;\r\n\r\n    const a = node;\r\n    const b = left;\r\n    const c = right;\r\n    const d = left.left;\r\n    const e = left.right;\r\n    const f = right.left;\r\n    const g = right.right;\r\n\r\n    const balance = c.height - b.height;\r\n    // Rotate c node up\r\n    if (balance > 1) {\r\n      // Swap the right node with it's parent\r\n      c.left = a;\r\n      c.parent = a.parent;\r\n      a.parent = c;\r\n\r\n      // The original node's old parent should point to the right node\r\n      // this is mega confusing\r\n      if (c.parent) {\r\n        if (c.parent.left === a) {\r\n          c.parent.left = c;\r\n        } else {\r\n          c.parent.right = c;\r\n        }\r\n      } else {\r\n        this.root = c;\r\n      }\r\n\r\n      // Rotate\r\n      if (f.height > g.height) {\r\n        c.right = f;\r\n        a.right = g;\r\n        g.parent = a;\r\n\r\n        a.bounds = b.bounds.combine(g.bounds);\r\n        c.bounds = a.bounds.combine(f.bounds);\r\n\r\n        a.height = 1 + Math.max(b.height, g.height);\r\n        c.height = 1 + Math.max(a.height, f.height);\r\n      } else {\r\n        c.right = g;\r\n        a.right = f;\r\n        f.parent = a;\r\n\r\n        a.bounds = b.bounds.combine(f.bounds);\r\n        c.bounds = a.bounds.combine(g.bounds);\r\n\r\n        a.height = 1 + Math.max(b.height, f.height);\r\n        c.height = 1 + Math.max(a.height, g.height);\r\n      }\r\n\r\n      return c;\r\n    }\r\n    // Rotate left node up\r\n    if (balance < -1) {\r\n      // swap\r\n      b.left = a;\r\n      b.parent = a.parent;\r\n      a.parent = b;\r\n\r\n      // node's old parent should point to b\r\n      if (b.parent) {\r\n        if (b.parent.left === a) {\r\n          b.parent.left = b;\r\n        } else {\r\n          if (b.parent.right !== a) {\r\n            throw 'Error rotating Dynamic Tree';\r\n          }\r\n          b.parent.right = b;\r\n        }\r\n      } else {\r\n        this.root = b;\r\n      }\r\n\r\n      // rotate\r\n      if (d.height > e.height) {\r\n        b.right = d;\r\n        a.left = e;\r\n        e.parent = a;\r\n\r\n        a.bounds = c.bounds.combine(e.bounds);\r\n        b.bounds = a.bounds.combine(d.bounds);\r\n\r\n        a.height = 1 + Math.max(c.height, e.height);\r\n        b.height = 1 + Math.max(a.height, d.height);\r\n      } else {\r\n        b.right = e;\r\n        a.left = d;\r\n        d.parent = a;\r\n\r\n        a.bounds = c.bounds.combine(d.bounds);\r\n        b.bounds = a.bounds.combine(e.bounds);\r\n\r\n        a.height = 1 + Math.max(c.height, d.height);\r\n        b.height = 1 + Math.max(a.height, e.height);\r\n      }\r\n      return b;\r\n    }\r\n\r\n    return node;\r\n  }\r\n\r\n  /**\r\n   * Returns the internal height of the tree, shorter trees are better. Performance drops as the tree grows\r\n   */\r\n  public getHeight(): number {\r\n    if (this.root === null) {\r\n      return 0;\r\n    }\r\n    return this.root.height;\r\n  }\r\n\r\n  /**\r\n   * Queries the Dynamic Axis Aligned Tree for bodies that could be colliding with the provided body.\r\n   *\r\n   * In the query callback, it will be passed a potential collider. Returning true from this callback indicates\r\n   * that you are complete with your query and you do not want to continue. Returning false will continue searching\r\n   * the tree until all possible colliders have been returned.\r\n   */\r\n  public query(collider: TProxy, callback: (other: TProxy) => boolean): void {\r\n    const bounds = collider.bounds;\r\n    const helper = (currentNode: TreeNode<TProxy>): boolean => {\r\n      if (currentNode && currentNode.bounds.overlaps(bounds)) {\r\n        if (currentNode.isLeaf() && currentNode.data !== collider) {\r\n          if (callback.call(collider, currentNode.data)) {\r\n            return true;\r\n          }\r\n        } else {\r\n          return helper(currentNode.left) || helper(currentNode.right);\r\n        }\r\n      }\r\n      return false;\r\n    };\r\n    helper(this.root);\r\n  }\r\n\r\n  /**\r\n   * Queries the Dynamic Axis Aligned Tree for bodies that could be intersecting. By default the raycast query uses an infinitely\r\n   * long ray to test the tree specified by `max`.\r\n   *\r\n   * In the query callback, it will be passed a potential body that intersects with the raycast. Returning true from this\r\n   * callback indicates that your are complete with your query and do not want to continue. Return false will continue searching\r\n   * the tree until all possible bodies that would intersect with the ray have been returned.\r\n   */\r\n  public rayCastQuery(ray: Ray, max: number = Infinity, callback: (other: TProxy) => boolean): void {\r\n    const helper = (currentNode: TreeNode<TProxy>): boolean => {\r\n      if (currentNode && currentNode.bounds.rayCast(ray, max)) {\r\n        if (currentNode.isLeaf()) {\r\n          if (callback.call(ray, currentNode.data)) {\r\n            // ray hit a leaf! return the body\r\n            return true;\r\n          }\r\n        } else {\r\n          // ray hit but not at a leaf, recurse deeper\r\n          return helper(currentNode.left) || helper(currentNode.right);\r\n        }\r\n      }\r\n      return false; // ray missed\r\n    };\r\n    helper(this.root);\r\n  }\r\n\r\n  public getNodes(): TreeNode<TProxy>[] {\r\n    const helper = (currentNode: TreeNode<TProxy>): TreeNode<TProxy>[] => {\r\n      if (currentNode) {\r\n        return [currentNode].concat(helper(currentNode.left), helper(currentNode.right));\r\n      } else {\r\n        return [];\r\n      }\r\n    };\r\n    return helper(this.root);\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext) {\r\n    // draw all the nodes in the Dynamic Tree\r\n    const helper = (currentNode: TreeNode<TProxy>) => {\r\n      if (currentNode) {\r\n        if (currentNode.isLeaf()) {\r\n          currentNode.bounds.draw(ex, Color.Green);\r\n        } else {\r\n          currentNode.bounds.draw(ex, Color.White);\r\n        }\r\n\r\n        if (currentNode.left) {\r\n          helper(currentNode.left);\r\n        }\r\n        if (currentNode.right) {\r\n          helper(currentNode.right);\r\n        }\r\n      }\r\n    };\r\n\r\n    helper(this.root);\r\n  }\r\n}\r\n","import { LineSegment } from './line-segment';\nimport { Vector } from './vector';\n\n/**\n * A 2D ray that can be cast into the scene to do collision detection\n */\n\nexport class Ray {\n  public pos: Vector;\n  public dir: Vector;\n\n  /**\n   * @param pos The starting position for the ray\n   * @param dir The vector indicating the direction of the ray\n   */\n  constructor(pos: Vector, dir: Vector) {\n    this.pos = pos;\n    this.dir = dir.normalize();\n  }\n\n  /**\n   * Tests a whether this ray intersects with a line segment. Returns a number greater than or equal to 0 on success.\n   * This number indicates the mathematical intersection time.\n   * @param line  The line to test\n   */\n  public intersect(line: LineSegment): number {\n    const numerator = line.begin.sub(this.pos);\n\n    // Test is line and ray are parallel and non intersecting\n    if (this.dir.cross(line.getSlope()) === 0 && numerator.cross(this.dir) !== 0) {\n      return -1;\n    }\n\n    // Lines are parallel\n    const divisor = this.dir.cross(line.getSlope());\n    if (divisor === 0) {\n      return -1;\n    }\n\n    const t = numerator.cross(line.getSlope()) / divisor;\n\n    if (t >= 0) {\n      const u = numerator.cross(this.dir) / divisor / line.getLength();\n      if (u >= 0 && u <= 1) {\n        return t;\n      }\n    }\n    return -1;\n  }\n\n  public intersectPoint(line: LineSegment): Vector {\n    const time = this.intersect(line);\n    if (time < 0) {\n      return null;\n    }\n    return this.getPoint(time);\n  }\n\n  /**\n   * Returns the point of intersection given the intersection time\n   */\n  public getPoint(time: number): Vector {\n    return this.pos.add(this.dir.scale(time));\n  }\n}\n","import { CollisionProcessor } from './CollisionProcessor';\r\nimport { DynamicTree } from './DynamicTree';\r\nimport { Pair } from './Pair';\r\n\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { FrameStats } from '../../Debug';\r\nimport { Logger } from '../../Util/Log';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Collider } from '../Colliders/Collider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { CompositeCollider } from '../Colliders/CompositeCollider';\r\nimport { CollisionGroup } from '../Group/CollisionGroup';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { RayCastHit } from './RayCastHit';\r\nimport { DeepRequired } from '../../Util/Required';\r\nimport { PhysicsConfig } from '../PhysicsConfig';\r\nimport { RayCastOptions } from './RayCastOptions';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { createId } from '../../Id';\r\n\r\n/**\r\n * Responsible for performing the collision broadphase (locating potential collisions) and\r\n * the narrowphase (actual collision contacts)\r\n */\r\nexport class DynamicTreeCollisionProcessor implements CollisionProcessor {\r\n  private _dynamicCollisionTree: DynamicTree<Collider>;\r\n  private _pairs = new Set<string>();\r\n\r\n  private _collisionPairCache: Pair[] = [];\r\n  private _colliders: Collider[] = [];\r\n\r\n  constructor(private _config: DeepRequired<PhysicsConfig>) {\r\n    this._dynamicCollisionTree = new DynamicTree<Collider>(_config.dynamicTree);\r\n  }\r\n\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  public query(point: Vector): Collider[];\r\n  public query(bounds: BoundingBox): Collider[];\r\n  public query(pointOrBounds: Vector | BoundingBox): Collider[] {\r\n    const results: Collider[] = [];\r\n    if (pointOrBounds instanceof BoundingBox) {\r\n      this._dynamicCollisionTree.query(\r\n        {\r\n          id: createId('collider', -1),\r\n          owner: null,\r\n          bounds: pointOrBounds\r\n        } as Collider,\r\n        (other) => {\r\n          results.push(other);\r\n          return false;\r\n        }\r\n      );\r\n    } else {\r\n      this._dynamicCollisionTree.query(\r\n        {\r\n          id: createId('collider', -1),\r\n          owner: null,\r\n          bounds: new BoundingBox(pointOrBounds.x, pointOrBounds.y, pointOrBounds.x, pointOrBounds.y)\r\n        } as Collider,\r\n        (other) => {\r\n          results.push(other);\r\n          return false;\r\n        }\r\n      );\r\n    }\r\n    return results;\r\n  }\r\n\r\n  public rayCast(ray: Ray, options?: RayCastOptions): RayCastHit[] {\r\n    const results: RayCastHit[] = [];\r\n    const maxDistance = options?.maxDistance ?? Infinity;\r\n    const collisionGroup = options?.collisionGroup;\r\n    const collisionMask = !collisionGroup ? options?.collisionMask ?? CollisionGroup.All.category : collisionGroup.category;\r\n    const searchAllColliders = options?.searchAllColliders ?? false;\r\n    this._dynamicCollisionTree.rayCastQuery(ray, maxDistance, (collider) => {\r\n      const owner = collider.owner;\r\n      const maybeBody = owner.get(BodyComponent);\r\n\r\n      if (options?.ignoreCollisionGroupAll && maybeBody.group === CollisionGroup.All) {\r\n        return false;\r\n      }\r\n\r\n      const canCollide = (collisionMask & maybeBody.group.category) !== 0;\r\n\r\n      // Early exit if not the right group\r\n      if (maybeBody?.group && !canCollide) {\r\n        return false;\r\n      }\r\n\r\n      const hit = collider.rayCast(ray, maxDistance);\r\n\r\n      if (hit) {\r\n        if (options?.filter) {\r\n          if (options.filter(hit)) {\r\n            results.push(hit);\r\n            if (!searchAllColliders) {\r\n              // returning true exits the search\r\n              return true;\r\n            }\r\n          }\r\n        } else {\r\n          results.push(hit);\r\n          if (!searchAllColliders) {\r\n            // returning true exits the search\r\n            return true;\r\n          }\r\n        }\r\n      }\r\n      return false;\r\n    });\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Tracks a physics body for collisions\r\n   */\r\n  public track(target: Collider): void {\r\n    if (!target) {\r\n      Logger.getInstance().warn('Cannot track null collider');\r\n      return;\r\n    }\r\n    if (target instanceof CompositeCollider) {\r\n      const colliders = target.getColliders();\r\n      for (const c of colliders) {\r\n        c.owner = target.owner;\r\n        this._colliders.push(c);\r\n        this._dynamicCollisionTree.trackCollider(c);\r\n      }\r\n    } else {\r\n      this._colliders.push(target);\r\n      this._dynamicCollisionTree.trackCollider(target);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Untracks a physics body\r\n   */\r\n  public untrack(target: Collider): void {\r\n    if (!target) {\r\n      Logger.getInstance().warn('Cannot untrack a null collider');\r\n      return;\r\n    }\r\n\r\n    if (target instanceof CompositeCollider) {\r\n      const colliders = target.getColliders();\r\n      for (const c of colliders) {\r\n        const index = this._colliders.indexOf(c);\r\n        if (index !== -1) {\r\n          this._colliders.splice(index, 1);\r\n        }\r\n        this._dynamicCollisionTree.untrackCollider(c);\r\n      }\r\n    } else {\r\n      const index = this._colliders.indexOf(target);\r\n      if (index !== -1) {\r\n        this._colliders.splice(index, 1);\r\n      }\r\n      this._dynamicCollisionTree.untrackCollider(target);\r\n    }\r\n  }\r\n\r\n  private _pairExists(colliderA: Collider, colliderB: Collider) {\r\n    // if the collision pair has been calculated already short circuit\r\n    const hash = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n    return this._pairs.has(hash);\r\n  }\r\n\r\n  /**\r\n   * Detects potential collision pairs in a broadphase approach with the dynamic AABB tree strategy\r\n   */\r\n  public broadphase(targets: Collider[], elapsed: number, stats?: FrameStats): Pair[] {\r\n    const seconds = elapsed / 1000;\r\n\r\n    // Retrieve the list of potential colliders, exclude killed, prevented, and self\r\n    const potentialColliders = targets.filter((other) => {\r\n      const body = other.owner?.get(BodyComponent);\r\n      return other.owner?.isActive && body.collisionType !== CollisionType.PreventCollision;\r\n    });\r\n\r\n    // clear old list of collision pairs\r\n    this._collisionPairCache = [];\r\n    this._pairs.clear();\r\n\r\n    // check for normal collision pairs\r\n    let collider: Collider;\r\n    for (let j = 0, l = potentialColliders.length; j < l; j++) {\r\n      collider = potentialColliders[j];\r\n      // Query the collision tree for potential colliders\r\n      this._dynamicCollisionTree.query(collider, (other: Collider) => {\r\n        if (!this._pairExists(collider, other) && Pair.canCollide(collider, other)) {\r\n          const pair = new Pair(collider, other);\r\n          this._pairs.add(pair.id);\r\n          this._collisionPairCache.push(pair);\r\n        }\r\n        // Always return false, to query whole tree. Returning true in the query method stops searching\r\n        return false;\r\n      });\r\n    }\r\n    if (stats) {\r\n      stats.physics.pairs = this._collisionPairCache.length;\r\n    }\r\n\r\n    // Check dynamic tree for fast moving objects\r\n    // Fast moving objects are those moving at least there smallest bound per frame\r\n    if (this._config.continuous.checkForFastBodies) {\r\n      for (const collider of potentialColliders) {\r\n        const body = collider.owner.get(BodyComponent);\r\n        // Skip non-active objects. Does not make sense on other collision types\r\n        if (body.collisionType !== CollisionType.Active) {\r\n          continue;\r\n        }\r\n\r\n        // Maximum travel distance next frame\r\n        const updateDistance =\r\n          body.vel.magnitude * seconds + // velocity term\r\n          body.acc.magnitude * 0.5 * seconds * seconds; // acc term\r\n\r\n        // Find the minimum dimension\r\n        const minDimension = Math.min(collider.bounds.height, collider.bounds.width);\r\n        if (this._config.continuous.disableMinimumSpeedForFastBody || updateDistance > minDimension / 2) {\r\n          if (stats) {\r\n            stats.physics.fastBodies++;\r\n          }\r\n\r\n          // start with the oldPos because the integration for actors has already happened\r\n          // objects resting on a surface may be slightly penetrating in the current position\r\n          const updateVec = body.globalPos.sub(body.oldPos);\r\n          const centerPoint = collider.center;\r\n          const furthestPoint = collider.getFurthestPoint(body.vel);\r\n          const origin: Vector = furthestPoint.sub(updateVec);\r\n\r\n          const ray: Ray = new Ray(origin, body.vel);\r\n\r\n          // back the ray up by -2x surfaceEpsilon to account for fast moving objects starting on the surface\r\n          ray.pos = ray.pos.add(ray.dir.scale(-2 * this._config.continuous.surfaceEpsilon));\r\n          let minCollider: Collider;\r\n          let minTranslate: Vector = new Vector(Infinity, Infinity);\r\n          this._dynamicCollisionTree.rayCastQuery(ray, updateDistance + this._config.continuous.surfaceEpsilon * 2, (other: Collider) => {\r\n            if (!this._pairExists(collider, other) && Pair.canCollide(collider, other)) {\r\n              const hit = other.rayCast(ray, updateDistance + this._config.continuous.surfaceEpsilon * 10);\r\n              if (hit) {\r\n                const translate = hit.point.sub(origin);\r\n                if (translate.magnitude < minTranslate.magnitude) {\r\n                  minTranslate = translate;\r\n                  minCollider = other;\r\n                }\r\n              }\r\n            }\r\n            return false;\r\n          });\r\n\r\n          if (minCollider && Vector.isValid(minTranslate)) {\r\n            const pair = new Pair(collider, minCollider);\r\n            if (!this._pairs.has(pair.id)) {\r\n              this._pairs.add(pair.id);\r\n              this._collisionPairCache.push(pair);\r\n            }\r\n            // move the fast moving object to the other body\r\n            // need to push into the surface by ex.Physics.surfaceEpsilon\r\n            const shift = centerPoint.sub(furthestPoint);\r\n            body.globalPos = origin\r\n              .add(shift)\r\n              .add(minTranslate)\r\n              .add(ray.dir.scale(10 * this._config.continuous.surfaceEpsilon)); // needed to push the shape slightly into contact\r\n            collider.update(body.transform.get());\r\n\r\n            if (stats) {\r\n              stats.physics.fastBodyCollisions++;\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // return cache\r\n    return this._collisionPairCache;\r\n  }\r\n\r\n  /**\r\n   * Applies narrow phase on collision pairs to find actual area intersections\r\n   * Adds actual colliding pairs to stats' Frame data\r\n   */\r\n  public narrowphase(pairs: Pair[], stats?: FrameStats): CollisionContact[] {\r\n    let contacts: CollisionContact[] = [];\r\n    for (let i = 0; i < pairs.length; i++) {\r\n      const newContacts = pairs[i].collide();\r\n      contacts = contacts.concat(newContacts);\r\n      if (stats && newContacts.length > 0) {\r\n        for (const c of newContacts) {\r\n          stats.physics.contacts.set(c.id, c);\r\n        }\r\n      }\r\n    }\r\n    if (stats) {\r\n      stats.physics.collisions += contacts.length;\r\n    }\r\n    return contacts;\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic tree positions\r\n   */\r\n  public update(targets: Collider[]): number {\r\n    let updated = 0;\r\n    const len = targets.length;\r\n\r\n    for (let i = 0; i < len; i++) {\r\n      if (this._dynamicCollisionTree.updateCollider(targets[i])) {\r\n        updated++;\r\n      }\r\n    }\r\n    return updated;\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext) {\r\n    this._dynamicCollisionTree.debug(ex);\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Clonable } from '../../Interfaces/Clonable';\r\nimport { Entity } from '../../EntityComponentSystem';\r\nimport { createId, Id } from '../../Id';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { EventEmitter } from '../../EventEmitter';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\nimport { CompositeCollider } from './CompositeCollider';\r\n\r\n/**\r\n * A collision collider specifies the geometry that can detect when other collision colliders intersect\r\n * for the purposes of colliding 2 objects in excalibur.\r\n */\r\nexport abstract class Collider implements Clonable<Collider> {\r\n  private static _ID = 0;\r\n  public readonly id: Id<'collider'> = createId('collider', Collider._ID++);\r\n  /**\r\n   * Composite collider if any this collider is attached to\r\n   *\r\n   * **WARNING** do not tamper with this property\r\n   */\r\n  public composite: CompositeCollider | null = null;\r\n  public events = new EventEmitter();\r\n\r\n  /**\r\n   * Returns a boolean indicating whether this body collided with\r\n   * or was in stationary contact with\r\n   * the body of the other {@apilink Collider}\r\n   */\r\n  public touching(other: Collider): boolean {\r\n    const contact = this.collide(other);\r\n\r\n    if (contact) {\r\n      return true;\r\n    }\r\n\r\n    return false;\r\n  }\r\n\r\n  public owner: Entity;\r\n\r\n  /**\r\n   * Pixel offset of the collision collider relative to the collider, by default (0, 0) meaning the collider is positioned\r\n   * on top of the collider.\r\n   */\r\n  offset: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Position of the collision collider in world coordinates\r\n   */\r\n  abstract get worldPos(): Vector;\r\n\r\n  /**\r\n   * The center point of the collision collider, for example if the collider is a circle it would be the center.\r\n   */\r\n  abstract get center(): Vector;\r\n\r\n  /**\r\n   * Return the axis-aligned bounding box of the collision collider in world coordinates\r\n   */\r\n  abstract get bounds(): BoundingBox;\r\n\r\n  /**\r\n   * Return the axis-aligned bounding box of the collision collider in local coordinates\r\n   */\r\n  abstract get localBounds(): BoundingBox;\r\n\r\n  /**\r\n   * Return the axes of this particular collider\r\n   */\r\n  abstract get axes(): Vector[];\r\n  /**\r\n   * Find the furthest point on the convex hull of this particular collider in a certain direction.\r\n   */\r\n  abstract getFurthestPoint(direction: Vector): Vector;\r\n\r\n  abstract getInertia(mass: number): number;\r\n\r\n  // All new CollisionShape need to do the following\r\n  // Create a new collision function in the CollisionJumpTable against all the primitives\r\n  // Currently there are 3 primitive collision collider 3! = 6 jump functions\r\n  abstract collide(collider: Collider): CollisionContact[];\r\n\r\n  /**\r\n   * Returns the closest line between the surfaces this collider and another\r\n   * @param collider\r\n   */\r\n  abstract getClosestLineBetween(collider: Collider): LineSegment;\r\n\r\n  /**\r\n   * Return wether the collider contains a point inclusive to it's border\r\n   */\r\n  abstract contains(point: Vector): boolean;\r\n\r\n  /**\r\n   * Return the point on the border of the collision collider that intersects with a ray (if any).\r\n   */\r\n  abstract rayCast(ray: Ray, max?: number): RayCastHit | null;\r\n\r\n  /**\r\n   * Create a projection of this collider along an axis. Think of this as casting a \"shadow\" along an axis\r\n   */\r\n  abstract project(axis: Vector): Projection;\r\n\r\n  /**\r\n   * Updates collider world space geometry\r\n   */\r\n  abstract update(transform: Transform): void;\r\n\r\n  abstract debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number; pointSize: number }): void;\r\n\r\n  abstract clone(): Collider;\r\n}\r\n","/**\r\n * Possible collision resolution strategies\r\n *\r\n * The default is {@apilink SolverStrategy.Arcade} which performs simple axis aligned arcade style physics. This is useful for things\r\n * like platformers or top down games.\r\n *\r\n * More advanced rigid body physics are enabled by setting {@apilink SolverStrategy.Realistic} which allows for complicated\r\n * simulated physical interactions.\r\n */\r\nexport enum SpatialPartitionStrategy {\r\n  DynamicTree = 'dynamic-tree',\r\n  SparseHashGrid = 'sparse-hash-grid'\r\n}\r\n","import { Vector, vec } from '../Math/vector';\r\nimport { DeepRequired } from '../Util/Required';\r\nimport { SolverStrategy } from './SolverStrategy';\r\nimport { ContactSolveBias } from './Solver/ContactBias';\r\nimport { SpatialPartitionStrategy } from './Detection/SpatialPartitionStrategy';\r\n\r\nexport interface DynamicTreeConfig {\r\n  /**\r\n   * Pad collider BoundingBox by a constant amount for purposes of potential pairs\r\n   *\r\n   * Default 5 pixels\r\n   */\r\n  boundsPadding?: number;\r\n\r\n  /**\r\n   * Factor to add to the collider BoundingBox, bounding box (dimensions += vel * dynamicTreeVelocityMultiplier);\r\n   *\r\n   * Default 2\r\n   */\r\n  velocityMultiplier?: number;\r\n}\r\n\r\nexport interface SparseHashGridConfig {\r\n  /**\r\n   * Size of the grid cells, default is 100x100 pixels.\r\n   *\r\n   * A good size means that your average collider in your game would fit inside the cell size by size dimension.\r\n   */\r\n  size: number;\r\n}\r\n\r\nexport interface PhysicsConfig {\r\n  /**\r\n   * Excalibur physics simulation is enabled\r\n   */\r\n  enabled?: boolean;\r\n  /**\r\n   * Configure gravity that applies to all {@apilink CollisionType.Active} bodies.\r\n   *\r\n   * This is acceleration in pixels/sec^2\r\n   *\r\n   * Default vec(0, 0)\r\n   *\r\n   * {@apilink BodyComponent.useGravity} to opt out\r\n   */\r\n  gravity?: Vector;\r\n  /**\r\n   * Configure the type of physics simulation you would like\r\n   *\r\n   * * {@apilink SolverStrategy.Arcade} is suitable for games where you might be doing platforming or top down movement.\r\n   * * {@apilink SolverStrategy.Realistic} is where you need objects to bounce off each other and respond like real world objects.\r\n   *\r\n   * Default is Arcade\r\n   */\r\n  solver?: SolverStrategy;\r\n\r\n  /**\r\n   * Configure physics sub-stepping, this can increase simulation fidelity by doing smaller physics steps\r\n   *\r\n   * Default is 1 step\r\n   */\r\n  substep?: number;\r\n\r\n  /**\r\n   * Configure colliders\r\n   */\r\n  colliders?: {\r\n    /**\r\n     * Treat composite collider's member colliders as either separate colliders for the purposes of onCollisionStart/onCollision\r\n     * or as a single collider together.\r\n     *\r\n     * This property can be overridden on individual {@apilink CompositeColliders}.\r\n     *\r\n     * For composites without gaps or small groups of colliders, you probably want 'together'\r\n     *\r\n     * For composites with deliberate gaps, like a platforming level layout, you probably want 'separate'\r\n     *\r\n     * Default is 'together' if unset\r\n     */\r\n    compositeStrategy?: 'separate' | 'together';\r\n  };\r\n\r\n  /**\r\n   * Configure excalibur continuous collision (WIP)\r\n   */\r\n  continuous?: {\r\n    /**\r\n     * Enable fast moving body checking, this enables checking for collision pairs via raycast for fast moving objects to prevent\r\n     * bodies from tunneling through one another.\r\n     *\r\n     * Default true\r\n     */\r\n    checkForFastBodies?: boolean;\r\n\r\n    /**\r\n     * Disable minimum fast moving body raycast, by default if checkForFastBodies = true Excalibur will only check if the\r\n     * body is moving at least half of its minimum dimension in an update. If disableMinimumSpeedForFastBody is set to true,\r\n     * Excalibur will always perform the fast body raycast regardless of speed.\r\n     *\r\n     * Default false\r\n     */\r\n    disableMinimumSpeedForFastBody?: boolean;\r\n\r\n    /**\r\n     * Surface epsilon is used to help deal with predicting collisions by applying a slop\r\n     *\r\n     * Default 0.1\r\n     */\r\n    surfaceEpsilon?: number;\r\n  };\r\n\r\n  /**\r\n   * Configure body defaults\r\n   */\r\n  bodies?: {\r\n    /**\r\n     * Configure default mass that bodies have\r\n     *\r\n     * Default 10 mass units\r\n     */\r\n    defaultMass?: number;\r\n\r\n    /**\r\n     * Sleep epsilon\r\n     *\r\n     * Default 0.07\r\n     */\r\n    sleepEpsilon?: number;\r\n\r\n    /**\r\n     * Wake Threshold, the amount of \"motion\" need to wake a body from sleep\r\n     *\r\n     * Default 0.07 * 3;\r\n     */\r\n    wakeThreshold?: number;\r\n\r\n    /**\r\n     * Sleep bias\r\n     *\r\n     * Default 0.9\r\n     */\r\n    sleepBias?: number;\r\n\r\n    /**\r\n     * By default bodies do not sleep, this can be turned on to improve perf if you have a lot of bodies.\r\n     *\r\n     * Default false\r\n     */\r\n    canSleepByDefault?: boolean;\r\n  };\r\n\r\n  /**\r\n   * Configure the spatial data structure for locating pairs and raycasts\r\n   */\r\n  spatialPartition?: SpatialPartitionStrategy;\r\n  sparseHashGrid?: SparseHashGridConfig;\r\n  dynamicTree?: DynamicTreeConfig;\r\n\r\n  /**\r\n   * Configure the {@apilink ArcadeSolver}\r\n   */\r\n  arcade?: {\r\n    /**\r\n     * Hints the {@apilink ArcadeSolver} to preferentially solve certain contact directions first.\r\n     *\r\n     * Options:\r\n     * * Solve {@apilink ContactSolveBias.VerticalFirst} which will do vertical contact resolution first (useful for platformers\r\n     * with up/down gravity)\r\n     * * Solve {@apilink ContactSolveBias.HorizontalFirst} which will do horizontal contact resolution first (useful for games with\r\n     * left/right forces)\r\n     * * By default {@apilink ContactSolveBias.None} which sorts by distance\r\n     */\r\n    contactSolveBias?: ContactSolveBias;\r\n  };\r\n\r\n  /**\r\n   * Configure the {@apilink RealisticSolver}\r\n   */\r\n  realistic?: {\r\n    contactSolveBias?: ContactSolveBias;\r\n    /**\r\n     * Number of position iterations (overlap) to run in the solver\r\n     *\r\n     * Default 3 iterations\r\n     */\r\n    positionIterations?: number;\r\n\r\n    /**\r\n     * Number of velocity iteration (response) to run in the solver\r\n     *\r\n     * Default 8 iterations\r\n     */\r\n    velocityIterations?: number;\r\n\r\n    /**\r\n     * Amount of overlap to tolerate in pixels\r\n     *\r\n     * Default 1 pixel\r\n     */\r\n    slop?: number;\r\n\r\n    /**\r\n     * Amount of positional overlap correction to apply each position iteration of the solver\r\n     * 0 - meaning no correction, 1 - meaning correct all overlap. Generally values 0 < .5 look nice.\r\n     *\r\n     * Default 0.2\r\n     */\r\n    steeringFactor?: number;\r\n\r\n    /**\r\n     * Warm start set to true re-uses impulses from previous frames back in the solver. Re-using impulses helps\r\n     * the solver converge quicker\r\n     *\r\n     * Default true\r\n     */\r\n    warmStart?: boolean;\r\n  };\r\n}\r\n\r\nexport const getDefaultPhysicsConfig: () => DeepRequired<PhysicsConfig> = () => ({\r\n  enabled: true,\r\n  gravity: vec(0, 0).clone(),\r\n  solver: SolverStrategy.Arcade,\r\n  substep: 1,\r\n  colliders: {\r\n    compositeStrategy: 'together'\r\n  },\r\n  continuous: {\r\n    checkForFastBodies: true,\r\n    disableMinimumSpeedForFastBody: false,\r\n    surfaceEpsilon: 0.1\r\n  },\r\n  bodies: {\r\n    canSleepByDefault: false,\r\n    sleepEpsilon: 0.07,\r\n    wakeThreshold: 0.07 * 3,\r\n    sleepBias: 0.9,\r\n    defaultMass: 10\r\n  },\r\n  spatialPartition: SpatialPartitionStrategy.SparseHashGrid,\r\n  sparseHashGrid: {\r\n    size: 100\r\n  },\r\n  dynamicTree: {\r\n    boundsPadding: 5,\r\n    velocityMultiplier: 2\r\n  },\r\n  arcade: {\r\n    contactSolveBias: ContactSolveBias.None\r\n  },\r\n  realistic: {\r\n    contactSolveBias: ContactSolveBias.None,\r\n    positionIterations: 3,\r\n    velocityIterations: 8,\r\n    slop: 1,\r\n    steeringFactor: 0.2,\r\n    warmStart: true\r\n  }\r\n});\r\n","import { Util } from '../..';\r\nimport { Pair } from '../Detection/Pair';\r\nimport { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Projection } from '../../Math/projection';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Vector } from '../../Math/vector';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { DynamicTree } from '../Detection/DynamicTree';\r\nimport { DynamicTreeCollisionProcessor } from '../Detection/DynamicTreeCollisionProcessor';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\nimport { Collider } from './Collider';\r\nimport { Transform } from '../../Math/transform';\r\nimport { getDefaultPhysicsConfig } from '../PhysicsConfig';\r\n\r\nexport class CompositeCollider extends Collider {\r\n  private _transform: Transform;\r\n  private _collisionProcessor = new DynamicTreeCollisionProcessor({\r\n    ...getDefaultPhysicsConfig()\r\n  });\r\n  private _dynamicAABBTree = new DynamicTree({\r\n    boundsPadding: 5,\r\n    velocityMultiplier: 2\r\n  });\r\n  private _colliders: Collider[] = [];\r\n\r\n  private _compositeStrategy?: 'separate' | 'together';\r\n  /**\r\n   * Treat composite collider's member colliders as either separate colliders for the purposes of onCollisionStart/onCollision\r\n   * or as a single collider together.\r\n   *\r\n   * This property can be overridden on individual {@apilink CompositeColliders}.\r\n   *\r\n   * For composites without gaps or small groups of colliders, you probably want 'together'\r\n   *\r\n   * For composites with deliberate gaps, like a platforming level layout, you probably want 'separate'\r\n   *\r\n   * Default is 'together' if unset\r\n   */\r\n  public set compositeStrategy(value: 'separate' | 'together') {\r\n    this._compositeStrategy = value;\r\n  }\r\n  public get compositeStrategy() {\r\n    return this._compositeStrategy;\r\n  }\r\n\r\n  constructor(colliders: Collider[]) {\r\n    super();\r\n    for (const c of colliders) {\r\n      this.addCollider(c);\r\n    }\r\n  }\r\n\r\n  clearColliders() {\r\n    this._colliders = [];\r\n  }\r\n\r\n  addCollider(collider: Collider) {\r\n    let colliders: Collider[];\r\n    if (collider instanceof CompositeCollider) {\r\n      colliders = collider.getColliders();\r\n      colliders.forEach((c) => c.offset.addEqual(collider.offset));\r\n    } else {\r\n      colliders = [collider];\r\n    }\r\n    // Flatten composites\r\n    for (const c of colliders) {\r\n      c.events.pipe(this.events);\r\n      c.composite = this;\r\n      this._colliders.push(c);\r\n      this._collisionProcessor.track(c);\r\n      this._dynamicAABBTree.trackCollider(c);\r\n    }\r\n  }\r\n\r\n  removeCollider(collider: Collider) {\r\n    collider.events.pipe(this.events);\r\n    collider.composite = null;\r\n    Util.removeItemFromArray(collider, this._colliders);\r\n    this._collisionProcessor.untrack(collider);\r\n    this._dynamicAABBTree.untrackCollider(collider);\r\n  }\r\n\r\n  getColliders(): Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  get worldPos(): Vector {\r\n    return (this._transform?.pos ?? Vector.Zero).add(this.offset);\r\n  }\r\n\r\n  get center(): Vector {\r\n    return (this._transform?.pos ?? Vector.Zero).add(this.offset);\r\n  }\r\n\r\n  get bounds(): BoundingBox {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    const results = colliders.reduce(\r\n      (acc, collider) => acc.combine(collider.bounds),\r\n      colliders[0]?.bounds ?? new BoundingBox().translate(this.worldPos)\r\n    );\r\n\r\n    return results.translate(this.offset);\r\n  }\r\n\r\n  get localBounds(): BoundingBox {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    const results = colliders.reduce((acc, collider) => acc.combine(collider.localBounds), colliders[0]?.localBounds ?? new BoundingBox());\r\n\r\n    return results;\r\n  }\r\n\r\n  get axes(): Vector[] {\r\n    // TODO cache this\r\n    const colliders = this.getColliders();\r\n    let axes: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      axes = axes.concat(collider.axes);\r\n    }\r\n    return axes;\r\n  }\r\n\r\n  getFurthestPoint(direction: Vector): Vector {\r\n    const colliders = this.getColliders();\r\n    const furthestPoints: Vector[] = [];\r\n    for (const collider of colliders) {\r\n      furthestPoints.push(collider.getFurthestPoint(direction));\r\n    }\r\n    // Pick best point from all colliders\r\n    let bestPoint = furthestPoints[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (const point of furthestPoints) {\r\n      const distance = point.dot(direction);\r\n      if (distance > maxDistance) {\r\n        bestPoint = point;\r\n        maxDistance = distance;\r\n      }\r\n    }\r\n    return bestPoint;\r\n  }\r\n\r\n  getInertia(mass: number): number {\r\n    const colliders = this.getColliders();\r\n    let totalInertia = 0;\r\n    for (const collider of colliders) {\r\n      totalInertia += collider.getInertia(mass);\r\n    }\r\n    return totalInertia;\r\n  }\r\n\r\n  collide(other: Collider): CollisionContact[] {\r\n    let otherColliders = [other];\r\n    if (other instanceof CompositeCollider) {\r\n      otherColliders = other.getColliders();\r\n    }\r\n\r\n    const pairs: Pair[] = [];\r\n    for (const c of otherColliders) {\r\n      this._dynamicAABBTree.query(c, (potentialCollider: Collider) => {\r\n        pairs.push(new Pair(c, potentialCollider));\r\n        return false;\r\n      });\r\n    }\r\n\r\n    let contacts: CollisionContact[] = [];\r\n    for (const p of pairs) {\r\n      contacts = contacts.concat(p.collide());\r\n    }\r\n    return contacts;\r\n  }\r\n\r\n  getClosestLineBetween(other: Collider): LineSegment {\r\n    const colliders = this.getColliders();\r\n    const lines: LineSegment[] = [];\r\n    if (other instanceof CompositeCollider) {\r\n      const otherColliders = other.getColliders();\r\n      for (const colliderA of colliders) {\r\n        for (const colliderB of otherColliders) {\r\n          const maybeLine = colliderA.getClosestLineBetween(colliderB);\r\n          if (maybeLine) {\r\n            lines.push(maybeLine);\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      for (const collider of colliders) {\r\n        const maybeLine = other.getClosestLineBetween(collider);\r\n        if (maybeLine) {\r\n          lines.push(maybeLine);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (lines.length) {\r\n      let minLength = lines[0].getLength();\r\n      let minLine = lines[0];\r\n      for (const line of lines) {\r\n        const length = line.getLength();\r\n        if (length < minLength) {\r\n          minLength = length;\r\n          minLine = line;\r\n        }\r\n      }\r\n      return minLine;\r\n    }\r\n    return null;\r\n  }\r\n  contains(point: Vector): boolean {\r\n    const colliders = this.getColliders();\r\n    for (const collider of colliders) {\r\n      if (collider.contains(point)) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n  rayCast(ray: Ray, max?: number): RayCastHit | null {\r\n    const colliders = this.getColliders();\r\n    const hits: RayCastHit[] = [];\r\n    for (const collider of colliders) {\r\n      const hit = collider.rayCast(ray, max);\r\n      if (hit) {\r\n        hits.push(hit);\r\n      }\r\n    }\r\n    if (hits.length) {\r\n      let minHit = hits[0];\r\n      let minDistance = minHit.point.dot(ray.dir);\r\n      for (const hit of hits) {\r\n        const distance = ray.dir.dot(hit.point);\r\n        if (distance < minDistance) {\r\n          minHit = hit;\r\n          minDistance = distance;\r\n        }\r\n      }\r\n      return minHit;\r\n    }\r\n    return null;\r\n  }\r\n  project(axis: Vector): Projection {\r\n    const colliders = this.getColliders();\r\n    const projections: Projection[] = [];\r\n    for (const collider of colliders) {\r\n      const proj = collider.project(axis);\r\n      if (proj) {\r\n        projections.push(proj);\r\n      }\r\n    }\r\n    // Merge all proj's on the same axis\r\n    if (projections.length) {\r\n      const newProjection = new Projection(projections[0].min, projections[0].max);\r\n      for (const proj of projections) {\r\n        newProjection.min = Math.min(proj.min, newProjection.min);\r\n        newProjection.max = Math.max(proj.max, newProjection.max);\r\n      }\r\n      return newProjection;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  update(transform: Transform): void {\r\n    if (transform) {\r\n      const colliders = this.getColliders();\r\n      for (const collider of colliders) {\r\n        collider.owner = this.owner;\r\n        collider.update(transform);\r\n      }\r\n    }\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number; pointSize: number }) {\r\n    const colliders = this.getColliders();\r\n    ex.save();\r\n    ex.translate(this.offset.x, this.offset.y);\r\n    for (const collider of colliders) {\r\n      collider.debug(ex, color, options);\r\n    }\r\n    ex.restore();\r\n  }\r\n\r\n  clone(): Collider {\r\n    const result = new CompositeCollider(this._colliders.map((c) => c.clone()));\r\n    result.offset = this.offset.clone();\r\n    return result;\r\n  }\r\n}\r\n","import { AffineMatrix } from './affine-matrix';\r\nimport { Vector } from './vector';\r\n\r\n/**\r\n * A 2D line segment\r\n */\r\n\r\nexport class LineSegment {\r\n  /**\r\n   * @param begin  The starting point of the line segment\r\n   * @param end  The ending point of the line segment\r\n   */\r\n  constructor(\r\n    public begin: Vector,\r\n    public end: Vector\r\n  ) {}\r\n\r\n  clone(dest?: LineSegment): LineSegment {\r\n    const result = dest || new LineSegment(this.begin.clone(), this.end.clone());\r\n    result.begin = this.begin.clone(result.begin);\r\n    result.end = this.end.clone(result.end);\r\n    return result;\r\n  }\r\n\r\n  transform(matrix: AffineMatrix, dest?: LineSegment): LineSegment {\r\n    const result = dest || new LineSegment(Vector.Zero, Vector.Zero);\r\n    result.begin = matrix.multiply(this.begin, result.begin);\r\n    result.end = matrix.multiply(this.end, result.end);\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Gets the raw slope (m) of the line. Will return (+/-)Infinity for vertical lines.\r\n   */\r\n  public get slope() {\r\n    return (this.end.y - this.begin.y) / (this.end.x - this.begin.x);\r\n  }\r\n\r\n  /**\r\n   * Gets the Y-intercept (b) of the line. Will return (+/-)Infinity if there is no intercept.\r\n   */\r\n  public get intercept() {\r\n    return this.begin.y - this.slope * this.begin.x;\r\n  }\r\n\r\n  private _normal: Vector;\r\n  /**\r\n   * Gets the normal of the line\r\n   */\r\n  public normal(): Vector {\r\n    if (this._normal) {\r\n      return this._normal;\r\n    }\r\n    return (this._normal = this.end.sub(this.begin).normal());\r\n  }\r\n\r\n  private _dir: Vector;\r\n  public dir(): Vector {\r\n    if (this._dir) {\r\n      return this._dir;\r\n    }\r\n    return (this._dir = this.end.sub(this.begin));\r\n  }\r\n\r\n  public getPoints(): Vector[] {\r\n    return [this.begin, this.end];\r\n  }\r\n\r\n  private _slope: Vector;\r\n  /**\r\n   * Returns the slope of the line in the form of a vector of length 1\r\n   */\r\n  public getSlope(): Vector {\r\n    if (this._slope) {\r\n      return this._slope;\r\n    }\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    const distance = begin.distance(end);\r\n    return (this._slope = end.sub(begin).scale(1 / distance));\r\n  }\r\n\r\n  /**\r\n   * Returns the edge of the line as vector, the length of the vector is the length of the edge\r\n   */\r\n  public getEdge(): Vector {\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    return end.sub(begin);\r\n  }\r\n\r\n  /**\r\n   * Returns the length of the line segment in pixels\r\n   */\r\n  public getLength(): number {\r\n    const begin = this.begin;\r\n    const end = this.end;\r\n    const distance = begin.distance(end);\r\n    return distance;\r\n  }\r\n\r\n  /**\r\n   * Returns the midpoint of the edge\r\n   */\r\n  public get midpoint(): Vector {\r\n    return this.begin.add(this.end).scale(0.5);\r\n  }\r\n\r\n  /**\r\n   * Flips the direction of the line segment\r\n   */\r\n  public flip(): LineSegment {\r\n    return new LineSegment(this.end, this.begin);\r\n  }\r\n\r\n  /**\r\n   * Tests if a given point is below the line, points in the normal direction above the line are considered above.\r\n   * @param point\r\n   */\r\n  public below(point: Vector): boolean {\r\n    const above2 = (this.end.x - this.begin.x) * (point.y - this.begin.y) - (this.end.y - this.begin.y) * (point.x - this.begin.x);\r\n    return above2 >= 0;\r\n  }\r\n\r\n  /**\r\n   * Returns the clip point\r\n   * @param sideVector Vector that traces the line\r\n   * @param length Length to clip along side\r\n   */\r\n  public clip(sideVector: Vector, length: number, normalize = true): LineSegment {\r\n    let dir = sideVector;\r\n    if (normalize) {\r\n      dir = dir.normalize();\r\n    }\r\n\r\n    const near = dir.dot(this.begin) - length;\r\n    const far = dir.dot(this.end) - length;\r\n\r\n    const results = [];\r\n    if (near <= 0) {\r\n      results.push(this.begin);\r\n    }\r\n    if (far <= 0) {\r\n      results.push(this.end);\r\n    }\r\n\r\n    if (near * far < 0) {\r\n      const clipTime = near / (near - far);\r\n      results.push(this.begin.add(this.end.sub(this.begin).scale(clipTime)));\r\n    }\r\n    if (results.length !== 2) {\r\n      return null;\r\n    }\r\n\r\n    return new LineSegment(results[0], results[1]);\r\n  }\r\n\r\n  /**\r\n   * Find the perpendicular distance from the line to a point\r\n   * https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line\r\n   * @param point\r\n   */\r\n  public distanceToPoint(point: Vector, signed: boolean = false) {\r\n    const x0 = point.x;\r\n    const y0 = point.y;\r\n\r\n    const l = this.getLength();\r\n\r\n    const dy = this.end.y - this.begin.y;\r\n    const dx = this.end.x - this.begin.x;\r\n    const distance = (dy * x0 - dx * y0 + this.end.x * this.begin.y - this.end.y * this.begin.x) / l;\r\n    return signed ? distance : Math.abs(distance);\r\n  }\r\n\r\n  /**\r\n   * Find the perpendicular line from the line to a point\r\n   * https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line\r\n   * (a - p) - ((a - p) * n)n\r\n   * a is a point on the line\r\n   * p is the arbitrary point above the line\r\n   * n is a unit vector in direction of the line\r\n   * @param point\r\n   */\r\n  public findVectorToPoint(point: Vector): Vector {\r\n    const aMinusP = this.begin.sub(point);\r\n    const n = this.getSlope();\r\n\r\n    return aMinusP.sub(n.scale(aMinusP.dot(n)));\r\n  }\r\n\r\n  /**\r\n   * Finds a point on the line given only an X or a Y value. Given an X value, the function returns\r\n   * a new point with the calculated Y value and vice-versa.\r\n   * @param x The known X value of the target point\r\n   * @param y The known Y value of the target point\r\n   * @returns A new point with the other calculated axis value\r\n   */\r\n  public findPoint(x: number = null, y: number = null): Vector {\r\n    const m = this.slope;\r\n    const b = this.intercept;\r\n\r\n    if (x !== null) {\r\n      return new Vector(x, m * x + b);\r\n    } else if (y !== null) {\r\n      return new Vector((y - b) / m, y);\r\n    } else {\r\n      throw new Error('You must provide an X or a Y value');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Whether or not the given point lies on this line. This method is precise by default\r\n   * meaning the point must lie exactly on the line. Adjust threshold to\r\n   * loosen the strictness of the check for floating-point calculations.\r\n   */\r\n  public hasPoint(x: number, y: number, threshold?: number): boolean;\r\n\r\n  /**\r\n   * Whether or not the given point lies on this line. This method is precise by default\r\n   * meaning the point must lie exactly on the line. Adjust threshold to\r\n   * loosen the strictness of the check for floating-point calculations.\r\n   */\r\n  public hasPoint(v: Vector, threshold?: number): boolean;\r\n\r\n  /**\r\n   * @see http://stackoverflow.com/a/11908158/109458\r\n   */\r\n  public hasPoint(): boolean {\r\n    let currPoint: Vector;\r\n    let threshold = 0;\r\n\r\n    if (typeof arguments[0] === 'number' && typeof arguments[1] === 'number') {\r\n      currPoint = new Vector(arguments[0], arguments[1]);\r\n      threshold = arguments[2] || 0;\r\n    } else if (arguments[0] instanceof Vector) {\r\n      currPoint = arguments[0];\r\n      threshold = arguments[1] || 0;\r\n    } else {\r\n      throw 'Could not determine the arguments for Vector.hasPoint';\r\n    }\r\n\r\n    const dxc = currPoint.x - this.begin.x;\r\n    const dyc = currPoint.y - this.begin.y;\r\n\r\n    const dx1 = this.end.x - this.begin.x;\r\n    const dy1 = this.end.y - this.begin.y;\r\n\r\n    const cross = dxc * dy1 - dyc * dx1;\r\n\r\n    // check whether point lines on the line\r\n    if (Math.abs(cross) > threshold) {\r\n      return false;\r\n    }\r\n\r\n    // check whether point lies in-between start and end\r\n    if (Math.abs(dx1) >= Math.abs(dy1)) {\r\n      return dx1 > 0 ? this.begin.x <= currPoint.x && currPoint.x <= this.end.x : this.end.x <= currPoint.x && currPoint.x <= this.begin.x;\r\n    } else {\r\n      return dy1 > 0 ? this.begin.y <= currPoint.y && currPoint.y <= this.end.y : this.end.y <= currPoint.y && currPoint.y <= this.begin.y;\r\n    }\r\n  }\r\n}\r\n","import { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { clamp } from '../../Math/util';\r\n\r\n/**\r\n * Finds the closest line segment between two given line segments.\r\n */\r\nfunction ClosestLine(line1: LineSegment, line2: LineSegment) {\r\n  // https://math.stackexchange.com/questions/1993953/closest-points-between-2-lines-in-2d\r\n  const EPSILON = 1e-9;\r\n\r\n  const line1Dir = line1.dir();\r\n  const line2Dir = line2.dir();\r\n\r\n  const d1Squared = line1Dir.dot(line1Dir);\r\n  const d2Squared = line2Dir.dot(line2Dir);\r\n\r\n  if (d1Squared < EPSILON && d2Squared < EPSILON) {\r\n    return new LineSegment(line1.begin, line2.begin);\r\n  }\r\n\r\n  if (d1Squared < EPSILON) {\r\n    const t = clamp(line2Dir.dot(line1.begin.sub(line2.begin)) / d2Squared, 0, 1);\r\n    const closestPoint = line2.begin.add(line2Dir.scale(t));\r\n    return new LineSegment(line1.begin, closestPoint);\r\n  }\r\n\r\n  if (d2Squared < EPSILON) {\r\n    const t = clamp(line1Dir.dot(line2.begin.sub(line1.begin)) / d1Squared, 0, 1);\r\n    const closestPoint = line1.begin.add(line1Dir.scale(t));\r\n    return new LineSegment(closestPoint, line2.begin);\r\n  }\r\n\r\n  const r = line1.begin.sub(line2.begin);\r\n  const a = d1Squared;\r\n  const e = d2Squared;\r\n  const f = line2Dir.dot(r);\r\n\r\n  const denom = a * e - Math.pow(line1Dir.dot(line2Dir), 2);\r\n\r\n  let s = 0;\r\n  let t = 0;\r\n\r\n  if (Math.abs(denom) > EPSILON) {\r\n    s = clamp((line1Dir.dot(line2Dir) * f - e * line1Dir.dot(r)) / denom, 0, 1);\r\n  } else {\r\n    // lines are parallel\r\n    s = clamp(line1Dir.dot(r) / a, 0, 1);\r\n  }\r\n\r\n  if (Math.abs(e) > EPSILON) {\r\n    t = clamp((line1Dir.dot(line2Dir) * s + f) / e, 0, 1);\r\n  } else {\r\n    // line2 is a degenerate point\r\n    t = 0;\r\n  }\r\n\r\n  const closestPointOnLine1 = line1.begin.add(line1Dir.scale(s));\r\n  const closestPointOnLine2 = line2.begin.add(line2Dir.scale(t));\r\n\r\n  return new LineSegment(closestPointOnLine1, closestPointOnLine2);\r\n}\r\n\r\nexport const ClosestLineJumpTable = {\r\n  PolygonPolygonClosestLine(polygonA: PolygonCollider, polygonB: PolygonCollider) {\r\n    const aSides = polygonA.getSides();\r\n    const bSides = polygonB.getSides();\r\n\r\n    let minDistance = Number.MAX_VALUE;\r\n    let closestLine: LineSegment | null = null;\r\n\r\n    for (let i = 0; i < aSides.length; i++) {\r\n      for (let j = 0; j < bSides.length; j++) {\r\n        const line = ClosestLine(aSides[i], bSides[j]);\r\n        const distance = line.getLength();\r\n\r\n        if (distance < minDistance) {\r\n          minDistance = distance;\r\n          closestLine = line;\r\n        }\r\n      }\r\n    }\r\n\r\n    return closestLine;\r\n  },\r\n\r\n  PolygonEdgeClosestLine(polygon: PolygonCollider, edge: EdgeCollider) {\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = edge.worldPos;\r\n    const otherDirection = otherWorldPos.sub(polygon.worldPos);\r\n\r\n    const rayTowardsOther = new Ray(polygon.worldPos, otherDirection);\r\n\r\n    const thisPoint = polygon.rayCast(rayTowardsOther).point.add(rayTowardsOther.dir.scale(0.1));\r\n\r\n    const thisFace = polygon.getClosestFace(thisPoint);\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n\r\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\r\n    const edgeLine = edge.asLine();\r\n\r\n    return ClosestLine(thisFace.face, edgeLine);\r\n  },\r\n\r\n  PolygonCircleClosestLine(polygon: PolygonCollider, circle: CircleCollider) {\r\n    // https://math.stackexchange.com/questions/1919177/how-to-find-point-on-line-closest-to-sphere\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = circle.worldPos;\r\n    const otherDirection = otherWorldPos.sub(polygon.worldPos);\r\n\r\n    const rayTowardsOther = new Ray(polygon.worldPos, otherDirection.normalize());\r\n\r\n    const thisPoint = polygon.rayCast(rayTowardsOther).point.add(rayTowardsOther.dir.scale(0.1));\r\n\r\n    const thisFace = polygon.getClosestFace(thisPoint);\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const p0 = thisFace.face.begin;\r\n    const u = thisFace.face.getEdge();\r\n\r\n    // Time of minimum distance\r\n    let t = (u.x * (otherWorldPos.x - p0.x) + u.y * (otherWorldPos.y - p0.y)) / (u.x * u.x + u.y * u.y);\r\n\r\n    // If time of minimum is past the edge clamp\r\n    if (t > 1) {\r\n      t = 1;\r\n    } else if (t < 0) {\r\n      t = 0;\r\n    }\r\n\r\n    // Minimum distance\r\n    const d = Math.sqrt(Math.pow(p0.x + u.x * t - otherWorldPos.x, 2) + Math.pow(p0.y + u.y * t - otherWorldPos.y, 2)) - circle.radius;\r\n\r\n    const circlex = ((p0.x + u.x * t - otherWorldPos.x) * circle.radius) / (circle.radius + d);\r\n    const circley = ((p0.y + u.y * t - otherWorldPos.y) * circle.radius) / (circle.radius + d);\r\n    return new LineSegment(u.scale(t).add(p0), new Vector(otherWorldPos.x + circlex, otherWorldPos.y + circley));\r\n  },\r\n\r\n  CircleCircleClosestLine(circleA: CircleCollider, circleB: CircleCollider) {\r\n    // Find the 2 closest faces on each polygon\r\n    const otherWorldPos = circleB.worldPos;\r\n    const otherDirection = otherWorldPos.sub(circleA.worldPos);\r\n\r\n    const thisWorldPos = circleA.worldPos;\r\n    const thisDirection = thisWorldPos.sub(circleB.worldPos);\r\n\r\n    const rayTowardsOther = new Ray(circleA.worldPos, otherDirection);\r\n    const rayTowardsThis = new Ray(circleB.worldPos, thisDirection);\r\n\r\n    const thisPoint = circleA.rayCast(rayTowardsOther);\r\n    const otherPoint = circleB.rayCast(rayTowardsThis);\r\n\r\n    return new LineSegment(thisPoint.point, otherPoint.point);\r\n  },\r\n\r\n  CircleEdgeClosestLine(circle: CircleCollider, edge: EdgeCollider) {\r\n    // https://math.stackexchange.com/questions/1919177/how-to-find-point-on-line-closest-to-sphere\r\n    const circleWorldPos = circle.worldPos;\r\n\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const edgeLine = edge.asLine();\r\n    const edgeStart = edgeLine.begin;\r\n    const edgeVector = edgeLine.getEdge();\r\n    const p0 = edgeStart;\r\n    const u = edgeVector;\r\n\r\n    // Time of minimum distance\r\n    let t = (u.x * (circleWorldPos.x - p0.x) + u.y * (circleWorldPos.y - p0.y)) / (u.x * u.x + u.y * u.y);\r\n\r\n    // If time of minimum is past the edge clamp to edge\r\n    if (t > 1) {\r\n      t = 1;\r\n    } else if (t < 0) {\r\n      t = 0;\r\n    }\r\n\r\n    // Minimum distance\r\n    const d = Math.sqrt(Math.pow(p0.x + u.x * t - circleWorldPos.x, 2) + Math.pow(p0.y + u.y * t - circleWorldPos.y, 2)) - circle.radius;\r\n\r\n    const circlex = ((p0.x + u.x * t - circleWorldPos.x) * circle.radius) / (circle.radius + d);\r\n    const circley = ((p0.y + u.y * t - circleWorldPos.y) * circle.radius) / (circle.radius + d);\r\n    return new LineSegment(u.scale(t).add(p0), new Vector(circleWorldPos.x + circlex, circleWorldPos.y + circley));\r\n  },\r\n\r\n  EdgeEdgeClosestLine(edgeA: EdgeCollider, edgeB: EdgeCollider) {\r\n    // L1 = P(s) = p0 + s * u, where s is time and p0 is the start of the line\r\n    const edgeLineA = edgeA.asLine();\r\n\r\n    // L2 = Q(t) = q0 + t * v, where t is time and q0 is the start of the line\r\n    const edgeLineB = edgeB.asLine();\r\n\r\n    return ClosestLine(edgeLineA, edgeLineB);\r\n  }\r\n};\r\n","import { BoundingBox } from '../BoundingBox';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\n\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Color } from '../../Color';\r\nimport { Collider } from './Collider';\r\n\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { BodyComponent } from '../Index';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\nimport { approximatelyEqual } from '../../Math/util';\r\n\r\nexport interface CircleColliderOptions {\r\n  /**\r\n   * Optional pixel offset to shift the circle relative to the collider, by default (0, 0).\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Required radius of the circle\r\n   */\r\n  radius: number;\r\n}\r\n\r\n/**\r\n * This is a circle collider for the excalibur rigid body physics simulation\r\n */\r\nexport class CircleCollider extends Collider {\r\n  /**\r\n   * Position of the circle relative to the collider, by default (0, 0).\r\n   */\r\n  public offset: Vector = Vector.Zero;\r\n\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  public get worldPos(): Vector {\r\n    return this._globalMatrix.getPosition();\r\n  }\r\n\r\n  private _naturalRadius: number;\r\n\r\n  private _radius: number | undefined;\r\n  /**\r\n   * Get the radius of the circle\r\n   */\r\n  public get radius(): number {\r\n    if (this._radius) {\r\n      return this._radius;\r\n    }\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    // This is a trade off, the alternative is retooling circles to support ellipse collisions\r\n    return (this._radius = this._naturalRadius * Math.min(scale.x, scale.y));\r\n  }\r\n\r\n  /**\r\n   * Set the radius of the circle\r\n   */\r\n  public set radius(val: number) {\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    // This is a trade off, the alternative is retooling circles to support ellipse collisions\r\n    this._naturalRadius = val / Math.min(scale.x, scale.y);\r\n    this._localBoundsDirty = true;\r\n    this._radius = val;\r\n  }\r\n\r\n  private _transform: Transform;\r\n\r\n  constructor(options: CircleColliderOptions) {\r\n    super();\r\n    this.offset = options.offset || Vector.Zero;\r\n    this.radius = options.radius || 0;\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this shape, not associated with any collider\r\n   */\r\n  public clone(): CircleCollider {\r\n    return new CircleCollider({\r\n      offset: this.offset.clone(),\r\n      radius: this.radius\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collider in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    return this._globalMatrix.getPosition();\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collider\r\n   */\r\n  public contains(point: Vector): boolean {\r\n    const pos = this._transform?.pos ?? this.offset;\r\n    const distance = pos.distance(point);\r\n    if (distance <= this.radius) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Casts a ray at the Circle collider and returns the nearest point of collision\r\n   * @param ray\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): RayCastHit | null {\r\n    // https://en.wikipedia.org/wiki/Intersection_(geometry)#A_line_and_a_circle\r\n    const c = this.center;\r\n    const dir = ray.dir;\r\n    const orig = ray.pos;\r\n\r\n    const u = c.sub(orig);\r\n\r\n    const u1 = dir.scale(u.dot(dir));\r\n    const u2 = u.sub(u1);\r\n\r\n    const d = u2.magnitude;\r\n\r\n    if (d > this.radius) {\r\n      return null;\r\n    } else {\r\n      // tangent case\r\n      let toi = 0;\r\n      if (approximatelyEqual(d, this.radius, 0.0001)) {\r\n        toi = -dir.dot(orig.sub(c));\r\n        if (toi > 0 && toi < max) {\r\n          const point = ray.getPoint(toi);\r\n          return {\r\n            point,\r\n            normal: point.sub(c).normalize(),\r\n            collider: this,\r\n            body: this.owner?.get(BodyComponent),\r\n            distance: toi\r\n          } satisfies RayCastHit;\r\n        }\r\n        return null;\r\n      } else {\r\n        // two point\r\n        const discriminant = Math.sqrt(Math.pow(dir.dot(orig.sub(c)), 2) - Math.pow(orig.sub(c).distance(), 2) + Math.pow(this.radius, 2));\r\n\r\n        const toi1 = -dir.dot(orig.sub(c)) + discriminant;\r\n        const toi2 = -dir.dot(orig.sub(c)) - discriminant;\r\n\r\n        const positiveToi: number[] = [];\r\n        if (toi1 >= 0) {\r\n          positiveToi.push(toi1);\r\n        }\r\n\r\n        if (toi2 >= 0) {\r\n          positiveToi.push(toi2);\r\n        }\r\n\r\n        const minToi = Math.min(...positiveToi);\r\n        if (minToi <= max) {\r\n          const point = ray.getPoint(minToi);\r\n          return {\r\n            point,\r\n            normal: point.sub(c).normalize(),\r\n            collider: this,\r\n            body: this.owner?.get(BodyComponent),\r\n            distance: minToi\r\n          } satisfies RayCastHit;\r\n        }\r\n        return null;\r\n      }\r\n    }\r\n  }\r\n\r\n  public getClosestLineBetween(shape: Collider): LineSegment {\r\n    if (shape instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.CircleCircleClosestLine(this, shape);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonCircleClosestLine(shape, this).flip();\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.CircleEdgeClosestLine(this, shape).flip();\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public collide(collider: Collider): CollisionContact[] {\r\n    if (collider instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCircleCircle(this, collider);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollideCirclePolygon(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollideCircleEdge(this, collider);\r\n    } else {\r\n      throw new Error(`Circle could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    return this.center.add(direction.normalize().scale(this.radius));\r\n  }\r\n\r\n  /**\r\n   * Find the local point on the shape in the direction specified\r\n   * @param direction\r\n   */\r\n  public getFurthestLocalPoint(direction: Vector): Vector {\r\n    const dir = direction.normalize();\r\n    return dir.scale(this.radius);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the circle collider in world coordinates\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    return this.localBounds.transform(this._globalMatrix);\r\n  }\r\n\r\n  private _localBoundsDirty = true;\r\n  private _localBounds: BoundingBox;\r\n  /**\r\n   * Get the axis aligned bounding box for the circle collider in local coordinates\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    if (this._localBoundsDirty) {\r\n      this._localBounds = new BoundingBox(-this._naturalRadius, -this._naturalRadius, +this._naturalRadius, +this._naturalRadius);\r\n      this._localBoundsDirty = false;\r\n    }\r\n    return this._localBounds;\r\n  }\r\n\r\n  /**\r\n   * Get axis not implemented on circles, since there are infinite axis in a circle\r\n   */\r\n  public get axes(): Vector[] {\r\n    return [];\r\n  }\r\n\r\n  /**\r\n   * Returns the moment of inertia of a circle given it's mass\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    return (mass * this.radius * this.radius) / 2;\r\n  }\r\n\r\n  /* istanbul ignore next */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n    this._radius = undefined;\r\n  }\r\n\r\n  /**\r\n   * Project the circle along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const scalars = [];\r\n    const point = this.center;\r\n    const dotProduct = point.dot(axis);\r\n    scalars.push(dotProduct);\r\n    scalars.push(dotProduct + this.radius);\r\n    scalars.push(dotProduct - this.radius);\r\n    return new Projection(Math.min.apply(Math, scalars), Math.max.apply(Math, scalars));\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number }) {\r\n    const { lineWidth } = { ...{ lineWidth: 1 }, ...options };\r\n    const tx = this._transform;\r\n    const scale = tx?.globalScale ?? Vector.One;\r\n    const rotation = tx?.globalRotation ?? 0;\r\n    const pos = tx?.globalPos ?? Vector.Zero;\r\n    ex.save();\r\n    ex.translate(pos.x, pos.y);\r\n    ex.rotate(rotation);\r\n    ex.scale(scale.x, scale.y);\r\n    ex.drawCircle(this.offset ?? Vector.Zero, this._naturalRadius, Color.Transparent, color, lineWidth);\r\n    ex.restore();\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Collider } from '../Colliders/Collider';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Pair } from './Pair';\r\nimport { SeparationInfo } from '../Colliders/SeparatingAxis';\r\nimport { BodyComponent } from '../BodyComponent';\r\n\r\n/**\r\n * Collision contacts are used internally by Excalibur to resolve collision between colliders. This\r\n * Pair prevents collisions from being evaluated more than one time\r\n */\r\nexport class CollisionContact {\r\n  private _canceled = false;\r\n\r\n  /**\r\n   * Currently the ids between colliders\r\n   */\r\n  readonly id: string;\r\n\r\n  /**\r\n   * The first collider in the collision\r\n   */\r\n  colliderA: Collider;\r\n\r\n  /**\r\n   * The second collider in the collision\r\n   */\r\n  colliderB: Collider;\r\n\r\n  /**\r\n   * The minimum translation vector to resolve overlap, pointing away from colliderA\r\n   */\r\n  mtv: Vector;\r\n\r\n  /**\r\n   * World space contact points between colliderA and colliderB\r\n   */\r\n  points: Vector[];\r\n\r\n  /**\r\n   * Local space contact points between colliderA and colliderB\r\n   */\r\n  localPoints: Vector[];\r\n\r\n  /**\r\n   * The collision normal, pointing away from colliderA\r\n   */\r\n  normal: Vector;\r\n\r\n  /**\r\n   * The collision tangent\r\n   */\r\n  tangent: Vector;\r\n\r\n  /**\r\n   * Information about the specifics of the collision contact separation\r\n   */\r\n  info: SeparationInfo;\r\n\r\n  bodyA: BodyComponent | null = null;\r\n  bodyB: BodyComponent | null = null;\r\n\r\n  constructor(\r\n    colliderA: Collider,\r\n    colliderB: Collider,\r\n    mtv: Vector,\r\n    normal: Vector,\r\n    tangent: Vector,\r\n    points: Vector[],\r\n    localPoints: Vector[],\r\n    info: SeparationInfo\r\n  ) {\r\n    this.colliderA = colliderA;\r\n    this.colliderB = colliderB;\r\n    this.mtv = mtv;\r\n    this.normal = normal;\r\n    this.tangent = tangent;\r\n    this.points = points;\r\n    this.localPoints = localPoints;\r\n    this.info = info;\r\n    this.id = Pair.calculatePairHash(colliderA.id, colliderB.id);\r\n    if (colliderA.composite || colliderB.composite) {\r\n      // Add on the parent composite pair for start/end contact if 'together\r\n      const colliderAId = colliderA.composite?.compositeStrategy === 'separate' ? colliderA.id : colliderA.composite?.id ?? colliderA.id;\r\n      const colliderBId = colliderB.composite?.compositeStrategy === 'separate' ? colliderB.id : colliderB.composite?.id ?? colliderB.id;\r\n      this.id += '|' + Pair.calculatePairHash(colliderAId, colliderBId);\r\n    }\r\n    if (this.colliderA.owner) {\r\n      this.bodyA = this.colliderA.owner.get(BodyComponent);\r\n    }\r\n    if (this.colliderB.owner) {\r\n      this.bodyB = this.colliderB.owner.get(BodyComponent);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Match contact awake state, except if body's are Fixed\r\n   */\r\n  public matchAwake(): void {\r\n    const bodyA = this.bodyA;\r\n    const bodyB = this.bodyB;\r\n    if (bodyA && bodyB) {\r\n      if (bodyA.isSleeping !== bodyB.isSleeping) {\r\n        if (bodyA.isSleeping && bodyA.collisionType !== CollisionType.Fixed && bodyB.sleepMotion >= bodyA.wakeThreshold) {\r\n          bodyA.isSleeping = false;\r\n        }\r\n        if (bodyB.isSleeping && bodyB.collisionType !== CollisionType.Fixed && bodyA.sleepMotion >= bodyB.wakeThreshold) {\r\n          bodyB.isSleeping = false;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public isCanceled() {\r\n    return this._canceled;\r\n  }\r\n\r\n  public cancel(): void {\r\n    this._canceled = true;\r\n  }\r\n\r\n  /**\r\n   * Biases the contact so that the given collider is colliderA\r\n   */\r\n  public bias(collider: Collider) {\r\n    if (collider !== this.colliderA && collider !== this.colliderB) {\r\n      throw new Error('Collider must be either colliderA or colliderB from this contact');\r\n    }\r\n\r\n    if (collider === this.colliderA) {\r\n      return this;\r\n    }\r\n\r\n    const colliderA = this.colliderA;\r\n    const colliderB = this.colliderB;\r\n\r\n    this.colliderB = colliderA;\r\n    this.colliderA = colliderB;\r\n    this.mtv = this.mtv.negate();\r\n    this.normal = this.normal.negate();\r\n    this.tangent = this.tangent.negate();\r\n\r\n    return this;\r\n  }\r\n}\r\n","import { LineSegment } from '../../Math/line-segment';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Collider } from './Collider';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Pool } from '../../Util/Pool';\r\n\r\n/**\r\n * Specific information about a contact and it's separation\r\n */\r\nexport class SeparationInfo {\r\n  /**\r\n   * Collider A\r\n   */\r\n  collider: Collider;\r\n\r\n  /**\r\n   * Signed value (negative means overlap, positive no overlap)\r\n   */\r\n  separation: number;\r\n\r\n  /**\r\n   * Axis of separation from the collider's perspective\r\n   */\r\n  axis: Vector = vec(0, 0);\r\n\r\n  /**\r\n   * Local axis of separation from the collider's perspective\r\n   */\r\n  localAxis?: Vector = vec(0, 0);\r\n\r\n  /**\r\n   * Side of separation (reference) from the collider's perspective\r\n   */\r\n\r\n  side?: LineSegment = new LineSegment(vec(0, 0), vec(0, 0));\r\n\r\n  /**\r\n   * Local side of separation (reference) from the collider's perspective\r\n   */\r\n  localSide?: LineSegment = new LineSegment(vec(0, 0), vec(0, 0));\r\n\r\n  /**\r\n   * Index of the separation side (reference) from the collider's perspective\r\n   */\r\n  sideId?: number;\r\n\r\n  /**\r\n   * Point on collider B (incident point)\r\n   */\r\n  point: Vector = vec(0, 0);\r\n\r\n  /**\r\n   * Local point on collider B (incident point)\r\n   */\r\n  localPoint?: Vector = vec(0, 0);\r\n}\r\n\r\nexport class SeparatingAxis {\r\n  static SeparationPool = new Pool(\r\n    () => new SeparationInfo(),\r\n    (i) => i, // no recycle\r\n    500\r\n  );\r\n  private static _ZERO = vec(0, 0);\r\n  private static _SCRATCH_POINT = vec(0, 0);\r\n  private static _SCRATCH_SUB_POINT = vec(0, 0);\r\n  private static _SCRATCH_NORMAL = vec(0, 0);\r\n  private static _SCRATCH_MATRIX = AffineMatrix.identity();\r\n  static findPolygonPolygonSeparation(polyA: PolygonCollider, polyB: PolygonCollider): SeparationInfo {\r\n    // if polyB has 0 scale we need to hop back to degenerate separation\r\n    if (polyB.transform.matrix.determinant() === 0) {\r\n      return SeparatingAxis.findPolygonPolygonSeparationDegenerate(polyA, polyB);\r\n    }\r\n\r\n    // Multi contact from SAT\r\n    // https://gamedev.stackexchange.com/questions/111390/multiple-contacts-for-sat-collision-detection\r\n    // do a SAT test to find a min axis if it exists\r\n\r\n    let bestSeparation = -Number.MAX_VALUE;\r\n    let bestSideIndex: number = -1;\r\n    let localPoint: Vector;\r\n    // Work inside polyB reference frame\r\n    // inv polyB converts to local space from polyA world space\r\n    const toPolyBSpace = polyB.transform.inverse.multiply(polyA.transform.matrix, SeparatingAxis._SCRATCH_MATRIX);\r\n    const toPolyBSpaceRotation = toPolyBSpace.getRotation();\r\n\r\n    const normalsA = polyA.normals;\r\n    const pointsA = polyA.points;\r\n    const pointsB = polyB.points;\r\n    for (let pointsAIndex = 0; pointsAIndex < pointsA.length; pointsAIndex++) {\r\n      const normal = normalsA[pointsAIndex].rotate(toPolyBSpaceRotation, SeparatingAxis._ZERO, SeparatingAxis._SCRATCH_NORMAL);\r\n      const point = toPolyBSpace.multiply(pointsA[pointsAIndex], SeparatingAxis._SCRATCH_POINT);\r\n\r\n      // For every point in polyB\r\n      // We want to see how much overlap there is on the axis provided by the normal\r\n      // We want to find the minimum overlap among all points\r\n      let smallestPointDistance = Number.MAX_VALUE;\r\n      let smallestLocalPoint: Vector;\r\n      for (let pointsBIndex = 0; pointsBIndex < pointsB.length; pointsBIndex++) {\r\n        const distance = normal.dot(pointsB[pointsBIndex].sub(point, SeparatingAxis._SCRATCH_SUB_POINT));\r\n        if (distance < smallestPointDistance) {\r\n          smallestPointDistance = distance;\r\n          smallestLocalPoint = pointsB[pointsBIndex];\r\n        }\r\n      }\r\n\r\n      // We take the maximum overlap as the separation between the\r\n      // A negative separation means there were no gaps between the two shapes\r\n      if (smallestPointDistance > bestSeparation) {\r\n        bestSeparation = smallestPointDistance;\r\n        bestSideIndex = pointsAIndex;\r\n        localPoint = smallestLocalPoint;\r\n      }\r\n    }\r\n\r\n    // TODO can we avoid applying world space transforms?\r\n    const bestSide2 = (bestSideIndex + 1) % pointsA.length;\r\n    const separationInfo = SeparatingAxis.SeparationPool.get();\r\n    separationInfo.collider = polyA;\r\n    separationInfo.separation = bestSeparation;\r\n    if (bestSeparation > 0) {\r\n      // early out because if separation is > 0 then no local point\r\n      return separationInfo;\r\n    }\r\n    normalsA[bestSideIndex].clone(separationInfo.localAxis);\r\n    normalsA[bestSideIndex].rotate(polyA.transform.rotation, SeparatingAxis._ZERO, separationInfo.axis);\r\n    polyA.transform.matrix.multiply(pointsA[bestSideIndex], separationInfo.side.begin);\r\n    polyA.transform.matrix.multiply(pointsA[bestSide2], separationInfo.side.end);\r\n    polyB.transform.matrix.multiply(localPoint, separationInfo.point);\r\n    separationInfo.sideId = bestSideIndex;\r\n    localPoint.clone(separationInfo.localPoint);\r\n    pointsA[bestSideIndex].clone(separationInfo.localSide.begin);\r\n    pointsA[bestSide2].clone(separationInfo.localSide.end);\r\n    return separationInfo;\r\n  }\r\n  static findCirclePolygonSeparation(circle: CircleCollider, polygon: PolygonCollider): Vector | null {\r\n    const axes = polygon.axes;\r\n    const pc = polygon.center;\r\n    // Special SAT with circles\r\n    const polyDir = pc.sub(circle.worldPos);\r\n    const closestPointOnPoly = polygon.getFurthestPoint(polyDir.negate());\r\n    axes.push(closestPointOnPoly.sub(circle.worldPos).normalize());\r\n\r\n    let minOverlap = Number.MAX_VALUE;\r\n    let minAxis = null;\r\n    let minIndex = -1;\r\n    for (let i = 0; i < axes.length; i++) {\r\n      const proj1 = polygon.project(axes[i]);\r\n      const proj2 = circle.project(axes[i]);\r\n      const overlap = proj1.getOverlap(proj2);\r\n      if (overlap <= 0) {\r\n        return null;\r\n      } else {\r\n        if (overlap < minOverlap) {\r\n          minOverlap = overlap;\r\n          minAxis = axes[i];\r\n          minIndex = i;\r\n        }\r\n      }\r\n    }\r\n    if (minIndex < 0) {\r\n      return null;\r\n    }\r\n    return minAxis.normalize().scale(minOverlap);\r\n  }\r\n\r\n  static findPolygonPolygonSeparationDegenerate(polyA: PolygonCollider, polyB: PolygonCollider): SeparationInfo {\r\n    let bestSeparation = -Number.MAX_VALUE;\r\n    let bestSide: LineSegment | null = null;\r\n    let bestAxis: Vector | null = null;\r\n    let bestSideIndex: number = -1;\r\n    let bestOtherPoint: Vector | null = null;\r\n    const sides = polyA.getSides();\r\n    const localSides = polyA.getLocalSides();\r\n    for (let i = 0; i < sides.length; i++) {\r\n      const side = sides[i];\r\n      const axis = side.normal();\r\n      const vertB = polyB.getFurthestPoint(axis.negate());\r\n      // Separation on side i's axis\r\n      // We are looking for the largest separation between poly A's sides\r\n      const vertSeparation = side.distanceToPoint(vertB, true);\r\n      if (vertSeparation > bestSeparation) {\r\n        bestSeparation = vertSeparation;\r\n        bestSide = side;\r\n        bestAxis = axis;\r\n        bestSideIndex = i;\r\n        bestOtherPoint = vertB;\r\n      }\r\n    }\r\n\r\n    return {\r\n      collider: polyA,\r\n      separation: bestAxis ? bestSeparation : 99,\r\n      axis: bestAxis as Vector,\r\n      side: bestSide,\r\n      localSide: localSides[bestSideIndex],\r\n      sideId: bestSideIndex,\r\n      point: bestOtherPoint as Vector,\r\n      localPoint: bestAxis ? polyB.getFurthestLocalPoint(bestAxis!.negate()) : null\r\n    };\r\n  }\r\n}\r\n\r\nSeparatingAxis.SeparationPool.disableWarnings = true;\r\n","import { CircleCollider } from './CircleCollider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { PolygonCollider } from './PolygonCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { SeparatingAxis, SeparationInfo } from './SeparatingAxis';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { TransformComponent } from '../../EntityComponentSystem';\r\nimport { Pair } from '../Detection/Pair';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nconst ScratchZero = Vector.Zero; // TODO constant vector\r\nconst ScratchNormal = Vector.Zero; // TODO constant vector\r\nconst ScratchMatrix = AffineMatrix.identity();\r\n\r\nexport const CollisionJumpTable = {\r\n  CollideCircleCircle(circleA: CircleCollider, circleB: CircleCollider): CollisionContact[] {\r\n    const circleAPos = circleA.worldPos;\r\n    const circleBPos = circleB.worldPos;\r\n    const combinedRadius = circleA.radius + circleB.radius;\r\n    const distance = circleAPos.distance(circleBPos);\r\n\r\n    if (distance > combinedRadius) {\r\n      return [];\r\n    }\r\n\r\n    // negative means overlap\r\n    const separation = combinedRadius - distance;\r\n\r\n    // Normal points from A -> B\r\n    const normal = circleBPos.sub(circleAPos).normalize();\r\n    const tangent = normal.perpendicular();\r\n    const mvt = normal.scale(separation);\r\n\r\n    const point = circleA.getFurthestPoint(normal);\r\n    const local = circleA.getFurthestLocalPoint(normal);\r\n\r\n    const info: SeparationInfo = {\r\n      collider: circleA,\r\n      separation,\r\n      axis: normal,\r\n      point: point\r\n    };\r\n\r\n    return [new CollisionContact(circleA, circleB, mvt, normal, tangent, [point], [local], info)];\r\n  },\r\n\r\n  CollideCirclePolygon(circle: CircleCollider, polygon: PolygonCollider): CollisionContact[] {\r\n    let minAxis = SeparatingAxis.findCirclePolygonSeparation(circle, polygon);\r\n    if (!minAxis) {\r\n      return [];\r\n    }\r\n\r\n    // make sure that the minAxis is pointing away from circle\r\n    const sameDir = minAxis.dot(polygon.center.sub(circle.center));\r\n    minAxis = sameDir < 0 ? minAxis.negate() : minAxis;\r\n\r\n    const point = circle.getFurthestPoint(minAxis);\r\n    const xf = circle.owner?.get(TransformComponent) ?? new TransformComponent();\r\n    const local = xf.applyInverse(point);\r\n    const normal = minAxis.normalize();\r\n\r\n    const info: SeparationInfo = {\r\n      collider: circle,\r\n      separation: -minAxis.magnitude,\r\n      axis: normal,\r\n      point: point,\r\n      localPoint: local,\r\n      side: polygon.findSide(normal.negate()),\r\n      localSide: polygon.findLocalSide(normal.negate())\r\n    };\r\n\r\n    return [new CollisionContact(circle, polygon, minAxis, normal, normal.perpendicular(), [point], [local], info)];\r\n  },\r\n\r\n  CollideCircleEdge(circle: CircleCollider, edge: EdgeCollider): CollisionContact[] {\r\n    // TODO not sure this actually abides by local/world collisions\r\n    // Are edge.begin and edge.end local space or world space? I think they should be local\r\n\r\n    // center of the circle in world pos\r\n    const cc = circle.center;\r\n    // vector in the direction of the edge\r\n    const edgeWorld = edge.asLine();\r\n    const e = edgeWorld.end.sub(edgeWorld.begin);\r\n\r\n    // amount of overlap with the circle's center along the edge direction\r\n    const u = e.dot(edgeWorld.end.sub(cc));\r\n    const v = e.dot(cc.sub(edgeWorld.begin));\r\n    const side = edge.asLine();\r\n    const localSide = edge.asLocalLine();\r\n\r\n    // Potential region A collision (circle is on the left side of the edge, before the beginning)\r\n    if (v <= 0) {\r\n      const da = edgeWorld.begin.sub(cc);\r\n      const dda = da.dot(da); // quick and dirty way of calc'n distance in r^2 terms saves some sqrts\r\n      // save some sqrts\r\n      if (dda > circle.radius * circle.radius) {\r\n        return []; // no collision\r\n      }\r\n\r\n      const normal = da.normalize();\r\n      const separation = circle.radius - Math.sqrt(dda);\r\n\r\n      const info: SeparationInfo = {\r\n        collider: circle,\r\n        separation: separation,\r\n        axis: normal,\r\n        point: side.begin,\r\n        side: side,\r\n        localSide: localSide\r\n      };\r\n\r\n      return [\r\n        new CollisionContact(circle, edge, normal.scale(separation), normal, normal.perpendicular(), [side.begin], [localSide.begin], info)\r\n      ];\r\n    }\r\n\r\n    // Potential region B collision (circle is on the right side of the edge, after the end)\r\n    if (u <= 0) {\r\n      const db = edgeWorld.end.sub(cc);\r\n      const ddb = db.dot(db);\r\n      if (ddb > circle.radius * circle.radius) {\r\n        return [];\r\n      }\r\n\r\n      const normal = db.normalize();\r\n      const separation = circle.radius - Math.sqrt(ddb);\r\n\r\n      const info: SeparationInfo = {\r\n        collider: circle,\r\n        separation: separation,\r\n        axis: normal,\r\n        point: side.end,\r\n        side: side,\r\n        localSide: localSide\r\n      };\r\n\r\n      return [\r\n        new CollisionContact(circle, edge, normal.scale(separation), normal, normal.perpendicular(), [side.end], [localSide.end], info)\r\n      ];\r\n    }\r\n\r\n    // Otherwise potential region AB collision (circle is in the middle of the edge between the beginning and end)\r\n    const den = e.dot(e);\r\n    const pointOnEdge = edgeWorld.begin\r\n      .scale(u)\r\n      .add(edgeWorld.end.scale(v))\r\n      .scale(1 / den);\r\n    const d = cc.sub(pointOnEdge);\r\n\r\n    const dd = d.dot(d);\r\n    if (dd > circle.radius * circle.radius) {\r\n      return []; // no collision\r\n    }\r\n\r\n    let normal = e.perpendicular();\r\n    // flip correct direction\r\n    if (normal.dot(cc.sub(edgeWorld.begin)) < 0) {\r\n      normal.x = -normal.x;\r\n      normal.y = -normal.y;\r\n    }\r\n\r\n    normal = normal.normalize();\r\n    const separation = circle.radius - Math.sqrt(dd);\r\n\r\n    const mvt = normal.scale(separation);\r\n    const info: SeparationInfo = {\r\n      collider: circle,\r\n      separation: separation,\r\n      axis: normal,\r\n      point: pointOnEdge,\r\n      side: side,\r\n      localSide: localSide\r\n    };\r\n\r\n    return [\r\n      new CollisionContact(\r\n        circle,\r\n        edge,\r\n        mvt,\r\n        normal.negate(),\r\n        normal.negate().perpendicular(),\r\n        [pointOnEdge],\r\n        [pointOnEdge.sub(edge.worldPos)],\r\n        info\r\n      )\r\n    ];\r\n  },\r\n\r\n  CollideEdgeEdge(): CollisionContact[] {\r\n    // Edge-edge collision doesn't make sense\r\n    return [];\r\n  },\r\n\r\n  CollidePolygonEdge(polygon: PolygonCollider, edge: EdgeCollider): CollisionContact[] {\r\n    const pc = polygon.center;\r\n    const ec = edge.center;\r\n    const dir = ec.sub(pc).normalize();\r\n\r\n    // build a temporary polygon from the edge to use SAT\r\n    const linePoly = new PolygonCollider({\r\n      points: [edge.begin, edge.end, edge.end.add(dir.scale(100)), edge.begin.add(dir.scale(100))],\r\n      offset: edge.offset\r\n    });\r\n    linePoly.owner = edge.owner;\r\n    const tx = edge.owner?.get(TransformComponent);\r\n    if (tx) {\r\n      linePoly.update(edge.owner.get(TransformComponent).get());\r\n    }\r\n    // Gross hack but poly-poly works well\r\n    const contact = this.CollidePolygonPolygon(polygon, linePoly);\r\n    if (contact.length) {\r\n      // Fudge the contact back to edge\r\n      contact[0].colliderB = edge;\r\n      (contact[0].id as any) = Pair.calculatePairHash(polygon.id, edge.id);\r\n    }\r\n    return contact;\r\n  },\r\n\r\n  CollidePolygonPolygon(polyA: PolygonCollider, polyB: PolygonCollider): CollisionContact[] {\r\n    // Multi contact from SAT\r\n    // https://gamedev.stackexchange.com/questions/111390/multiple-contacts-for-sat-collision-detection\r\n    // do a SAT test to find a min axis if it exists\r\n    const separationA = SeparatingAxis.findPolygonPolygonSeparation(polyA, polyB);\r\n\r\n    // If there is no overlap from boxA's perspective we can end early\r\n    if (separationA.separation > 0) {\r\n      return [];\r\n    }\r\n\r\n    const separationB = SeparatingAxis.findPolygonPolygonSeparation(polyB, polyA);\r\n    // If there is no overlap from boxB's perspective exit now\r\n    if (separationB.separation > 0) {\r\n      return [];\r\n    }\r\n\r\n    // Separations are both negative, we want to pick the least negative (minimal movement)\r\n    const separation = separationA.separation > separationB.separation ? separationA : separationB;\r\n\r\n    // The incident side is the most opposite from the axes of collision on the other collider\r\n    const other = separation.collider === polyA ? polyB : polyA;\r\n    const main = separation.collider === polyA ? polyA : polyB;\r\n\r\n    const toIncidentFrame = other.transform.inverse.multiply(main.transform.matrix, ScratchMatrix);\r\n    const toIncidentFrameRotation = toIncidentFrame.getRotation();\r\n    const referenceEdgeNormal = main.normals[separation.sideId].rotate(toIncidentFrameRotation, ScratchZero, ScratchNormal);\r\n    let minEdge = Number.MAX_VALUE;\r\n    let incidentEdgeIndex = 0;\r\n    for (let i = 0; i < other.normals.length; i++) {\r\n      const value = referenceEdgeNormal.dot(other.normals[i]);\r\n      if (value < minEdge) {\r\n        minEdge = value;\r\n        incidentEdgeIndex = i;\r\n      }\r\n    }\r\n\r\n    // FIXME temporary to prevent a crash, invalid separation\r\n    if (!separation.localSide || !separation.localAxis || !separation.axis) {\r\n      return [];\r\n    }\r\n\r\n    // Clip incident side by the perpendicular lines at each end of the reference side\r\n    // https://en.wikipedia.org/wiki/Sutherland%E2%80%93Hodgman_algorithm\r\n    const referenceSide = separation.localSide.transform(toIncidentFrame);\r\n    const referenceDirection = separation.localAxis.perpendicular().negate().rotate(toIncidentFrameRotation);\r\n\r\n    const incidentSide = new LineSegment(other.points[incidentEdgeIndex], other.points[(incidentEdgeIndex + 1) % other.points.length]);\r\n    const clipRight = incidentSide.clip(referenceDirection.negate(), -referenceDirection.dot(referenceSide.begin), false);\r\n    let clipLeft: LineSegment | null = null;\r\n    if (clipRight) {\r\n      clipLeft = clipRight.clip(referenceDirection, referenceDirection.dot(referenceSide.end), false);\r\n    }\r\n\r\n    if (clipLeft) {\r\n      const localPoints: Vector[] = [];\r\n      const points: Vector[] = [];\r\n      const clipPoints = clipLeft.getPoints();\r\n\r\n      for (let i = 0; i < clipPoints.length; i++) {\r\n        const p = clipPoints[i];\r\n        if (referenceSide.below(p)) {\r\n          localPoints.push(p);\r\n          points.push(other.transform.apply(p));\r\n        }\r\n      }\r\n      let normal = separation.axis;\r\n      let tangent = normal.perpendicular();\r\n      // Point Contact A -> B\r\n      if (polyB.center.sub(polyA.center).dot(normal) < 0) {\r\n        normal = normal.negate();\r\n        tangent = normal.perpendicular();\r\n      }\r\n      return [new CollisionContact(polyA, polyB, normal.scale(-separation.separation), normal, tangent, points, localPoints, separation)];\r\n    }\r\n    return [];\r\n  },\r\n\r\n  FindContactSeparation(contact: CollisionContact, localPoint: Vector): number {\r\n    const shapeA = contact.colliderA;\r\n    const txA = contact.bodyA?.transform ?? new TransformComponent();\r\n    const shapeB = contact.colliderB;\r\n    const txB = contact.bodyB?.transform ?? new TransformComponent();\r\n\r\n    // both are circles\r\n    if (shapeA instanceof CircleCollider && shapeB instanceof CircleCollider) {\r\n      const combinedRadius = shapeA.radius + shapeB.radius;\r\n      const distance = txA.pos.distance(txB.pos);\r\n      const separation = combinedRadius - distance;\r\n      return -separation;\r\n    }\r\n\r\n    // both are polygons\r\n    if (shapeA instanceof PolygonCollider && shapeB instanceof PolygonCollider) {\r\n      if (contact.info.localSide) {\r\n        let side: LineSegment;\r\n        let worldPoint: Vector;\r\n        if (contact.info.collider === shapeA) {\r\n          side = new LineSegment(\r\n            txA.apply(contact.info.localSide.begin).add(shapeA.offset),\r\n            txA.apply(contact.info.localSide.end).add(shapeA.offset)\r\n          );\r\n          worldPoint = txB.apply(localPoint).add(shapeB.offset);\r\n        } else {\r\n          side = new LineSegment(\r\n            txB.apply(contact.info.localSide.begin).add(shapeB.offset),\r\n            txB.apply(contact.info.localSide.end).add(shapeB.offset)\r\n          );\r\n          worldPoint = txA.apply(localPoint).add(shapeA.offset);\r\n        }\r\n\r\n        return side.distanceToPoint(worldPoint, true);\r\n      }\r\n    }\r\n\r\n    // polygon v circle\r\n    if (\r\n      (shapeA instanceof PolygonCollider && shapeB instanceof CircleCollider) ||\r\n      (shapeB instanceof PolygonCollider && shapeA instanceof CircleCollider)\r\n    ) {\r\n      const worldPoint = txA.apply(localPoint);\r\n      if (contact.info.side) {\r\n        return contact.info.side.distanceToPoint(worldPoint, true);\r\n      }\r\n    }\r\n\r\n    // polygon v edge\r\n    if (\r\n      (shapeA instanceof EdgeCollider && shapeB instanceof PolygonCollider) ||\r\n      (shapeB instanceof EdgeCollider && shapeA instanceof PolygonCollider)\r\n    ) {\r\n      let worldPoint: Vector;\r\n      if (contact.info.collider === shapeA) {\r\n        worldPoint = txB.apply(localPoint);\r\n      } else {\r\n        worldPoint = txA.apply(localPoint);\r\n      }\r\n      if (contact.info.side) {\r\n        return contact.info.side.distanceToPoint(worldPoint, true);\r\n      }\r\n    }\r\n\r\n    // circle v edge\r\n    if (\r\n      (shapeA instanceof CircleCollider && shapeB instanceof EdgeCollider) ||\r\n      (shapeB instanceof CircleCollider && shapeA instanceof EdgeCollider)\r\n    ) {\r\n      // Local point is always on the edge which is always shapeB\r\n      const worldPoint = txB.apply(localPoint);\r\n\r\n      let circlePoint: Vector;\r\n      if (shapeA instanceof CircleCollider) {\r\n        circlePoint = shapeA.getFurthestPoint(contact.normal);\r\n      }\r\n\r\n      const dist = worldPoint.distance(circlePoint);\r\n\r\n      if (contact.info.side) {\r\n        return dist > 0 ? -dist : 0;\r\n      }\r\n    }\r\n\r\n    return 0;\r\n  }\r\n};\r\n","import { BoundingBox } from '../BoundingBox';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { PolygonCollider } from './PolygonCollider';\r\n\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Color } from '../../Color';\r\nimport { Collider } from './Collider';\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Transform } from '../../Math/transform';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { BodyComponent } from '../Index';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\n\r\nexport interface EdgeColliderOptions {\r\n  /**\r\n   * The beginning of the edge defined in local coordinates to the collider\r\n   */\r\n  begin: Vector;\r\n  /**\r\n   * The ending of the edge defined in local coordinates to the collider\r\n   */\r\n  end: Vector;\r\n  /**\r\n   * Optionally specify an offset\r\n   */\r\n  offset?: Vector;\r\n}\r\n\r\n/**\r\n * Edge is a single line collider to create collisions with a single line.\r\n */\r\nexport class EdgeCollider extends Collider {\r\n  offset: Vector;\r\n  begin: Vector;\r\n  end: Vector;\r\n\r\n  private _transform: Transform;\r\n  private _globalMatrix: AffineMatrix = AffineMatrix.identity();\r\n\r\n  constructor(options: EdgeColliderOptions) {\r\n    super();\r\n    this.begin = options.begin || Vector.Zero;\r\n    this.end = options.end || Vector.Zero;\r\n    this.offset = options.offset ?? Vector.Zero;\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this Edge, not associated with any collider\r\n   */\r\n  public clone(): EdgeCollider {\r\n    return new EdgeCollider({\r\n      begin: this.begin.clone(),\r\n      end: this.end.clone()\r\n    });\r\n  }\r\n\r\n  public get worldPos(): Vector {\r\n    const tx = this._transform;\r\n    return tx?.globalPos.add(this.offset) ?? this.offset;\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collision area in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const pos = begin.average(end);\r\n    return pos;\r\n  }\r\n\r\n  private _getTransformedBegin(): Vector {\r\n    return this._globalMatrix.multiply(this.begin);\r\n  }\r\n\r\n  private _getTransformedEnd(): Vector {\r\n    return this._globalMatrix.multiply(this.end);\r\n  }\r\n\r\n  /**\r\n   * Returns the slope of the line in the form of a vector\r\n   */\r\n  public getSlope(): Vector {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const distance = begin.distance(end);\r\n    return end.sub(begin).scale(1 / distance);\r\n  }\r\n\r\n  /**\r\n   * Returns the length of the line segment in pixels\r\n   */\r\n  public getLength(): number {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    const distance = begin.distance(end);\r\n    return distance;\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collision area\r\n   */\r\n  public contains(): boolean {\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): RayCastHit | null {\r\n    const numerator = this._getTransformedBegin().sub(ray.pos);\r\n\r\n    // Test is line and ray are parallel and non intersecting\r\n    if (ray.dir.cross(this.getSlope()) === 0 && numerator.cross(ray.dir) !== 0) {\r\n      return null;\r\n    }\r\n\r\n    // Lines are parallel\r\n    const divisor = ray.dir.cross(this.getSlope());\r\n    if (divisor === 0) {\r\n      return null;\r\n    }\r\n\r\n    const t = numerator.cross(this.getSlope()) / divisor;\r\n\r\n    if (t >= 0 && t <= max) {\r\n      const u = numerator.cross(ray.dir) / divisor / this.getLength();\r\n      if (u >= 0 && u <= 1) {\r\n        return {\r\n          distance: t,\r\n          normal: this.asLine().normal(),\r\n          collider: this,\r\n          body: this.owner?.get(BodyComponent),\r\n          point: ray.getPoint(t)\r\n        } satisfies RayCastHit;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the closes line between this and another collider, from this -> collider\r\n   * @param shape\r\n   */\r\n  public getClosestLineBetween(shape: Collider): LineSegment {\r\n    if (shape instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.CircleEdgeClosestLine(shape, this);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonEdgeClosestLine(shape, this).flip();\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.EdgeEdgeClosestLine(this, shape);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public collide(shape: Collider): CollisionContact[] {\r\n    if (shape instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCircleEdge(shape, this);\r\n    } else if (shape instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollidePolygonEdge(shape, this);\r\n    } else if (shape instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollideEdgeEdge();\r\n    } else {\r\n      throw new Error(`Edge could not collide with unknown CollisionShape ${typeof shape}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    const transformedBegin = this._getTransformedBegin();\r\n    const transformedEnd = this._getTransformedEnd();\r\n    if (direction.dot(transformedBegin) > 0) {\r\n      return transformedBegin;\r\n    } else {\r\n      return transformedEnd;\r\n    }\r\n  }\r\n\r\n  private _boundsFromBeginEnd(begin: Vector, end: Vector, padding = 10) {\r\n    // A perfectly vertical or horizontal edge would have a bounds 0 width or height\r\n    // this causes problems for the collision system so we give them some padding\r\n    return new BoundingBox(\r\n      Math.min(begin.x, end.x) - padding,\r\n      Math.min(begin.y, end.y) - padding,\r\n      Math.max(begin.x, end.x) + padding,\r\n      Math.max(begin.y, end.y) + padding\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the edge collider in world space\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    const transformedBegin = this._getTransformedBegin();\r\n    const transformedEnd = this._getTransformedEnd();\r\n    return this._boundsFromBeginEnd(transformedBegin, transformedEnd);\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the edge collider in local space\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    return this._boundsFromBeginEnd(this.begin, this.end);\r\n  }\r\n\r\n  /**\r\n   * Returns this edge represented as a line in world coordinates\r\n   */\r\n  public asLine(): LineSegment {\r\n    return new LineSegment(this._getTransformedBegin(), this._getTransformedEnd());\r\n  }\r\n\r\n  /**\r\n   * Return this edge as a line in local line coordinates (relative to the position)\r\n   */\r\n  public asLocalLine(): LineSegment {\r\n    return new LineSegment(this.begin, this.end);\r\n  }\r\n\r\n  /**\r\n   * Get the axis associated with the edge\r\n   */\r\n  public get axes(): Vector[] {\r\n    const e = this._getTransformedEnd().sub(this._getTransformedBegin());\r\n    const edgeNormal = e.normal();\r\n\r\n    const axes = [];\r\n    axes.push(edgeNormal);\r\n    axes.push(edgeNormal.negate());\r\n    axes.push(edgeNormal.normal());\r\n    axes.push(edgeNormal.normal().negate());\r\n    return axes;\r\n  }\r\n\r\n  /**\r\n   * Get the moment of inertia for an edge\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    const length = this.end.sub(this.begin).distance() / 2;\r\n    return mass * length * length;\r\n  }\r\n\r\n  /**\r\n   * @inheritdoc\r\n   */\r\n  public update(transform: Transform): void {\r\n    this._transform = transform;\r\n    const globalMat = transform.matrix ?? this._globalMatrix;\r\n    globalMat.clone(this._globalMatrix);\r\n    this._globalMatrix.translate(this.offset.x, this.offset.y);\r\n  }\r\n\r\n  /**\r\n   * Project the edge along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const scalars = [];\r\n\r\n    const points = [this._getTransformedBegin(), this._getTransformedEnd()];\r\n    const len = points.length;\r\n    for (let i = 0; i < len; i++) {\r\n      scalars.push(points[i].dot(axis));\r\n    }\r\n\r\n    return new Projection(Math.min.apply(Math, scalars), Math.max.apply(Math, scalars));\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color) {\r\n    const begin = this._getTransformedBegin();\r\n    const end = this._getTransformedEnd();\r\n    ex.drawLine(begin, end, color, 2);\r\n    ex.drawCircle(begin, 2, color);\r\n    ex.drawCircle(end, 2, color);\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext, LineGraphicsOptions, PointGraphicsOptions } from './Context/ExcaliburGraphicsContext';\r\nimport { Color } from '../Color';\r\nimport { Ray } from '../Math/ray';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\n\r\nexport class Debug {\r\n  static _drawCalls: ((ctx: ExcaliburGraphicsContext) => void)[] = [];\r\n  static _ctx: ExcaliburGraphicsContext;\r\n  static z: number = Infinity;\r\n  static registerGraphicsContext(ctx: ExcaliburGraphicsContext) {\r\n    Debug._ctx = ctx;\r\n  }\r\n  static draw(debugDrawCall: (ctx: ExcaliburGraphicsContext) => void) {\r\n    this._drawCalls.push(debugDrawCall);\r\n  }\r\n\r\n  static drawPoint(point: Vector, options?: PointGraphicsOptions) {\r\n    Debug.draw((ctx) => {\r\n      ctx.debug.drawPoint(point, options);\r\n    });\r\n  }\r\n\r\n  static drawLine(start: Vector, end: Vector, options?: LineGraphicsOptions) {\r\n    Debug.draw((ctx) => {\r\n      ctx.debug.drawLine(start, end, options);\r\n    });\r\n  }\r\n\r\n  static drawLines(points: Vector[], options?: LineGraphicsOptions) {\r\n    if (points.length > 1) {\r\n      Debug.draw((ctx) => {\r\n        for (let i = 0; i < points.length - 1; i++) {\r\n          ctx.debug.drawLine(points[i], points[i + 1], options);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  static drawText(text: string, pos: Vector) {\r\n    Debug.draw((ctx) => {\r\n      ctx.debug.drawText(text, pos);\r\n    });\r\n  }\r\n\r\n  static drawPolygon(points: Vector[], options?: { color?: Color }) {\r\n    if (points.length > 1) {\r\n      Debug.draw((ctx) => {\r\n        const firstPoint = points[0];\r\n        const polygon = [...points, firstPoint];\r\n        for (let i = 0; i < polygon.length - 1; i++) {\r\n          ctx.debug.drawLine(polygon[i], polygon[i + 1], options);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  static drawCircle(\r\n    center: Vector,\r\n    radius: number,\r\n    options?: {\r\n      color?: Color;\r\n      strokeColor?: Color;\r\n      width?: number;\r\n    }\r\n  ) {\r\n    const { color, strokeColor, width } = {\r\n      color: Color.Black,\r\n      strokeColor: undefined,\r\n      width: undefined,\r\n      ...options\r\n    };\r\n    Debug.draw((ctx) => {\r\n      ctx.drawCircle(center, radius, color, strokeColor, width);\r\n    });\r\n  }\r\n\r\n  static drawBounds(boundingBox: BoundingBox, options?: { color?: Color }): void {\r\n    Debug.draw((ctx) => {\r\n      ctx.debug.drawRect(boundingBox.left, boundingBox.top, boundingBox.width, boundingBox.height, options);\r\n    });\r\n  }\r\n\r\n  static drawRay(ray: Ray, options?: { distance?: number; color?: Color }) {\r\n    const { distance, color } = {\r\n      color: Color.Blue,\r\n      distance: 10,\r\n      ...options\r\n    };\r\n    Debug.draw((ctx) => {\r\n      const start = ray.pos;\r\n      const end = ray.pos.add(ray.dir.scale(distance));\r\n\r\n      ctx.debug.drawLine(start, end, { color });\r\n    });\r\n  }\r\n\r\n  static flush(ctx: ExcaliburGraphicsContext) {\r\n    ctx.save();\r\n    ctx.z = Debug.z;\r\n    for (const drawCall of Debug._drawCalls) {\r\n      drawCall(ctx);\r\n    }\r\n    ctx.restore();\r\n    Debug.clear();\r\n  }\r\n\r\n  static clear() {\r\n    Debug._drawCalls.length = 0;\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { CollisionJumpTable } from './CollisionJumpTable';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { Projection } from '../../Math/projection';\r\nimport { LineSegment } from '../../Math/line-segment';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Ray } from '../../Math/ray';\r\nimport { ClosestLineJumpTable } from './ClosestLineJumpTable';\r\nimport { Collider } from './Collider';\r\nimport { BodyComponent, Debug, ExcaliburGraphicsContext, Logger, sign } from '../..';\r\nimport { CompositeCollider } from './CompositeCollider';\r\nimport { Shape } from './Shape';\r\nimport { Transform } from '../../Math/transform';\r\nimport { RayCastHit } from '../Detection/RayCastHit';\r\n\r\nexport interface PolygonColliderOptions {\r\n  /**\r\n   * Pixel offset relative to a collider's body transform position.\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * **Must be at least 3 points**\r\n   */\r\n  points: Vector[];\r\n\r\n  /**\r\n   * Suppresses convexity warning\r\n   */\r\n  suppressConvexWarning?: boolean;\r\n}\r\n\r\n/**\r\n * Polygon collider for detecting collisions\r\n */\r\nexport class PolygonCollider extends Collider {\r\n  private _logger = Logger.getInstance();\r\n  /**\r\n   * Pixel offset relative to a collider's body transform position.\r\n   */\r\n  public offset: Vector;\r\n\r\n  public flagDirty() {\r\n    this._localBoundsDirty = true;\r\n    this._localSidesDirty = true;\r\n    this._transformedPointsDirty = true;\r\n    this._sidesDirty = true;\r\n  }\r\n\r\n  private _points: Vector[];\r\n  private _normals: Vector[];\r\n\r\n  public get normals(): readonly Vector[] {\r\n    return this._normals;\r\n  }\r\n\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * Excalibur stores these in counter-clockwise order\r\n   */\r\n  public set points(points: Vector[]) {\r\n    if (points.length < 3) {\r\n      throw new Error('PolygonCollider cannot be created with less that 3 points');\r\n    }\r\n    this._points = points;\r\n    this._checkAndUpdateWinding(this._points);\r\n    this._calculateNormals();\r\n    this.flagDirty();\r\n  }\r\n\r\n  private _calculateNormals() {\r\n    const normals: Vector[] = [];\r\n    for (let i = 0; i < this._points.length; i++) {\r\n      normals.push(this._points[(i + 1) % this._points.length].sub(this._points[i]).normal());\r\n    }\r\n    this._normals = normals;\r\n  }\r\n\r\n  /**\r\n   * Points in the polygon in order around the perimeter in local coordinates. These are relative from the body transform position.\r\n   * Excalibur stores these in counter-clockwise order\r\n   */\r\n  public get points(): Vector[] {\r\n    return this._points;\r\n  }\r\n\r\n  private _transform: Transform = new Transform();\r\n  public get transform() {\r\n    return this._transform;\r\n  }\r\n\r\n  private _transformedPoints: Vector[] = [];\r\n  private _sides: LineSegment[] = [];\r\n  private _localSides: LineSegment[] = [];\r\n\r\n  constructor(options: PolygonColliderOptions) {\r\n    super();\r\n    this.offset = options.offset ?? Vector.Zero;\r\n    this._transform.pos.x += this.offset.x;\r\n    this._transform.pos.y += this.offset.y;\r\n    this.points = options.points;\r\n\r\n    if (!this.isConvex()) {\r\n      if (!options.suppressConvexWarning) {\r\n        this._logger.warn(\r\n          'Excalibur only supports convex polygon colliders and will not behave properly.' +\r\n            'Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles'\r\n        );\r\n      }\r\n    }\r\n\r\n    // calculate initial transformation\r\n    this._calculateTransformation();\r\n  }\r\n\r\n  private _checkAndUpdateWinding(points: Vector[]) {\r\n    const counterClockwise = this._isCounterClockwiseWinding(points);\r\n    if (!counterClockwise) {\r\n      points.reverse();\r\n    }\r\n  }\r\n  public _isCounterClockwiseWinding(points: Vector[]): boolean {\r\n    // https://stackoverflow.com/a/1165943\r\n    let sum = 0;\r\n    for (let i = 0; i < points.length; i++) {\r\n      sum += (points[(i + 1) % points.length].x - points[i].x) * (points[(i + 1) % points.length].y + points[i].y);\r\n    }\r\n    return sum < 0;\r\n  }\r\n\r\n  /**\r\n   * Returns if the polygon collider is convex, Excalibur does not handle non-convex collision shapes.\r\n   * Call {@apilink Polygon.triangulate} to generate a {@apilink CompositeCollider} from this non-convex shape\r\n   */\r\n  public isConvex(): boolean {\r\n    // From SO: https://stackoverflow.com/a/45372025\r\n    if (this.points.length < 3) {\r\n      return false;\r\n    }\r\n    let oldPoint = this.points[this.points.length - 2];\r\n    let newPoint = this.points[this.points.length - 1];\r\n    let direction = Math.atan2(newPoint.y - oldPoint.y, newPoint.x - oldPoint.x);\r\n    let oldDirection = 0;\r\n    let orientation = 0;\r\n    let angleSum = 0;\r\n    for (const [i, point] of this.points.entries()) {\r\n      oldPoint = newPoint;\r\n      oldDirection = direction;\r\n      newPoint = point;\r\n      direction = Math.atan2(newPoint.y - oldPoint.y, newPoint.x - oldPoint.x);\r\n      if (oldPoint.equals(newPoint)) {\r\n        return false; // repeat point\r\n      }\r\n      let angle = direction - oldDirection;\r\n      if (angle <= -Math.PI) {\r\n        angle += Math.PI * 2;\r\n      } else if (angle > Math.PI) {\r\n        angle -= Math.PI * 2;\r\n      }\r\n      if (i === 0) {\r\n        if (angle === 0.0) {\r\n          return false;\r\n        }\r\n        orientation = angle > 0 ? 1 : -1;\r\n      } else {\r\n        if (orientation * angle <= 0) {\r\n          return false;\r\n        }\r\n      }\r\n      angleSum += angle;\r\n    }\r\n    return Math.abs(Math.round(angleSum / (Math.PI * 2))) === 1;\r\n  }\r\n\r\n  /**\r\n   * Tessellates the polygon into a triangle fan as a {@apilink CompositeCollider} of triangle polygons\r\n   */\r\n  public tessellate(): CompositeCollider {\r\n    const polygons: Vector[][] = [];\r\n    for (let i = 1; i < this.points.length - 2; i++) {\r\n      polygons.push([this.points[0], this.points[i + 1], this.points[i + 2]]);\r\n    }\r\n    polygons.push([this.points[0], this.points[1], this.points[2]]);\r\n\r\n    return new CompositeCollider(polygons.map((points) => Shape.Polygon(points)));\r\n  }\r\n\r\n  /**\r\n   * Triangulate the polygon collider using the \"Ear Clipping\" algorithm.\r\n   * Returns a new {@apilink CompositeCollider} made up of smaller triangles.\r\n   */\r\n  public triangulate(): CompositeCollider {\r\n    // https://www.youtube.com/watch?v=hTJFcHutls8\r\n    if (this.points.length < 3) {\r\n      throw Error('Invalid polygon');\r\n    }\r\n\r\n    const triangles: [Vector, Vector, Vector][] = [];\r\n    // algorithm likes clockwise\r\n    const vertices = [...this.points].reverse();\r\n    let vertexCount = vertices.length;\r\n\r\n    /**\r\n     * Returns the previous index based on the current vertex\r\n     */\r\n    function getPrevIndex(index: number) {\r\n      return index === 0 ? vertexCount - 1 : index - 1;\r\n    }\r\n\r\n    /**\r\n     * Retrieves the next index based on the current vertex\r\n     */\r\n    function getNextIndex(index: number) {\r\n      return index === vertexCount - 1 ? 0 : index + 1;\r\n    }\r\n\r\n    /**\r\n     * Whether or not the angle at this vertex index is convex\r\n     */\r\n    function isConvex(index: number) {\r\n      const prev = getPrevIndex(index);\r\n      const next = getNextIndex(index);\r\n\r\n      const va = vertices[prev];\r\n      const vb = vertices[index];\r\n      const vc = vertices[next];\r\n\r\n      // Check convexity\r\n      const leftArm = va.sub(vb);\r\n      const rightArm = vc.sub(vb);\r\n      // Positive cross product is convex\r\n      if (leftArm.cross(rightArm) < 0) {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n\r\n    const convexVertices = vertices.map((_, i) => isConvex(i));\r\n\r\n    /**\r\n     * Quick test for point in triangle\r\n     */\r\n    function isPointInTriangle(point: Vector, a: Vector, b: Vector, c: Vector) {\r\n      const ab = b.sub(a);\r\n      const bc = c.sub(b);\r\n      const ca = a.sub(c);\r\n\r\n      const ap = point.sub(a);\r\n      const bp = point.sub(b);\r\n      const cp = point.sub(c);\r\n\r\n      const cross1 = ab.cross(ap);\r\n      const cross2 = bc.cross(bp);\r\n      const cross3 = ca.cross(cp);\r\n\r\n      if (cross1 > 0 || cross2 > 0 || cross3 > 0) {\r\n        return false;\r\n      }\r\n      return true;\r\n    }\r\n\r\n    /**\r\n     * Calculate the area of the triangle\r\n     */\r\n    // function triangleArea(a: Vector, b: Vector, c: Vector) {\r\n    //   return Math.abs(a.x * (b.y - c.y) + b.x * (c.y - a.y) + c.x * (a.y - c.y))/2;\r\n    // }\r\n\r\n    /**\r\n     * Find the next suitable ear tip\r\n     */\r\n    function findEarTip() {\r\n      for (let i = 0; i < vertexCount; i++) {\r\n        if (convexVertices[i]) {\r\n          const prev = getPrevIndex(i);\r\n          const next = getNextIndex(i);\r\n\r\n          const va = vertices[prev];\r\n          const vb = vertices[i];\r\n          const vc = vertices[next];\r\n\r\n          let isEar = true;\r\n          // Check that if any vertices are in the triangle a, b, c\r\n          for (let j = 0; j < vertexCount; j++) {\r\n            // We can skip these verts because they are the triangle we are testing\r\n            if (j === i || j === prev || j === next) {\r\n              continue;\r\n            }\r\n            const point = vertices[j];\r\n            if (isPointInTriangle(point, va, vb, vc)) {\r\n              isEar = false;\r\n              break;\r\n            }\r\n          }\r\n\r\n          // Add ear to polygon list and remove from list\r\n          if (isEar) {\r\n            return i;\r\n          }\r\n        }\r\n      }\r\n\r\n      // Fall back to any convex vertex\r\n      for (let i = 0; i < vertexCount; i++) {\r\n        if (convexVertices[i]) {\r\n          return i;\r\n        }\r\n      }\r\n\r\n      // bail and return the first one?\r\n      return 0;\r\n    }\r\n\r\n    /**\r\n     * Cut the ear and produce a triangle, update internal state\r\n     */\r\n    function cutEarTip(index: number) {\r\n      const prev = getPrevIndex(index);\r\n      const next = getNextIndex(index);\r\n\r\n      const va = vertices[prev];\r\n      const vb = vertices[index];\r\n      const vc = vertices[next];\r\n\r\n      // Clockwise winding\r\n      // if (triangleArea(va, vb, vc) > 0) {\r\n      triangles.push([va, vb, vc]);\r\n      // }\r\n      vertices.splice(index, 1);\r\n      convexVertices.splice(index, 1);\r\n      vertexCount--;\r\n    }\r\n\r\n    // Loop over all the vertices finding ears\r\n    while (vertexCount > 3) {\r\n      const earIndex = findEarTip();\r\n      cutEarTip(earIndex);\r\n\r\n      // reclassify vertices\r\n      for (let i = 0; i < vertexCount; i++) {\r\n        convexVertices[i] = isConvex(i);\r\n      }\r\n    }\r\n\r\n    // Last triangle after the loop\r\n    triangles.push([vertices[0], vertices[1], vertices[2]]);\r\n\r\n    // FIXME: there is a colinear triangle that sneaks in here sometimes\r\n    return new CompositeCollider(triangles.map((points) => Shape.Polygon(points, Vector.Zero, true)));\r\n  }\r\n\r\n  /**\r\n   * Returns a clone of this ConvexPolygon, not associated with any collider\r\n   */\r\n  public clone(): PolygonCollider {\r\n    return new PolygonCollider({\r\n      offset: this.offset.clone(),\r\n      points: this.points.map((p) => p.clone())\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the world position of the collider, which is the current body transform plus any defined offset\r\n   */\r\n  public get worldPos(): Vector {\r\n    return this._transform.pos;\r\n  }\r\n\r\n  /**\r\n   * Get the center of the collider in world coordinates\r\n   */\r\n  public get center(): Vector {\r\n    return this.bounds.center;\r\n  }\r\n\r\n  private _transformedPointsDirty = true;\r\n  /**\r\n   * Calculates the underlying transformation from the body relative space to world space\r\n   */\r\n  private _calculateTransformation() {\r\n    const points = this.points;\r\n    const len = points.length;\r\n    this._transformedPoints.length = 0; // clear out old transform\r\n    for (let i = 0; i < len; i++) {\r\n      this._transformedPoints[i] = this._transform.apply(points[i].clone());\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets the points that make up the polygon in world space, from actor relative space (if specified)\r\n   */\r\n  public getTransformedPoints(): Vector[] {\r\n    if (this._transformedPointsDirty) {\r\n      this._calculateTransformation();\r\n      this._transformedPointsDirty = false;\r\n    }\r\n    return this._transformedPoints;\r\n  }\r\n\r\n  private _sidesDirty = true;\r\n  /**\r\n   * Gets the sides of the polygon in world space\r\n   */\r\n  public getSides(): LineSegment[] {\r\n    if (this._sidesDirty) {\r\n      const lines = [];\r\n      const points = this.getTransformedPoints();\r\n      const len = points.length;\r\n      for (let i = 0; i < len; i++) {\r\n        // This winding is important\r\n        lines.push(new LineSegment(points[i], points[(i + 1) % len]));\r\n      }\r\n      this._sides = lines;\r\n      this._sidesDirty = false;\r\n    }\r\n    return this._sides;\r\n  }\r\n\r\n  private _localSidesDirty = true;\r\n  /**\r\n   * Returns the local coordinate space sides\r\n   */\r\n  public getLocalSides(): LineSegment[] {\r\n    if (this._localSidesDirty) {\r\n      const lines = [];\r\n      const points = this.points;\r\n      const len = points.length;\r\n      for (let i = 0; i < len; i++) {\r\n        // This winding is important\r\n        lines.push(new LineSegment(points[i], points[(i + 1) % len]));\r\n      }\r\n      this._localSides = lines;\r\n      this._localSidesDirty = false;\r\n    }\r\n\r\n    return this._localSides;\r\n  }\r\n\r\n  /**\r\n   * Given a direction vector find the world space side that is most in that direction\r\n   * @param direction\r\n   */\r\n  public findSide(direction: Vector): LineSegment {\r\n    const sides = this.getSides();\r\n    let bestSide = sides[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let side = 0; side < sides.length; side++) {\r\n      const currentSide = sides[side];\r\n      const sideNormal = currentSide.normal();\r\n      const mostDirection = sideNormal.dot(direction);\r\n      if (mostDirection > maxDistance) {\r\n        bestSide = currentSide;\r\n        maxDistance = mostDirection;\r\n      }\r\n    }\r\n    return bestSide;\r\n  }\r\n\r\n  /**\r\n   * Given a direction vector find the local space side that is most in that direction\r\n   * @param direction\r\n   */\r\n  public findLocalSide(direction: Vector): LineSegment {\r\n    const sides = this.getLocalSides();\r\n    let bestSide = sides[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let side = 0; side < sides.length; side++) {\r\n      const currentSide = sides[side];\r\n      const sideNormal = currentSide.normal();\r\n      const mostDirection = sideNormal.dot(direction);\r\n      if (mostDirection > maxDistance) {\r\n        bestSide = currentSide;\r\n        maxDistance = mostDirection;\r\n      }\r\n    }\r\n    return bestSide;\r\n  }\r\n\r\n  /**\r\n   * Get the axis associated with the convex polygon\r\n   */\r\n  public get axes(): Vector[] {\r\n    const axes: Vector[] = [];\r\n    const sides = this.getSides();\r\n    for (let i = 0; i < sides.length; i++) {\r\n      axes.push(sides[i].normal());\r\n    }\r\n    return axes;\r\n  }\r\n\r\n  /**\r\n   * Updates the transform for the collision geometry\r\n   *\r\n   * Collision geometry (points/bounds) will not change until this is called.\r\n   * @param transform\r\n   */\r\n  public update(transform: Transform): void {\r\n    if (transform) {\r\n      // This change means an update must be performed in order for geometry to update\r\n      transform.cloneWithParent(this._transform);\r\n      this._transformedPointsDirty = true;\r\n      this._sidesDirty = true;\r\n      if (this.offset.x !== 0 || this.offset.y !== 0) {\r\n        this._transform.pos.x += this.offset.x;\r\n        this._transform.pos.y += this.offset.y;\r\n      }\r\n\r\n      if (this._transform.isMirrored()) {\r\n        // negative transforms really mess with things in collision local space\r\n        // flatten out the negatives by applying to geometry\r\n        this.points = this.points.map((p) => vec(p.x * sign(this._transform.scale.x), p.y * sign(this._transform.scale.y)));\r\n        this._transform.scale.x = Math.abs(this._transform.scale.x);\r\n        this._transform.scale.y = Math.abs(this._transform.scale.y);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tests if a point is contained in this collider in world space\r\n   */\r\n  public contains(point: Vector): boolean {\r\n    // Always cast to the right, as long as we cast in a consistent fixed direction we\r\n    // will be fine\r\n    const localPoint = this._transform.applyInverse(point);\r\n    const testRay = new Ray(localPoint, new Vector(1, 0));\r\n\r\n    let intersectCount = 0;\r\n    const sides = this.getLocalSides();\r\n    for (let sideIndex = 0; sideIndex < sides.length; sideIndex++) {\r\n      const side = sides[sideIndex];\r\n      if (testRay.intersect(side) >= 0) {\r\n        intersectCount++;\r\n      }\r\n    }\r\n\r\n    if (intersectCount % 2 === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getClosestLineBetween(collider: Collider): LineSegment {\r\n    if (collider instanceof CircleCollider) {\r\n      return ClosestLineJumpTable.PolygonCircleClosestLine(this, collider);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return ClosestLineJumpTable.PolygonPolygonClosestLine(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return ClosestLineJumpTable.PolygonEdgeClosestLine(this, collider);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a collision contact if the 2 colliders collide, otherwise collide will\r\n   * return null.\r\n   * @param collider\r\n   */\r\n  public collide(collider: Collider): CollisionContact[] {\r\n    if (collider instanceof CircleCollider) {\r\n      return CollisionJumpTable.CollideCirclePolygon(collider, this);\r\n    } else if (collider instanceof PolygonCollider) {\r\n      return CollisionJumpTable.CollidePolygonPolygon(this, collider);\r\n    } else if (collider instanceof EdgeCollider) {\r\n      return CollisionJumpTable.CollidePolygonEdge(this, collider);\r\n    } else {\r\n      throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof collider}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Find the point on the collider furthest in the direction specified\r\n   */\r\n  public getFurthestPoint(direction: Vector): Vector {\r\n    const pts = this.getTransformedPoints();\r\n    let furthestPoint = null;\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let i = 0; i < pts.length; i++) {\r\n      const distance = direction.dot(pts[i]);\r\n      if (distance > maxDistance) {\r\n        maxDistance = distance;\r\n        furthestPoint = pts[i];\r\n      }\r\n    }\r\n    return furthestPoint;\r\n  }\r\n\r\n  /**\r\n   * Find the local point on the collider furthest in the direction specified\r\n   * @param direction\r\n   */\r\n  public getFurthestLocalPoint(direction: Vector): Vector {\r\n    const pts = this.points;\r\n    let furthestPoint = pts[0];\r\n    let maxDistance = -Number.MAX_VALUE;\r\n    for (let i = 0; i < pts.length; i++) {\r\n      const distance = direction.dot(pts[i]);\r\n      if (distance > maxDistance) {\r\n        maxDistance = distance;\r\n        furthestPoint = pts[i];\r\n      }\r\n    }\r\n    return furthestPoint;\r\n  }\r\n\r\n  /**\r\n   * Finds the closes face to the point using perpendicular distance\r\n   * @param point point to test against polygon\r\n   */\r\n  public getClosestFace(point: Vector): { distance: Vector; face: LineSegment } {\r\n    const sides = this.getSides();\r\n    let min = Number.POSITIVE_INFINITY;\r\n    let faceIndex = -1;\r\n    let distance = -1;\r\n    for (let i = 0; i < sides.length; i++) {\r\n      const dist = sides[i].distanceToPoint(point);\r\n      if (dist < min) {\r\n        min = dist;\r\n        faceIndex = i;\r\n        distance = dist;\r\n      }\r\n    }\r\n\r\n    if (faceIndex !== -1) {\r\n      return {\r\n        distance: sides[faceIndex].normal().scale(distance),\r\n        face: sides[faceIndex]\r\n      };\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Get the axis aligned bounding box for the polygon collider in world coordinates\r\n   */\r\n  public get bounds(): BoundingBox {\r\n    return this.localBounds.transform(this._transform.matrix);\r\n  }\r\n\r\n  private _localBoundsDirty = true;\r\n  private _localBounds: BoundingBox;\r\n  /**\r\n   * Get the axis aligned bounding box for the polygon collider in local coordinates\r\n   */\r\n  public get localBounds(): BoundingBox {\r\n    if (this._localBoundsDirty) {\r\n      this._localBounds = BoundingBox.fromPoints(this.points);\r\n      this._localBoundsDirty = false;\r\n    }\r\n\r\n    return this._localBounds;\r\n  }\r\n\r\n  private _cachedMass: number;\r\n  private _cachedInertia: number;\r\n  /**\r\n   * Get the moment of inertia for an arbitrary polygon\r\n   * https://en.wikipedia.org/wiki/List_of_moments_of_inertia\r\n   */\r\n  public getInertia(mass: number): number {\r\n    if (this._cachedMass === mass && this._cachedInertia) {\r\n      return this._cachedInertia;\r\n    }\r\n    let numerator = 0;\r\n    let denominator = 0;\r\n    const points = this.points;\r\n    for (let i = 0; i < points.length; i++) {\r\n      const iplusone = (i + 1) % points.length;\r\n      const crossTerm = points[iplusone].cross(points[i]);\r\n      numerator += crossTerm * (points[i].dot(points[i]) + points[i].dot(points[iplusone]) + points[iplusone].dot(points[iplusone]));\r\n      denominator += crossTerm;\r\n    }\r\n    this._cachedMass = mass;\r\n    return (this._cachedInertia = (mass / 6) * (numerator / denominator));\r\n  }\r\n\r\n  /**\r\n   * Casts a ray into the polygon and returns a vector representing the point of contact (in world space) or null if no collision.\r\n   */\r\n  public rayCast(ray: Ray, max: number = Infinity): RayCastHit | null {\r\n    // find the minimum contact time greater than 0\r\n    // contact times less than 0 are behind the ray and we don't want those\r\n    const sides = this.getSides();\r\n    const len = sides.length;\r\n    let minContactTime = Number.MAX_VALUE;\r\n    let contactSide: LineSegment;\r\n    let contactIndex = -1;\r\n    for (let i = 0; i < len; i++) {\r\n      const contactTime = ray.intersect(sides[i]);\r\n      if (contactTime >= 0 && contactTime < minContactTime && contactTime <= max) {\r\n        minContactTime = contactTime;\r\n        contactSide = sides[i];\r\n        contactIndex = i;\r\n      }\r\n    }\r\n\r\n    // contact was found\r\n    if (contactIndex >= 0) {\r\n      return {\r\n        collider: this,\r\n        distance: minContactTime,\r\n        body: this.owner?.get(BodyComponent),\r\n        point: ray.getPoint(minContactTime),\r\n        normal: contactSide.normal()\r\n      } satisfies RayCastHit;\r\n    }\r\n\r\n    // no contact found\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Project the edges of the polygon along a specified axis\r\n   */\r\n  public project(axis: Vector): Projection {\r\n    const points = this.getTransformedPoints();\r\n    const len = points.length;\r\n    let min = Number.MAX_VALUE;\r\n    let max = -Number.MAX_VALUE;\r\n    for (let i = 0; i < len; i++) {\r\n      const scalar = points[i].dot(axis);\r\n      min = Math.min(min, scalar);\r\n      max = Math.max(max, scalar);\r\n    }\r\n\r\n    return new Projection(min, max);\r\n  }\r\n\r\n  public debug(ex: ExcaliburGraphicsContext, color: Color, options?: { lineWidth: number; pointSize: number }) {\r\n    const points = this.getTransformedPoints();\r\n    Debug.drawPolygon(points, { color });\r\n  }\r\n}\r\n","import { PolygonCollider } from './PolygonCollider';\r\nimport { CircleCollider } from './CircleCollider';\r\nimport { EdgeCollider } from './EdgeCollider';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { CompositeCollider } from './CompositeCollider';\r\nimport { Logger } from '../..';\r\n\r\n/**\r\n * Excalibur helper for defining colliders quickly\r\n */\r\nexport class Shape {\r\n  /**\r\n   * Creates a box collider, under the hood defines a {@apilink PolygonCollider} collider\r\n   * @param width Width of the box\r\n   * @param height Height of the box\r\n   * @param anchor Anchor of the box (default (.5, .5)) which positions the box relative to the center of the collider's position\r\n   * @param offset Optional offset relative to the collider in local coordinates\r\n   */\r\n  static Box(width: number, height: number, anchor: Vector = Vector.Half, offset: Vector = Vector.Zero): PolygonCollider {\r\n    return new PolygonCollider({\r\n      points: new BoundingBox(-width * anchor.x, -height * anchor.y, width - width * anchor.x, height - height * anchor.y).getPoints(),\r\n      offset: offset\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new {@apilink PolygonCollider | `arbitrary polygon`} collider\r\n   *\r\n   * PolygonColliders are useful for creating convex polygon shapes\r\n   * @param points Points specified in counter clockwise\r\n   * @param offset Optional offset relative to the collider in local coordinates\r\n   */\r\n  static Polygon(points: Vector[], offset: Vector = Vector.Zero, suppressConvexWarning = false): PolygonCollider {\r\n    return new PolygonCollider({\r\n      points: points,\r\n      offset: offset,\r\n      suppressConvexWarning\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new {@apilink CircleCollider | `circle`} collider\r\n   *\r\n   * Circle colliders are useful for balls, or to make collisions more forgiving on sharp edges\r\n   * @param radius Radius of the circle collider\r\n   * @param offset Optional offset relative to the collider in local coordinates\r\n   */\r\n  static Circle(radius: number, offset: Vector = Vector.Zero): CircleCollider {\r\n    return new CircleCollider({\r\n      radius: radius,\r\n      offset: offset\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new {@apilink EdgeCollider | `edge`} collider\r\n   *\r\n   * Edge colliders are useful for  floors, walls, and other barriers\r\n   * @param begin Beginning of the edge in local coordinates to the collider\r\n   * @param end Ending of the edge in local coordinates to the collider\r\n   */\r\n  static Edge(begin: Vector, end: Vector): EdgeCollider {\r\n    return new EdgeCollider({\r\n      begin: begin,\r\n      end: end\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Creates a new capsule shaped {@apilink CompositeCollider} using 2 circles and a box\r\n   *\r\n   * Capsule colliders are useful for platformers with incline or jagged floors to have a smooth\r\n   * player experience.\r\n   * @param width\r\n   * @param height\r\n   * @param offset Optional offset\r\n   */\r\n  static Capsule(width: number, height: number, offset = Vector.Zero): CompositeCollider {\r\n    const logger = Logger.getInstance();\r\n    if (width === height) {\r\n      logger.warn('A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider');\r\n    }\r\n\r\n    const vertical = height >= width;\r\n\r\n    if (vertical) {\r\n      // height > width, if equal maybe use a circle\r\n      const capsule = new CompositeCollider([\r\n        Shape.Circle(width / 2, vec(0, -height / 2 + width / 2).add(offset)),\r\n        Shape.Box(width, height - width, Vector.Half, offset),\r\n        Shape.Circle(width / 2, vec(0, height / 2 - width / 2).add(offset))\r\n      ]);\r\n      return capsule;\r\n    } else {\r\n      // width > height, if equal maybe use a circle\r\n      const capsule = new CompositeCollider([\r\n        Shape.Circle(height / 2, vec(-width / 2 + height / 2, 0).add(offset)),\r\n        Shape.Box(width - height, height, Vector.Half, offset),\r\n        Shape.Circle(height / 2, vec(width / 2 - height / 2, 0).add(offset))\r\n      ]);\r\n      return capsule;\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { CollisionEndEvent, CollisionStartEvent, PostCollisionEvent, PreCollisionEvent } from '../Events';\r\nimport { Observable } from '../Util/Observable';\r\nimport { BoundingBox } from './BoundingBox';\r\nimport { CollisionContact } from './Detection/CollisionContact';\r\nimport { CircleCollider } from './Colliders/CircleCollider';\r\nimport { Collider } from './Colliders/Collider';\r\nimport { CompositeCollider } from './Colliders/CompositeCollider';\r\nimport { PolygonCollider } from './Colliders/PolygonCollider';\r\nimport { EdgeCollider } from './Colliders/EdgeCollider';\r\nimport { Shape } from './Colliders/Shape';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { Actor } from '../Actor';\r\n\r\nexport class ColliderComponent extends Component {\r\n  public events = new EventEmitter();\r\n  /**\r\n   * Observable that notifies when a collider is added to the body\r\n   */\r\n  public $colliderAdded = new Observable<Collider>();\r\n\r\n  /**\r\n   * Observable that notifies when a collider is removed from the body\r\n   */\r\n  public $colliderRemoved = new Observable<Collider>();\r\n\r\n  constructor(collider?: Collider) {\r\n    super();\r\n    this.set(collider);\r\n  }\r\n\r\n  private _collider: Collider;\r\n  /**\r\n   * Get the current collider geometry\r\n   */\r\n  public get(): Collider | undefined {\r\n    return this._collider;\r\n  }\r\n\r\n  /**\r\n   * Set the collider geometry\r\n   * @param collider\r\n   * @returns the collider you set\r\n   */\r\n  public set<T extends Collider>(collider: T): T {\r\n    this.clear();\r\n    if (collider) {\r\n      this._collider = collider;\r\n      this._collider.owner = this.owner;\r\n      collider.events.pipe(this.events);\r\n      this.$colliderAdded.notifyAll(collider);\r\n      this.update();\r\n    }\r\n    return collider;\r\n  }\r\n\r\n  private _collidersToRemove: Collider[] = [];\r\n  /**\r\n   * Remove collider geometry from collider component\r\n   */\r\n  public clear() {\r\n    if (this._collider) {\r\n      this._collidersToRemove.push(this._collider);\r\n      this._collider = null;\r\n    }\r\n  }\r\n\r\n  public processColliderRemoval() {\r\n    for (const collider of this._collidersToRemove) {\r\n      collider.events.unpipe(this.events);\r\n      this.$colliderRemoved.notifyAll(collider);\r\n      collider.owner = null;\r\n    }\r\n  }\r\n\r\n  public clone(): ColliderComponent {\r\n    const clone = new ColliderComponent(this._collider.clone());\r\n\r\n    return clone;\r\n  }\r\n\r\n  /**\r\n   * Return world space bounds\r\n   */\r\n  public get bounds() {\r\n    return this._collider?.bounds ?? new BoundingBox();\r\n  }\r\n\r\n  /**\r\n   * Return local space bounds\r\n   */\r\n  public get localBounds() {\r\n    return this._collider?.localBounds ?? new BoundingBox();\r\n  }\r\n\r\n  /**\r\n   * Update the collider's transformed geometry\r\n   */\r\n  public update() {\r\n    const tx = this.owner?.get(TransformComponent);\r\n    if (this._collider) {\r\n      this._collider.owner = this.owner;\r\n      if (tx) {\r\n        this._collider.update(tx.get());\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Collide component with another\r\n   * @param other\r\n   */\r\n  collide(other: ColliderComponent): CollisionContact[] {\r\n    let colliderA = this._collider;\r\n    let colliderB = other._collider;\r\n    if (!colliderA || !colliderB) {\r\n      return [];\r\n    }\r\n\r\n    // If we have a composite left hand side :(\r\n    // Might bite us, but to avoid updating all the handlers make composite always left side\r\n    let flipped = false;\r\n    if (colliderB instanceof CompositeCollider) {\r\n      colliderA = colliderB;\r\n      colliderB = this._collider;\r\n      flipped = true;\r\n    }\r\n\r\n    if (this._collider) {\r\n      const contacts = colliderA.collide(colliderB);\r\n      if (contacts) {\r\n        if (flipped) {\r\n          contacts.forEach((contact) => {\r\n            contact.mtv = contact.mtv.negate();\r\n            contact.normal = contact.normal.negate();\r\n            contact.tangent = contact.normal.perpendicular();\r\n            contact.colliderA = this._collider;\r\n            contact.colliderB = other._collider;\r\n          });\r\n        }\r\n        return contacts;\r\n      }\r\n      return [];\r\n    }\r\n    return [];\r\n  }\r\n\r\n  onAdd(entity: Entity) {\r\n    if (this._collider) {\r\n      this.update();\r\n    }\r\n    // Wire up the collider events to the owning entity\r\n    this.events.on('precollision', (evt: any) => {\r\n      const precollision = evt as PreCollisionEvent<Collider>;\r\n      entity.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(precollision.self, precollision.other, precollision.side, precollision.intersection, precollision.contact)\r\n      );\r\n      if (entity instanceof Actor) {\r\n        entity.onPreCollisionResolve(precollision.self, precollision.other, precollision.side, precollision.contact);\r\n      }\r\n    });\r\n    this.events.on('postcollision', (evt: any) => {\r\n      const postcollision = evt as PostCollisionEvent<Collider>;\r\n      entity.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(\r\n          postcollision.self,\r\n          postcollision.other,\r\n          postcollision.side,\r\n          postcollision.intersection,\r\n          postcollision.contact\r\n        )\r\n      );\r\n      if (entity instanceof Actor) {\r\n        entity.onPostCollisionResolve(postcollision.self, postcollision.other, postcollision.side, postcollision.contact);\r\n      }\r\n    });\r\n    this.events.on('collisionstart', (evt: any) => {\r\n      const start = evt as CollisionStartEvent<Collider>;\r\n      entity.events.emit('collisionstart', new CollisionStartEvent(start.self, start.other, start.side, start.contact));\r\n      if (entity instanceof Actor) {\r\n        entity.onCollisionStart(start.self, start.other, start.side, start.contact);\r\n      }\r\n    });\r\n    this.events.on('collisionend', (evt: any) => {\r\n      const end = evt as CollisionEndEvent<Collider>;\r\n      entity.events.emit('collisionend', new CollisionEndEvent(end.self, end.other, end.side, end.lastContact));\r\n      if (entity instanceof Actor) {\r\n        entity.onCollisionEnd(end.self, end.other, end.side, end.lastContact);\r\n      }\r\n    });\r\n  }\r\n\r\n  onRemove() {\r\n    this.events.clear();\r\n    this.$colliderRemoved.notifyAll(this._collider);\r\n  }\r\n\r\n  /**\r\n   * Sets up a box geometry based on the current bounds of the associated actor of this physics body.\r\n   *\r\n   * If no width/height are specified the body will attempt to use the associated actor's width/height.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useBoxCollider(width: number, height: number, anchor: Vector = Vector.Half, center: Vector = Vector.Zero): PolygonCollider {\r\n    const collider = Shape.Box(width, height, anchor, center);\r\n    return this.set(collider);\r\n  }\r\n\r\n  /**\r\n   * Sets up a {@apilink PolygonCollider | `polygon`} collision geometry based on a list of of points relative\r\n   *  to the anchor of the associated actor\r\n   * of this physics body.\r\n   *\r\n   * Only [convex polygon](https://en.wikipedia.org/wiki/Convex_polygon) definitions are supported.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  usePolygonCollider(points: Vector[], center: Vector = Vector.Zero): PolygonCollider {\r\n    const poly = Shape.Polygon(points, center);\r\n    return this.set(poly);\r\n  }\r\n\r\n  /**\r\n   * Sets up a {@apilink Circle | `circle collision geometry`} as the only collider with a specified radius in pixels.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useCircleCollider(radius: number, center: Vector = Vector.Zero): CircleCollider {\r\n    const collider = Shape.Circle(radius, center);\r\n    return this.set(collider);\r\n  }\r\n\r\n  /**\r\n   * Sets up an {@apilink Edge | `edge collision geometry`} with a start point and an end point relative to the anchor of the associated actor\r\n   * of this physics body.\r\n   *\r\n   * By default, the box is center is at (0, 0) which means it is centered around the actors anchor.\r\n   */\r\n  useEdgeCollider(begin: Vector, end: Vector): EdgeCollider {\r\n    const collider = Shape.Edge(begin, end);\r\n    return this.set(collider);\r\n  }\r\n\r\n  /**\r\n   * Setups up a {@apilink CompositeCollider} which can define any arbitrary set of excalibur colliders\r\n   * @param colliders\r\n   */\r\n  useCompositeCollider(colliders: Collider[]): CompositeCollider {\r\n    return this.set(new CompositeCollider(colliders));\r\n  }\r\n}\r\n","import { vec, Vector } from '../Math/vector';\r\nimport { CollisionType } from './CollisionType';\r\nimport { Clonable } from '../Interfaces/Clonable';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { CollisionGroup } from './Group/CollisionGroup';\r\nimport { createId, Id } from '../Id';\r\nimport { clamp } from '../Math/util';\r\nimport { ColliderComponent } from './ColliderComponent';\r\nimport { Transform } from '../Math/transform';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { getDefaultPhysicsConfig, PhysicsConfig } from './PhysicsConfig';\r\nimport { DeepRequired } from '../Util/Required';\r\nimport { Entity } from '../EntityComponentSystem';\r\n\r\nexport interface BodyComponentOptions {\r\n  type?: CollisionType;\r\n  group?: CollisionGroup;\r\n  useGravity?: boolean;\r\n  config?: Pick<PhysicsConfig, 'bodies'>['bodies'];\r\n}\r\n\r\nexport enum DegreeOfFreedom {\r\n  Rotation = 'rotation',\r\n  X = 'x',\r\n  Y = 'y'\r\n}\r\n\r\n/**\r\n * Body describes all the physical properties pos, vel, acc, rotation, angular velocity for the purpose of\r\n * of physics simulation.\r\n */\r\nexport class BodyComponent extends Component implements Clonable<BodyComponent> {\r\n  public dependencies = [TransformComponent, MotionComponent];\r\n  public static _ID = 0;\r\n  public readonly id: Id<'body'> = createId('body', BodyComponent._ID++);\r\n  public events = new EventEmitter();\r\n\r\n  public oldTransform = new Transform();\r\n\r\n  /**\r\n   * Indicates whether the old transform has been captured at least once for interpolation\r\n   * @internal\r\n   */\r\n  public __oldTransformCaptured: boolean = false;\r\n\r\n  /**\r\n   * Enable or disabled the fixed update interpolation, by default interpolation is on.\r\n   */\r\n  public enableFixedUpdateInterpolate = true;\r\n\r\n  private _bodyConfig: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']>;\r\n  private static _DEFAULT_CONFIG: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']> = {\r\n    ...getDefaultPhysicsConfig().bodies\r\n  };\r\n  public wakeThreshold: number;\r\n\r\n  constructor(options?: BodyComponentOptions) {\r\n    super();\r\n    if (options) {\r\n      this.collisionType = options.type ?? this.collisionType;\r\n      this.group = options.group ?? this.group;\r\n      this.useGravity = options.useGravity ?? this.useGravity;\r\n      this._bodyConfig = {\r\n        ...getDefaultPhysicsConfig().bodies,\r\n        ...options.config\r\n      };\r\n    } else {\r\n      this._bodyConfig = {\r\n        ...getDefaultPhysicsConfig().bodies\r\n      };\r\n    }\r\n    this.updatePhysicsConfig(this._bodyConfig);\r\n    this._mass = BodyComponent._DEFAULT_CONFIG.defaultMass;\r\n  }\r\n\r\n  public get matrix() {\r\n    return this.transform.get().matrix;\r\n  }\r\n\r\n  /**\r\n   * Called by excalibur to update physics config defaults if they change\r\n   * @param config\r\n   */\r\n  public updatePhysicsConfig(config: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']>) {\r\n    this._bodyConfig = {\r\n      ...getDefaultPhysicsConfig().bodies,\r\n      ...config\r\n    };\r\n    this.canSleep = this._bodyConfig.canSleepByDefault;\r\n    this.sleepMotion = this._bodyConfig.sleepEpsilon * 5;\r\n    this.wakeThreshold = this._bodyConfig.wakeThreshold;\r\n  }\r\n  /**\r\n   * Called by excalibur to update defaults\r\n   * @param config\r\n   */\r\n  public static updateDefaultPhysicsConfig(config: DeepRequired<Pick<PhysicsConfig, 'bodies'>['bodies']>) {\r\n    BodyComponent._DEFAULT_CONFIG = config;\r\n  }\r\n\r\n  /**\r\n   * Collision type for the rigidbody physics simulation, by default {@apilink CollisionType.PreventCollision}\r\n   */\r\n  public collisionType: CollisionType = CollisionType.PreventCollision;\r\n\r\n  /**\r\n   * The collision group for the body's colliders, by default body colliders collide with everything\r\n   */\r\n  public group: CollisionGroup = CollisionGroup.All;\r\n\r\n  /**\r\n   * The amount of mass the body has\r\n   */\r\n  private _mass: number;\r\n  public get mass(): number {\r\n    return this._mass;\r\n  }\r\n\r\n  public set mass(newMass: number) {\r\n    this._mass = newMass;\r\n    this._cachedInertia = undefined;\r\n    this._cachedInverseInertia = undefined;\r\n  }\r\n\r\n  /**\r\n   * The inverse mass (1/mass) of the body. If {@apilink CollisionType.Fixed} this is 0, meaning \"infinite\" mass\r\n   */\r\n  public get inverseMass(): number {\r\n    return this.collisionType === CollisionType.Fixed ? 0 : 1 / this.mass;\r\n  }\r\n\r\n  /**\r\n   * Amount of \"motion\" the body has before sleeping. If below {@apilink Physics.sleepEpsilon} it goes to \"sleep\"\r\n   */\r\n  public sleepMotion: number;\r\n\r\n  /**\r\n   * Can this body sleep, by default bodies do not sleep\r\n   */\r\n  public canSleep: boolean;\r\n\r\n  private _sleeping = false;\r\n  /**\r\n   * Whether this body is sleeping or not\r\n   * @deprecated use isSleeping\r\n   */\r\n  public get sleeping(): boolean {\r\n    return this.isSleeping;\r\n  }\r\n\r\n  /**\r\n   * Whether this body is sleeping or not\r\n   */\r\n  public get isSleeping(): boolean {\r\n    return this._sleeping;\r\n  }\r\n\r\n  /**\r\n   * Set the sleep state of the body\r\n   * @param sleeping\r\n   * @deprecated use isSleeping\r\n   */\r\n  public setSleeping(sleeping: boolean) {\r\n    this.isSleeping = sleeping;\r\n  }\r\n\r\n  public set isSleeping(sleeping: boolean) {\r\n    this._sleeping = sleeping;\r\n    if (!sleeping) {\r\n      // Give it a kick to keep it from falling asleep immediately\r\n      this.sleepMotion = this._bodyConfig.sleepEpsilon * 5;\r\n    } else {\r\n      this.vel = Vector.Zero;\r\n      this.acc = Vector.Zero;\r\n      this.angularVelocity = 0;\r\n      this.sleepMotion = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update body's {@apilink BodyComponent.sleepMotion} for the purpose of sleeping\r\n   */\r\n  public updateMotion() {\r\n    if (this._sleeping) {\r\n      this.isSleeping = true;\r\n    }\r\n    const currentMotion = this.vel.magnitude * this.vel.magnitude + Math.abs(this.angularVelocity * this.angularVelocity);\r\n    const bias = this._bodyConfig.sleepBias;\r\n    this.sleepMotion = bias * this.sleepMotion + (1 - bias) * currentMotion;\r\n    this.sleepMotion = clamp(this.sleepMotion, 0, 10 * this._bodyConfig.sleepEpsilon);\r\n    if (this.canSleep && this.sleepMotion < this._bodyConfig.sleepEpsilon) {\r\n      this.isSleeping = true;\r\n    }\r\n  }\r\n\r\n  private _cachedInertia: number;\r\n  /**\r\n   * Get the moment of inertia from the {@apilink ColliderComponent}\r\n   */\r\n  public get inertia() {\r\n    if (this._cachedInertia) {\r\n      return this._cachedInertia;\r\n    }\r\n\r\n    // Inertia is a property of the geometry, so this is a little goofy but seems to be okay?\r\n    const collider = this.owner.get(ColliderComponent);\r\n    if (collider) {\r\n      collider.$colliderAdded.subscribe(() => {\r\n        this._cachedInertia = null;\r\n      });\r\n      collider.$colliderRemoved.subscribe(() => {\r\n        this._cachedInertia = null;\r\n      });\r\n      const maybeCollider = collider.get();\r\n      if (maybeCollider) {\r\n        return (this._cachedInertia = maybeCollider.getInertia(this.mass));\r\n      }\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  private _cachedInverseInertia: number;\r\n  /**\r\n   * Get the inverse moment of inertial from the {@apilink ColliderComponent}. If {@apilink CollisionType.Fixed} this is 0, meaning \"infinite\" mass\r\n   */\r\n  public get inverseInertia() {\r\n    if (this._cachedInverseInertia) {\r\n      return this._cachedInverseInertia;\r\n    }\r\n    return (this._cachedInverseInertia = this.collisionType === CollisionType.Fixed ? 0 : 1 / this.inertia);\r\n  }\r\n\r\n  /**\r\n   * The also known as coefficient of restitution of this actor, represents the amount of energy preserved after collision or the\r\n   * bounciness. If 1, it is 100% bouncy, 0 it completely absorbs.\r\n   */\r\n  public bounciness: number = 0.2;\r\n\r\n  /**\r\n   * The coefficient of friction on this actor.\r\n   *\r\n   * The {@apilink SolverStrategy.Arcade} does not support this property.\r\n   *\r\n   */\r\n  public friction: number = 0.99;\r\n\r\n  /**\r\n   * Should use global gravity {@apilink Physics.gravity} in it's physics simulation, default is true\r\n   */\r\n  public useGravity: boolean = true;\r\n\r\n  /**\r\n   * Degrees of freedom to limit\r\n   *\r\n   * Note: this only limits responses in the realistic solver, if velocity/angularVelocity is set the actor will still respond\r\n   */\r\n  public limitDegreeOfFreedom: DegreeOfFreedom[] = [];\r\n\r\n  /**\r\n   * Returns if the owner is active\r\n   * @deprecated use isActive\r\n   */\r\n  public get active() {\r\n    return !!this.owner?.isActive;\r\n  }\r\n\r\n  /**\r\n   * Returns if the owner is active\r\n   */\r\n  public get isActive() {\r\n    return !!this.owner?.isActive;\r\n  }\r\n\r\n  /**\r\n   * @deprecated Use globalPos\r\n   */\r\n  public get center() {\r\n    return this.globalPos;\r\n  }\r\n\r\n  public transform: TransformComponent;\r\n  public motion: MotionComponent;\r\n\r\n  override onAdd(owner: Entity<any>): void {\r\n    this.transform = this.owner?.get(TransformComponent);\r\n    this.motion = this.owner?.get(MotionComponent);\r\n  }\r\n\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  public set pos(val: Vector) {\r\n    this.transform.pos = val;\r\n  }\r\n\r\n  /**\r\n   * The (x, y) position of the actor this will be in the middle of the actor if the\r\n   * {@apilink Actor.anchor} is set to (0.5, 0.5) which is default.\r\n   * If you want the (x, y) position to be the top left of the actor specify an anchor of (0, 0).\r\n   */\r\n  public get globalPos(): Vector {\r\n    return this.transform.globalPos;\r\n  }\r\n\r\n  public set globalPos(val: Vector) {\r\n    this.transform.globalPos = val;\r\n  }\r\n\r\n  private _oldGlobalPos: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The position of the actor last frame (x, y) in pixels\r\n   */\r\n  public get oldPos(): Vector {\r\n    return this.oldTransform.pos;\r\n  }\r\n\r\n  /**\r\n   * The global position of the actor last frame (x, y) in pixels\r\n   */\r\n  public get oldGlobalPos(): Vector {\r\n    return this._oldGlobalPos;\r\n  }\r\n\r\n  /**\r\n   * The current velocity vector (vx, vy) of the actor in pixels/second\r\n   */\r\n  public get vel(): Vector {\r\n    return this.motion.vel;\r\n  }\r\n\r\n  public set vel(val: Vector) {\r\n    this.motion.vel = val;\r\n  }\r\n\r\n  /**\r\n   * The velocity of the actor last frame (vx, vy) in pixels/second\r\n   */\r\n  public oldVel: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * The current acceleration vector (ax, ay) of the actor in pixels/second/second. An acceleration pointing down such as (0, 100) may\r\n   * be useful to simulate a gravitational effect.\r\n   */\r\n  public get acc(): Vector {\r\n    return this.motion.acc;\r\n  }\r\n\r\n  public set acc(val: Vector) {\r\n    this.motion.acc = val;\r\n  }\r\n\r\n  /**\r\n   * Gets/sets the acceleration of the actor from the last frame. This does not include the global acc {@apilink Physics.acc}.\r\n   */\r\n  public oldAcc: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The current torque applied to the actor\r\n   */\r\n  public get torque(): number {\r\n    return this.motion.torque;\r\n  }\r\n\r\n  public set torque(val: number) {\r\n    this.motion.torque = val;\r\n  }\r\n\r\n  /**\r\n   * Gets/sets the rotation of the body from the last frame.\r\n   */\r\n  public get oldRotation(): number {\r\n    return this.oldTransform.rotation;\r\n  }\r\n\r\n  /**\r\n   * The rotation of the body in radians\r\n   */\r\n  public get rotation() {\r\n    return this.transform.globalRotation;\r\n  }\r\n\r\n  public set rotation(val: number) {\r\n    this.transform.globalRotation = val;\r\n  }\r\n\r\n  /**\r\n   * The scale vector of the actor\r\n   */\r\n  public get scale(): Vector {\r\n    return this.transform.globalScale;\r\n  }\r\n\r\n  public set scale(val: Vector) {\r\n    this.transform.globalScale = val;\r\n  }\r\n\r\n  /**\r\n   * The scale of the actor last frame\r\n   */\r\n  public get oldScale(): Vector {\r\n    return this.oldTransform.scale;\r\n  }\r\n\r\n  /**\r\n   * The scale rate of change of the actor in scale/second\r\n   */\r\n  public get scaleFactor(): Vector {\r\n    return this.motion.scaleFactor;\r\n  }\r\n\r\n  public set scaleFactor(scaleFactor: Vector) {\r\n    this.motion.scaleFactor = scaleFactor;\r\n  }\r\n\r\n  /**\r\n   * Get the angular velocity in radians/second\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this.motion.angularVelocity;\r\n  }\r\n\r\n  /**\r\n   * Set the angular velocity in radians/second\r\n   */\r\n  public set angularVelocity(value: number) {\r\n    this.motion.angularVelocity = value;\r\n  }\r\n\r\n  private _impulseScratch = vec(0, 0);\r\n  private _distanceFromCenterScratch = vec(0, 0);\r\n  /**\r\n   * Apply a specific impulse to the body\r\n   * @param point\r\n   * @param impulse\r\n   */\r\n  public applyImpulse(point: Vector, impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    const finalImpulse = impulse.scale(this.inverseMass, this._impulseScratch);\r\n    if (this.limitDegreeOfFreedom.indexOf(DegreeOfFreedom.X) > -1) {\r\n      finalImpulse.x = 0;\r\n    }\r\n    if (this.limitDegreeOfFreedom.indexOf(DegreeOfFreedom.Y) > -1) {\r\n      finalImpulse.y = 0;\r\n    }\r\n\r\n    this.vel.addEqual(finalImpulse);\r\n\r\n    if (!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n      const distanceFromCenter = point.sub(this.globalPos, this._distanceFromCenterScratch);\r\n      this.angularVelocity += this.inverseInertia * distanceFromCenter.cross(impulse);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply only linear impulse to the body\r\n   * @param impulse\r\n   */\r\n  public applyLinearImpulse(impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    const finalImpulse = impulse.scale(this.inverseMass);\r\n\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n      finalImpulse.x = 0;\r\n    }\r\n    if (this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n      finalImpulse.y = 0;\r\n    }\r\n\r\n    this.vel = this.vel.add(finalImpulse);\r\n  }\r\n\r\n  /**\r\n   * Apply only angular impulse to the body\r\n   * @param point\r\n   * @param impulse\r\n   */\r\n  public applyAngularImpulse(point: Vector, impulse: Vector) {\r\n    if (this.collisionType !== CollisionType.Active) {\r\n      return; // only active objects participate in the simulation\r\n    }\r\n\r\n    if (!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n      const distanceFromCenter = point.sub(this.globalPos);\r\n      this.angularVelocity += this.inverseInertia * distanceFromCenter.cross(impulse);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the old versions of pos, vel, acc, and scale.\r\n   */\r\n  public captureOldTransform() {\r\n    // Capture old values before integration step updates them\r\n    this.__oldTransformCaptured = true;\r\n    const tx = this.transform.get();\r\n    tx.clone(this.oldTransform);\r\n    this.oldTransform.parent = tx.parent; // also grab parent\r\n    this.oldVel.setTo(this.vel.x, this.vel.y);\r\n    this.oldAcc.setTo(this.acc.x, this.acc.y);\r\n    this.oldGlobalPos.setTo(this.globalPos.x, this.globalPos.y);\r\n  }\r\n\r\n  public clone(): BodyComponent {\r\n    const component = super.clone() as BodyComponent;\r\n    return component;\r\n  }\r\n}\r\n","import { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface RectangleOptions {\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\n/**\r\n * A Rectangle {@apilink Graphic} for drawing rectangles to the {@apilink ExcaliburGraphicsContext}\r\n */\r\nexport class Rectangle extends Raster {\r\n  constructor(options: RasterOptions & RectangleOptions) {\r\n    super(options);\r\n    this.width = options.width;\r\n    this.height = options.height;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Rectangle {\r\n    return new Rectangle({\r\n      width: this.width,\r\n      height: this.height,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.color) {\r\n      ctx.fillRect(0, 0, this.width, this.height);\r\n    }\r\n    if (this.strokeColor) {\r\n      ctx.strokeRect(0, 0, this.width, this.height);\r\n    }\r\n  }\r\n}\r\n","import { ImageFiltering } from './Filtering';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface CircleOptions {\r\n  radius: number;\r\n}\r\n\r\n/**\r\n * A circle {@apilink Graphic} for drawing circles to the {@apilink ExcaliburGraphicsContext}\r\n *\r\n * Circles default to {@apilink ImageFiltering.Blended}\r\n */\r\nexport class Circle extends Raster {\r\n  private _radius: number = 0;\r\n  public get radius() {\r\n    return this._radius;\r\n  }\r\n  public set radius(value: number) {\r\n    this._radius = value;\r\n    this.width = this._radius * 2;\r\n    this.height = this._radius * 2;\r\n    this.flagDirty();\r\n  }\r\n  constructor(options: RasterOptions & CircleOptions) {\r\n    super(options);\r\n    const lineWidth = options.lineWidth ?? (options.strokeColor ? 1 : 0); // default lineWidth in canvas is 1px\r\n    this.padding = options.padding ?? 2 + lineWidth / 2; // default 2 padding for circles looks nice\r\n    this.radius = options.radius;\r\n    this.filtering = options.filtering ?? ImageFiltering.Blended;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Circle {\r\n    return new Circle({\r\n      radius: this.radius,\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.radius > 0) {\r\n      ctx.beginPath();\r\n      ctx.arc(this.radius, this.radius, this.radius, 0, Math.PI * 2);\r\n\r\n      if (this.color) {\r\n        ctx.fill();\r\n      }\r\n\r\n      if (this.strokeColor) {\r\n        ctx.stroke();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Component } from '../EntityComponentSystem/Component';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\n\r\nexport interface PointerComponentOptions {\r\n  useColliderShape?: boolean;\r\n  useGraphicsBounds?: boolean;\r\n  localBounds?: BoundingBox;\r\n}\r\n\r\n/**\r\n * Add this component to optionally configure how the pointer\r\n * system detects pointer events.\r\n *\r\n * By default the collider shape is used and graphics bounds is not.\r\n *\r\n * If both collider shape and graphics bounds are enabled it will fire events if either or\r\n * are intersecting the pointer.\r\n */\r\nexport class PointerComponent extends Component {\r\n  /**\r\n   * Use any existing Collider component geometry for pointer events. This is useful if you want\r\n   * user pointer events only to trigger on the same collision geometry used in the collider component\r\n   * for collision resolution. Default is `true`.\r\n   */\r\n  public useColliderShape = true;\r\n  /**\r\n   * Use any existing Graphics component bounds for pointers. This is useful if you want the axis aligned\r\n   * bounds around the graphic to trigger pointer events. Default is `true`.\r\n   */\r\n  public useGraphicsBounds = true;\r\n\r\n  /**\r\n   * Optionally use other bounds for pointer testing\r\n   */\r\n  public localBounds?: BoundingBox;\r\n\r\n  constructor(options?: PointerComponentOptions) {\r\n    super();\r\n    this.useColliderShape = options?.useColliderShape ?? this.useColliderShape;\r\n    this.useGraphicsBounds = options?.useGraphicsBounds ?? this.useGraphicsBounds;\r\n    this.localBounds = options?.localBounds;\r\n  }\r\n}\r\n","import { Vector } from '../Math/vector';\r\n\r\n/**\r\n * A definition of an EasingFunction. See {@apilink EasingFunctions}.\r\n */\r\n// tslint:disable-next-line\r\nexport interface EasingFunction<TValueToEase = number> {\r\n  (currentTime: number, startValue: TValueToEase, endValue: TValueToEase, duration: number): TValueToEase;\r\n}\r\n\r\n/**\r\n * Standard easing functions for motion in Excalibur, defined on a domain of [0, duration] and a range from [+startValue,+endValue]\r\n * Given a time, the function will return a value from positive startValue to positive endValue.\r\n *\r\n * ```js\r\n * function Linear (t) {\r\n *    return t * t;\r\n * }\r\n *\r\n * // accelerating from zero velocity\r\n * function EaseInQuad (t) {\r\n *    return t * t;\r\n * }\r\n *\r\n * // decelerating to zero velocity\r\n * function EaseOutQuad (t) {\r\n *    return t * (2 - t);\r\n * }\r\n *\r\n * // acceleration until halfway, then deceleration\r\n * function EaseInOutQuad (t) {\r\n *    return t < .5 ? 2 * t * t : -1 + (4 - 2 * t) * t;\r\n * }\r\n *\r\n * // accelerating from zero velocity\r\n * function EaseInCubic (t) {\r\n *    return t * t * t;\r\n * }\r\n *\r\n * // decelerating to zero velocity\r\n * function EaseOutCubic (t) {\r\n *    return (--t) * t * t + 1;\r\n * }\r\n *\r\n * // acceleration until halfway, then deceleration\r\n * function EaseInOutCubic (t) {\r\n *    return t < .5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;\r\n * }\r\n * ```\r\n */\r\nexport class EasingFunctions {\r\n  public static CreateReversibleEasingFunction(easing: EasingFunction): EasingFunction {\r\n    return (time: number, start: number, end: number, duration: number) => {\r\n      if (end < start) {\r\n        return start - (easing(time, end, start, duration) - end);\r\n      } else {\r\n        return easing(time, start, end, duration);\r\n      }\r\n    };\r\n  }\r\n\r\n  public static CreateVectorEasingFunction(easing: EasingFunction<number>): EasingFunction<Vector> {\r\n    return (time: number, start: Vector, end: Vector, duration: number) => {\r\n      return new Vector(easing(time, start.x, end.x, duration), easing(time, start.y, end.y, duration));\r\n    };\r\n  }\r\n\r\n  public static Linear: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      return (endValue * currentTime) / duration + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInQuad = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n\r\n      return endValue * currentTime * currentTime + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseOutQuad: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n      return -endValue * currentTime * (currentTime - 2) + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInOutQuad: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration / 2;\r\n\r\n      if (currentTime < 1) {\r\n        return (endValue / 2) * currentTime * currentTime + startValue;\r\n      }\r\n      currentTime--;\r\n\r\n      return (-endValue / 2) * (currentTime * (currentTime - 2) - 1) + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n      return endValue * currentTime * currentTime * currentTime + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseOutCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration;\r\n      currentTime--;\r\n      return endValue * (currentTime * currentTime * currentTime + 1) + startValue;\r\n    }\r\n  );\r\n\r\n  public static EaseInOutCubic: EasingFunction = EasingFunctions.CreateReversibleEasingFunction(\r\n    (currentTime: number, startValue: number, endValue: number, duration: number) => {\r\n      endValue = endValue - startValue;\r\n      currentTime /= duration / 2;\r\n      if (currentTime < 1) {\r\n        return (endValue / 2) * currentTime * currentTime * currentTime + startValue;\r\n      }\r\n      currentTime -= 2;\r\n      return (endValue / 2) * (currentTime * currentTime * currentTime + 2) + startValue;\r\n    }\r\n  );\r\n}\r\n","import { ActionCompleteEvent, ActionStartEvent } from '../Events';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Action } from './Action';\r\n\r\n/**\r\n * Action Queues represent an ordered sequence of actions\r\n *\r\n * Action queues are part of the {@apilink ActionContext | `Action API`} and\r\n * store the list of actions to be executed for an {@apilink Actor}.\r\n *\r\n * Actors implement {@apilink Actor.actions} which can be manipulated by\r\n * advanced users to adjust the actions currently being executed in the\r\n * queue.\r\n */\r\nexport class ActionQueue {\r\n  private _entity: Entity;\r\n  private _actions: Action[] = [];\r\n  private _currentAction: Action | null = null;\r\n  private _completedActions: Action[] = [];\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n  }\r\n\r\n  /**\r\n   * Add an action to the sequence\r\n   * @param action\r\n   */\r\n  public add(action: Action) {\r\n    this._actions.push(action);\r\n  }\r\n\r\n  /**\r\n   * Remove an action by reference from the sequence\r\n   * @param action\r\n   */\r\n  public remove(action: Action) {\r\n    const index = this._actions.indexOf(action);\r\n    this._actions.splice(index, 1);\r\n  }\r\n\r\n  /**\r\n   * Removes all actions from this sequence\r\n   */\r\n  public clearActions(): void {\r\n    this._actions.length = 0;\r\n    this._completedActions.length = 0;\r\n    if (this._currentAction) {\r\n      this._currentAction.stop();\r\n    }\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns The total list of actions in this sequence complete or not\r\n   */\r\n  public getActions(): Action[] {\r\n    return this._actions.concat(this._completedActions);\r\n  }\r\n\r\n  public getIncompleteActions(): Action[] {\r\n    return this._actions;\r\n  }\r\n\r\n  public getCurrentAction(): Action | null {\r\n    return this._currentAction;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @returns `true` if there are more actions to process in the sequence\r\n   */\r\n  public hasNext(): boolean {\r\n    return this._actions.length > 0;\r\n  }\r\n\r\n  /**\r\n   * @returns `true` if the current sequence of actions is done\r\n   */\r\n  public isComplete(): boolean {\r\n    return this._actions.length === 0;\r\n  }\r\n\r\n  /**\r\n   * Resets the sequence of actions, this is used to restart a sequence from the beginning\r\n   */\r\n  public reset(): void {\r\n    this._actions = this.getActions();\r\n\r\n    const len = this._actions.length;\r\n    for (let i = 0; i < len; i++) {\r\n      this._actions[i].reset();\r\n    }\r\n    this._completedActions = [];\r\n  }\r\n\r\n  /**\r\n   * Update the queue which updates actions and handles completing actions\r\n   * @param elapsed\r\n   */\r\n  public update(elapsed: number) {\r\n    if (this._actions.length > 0) {\r\n      if (this._currentAction !== this._actions[0]) {\r\n        this._currentAction = this._actions[0];\r\n        this._entity.emit('actionstart', new ActionStartEvent(this._currentAction, this._entity));\r\n      }\r\n\r\n      this._currentAction.update(elapsed);\r\n\r\n      if (this._currentAction.isComplete(this._entity)) {\r\n        this._entity.emit('actioncomplete', new ActionCompleteEvent(this._currentAction, this._entity));\r\n        const complete = this._actions.shift();\r\n        if (complete) {\r\n          this._completedActions.push(complete);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Entity } from '../EntityComponentSystem/Entity';\r\n\r\n/**\r\n * Used for implementing actions for the {@apilink ActionContext | `Action API`}.\r\n */\r\nexport interface Action {\r\n  id: number;\r\n  update(elapsed: number): void;\r\n  isComplete(entity: Entity): boolean;\r\n  reset(): void;\r\n  stop(): void;\r\n}\r\n\r\nlet _ACTION_ID = 0;\r\n/**\r\n *\r\n */\r\nexport function nextActionId(): number {\r\n  return _ACTION_ID++;\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\nexport class Repeat implements Action {\r\n  id = nextActionId();\r\n  private _actionQueue: ActionQueue;\r\n  private _repeat: number;\r\n  private _originalRepeat: number;\r\n  private _stopped: boolean = false;\r\n  private _repeatContext: ActionContext;\r\n  private _repeatBuilder: (repeatContext: ActionContext) => any;\r\n  constructor(entity: Entity, repeatBuilder: (repeatContext: ActionContext) => any, repeat: number) {\r\n    this._repeatBuilder = repeatBuilder;\r\n    this._repeatContext = new ActionContext(entity);\r\n    this._actionQueue = this._repeatContext.getQueue();\r\n\r\n    this._repeat = repeat;\r\n    this._originalRepeat = repeat;\r\n\r\n    this._repeatBuilder(this._repeatContext);\r\n    this._repeat--; // current execution is the first repeat\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (this._actionQueue.isComplete()) {\r\n      this._actionQueue.clearActions();\r\n      this._repeatBuilder(this._repeatContext);\r\n      this._repeat--;\r\n    }\r\n    this._actionQueue.update(elapsed);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || (this._repeat <= 0 && this._actionQueue.isComplete());\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._repeat = this._originalRepeat;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\n/**\r\n * RepeatForever Action implementation, it is recommended you use the fluent action\r\n * context API.\r\n *\r\n *\r\n */\r\nexport class RepeatForever implements Action {\r\n  id = nextActionId();\r\n  private _actionQueue: ActionQueue;\r\n  private _stopped: boolean = false;\r\n  private _repeatContext: ActionContext;\r\n  private _repeatBuilder: (repeatContext: ActionContext) => any;\r\n  constructor(entity: Entity, repeatBuilder: (repeatContext: ActionContext) => any) {\r\n    this._repeatBuilder = repeatBuilder;\r\n    this._repeatContext = new ActionContext(entity);\r\n    this._actionQueue = this._repeatContext.getQueue();\r\n\r\n    this._repeatBuilder(this._repeatContext);\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (this._stopped) {\r\n      return;\r\n    }\r\n\r\n    if (this._actionQueue.isComplete()) {\r\n      this._actionQueue.clearActions();\r\n      this._repeatBuilder(this._repeatContext);\r\n    }\r\n\r\n    this._actionQueue.update(elapsed);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n    this._actionQueue.clearActions();\r\n  }\r\n\r\n  public reset(): void {\r\n    return;\r\n  }\r\n}\r\n","import { RotationType } from './rotation-type';\r\nimport { TwoPI } from './util';\r\nimport { Vector } from './vector';\r\n\r\n/**\r\n * Linear interpolation between `a` and `b`, at `time = 0` the value will be `a` at `time = 1` the value will be `b`\r\n * @param a\r\n * @param b\r\n * @param time\r\n */\r\nexport function lerp(a: number, b: number, time: number): number {\r\n  return (1 - time) * a + b * time;\r\n}\r\n\r\n/**\r\n * Linear interpolation between angles in radians\r\n * @param startAngle\r\n * @param endAngle\r\n * @param rotationType\r\n * @param time\r\n */\r\nexport function lerpAngle(startAngle: number, endAngle: number, rotationType: RotationType, time: number): number {\r\n  const shortestPathIsPositive = (startAngle - endAngle + TwoPI) % TwoPI >= Math.PI;\r\n  const distance1 = Math.abs(endAngle - startAngle);\r\n  const distance2 = TwoPI - distance1;\r\n  let shortDistance = 0;\r\n  let longDistance = 0;\r\n  if (distance1 > distance2) {\r\n    shortDistance = distance2;\r\n    longDistance = distance1;\r\n  } else {\r\n    shortDistance = distance1;\r\n    longDistance = distance2;\r\n  }\r\n  let distance = 0;\r\n  let direction = 1;\r\n\r\n  switch (rotationType) {\r\n    case RotationType.ShortestPath:\r\n      distance = shortDistance;\r\n      direction = shortestPathIsPositive ? 1 : -1;\r\n      break;\r\n    case RotationType.LongestPath:\r\n      distance = longDistance;\r\n      direction = shortestPathIsPositive ? -1 : 1;\r\n      break;\r\n    case RotationType.Clockwise:\r\n      direction = 1;\r\n      distance = shortestPathIsPositive ? shortDistance : longDistance;\r\n      break;\r\n    case RotationType.CounterClockwise:\r\n      direction = -1;\r\n      distance = shortestPathIsPositive ? longDistance : shortDistance;\r\n      break;\r\n  }\r\n\r\n  return startAngle + direction * (distance * time);\r\n}\r\n\r\n/**\r\n * Linear interpolation between `a` and `b`, at `time = 0` the value will be `a` at `time = 1` the value will be `b`\r\n * @param a\r\n * @param b\r\n * @param time\r\n */\r\nexport function lerpVector(a: Vector, b: Vector, time: number): Vector {\r\n  return a.scale(1 - time).add(b.scale(time));\r\n}\r\n\r\n/**\r\n * Inverse of a linear interpolation, given a `value` in between `a` and `b` return how close to `a` or `b` the `value` is.\r\n *\r\n * Example: `a=1`, `b=5`, `value=4` will return `.75`\r\n * @param a\r\n * @param b\r\n * @param value\r\n */\r\nexport function inverseLerp(a: number, b: number, value: number): number {\r\n  return (value - a) / (b - a);\r\n}\r\n\r\n/**\r\n * Inverse of a linear interpolation, given a `value` in between `a` and `b` return how close to `a` or `b` the `value` is.\r\n *\r\n * **Warning** assumes that the `value` vector is co-linear with vector `a` and `b`\r\n *\r\n * Example: `a=1`, `b=5`, `value=4` will return `.75`\r\n * @param a\r\n * @param b\r\n * @param value\r\n */\r\nexport function inverseLerpVector(a: Vector, b: Vector, value: Vector): number {\r\n  const numerator = value.sub(a);\r\n  const denominator = b.sub(a);\r\n  const x = numerator.x / denominator.x;\r\n  const y = numerator.y / denominator.y;\r\n  return Math.min(x, y);\r\n}\r\n\r\n/**\r\n * Remaps a value from a source domain to a destination\r\n * @param minSource\r\n * @param maxSource\r\n * @param minDestination\r\n * @param maxDestination\r\n * @param value\r\n */\r\nexport function remap(minSource: number, maxSource: number, minDestination: number, maxDestination: number, value: number): number {\r\n  const time = inverseLerp(minSource, maxSource, value);\r\n  return lerp(minDestination, maxDestination, time);\r\n}\r\n\r\n/**\r\n * Remaps a value from a source domain to a destination\r\n *\r\n * **Warning** assumes that the `value` vector is co-linear with vector `minSource` and `maxSource`\r\n * @param minSource\r\n * @param maxSource\r\n * @param minDestination\r\n * @param maxDestination\r\n * @param value\r\n */\r\nexport function remapVector(minSource: Vector, maxSource: Vector, minDestination: Vector, maxDestination: Vector, value: Vector): Vector {\r\n  const time = inverseLerpVector(minSource, maxSource, value);\r\n  return lerpVector(minDestination, maxDestination, time);\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { clamp, remap } from '../../Math';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { EasingFunction, EasingFunctions } from '../../Util/EasingFunctions';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport interface MoveByOptions {\r\n  offset: Vector;\r\n  duration: number;\r\n  easing?: EasingFunction;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isMoveByOptions(x: any): x is MoveByOptions {\r\n  return x.offset instanceof Vector && typeof x.duration === 'number';\r\n}\r\n\r\nexport class MoveByWithOptions implements Action {\r\n  id = nextActionId();\r\n  private _start!: Vector;\r\n  private _end!: Vector;\r\n  private _durationMs: number;\r\n  private _tx: TransformComponent;\r\n  private _started: boolean = false;\r\n  private _currentMs: number;\r\n  private _stopped: boolean = false;\r\n  private _motion: MotionComponent;\r\n  private _offset: Vector;\r\n  private _easing: EasingFunction = EasingFunctions.Linear;\r\n  constructor(\r\n    public entity: Entity,\r\n    options: MoveByOptions\r\n  ) {\r\n    this._offset = options.offset;\r\n    this._easing = options.easing ?? this._easing;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);\r\n    }\r\n    this._durationMs = options.duration;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._start = this._tx.pos.clone();\r\n      this._end = this._start.add(this._offset);\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    const currentPos = this._tx.pos;\r\n    const newPosX = this._easing(t, this._start.x, this._end.x, 1);\r\n    const newPosY = this._easing(t, this._start.y, this._end.y, 1);\r\n    const velX = (newPosX - currentPos.x) / (elapsed / 1000);\r\n    const velY = (newPosY - currentPos.y) / (elapsed / 1000);\r\n    this._motion.vel.x = velX;\r\n    this._motion.vel.y = velY;\r\n\r\n    if (this.isComplete(this.entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n  public isComplete(entity: Entity): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n\r\nexport class MoveBy implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _entity: Entity;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _distance!: number;\r\n  private _speed: number;\r\n\r\n  private _start!: Vector;\r\n  private _offset!: Vector;\r\n  private _end!: Vector;\r\n  private _dir!: Vector;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, offsetX: number, offsetY: number, speed: number) {\r\n    this._entity = entity;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._speed = speed;\r\n    this._offset = new Vector(offsetX, offsetY);\r\n    if (speed <= 0) {\r\n      Logger.getInstance().error('Attempted to moveBy with speed less than or equal to zero : ' + speed);\r\n      throw new Error('Speed must be greater than 0 pixels per second');\r\n    }\r\n  }\r\n\r\n  public update(elapsed: number) {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n      this._end = this._start.add(this._offset);\r\n      this._distance = this._offset.magnitude;\r\n      this._dir = this._end.sub(this._start).normalize();\r\n    }\r\n\r\n    if (this.isComplete(this._entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    } else {\r\n      this._motion.vel = this._dir.scale(this._speed);\r\n    }\r\n  }\r\n\r\n  public isComplete(entity: Entity): boolean {\r\n    const tx = entity.get(TransformComponent);\r\n    return this._stopped || tx.pos.distance(this._start) >= this._distance;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { clamp, remap } from '../../Math';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { EasingFunction, EasingFunctions } from '../../Util/EasingFunctions';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport interface MoveToOptions {\r\n  pos: Vector;\r\n  duration: number;\r\n  easing?: EasingFunction;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isMoveToOptions(x: any): x is MoveToOptions {\r\n  return x.pos instanceof Vector && typeof x.duration === 'number';\r\n}\r\n\r\nexport class MoveToWithOptions implements Action {\r\n  id = nextActionId();\r\n  private _end: Vector;\r\n  private _durationMs: number;\r\n  private _tx: TransformComponent;\r\n  private _started: boolean = false;\r\n  private _start!: Vector;\r\n  private _currentMs: number;\r\n  private _stopped: boolean = false;\r\n  private _motion: MotionComponent;\r\n  private _easing: EasingFunction = EasingFunctions.Linear;\r\n  constructor(\r\n    public entity: Entity,\r\n    options: MoveToOptions\r\n  ) {\r\n    this._end = options.pos;\r\n    this._easing = options.easing ?? this._easing;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);\r\n    }\r\n    this._durationMs = options.duration;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._start = this._tx.pos.clone();\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    const currentPos = this._tx.pos;\r\n    const newPosX = this._easing(t, this._start.x, this._end.x, 1);\r\n    const newPosY = this._easing(t, this._start.y, this._end.y, 1);\r\n    const velX = (newPosX - currentPos.x) / (elapsed / 1000);\r\n    const velY = (newPosY - currentPos.y) / (elapsed / 1000);\r\n    this._motion.vel.x = velX;\r\n    this._motion.vel.y = velY;\r\n\r\n    if (this.isComplete(this.entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n  public isComplete(entity: Entity): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n\r\nexport class MoveTo implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _start!: Vector;\r\n  private _end: Vector;\r\n  private _dir!: Vector;\r\n  private _speed: number;\r\n  private _distance!: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(\r\n    public entity: Entity,\r\n    destX: number,\r\n    destY: number,\r\n    speed: number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._end = new Vector(destX, destY);\r\n    this._speed = speed;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n      this._distance = this._start.distance(this._end);\r\n      this._dir = this._end.sub(this._start).normalize();\r\n    }\r\n    const m = this._dir.scale(this._speed);\r\n    this._motion.vel = vec(m.x, m.y);\r\n\r\n    if (this.isComplete(this.entity)) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public isComplete(entity: Entity): boolean {\r\n    const tx = entity.get(TransformComponent);\r\n    return this._stopped || new Vector(tx.pos.x, tx.pos.y).distance(this._start) >= this._distance;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action, nextActionId } from '../Action';\r\nimport { RotationType } from '../../Math';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { clamp, TwoPI } from '../../Math/util';\r\nimport { lerpAngle, remap } from '../../Math';\r\n\r\nexport interface RotateToOptions {\r\n  /**\r\n   * Absolute angle to rotate to in radians\r\n   */\r\n  angle: number;\r\n  /**\r\n   * Duration to take in milliseconds\r\n   */\r\n  duration: number;\r\n  /**\r\n   * Optionally provide type of rotation, default is RotationType.ShortestPath\r\n   */\r\n  rotationType?: RotationType;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isRotateToOptions(x: any): x is RotateToOptions {\r\n  return typeof x.angle === 'number' && typeof x.duration === 'number';\r\n}\r\n\r\nexport class RotateToWithOptions implements Action {\r\n  id = nextActionId();\r\n  private _durationMs: number;\r\n  private _tx: TransformComponent;\r\n  private _started: boolean = false;\r\n  private _currentMs: number;\r\n  private _stopped: boolean = false;\r\n  private _motion: MotionComponent;\r\n  private _endAngle: number = 0;\r\n  private _startAngle: number = 0;\r\n  private _rotationType: RotationType;\r\n  constructor(\r\n    public entity: Entity,\r\n    options: RotateToOptions\r\n  ) {\r\n    this._endAngle = options.angle;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);\r\n    }\r\n    this._durationMs = options.duration;\r\n    this._rotationType = options.rotationType ?? RotationType.ShortestPath;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._startAngle = this._tx.rotation;\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    const newAngle = lerpAngle(this._startAngle, this._endAngle, this._rotationType, t);\r\n    const currentAngle = this._tx.rotation;\r\n\r\n    const rx = (newAngle - currentAngle) / (elapsed / 1000);\r\n    this._motion.angularVelocity = rx;\r\n\r\n    if (this.isComplete(this.entity)) {\r\n      this._tx.rotation = this._endAngle;\r\n      this._motion.angularVelocity = 0;\r\n    }\r\n  }\r\n  public isComplete(entity: Entity): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n\r\nexport class RotateTo implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _start!: number;\r\n  private _end: number;\r\n  private _speed: number;\r\n  private _rotationType: RotationType;\r\n  private _direction!: number;\r\n  private _distance!: number;\r\n  private _shortDistance!: number;\r\n  private _longDistance!: number;\r\n  private _shortestPathIsPositive!: boolean;\r\n  private _currentNonCannonAngle!: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, angle: number, speed: number, rotationType?: RotationType) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._end = angle;\r\n    this._speed = speed;\r\n    this._rotationType = rotationType || RotationType.ShortestPath;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = this._tx.rotation;\r\n      this._currentNonCannonAngle = this._tx.rotation;\r\n      const distance1 = Math.abs(this._end - this._start);\r\n      const distance2 = TwoPI - distance1;\r\n      if (distance1 > distance2) {\r\n        this._shortDistance = distance2;\r\n        this._longDistance = distance1;\r\n      } else {\r\n        this._shortDistance = distance1;\r\n        this._longDistance = distance2;\r\n      }\r\n\r\n      this._shortestPathIsPositive = (this._start - this._end + TwoPI) % TwoPI >= Math.PI;\r\n\r\n      switch (this._rotationType) {\r\n        case RotationType.ShortestPath:\r\n          this._distance = this._shortDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = 1;\r\n          } else {\r\n            this._direction = -1;\r\n          }\r\n          break;\r\n        case RotationType.LongestPath:\r\n          this._distance = this._longDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = -1;\r\n          } else {\r\n            this._direction = 1;\r\n          }\r\n          break;\r\n        case RotationType.Clockwise:\r\n          this._direction = 1;\r\n          if (this._shortestPathIsPositive) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n        case RotationType.CounterClockwise:\r\n          this._direction = -1;\r\n          if (!this._shortestPathIsPositive) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    this._motion.angularVelocity = this._direction * this._speed;\r\n    this._currentNonCannonAngle += this._direction * this._speed * (elapsed / 1000);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._end;\r\n      this._motion.angularVelocity = 0;\r\n      this._stopped = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    const distanceTraveled = Math.abs(this._currentNonCannonAngle - this._start);\r\n    return this._stopped || distanceTraveled >= Math.abs(this._distance);\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action, nextActionId } from '../Action';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { canonicalizeAngle, clamp, TwoPI } from '../../Math/util';\r\nimport { lerpAngle, remap, RotationType } from '../../Math';\r\n\r\nexport interface RotateByOptions {\r\n  /**\r\n   * Angle in radians to offset from the current and rotate\r\n   */\r\n  angleRadiansOffset: number;\r\n  /**\r\n   * Duration to take in milliseconds\r\n   */\r\n  duration: number;\r\n  /**\r\n   * Optionally provide type of rotation, default is RotationType.ShortestPath\r\n   */\r\n  rotationType?: RotationType;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isRotateByOptions(x: any): x is RotateByOptions {\r\n  return typeof x.angleRadiansOffset === 'number' && typeof x.duration === 'number';\r\n}\r\n\r\nexport class RotateByWithOptions implements Action {\r\n  id = nextActionId();\r\n  private _durationMs: number;\r\n  private _tx: TransformComponent;\r\n  private _started: boolean = false;\r\n  private _currentMs: number;\r\n  private _stopped: boolean = false;\r\n  private _motion: MotionComponent;\r\n  private _offset: number = 0;\r\n  private _startAngle: number = 0;\r\n  private _rotationType: RotationType;\r\n  private _endAngle: number = 0;\r\n  constructor(\r\n    public entity: Entity,\r\n    options: RotateByOptions\r\n  ) {\r\n    this._offset = options.angleRadiansOffset;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);\r\n    }\r\n    this._durationMs = options.duration;\r\n    this._rotationType = options.rotationType ?? RotationType.ShortestPath;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._startAngle = this._tx.rotation;\r\n      this._endAngle = canonicalizeAngle(this._startAngle + this._offset);\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    const newAngle = lerpAngle(this._startAngle, this._endAngle, this._rotationType, t);\r\n    const currentAngle = this._tx.rotation;\r\n\r\n    const rx = (newAngle - currentAngle) / (elapsed / 1000);\r\n    this._motion.angularVelocity = rx;\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._endAngle;\r\n      this._motion.angularVelocity = 0;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n\r\nexport class RotateBy implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _start!: number;\r\n  private _end!: number;\r\n  private _speed: number;\r\n  private _offset: number;\r\n\r\n  private _rotationType: RotationType;\r\n  private _direction!: number;\r\n  private _distance!: number;\r\n  private _shortDistance!: number;\r\n  private _longDistance!: number;\r\n  private _shortestPathIsPositive!: boolean;\r\n  private _currentNonCannonAngle!: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, angleRadiansOffset: number, speed: number, rotationType?: RotationType) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._speed = speed;\r\n    this._offset = angleRadiansOffset;\r\n    this._rotationType = rotationType || RotationType.ShortestPath;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._start = this._tx.rotation;\r\n      this._currentNonCannonAngle = this._tx.rotation;\r\n      this._end = this._start + this._offset;\r\n\r\n      const distance1 = Math.abs(this._end - this._start);\r\n      const distance2 = TwoPI - distance1;\r\n      if (distance1 > distance2) {\r\n        this._shortDistance = distance2;\r\n        this._longDistance = distance1;\r\n      } else {\r\n        this._shortDistance = distance1;\r\n        this._longDistance = distance2;\r\n      }\r\n\r\n      this._shortestPathIsPositive = (this._start - this._end + TwoPI) % TwoPI >= Math.PI;\r\n\r\n      switch (this._rotationType) {\r\n        case RotationType.ShortestPath:\r\n          this._distance = this._shortDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = 1;\r\n          } else {\r\n            this._direction = -1;\r\n          }\r\n          break;\r\n        case RotationType.LongestPath:\r\n          this._distance = this._longDistance;\r\n          if (this._shortestPathIsPositive) {\r\n            this._direction = -1;\r\n          } else {\r\n            this._direction = 1;\r\n          }\r\n          break;\r\n        case RotationType.Clockwise:\r\n          this._direction = 1;\r\n          if (this._shortDistance >= 0) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n        case RotationType.CounterClockwise:\r\n          this._direction = -1;\r\n          if (this._shortDistance <= 0) {\r\n            this._distance = this._shortDistance;\r\n          } else {\r\n            this._distance = this._longDistance;\r\n          }\r\n          break;\r\n      }\r\n    }\r\n\r\n    this._motion.angularVelocity = this._direction * this._speed;\r\n    this._currentNonCannonAngle += this._direction * this._speed * (elapsed / 1000);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.rotation = this._end;\r\n      this._motion.angularVelocity = 0;\r\n      this._stopped = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    const distanceTraveled = Math.abs(this._currentNonCannonAngle - this._start);\r\n    return this._stopped || distanceTraveled >= Math.abs(this._distance);\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.angularVelocity = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._start = undefined as any;\r\n    this._currentNonCannonAngle = undefined as any;\r\n    this._distance = undefined as any;\r\n  }\r\n}\r\n","import { vec, Vector } from '../../Math/vector';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { clamp, lerpVector, remap } from '../../Math';\r\n\r\nexport interface ScaleToOptions {\r\n  /**\r\n   * Absolute scale to change to\r\n   */\r\n  scale: Vector;\r\n  /**\r\n   * Duration to take in milliseconds\r\n   */\r\n  duration: number;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isScaleToOptions(x: any): x is ScaleToOptions {\r\n  return typeof x.scale === 'object' && typeof x.duration === 'number';\r\n}\r\n\r\nexport class ScaleToWithOptions implements Action {\r\n  id = nextActionId();\r\n  private _durationMs: number;\r\n  private _tx: TransformComponent;\r\n  private _started: boolean = false;\r\n  private _currentMs: number;\r\n  private _stopped: boolean = false;\r\n  private _motion: MotionComponent;\r\n  private _endScale: Vector = vec(1, 1);\r\n  private _startScale: Vector = vec(1, 1);\r\n  constructor(\r\n    public entity: Entity,\r\n    options: ScaleToOptions\r\n  ) {\r\n    this._endScale = options.scale;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);\r\n    }\r\n    this._durationMs = options.duration;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._startScale = this._tx.scale;\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    const newScale = lerpVector(this._startScale, this._endScale, t);\r\n    const currentScale = this._tx.scale;\r\n\r\n    const sx = newScale.sub(currentScale).scale(1 / (elapsed / 1000));\r\n    this._motion.scaleFactor = sx;\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = this._endScale;\r\n      this._motion.angularVelocity = 0;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor = Vector.Zero;\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n\r\nexport class ScaleTo implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _startX!: number;\r\n  private _startY!: number;\r\n  private _endX: number;\r\n  private _endY: number;\r\n  private _speedX: number;\r\n  private _speedY: number;\r\n  private _distanceX!: number;\r\n  private _distanceY!: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  constructor(entity: Entity, scaleX: number, scaleY: number, speedX: number, speedY: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._endX = scaleX;\r\n    this._endY = scaleY;\r\n    this._speedX = speedX;\r\n    this._speedY = speedY;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._startX = this._tx.scale.x;\r\n      this._startY = this._tx.scale.y;\r\n      this._distanceX = Math.abs(this._endX - this._startX);\r\n      this._distanceY = Math.abs(this._endY - this._startY);\r\n    }\r\n\r\n    if (!(Math.abs(this._tx.scale.x - this._startX) >= this._distanceX)) {\r\n      const directionX = this._endY < this._startY ? -1 : 1;\r\n      this._motion.scaleFactor.x = this._speedX * directionX;\r\n    } else {\r\n      this._motion.scaleFactor.x = 0;\r\n    }\r\n\r\n    if (!(Math.abs(this._tx.scale.y - this._startY) >= this._distanceY)) {\r\n      const directionY = this._endY < this._startY ? -1 : 1;\r\n      this._motion.scaleFactor.y = this._speedY * directionY;\r\n    } else {\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = vec(this._endX, this._endY);\r\n      this._motion.scaleFactor.x = 0;\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return (\r\n      this._stopped ||\r\n      (Math.abs(this._tx.scale.x - this._startX) >= this._distanceX - 0.01 &&\r\n        Math.abs(this._tx.scale.y - this._startY) >= this._distanceY - 0.01)\r\n    );\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor.x = 0;\r\n    this._motion.scaleFactor.y = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { vec, Vector } from '../../Math/vector';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { clamp, lerpVector, remap } from '../../Math';\r\n\r\nexport interface ScaleByOptions {\r\n  /**\r\n   * Absolute scale to change to\r\n   */\r\n  scaleOffset: Vector;\r\n  /**\r\n   * Duration to take in milliseconds\r\n   */\r\n  duration: number;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isScaleByOptions(x: any): x is ScaleByOptions {\r\n  return typeof x.scaleOffset === 'object' && typeof x.duration === 'number';\r\n}\r\n\r\nexport class ScaleByWithOptions implements Action {\r\n  id = nextActionId();\r\n  private _durationMs: number;\r\n  private _tx: TransformComponent;\r\n  private _started: boolean = false;\r\n  private _currentMs: number;\r\n  private _stopped: boolean = false;\r\n  private _motion: MotionComponent;\r\n  private _endScale: Vector = vec(1, 1);\r\n  private _scaleOffset: Vector = vec(0, 0);\r\n  private _startScale: Vector = vec(1, 1);\r\n  constructor(\r\n    public entity: Entity,\r\n    options: ScaleByOptions\r\n  ) {\r\n    this._scaleOffset = options.scaleOffset;\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);\r\n    }\r\n    this._durationMs = options.duration;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._startScale = this._tx.scale;\r\n      this._endScale = this._startScale.add(this._scaleOffset);\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    const newScale = lerpVector(this._startScale, this._endScale, t);\r\n    const currentScale = this._tx.scale;\r\n    const sx = newScale.sub(currentScale).scale(1 / (elapsed / 1000));\r\n    this._motion.scaleFactor = sx;\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = this._endScale;\r\n      this._motion.angularVelocity = 0;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor = Vector.Zero;\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n\r\nexport class ScaleBy implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _startScale!: Vector;\r\n  private _endScale!: Vector;\r\n  private _offset: Vector;\r\n  private _distanceX!: number;\r\n  private _distanceY!: number;\r\n  private _directionX!: number;\r\n  private _directionY!: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _speedX: number;\r\n  private _speedY: number;\r\n  constructor(entity: Entity, scaleOffsetX: number, scaleOffsetY: number, speed: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._offset = new Vector(scaleOffsetX, scaleOffsetY);\r\n    this._speedX = this._speedY = speed;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._startScale = this._tx.scale.clone();\r\n      this._endScale = this._startScale.add(this._offset);\r\n      this._distanceX = Math.abs(this._endScale.x - this._startScale.x);\r\n      this._distanceY = Math.abs(this._endScale.y - this._startScale.y);\r\n      this._directionX = this._endScale.x < this._startScale.x ? -1 : 1;\r\n      this._directionY = this._endScale.y < this._startScale.y ? -1 : 1;\r\n    }\r\n\r\n    this._motion.scaleFactor.x = this._speedX * this._directionX;\r\n    this._motion.scaleFactor.y = this._speedY * this._directionY;\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.scale = this._endScale;\r\n      this._motion.scaleFactor.x = 0;\r\n      this._motion.scaleFactor.y = 0;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return (\r\n      this._stopped ||\r\n      (Math.abs(this._tx.scale.x - this._startScale.x) >= this._distanceX - 0.01 &&\r\n        Math.abs(this._tx.scale.y - this._startScale.y) >= this._distanceY - 0.01)\r\n    );\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.scaleFactor.x = 0;\r\n    this._motion.scaleFactor.y = 0;\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Action, nextActionId } from '../Action';\r\n\r\nexport class CallMethod implements Action {\r\n  id = nextActionId();\r\n  private _method: () => any;\r\n  private _hasBeenCalled: boolean = false;\r\n  constructor(method: () => any) {\r\n    this._method = method;\r\n  }\r\n\r\n  public update(elapsed: number) {\r\n    this._method();\r\n    this._hasBeenCalled = true;\r\n  }\r\n  public isComplete() {\r\n    return this._hasBeenCalled;\r\n  }\r\n  public reset() {\r\n    this._hasBeenCalled = false;\r\n  }\r\n  public stop() {\r\n    this._hasBeenCalled = true;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\n/**\r\n * @deprecated use moveTo({pos: Vector, duration: number, easing: EasingFunction})\r\n */\r\nexport class EaseTo implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1 * 1000; // 1 second\r\n  private _lerpStart: Vector = new Vector(0, 0);\r\n  private _lerpEnd: Vector = new Vector(0, 0);\r\n  private _initialized: boolean = false;\r\n  private _stopped: boolean = false;\r\n  constructor(\r\n    entity: Entity,\r\n    x: number,\r\n    y: number,\r\n    duration: number,\r\n    public easingFcn: (currentTime: number, startValue: number, endValue: number, duration: number) => number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._lerpDuration = duration;\r\n    this._lerpEnd = new Vector(x, y);\r\n  }\r\n  private _initialize() {\r\n    this._lerpStart = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._currentLerpTime = 0;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._initialized) {\r\n      this._initialize();\r\n      this._initialized = true;\r\n    }\r\n\r\n    // Need to update lerp time first, otherwise the first update will always be zero\r\n    this._currentLerpTime += elapsed;\r\n    let newX = this._tx.pos.x;\r\n    let newY = this._tx.pos.y;\r\n    if (this._currentLerpTime < this._lerpDuration) {\r\n      if (this._lerpEnd.x < this._lerpStart.x) {\r\n        newX =\r\n          this._lerpStart.x -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.x, this._lerpStart.x, this._lerpDuration) - this._lerpEnd.x);\r\n      } else {\r\n        newX = this.easingFcn(this._currentLerpTime, this._lerpStart.x, this._lerpEnd.x, this._lerpDuration);\r\n      }\r\n\r\n      if (this._lerpEnd.y < this._lerpStart.y) {\r\n        newY =\r\n          this._lerpStart.y -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.y, this._lerpStart.y, this._lerpDuration) - this._lerpEnd.y);\r\n      } else {\r\n        newY = this.easingFcn(this._currentLerpTime, this._lerpStart.y, this._lerpEnd.y, this._lerpDuration);\r\n      }\r\n      // Given the lerp position figure out the velocity in pixels per second\r\n      this._motion.vel = vec((newX - this._tx.pos.x) / (elapsed / 1000), (newY - this._tx.pos.y) / (elapsed / 1000));\r\n    } else {\r\n      this._tx.pos = vec(this._lerpEnd.x, this._lerpEnd.y);\r\n      this._motion.vel = Vector.Zero;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentLerpTime >= this._lerpDuration;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._initialized = false;\r\n    this._stopped = false;\r\n    this._currentLerpTime = 0;\r\n  }\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\n/**\r\n * @deprecated use moveBy({offset: Vector, duration: number, easing: EasingFunction})\r\n */\r\nexport class EaseBy implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1 * 1000; // 1 second\r\n  private _lerpStart: Vector = new Vector(0, 0);\r\n  private _lerpEnd: Vector = new Vector(0, 0);\r\n  private _offset: Vector;\r\n  private _initialized: boolean = false;\r\n  private _stopped: boolean = false;\r\n  constructor(\r\n    entity: Entity,\r\n    offsetX: number,\r\n    offsetY: number,\r\n    duration: number,\r\n    public easingFcn: (currentTime: number, startValue: number, endValue: number, duration: number) => number\r\n  ) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._lerpDuration = duration;\r\n    this._offset = new Vector(offsetX, offsetY);\r\n  }\r\n  private _initialize() {\r\n    this._lerpStart = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._currentLerpTime = 0;\r\n    this._lerpEnd = this._lerpStart.add(this._offset);\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._initialized) {\r\n      this._initialize();\r\n      this._initialized = true;\r\n    }\r\n\r\n    // Need to update lerp time first, otherwise the first update will always be zero\r\n    this._currentLerpTime += elapsed;\r\n    let newX = this._tx.pos.x;\r\n    let newY = this._tx.pos.y;\r\n    if (this._currentLerpTime < this._lerpDuration) {\r\n      if (this._lerpEnd.x < this._lerpStart.x) {\r\n        newX =\r\n          this._lerpStart.x -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.x, this._lerpStart.x, this._lerpDuration) - this._lerpEnd.x);\r\n      } else {\r\n        newX = this.easingFcn(this._currentLerpTime, this._lerpStart.x, this._lerpEnd.x, this._lerpDuration);\r\n      }\r\n\r\n      if (this._lerpEnd.y < this._lerpStart.y) {\r\n        newY =\r\n          this._lerpStart.y -\r\n          (this.easingFcn(this._currentLerpTime, this._lerpEnd.y, this._lerpStart.y, this._lerpDuration) - this._lerpEnd.y);\r\n      } else {\r\n        newY = this.easingFcn(this._currentLerpTime, this._lerpStart.y, this._lerpEnd.y, this._lerpDuration);\r\n      }\r\n      // Given the lerp position figure out the velocity in pixels per second\r\n      this._motion.vel = vec((newX - this._tx.pos.x) / (elapsed / 1000), (newY - this._tx.pos.y) / (elapsed / 1000));\r\n    } else {\r\n      this._tx.pos = vec(this._lerpEnd.x, this._lerpEnd.y);\r\n      this._motion.vel = Vector.Zero;\r\n    }\r\n  }\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentLerpTime >= this._lerpDuration;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._initialized = false;\r\n    this._stopped = false;\r\n    this._currentLerpTime = 0;\r\n  }\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n}\r\n","import { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport class Blink implements Action {\r\n  id = nextActionId();\r\n  private _graphics: GraphicsComponent;\r\n  private _timeVisible: number = 0;\r\n  private _timeNotVisible: number = 0;\r\n  private _elapsedTime: number = 0;\r\n  private _totalTime: number = 0;\r\n  private _duration: number;\r\n  private _stopped: boolean = false;\r\n  private _started: boolean = false;\r\n  constructor(entity: Entity, timeVisible: number, timeNotVisible: number, numBlinks: number = 1) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._timeVisible = timeVisible;\r\n    this._timeNotVisible = timeNotVisible;\r\n    this._duration = (timeVisible + timeNotVisible) * numBlinks;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._elapsedTime = 0;\r\n      this._totalTime = 0;\r\n    }\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    this._elapsedTime += elapsed;\r\n    this._totalTime += elapsed;\r\n    if (this._graphics.isVisible && this._elapsedTime >= this._timeVisible) {\r\n      this._graphics.isVisible = false;\r\n      this._elapsedTime = 0;\r\n    }\r\n\r\n    if (!this._graphics.isVisible && this._elapsedTime >= this._timeNotVisible) {\r\n      this._graphics.isVisible = true;\r\n      this._elapsedTime = 0;\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._graphics.isVisible = true;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._totalTime >= this._duration;\r\n  }\r\n\r\n  public stop(): void {\r\n    if (this._graphics) {\r\n      this._graphics.isVisible = true;\r\n    }\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset() {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._elapsedTime = 0;\r\n    this._totalTime = 0;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Logger } from '../../Util/Log';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport class Fade implements Action {\r\n  id = nextActionId();\r\n  private _graphics: GraphicsComponent;\r\n\r\n  private _endOpacity: number;\r\n  private _remainingTime: number;\r\n  private _originalTime: number;\r\n  private _multiplier: number = 1;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, endOpacity: number, duration: number) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._endOpacity = endOpacity;\r\n    this._remainingTime = this._originalTime = duration;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._remainingTime = this._originalTime;\r\n\r\n      // determine direction when we start\r\n      if (this._endOpacity < this._graphics.opacity) {\r\n        this._multiplier = -1;\r\n      } else {\r\n        this._multiplier = 1;\r\n      }\r\n    }\r\n\r\n    if (this._remainingTime > 0) {\r\n      this._graphics.opacity += (this._multiplier * (Math.abs(this._graphics.opacity - this._endOpacity) * elapsed)) / this._remainingTime;\r\n    }\r\n\r\n    this._remainingTime -= elapsed;\r\n\r\n    if (this.isComplete()) {\r\n      this._graphics.opacity = this._endOpacity;\r\n    }\r\n\r\n    Logger.getInstance().debug('[Action fade] Actor opacity:', this._graphics.opacity);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._remainingTime <= 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._remainingTime = this._originalTime;\r\n  }\r\n}\r\n","import { Action, nextActionId } from '../Action';\r\n\r\nexport class Delay implements Action {\r\n  id = nextActionId();\r\n  private _elapsedTime: number = 0;\r\n  private _delay: number;\r\n  private _started: boolean = false;\r\n  private _stopped = false;\r\n  constructor(duration: number) {\r\n    this._delay = duration;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n    }\r\n\r\n    this._elapsedTime += elapsed;\r\n  }\r\n\r\n  isComplete(): boolean {\r\n    return this._stopped || this._elapsedTime >= this._delay;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  reset(): void {\r\n    this._elapsedTime = 0;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { ActionsComponent } from '../ActionsComponent';\r\n\r\nexport class Die implements Action {\r\n  id = nextActionId();\r\n  private _entity: Entity;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    this._entity.get(ActionsComponent).clearActions();\r\n    this._entity.kill();\r\n    this._stopped = true;\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped;\r\n  }\r\n\r\n  public stop(): void {\r\n    return;\r\n  }\r\n\r\n  public reset(): void {\r\n    return;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { vec, Vector } from '../../Math/vector';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport class Follow implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _followTx: TransformComponent;\r\n  private _followMotion: MotionComponent;\r\n\r\n  public x: number;\r\n  public y: number;\r\n  private _current: Vector;\r\n  private _end: Vector;\r\n  private _dir: Vector;\r\n  private _speed: number;\r\n  private _maximumDistance: number;\r\n  private _distanceBetween: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n\r\n  constructor(entity: Entity, entityToFollow: Entity, followDistance?: number) {\r\n    this._tx = entity.get(TransformComponent);\r\n    this._motion = entity.get(MotionComponent);\r\n    this._followTx = entityToFollow.get(TransformComponent);\r\n    this._followMotion = entityToFollow.get(MotionComponent);\r\n    this._current = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._end = new Vector(this._followTx.pos.x, this._followTx.pos.y);\r\n    this._maximumDistance = followDistance !== undefined ? followDistance : this._current.distance(this._end);\r\n    this._speed = 0;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._distanceBetween = this._current.distance(this._end);\r\n      this._dir = this._end.sub(this._current).normalize();\r\n    }\r\n\r\n    const actorToFollowSpeed = Math.sqrt(Math.pow(this._followMotion.vel.x, 2) + Math.pow(this._followMotion.vel.y, 2));\r\n    if (actorToFollowSpeed !== 0) {\r\n      this._speed = actorToFollowSpeed;\r\n    }\r\n    this._current = vec(this._tx.pos.x, this._tx.pos.y);\r\n\r\n    this._end = vec(this._followTx.pos.x, this._followTx.pos.y);\r\n    this._distanceBetween = this._current.distance(this._end);\r\n    this._dir = this._end.sub(this._current).normalize();\r\n\r\n    if (this._distanceBetween >= this._maximumDistance) {\r\n      const m = this._dir.scale(this._speed);\r\n      this._motion.vel = vec(m.x, m.y);\r\n    } else {\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    // the actor following should never stop unless specified to do so\r\n    return this._stopped;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { MotionComponent } from '../../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport class Meet implements Action {\r\n  id = nextActionId();\r\n  private _tx: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _meetTx: TransformComponent;\r\n  private _meetMotion: MotionComponent;\r\n  public x!: number;\r\n  public y!: number;\r\n  private _current: Vector;\r\n  private _end: Vector;\r\n  private _dir!: Vector;\r\n  private _speed: number;\r\n  private _distanceBetween!: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _speedWasSpecified = false;\r\n\r\n  constructor(actor: Entity, actorToMeet: Entity, speed?: number) {\r\n    this._tx = actor.get(TransformComponent);\r\n    this._motion = actor.get(MotionComponent);\r\n    this._meetTx = actorToMeet.get(TransformComponent);\r\n    this._meetMotion = actorToMeet.get(MotionComponent);\r\n    this._current = new Vector(this._tx.pos.x, this._tx.pos.y);\r\n    this._end = new Vector(this._meetTx.pos.x, this._meetTx.pos.y);\r\n    this._speed = speed || 0;\r\n\r\n    if (speed !== undefined) {\r\n      this._speedWasSpecified = true;\r\n    }\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._distanceBetween = this._current.distance(this._end);\r\n      this._dir = this._end.sub(this._current).normalize();\r\n    }\r\n\r\n    const actorToMeetSpeed = Math.sqrt(Math.pow(this._meetMotion.vel.x, 2) + Math.pow(this._meetMotion.vel.y, 2));\r\n    if (actorToMeetSpeed !== 0 && !this._speedWasSpecified) {\r\n      this._speed = actorToMeetSpeed;\r\n    }\r\n    this._current = vec(this._tx.pos.x, this._tx.pos.y);\r\n\r\n    this._end = vec(this._meetTx.pos.x, this._meetTx.pos.y);\r\n    this._distanceBetween = this._current.distance(this._end);\r\n    this._dir = this._end.sub(this._current).normalize();\r\n\r\n    const m = this._dir.scale(this._speed);\r\n    this._motion.vel = vec(m.x, m.y);\r\n\r\n    if (this.isComplete()) {\r\n      this._tx.pos = vec(this._end.x, this._end.y);\r\n      this._motion.vel = vec(0, 0);\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._distanceBetween <= 1;\r\n  }\r\n\r\n  public stop(): void {\r\n    this._motion.vel = vec(0, 0);\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._started = false;\r\n    this._stopped = false;\r\n    this._distanceBetween = Infinity;\r\n  }\r\n}\r\n","import { GraphicsComponent } from '../../Graphics/GraphicsComponent';\r\nimport { Entity } from '../../EntityComponentSystem/Entity';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { Actor } from '../../Actor';\r\nimport { Material } from '../../Graphics/Context/material';\r\nimport { Color } from '../../Color';\r\nimport { Shader } from '../../Graphics/Context/shader';\r\n\r\nexport class Flash implements Action {\r\n  id = nextActionId();\r\n  private _graphics: GraphicsComponent;\r\n  private _duration: number;\r\n  private _stopped: boolean = false;\r\n  private _started: boolean = false;\r\n  private _entity: Entity;\r\n  private _material: Material | undefined;\r\n  private _total: number = 0;\r\n  private _currentDuration: number = 0;\r\n\r\n  constructor(entity: Entity, color: Color, duration: number = 1000) {\r\n    this._graphics = entity.get(GraphicsComponent);\r\n    this._duration = duration;\r\n    this._entity = entity;\r\n    this._material = entity.scene?.engine.graphicsContext.createMaterial({\r\n      name: 'flash-material',\r\n      color,\r\n      fragmentSource: `#version 300 es\r\n    \r\n        precision mediump float;\r\n        uniform float u_blend;\r\n        uniform sampler2D u_graphic;\r\n        uniform vec4 u_color;\r\n    \r\n        in vec2 v_uv; \r\n        out vec4 color;\r\n    \r\n        void main() { \r\n            vec4 textureColor = texture(u_graphic, v_uv); \r\n            color = mix(textureColor, u_color, u_blend * textureColor.a);\r\n            color.rgb = color.rgb * color.a;\r\n        }`\r\n    }) as Material;\r\n    this._total = duration;\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._started = true;\r\n      this._total = this._duration;\r\n      this._currentDuration = this._duration;\r\n      (this._entity as Actor).graphics.material = this._material as Material;\r\n    }\r\n    if (!this._graphics) {\r\n      return;\r\n    }\r\n\r\n    this._currentDuration -= elapsed;\r\n\r\n    if (this._graphics) {\r\n      this._material?.update((shader: Shader) => {\r\n        shader.trySetUniformFloat('u_blend', this._currentDuration / this._total);\r\n      });\r\n    }\r\n\r\n    if (this.isComplete()) {\r\n      (this._entity as Actor).graphics.material = null;\r\n    }\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._currentDuration <= 0;\r\n  }\r\n\r\n  public stop(): void {\r\n    if (this._graphics) {\r\n      this._graphics.isVisible = true;\r\n    }\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset() {\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n}\r\n","import { lerpVector, remap } from './lerp';\r\nimport { Vector } from './vector';\r\n\r\nexport interface BezierCurveOptions {\r\n  /**\r\n   * [start, control1, control2, end]\r\n   */\r\n  controlPoints: [start: Vector, control1: Vector, control2: Vector, end: Vector];\r\n  /**\r\n   * Quality when sampling uniform points on the curve. Samples = 4 * quality;\r\n   *\r\n   * For bigger 'uniform' curves you may want to increase quality\r\n   *\r\n   * Default 4\r\n   */\r\n  quality?: number;\r\n}\r\n\r\n/**\r\n * BezierCurve that supports cubic Bezier curves.\r\n */\r\nexport class BezierCurve {\r\n  // Thanks Freya! https://www.youtube.com/watch?v=aVwxzDHniEw\r\n  private _distLookup: number[] = [];\r\n  private _controlPoints: [Vector, Vector, Vector, Vector];\r\n  private _arcLength: number;\r\n  readonly quality: number = 4;\r\n  constructor(options: BezierCurveOptions) {\r\n    if (options.controlPoints.length !== 4) {\r\n      throw new Error('Only cubic bezier curves are supported');\r\n    }\r\n    this._controlPoints = [...options.controlPoints];\r\n    this.quality = options.quality ?? this.quality;\r\n\r\n    this._calculateLookup();\r\n  }\r\n\r\n  public get arcLength(): number {\r\n    return this._arcLength;\r\n  }\r\n\r\n  public get controlPoints(): readonly [start: Vector, control1: Vector, control2: Vector, end: Vector] {\r\n    return this._controlPoints;\r\n  }\r\n\r\n  public set controlPoints(points: [start: Vector, control1: Vector, control2: Vector, end: Vector]) {\r\n    this._controlPoints = [...points];\r\n    this._calculateLookup();\r\n  }\r\n\r\n  setControlPoint(index: 0 | 1 | 2 | 3, point: Vector) {\r\n    this._controlPoints[index] = point;\r\n    this._calculateLookup();\r\n  }\r\n\r\n  private _calculateLookup() {\r\n    let totalLength = 0;\r\n    this._distLookup.length = 0;\r\n    let prev = this.controlPoints[0];\r\n    const n = this.controlPoints.length * this.quality;\r\n    for (let i = 0; i < n; i++) {\r\n      const t = i / (n - 1);\r\n      const pt = this.getPoint(t);\r\n      const diff = prev.distance(pt);\r\n      totalLength += diff;\r\n      this._distLookup.push(totalLength);\r\n      prev = pt;\r\n    }\r\n    this._arcLength = totalLength;\r\n  }\r\n\r\n  private _getTimeGivenDistance(distance: number): number {\r\n    const n = this._distLookup.length;\r\n    const arcLength = this.arcLength;\r\n\r\n    if (distance >= 0 && distance < arcLength) {\r\n      for (let i = 0; i < n - 1; i++) {\r\n        if (this._distLookup[i] <= distance && distance < this._distLookup[i + 1]) {\r\n          return remap(this._distLookup[i], this._distLookup[i + 1], i / (n - 1), (i + 1) / (n - 1), distance);\r\n        }\r\n      }\r\n    }\r\n    return distance / arcLength;\r\n  }\r\n\r\n  /**\r\n   * Get the point on the Bezier curve at a certain time\r\n   * @param time Between 0-1\r\n   */\r\n  getPoint(time: number): Vector {\r\n    const points = [...this.controlPoints];\r\n\r\n    for (let r = 1; r < points.length; r++) {\r\n      for (let i = 0; i < points.length - r; i++) {\r\n        points[i] = lerpVector(points[i], points[i + 1], time);\r\n      }\r\n    }\r\n\r\n    return points[0];\r\n  }\r\n\r\n  /**\r\n   * Get the tangent of the Bezier curve at a certain time\r\n   * @param time Between 0-1\r\n   */\r\n  getTangent(time: number): Vector {\r\n    const timeSquared = time * time;\r\n    const p0 = this.controlPoints[0];\r\n    const p1 = this.controlPoints[1];\r\n    const p2 = this.controlPoints[2];\r\n    const p3 = this.controlPoints[3];\r\n\r\n    // Derivative of Bernstein polynomial\r\n    const pPrime = p0\r\n      .scale(-3 * timeSquared + 6 * time - 3)\r\n      .add(p1.scale(9 * timeSquared - 12 * time + 3).add(p2.scale(-9 * timeSquared + 6 * time).add(p3.scale(3 * timeSquared))));\r\n\r\n    return pPrime.normalize();\r\n  }\r\n\r\n  /**\r\n   * Get the tangent of the Bezier curve where the distance is uniformly distributed over time\r\n   * @param time\r\n   */\r\n  getUniformTangent(time: number): Vector {\r\n    const desiredDistance = time * this.arcLength;\r\n    const uniformTime = this._getTimeGivenDistance(desiredDistance);\r\n    return this.getTangent(uniformTime);\r\n  }\r\n\r\n  /**\r\n   * Get the normal of the Bezier curve at a certain time\r\n   * @param time Between 0-1\r\n   */\r\n  getNormal(time: number): Vector {\r\n    return this.getTangent(time).normal();\r\n  }\r\n\r\n  /**\r\n   * Get the normal of the Bezier curve where the distance is uniformly distributed over time\r\n   * @param time\r\n   */\r\n  getUniformNormal(time: number): Vector {\r\n    return this.getUniformTangent(time).normal();\r\n  }\r\n\r\n  /**\r\n   * Points are spaced uniformly across the length of the curve over time\r\n   * @param time\r\n   */\r\n  getUniformPoint(time: number): Vector {\r\n    const desiredDistance = time * this.arcLength;\r\n    const uniformTime = this._getTimeGivenDistance(desiredDistance);\r\n    return this.getPoint(uniformTime);\r\n  }\r\n\r\n  clone(): BezierCurve {\r\n    return new BezierCurve({\r\n      controlPoints: [...this.controlPoints],\r\n      quality: this.quality\r\n    });\r\n  }\r\n}\r\n","import { Entity, TransformComponent } from '../../EntityComponentSystem';\r\nimport { BezierCurve, clamp, remap, vec, Vector } from '../../Math';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport interface CurveToOptions {\r\n  /**\r\n   * Bezier Curve in world coordinates to animate towards\r\n   *\r\n   * The start control point is assumed to be the actor's current position\r\n   */\r\n  controlPoints: [control1: Vector, control2: Vector, end: Vector];\r\n  /**\r\n   * Total duration for the action to run\r\n   */\r\n  duration: number;\r\n  /**\r\n   * Dynamic mode will speed up/slow down depending on the curve\r\n   *\r\n   * Uniform mode will animate at a consistent velocity across the curve\r\n   *\r\n   * Default: 'dynamic'\r\n   */\r\n  mode?: 'dynamic' | 'uniform';\r\n  /**\r\n   * Quality when sampling uniform points on the curve. Samples = 4 * quality;\r\n   *\r\n   * For bigger 'uniform' curves you may want to increase quality\r\n   *\r\n   * Default 4\r\n   */\r\n  quality?: number;\r\n}\r\n\r\nexport class CurveTo implements Action {\r\n  id: number = nextActionId();\r\n\r\n  private _curve: BezierCurve;\r\n  private _durationMs: number;\r\n  private _entity: Entity<any>;\r\n  private _tx: TransformComponent;\r\n  private _currentMs: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _mode: 'dynamic' | 'uniform' = 'dynamic';\r\n  constructor(entity: Entity, options: CurveToOptions) {\r\n    this._entity = entity;\r\n    this._tx = this._entity.get(TransformComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);\r\n    }\r\n    this._curve = new BezierCurve({\r\n      controlPoints: [vec(0, 0), ...options.controlPoints],\r\n      quality: options.quality\r\n    });\r\n    this._durationMs = options.duration;\r\n    this._mode = options.mode ?? this._mode;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._curve.setControlPoint(0, this._tx.globalPos.clone());\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    if (this._mode === 'dynamic') {\r\n      this._tx.pos = this._curve.getPoint(t);\r\n    } else {\r\n      this._tx.pos = this._curve.getUniformPoint(t);\r\n    }\r\n    if (this.isComplete(this._entity)) {\r\n      if (this._mode === 'dynamic') {\r\n        this._tx.pos = this._curve.getPoint(1);\r\n      } else {\r\n        this._tx.pos = this._curve.getUniformPoint(1);\r\n      }\r\n    }\r\n  }\r\n  isComplete(entity: Entity): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n  reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n  stop(): void {\r\n    this._stopped = true;\r\n    this._currentMs = 0;\r\n  }\r\n}\r\n","import { Entity, TransformComponent } from '../../EntityComponentSystem';\r\nimport { BezierCurve, clamp, remap, vec, Vector } from '../../Math';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\nexport interface CurveByOptions {\r\n  /**\r\n   * Bezier Curve relative to the current actor position to move\r\n   */\r\n  controlPoints: [control1: Vector, control2: Vector, end: Vector];\r\n  /**\r\n   * Total duration for the action to run\r\n   */\r\n  duration: number;\r\n  /**\r\n   * Dynamic mode will speed up/slow down depending on the curve\r\n   *\r\n   * Uniform mode will animate at a consistent velocity across the curve\r\n   *\r\n   * Default: 'dynamic'\r\n   */\r\n  mode?: 'dynamic' | 'uniform';\r\n\r\n  /**\r\n   * Quality when sampling uniform points on the curve. Samples = 4 * quality;\r\n   *\r\n   * For bigger 'uniform' curves you may want to increase quality to make the motion appear smooth\r\n   *\r\n   * Default 4\r\n   */\r\n  quality?: number;\r\n}\r\n\r\nexport class CurveBy implements Action {\r\n  id: number = nextActionId();\r\n\r\n  private _curve: BezierCurve;\r\n  private _durationMs: number;\r\n  private _entity: Entity<any>;\r\n  private _tx: TransformComponent;\r\n  private _currentMs: number;\r\n  private _started = false;\r\n  private _stopped = false;\r\n  private _mode: 'dynamic' | 'uniform' = 'dynamic';\r\n  constructor(entity: Entity, options: CurveByOptions) {\r\n    this._entity = entity;\r\n    this._tx = this._entity.get(TransformComponent);\r\n    if (!this._tx) {\r\n      throw new Error(`Entity ${entity.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);\r\n    }\r\n    this._curve = this._curve = new BezierCurve({\r\n      controlPoints: [vec(0, 0), ...options.controlPoints],\r\n      quality: options.quality\r\n    });\r\n    this._durationMs = options.duration;\r\n    this._mode = options.mode ?? this._mode;\r\n    this._currentMs = this._durationMs;\r\n  }\r\n\r\n  update(elapsed: number): void {\r\n    if (!this._started) {\r\n      this._curve.setControlPoint(0, this._tx.globalPos);\r\n      this._curve.setControlPoint(1, this._curve.controlPoints[1].add(this._tx.globalPos));\r\n      this._curve.setControlPoint(2, this._curve.controlPoints[2].add(this._tx.globalPos));\r\n      this._curve.setControlPoint(3, this._curve.controlPoints[3].add(this._tx.globalPos));\r\n      this._started = true;\r\n    }\r\n    this._currentMs -= elapsed;\r\n    const t = clamp(remap(0, this._durationMs, 0, 1, this._durationMs - this._currentMs), 0, 1);\r\n    if (this._mode === 'dynamic') {\r\n      this._tx.pos = this._curve.getPoint(t);\r\n    } else {\r\n      this._tx.pos = this._curve.getUniformPoint(t);\r\n    }\r\n    if (this.isComplete(this._entity)) {\r\n      if (this._mode === 'dynamic') {\r\n        this._tx.pos = this._curve.getPoint(1);\r\n      } else {\r\n        this._tx.pos = this._curve.getUniformPoint(1);\r\n      }\r\n    }\r\n  }\r\n  isComplete(entity: Entity): boolean {\r\n    return this._stopped || this._currentMs < 0;\r\n  }\r\n  reset(): void {\r\n    this._currentMs = this._durationMs;\r\n    this._started = false;\r\n    this._stopped = false;\r\n  }\r\n  stop(): void {\r\n    this._stopped = true;\r\n  }\r\n}\r\n","import { EasingFunction, EasingFunctions } from '../Util/EasingFunctions';\r\nimport { ActionQueue } from './ActionQueue';\r\nimport { Repeat } from './Action/Repeat';\r\nimport { RepeatForever } from './Action/RepeatForever';\r\nimport { isMoveByOptions, MoveBy, MoveByOptions, MoveByWithOptions } from './Action/MoveBy';\r\nimport { isMoveToOptions, MoveTo, MoveToOptions, MoveToWithOptions } from './Action/MoveTo';\r\nimport { RotateTo, RotateToOptions, RotateToWithOptions } from './Action/RotateTo';\r\nimport { RotateBy, RotateByOptions, RotateByWithOptions } from './Action/RotateBy';\r\nimport { isScaleToOptions, ScaleTo, ScaleToOptions, ScaleToWithOptions } from './Action/ScaleTo';\r\nimport { isScaleByOptions, ScaleBy, ScaleByOptions, ScaleByWithOptions } from './Action/ScaleBy';\r\nimport { CallMethod } from './Action/CallMethod';\r\nimport { EaseTo } from './Action/EaseTo';\r\nimport { EaseBy } from './Action/EaseBy';\r\nimport { Blink } from './Action/Blink';\r\nimport { Fade } from './Action/Fade';\r\nimport { Delay } from './Action/Delay';\r\nimport { Die } from './Action/Die';\r\nimport { Follow } from './Action/Follow';\r\nimport { Meet } from './Action/Meet';\r\nimport { Vector, RotationType } from '../Math';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Action } from './Action';\r\nimport { Color } from '../Color';\r\nimport { Flash } from './Action/Flash';\r\nimport { CurveTo, CurveToOptions } from './Action/CurveTo';\r\nimport { CurveBy, CurveByOptions } from './Action/CurveBy';\r\n\r\n/**\r\n * The fluent Action API allows you to perform \"actions\" on\r\n * {@apilink Actor | `actors`} such as following, moving, rotating, and\r\n * more. You can implement your own actions by implementing\r\n * the {@apilink Action} interface.\r\n */\r\nexport class ActionContext {\r\n  private _entity: Entity;\r\n  private _queue: ActionQueue;\r\n\r\n  constructor(entity: Entity) {\r\n    this._entity = entity;\r\n    this._queue = new ActionQueue(entity);\r\n  }\r\n\r\n  public getQueue(): ActionQueue {\r\n    return this._queue;\r\n  }\r\n\r\n  public update(elapsed: number) {\r\n    this._queue.update(elapsed);\r\n  }\r\n\r\n  /**\r\n   * Clears all queued actions from the Actor\r\n   */\r\n  public clearActions(): void {\r\n    this._queue.clearActions();\r\n  }\r\n\r\n  public runAction(action: Action) {\r\n    action.reset();\r\n    this._queue.add(action);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Animates an actor with a specified bezier curve by an offset to the current position, the start point is assumed\r\n   * to be the actors current position\r\n   * @param options\r\n   */\r\n  public curveBy(options: CurveByOptions): ActionContext {\r\n    this._queue.add(new CurveBy(this._entity, options));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Animates an actor with a specified bezier curve to an absolute world space coordinate, the start point is assumed\r\n   * to be the actors current position\r\n   * @param options\r\n   */\r\n  public curveTo(options: CurveToOptions): ActionContext {\r\n    this._queue.add(new CurveTo(this._entity, options));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given {@apilink EasingFunctions} and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos       The x,y vector location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use {@apilink EasingFunction} or a custom function to use to calculate position, Default is {@apilink EasingFunctions.Linear}\r\n   * @deprecated use new moveTo({pos: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeTo(pos: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given {@apilink EasingFunctions} and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x         The x location to move the actor to\r\n   * @param y         The y location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use {@apilink EasingFunction} or a custom function to use to calculate position, Default is {@apilink EasingFunctions.Linear}\r\n   * @deprecated use new moveTo({pos: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeTo(x: number, y: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeTo(...args: any[]): ActionContext {\r\n    let x = 0;\r\n    let y = 0;\r\n    let duration = 0;\r\n    let easingFcn = EasingFunctions.Linear;\r\n    if (args[0] instanceof Vector) {\r\n      x = args[0].x;\r\n      y = args[0].y;\r\n      duration = args[1];\r\n      easingFcn = args[2] ?? easingFcn;\r\n    } else {\r\n      x = args[0];\r\n      y = args[1];\r\n      duration = args[2];\r\n      easingFcn = args[3] ?? easingFcn;\r\n    }\r\n\r\n    this._queue.add(new EaseTo(this._entity, x, y, duration, easingFcn));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor by a specified vector offset relative to the current position given\r\n   * a duration and a {@apilink EasingFunction}. This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset Vector offset relative to the current position\r\n   * @param duration The duration in milliseconds\r\n   * @param easingFcn Use {@apilink EasingFunction} or a custom function to use to calculate position, Default is {@apilink EasingFunctions.Linear}\r\n   * @deprecated use new moveBy({offset: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeBy(offset: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor by a specified x and y offset relative to the current position given\r\n   * a duration and a {@apilink EasingFunction}. This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset Vector offset relative to the current position\r\n   * @param duration The duration in milliseconds\r\n   * @param easingFcn Use {@apilink EasingFunction} or a custom function to use to calculate position, Default is {@apilink EasingFunctions.Linear}\r\n   * @deprecated use new moveBy({offset: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeBy(offsetX: number, offsetY: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(...args: any[]): ActionContext {\r\n    let offsetX = 0;\r\n    let offsetY = 0;\r\n    let duration = 0;\r\n    let easingFcn = EasingFunctions.Linear;\r\n    if (args[0] instanceof Vector) {\r\n      offsetX = args[0].x;\r\n      offsetY = args[0].y;\r\n      duration = args[1];\r\n      easingFcn = args[2] ?? easingFcn;\r\n    } else {\r\n      offsetX = args[0];\r\n      offsetY = args[1];\r\n      duration = args[2];\r\n      easingFcn = args[3] ?? easingFcn;\r\n    }\r\n\r\n    this._queue.add(new EaseBy(this._entity, offsetX, offsetY, duration, easingFcn));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Moves an actor to a specified {@link Vector} in a given duration in milliseconds.\r\n   * You may optionally specify an {@link EasingFunction}\r\n   * @param options\r\n   */\r\n  public moveTo(options: MoveToOptions): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos    The x,y vector location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(pos: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x      The x location to move the actor to\r\n   * @param y      The y location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(x: number, y: number, speed: number): ActionContext;\r\n  public moveTo(xOrPosOrOptions: number | Vector | MoveToOptions, yOrSpeed?: number, speedOrUndefined?: number): ActionContext {\r\n    let x = 0;\r\n    let y = 0;\r\n    let speed = 0;\r\n    if (xOrPosOrOptions instanceof Vector) {\r\n      x = xOrPosOrOptions.x;\r\n      y = xOrPosOrOptions.y;\r\n      speed = +(yOrSpeed ?? 0);\r\n      this._queue.add(new MoveTo(this._entity, x, y, speed));\r\n    } else if (typeof xOrPosOrOptions === 'number' && typeof yOrSpeed === 'number' && typeof speedOrUndefined === 'number') {\r\n      x = xOrPosOrOptions;\r\n      y = yOrSpeed;\r\n      speed = speedOrUndefined;\r\n      this._queue.add(new MoveTo(this._entity, x, y, speed));\r\n    } else if (isMoveToOptions(xOrPosOrOptions)) {\r\n      this._queue.add(new MoveToWithOptions(this._entity, xOrPosOrOptions));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Moves an actor by a specified offset {@link Vector} in a given duration in milliseconds.\r\n   * You may optionally specify an {@link EasingFunction}\r\n   * @param options\r\n   */\r\n  public moveBy(options: MoveByOptions): ActionContext;\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param xOffset     The x offset to apply to this actor\r\n   * @param yOffset     The y location to move the actor to\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(offset: Vector, speed: number): ActionContext;\r\n  public moveBy(xOffset: number, yOffset: number, speed: number): ActionContext;\r\n  public moveBy(\r\n    xOffsetOrVectorOrOptions: number | Vector | MoveByOptions,\r\n    yOffsetOrSpeed?: number,\r\n    speedOrUndefined?: number\r\n  ): ActionContext {\r\n    let xOffset = 0;\r\n    let yOffset = 0;\r\n    let speed = 0;\r\n    if (xOffsetOrVectorOrOptions instanceof Vector && typeof yOffsetOrSpeed === 'number') {\r\n      xOffset = xOffsetOrVectorOrOptions.x;\r\n      yOffset = xOffsetOrVectorOrOptions.y;\r\n      speed = yOffsetOrSpeed;\r\n      this._queue.add(new MoveBy(this._entity, xOffset, yOffset, speed));\r\n    } else if (typeof xOffsetOrVectorOrOptions === 'number' && typeof yOffsetOrSpeed === 'number' && typeof speedOrUndefined === 'number') {\r\n      xOffset = xOffsetOrVectorOrOptions;\r\n      yOffset = yOffsetOrSpeed;\r\n      speed = speedOrUndefined;\r\n      this._queue.add(new MoveBy(this._entity, xOffset, yOffset, speed));\r\n    } else if (isMoveByOptions(xOffsetOrVectorOrOptions)) {\r\n      this._queue.add(new MoveByWithOptions(this._entity, xOffsetOrVectorOrOptions));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Rotates an actor to a specified angle over a duration in milliseconds,\r\n   * you make pick a rotation strategy {@link RotationType} to pick the direction\r\n   * @param options\r\n   */\r\n  public rotateTo(options: RotateToOptions): ActionContext;\r\n  /**\r\n   * This method will rotate an actor to the specified angle at the speed\r\n   * specified (in radians per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angle  The angle to rotate to in radians\r\n   * @param speed         The angular velocity of the rotation specified in radians per second\r\n   * @param rotationType  The {@apilink RotationType} to use for this rotation\r\n   */\r\n  public rotateTo(angle: number, speed: number, rotationType?: RotationType): ActionContext;\r\n  public rotateTo(angleRadiansOrOptions: number | RotateToOptions, speed?: number, rotationType?: RotationType): ActionContext {\r\n    if (typeof angleRadiansOrOptions === 'number' && typeof speed === 'number') {\r\n      this._queue.add(new RotateTo(this._entity, angleRadiansOrOptions, speed, rotationType));\r\n    } else if (typeof angleRadiansOrOptions === 'object') {\r\n      this._queue.add(new RotateToWithOptions(this._entity, angleRadiansOrOptions));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Rotates an actor by a specified offset angle over a duration in milliseconds,\r\n   * you make pick a rotation strategy {@link RotationType} to pick the direction\r\n   * @param options\r\n   */\r\n  public rotateBy(options: RotateByOptions): ActionContext;\r\n  /**\r\n   * This method will rotate an actor by the specified angle offset, from it's current rotation given a certain speed\r\n   * in radians/sec and return back the actor. This method is part\r\n   * of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadiansOffset  The angle to rotate to in radians relative to the current rotation\r\n   * @param speed          The speed in radians/sec the actor should rotate at\r\n   * @param rotationType  The {@apilink RotationType} to use for this rotation, default is shortest path\r\n   */\r\n  public rotateBy(angleRadiansOffset: number, speed: number, rotationType?: RotationType): ActionContext;\r\n  public rotateBy(angleRadiansOffsetOrOptions: number | RotateByOptions, speed?: number, rotationType?: RotationType): ActionContext {\r\n    if (typeof angleRadiansOffsetOrOptions === 'object') {\r\n      this._queue.add(new RotateByWithOptions(this._entity, angleRadiansOffsetOrOptions));\r\n    } else {\r\n      this._queue.add(new RotateBy(this._entity, angleRadiansOffsetOrOptions, speed as number, rotationType));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Scales an actor to a specified scale {@link Vector} over a duration in milliseconds\r\n   * @param options\r\n   */\r\n  public scaleTo(options: ScaleToOptions): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param size    The scale to adjust the actor to over time\r\n   * @param speed   The speed of scaling specified in magnitude increase per second\r\n   */\r\n  public scaleTo(size: Vector, speed: Vector): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param sizeX   The scaling factor to apply on X axis\r\n   * @param sizeY   The scaling factor to apply on Y axis\r\n   * @param speedX  The speed of scaling specified in magnitude increase per second on X axis\r\n   * @param speedY  The speed of scaling specified in magnitude increase per second on Y axis\r\n   */\r\n  public scaleTo(sizeX: number, sizeY: number, speedX: number, speedY: number): ActionContext;\r\n  public scaleTo(\r\n    sizeXOrVectorOrOptions: number | Vector | ScaleToOptions,\r\n    sizeYOrSpeed?: number | Vector,\r\n    speedXOrUndefined?: number | undefined,\r\n    speedYOrUndefined?: number | undefined\r\n  ): ActionContext {\r\n    let sizeX = 1;\r\n    let sizeY = 1;\r\n    let speedX = 0;\r\n    let speedY = 0;\r\n\r\n    if (isScaleToOptions(sizeXOrVectorOrOptions)) {\r\n      this._queue.add(new ScaleToWithOptions(this._entity, sizeXOrVectorOrOptions));\r\n      return this;\r\n    }\r\n\r\n    if (sizeXOrVectorOrOptions instanceof Vector && sizeYOrSpeed instanceof Vector) {\r\n      sizeX = sizeXOrVectorOrOptions.x;\r\n      sizeY = sizeXOrVectorOrOptions.y;\r\n\r\n      speedX = sizeYOrSpeed.x;\r\n      speedY = sizeYOrSpeed.y;\r\n    }\r\n    if (typeof sizeXOrVectorOrOptions === 'number' && typeof sizeYOrSpeed === 'number') {\r\n      sizeX = sizeXOrVectorOrOptions;\r\n      sizeY = sizeYOrSpeed;\r\n\r\n      speedX = speedXOrUndefined as any;\r\n      speedY = speedYOrUndefined as any;\r\n    }\r\n\r\n    this._queue.add(new ScaleTo(this._entity, sizeX, sizeY, speedX, speedY));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Scales an actor by a specified scale offset {@link Vector} over a duration in milliseconds\r\n   * @param options\r\n   */\r\n  public scaleBy(options: ScaleByOptions): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param offset   The scaling factor to apply to the actor\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param sizeOffsetX   The scaling factor to apply on X axis\r\n   * @param sizeOffsetY   The scaling factor to apply on Y axis\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(sizeOffsetX: number, sizeOffsetY: number, speed: number): ActionContext;\r\n  public scaleBy(\r\n    sizeOffsetXOrVectorOrOptions: number | Vector | ScaleByOptions,\r\n    sizeOffsetYOrSpeed?: number,\r\n    speed?: number | undefined\r\n  ): ActionContext {\r\n    if (isScaleByOptions(sizeOffsetXOrVectorOrOptions)) {\r\n      this._queue.add(new ScaleByWithOptions(this._entity, sizeOffsetXOrVectorOrOptions));\r\n      return this;\r\n    }\r\n    let sizeOffsetX = 1;\r\n    let sizeOffsetY = 1;\r\n\r\n    if (sizeOffsetXOrVectorOrOptions instanceof Vector) {\r\n      sizeOffsetX = sizeOffsetXOrVectorOrOptions.x;\r\n      sizeOffsetY = sizeOffsetXOrVectorOrOptions.y;\r\n\r\n      speed = sizeOffsetYOrSpeed;\r\n    }\r\n    if (typeof sizeOffsetXOrVectorOrOptions === 'number' && typeof sizeOffsetYOrSpeed === 'number') {\r\n      sizeOffsetX = sizeOffsetXOrVectorOrOptions;\r\n      sizeOffsetY = sizeOffsetYOrSpeed;\r\n    }\r\n\r\n    this._queue.add(new ScaleBy(this._entity, sizeOffsetX, sizeOffsetY, speed as any));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor to blink (become visible and not\r\n   * visible). Optionally, you may specify the number of blinks. Specify the amount of time\r\n   * the actor should be visible per blink, and the amount of time not visible.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param timeVisible     The amount of time to stay visible per blink in milliseconds\r\n   * @param timeNotVisible  The amount of time to stay not visible per blink in milliseconds\r\n   * @param numBlinks       The number of times to blink\r\n   */\r\n  public blink(timeVisible: number, timeNotVisible: number, numBlinks: number = 1): ActionContext {\r\n    this._queue.add(new Blink(this._entity, timeVisible, timeNotVisible, numBlinks));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor's opacity to change from its current value\r\n   * to the provided value by a specified time (in milliseconds). This method is\r\n   * part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param opacity  The ending opacity\r\n   * @param duration     The time it should take to fade the actor (in milliseconds)\r\n   */\r\n  public fade(opacity: number, duration: number): ActionContext {\r\n    this._queue.add(new Fade(this._entity, opacity, duration));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This will cause an actor to flash a specific color for a period of time\r\n   * @param color\r\n   * @param duration The duration in milliseconds\r\n   */\r\n  public flash(color: Color, duration: number = 1000) {\r\n    this._queue.add(new Flash(this._entity, color, duration));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will delay the next action from executing for a certain\r\n   * amount of time (in milliseconds). This method is part of the actor\r\n   * 'Action' fluent API allowing action chaining.\r\n   * @param duration  The amount of time to delay the next action in the queue from executing in milliseconds\r\n   */\r\n  public delay(duration: number): ActionContext {\r\n    this._queue.add(new Delay(duration));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will add an action to the queue that will remove the actor from the\r\n   * scene once it has completed its previous  Any actions on the\r\n   * action queue after this action will not be executed.\r\n   */\r\n  public die(): ActionContext {\r\n    this._queue.add(new Die(this._entity));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method allows you to call an arbitrary method as the next action in the\r\n   * action queue. This is useful if you want to execute code in after a specific\r\n   * action, i.e An actor arrives at a destination after traversing a path\r\n   */\r\n  public callMethod(method: () => any): ActionContext {\r\n    this._queue.add(new CallMethod(method));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   * @param times  The number of times to repeat all the previous actions in the action queue. If nothing is specified the actions\r\n   * will repeat forever\r\n   */\r\n  public repeat(repeatBuilder: (repeatContext: ActionContext) => any, times?: number): ActionContext {\r\n    if (!times) {\r\n      this.repeatForever(repeatBuilder);\r\n      return this;\r\n    }\r\n    this._queue.add(new Repeat(this._entity, repeatBuilder, times));\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   */\r\n  public repeatForever(repeatBuilder: (repeatContext: ActionContext) => any): ActionContext {\r\n    this._queue.add(new RepeatForever(this._entity, repeatBuilder));\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to follow another at a specified distance\r\n   * @param entity           The entity to follow\r\n   * @param followDistance  The distance to maintain when following, if not specified the actor will follow at the current distance.\r\n   */\r\n  public follow(entity: Entity, followDistance?: number): ActionContext {\r\n    if (followDistance === undefined) {\r\n      this._queue.add(new Follow(this._entity, entity));\r\n    } else {\r\n      this._queue.add(new Follow(this._entity, entity, followDistance));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to move towards another until they\r\n   * collide \"meet\" at a specified speed.\r\n   * @param entity  The entity to meet\r\n   * @param speed  The speed in pixels per second to move, if not specified it will match the speed of the other actor\r\n   */\r\n  public meet(entity: Entity, speed?: number): ActionContext {\r\n    if (speed === undefined) {\r\n      this._queue.add(new Meet(this._entity, entity));\r\n    } else {\r\n      this._queue.add(new Meet(this._entity, entity, speed));\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns a promise that resolves when the current action queue up to now\r\n   * is finished.\r\n   */\r\n  public toPromise(): Promise<void> {\r\n    const temp = new Promise<void>((resolve) => {\r\n      this._queue.add(\r\n        new CallMethod(() => {\r\n          resolve();\r\n        })\r\n      );\r\n    });\r\n    return temp;\r\n  }\r\n}\r\n","import { ActionContext } from './ActionContext';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Actor } from '../Actor';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Vector, RotationType } from '../Math';\r\nimport { EasingFunction } from '../Util/EasingFunctions';\r\nimport { ActionQueue } from './ActionQueue';\r\nimport { Action } from './Action';\r\nimport { Color } from '../Color';\r\nimport { CurveToOptions } from './Action/CurveTo';\r\nimport { CurveByOptions } from './Action/CurveBy';\r\nimport { MoveToOptions } from './Action/MoveTo';\r\nimport { MoveByOptions, RotateByOptions, RotateToOptions, ScaleByOptions, ScaleToOptions } from './index';\r\n\r\nexport interface ActionContextMethods extends Pick<ActionContext, keyof ActionContext> {}\r\n\r\nexport class ActionsComponent extends Component implements ActionContextMethods {\r\n  dependencies = [TransformComponent, MotionComponent];\r\n  private _ctx: ActionContext | null = null;\r\n\r\n  onAdd(entity: Entity) {\r\n    this._ctx = new ActionContext(entity);\r\n  }\r\n\r\n  onRemove() {\r\n    this._ctx = null;\r\n  }\r\n\r\n  private _getCtx() {\r\n    if (!this._ctx) {\r\n      throw new Error('Actions component not attached to an entity, no context available');\r\n    }\r\n    return this._ctx;\r\n  }\r\n\r\n  /**\r\n   * Returns the internal action queue\r\n   * @returns action queue\r\n   */\r\n  public getQueue(): ActionQueue {\r\n    if (!this._ctx) {\r\n      throw new Error('Actions component not attached to an entity, no queue available');\r\n    }\r\n    return this._ctx.getQueue();\r\n  }\r\n\r\n  /**\r\n   * Runs a specific action in the action queue\r\n   * @param action\r\n   */\r\n  public runAction(action: Action): ActionContext {\r\n    if (!this._ctx) {\r\n      throw new Error('Actions component not attached to an entity, cannot run action');\r\n    }\r\n    return this._ctx.runAction(action);\r\n  }\r\n\r\n  /**\r\n   * Updates the internal action context, performing action and moving through the internal queue\r\n   * @param elapsed\r\n   */\r\n  public update(elapsed: number): void {\r\n    return this._ctx?.update(elapsed);\r\n  }\r\n\r\n  /**\r\n   * Clears all queued actions from the Actor\r\n   */\r\n  public clearActions(): void {\r\n    this._ctx?.clearActions();\r\n  }\r\n\r\n  /**\r\n   * Animates an actor with a specified bezier curve by an offset to the current position, the start point is assumed\r\n   * to be the actors current position\r\n   * @param options\r\n   */\r\n  public curveBy(options: CurveByOptions): ActionContext {\r\n    return this._getCtx().curveBy.apply(this._ctx, [options]);\r\n  }\r\n\r\n  /**\r\n   * Animates an actor with a specified bezier curve to an absolute world space coordinate, the start point is assumed\r\n   * to be the actors current position\r\n   * @param options\r\n   */\r\n  public curveTo(options: CurveToOptions): ActionContext {\r\n    return this._getCtx().curveTo.apply(this._ctx, [options]);\r\n  }\r\n\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given {@apilink EasingFunctions} and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos       The x,y vector location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use {@apilink EasingFunctions} or a custom function to use to calculate position, Default is {@apilink EasingFunctions.Linear}\r\n   * @deprecated use new moveTo({pos: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeTo(pos: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified `x` and `y` position over the\r\n   * specified duration using a given {@apilink EasingFunctions} and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x         The x location to move the actor to\r\n   * @param y         The y location to move the actor to\r\n   * @param duration  The time it should take the actor to move to the new location in milliseconds\r\n   * @param easingFcn Use {@apilink EasingFunctions} or a custom function to use to calculate position, Default is {@apilink EasingFunctions.Linear}\r\n   * @deprecated use new moveTo({pos: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeTo(x: number, y: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeTo(...args: any[]): ActionContext {\r\n    return this._getCtx().easeTo.apply(this._ctx, args as any);\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @param offset\r\n   * @param duration\r\n   * @param easingFcn\r\n   * @deprecated use new moveBy({pos: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeBy(offset: Vector, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  /**\r\n   *\r\n   * @param offsetX\r\n   * @param offsetY\r\n   * @param duration\r\n   * @param easingFcn\r\n   * @deprecated use new moveBy({pos: Vector, duration: number, easing: EasingFunction})\r\n   */\r\n  public easeBy(offsetX: number, offsetY: number, duration: number, easingFcn?: EasingFunction): ActionContext;\r\n  public easeBy(...args: any[]): ActionContext {\r\n    return this._getCtx().easeBy.apply(this._ctx, args as any);\r\n  }\r\n\r\n  /**\r\n   * Moves an actor to a specified {@link Vector} in a given duration in milliseconds.\r\n   * You may optionally specify an {@link EasingFunction}\r\n   * @param options\r\n   */\r\n  public moveTo(options: MoveToOptions): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param pos    The x,y vector location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(pos: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor to the specified x and y position at the\r\n   * speed specified (in pixels per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param x      The x location to move the actor to\r\n   * @param y      The y location to move the actor to\r\n   * @param speed  The speed in pixels per second to move\r\n   */\r\n  public moveTo(x: number, y: number, speed: number): ActionContext;\r\n  public moveTo(xOrPosOrOptions: number | Vector | MoveToOptions, yOrSpeed?: number, speedOrUndefined?: number): ActionContext {\r\n    return this._getCtx().moveTo.apply(this._ctx, [xOrPosOrOptions, yOrSpeed, speedOrUndefined] as any);\r\n  }\r\n\r\n  /**\r\n   * Moves an actor by a specified offset {@link Vector} in a given duration in milliseconds.\r\n   * You may optionally specify an {@link EasingFunction}\r\n   * @param options\r\n   */\r\n  public moveBy(options: MoveByOptions): ActionContext;\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param offset The (x, y) offset to apply to this actor\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will move an actor by the specified x offset and y offset from its current position, at a certain speed.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param xOffset     The x offset to apply to this actor\r\n   * @param yOffset     The y location to move the actor to\r\n   * @param speed  The speed in pixels per second the actor should move\r\n   */\r\n  public moveBy(xOffset: number, yOffset: number, speed: number): ActionContext;\r\n  public moveBy(\r\n    xOffsetOrVectorOptions: number | Vector | MoveByOptions,\r\n    yOffsetOrSpeed?: number,\r\n    speedOrUndefined?: number\r\n  ): ActionContext {\r\n    return this._getCtx().moveBy.apply(this._ctx, [xOffsetOrVectorOptions, yOffsetOrSpeed, speedOrUndefined] as any);\r\n  }\r\n\r\n  /**\r\n   * Rotates an actor to a specified angle over a duration in milliseconds,\r\n   * you make pick a rotation strategy {@link RotationType} to pick the direction\r\n   * @param options\r\n   */\r\n  public rotateTo(options: RotateToOptions): ActionContext;\r\n  /**\r\n   * This method will rotate an actor to the specified angle at the speed\r\n   * specified (in radians per second) and return back the actor. This\r\n   * method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angle  The angle to rotate to in radians\r\n   * @param speed         The angular velocity of the rotation specified in radians per second\r\n   * @param rotationType  The {@apilink RotationType} to use for this rotation\r\n   */\r\n  public rotateTo(angle: number, speed: number, rotationType?: RotationType): ActionContext;\r\n  public rotateTo(angle: number | RotateToOptions, speed?: number, rotationType?: RotationType): ActionContext {\r\n    return this._getCtx().rotateTo.apply(this._ctx, [angle, speed, rotationType] as any);\r\n  }\r\n\r\n  /**\r\n   * Rotates an actor by a specified offset angle over a duration in milliseconds,\r\n   * you make pick a rotation strategy {@link RotationType} to pick the direction\r\n   * @param options\r\n   */\r\n  public rotateBy(options: RotateByOptions): ActionContext;\r\n  /**\r\n   * This method will rotate an actor by the specified angle offset, from it's current rotation given a certain speed\r\n   * in radians/sec and return back the actor. This method is part\r\n   * of the actor 'Action' fluent API allowing action chaining.\r\n   * @param angleRadiansOffset  The angle to rotate to in radians relative to the current rotation\r\n   * @param speed          The speed in radians/sec the actor should rotate at\r\n   * @param rotationType  The {@apilink RotationType} to use for this rotation, default is shortest path\r\n   */\r\n  public rotateBy(angleRadiansOffset: number, speed: number, rotationType?: RotationType): ActionContext;\r\n  public rotateBy(angleRadiansOffsetOrOptions: number | RotateByOptions, speed?: number, rotationType?: RotationType): ActionContext {\r\n    return this._getCtx().rotateBy.apply(this._ctx, [angleRadiansOffsetOrOptions, speed, rotationType] as any);\r\n  }\r\n\r\n  /**\r\n   * Scales an actor to a specified scale {@link Vector} over a duration\r\n   * @param options\r\n   */\r\n  public scaleTo(options: ScaleToOptions): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param size    The scale to adjust the actor to over time\r\n   * @param speed   The speed of scaling specified in magnitude increase per second\r\n   */\r\n  public scaleTo(size: Vector, speed: Vector): ActionContext;\r\n  /**\r\n   * This method will scale an actor to the specified size at the speed\r\n   * specified (in magnitude increase per second) and return back the\r\n   * actor. This method is part of the actor 'Action' fluent API allowing\r\n   * action chaining.\r\n   * @param sizeX   The scaling factor to apply on X axis\r\n   * @param sizeY   The scaling factor to apply on Y axis\r\n   * @param speedX  The speed of scaling specified in magnitude increase per second on X axis\r\n   * @param speedY  The speed of scaling specified in magnitude increase per second on Y axis\r\n   */\r\n  public scaleTo(sizeX: number, sizeY: number, speedX: number, speedY: number): ActionContext;\r\n  public scaleTo(\r\n    sizeXOrVectorOrOptions: number | Vector | ScaleToOptions,\r\n    sizeYOrSpeed?: number | Vector,\r\n    speedXOrUndefined?: number,\r\n    speedYOrUndefined?: number\r\n  ): ActionContext {\r\n    return this._getCtx().scaleTo.apply(this._ctx, [sizeXOrVectorOrOptions, sizeYOrSpeed, speedXOrUndefined, speedYOrUndefined] as any);\r\n  }\r\n\r\n  /**\r\n   * Scales an actor by a specified scale offset {@link Vector} over a duration in milliseconds\r\n   * @param options\r\n   */\r\n  public scaleBy(options: ScaleByOptions): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param offset   The scaling factor to apply to the actor\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(offset: Vector, speed: number): ActionContext;\r\n  /**\r\n   * This method will scale an actor by an amount relative to the current scale at a certain speed in scale units/sec\r\n   * and return back the actor. This method is part of the\r\n   * actor 'Action' fluent API allowing action chaining.\r\n   * @param sizeOffsetX   The scaling factor to apply on X axis\r\n   * @param sizeOffsetY   The scaling factor to apply on Y axis\r\n   * @param speed    The speed to scale at in scale units/sec\r\n   */\r\n  public scaleBy(sizeOffsetX: number, sizeOffsetY: number, speed: number): ActionContext;\r\n  public scaleBy(\r\n    sizeOffsetXOrVectorOrOptions: number | Vector | ScaleByOptions,\r\n    sizeOffsetYOrSpeed?: number,\r\n    speed?: number\r\n  ): ActionContext {\r\n    return this._getCtx().scaleBy.apply(this._ctx, [sizeOffsetXOrVectorOrOptions, sizeOffsetYOrSpeed, speed] as any);\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor to blink (become visible and not\r\n   * visible). Optionally, you may specify the number of blinks. Specify the amount of time\r\n   * the actor should be visible per blink, and the amount of time not visible.\r\n   * This method is part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param timeVisible     The amount of time to stay visible per blink in milliseconds\r\n   * @param timeNotVisible  The amount of time to stay not visible per blink in milliseconds\r\n   * @param numBlinks       The number of times to blink\r\n   */\r\n  public blink(timeVisible: number, timeNotVisible: number, numBlinks?: number): ActionContext {\r\n    return this._getCtx().blink(timeVisible, timeNotVisible, numBlinks);\r\n  }\r\n\r\n  /**\r\n   * This method will cause an actor's opacity to change from its current value\r\n   * to the provided value by a specified time (in milliseconds). This method is\r\n   * part of the actor 'Action' fluent API allowing action chaining.\r\n   * @param opacity  The ending opacity\r\n   * @param duration     The time it should take to fade the actor (in milliseconds)\r\n   */\r\n  public fade(opacity: number, duration: number): ActionContext {\r\n    return this._getCtx().fade(opacity, duration);\r\n  }\r\n\r\n  /**\r\n   * This will cause an actor to flash a specific color for a period of time\r\n   * @param color\r\n   * @param duration The duration in milliseconds\r\n   */\r\n  public flash(color: Color, duration: number = 1000) {\r\n    return this._getCtx().flash(color, duration);\r\n  }\r\n\r\n  /**\r\n   * This method will delay the next action from executing for a certain\r\n   * amount of time (in milliseconds). This method is part of the actor\r\n   * 'Action' fluent API allowing action chaining.\r\n   * @param duration  The amount of time to delay the next action in the queue from executing in milliseconds\r\n   */\r\n  public delay(duration: number): ActionContext {\r\n    return this._getCtx().delay(duration);\r\n  }\r\n\r\n  /**\r\n   * This method will add an action to the queue that will remove the actor from the\r\n   * scene once it has completed its previous  Any actions on the\r\n   * action queue after this action will not be executed.\r\n   */\r\n  public die(): ActionContext {\r\n    return this._getCtx().die();\r\n  }\r\n\r\n  /**\r\n   * This method allows you to call an arbitrary method as the next action in the\r\n   * action queue. This is useful if you want to execute code in after a specific\r\n   * action, i.e An actor arrives at a destination after traversing a path\r\n   */\r\n  public callMethod(method: () => any): ActionContext {\r\n    return this._getCtx().callMethod(method);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   * @param times  The number of times to repeat all the previous actions in the action queue. If nothing is specified the actions\r\n   * will repeat forever\r\n   */\r\n  public repeat(repeatBuilder: (repeatContext: ActionContext) => any, times?: number): ActionContext {\r\n    return this._getCtx().repeat(repeatBuilder, times);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the actor to repeat all of the actions built in\r\n   * the `repeatBuilder` callback. If the number of repeats\r\n   * is not specified it will repeat forever. This method is part of\r\n   * the actor 'Action' fluent API allowing action chaining\r\n   *\r\n   * ```typescript\r\n   * // Move up in a zig-zag by repeated moveBy's\r\n   * actor.actions.repeat(repeatCtx => {\r\n   * repeatCtx.moveBy(10, 0, 10);\r\n   * repeatCtx.moveBy(0, 10, 10);\r\n   * }, 5);\r\n   * ```\r\n   * @param repeatBuilder The builder to specify the repeatable list of actions\r\n   */\r\n  public repeatForever(repeatBuilder: (repeatContext: ActionContext) => any): ActionContext {\r\n    return this._getCtx().repeatForever(repeatBuilder);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to follow another at a specified distance\r\n   * @param entity           The entity to follow\r\n   * @param followDistance  The distance to maintain when following, if not specified the actor will follow at the current distance.\r\n   */\r\n  public follow(entity: Actor, followDistance?: number): ActionContext {\r\n    return this._getCtx().follow(entity, followDistance);\r\n  }\r\n\r\n  /**\r\n   * This method will cause the entity to move towards another until they\r\n   * collide \"meet\" at a specified speed.\r\n   * @param entity  The entity to meet\r\n   * @param speed  The speed in pixels per second to move, if not specified it will match the speed of the other actor\r\n   */\r\n  public meet(entity: Actor, speed?: number): ActionContext {\r\n    return this._getCtx().meet(entity, speed);\r\n  }\r\n\r\n  /**\r\n   * Returns a promise that resolves when the current action queue up to now\r\n   * is finished.\r\n   */\r\n  public toPromise(): Promise<void> {\r\n    return this._getCtx().toPromise();\r\n  }\r\n}\r\n","import {\r\n  KillEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PostCollisionEvent,\r\n  PreCollisionEvent,\r\n  CollisionStartEvent,\r\n  CollisionEndEvent,\r\n  PostKillEvent,\r\n  PreKillEvent,\r\n  EnterViewPortEvent,\r\n  ExitViewPortEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  PreDebugDrawEvent,\r\n  PostDebugDrawEvent,\r\n  ActionStartEvent,\r\n  ActionCompleteEvent\r\n} from './Events';\r\nimport { Engine } from './Engine';\r\nimport { Color } from './Color';\r\nimport { CanInitialize, CanUpdate, CanBeKilled } from './Interfaces/LifecycleEvents';\r\nimport { Scene } from './Scene';\r\nimport { Logger } from './Util/Log';\r\nimport { Vector, vec } from './Math/vector';\r\nimport { BodyComponent } from './Collision/BodyComponent';\r\nimport { Eventable } from './Interfaces/Evented';\r\nimport { PointerEvents } from './Interfaces/PointerEventHandlers';\r\nimport { CollisionType } from './Collision/CollisionType';\r\n\r\nimport { Entity, EntityEvents } from './EntityComponentSystem/Entity';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { MotionComponent } from './EntityComponentSystem/Components/MotionComponent';\r\nimport { GraphicsComponent } from './Graphics/GraphicsComponent';\r\nimport { Rectangle } from './Graphics/Rectangle';\r\nimport { ColliderComponent } from './Collision/ColliderComponent';\r\nimport { Shape } from './Collision/Colliders/Shape';\r\nimport { watch } from './Util/Watch';\r\nimport { Collider, CollisionContact, CollisionGroup, Side } from './Collision/Index';\r\nimport { Circle } from './Graphics/Circle';\r\nimport { PointerEvent } from './Input/PointerEvent';\r\nimport { WheelEvent } from './Input/WheelEvent';\r\nimport { PointerComponent } from './Input/PointerComponent';\r\nimport { ActionsComponent } from './Actions/ActionsComponent';\r\nimport { CoordPlane } from './Math/coord-plane';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { Component } from './EntityComponentSystem';\r\n\r\n/**\r\n * Type guard for checking if something is an Actor\r\n * @param x\r\n */\r\nexport function isActor(x: any): x is Actor {\r\n  return x instanceof Actor;\r\n}\r\n\r\n/**\r\n * Actor constructor options\r\n */\r\nexport type ActorArgs = ColliderArgs & {\r\n  /**\r\n   * Optionally set the name of the actor, default is 'anonymous'\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally set the x position of the actor, default is 0\r\n   */\r\n  x?: number;\r\n  /**\r\n   * Optionally set the y position of the actor, default is 0\r\n   */\r\n  y?: number;\r\n  /**\r\n   * Optionally set the (x, y) position of the actor as a vector, default is (0, 0)\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally set the coordinate plane of the actor, default is {@apilink CoordPlane.World} meaning actor is subject to camera positioning\r\n   */\r\n  coordPlane?: CoordPlane;\r\n  /**\r\n   * Optionally set the velocity of the actor in pixels/sec\r\n   */\r\n  vel?: Vector;\r\n  /**\r\n   * Optionally set the acceleration of the actor in pixels/sec^2\r\n   */\r\n  acc?: Vector;\r\n  /**\r\n   * Optionally se the rotation in radians (180 degrees = Math.PI radians)\r\n   */\r\n  rotation?: number;\r\n  /**\r\n   * Optionally set the angular velocity of the actor in radians/sec (180 degrees = Math.PI radians)\r\n   */\r\n  angularVelocity?: number;\r\n  /**\r\n   * Optionally set the scale of the actor's transform\r\n   */\r\n  scale?: Vector;\r\n  /**\r\n   * Optionally set the z index of the actor, default is 0\r\n   */\r\n  z?: number;\r\n  /**\r\n   * Optionally set the color of an actor, only used if no graphics are present\r\n   * If a width/height or a radius was set a default graphic will be added\r\n   */\r\n  color?: Color;\r\n  /**\r\n   * Optionally set the color of an actor, only used if no graphics are present\r\n   * If a width/height or a radius was set a default graphic will be added\r\n   */\r\n  opacity?: number;\r\n  /**\r\n   * Optionally set the visibility of the actor\r\n   */\r\n  visible?: boolean;\r\n  /**\r\n   * Optionally set the anchor for graphics in the actor\r\n   */\r\n  anchor?: Vector;\r\n  /**\r\n   * Optionally set the anchor for graphics in the actor\r\n   */\r\n  offset?: Vector;\r\n  /**\r\n   * Optionally set the collision type\r\n   */\r\n  collisionType?: CollisionType;\r\n\r\n  /**\r\n   * Optionally supply a {@apilink CollisionGroup}\r\n   */\r\n  collisionGroup?: CollisionGroup;\r\n\r\n  /**\r\n   * Optionally silence excalibur warning warnings\r\n   */\r\n  silenceWarnings?: boolean;\r\n};\r\n\r\ntype ColliderArgs =\r\n  | // custom collider\r\n  {\r\n      /**\r\n       * Optionally supply a collider for an actor, if supplied ignores any supplied width/height\r\n       */\r\n      collider?: Collider;\r\n\r\n      width?: undefined;\r\n      height?: undefined;\r\n      radius?: undefined;\r\n    }\r\n  // box collider\r\n  | {\r\n      /**\r\n       * Optionally set the width of a box collider for the actor\r\n       */\r\n      width?: number;\r\n      /**\r\n       * Optionally set the height of a box collider for the actor\r\n       */\r\n      height?: number;\r\n\r\n      collider?: undefined;\r\n      radius?: undefined;\r\n    }\r\n  // circle collider\r\n  | {\r\n      /**\r\n       * Optionally set the radius of the circle collider for the actor\r\n       */\r\n      radius?: number;\r\n\r\n      collider?: undefined;\r\n      width?: undefined;\r\n      height?: undefined;\r\n    };\r\n\r\nexport type ActorEvents = EntityEvents & {\r\n  collisionstart: CollisionStartEvent;\r\n  collisionend: CollisionEndEvent;\r\n  precollision: PreCollisionEvent;\r\n  postcollision: PostCollisionEvent;\r\n  kill: KillEvent;\r\n  prekill: PreKillEvent;\r\n  postkill: PostKillEvent;\r\n  predraw: PreDrawEvent;\r\n  postdraw: PostDrawEvent;\r\n  pretransformdraw: PreDrawEvent;\r\n  posttransformdraw: PostDrawEvent;\r\n  predebugdraw: PreDebugDrawEvent;\r\n  postdebugdraw: PostDebugDrawEvent;\r\n  pointerup: PointerEvent;\r\n  pointerdown: PointerEvent;\r\n  pointerenter: PointerEvent;\r\n  pointerleave: PointerEvent;\r\n  pointermove: PointerEvent;\r\n  pointercancel: PointerEvent;\r\n  pointerwheel: WheelEvent;\r\n  pointerdragstart: PointerEvent;\r\n  pointerdragend: PointerEvent;\r\n  pointerdragenter: PointerEvent;\r\n  pointerdragleave: PointerEvent;\r\n  pointerdragmove: PointerEvent;\r\n  enterviewport: EnterViewPortEvent;\r\n  exitviewport: ExitViewPortEvent;\r\n  actionstart: ActionStartEvent;\r\n  actioncomplete: ActionCompleteEvent;\r\n};\r\n\r\nexport const ActorEvents = {\r\n  CollisionStart: 'collisionstart',\r\n  CollisionEnd: 'collisionend',\r\n  PreCollision: 'precollision',\r\n  PostCollision: 'postcollision',\r\n  Kill: 'kill',\r\n  PreKill: 'prekill',\r\n  PostKill: 'postkill',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw',\r\n  PreTransformDraw: 'pretransformdraw',\r\n  PostTransformDraw: 'posttransformdraw',\r\n  PreDebugDraw: 'predebugdraw',\r\n  PostDebugDraw: 'postdebugdraw',\r\n  PointerUp: 'pointerup',\r\n  PointerDown: 'pointerdown',\r\n  PointerEnter: 'pointerenter',\r\n  PointerLeave: 'pointerleave',\r\n  PointerMove: 'pointermove',\r\n  PointerCancel: 'pointercancel',\r\n  Wheel: 'pointerwheel',\r\n  PointerDrag: 'pointerdragstart',\r\n  PointerDragEnd: 'pointerdragend',\r\n  PointerDragEnter: 'pointerdragenter',\r\n  PointerDragLeave: 'pointerdragleave',\r\n  PointerDragMove: 'pointerdragmove',\r\n  EnterViewPort: 'enterviewport',\r\n  ExitViewPort: 'exitviewport',\r\n  ActionStart: 'actionstart',\r\n  ActionComplete: 'actioncomplete'\r\n};\r\n\r\n/**\r\n * The most important primitive in Excalibur is an `Actor`. Anything that\r\n * can move on the screen, collide with another `Actor`, respond to events,\r\n * or interact with the current scene, must be an actor. An `Actor` **must**\r\n * be part of a {@apilink Scene} for it to be drawn to the screen.\r\n */\r\nexport class Actor extends Entity implements Eventable, PointerEvents, CanInitialize, CanUpdate, CanBeKilled {\r\n  public events = new EventEmitter<ActorEvents>();\r\n  // #region Properties\r\n\r\n  /**\r\n   * Set defaults for all Actors\r\n   */\r\n  public static defaults = {\r\n    anchor: Vector.Half\r\n  };\r\n\r\n  /**\r\n   * The physics body the is associated with this actor. The body is the container for all physical properties, like position, velocity,\r\n   * acceleration, mass, inertia, etc.\r\n   */\r\n  public body: BodyComponent;\r\n\r\n  /**\r\n   * Access the Actor's built in {@apilink TransformComponent}\r\n   */\r\n  public transform: TransformComponent;\r\n\r\n  /**\r\n   * Access the Actor's built in {@apilink MotionComponent}\r\n   */\r\n  public motion: MotionComponent;\r\n\r\n  /**\r\n   * Access to the Actor's built in {@apilink GraphicsComponent}\r\n   */\r\n  public graphics: GraphicsComponent;\r\n\r\n  /**\r\n   * Access to the Actor's built in {@apilink ColliderComponent}\r\n   */\r\n  public collider: ColliderComponent;\r\n\r\n  /**\r\n   * Access to the Actor's built in {@apilink PointerComponent} config\r\n   */\r\n  public pointer: PointerComponent;\r\n\r\n  /**\r\n   * Useful for quickly scripting actor behavior, like moving to a place, patrolling back and forth, blinking, etc.\r\n   *\r\n   *  Access to the Actor's built in {@apilink ActionsComponent} which forwards to the\r\n   * {@apilink ActionContext | `Action context`} of the actor.\r\n   */\r\n  public actions: ActionsComponent;\r\n  private _silenceWarnings: boolean;\r\n\r\n  /**\r\n   * Gets the position vector of the actor in pixels\r\n   */\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  /**\r\n   * Sets the position vector of the actor in pixels\r\n   */\r\n  public set pos(thePos: Vector) {\r\n    this.transform.pos = thePos.clone();\r\n  }\r\n\r\n  /**\r\n   * Gets the position vector of the actor from the last frame\r\n   */\r\n  public get oldPos(): Vector {\r\n    return this.body.oldPos;\r\n  }\r\n\r\n  /**\r\n   * Gets the global position vector of the actor from the last frame\r\n   */\r\n  public get oldGlobalPos(): Vector {\r\n    return this.body.oldGlobalPos;\r\n  }\r\n\r\n  /**\r\n   * Sets the position vector of the actor in the last frame\r\n   */\r\n  public set oldPos(thePos: Vector) {\r\n    this.body.oldPos.setTo(thePos.x, thePos.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the velocity vector of the actor in pixels/sec\r\n   */\r\n  public get vel(): Vector {\r\n    return this.motion.vel;\r\n  }\r\n\r\n  /**\r\n   * Sets the velocity vector of the actor in pixels/sec\r\n   */\r\n  public set vel(theVel: Vector) {\r\n    this.motion.vel = theVel.clone();\r\n  }\r\n\r\n  /**\r\n   * Gets the velocity vector of the actor from the last frame\r\n   */\r\n  public get oldVel(): Vector {\r\n    return this.body.oldVel;\r\n  }\r\n\r\n  /**\r\n   * Sets the velocity vector of the actor from the last frame\r\n   */\r\n  public set oldVel(theVel: Vector) {\r\n    this.body.oldVel.setTo(theVel.x, theVel.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the acceleration vector of the actor in pixels/second/second. An acceleration pointing down such as (0, 100) may be\r\n   * useful to simulate a gravitational effect.\r\n   */\r\n  public get acc(): Vector {\r\n    return this.motion.acc;\r\n  }\r\n\r\n  /**\r\n   * Sets the acceleration vector of teh actor in pixels/second/second\r\n   */\r\n  public set acc(theAcc: Vector) {\r\n    this.motion.acc = theAcc.clone();\r\n  }\r\n\r\n  /**\r\n   * Sets the acceleration of the actor from the last frame. This does not include the global acc {@apilink Physics.acc}.\r\n   */\r\n  public set oldAcc(theAcc: Vector) {\r\n    this.body.oldAcc.setTo(theAcc.x, theAcc.y);\r\n  }\r\n\r\n  /**\r\n   * Gets the acceleration of the actor from the last frame. This does not include the global acc {@apilink Physics.acc}.\r\n   */\r\n  public get oldAcc(): Vector {\r\n    return this.body.oldAcc;\r\n  }\r\n\r\n  /**\r\n   * Gets the rotation of the actor in radians. 1 radian = 180/PI Degrees.\r\n   */\r\n  public get rotation(): number {\r\n    return this.transform.rotation;\r\n  }\r\n\r\n  /**\r\n   * Sets the rotation of the actor in radians. 1 radian = 180/PI Degrees.\r\n   */\r\n  public set rotation(theAngle: number) {\r\n    this.transform.rotation = theAngle;\r\n  }\r\n\r\n  /**\r\n   * Gets the rotational velocity of the actor in radians/second\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this.motion.angularVelocity;\r\n  }\r\n\r\n  /**\r\n   * Sets the rotational velocity of the actor in radians/sec\r\n   */\r\n  public set angularVelocity(angularVelocity: number) {\r\n    this.motion.angularVelocity = angularVelocity;\r\n  }\r\n\r\n  public get scale(): Vector {\r\n    return this.get(TransformComponent).scale;\r\n  }\r\n\r\n  public set scale(scale: Vector) {\r\n    this.get(TransformComponent).scale = scale;\r\n  }\r\n\r\n  private _anchor: Vector = watch(Vector.Half, (v) => this._handleAnchorChange(v));\r\n  /**\r\n   * The anchor to apply all actor related transformations like rotation,\r\n   * translation, and scaling. By default the anchor is in the center of\r\n   * the actor. By default it is set to the center of the actor (.5, .5)\r\n   *\r\n   * An anchor of (.5, .5) will ensure that drawings are centered.\r\n   *\r\n   * Use `anchor.setTo` to set the anchor to a different point using\r\n   * values between 0 and 1. For example, anchoring to the top-left would be\r\n   * `Actor.anchor.setTo(0, 0)` and top-right would be `Actor.anchor.setTo(0, 1)`.\r\n   */\r\n  public get anchor(): Vector {\r\n    return this._anchor;\r\n  }\r\n\r\n  public set anchor(vec: Vector) {\r\n    this._anchor = watch(vec, (v) => this._handleAnchorChange(v));\r\n    this._handleAnchorChange(vec);\r\n  }\r\n\r\n  private _handleAnchorChange(v: Vector) {\r\n    if (this.graphics) {\r\n      this.graphics.anchor = v;\r\n    }\r\n  }\r\n\r\n  private _offset: Vector = watch(Vector.Zero, (v) => this._handleOffsetChange(v));\r\n  /**\r\n   * The offset in pixels to apply to all actor graphics\r\n   *\r\n   * Default offset of (0, 0)\r\n   */\r\n  public get offset(): Vector {\r\n    return this._offset;\r\n  }\r\n\r\n  public set offset(vec: Vector) {\r\n    this._offset = watch(vec, (v) => this._handleOffsetChange(v));\r\n    this._handleOffsetChange(vec);\r\n  }\r\n\r\n  private _handleOffsetChange(v: Vector) {\r\n    if (this.graphics) {\r\n      this.graphics.offset = v;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Indicates whether the actor is physically in the viewport\r\n   */\r\n  public get isOffScreen(): boolean {\r\n    return this.hasTag('ex.offscreen');\r\n  }\r\n\r\n  /**\r\n   * Convenience reference to the global logger\r\n   */\r\n  public logger: Logger = Logger.getInstance();\r\n\r\n  /**\r\n   * Draggable helper\r\n   */\r\n  private _draggable: boolean = false;\r\n  private _dragging: boolean = false;\r\n\r\n  private _pointerDragStartHandler = () => {\r\n    this._dragging = true;\r\n  };\r\n\r\n  private _pointerDragEndHandler = () => {\r\n    this._dragging = false;\r\n  };\r\n\r\n  private _pointerDragMoveHandler = (pe: PointerEvent) => {\r\n    if (this._dragging) {\r\n      this.pos = pe.worldPos;\r\n    }\r\n  };\r\n\r\n  private _pointerDragLeaveHandler = (pe: PointerEvent) => {\r\n    if (this._dragging) {\r\n      this.pos = pe.worldPos;\r\n    }\r\n  };\r\n\r\n  public get draggable(): boolean {\r\n    return this._draggable;\r\n  }\r\n\r\n  public set draggable(isDraggable: boolean) {\r\n    if (isDraggable) {\r\n      if (isDraggable && !this._draggable) {\r\n        this.events.on('pointerdragstart', this._pointerDragStartHandler);\r\n        this.events.on('pointerdragend', this._pointerDragEndHandler);\r\n        this.events.on('pointerdragmove', this._pointerDragMoveHandler);\r\n        this.events.on('pointerdragleave', this._pointerDragLeaveHandler);\r\n      } else if (!isDraggable && this._draggable) {\r\n        this.events.off('pointerdragstart', this._pointerDragStartHandler);\r\n        this.events.off('pointerdragend', this._pointerDragEndHandler);\r\n        this.events.off('pointerdragmove', this._pointerDragMoveHandler);\r\n        this.events.off('pointerdragleave', this._pointerDragLeaveHandler);\r\n      }\r\n\r\n      this._draggable = isDraggable;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the color of the actor's current graphic\r\n   */\r\n  public get color(): Color {\r\n    return this.graphics.color;\r\n  }\r\n  public set color(v: Color) {\r\n    this.graphics.color = v;\r\n  }\r\n\r\n  // #endregion\r\n\r\n  /**\r\n   *\r\n   * @param config\r\n   */\r\n  constructor(config?: ActorArgs) {\r\n    super();\r\n\r\n    const {\r\n      name,\r\n      x,\r\n      y,\r\n      pos,\r\n      coordPlane,\r\n      scale,\r\n      width,\r\n      height,\r\n      radius,\r\n      collider,\r\n      vel,\r\n      acc,\r\n      rotation,\r\n      angularVelocity,\r\n      z,\r\n      color,\r\n      visible,\r\n      opacity,\r\n      anchor,\r\n      offset,\r\n      collisionType,\r\n      collisionGroup,\r\n      silenceWarnings\r\n    } = {\r\n      ...config\r\n    };\r\n\r\n    this.name = name ?? this.name;\r\n    this.anchor = anchor ?? Actor.defaults.anchor.clone();\r\n    this.offset = offset ?? Vector.Zero;\r\n    this.transform = new TransformComponent();\r\n    this.addComponent(this.transform);\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n    this.rotation = rotation ?? 0;\r\n    this.scale = scale ?? vec(1, 1);\r\n    this.z = z ?? 0;\r\n    this.transform.coordPlane = coordPlane ?? CoordPlane.World;\r\n    this._silenceWarnings = silenceWarnings ?? false;\r\n\r\n    this.pointer = new PointerComponent();\r\n    this.addComponent(this.pointer);\r\n\r\n    this.graphics = new GraphicsComponent({\r\n      anchor: this.anchor,\r\n      offset: this.offset,\r\n      opacity: opacity\r\n    });\r\n    this.addComponent(this.graphics);\r\n\r\n    this.motion = new MotionComponent();\r\n    this.addComponent(this.motion);\r\n    this.vel = vel ?? Vector.Zero;\r\n    this.acc = acc ?? Vector.Zero;\r\n    this.angularVelocity = angularVelocity ?? 0;\r\n\r\n    this.actions = new ActionsComponent();\r\n    this.addComponent(this.actions);\r\n\r\n    this.body = new BodyComponent();\r\n    this.addComponent(this.body);\r\n    this.body.collisionType = collisionType ?? CollisionType.Passive;\r\n    if (collisionGroup) {\r\n      this.body.group = collisionGroup;\r\n    }\r\n\r\n    if (color) {\r\n      this.color = color;\r\n    }\r\n\r\n    if (collider) {\r\n      this.collider = new ColliderComponent(collider);\r\n      this.addComponent(this.collider);\r\n    } else if (radius) {\r\n      this.collider = new ColliderComponent(Shape.Circle(radius));\r\n      this.addComponent(this.collider);\r\n\r\n      if (color) {\r\n        this.graphics.add(\r\n          new Circle({\r\n            color: color,\r\n            radius\r\n          })\r\n        );\r\n      }\r\n    } else {\r\n      if (width > 0 && height > 0) {\r\n        this.collider = new ColliderComponent(Shape.Box(width, height, this.anchor));\r\n        this.addComponent(this.collider);\r\n\r\n        if (color && width && height) {\r\n          this.graphics.add(\r\n            new Rectangle({\r\n              color: color,\r\n              width,\r\n              height\r\n            })\r\n          );\r\n        }\r\n      } else {\r\n        this.collider = new ColliderComponent();\r\n        this.addComponent(this.collider); // no collider\r\n      }\r\n    }\r\n\r\n    this.graphics.isVisible = visible ?? true;\r\n  }\r\n\r\n  public clone(): Actor {\r\n    const clone = new Actor({\r\n      silenceWarnings: this._silenceWarnings,\r\n      color: this.color.clone(),\r\n      anchor: this.anchor.clone(),\r\n      offset: this.offset.clone()\r\n    });\r\n    clone.clearComponents();\r\n    clone.processComponentRemoval();\r\n\r\n    // Clone builtins, order is important, same as ctor\r\n    clone.addComponent((clone.transform = this.transform.clone() as TransformComponent), true);\r\n    clone.addComponent((clone.pointer = this.pointer.clone() as PointerComponent), true);\r\n    clone.addComponent((clone.graphics = this.graphics.clone() as GraphicsComponent), true);\r\n    clone.addComponent((clone.motion = this.motion.clone() as MotionComponent), true);\r\n    clone.addComponent((clone.actions = this.actions.clone() as ActionsComponent), true);\r\n    clone.addComponent((clone.body = this.body.clone() as BodyComponent), true);\r\n    clone.addComponent((clone.collider = this.collider.clone() as ColliderComponent), true);\r\n\r\n    const builtInComponents: Component[] = [\r\n      this.transform,\r\n      this.pointer,\r\n      this.graphics,\r\n      this.motion,\r\n      this.actions,\r\n      this.body,\r\n      this.collider\r\n    ];\r\n\r\n    // Clone non-builtin the current actors components\r\n    const components = this.getComponents();\r\n    for (const c of components) {\r\n      if (!builtInComponents.includes(c)) {\r\n        clone.addComponent(c.clone(), true);\r\n      }\r\n    }\r\n    return clone;\r\n  }\r\n\r\n  /**\r\n   * `onInitialize` is called before the first update of the actor. This method is meant to be\r\n   * overridden. This is where initialization of child actors should take place.\r\n   *\r\n   * Synonymous with the event handler `.on('initialize', (evt) => {...})`\r\n   */\r\n  public onInitialize(engine: Engine): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Initializes this actor and all it's child actors, meant to be called by the Scene before first update not by users of Excalibur.\r\n   *\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   * @internal\r\n   */\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n    for (const child of this.children) {\r\n      child._initialize(engine);\r\n    }\r\n  }\r\n\r\n  // #region Events\r\n  public emit<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, event: ActorEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, handler: Handler<ActorEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, handler: Handler<ActorEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<ActorEvents>>(eventName: TEventName, handler: Handler<ActorEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<ActorEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  // #endregion\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _prekill handler for {@apilink onPreKill} lifecycle event\r\n   * @internal\r\n   */\r\n  public _prekill(scene: Scene) {\r\n    this.events.emit('prekill', new PreKillEvent(this));\r\n    this.onPreKill(scene);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreKill lifecycle event handler. Synonymous with `.on('prekill', (evt) =>{...})`\r\n   *\r\n   * `onPreKill` is called directly before an actor is killed and removed from its current {@apilink Scene}.\r\n   */\r\n  public onPreKill(scene: Scene) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _prekill handler for {@apilink onPostKill} lifecycle event\r\n   * @internal\r\n   */\r\n  public _postkill(scene: Scene) {\r\n    this.events.emit('postkill', new PostKillEvent(this));\r\n    this.onPostKill(scene);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostKill lifecycle event handler. Synonymous with `.on('postkill', (evt) => {...})`\r\n   *\r\n   * `onPostKill` is called directly after an actor is killed and remove from its current {@apilink Scene}.\r\n   */\r\n  public onPostKill(scene: Scene) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * If the current actor is a member of the scene, this will remove\r\n   * it from the scene graph. It will no longer be drawn or updated.\r\n   */\r\n  public kill() {\r\n    if (this.scene) {\r\n      this._prekill(this.scene);\r\n      this.events.emit('kill', new KillEvent(this));\r\n      super.kill();\r\n      this._postkill(this.scene);\r\n    } else {\r\n      this.logger.warn(`Cannot kill actor named \"${this.name}\", it was never added to the Scene`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * If the current actor is killed, it will now not be killed.\r\n   */\r\n  public unkill() {\r\n    this.isActive = true;\r\n  }\r\n\r\n  /**\r\n   * Indicates wether the actor has been killed.\r\n   */\r\n  public isKilled(): boolean {\r\n    return !this.isActive;\r\n  }\r\n\r\n  /**\r\n   * Gets the z-index of an actor. The z-index determines the relative order an actor is drawn in.\r\n   * Actors with a higher z-index are drawn on top of actors with a lower z-index\r\n   */\r\n  public get z(): number {\r\n    return this.get(TransformComponent).z;\r\n  }\r\n\r\n  /**\r\n   * Sets the z-index of an actor and updates it in the drawing list for the scene.\r\n   * The z-index determines the relative order an actor is drawn in.\r\n   * Actors with a higher z-index are drawn on top of actors with a lower z-index\r\n   * @param newZ new z-index to assign\r\n   */\r\n  public set z(newZ: number) {\r\n    this.get(TransformComponent).z = newZ;\r\n  }\r\n\r\n  /**\r\n   * Get the center point of an actor (global position)\r\n   */\r\n  public get center(): Vector {\r\n    const globalPos = this.getGlobalPos();\r\n    return new Vector(\r\n      globalPos.x + this.width / 2 - this.anchor.x * this.width,\r\n      globalPos.y + this.height / 2 - this.anchor.y * this.height\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the local center point of an actor\r\n   */\r\n  public get localCenter(): Vector {\r\n    return new Vector(this.pos.x + this.width / 2 - this.anchor.x * this.width, this.pos.y + this.height / 2 - this.anchor.y * this.height);\r\n  }\r\n\r\n  public get width() {\r\n    return this.collider.localBounds.width * this.getGlobalScale().x;\r\n  }\r\n\r\n  public get height() {\r\n    return this.collider.localBounds.height * this.getGlobalScale().y;\r\n  }\r\n\r\n  /**\r\n   * Gets this actor's rotation taking into account any parent relationships\r\n   * @returns Rotation angle in radians\r\n   * @deprecated Use {@apilink globalRotation} instead\r\n   */\r\n  public getGlobalRotation(): number {\r\n    return this.get(TransformComponent).globalRotation;\r\n  }\r\n\r\n  /**\r\n   * The actor's rotation (in radians) taking into account any parent relationships\r\n   */\r\n  public get globalRotation(): number {\r\n    return this.get(TransformComponent).globalRotation;\r\n  }\r\n\r\n  /**\r\n   * Gets an actor's world position taking into account parent relationships, scaling, rotation, and translation\r\n   * @returns Position in world coordinates\r\n   * @deprecated Use {@apilink globalPos} instead\r\n   */\r\n  public getGlobalPos(): Vector {\r\n    return this.get(TransformComponent).globalPos;\r\n  }\r\n\r\n  /**\r\n   * The actor's world position taking into account parent relationships, scaling, rotation, and translation\r\n   */\r\n  public get globalPos(): Vector {\r\n    return this.get(TransformComponent).globalPos;\r\n  }\r\n\r\n  /**\r\n   * Gets the global scale of the Actor\r\n   * @deprecated Use {@apilink globalScale} instead\r\n   */\r\n  public getGlobalScale(): Vector {\r\n    return this.get(TransformComponent).globalScale;\r\n  }\r\n\r\n  /**\r\n   * The global scale of the Actor\r\n   */\r\n  public get globalScale(): Vector {\r\n    return this.get(TransformComponent).globalScale;\r\n  }\r\n\r\n  /**\r\n   * The global z-index of the actor\r\n   */\r\n  public get globalZ(): number {\r\n    return this.get(TransformComponent).globalZ;\r\n  }\r\n\r\n  // #region Collision\r\n\r\n  /**\r\n   * Tests whether the x/y specified are contained in the actor\r\n   * @param x  X coordinate to test (in world coordinates)\r\n   * @param y  Y coordinate to test (in world coordinates)\r\n   * @param recurse checks whether the x/y are contained in any child actors (if they exist).\r\n   */\r\n  public contains(x: number, y: number, recurse: boolean = false): boolean {\r\n    const point = vec(x, y);\r\n    const collider = this.get(ColliderComponent);\r\n    collider.update();\r\n    const geom = collider.get();\r\n    if (!geom) {\r\n      return false;\r\n    }\r\n    const containment = geom.contains(point);\r\n\r\n    if (recurse) {\r\n      return (\r\n        containment ||\r\n        this.children.some((child: Actor) => {\r\n          return child.contains(x, y, true);\r\n        })\r\n      );\r\n    }\r\n\r\n    return containment;\r\n  }\r\n\r\n  /**\r\n   * Returns true if the two actor.collider's surfaces are less than or equal to the distance specified from each other\r\n   * @param actor     Actor to test\r\n   * @param distance  Distance in pixels to test\r\n   */\r\n  public within(actor: Actor, distance: number): boolean {\r\n    const collider = this.get(ColliderComponent);\r\n    const otherCollider = actor.get(ColliderComponent);\r\n    const me = collider.get();\r\n    const other = otherCollider.get();\r\n    if (me && other) {\r\n      return me.getClosestLineBetween(other).getLength() <= distance;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  // #endregion\r\n\r\n  // #region Update\r\n\r\n  /**\r\n   * Called by the Engine, updates the state of the actor\r\n   * @internal\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public update(engine: Engine, elapsed: number) {\r\n    this._initialize(engine);\r\n    this._add(engine);\r\n    this._preupdate(engine, elapsed);\r\n    this._postupdate(engine, elapsed);\r\n    this._remove(engine);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before an actor is updated.\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public onPreUpdate(engine: Engine, elapsed: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('postupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after an actor is updated.\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public onPostUpdate(engine: Engine, elapsed: number): void {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires before every collision resolution for a confirmed contact\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  public onPreCollisionResolve(self: Collider, other: Collider, side: Side, contact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires after every resolution for a confirmed contact.\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  public onPostCollisionResolve(self: Collider, other: Collider, side: Side, contact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires once when 2 entities with a ColliderComponent first start colliding or touching, if the Colliders stay in contact this\r\n   * does not continue firing until they separate and re-collide.\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param contact\r\n   */\r\n  public onCollisionStart(self: Collider, other: Collider, side: Side, contact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Fires once when 2 entities with a ColliderComponent separate after having been in contact.\r\n   * @param self\r\n   * @param other\r\n   * @param side\r\n   * @param lastContact\r\n   */\r\n  public onCollisionEnd(self: Collider, other: Collider, side: Side, lastContact: CollisionContact) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPreUpdate} lifecycle event\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, elapsed: number): void {\r\n    this.events.emit('preupdate', new PreUpdateEvent(engine, elapsed, this));\r\n    this.onPreUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPostUpdate} lifecycle event\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, elapsed: number): void {\r\n    this.events.emit('postupdate', new PostUpdateEvent(engine, elapsed, this));\r\n    this.onPostUpdate(engine, elapsed);\r\n  }\r\n\r\n  // endregion\r\n}\r\n","import { Vector, vec } from './Math/vector';\r\nimport { Engine } from './Engine';\r\nimport { Actor, ActorArgs } from './Actor';\r\nimport { TransformComponent } from './EntityComponentSystem/Components/TransformComponent';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { CoordPlane } from './Math/coord-plane';\r\n\r\n/**\r\n * Type guard to detect a screen element\r\n */\r\nexport function isScreenElement(actor: Actor) {\r\n  return actor instanceof ScreenElement;\r\n}\r\n\r\n/**\r\n * Helper {@apilink Actor} primitive for drawing UI's, optimized for UI drawing. Does\r\n * not participate in collisions. Drawn on top of all other actors.\r\n */\r\nexport class ScreenElement extends Actor {\r\n  protected _engine: Engine;\r\n\r\n  constructor();\r\n  constructor(config?: ActorArgs);\r\n\r\n  constructor(config?: ActorArgs) {\r\n    super({ ...config });\r\n    this.get(TransformComponent).coordPlane = CoordPlane.Screen;\r\n    this.anchor = config?.anchor ?? vec(0, 0);\r\n    this.body.collisionType = config?.collisionType ?? CollisionType.PreventCollision;\r\n    this.pointer.useGraphicsBounds = true;\r\n    this.pointer.useColliderShape = false;\r\n    if (!config?.collider && config?.width > 0 && config?.height > 0) {\r\n      this.collider.useBoxCollider(this.width, this.height, this.anchor);\r\n    }\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    this._engine = engine;\r\n    super._initialize(engine);\r\n  }\r\n\r\n  public contains(x: number, y: number, useWorld: boolean = true) {\r\n    if (useWorld) {\r\n      return super.contains(x, y);\r\n    }\r\n\r\n    const coords = this._engine.worldToScreenCoordinates(new Vector(x, y));\r\n    return super.contains(coords.x, coords.y);\r\n  }\r\n}\r\n","import { Scene } from './Scene';\r\nimport { Logger } from './Util/Log';\r\nimport * as ex from './index';\r\nimport { Random } from './Math/Random';\r\n\r\nexport interface TimerOptions {\r\n  /**\r\n   * If true the timer repeats every interval infinitely\r\n   */\r\n  repeats?: boolean;\r\n  /**\r\n   * If a number is specified then it will only repeat a number of times\r\n   */\r\n  numberOfRepeats?: number;\r\n  /**\r\n   * @deprecated use action: () => void, will be removed in v1.0\r\n   */\r\n  fcn?: () => void;\r\n  /**\r\n   * Action to perform every time the timer fires\r\n   */\r\n  action?: () => void;\r\n  /**\r\n   * Interval in milliseconds for the timer to fire\r\n   */\r\n  interval: number;\r\n  /**\r\n   * Optionally specify a random range of milliseconds for the timer to fire\r\n   */\r\n  randomRange?: [number, number];\r\n  /**\r\n   * Optionally provide a random instance to use for random behavior, otherwise a new random will be created seeded from the current time.\r\n   */\r\n  random?: ex.Random;\r\n}\r\n\r\n/**\r\n * The Excalibur timer hooks into the internal timer and fires callbacks,\r\n * after a certain interval, optionally repeating.\r\n */\r\nexport class Timer {\r\n  private _logger = Logger.getInstance();\r\n  private static _MAX_ID: number = 0;\r\n  public id: number = 0;\r\n\r\n  private _elapsedTime: number = 0;\r\n  private _totalTimeAlive: number = 0;\r\n\r\n  private _running = false;\r\n\r\n  private _numberOfTicks: number = 0;\r\n  private _callbacks: Array<() => void>;\r\n\r\n  public interval: number = 10;\r\n  public repeats: boolean = false;\r\n  public maxNumberOfRepeats: number = -1;\r\n  public randomRange: [number, number] = [0, 0];\r\n  public random: ex.Random;\r\n  private _baseInterval = 10;\r\n  private _generateRandomInterval = () => {\r\n    return this._baseInterval + this.random.integer(this.randomRange[0], this.randomRange[1]);\r\n  };\r\n\r\n  private _complete = false;\r\n  public get complete() {\r\n    return this._complete;\r\n  }\r\n\r\n  public scene: Scene = null;\r\n\r\n  constructor(options: TimerOptions) {\r\n    const fcn = options.action ?? options.fcn;\r\n    const interval = options.interval;\r\n    const repeats = options.repeats;\r\n    const numberOfRepeats = options.numberOfRepeats;\r\n    const randomRange = options.randomRange;\r\n    const random = options.random;\r\n\r\n    if (!!numberOfRepeats && numberOfRepeats >= 0) {\r\n      this.maxNumberOfRepeats = numberOfRepeats;\r\n      if (!repeats) {\r\n        throw new Error('repeats must be set to true if numberOfRepeats is set');\r\n      }\r\n    }\r\n\r\n    this.id = Timer._MAX_ID++;\r\n    this._callbacks = [];\r\n    this._baseInterval = this.interval = interval;\r\n    if (!!randomRange) {\r\n      if (randomRange[0] > randomRange[1]) {\r\n        throw new Error('min value must be lower than max value for range');\r\n      }\r\n      //We use the instance of ex.Random to generate the range\r\n      this.random = random ?? new Random();\r\n      this.randomRange = randomRange;\r\n\r\n      this.interval = this._generateRandomInterval();\r\n      this.on(() => {\r\n        this.interval = this._generateRandomInterval();\r\n      });\r\n    }\r\n    this.repeats = repeats || this.repeats;\r\n    if (fcn) {\r\n      this.on(fcn);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a new callback to be fired after the interval is complete\r\n   * @param action The callback to be added to the callback list, to be fired after the interval is complete.\r\n   */\r\n  public on(action: () => void) {\r\n    this._callbacks.push(action);\r\n  }\r\n\r\n  /**\r\n   * Removes a callback from the callback list to be fired after the interval is complete.\r\n   * @param action The callback to be removed from the callback list, to be fired after the interval is complete.\r\n   */\r\n  public off(action: () => void) {\r\n    const index = this._callbacks.indexOf(action);\r\n    this._callbacks.splice(index, 1);\r\n  }\r\n  /**\r\n   * Updates the timer after a certain number of milliseconds have elapsed. This is used internally by the engine.\r\n   * @param elapsed  Number of elapsed milliseconds since the last update.\r\n   */\r\n  public update(elapsed: number) {\r\n    if (this._running) {\r\n      this._totalTimeAlive += elapsed;\r\n      this._elapsedTime += elapsed;\r\n\r\n      if (this.maxNumberOfRepeats > -1 && this._numberOfTicks >= this.maxNumberOfRepeats) {\r\n        this._complete = true;\r\n        this._running = false;\r\n        this._elapsedTime = 0;\r\n      }\r\n\r\n      if (!this.complete && this._elapsedTime >= this.interval) {\r\n        this._callbacks.forEach((c) => {\r\n          c.call(this);\r\n        });\r\n        this._numberOfTicks++;\r\n        if (this.repeats) {\r\n          this._elapsedTime = 0;\r\n        } else {\r\n          this._complete = true;\r\n          this._running = false;\r\n          this._elapsedTime = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the timer so that it can be reused, and optionally reconfigure the timers interval.\r\n   *\r\n   * Warning** you may need to call `timer.start()` again if the timer had completed\r\n   * @param newInterval If specified, sets a new non-negative interval in milliseconds to refire the callback\r\n   * @param newNumberOfRepeats If specified, sets a new non-negative upper limit to the number of time this timer executes\r\n   */\r\n  public reset(newInterval?: number, newNumberOfRepeats?: number) {\r\n    if (!!newInterval && newInterval >= 0) {\r\n      this._baseInterval = this.interval = newInterval;\r\n    }\r\n\r\n    if (!!this.maxNumberOfRepeats && this.maxNumberOfRepeats >= 0) {\r\n      this.maxNumberOfRepeats = newNumberOfRepeats;\r\n      if (!this.repeats) {\r\n        throw new Error('repeats must be set to true if numberOfRepeats is set');\r\n      }\r\n    }\r\n\r\n    this._complete = false;\r\n    this._elapsedTime = 0;\r\n    this._numberOfTicks = 0;\r\n  }\r\n\r\n  public get timesRepeated(): number {\r\n    return this._numberOfTicks;\r\n  }\r\n\r\n  public getTimeRunning(): number {\r\n    return this._totalTimeAlive;\r\n  }\r\n\r\n  /**\r\n   * @returns milliseconds until the next action callback, if complete will return 0\r\n   */\r\n  public get timeToNextAction() {\r\n    if (this.complete) {\r\n      return 0;\r\n    }\r\n    return this.interval - this._elapsedTime;\r\n  }\r\n\r\n  /**\r\n   * @returns milliseconds elapsed toward the next action\r\n   */\r\n  public get timeElapsedTowardNextAction() {\r\n    return this._elapsedTime;\r\n  }\r\n\r\n  public get isRunning() {\r\n    return this._running;\r\n  }\r\n\r\n  /**\r\n   * Pauses the timer, time will no longer increment towards the next call\r\n   */\r\n  public pause(): Timer {\r\n    this._running = false;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Resumes the timer, time will now increment towards the next call.\r\n   */\r\n  public resume(): Timer {\r\n    this._running = true;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Starts the timer, if the timer was complete it will restart the timer and reset the elapsed time counter\r\n   */\r\n  public start(): Timer {\r\n    if (!this.scene) {\r\n      this._logger.warn('Cannot start a timer not part of a scene, timer wont start until added');\r\n    }\r\n\r\n    this._running = true;\r\n    if (this.complete) {\r\n      this._complete = false;\r\n      this._elapsedTime = 0;\r\n      this._numberOfTicks = 0;\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Stops the timer and resets the elapsed time counter towards the next action invocation\r\n   */\r\n  public stop(): Timer {\r\n    this._running = false;\r\n    this._elapsedTime = 0;\r\n    this._numberOfTicks = 0;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Cancels the timer, preventing any further executions.\r\n   */\r\n  public cancel() {\r\n    this.pause();\r\n    if (this.scene) {\r\n      this.scene.cancelTimer(this);\r\n    }\r\n  }\r\n}\r\n","import { Component } from '../EntityComponentSystem/Component';\r\nimport { vec, Vector } from '../Math/vector';\r\n\r\nexport class ParallaxComponent extends Component {\r\n  parallaxFactor = vec(1.0, 1.0);\r\n\r\n  constructor(parallaxFactor?: Vector) {\r\n    super();\r\n    this.parallaxFactor = parallaxFactor ?? this.parallaxFactor;\r\n  }\r\n}\r\n","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { DebugConfig } from '../Debug';\r\nimport { Component } from '../EntityComponentSystem/Component';\r\n\r\n/**\r\n * Provide arbitrary drawing for the purposes of debugging your game\r\n *\r\n * Will only show when the Engine is set to debug mode {@apilink Engine.showDebug} or {@apilink Engine.toggleDebug}\r\n *\r\n */\r\nexport class DebugGraphicsComponent extends Component {\r\n  constructor(\r\n    public draw: (ctx: ExcaliburGraphicsContext, debugFlags: DebugConfig) => void,\r\n    public useTransform = true\r\n  ) {\r\n    super();\r\n  }\r\n}\r\n","import { EventEmitter } from '../EventEmitter';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { GlobalCoordinates } from '../Math';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\nimport { RentalPool } from '../Util/RentalPool';\r\n\r\n/**\r\n * Signals that an object has nested pointer events on nested objects that are not an Entity with\r\n * a PointerComponent. For example TileMap Tiles\r\n */\r\nexport interface HasNestedPointerEvents {\r\n  _dispatchPointerEvents(receiver: PointerEventReceiver): void;\r\n  _processPointerToObject(receiver: PointerEventReceiver): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nfunction hasNestedEvents(object: any): object is HasNestedPointerEvents {\r\n  return object && object._dispatchPointerEvents && object._processPointerToObject;\r\n}\r\n\r\nexport class PointerTargetObjectProxy<TObject extends { events: EventEmitter }> {\r\n  public object!: TObject;\r\n  public contains!: (point: GlobalCoordinates) => boolean;\r\n  public active!: () => boolean;\r\n  public get events(): EventEmitter {\r\n    return this.object.events;\r\n  }\r\n  public init(object: TObject, contains: (point: GlobalCoordinates) => boolean, active: () => boolean): void {\r\n    this.object = object;\r\n    this.contains = contains;\r\n    this.active = active;\r\n  }\r\n}\r\n\r\nexport class PointerEventsToObjectDispatcher<TObject extends { events: EventEmitter }> {\r\n  private _proxyPool = new RentalPool(\r\n    () => new PointerTargetObjectProxy<TObject>(),\r\n    (p) => p,\r\n    100\r\n  );\r\n  private _objectToProxy = new Map<TObject, PointerTargetObjectProxy<TObject>>();\r\n  private _proxies: PointerTargetObjectProxy<TObject>[] = [];\r\n\r\n  /**\r\n   * Tracks an object to associate with pointers and their events\r\n   * @param object\r\n   * @param contains\r\n   * @param active\r\n   */\r\n  public addObject(object: TObject, contains: (point: GlobalCoordinates) => boolean, active: () => boolean): void {\r\n    const proxy = this._proxyPool.rent(false);\r\n    proxy.init(object, contains, active);\r\n    this._proxies.push(proxy);\r\n    this._objectToProxy.set(object, proxy);\r\n  }\r\n\r\n  private _getProxy(object: TObject): PointerTargetObjectProxy<TObject> {\r\n    const proxy = this._objectToProxy.get(object);\r\n    if (proxy) {\r\n      return proxy;\r\n    }\r\n    throw new Error('No PointerTargetProxy for object');\r\n  }\r\n\r\n  /**\r\n   * Untracks an object associated with pointers and their events\r\n   * @param object\r\n   */\r\n  public removeObject(object: TObject): void {\r\n    const proxy = this._objectToProxy.get(object);\r\n    if (proxy) {\r\n      const index = this._proxies.indexOf(proxy);\r\n      if (index > -1) {\r\n        this._proxies.splice(index, 1);\r\n      }\r\n      this._proxyPool.return(proxy);\r\n    }\r\n  }\r\n  private _lastFrameObjectToPointers = new Map<PointerTargetObjectProxy<any>, number[]>();\r\n  private _currentFrameObjectToPointers = new Map<PointerTargetObjectProxy<any>, number[]>();\r\n  private _objectCurrentlyUnderPointer(object: PointerTargetObjectProxy<any>, pointerId: number): boolean {\r\n    return !!(this._currentFrameObjectToPointers.has(object) && this._currentFrameObjectToPointers.get(object)!.includes(pointerId));\r\n  }\r\n\r\n  private _objectWasUnderPointer(object: PointerTargetObjectProxy<any>, pointerId: number): boolean {\r\n    return !!(this._lastFrameObjectToPointers.has(object) && this._lastFrameObjectToPointers.get(object)!.includes(pointerId));\r\n  }\r\n\r\n  private _entered(object: PointerTargetObjectProxy<any>, pointerId: number): boolean {\r\n    return this._objectCurrentlyUnderPointer(object, pointerId) && !this._lastFrameObjectToPointers.has(object);\r\n  }\r\n\r\n  private _left(object: PointerTargetObjectProxy<any>, pointerId: number): boolean {\r\n    return !this._currentFrameObjectToPointers.has(object) && this._objectWasUnderPointer(object, pointerId);\r\n  }\r\n\r\n  /**\r\n   * Manually associate a pointer id with an object.\r\n   *\r\n   * This assumes you've checked that the pointer is indeed over the object.\r\n   */\r\n  public addPointerToObject(object: TObject, pointerId: number): void {\r\n    const maybeProxy = this._objectToProxy.get(object);\r\n    if (maybeProxy) {\r\n      this._addPointerToProxy(maybeProxy, pointerId);\r\n    }\r\n  }\r\n\r\n  private _addPointerToProxy(object: PointerTargetObjectProxy<any>, pointerId: number): void {\r\n    if (!this._currentFrameObjectToPointers.has(object)) {\r\n      this._currentFrameObjectToPointers.set(object, [pointerId]);\r\n      return;\r\n    }\r\n    const pointers = this._currentFrameObjectToPointers.get(object)!;\r\n    this._currentFrameObjectToPointers.set(object, pointers.concat(pointerId));\r\n  }\r\n\r\n  /**\r\n   * Dispatches the appropriate pointer events in sortedObject order on tracked objects\r\n   * @param receiver\r\n   * @param sortedObjects\r\n   */\r\n  public dispatchEvents(receiver: PointerEventReceiver, sortedObjects: TObject[]) {\r\n    const lastFrameEntities = new Set(this._lastFrameObjectToPointers.keys());\r\n    const currentFrameEntities = new Set(this._currentFrameObjectToPointers.keys());\r\n    // Filter preserves z order\r\n    let lastMovePerPointer: Map<number, PointerEvent>;\r\n    let lastUpPerPointer: Map<number, PointerEvent>;\r\n    let lastDownPerPointer: Map<number, PointerEvent>;\r\n    // Dispatch events in proxy z order\r\n    for (let i = 0; i < sortedObjects.length; i++) {\r\n      const object = sortedObjects[i];\r\n      const proxy = this._getProxy(object);\r\n      if (hasNestedEvents(object)) {\r\n        object._dispatchPointerEvents(receiver);\r\n      }\r\n      if (lastFrameEntities.has(proxy) || currentFrameEntities.has(proxy)) {\r\n        lastDownPerPointer = this._processDownAndEmit(receiver, proxy);\r\n\r\n        lastUpPerPointer = this._processUpAndEmit(receiver, proxy);\r\n\r\n        lastMovePerPointer = this._processMoveAndEmit(receiver, proxy);\r\n\r\n        const lastUpDownMoveEvents = [...lastMovePerPointer.values(), ...lastDownPerPointer.values(), ...lastUpPerPointer.values()];\r\n        this._processEnterLeaveAndEmit(receiver, proxy, lastUpDownMoveEvents);\r\n\r\n        this._processCancelAndEmit(receiver, proxy);\r\n\r\n        this._processWheelAndEmit(receiver, proxy);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Given the tracked objects, update pointer containment given the provided contains()\r\n   * @param receiver\r\n   * @param objects\r\n   */\r\n  public processPointerToObject(receiver: PointerEventReceiver, objects: TObject[]) {\r\n    // Pre-process find entities under pointers\r\n    for (let objectIndex = 0; objectIndex < objects.length; objectIndex++) {\r\n      const object = objects[objectIndex];\r\n      const proxy = this._getProxy(object);\r\n      if (hasNestedEvents(object)) {\r\n        object._processPointerToObject(receiver);\r\n      }\r\n      for (const [pointerId, pos] of receiver.currentFramePointerCoords.entries()) {\r\n        if (proxy.contains(pos)) {\r\n          this._addPointerToProxy(proxy, pointerId);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear current frames pointer-object associations and track last frame pointer-object associations\r\n   */\r\n  public clear() {\r\n    this._lastFrameObjectToPointers.clear();\r\n    this._lastFrameObjectToPointers = new Map<PointerTargetObjectProxy<any>, number[]>(this._currentFrameObjectToPointers);\r\n    this._currentFrameObjectToPointers.clear();\r\n  }\r\n\r\n  private _processDownAndEmit(receiver: PointerEventReceiver, object: PointerTargetObjectProxy<any>): Map<number, PointerEvent> {\r\n    const lastDownPerPointer = new Map<number, PointerEvent>();\r\n    // Loop through down and dispatch to entities\r\n    for (const event of receiver.currentFrameDown) {\r\n      if (event.active && this._objectCurrentlyUnderPointer(object, event.pointerId)) {\r\n        object.events.emit('pointerdown', event as any);\r\n        if (receiver.isDragStart(event.pointerId)) {\r\n          object.events.emit('pointerdragstart', event as any);\r\n        }\r\n      }\r\n      lastDownPerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastDownPerPointer;\r\n  }\r\n\r\n  private _processUpAndEmit(receiver: PointerEventReceiver, object: PointerTargetObjectProxy<any>): Map<number, PointerEvent> {\r\n    const lastUpPerPointer = new Map<number, PointerEvent>();\r\n    // Loop through up and dispatch to entities\r\n    for (const event of receiver.currentFrameUp) {\r\n      if (event.active && this._objectCurrentlyUnderPointer(object, event.pointerId)) {\r\n        object.events.emit('pointerup', event as any);\r\n        if (receiver.isDragEnd(event.pointerId)) {\r\n          object.events.emit('pointerdragend', event as any);\r\n        }\r\n      }\r\n      lastUpPerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastUpPerPointer;\r\n  }\r\n\r\n  private _processMoveAndEmit(receiver: PointerEventReceiver, object: PointerTargetObjectProxy<any>): Map<number, PointerEvent> {\r\n    const lastMovePerPointer = new Map<number, PointerEvent>();\r\n    // Loop through move and dispatch to entities\r\n    for (const event of receiver.currentFrameMove) {\r\n      if (event.active && object.active() && this._objectCurrentlyUnderPointer(object, event.pointerId)) {\r\n        // move\r\n        object.events.emit('pointermove', event as any);\r\n\r\n        if (receiver.isDragging(event.pointerId)) {\r\n          object.events.emit('pointerdragmove', event as any);\r\n        }\r\n      }\r\n      lastMovePerPointer.set(event.pointerId, event);\r\n    }\r\n    return lastMovePerPointer;\r\n  }\r\n\r\n  private _processEnterLeaveAndEmit(\r\n    receiver: PointerEventReceiver,\r\n    object: PointerTargetObjectProxy<any>,\r\n    lastUpDownMoveEvents: PointerEvent[]\r\n  ) {\r\n    // up, down, and move are considered for enter and leave\r\n    for (const event of lastUpDownMoveEvents) {\r\n      // enter\r\n      if (event.active && object.active() && this._entered(object, event.pointerId)) {\r\n        object.events.emit('pointerenter', event as any);\r\n        if (receiver.isDragging(event.pointerId)) {\r\n          object.events.emit('pointerdragenter', event as any);\r\n        }\r\n        break;\r\n      }\r\n      if (\r\n        event.active &&\r\n        object.active() &&\r\n        // leave can happen on move\r\n        (this._left(object, event.pointerId) ||\r\n          // or leave can happen on pointer up\r\n          (this._objectCurrentlyUnderPointer(object, event.pointerId) && event.type === 'up'))\r\n      ) {\r\n        object.events.emit('pointerleave', event as any);\r\n        if (receiver.isDragging(event.pointerId)) {\r\n          object.events.emit('pointerdragleave', event as any);\r\n        }\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processCancelAndEmit(receiver: PointerEventReceiver, object: PointerTargetObjectProxy<any>) {\r\n    // cancel\r\n    for (const event of receiver.currentFrameCancel) {\r\n      if (event.active && object.active() && this._objectCurrentlyUnderPointer(object, event.pointerId)) {\r\n        object.events.emit('pointercancel', event as any);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _processWheelAndEmit(receiver: PointerEventReceiver, object: PointerTargetObjectProxy<any>) {\r\n    // wheel\r\n    for (const event of receiver.currentFrameWheel) {\r\n      // Currently the wheel only fires under the primary pointer '0'\r\n      if (event.active && object.active() && this._objectCurrentlyUnderPointer(object, 0)) {\r\n        object.events.emit('pointerwheel', event as any);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Engine } from '../Engine';\r\nimport { Vector, vec } from '../Math/vector';\r\nimport { Logger } from '../Util/Log';\r\nimport { Entity, EntityEvents } from '../EntityComponentSystem/Entity';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { CollisionType } from '../Collision/CollisionType';\r\nimport { Shape } from '../Collision/Colliders/Shape';\r\nimport { ExcaliburGraphicsContext, Graphic, GraphicsComponent, hasGraphicsTick, ParallaxComponent } from '../Graphics';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { CompositeCollider } from '../Collision/Colliders/CompositeCollider';\r\nimport { DebugGraphicsComponent } from '../Graphics/DebugGraphicsComponent';\r\nimport { Collider } from '../Collision/Colliders/Collider';\r\nimport { PostDrawEvent, PostUpdateEvent, PreDrawEvent, PreUpdateEvent } from '../Events';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { DebugConfig } from '../Debug';\r\nimport { clamp } from '../Math/util';\r\nimport { PointerComponent } from '../Input/PointerComponent';\r\nimport { PointerEvent } from '../Input/PointerEvent';\r\nimport { PointerEventReceiver } from '../Input/PointerEventReceiver';\r\nimport { HasNestedPointerEvents, PointerEventsToObjectDispatcher } from '../Input/PointerEventsToObjectDispatcher';\r\nimport { GlobalCoordinates } from '../Math';\r\n\r\nexport interface TileMapOptions {\r\n  /**\r\n   * Optionally name the tile map\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally specify the position of the tile map\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Width of an individual tile in pixels\r\n   */\r\n  tileWidth: number;\r\n  /**\r\n   * Height of an individual tile in pixels\r\n   */\r\n  tileHeight: number;\r\n  /**\r\n   * The number of tile columns, or the number of tiles wide\r\n   */\r\n  columns: number;\r\n  /**\r\n   * The number of tile  rows, or the number of tiles high\r\n   */\r\n  rows: number;\r\n\r\n  /**\r\n   * Optionally render from the top of the graphic, by default tiles are rendered from the bottom\r\n   */\r\n  renderFromTopOfGraphic?: boolean;\r\n\r\n  /**\r\n   * Optionally configure the meshing lookbehind for Tilemap, Tilemaps combine solid tiles into optimal\r\n   * geometry and the lookbehind configures how far back the Tilemap to look for geometry when combining. Meshing\r\n   * is an expensive operation, so when the Tilemap geometry is invalidated it must be recalculated.\r\n   *\r\n   * Default is 10 slots, but if your Tilemap does not change positions or solid tiles often you can increase this to\r\n   * Infinity.\r\n   */\r\n  meshingLookBehind?: number;\r\n}\r\n\r\nexport type TilePointerEvents = {\r\n  pointerup: PointerEvent;\r\n  pointerdown: PointerEvent;\r\n  pointermove: PointerEvent;\r\n  pointercancel: PointerEvent;\r\n  pointerenter: PointerEvent;\r\n  pointerleave: PointerEvent;\r\n};\r\n\r\nexport type TileMapEvents = EntityEvents &\r\n  TilePointerEvents & {\r\n    preupdate: PreUpdateEvent<TileMap>;\r\n    postupdate: PostUpdateEvent<TileMap>;\r\n    predraw: PreDrawEvent;\r\n    postdraw: PostDrawEvent;\r\n  };\r\n\r\nexport const TileMapEvents = {\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw',\r\n  PointerUp: 'pointerup',\r\n  PointerDown: 'pointerdown',\r\n  PointerMove: 'pointermove',\r\n  PointerCancel: 'pointercancel'\r\n};\r\n\r\n/**\r\n * The TileMap provides a mechanism for doing flat 2D tiles rendered in a grid.\r\n *\r\n * TileMaps are useful for top down or side scrolling grid oriented games.\r\n */\r\nexport class TileMap extends Entity implements HasNestedPointerEvents {\r\n  public events = new EventEmitter<TileMapEvents>();\r\n  private _token = 0;\r\n  private _engine!: Engine;\r\n\r\n  public logger: Logger = Logger.getInstance();\r\n  public readonly tiles: Tile[] = [];\r\n  private _rows: Tile[][] = [];\r\n  private _cols: Tile[][] = [];\r\n\r\n  public readonly tileWidth: number;\r\n  public readonly tileHeight: number;\r\n  public readonly rows: number;\r\n  public readonly columns: number;\r\n\r\n  public renderFromTopOfGraphic = false;\r\n  public meshingLookBehind = 10;\r\n\r\n  private _collidersDirty = true;\r\n  private _pointerEventDispatcher: PointerEventsToObjectDispatcher<Tile>;\r\n  public flagCollidersDirty() {\r\n    this._collidersDirty = true;\r\n  }\r\n\r\n  public flagTilesDirty() {\r\n    for (let i = 0; i < this.tiles.length; i++) {\r\n      if (this.tiles[i]) {\r\n        this.tiles[i].flagDirty();\r\n      }\r\n    }\r\n  }\r\n\r\n  public pointer: PointerComponent;\r\n  public transform: TransformComponent;\r\n  private _motion: MotionComponent;\r\n  private _graphics: GraphicsComponent;\r\n  public collider: ColliderComponent;\r\n  private _composite: CompositeCollider;\r\n\r\n  public get x(): number {\r\n    return this.transform.pos.x ?? 0;\r\n  }\r\n\r\n  public set x(val: number) {\r\n    if (this.transform?.pos) {\r\n      this.get(TransformComponent).pos = vec(val, this.y);\r\n    }\r\n  }\r\n\r\n  public get y(): number {\r\n    return this.transform?.pos.y ?? 0;\r\n  }\r\n\r\n  public set y(val: number) {\r\n    if (this.transform?.pos) {\r\n      this.transform.pos = vec(this.x, val);\r\n    }\r\n  }\r\n\r\n  public get z(): number {\r\n    return this.transform.z ?? 0;\r\n  }\r\n\r\n  public set z(val: number) {\r\n    if (this.transform) {\r\n      this.transform.z = val;\r\n    }\r\n  }\r\n\r\n  private _oldRotation: number = 0;\r\n  public get rotation(): number {\r\n    return this.transform?.rotation ?? 0;\r\n  }\r\n\r\n  public set rotation(val: number) {\r\n    if (this.transform) {\r\n      this.transform.rotation = val;\r\n    }\r\n  }\r\n\r\n  private _oldScale: Vector;\r\n  public get scale(): Vector {\r\n    return this.transform?.scale ?? Vector.One;\r\n  }\r\n\r\n  public set scale(val: Vector) {\r\n    if (this.transform?.scale) {\r\n      this.transform.scale = val;\r\n    }\r\n  }\r\n\r\n  private _oldPos: Vector;\r\n  public get pos(): Vector {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  public set pos(val: Vector) {\r\n    this.transform.pos = val;\r\n  }\r\n\r\n  public get vel(): Vector {\r\n    return this._motion.vel;\r\n  }\r\n\r\n  public set vel(val: Vector) {\r\n    this._motion.vel = val;\r\n  }\r\n\r\n  /**\r\n   * Width of the whole tile map in pixels\r\n   */\r\n  public get width(): number {\r\n    return this.tileWidth * this.columns * this.scale.x;\r\n  }\r\n\r\n  /**\r\n   * Height of the whole tilemap in pixels\r\n   */\r\n  public get height(): number {\r\n    return this.tileHeight * this.rows * this.scale.y;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, event: TileMapEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, handler: Handler<TileMapEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, handler: Handler<TileMapEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<TileMapEvents>>(eventName: TEventName, handler: Handler<TileMapEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<TileMapEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler as any);\r\n  }\r\n\r\n  /**\r\n   * @param options\r\n   */\r\n  constructor(options: TileMapOptions) {\r\n    super([], options.name);\r\n    this.meshingLookBehind = options.meshingLookBehind ?? this.meshingLookBehind;\r\n    this.addComponent(new TransformComponent());\r\n    this.addComponent(new MotionComponent());\r\n    this.addComponent(\r\n      new BodyComponent({\r\n        type: CollisionType.Fixed\r\n      })\r\n    );\r\n    this.addComponent(\r\n      new GraphicsComponent({\r\n        onPostDraw: (ctx, elapsed) => this.draw(ctx, elapsed)\r\n      })\r\n    );\r\n    this.addComponent(new DebugGraphicsComponent((ctx, debugFlags) => this.debug(ctx, debugFlags), false));\r\n    this.addComponent(new ColliderComponent());\r\n    this.addComponent(new PointerComponent());\r\n    this.pointer = this.get(PointerComponent);\r\n    this._graphics = this.get(GraphicsComponent);\r\n    this.transform = this.get(TransformComponent);\r\n    this._motion = this.get(MotionComponent);\r\n    this.collider = this.get(ColliderComponent);\r\n    this._composite = this.collider.useCompositeCollider([]);\r\n\r\n    this.transform.pos = options.pos ?? Vector.Zero;\r\n    this._oldPos = this.transform.pos.clone();\r\n    this._oldScale = this.transform.scale.clone();\r\n    this.renderFromTopOfGraphic = options.renderFromTopOfGraphic ?? this.renderFromTopOfGraphic;\r\n    this.tileWidth = options.tileWidth;\r\n    this.tileHeight = options.tileHeight;\r\n    this.rows = options.rows;\r\n    this.columns = options.columns;\r\n\r\n    this._pointerEventDispatcher = new PointerEventsToObjectDispatcher();\r\n\r\n    this.tiles = new Array<Tile>(this.rows * this.columns);\r\n    this._rows = new Array(this.rows);\r\n    this._cols = new Array(this.columns);\r\n    let currentCol: Tile[] = [];\r\n    for (let i = 0; i < this.columns; i++) {\r\n      for (let j = 0; j < this.rows; j++) {\r\n        const tile = new Tile({\r\n          x: i,\r\n          y: j,\r\n          map: this\r\n        });\r\n        tile.map = this;\r\n        this.tiles[i + j * this.columns] = tile;\r\n        this._pointerEventDispatcher.addObject(\r\n          tile,\r\n          (vec: GlobalCoordinates) => {\r\n            // TODO handle geometry/graphics\r\n            return tile.bounds.contains(vec.worldPos);\r\n          },\r\n          () => true\r\n        );\r\n        currentCol.push(tile);\r\n        if (!this._rows[j]) {\r\n          this._rows[j] = [];\r\n        }\r\n        this._rows[j].push(tile);\r\n      }\r\n      this._cols[i] = currentCol;\r\n      currentCol = [];\r\n    }\r\n\r\n    this._graphics.localBounds = new BoundingBox({\r\n      left: 0,\r\n      top: 0,\r\n      right: this.columns * this.tileWidth * this.scale.x,\r\n      bottom: this.rows * this.tileHeight * this.scale.y\r\n    });\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n    this._engine = engine;\r\n  }\r\n\r\n  private _originalOffsets = new WeakMap<Collider, Vector>();\r\n  private _getOrSetColliderOriginalOffset(collider: Collider): Vector {\r\n    if (!this._originalOffsets.has(collider)) {\r\n      const originalOffset = collider.offset;\r\n      this._originalOffsets.set(collider, originalOffset);\r\n      return originalOffset;\r\n    } else {\r\n      return this._originalOffsets.get(collider) ?? Vector.Zero;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Tiles colliders based on the solid tiles in the tilemap.\r\n   */\r\n  private _updateColliders(): void {\r\n    this.collider.$colliderRemoved.notifyAll(this._composite);\r\n    this._composite.clearColliders();\r\n    const colliders: BoundingBox[] = [];\r\n    this._composite = this.collider.useCompositeCollider([]);\r\n    let current: BoundingBox | null = null;\r\n\r\n    /**\r\n     * Returns wether or not the 2 boxes share an edge and are the same height\r\n     * @param prev\r\n     * @param next\r\n     * @returns true if they share and edge, false if not\r\n     */\r\n    const shareEdges = (prev: BoundingBox, next: BoundingBox) => {\r\n      if (prev && next) {\r\n        // same top/bottom\r\n        return (\r\n          prev.top === next.top &&\r\n          prev.bottom === next.bottom &&\r\n          // Shared right/left edge\r\n          prev.right === next.left\r\n        );\r\n      }\r\n      return false;\r\n    };\r\n\r\n    /**\r\n     * Potentially merges the current collider into a list of previous ones, mutating the list\r\n     * If checkAndCombine returns true, the collider was successfully merged and should be thrown away\r\n     * @param current current collider to test\r\n     * @param colliders List of colliders to consider merging with\r\n     * @param maxLookBack The amount of colliders to look back for combination\r\n     * @returns false when no combination found, true when successfully combined\r\n     */\r\n    const checkAndCombine = (current: BoundingBox, colliders: BoundingBox[], maxLookBack = this.meshingLookBehind) => {\r\n      if (!current) {\r\n        return false;\r\n      }\r\n      // walk backwards through the list of colliders and combine with the first that shares an edge\r\n      for (let i = colliders.length - 1; i >= 0; i--) {\r\n        if (maxLookBack-- < 0) {\r\n          // blunt the O(n^2) algorithm a bit\r\n          return false;\r\n        }\r\n        const prev = colliders[i];\r\n        if (shareEdges(prev, current)) {\r\n          colliders[i] = prev.combine(current);\r\n          return true;\r\n        }\r\n      }\r\n      return false;\r\n    };\r\n\r\n    // ? configurable bias perhaps, horizontal strips vs. vertical ones\r\n    // Bad tile collider packing algorithm\r\n    for (let i = 0; i < this.columns; i++) {\r\n      // Scan column for colliders\r\n      for (let j = 0; j < this.rows; j++) {\r\n        const tile = this.tiles[i + j * this.columns];\r\n        // Current tile in column is solid build up current collider\r\n        if (tile.solid) {\r\n          // Use custom collider otherwise bounding box\r\n          if (tile.getColliders().length > 0) {\r\n            // tile with custom collider interrupting the current run\r\n            for (const collider of tile.getColliders()) {\r\n              const originalOffset = this._getOrSetColliderOriginalOffset(collider);\r\n              collider.offset = vec(tile.x * this.tileWidth * this.scale.x, tile.y * this.tileHeight * this.scale.y).add(originalOffset);\r\n              collider.owner = this;\r\n              this._composite.addCollider(collider);\r\n            }\r\n            //we push any current collider before nulling the current run\r\n            if (current && !checkAndCombine(current, colliders)) {\r\n              colliders.push(current);\r\n            }\r\n            current = null;\r\n            // Use the bounding box\r\n          } else {\r\n            if (!current) {\r\n              // no current run, start one\r\n              current = tile.defaultGeometry;\r\n            } else {\r\n              // combine with current run\r\n              current = current.combine(tile.defaultGeometry);\r\n            }\r\n          }\r\n        } else {\r\n          // Not solid skip and cut off the current collider\r\n          // End of run check and combine\r\n          if (current && !checkAndCombine(current, colliders)) {\r\n            colliders.push(current);\r\n          }\r\n          current = null;\r\n        }\r\n      }\r\n      // After a column is complete check to see if it can be merged into the last one\r\n      // Eno of run check and combine\r\n      if (current && !checkAndCombine(current, colliders)) {\r\n        // else new collider if no combination\r\n        colliders.push(current);\r\n      }\r\n      current = null;\r\n    }\r\n\r\n    for (const c of colliders) {\r\n      const collider = Shape.Box(c.width, c.height, Vector.Zero, vec(c.left - this.pos.x, c.top - this.pos.y));\r\n      collider.owner = this;\r\n      this._composite.addCollider(collider);\r\n    }\r\n    this.collider.update();\r\n    // Notify that colliders have been updated\r\n    this.collider.$colliderAdded.notifyAll(this._composite);\r\n  }\r\n\r\n  /**\r\n   * Returns the {@apilink Tile} by index (row major order)\r\n   *\r\n   * Returns null if out of bounds\r\n   */\r\n  public getTileByIndex(index: number): Tile | null {\r\n    return this.tiles[index] ?? null;\r\n  }\r\n  /**\r\n   * Returns the {@apilink Tile} by its x and y integer coordinates\r\n   *\r\n   * Returns null if out of bounds\r\n   *\r\n   * For example, if I want the tile in fifth column (x), and second row (y):\r\n   * `getTile(4, 1)` 0 based, so 0 is the first in row/column\r\n   */\r\n  public getTile(x: number, y: number): Tile | null {\r\n    if (x < 0 || y < 0 || x >= this.columns || y >= this.rows) {\r\n      return null;\r\n    }\r\n    return this.tiles[x + y * this.columns];\r\n  }\r\n  /**\r\n   * Returns the {@apilink Tile} by testing a point in world coordinates,\r\n   * returns `null` if no Tile was found.\r\n   */\r\n  public getTileByPoint(point: Vector): Tile | null {\r\n    const { x, y } = this._getTileCoordinates(point);\r\n    const tile = this.getTile(x, y);\r\n    if (x >= 0 && y >= 0 && x < this.columns && y < this.rows && tile) {\r\n      return tile;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  private _getTileCoordinates(point: Vector): { x: number; y: number } {\r\n    // Convert to Tile Space point\r\n    point = this.transform.applyInverse(point);\r\n\r\n    const x = Math.floor(point.x / this.tileWidth);\r\n    const y = Math.floor(point.y / this.tileHeight);\r\n    return { x, y };\r\n  }\r\n\r\n  public getRows(): readonly Tile[][] {\r\n    return this._rows;\r\n  }\r\n\r\n  public getColumns(): readonly Tile[][] {\r\n    return this._cols;\r\n  }\r\n\r\n  /**\r\n   * Returns the on screen tiles for a tilemap, this will overshoot by a small amount because of the internal quad tree data structure.\r\n   *\r\n   * Useful if you need to perform specific logic on onscreen tiles\r\n   */\r\n  public getOnScreenTiles(): readonly Tile[] {\r\n    let worldBounds = this._engine.screen.getWorldBounds();\r\n    const maybeParallax = this.get(ParallaxComponent);\r\n    if (maybeParallax && this.isInitialized) {\r\n      let pos = this.pos;\r\n      const oneMinusFactor = Vector.One.sub(maybeParallax.parallaxFactor);\r\n      const parallaxOffset = this._engine.currentScene.camera.pos.scale(oneMinusFactor);\r\n      pos = pos.sub(parallaxOffset);\r\n      // adjust world bounds by parallax factor\r\n      worldBounds = worldBounds.translate(pos);\r\n    }\r\n\r\n    const bounds = this.transform.coordPlane === CoordPlane.Screen ? this._engine.screen.getScreenBounds() : worldBounds;\r\n    const topLeft = this._getTileCoordinates(bounds.topLeft);\r\n    const topRight = this._getTileCoordinates(bounds.topRight);\r\n    const bottomRight = this._getTileCoordinates(bounds.bottomRight);\r\n    const bottomLeft = this._getTileCoordinates(bounds.bottomLeft);\r\n\r\n    const tileStartX = Math.min(clamp(topLeft.x, 0, this.columns - 1), clamp(topRight.x, 0, this.columns - 1));\r\n    const tileStartY = Math.min(clamp(topLeft.y, 0, this.rows - 1), clamp(topRight.y, 0, this.rows - 1));\r\n    const tileEndX = Math.max(clamp(bottomRight.x, 0, this.columns - 1), clamp(bottomLeft.x, 0, this.columns - 1));\r\n    const tileEndY = Math.max(clamp(bottomRight.y, 0, this.rows - 1), clamp(bottomLeft.y, 0, this.rows - 1));\r\n\r\n    const tiles: Tile[] = [];\r\n    for (let x = tileStartX; x <= tileEndX; x++) {\r\n      for (let y = tileStartY; y <= tileEndY; y++) {\r\n        tiles.push(this.getTile(x, y)!);\r\n      }\r\n    }\r\n    return tiles;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _processPointerToObject(receiver: PointerEventReceiver) {\r\n    this._pointerEventDispatcher.processPointerToObject(receiver, this.tiles);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _dispatchPointerEvents(receiver: PointerEventReceiver) {\r\n    this._pointerEventDispatcher.dispatchEvents(receiver, this.tiles);\r\n  }\r\n\r\n  public update(engine: Engine, elapsed: number) {\r\n    this._initialize(engine);\r\n    this.onPreUpdate(engine, elapsed);\r\n    this.emit('preupdate', new PreUpdateEvent(engine, elapsed, this));\r\n\r\n    // Update colliders\r\n    if (!this._oldPos.equals(this.pos) || this._oldRotation !== this.rotation || !this._oldScale.equals(this.scale)) {\r\n      this.flagCollidersDirty();\r\n      this.flagTilesDirty();\r\n    }\r\n    if (this._collidersDirty) {\r\n      this._collidersDirty = false;\r\n      this._updateColliders();\r\n    }\r\n\r\n    // Clear last frame's events\r\n    this._pointerEventDispatcher.clear();\r\n\r\n    this._token++;\r\n\r\n    this.pos.clone(this._oldPos);\r\n    this._oldRotation = this.rotation;\r\n    this.scale.clone(this._oldScale);\r\n    this.transform.pos = this.pos;\r\n    this.onPostUpdate(engine, elapsed);\r\n    this.emit('postupdate', new PostUpdateEvent(engine, elapsed, this));\r\n  }\r\n\r\n  /**\r\n   * Draws the tile map to the screen. Called by the {@apilink Scene}.\r\n   * @param ctx ExcaliburGraphicsContext\r\n   * @param elapsed  The number of milliseconds since the last draw\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext, elapsed: number): void {\r\n    if (!this.isInitialized) {\r\n      return;\r\n    }\r\n    this.emit('predraw', new PreDrawEvent(ctx as any, elapsed, this)); // TODO fix event\r\n\r\n    let graphics: readonly Graphic[], graphicsIndex: number, graphicsLen: number;\r\n\r\n    const tiles = this.getOnScreenTiles();\r\n    for (let i = 0; i < tiles.length; i++) {\r\n      const tile = tiles[i];\r\n      // get non-negative tile sprites\r\n      const offsets = tile.getGraphicsOffsets();\r\n      graphics = tile.getGraphics();\r\n\r\n      for (graphicsIndex = 0, graphicsLen = graphics.length; graphicsIndex < graphicsLen; graphicsIndex++) {\r\n        // draw sprite, warning if sprite doesn't exist\r\n        const graphic = graphics[graphicsIndex];\r\n        const offset = offsets[graphicsIndex];\r\n        if (graphic) {\r\n          if (hasGraphicsTick(graphic)) {\r\n            graphic?.tick(elapsed, this._token);\r\n          }\r\n          const offsetY = this.renderFromTopOfGraphic ? 0 : graphic.height - this.tileHeight;\r\n          graphic.draw(ctx, tile.x * this.tileWidth + offset.x, tile.y * this.tileHeight - offsetY + offset.y);\r\n        }\r\n      }\r\n    }\r\n    this.emit('postdraw', new PostDrawEvent(ctx as any, elapsed, this));\r\n  }\r\n\r\n  public debug(gfx: ExcaliburGraphicsContext, debugFlags: DebugConfig) {\r\n    const {\r\n      showAll,\r\n      showGrid,\r\n      gridColor,\r\n      gridWidth,\r\n      showSolidBounds: showColliderBounds,\r\n      solidBoundsColor: colliderBoundsColor,\r\n      showColliderGeometry\r\n    } = debugFlags.tilemap;\r\n    const { geometryColor, geometryLineWidth, geometryPointSize } = debugFlags.collider;\r\n    const width = this.tileWidth * this.columns * this.scale.x;\r\n    const height = this.tileHeight * this.rows * this.scale.y;\r\n    const pos = this.pos;\r\n    if (showGrid || showAll) {\r\n      for (let r = 0; r < this.rows + 1; r++) {\r\n        const yOffset = vec(0, r * this.tileHeight * this.scale.y);\r\n        gfx.drawLine(pos.add(yOffset), pos.add(vec(width, yOffset.y)), gridColor, gridWidth);\r\n      }\r\n\r\n      for (let c = 0; c < this.columns + 1; c++) {\r\n        const xOffset = vec(c * this.tileWidth * this.scale.x, 0);\r\n        gfx.drawLine(pos.add(xOffset), pos.add(vec(xOffset.x, height)), gridColor, gridWidth);\r\n      }\r\n    }\r\n\r\n    if (showAll || showColliderBounds || showColliderGeometry) {\r\n      const colliders = this._composite.getColliders();\r\n      gfx.save();\r\n      gfx.translate(this.pos.x, this.pos.y);\r\n      gfx.scale(this.scale.x, this.scale.y);\r\n      for (const collider of colliders) {\r\n        const bounds = collider.localBounds;\r\n        const pos = collider.worldPos.sub(this.pos);\r\n        if (showColliderBounds) {\r\n          gfx.drawRectangle(pos, bounds.width, bounds.height, colliderBoundsColor);\r\n        }\r\n      }\r\n      gfx.restore();\r\n      if (showColliderGeometry) {\r\n        for (const collider of colliders) {\r\n          collider.debug(gfx, geometryColor, { lineWidth: geometryLineWidth, pointSize: geometryPointSize });\r\n        }\r\n      }\r\n    }\r\n\r\n    if (showAll || showColliderBounds) {\r\n      gfx.save();\r\n      gfx.z = 999;\r\n      if (showColliderBounds) {\r\n        for (let i = 0; i < this.tiles.length; i++) {\r\n          this.tiles[i].bounds.draw(gfx);\r\n        }\r\n      }\r\n      gfx.restore();\r\n    }\r\n  }\r\n}\r\n\r\nexport interface TileOptions {\r\n  /**\r\n   * Integer tile x coordinate\r\n   */\r\n  x: number;\r\n  /**\r\n   * Integer tile y coordinate\r\n   */\r\n  y: number;\r\n  map: TileMap;\r\n  solid?: boolean;\r\n  graphics?: Graphic[];\r\n}\r\n\r\n/**\r\n * TileMap Tile\r\n *\r\n * A light-weight object that occupies a space in a collision map. Generally\r\n * created by a {@apilink TileMap}.\r\n *\r\n * Tiles can draw multiple sprites. Note that the order of drawing is the order\r\n * of the sprites in the array so the last one will be drawn on top. You can\r\n * use transparency to create layers this way.\r\n */\r\nexport class Tile {\r\n  private _bounds!: BoundingBox;\r\n  private _geometry!: BoundingBox;\r\n  private _pos!: Vector;\r\n  private _posDirty = false;\r\n\r\n  public events = new EventEmitter<TilePointerEvents>();\r\n\r\n  /**\r\n   * Return the world position of the top left corner of the tile\r\n   */\r\n  public get pos() {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n      this._posDirty = false;\r\n    }\r\n    return this._pos;\r\n  }\r\n\r\n  /**\r\n   * Integer x coordinate of the tile\r\n   */\r\n  public readonly x: number;\r\n\r\n  /**\r\n   * Integer y coordinate of the tile\r\n   */\r\n  public readonly y: number;\r\n\r\n  private _width: number;\r\n  /**\r\n   * Width of the tile in pixels\r\n   */\r\n  public get width(): number {\r\n    return this._width;\r\n  }\r\n\r\n  private _height: number;\r\n  /**\r\n   * Height of the tile in pixels\r\n   */\r\n  public get height(): number {\r\n    return this._height;\r\n  }\r\n\r\n  /**\r\n   * Reference to the TileMap this tile is associated with\r\n   */\r\n  public map: TileMap;\r\n\r\n  private _solid = false;\r\n  /**\r\n   * Wether this tile should be treated as solid by the tilemap\r\n   */\r\n  public get solid(): boolean {\r\n    return this._solid;\r\n  }\r\n  /**\r\n   * Wether this tile should be treated as solid by the tilemap\r\n   */\r\n  public set solid(val: boolean) {\r\n    this.map?.flagCollidersDirty();\r\n    this._solid = val;\r\n  }\r\n\r\n  private _graphics: Graphic[] = [];\r\n  private _offsets: Vector[] = [];\r\n\r\n  /**\r\n   * Current list of graphics for this tile\r\n   */\r\n  public getGraphics(): readonly Graphic[] {\r\n    return this._graphics;\r\n  }\r\n\r\n  /**\r\n   * Current list of offsets for this tile's graphics\r\n   */\r\n  public getGraphicsOffsets(): readonly Vector[] {\r\n    return this._offsets;\r\n  }\r\n\r\n  /**\r\n   * Add another {@apilink Graphic} to this TileMap tile\r\n   * @param graphic\r\n   */\r\n  public addGraphic(graphic: Graphic, options?: { offset?: Vector }) {\r\n    this._graphics.push(graphic);\r\n    if (options?.offset) {\r\n      this._offsets.push(options.offset);\r\n    } else {\r\n      this._offsets.push(Vector.Zero);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove an instance of a {@apilink Graphic} from this tile\r\n   */\r\n  public removeGraphic(graphic: Graphic) {\r\n    const index = this._graphics.indexOf(graphic);\r\n    if (index > -1) {\r\n      this._graphics.splice(index, 1);\r\n      this._offsets.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all graphics from this tile\r\n   */\r\n  public clearGraphics() {\r\n    this._graphics.length = 0;\r\n    this._offsets.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Current list of colliders for this tile\r\n   */\r\n  private _colliders: Collider[] = [];\r\n\r\n  /**\r\n   * Returns the list of colliders\r\n   */\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Adds a custom collider to the {@apilink Tile} to use instead of it's bounds\r\n   *\r\n   * If no collider is set but {@apilink Tile.solid} is set, the tile bounds are used as a collider.\r\n   *\r\n   * **Note!** the {@apilink Tile.solid} must be set to true for it to act as a \"fixed\" collider\r\n   * @param collider\r\n   */\r\n  public addCollider(collider: Collider) {\r\n    this._colliders.push(collider);\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the {@apilink Tile}\r\n   * @param collider\r\n   */\r\n  public removeCollider(collider: Collider) {\r\n    const index = this._colliders.indexOf(collider);\r\n    if (index > -1) {\r\n      this._colliders.splice(index, 1);\r\n    }\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Clears all colliders from the {@apilink Tile}\r\n   */\r\n  public clearColliders() {\r\n    this._colliders.length = 0;\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Arbitrary data storage per tile, useful for any game specific data\r\n   */\r\n  public data = new Map<string, any>();\r\n\r\n  constructor(options: TileOptions) {\r\n    this.x = options.x;\r\n    this.y = options.y;\r\n    this.map = options.map;\r\n    this._width = options.map.tileWidth * this.map.scale.x;\r\n    this._height = options.map.tileHeight * this.map.scale.y;\r\n    this.solid = options.solid ?? this.solid;\r\n    this._graphics = options.graphics ?? [];\r\n    this._recalculate();\r\n  }\r\n\r\n  public flagDirty() {\r\n    return (this._posDirty = true);\r\n  }\r\n\r\n  private _recalculate() {\r\n    const geometryPos = this.map.pos.add(vec(this.x * this.map.tileWidth, this.y * this.map.tileHeight));\r\n    this._geometry = new BoundingBox(geometryPos.x, geometryPos.y, geometryPos.x + this.map.tileWidth, geometryPos.y + this.map.tileHeight);\r\n\r\n    this._width = this.map.tileWidth * this.map.scale.x;\r\n    this._height = this.map.tileHeight * this.map.scale.y;\r\n\r\n    this._pos = this.map.pos.add(vec(this.x * this._width, this.y * this._height));\r\n    this._bounds = new BoundingBox(this._pos.x, this._pos.y, this._pos.x + this._width, this._pos.y + this._height);\r\n\r\n    if (this.map.rotation) {\r\n      this._bounds = this._bounds.rotate(this.map.rotation, this.map.pos);\r\n    }\r\n    this._posDirty = false;\r\n  }\r\n\r\n  /**\r\n   * Tile bounds in world space\r\n   */\r\n  public get bounds() {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n    }\r\n    return this._bounds;\r\n  }\r\n\r\n  public get defaultGeometry() {\r\n    return this._geometry;\r\n  }\r\n\r\n  /**\r\n   * Tile position in world space\r\n   */\r\n  public get center(): Vector {\r\n    if (this._posDirty) {\r\n      this._recalculate();\r\n    }\r\n    return new Vector(this._pos.x + this._width / 2, this._pos.y + this._height / 2);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<TilePointerEvents>>(eventName: TEventName, event: TilePointerEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<TilePointerEvents>>(\r\n    eventName: TEventName,\r\n    handler: Handler<TilePointerEvents[TEventName]>\r\n  ): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<TilePointerEvents>>(\r\n    eventName: TEventName,\r\n    handler: Handler<TilePointerEvents[TEventName]>\r\n  ): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<TilePointerEvents>>(eventName: TEventName, handler: Handler<TilePointerEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<TilePointerEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    if (handler) {\r\n      this.events.off(eventName, handler);\r\n    } else {\r\n      this.events.off(eventName);\r\n    }\r\n  }\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Screen } from './Screen';\r\nimport { EasingFunction, EasingFunctions } from './Util/EasingFunctions';\r\nimport { Vector, vec } from './Math/vector';\r\nimport { Actor } from './Actor';\r\nimport { removeItemFromArray } from './Util/Util';\r\nimport { CanUpdate, CanInitialize } from './Interfaces/LifecycleEvents';\r\nimport { PreUpdateEvent, PostUpdateEvent, InitializeEvent } from './Events';\r\nimport { BoundingBox } from './Collision/BoundingBox';\r\nimport { Logger } from './Util/Log';\r\nimport { ExcaliburGraphicsContext } from './Graphics/Context/ExcaliburGraphicsContext';\r\nimport { AffineMatrix } from './Math/affine-matrix';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { pixelSnapEpsilon } from './Graphics';\r\nimport { sign } from './Math/util';\r\nimport { WatchVector } from './Math/watch-vector';\r\n\r\n/**\r\n * Interface that describes a custom camera strategy for tracking targets\r\n */\r\nexport interface CameraStrategy<T> {\r\n  /**\r\n   * Target of the camera strategy that will be passed to the action\r\n   */\r\n  target: T;\r\n\r\n  /**\r\n   * Camera strategies perform an action to calculate a new focus returned out of the strategy\r\n   * @param target The target object to apply this camera strategy (if any)\r\n   * @param camera The current camera implementation in excalibur running the game\r\n   * @param engine The current engine running the game\r\n   * @param elapsed The elapsed time in milliseconds since the last frame\r\n   */\r\n  action: (target: T, camera: Camera, engine: Engine, elapsed: number) => Vector;\r\n}\r\n\r\n/**\r\n * Container to house convenience strategy methods\r\n * @internal\r\n */\r\nexport class StrategyContainer {\r\n  constructor(public camera: Camera) {}\r\n\r\n  /**\r\n   * Creates and adds the {@apilink LockCameraToActorStrategy} on the current camera.\r\n   * @param actor The actor to lock the camera to\r\n   */\r\n  public lockToActor(actor: Actor) {\r\n    this.camera.addStrategy(new LockCameraToActorStrategy(actor));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the {@apilink LockCameraToActorAxisStrategy} on the current camera\r\n   * @param actor The actor to lock the camera to\r\n   * @param axis The axis to follow the actor on\r\n   */\r\n  public lockToActorAxis(actor: Actor, axis: Axis) {\r\n    this.camera.addStrategy(new LockCameraToActorAxisStrategy(actor, axis));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the {@apilink ElasticToActorStrategy} on the current camera\r\n   * If cameraElasticity < cameraFriction < 1.0, the behavior will be a dampened spring that will slowly end at the target without bouncing\r\n   * If cameraFriction < cameraElasticity < 1.0, the behavior will be an oscillating spring that will over\r\n   * correct and bounce around the target\r\n   * @param actor Target actor to elastically follow\r\n   * @param cameraElasticity [0 - 1.0] The higher the elasticity the more force that will drive the camera towards the target\r\n   * @param cameraFriction [0 - 1.0] The higher the friction the more that the camera will resist motion towards the target\r\n   */\r\n  public elasticToActor(actor: Actor, cameraElasticity: number, cameraFriction: number) {\r\n    this.camera.addStrategy(new ElasticToActorStrategy(actor, cameraElasticity, cameraFriction));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the {@apilink RadiusAroundActorStrategy} on the current camera\r\n   * @param actor Target actor to follow when it is \"radius\" pixels away\r\n   * @param radius Number of pixels away before the camera will follow\r\n   */\r\n  public radiusAroundActor(actor: Actor, radius: number) {\r\n    this.camera.addStrategy(new RadiusAroundActorStrategy(actor, radius));\r\n  }\r\n\r\n  /**\r\n   * Creates and adds the {@apilink LimitCameraBoundsStrategy} on the current camera\r\n   * @param box The bounding box to limit the camera to.\r\n   */\r\n  public limitCameraBounds(box: BoundingBox) {\r\n    this.camera.addStrategy(new LimitCameraBoundsStrategy(box));\r\n  }\r\n}\r\n\r\n/**\r\n * Camera axis enum\r\n */\r\nexport enum Axis {\r\n  X,\r\n  Y\r\n}\r\n\r\n/**\r\n * Lock a camera to the exact x/y position of an actor.\r\n */\r\nexport class LockCameraToActorStrategy implements CameraStrategy<Actor> {\r\n  constructor(public target: Actor) {}\r\n  public action = (target: Actor, camera: Camera, engine: Engine, elapsed: number) => {\r\n    const center = target.center;\r\n    return center;\r\n  };\r\n}\r\n\r\n/**\r\n * Lock a camera to a specific axis around an actor.\r\n */\r\nexport class LockCameraToActorAxisStrategy implements CameraStrategy<Actor> {\r\n  constructor(\r\n    public target: Actor,\r\n    public axis: Axis\r\n  ) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, elapsed: number) => {\r\n    const center = target.center;\r\n    const currentFocus = cam.getFocus();\r\n    if (this.axis === Axis.X) {\r\n      return new Vector(center.x, currentFocus.y);\r\n    } else {\r\n      return new Vector(currentFocus.x, center.y);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Using [Hook's law](https://en.wikipedia.org/wiki/Hooke's_law), elastically move the camera towards the target actor.\r\n */\r\nexport class ElasticToActorStrategy implements CameraStrategy<Actor> {\r\n  /**\r\n   * If cameraElasticity < cameraFriction < 1.0, the behavior will be a dampened spring that will slowly end at the target without bouncing\r\n   * If cameraFriction < cameraElasticity < 1.0, the behavior will be an oscillating spring that will over\r\n   * correct and bounce around the target\r\n   * @param target Target actor to elastically follow\r\n   * @param cameraElasticity [0 - 1.0] The higher the elasticity the more force that will drive the camera towards the target\r\n   * @param cameraFriction [0 - 1.0] The higher the friction the more that the camera will resist motion towards the target\r\n   */\r\n  constructor(\r\n    public target: Actor,\r\n    public cameraElasticity: number,\r\n    public cameraFriction: number\r\n  ) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, elapsed: number) => {\r\n    const position = target.center;\r\n    let focus = cam.getFocus();\r\n    let cameraVel = cam.vel.clone();\r\n\r\n    // Calculate the stretch vector, using the spring equation\r\n    // F = kX\r\n    // https://en.wikipedia.org/wiki/Hooke's_law\r\n    // Apply to the current camera velocity\r\n    const stretch = position.sub(focus).scale(this.cameraElasticity); // stretch is X\r\n    cameraVel = cameraVel.add(stretch);\r\n\r\n    // Calculate the friction (-1 to apply a force in the opposition of motion)\r\n    // Apply to the current camera velocity\r\n    const friction = cameraVel.scale(-1).scale(this.cameraFriction);\r\n    cameraVel = cameraVel.add(friction);\r\n\r\n    // Update position by velocity deltas\r\n    focus = focus.add(cameraVel);\r\n\r\n    return focus;\r\n  };\r\n}\r\n\r\nexport class RadiusAroundActorStrategy implements CameraStrategy<Actor> {\r\n  /**\r\n   *\r\n   * @param target Target actor to follow when it is \"radius\" pixels away\r\n   * @param radius Number of pixels away before the camera will follow\r\n   */\r\n  constructor(\r\n    public target: Actor,\r\n    public radius: number\r\n  ) {}\r\n  public action = (target: Actor, cam: Camera, _eng: Engine, elapsed: number) => {\r\n    const position = target.center;\r\n    const focus = cam.getFocus();\r\n\r\n    const direction = position.sub(focus);\r\n    const distance = direction.magnitude;\r\n    if (distance >= this.radius) {\r\n      const offset = distance - this.radius;\r\n      return focus.add(direction.normalize().scale(offset));\r\n    }\r\n    return focus;\r\n  };\r\n}\r\n\r\n/**\r\n * Prevent a camera from going beyond the given camera dimensions.\r\n */\r\nexport class LimitCameraBoundsStrategy implements CameraStrategy<BoundingBox> {\r\n  /**\r\n   * Useful for limiting the camera to a {@apilink TileMap}'s dimensions, or a specific area inside the map.\r\n   *\r\n   * Note that this strategy does not perform any movement by itself.\r\n   * It only sets the camera position to within the given bounds when the camera has gone beyond them.\r\n   * Thus, it is a good idea to combine it with other camera strategies and set this strategy as the last one.\r\n   *\r\n   * Make sure that the camera bounds are at least as large as the viewport size.\r\n   * @param target The bounding box to limit the camera to\r\n   */\r\n\r\n  boundSizeChecked: boolean = false; // Check and warn only once\r\n\r\n  constructor(public target: BoundingBox) {}\r\n\r\n  public action = (target: BoundingBox, cam: Camera, _eng: Engine, elapsed: number) => {\r\n    const focus = cam.getFocus();\r\n\r\n    if (!this.boundSizeChecked) {\r\n      if (target.bottom - target.top < _eng.drawHeight || target.right - target.left < _eng.drawWidth) {\r\n        Logger.getInstance().warn('Camera bounds should not be smaller than the engine viewport');\r\n      }\r\n      this.boundSizeChecked = true;\r\n    }\r\n\r\n    let focusX = focus.x;\r\n    let focusY = focus.y;\r\n    if (focus.x < target.left + _eng.halfDrawWidth) {\r\n      focusX = target.left + _eng.halfDrawWidth;\r\n    } else if (focus.x > target.right - _eng.halfDrawWidth) {\r\n      focusX = target.right - _eng.halfDrawWidth;\r\n    }\r\n\r\n    if (focus.y < target.top + _eng.halfDrawHeight) {\r\n      focusY = target.top + _eng.halfDrawHeight;\r\n    } else if (focus.y > target.bottom - _eng.halfDrawHeight) {\r\n      focusY = target.bottom - _eng.halfDrawHeight;\r\n    }\r\n\r\n    return vec(focusX, focusY);\r\n  };\r\n}\r\n\r\nexport type CameraEvents = {\r\n  preupdate: PreUpdateEvent<Camera>;\r\n  postupdate: PostUpdateEvent<Camera>;\r\n  initialize: InitializeEvent<Camera>;\r\n};\r\n\r\nexport const CameraEvents = {\r\n  Initialize: 'initialize',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate'\r\n};\r\n\r\n/**\r\n * Cameras\r\n *\r\n * {@apilink Camera} is the base class for all Excalibur cameras. Cameras are used\r\n * to move around your game and set focus. They are used to determine\r\n * what is \"off screen\" and can be used to scale the game.\r\n *\r\n */\r\nexport class Camera implements CanUpdate, CanInitialize {\r\n  public events = new EventEmitter<CameraEvents>();\r\n  public transform: AffineMatrix = AffineMatrix.identity();\r\n  public inverse: AffineMatrix = AffineMatrix.identity();\r\n\r\n  protected _follow: Actor;\r\n\r\n  private _cameraStrategies: CameraStrategy<any>[] = [];\r\n\r\n  public strategy: StrategyContainer = new StrategyContainer(this);\r\n\r\n  /**\r\n   * Get or set current zoom of the camera, defaults to 1\r\n   */\r\n  private _z = 1;\r\n  public get zoom(): number {\r\n    return this._z;\r\n  }\r\n\r\n  public set zoom(val: number) {\r\n    this._z = val;\r\n    if (this._engine) {\r\n      this._halfWidth = this._engine.halfDrawWidth;\r\n      this._halfHeight = this._engine.halfDrawHeight;\r\n    }\r\n  }\r\n  /**\r\n   * Get or set rate of change in zoom, defaults to 0\r\n   */\r\n  public dz: number = 0;\r\n  /**\r\n   * Get or set zoom acceleration\r\n   */\r\n  public az: number = 0;\r\n\r\n  /**\r\n   * Current rotation of the camera\r\n   */\r\n  public rotation: number = 0;\r\n\r\n  private _angularVelocity: number = 0;\r\n\r\n  /**\r\n   * Get or set the camera's angular velocity\r\n   */\r\n  public get angularVelocity(): number {\r\n    return this._angularVelocity;\r\n  }\r\n\r\n  public set angularVelocity(value: number) {\r\n    this._angularVelocity = value;\r\n  }\r\n\r\n  private _posChanged = false;\r\n  private _pos: Vector = new WatchVector(Vector.Zero, () => {\r\n    this._posChanged = true;\r\n  });\r\n  /**\r\n   * Get or set the camera's position\r\n   */\r\n  public get pos(): Vector {\r\n    return this._pos;\r\n  }\r\n  public set pos(vec: Vector) {\r\n    this._posChanged = true;\r\n    this._pos = new WatchVector(vec, () => {\r\n      this._posChanged = true;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Has the position changed since the last update\r\n   */\r\n  public hasChanged(): boolean {\r\n    return this._posChanged;\r\n  }\r\n  /**\r\n   * Interpolated camera position if more draws are running than updates\r\n   *\r\n   * Enabled when `Engine.fixedUpdateFps` is enabled, in all other cases this will be the same as pos\r\n   */\r\n  public drawPos: Vector = this.pos.clone();\r\n\r\n  private _oldPos = this.pos.clone();\r\n\r\n  /**\r\n   * Get or set the camera's velocity\r\n   */\r\n  public vel: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * Get or set the camera's acceleration\r\n   */\r\n  public acc: Vector = Vector.Zero;\r\n\r\n  private _cameraMoving: boolean = false;\r\n  private _currentLerpTime: number = 0;\r\n  private _lerpDuration: number = 1000; // 1 second\r\n  private _lerpStart: Vector = null;\r\n  private _lerpEnd: Vector = null;\r\n  private _lerpResolve: (value: Vector) => void;\r\n  private _lerpPromise: Promise<Vector>;\r\n\r\n  //camera effects\r\n  protected _isShaking: boolean = false;\r\n  private _shakeMagnitudeX: number = 0;\r\n  private _shakeMagnitudeY: number = 0;\r\n  private _shakeDuration: number = 0;\r\n  private _elapsedShakeTime: number = 0;\r\n  private _xShake: number = 0;\r\n  private _yShake: number = 0;\r\n\r\n  protected _isZooming: boolean = false;\r\n  private _zoomStart: number = 1;\r\n  private _zoomEnd: number = 1;\r\n  private _currentZoomTime: number = 0;\r\n  private _zoomDuration: number = 0;\r\n\r\n  private _zoomResolve: (val: boolean) => void;\r\n  private _zoomPromise: Promise<boolean>;\r\n  private _zoomEasing: EasingFunction = EasingFunctions.EaseInOutCubic;\r\n  private _easing: EasingFunction = EasingFunctions.EaseInOutCubic;\r\n\r\n  private _halfWidth: number = 0;\r\n  private _halfHeight: number = 0;\r\n\r\n  /**\r\n   * Get the camera's x position\r\n   */\r\n  public get x() {\r\n    return this.pos.x;\r\n  }\r\n\r\n  /**\r\n   * Set the camera's x position (cannot be set when following an {@apilink Actor} or when moving)\r\n   */\r\n  public set x(value: number) {\r\n    if (!this._follow && !this._cameraMoving) {\r\n      this.pos = vec(value, this.pos.y);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the camera's y position\r\n   */\r\n  public get y() {\r\n    return this.pos.y;\r\n  }\r\n\r\n  /**\r\n   * Set the camera's y position (cannot be set when following an {@apilink Actor} or when moving)\r\n   */\r\n  public set y(value: number) {\r\n    if (!this._follow && !this._cameraMoving) {\r\n      this.pos = vec(this.pos.x, value);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's x velocity\r\n   */\r\n  public get dx() {\r\n    return this.vel.x;\r\n  }\r\n\r\n  public set dx(value: number) {\r\n    this.vel = vec(value, this.vel.y);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's y velocity\r\n   */\r\n  public get dy() {\r\n    return this.vel.y;\r\n  }\r\n\r\n  public set dy(value: number) {\r\n    this.vel = vec(this.vel.x, value);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's x acceleration\r\n   */\r\n  public get ax() {\r\n    return this.acc.x;\r\n  }\r\n\r\n  public set ax(value: number) {\r\n    this.acc = vec(value, this.acc.y);\r\n  }\r\n\r\n  /**\r\n   * Get or set the camera's y acceleration\r\n   */\r\n  public get ay() {\r\n    return this.acc.y;\r\n  }\r\n\r\n  public set ay(value: number) {\r\n    this.acc = vec(this.acc.x, value);\r\n  }\r\n\r\n  /**\r\n   * Returns the focal point of the camera, a new point giving the x and y position of the camera\r\n   */\r\n  public getFocus() {\r\n    return this.pos;\r\n  }\r\n\r\n  /**\r\n   * This moves the camera focal point to the specified position using specified easing function. Cannot move when following an Actor.\r\n   * @param pos The target position to move to\r\n   * @param duration The duration in milliseconds the move should last\r\n   * @param [easingFn] An optional easing function ({@apilink EasingFunctions.EaseInOutCubic} by default)\r\n   * @returns A {@apilink Promise} that resolves when movement is finished, including if it's interrupted.\r\n   *          The {@apilink Promise} value is the {@apilink Vector} of the target position. It will be rejected if a move cannot be made.\r\n   */\r\n  public move(pos: Vector, duration: number, easingFn: EasingFunction = EasingFunctions.EaseInOutCubic): Promise<Vector> {\r\n    if (typeof easingFn !== 'function') {\r\n      throw 'Please specify an EasingFunction';\r\n    }\r\n\r\n    // cannot move when following an actor\r\n    if (this._follow) {\r\n      return Promise.reject(pos);\r\n    }\r\n\r\n    // resolve existing promise, if any\r\n    if (this._lerpPromise && this._lerpResolve) {\r\n      this._lerpResolve(pos);\r\n    }\r\n\r\n    this._lerpPromise = new Promise<Vector>((resolve) => {\r\n      this._lerpResolve = resolve;\r\n    });\r\n    this._lerpStart = this.getFocus().clone();\r\n    this._lerpDuration = duration;\r\n    this._lerpEnd = pos;\r\n    this._currentLerpTime = 0;\r\n    this._cameraMoving = true;\r\n    this._easing = easingFn;\r\n\r\n    return this._lerpPromise;\r\n  }\r\n\r\n  /**\r\n   * Sets the camera to shake at the specified magnitudes for the specified duration\r\n   * @param magnitudeX  The x magnitude of the shake\r\n   * @param magnitudeY  The y magnitude of the shake\r\n   * @param duration    The duration of the shake in milliseconds\r\n   */\r\n  public shake(magnitudeX: number, magnitudeY: number, duration: number) {\r\n    this._isShaking = true;\r\n    this._shakeMagnitudeX = magnitudeX;\r\n    this._shakeMagnitudeY = magnitudeY;\r\n    this._shakeDuration = duration;\r\n  }\r\n\r\n  /**\r\n   * Zooms the camera in or out by the specified scale over the specified duration.\r\n   * If no duration is specified, it take effect immediately.\r\n   * @param scale    The scale of the zoom\r\n   * @param duration The duration of the zoom in milliseconds\r\n   */\r\n  public zoomOverTime(scale: number, duration: number = 0, easingFn: EasingFunction = EasingFunctions.EaseInOutCubic): Promise<boolean> {\r\n    this._zoomPromise = new Promise<boolean>((resolve) => {\r\n      this._zoomResolve = resolve;\r\n    });\r\n\r\n    if (duration) {\r\n      this._isZooming = true;\r\n      this._zoomEasing = easingFn;\r\n      this._currentZoomTime = 0;\r\n      this._zoomDuration = duration;\r\n      this._zoomStart = this.zoom;\r\n      this._zoomEnd = scale;\r\n    } else {\r\n      this._isZooming = false;\r\n      this.zoom = scale;\r\n      return Promise.resolve(true);\r\n    }\r\n\r\n    return this._zoomPromise;\r\n  }\r\n\r\n  private _viewport: BoundingBox = null;\r\n  /**\r\n   * Gets the bounding box of the viewport of this camera in world coordinates\r\n   */\r\n  public get viewport(): BoundingBox {\r\n    if (this._viewport) {\r\n      return this._viewport;\r\n    }\r\n\r\n    return new BoundingBox(0, 0, 0, 0);\r\n  }\r\n\r\n  /**\r\n   * Adds a new camera strategy to this camera\r\n   * @param cameraStrategy Instance of an {@apilink CameraStrategy}\r\n   */\r\n  public addStrategy<T>(cameraStrategy: CameraStrategy<T>) {\r\n    this._cameraStrategies.push(cameraStrategy);\r\n  }\r\n\r\n  /**\r\n   * Removes a camera strategy by reference\r\n   * @param cameraStrategy Instance of an {@apilink CameraStrategy}\r\n   */\r\n  public removeStrategy<T>(cameraStrategy: CameraStrategy<T>) {\r\n    removeItemFromArray(cameraStrategy, this._cameraStrategies);\r\n  }\r\n\r\n  /**\r\n   * Clears all camera strategies from the camera\r\n   */\r\n  public clearAllStrategies() {\r\n    this._cameraStrategies.length = 0;\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPreUpdate} lifecycle event\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, elapsed: number): void {\r\n    this.events.emit('preupdate', new PreUpdateEvent(engine, elapsed, this));\r\n    this.onPreUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before a scene is updated.\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public onPreUpdate(engine: Engine, elapsed: number): void {\r\n    // Overridable\r\n  }\r\n\r\n  /**\r\n   *  It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPostUpdate} lifecycle event\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, elapsed: number): void {\r\n    this.events.emit('postupdate', new PostUpdateEvent(engine, elapsed, this));\r\n    this.onPostUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public onPostUpdate(engine: Engine, elapsed: number): void {\r\n    // Overridable\r\n  }\r\n\r\n  private _engine: Engine;\r\n  private _screen: Screen;\r\n  private _isInitialized = false;\r\n  public get isInitialized() {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      this._engine = engine;\r\n      this._screen = engine.screen;\r\n\r\n      const currentRes = this._screen.contentArea;\r\n      let center = vec(currentRes.width / 2, currentRes.height / 2);\r\n      if (!this._engine.loadingComplete) {\r\n        // If there was a loading screen, we peek the configured resolution\r\n        const res = this._screen.peekResolution();\r\n        if (res) {\r\n          center = vec(res.width / 2, res.height / 2);\r\n        }\r\n      }\r\n      this._halfWidth = center.x;\r\n      this._halfHeight = center.y;\r\n\r\n      // If the user has not set the camera pos, apply default center screen position\r\n      if (!this._posChanged) {\r\n        this.pos = center;\r\n      }\r\n      this.pos.clone(this.drawPos);\r\n      // First frame bootstrap\r\n\r\n      // Ensure camera tx is correct\r\n      // Run update twice to ensure properties are init'd\r\n      this.updateTransform(this.pos);\r\n\r\n      // Run strategies for first frame\r\n      this.runStrategies(engine, engine.clock.elapsed());\r\n\r\n      // Setup the first frame viewport\r\n      this.updateViewport();\r\n\r\n      // It's important to update the camera after strategies\r\n      // This prevents jitter\r\n      this.updateTransform(this.pos);\r\n      this.pos.clone(this._oldPos);\r\n\r\n      this.onInitialize(engine);\r\n      this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   */\r\n  public onInitialize(engine: Engine) {\r\n    // Overridable\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, event: CameraEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, handler: Handler<CameraEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, handler: Handler<CameraEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<CameraEvents>>(eventName: TEventName, handler: Handler<CameraEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<CameraEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  public runStrategies(engine: Engine, elapsed: number) {\r\n    for (const s of this._cameraStrategies) {\r\n      this.pos = s.action.call(s, s.target, this, engine, elapsed);\r\n    }\r\n  }\r\n\r\n  public updateViewport() {\r\n    // recalculate viewport\r\n    this._viewport = new BoundingBox(\r\n      this.x - this._halfWidth,\r\n      this.y - this._halfHeight,\r\n      this.x + this._halfWidth,\r\n      this.y + this._halfHeight\r\n    );\r\n  }\r\n\r\n  public update(engine: Engine, elapsed: number) {\r\n    this._initialize(engine);\r\n    this._preupdate(engine, elapsed);\r\n    this.pos.clone(this._oldPos);\r\n\r\n    // Update placements based on linear algebra\r\n    this.pos = this.pos.add(this.vel.scale(elapsed / 1000));\r\n    this.zoom += (this.dz * elapsed) / 1000;\r\n\r\n    this.vel = this.vel.add(this.acc.scale(elapsed / 1000));\r\n    this.dz += (this.az * elapsed) / 1000;\r\n\r\n    this.rotation += (this.angularVelocity * elapsed) / 1000;\r\n\r\n    if (this._isZooming) {\r\n      if (this._currentZoomTime < this._zoomDuration) {\r\n        const zoomEasing = this._zoomEasing;\r\n        const newZoom = zoomEasing(this._currentZoomTime, this._zoomStart, this._zoomEnd, this._zoomDuration);\r\n\r\n        this.zoom = newZoom;\r\n        this._currentZoomTime += elapsed;\r\n      } else {\r\n        this._isZooming = false;\r\n        this.zoom = this._zoomEnd;\r\n        this._currentZoomTime = 0;\r\n        this._zoomResolve(true);\r\n      }\r\n    }\r\n\r\n    if (this._cameraMoving) {\r\n      if (this._currentLerpTime < this._lerpDuration) {\r\n        const moveEasing = EasingFunctions.CreateVectorEasingFunction(this._easing);\r\n\r\n        const lerpPoint = moveEasing(this._currentLerpTime, this._lerpStart, this._lerpEnd, this._lerpDuration);\r\n\r\n        this.pos = lerpPoint;\r\n\r\n        this._currentLerpTime += elapsed;\r\n      } else {\r\n        this.pos = this._lerpEnd;\r\n        const end = this._lerpEnd.clone();\r\n\r\n        this._lerpStart = null;\r\n        this._lerpEnd = null;\r\n        this._currentLerpTime = 0;\r\n        this._cameraMoving = false;\r\n        // Order matters here, resolve should be last so any chain promises have a clean slate\r\n        this._lerpResolve(end);\r\n      }\r\n    }\r\n\r\n    if (this._isDoneShaking()) {\r\n      this._isShaking = false;\r\n      this._elapsedShakeTime = 0;\r\n      this._shakeMagnitudeX = 0;\r\n      this._shakeMagnitudeY = 0;\r\n      this._shakeDuration = 0;\r\n      this._xShake = 0;\r\n      this._yShake = 0;\r\n    } else {\r\n      this._elapsedShakeTime += elapsed;\r\n      this._xShake = ((Math.random() * this._shakeMagnitudeX) | 0) + 1;\r\n      this._yShake = ((Math.random() * this._shakeMagnitudeY) | 0) + 1;\r\n    }\r\n\r\n    this.runStrategies(engine, elapsed);\r\n\r\n    this.updateViewport();\r\n\r\n    // It's important to update the camera after strategies\r\n    // This prevents jitter\r\n    this.updateTransform(this.pos);\r\n    this._postupdate(engine, elapsed);\r\n    this._posChanged = false;\r\n  }\r\n\r\n  private _snapPos = vec(0, 0);\r\n  /**\r\n   * Applies the relevant transformations to the game canvas to \"move\" or apply effects to the Camera\r\n   * @param ctx Canvas context to apply transformations\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext): void {\r\n    // default to the current position\r\n    this.pos.clone(this.drawPos);\r\n\r\n    // interpolation if fixed update is on\r\n    // must happen on the draw, because more draws are potentially happening than updates\r\n    if (this._engine.fixedUpdateTimestep) {\r\n      const blend = this._engine.currentFrameLagMs / this._engine.fixedUpdateTimestep;\r\n      const interpolatedPos = this.pos.scale(blend).add(this._oldPos.scale(1.0 - blend));\r\n      interpolatedPos.clone(this.drawPos);\r\n      this.updateTransform(interpolatedPos);\r\n    }\r\n    // Snap camera to pixel\r\n    if (ctx.snapToPixel) {\r\n      const snapPos = this.drawPos.clone(this._snapPos);\r\n      snapPos.x = ~~(snapPos.x + pixelSnapEpsilon * sign(snapPos.x));\r\n      snapPos.y = ~~(snapPos.y + pixelSnapEpsilon * sign(snapPos.y));\r\n      snapPos.clone(this.drawPos);\r\n      this.updateTransform(snapPos);\r\n    }\r\n    ctx.multiply(this.transform);\r\n  }\r\n\r\n  public updateTransform(pos: Vector) {\r\n    // center the camera\r\n    const newCanvasWidth = this._screen.resolution.width / this.zoom;\r\n    const newCanvasHeight = this._screen.resolution.height / this.zoom;\r\n    const cameraPos = vec(-pos.x + newCanvasWidth / 2 + this._xShake, -pos.y + newCanvasHeight / 2 + this._yShake);\r\n\r\n    // Calculate camera transform\r\n    this.transform.reset();\r\n\r\n    this.transform.scale(this.zoom, this.zoom);\r\n\r\n    // rotate about the focus\r\n    this.transform.translate(newCanvasWidth / 2, newCanvasHeight / 2);\r\n    this.transform.rotate(this.rotation);\r\n    this.transform.translate(-newCanvasWidth / 2, -newCanvasHeight / 2);\r\n\r\n    this.transform.translate(cameraPos.x, cameraPos.y);\r\n    this.transform.inverse(this.inverse);\r\n  }\r\n\r\n  private _isDoneShaking(): boolean {\r\n    return !this._isShaking || this._elapsedShakeTime >= this._shakeDuration;\r\n  }\r\n}\r\n","import { Vector } from './Math/vector';\r\nimport { ExitTriggerEvent, EnterTriggerEvent, CollisionEndEvent, CollisionStartEvent } from './Events';\r\nimport { CollisionType } from './Collision/CollisionType';\r\nimport { Entity } from './EntityComponentSystem';\r\nimport { Actor, ActorArgs, ActorEvents } from './Actor';\r\nimport { EventEmitter } from './EventEmitter';\r\n\r\nexport type TriggerEvents = ActorEvents & {\r\n  exit: ExitTriggerEvent;\r\n  enter: EnterTriggerEvent;\r\n};\r\n\r\nexport const TriggerEvents = {\r\n  ExitTrigger: 'exit',\r\n  EnterTrigger: 'enter'\r\n};\r\n\r\n/**\r\n * TriggerOptions\r\n */\r\nexport interface TriggerOptions {\r\n  // position of the trigger\r\n  pos: Vector;\r\n  // width of the trigger\r\n  width: number;\r\n  // height of the trigger\r\n  height: number;\r\n  // whether the trigger is visible or not\r\n  visible: boolean;\r\n  // action to take when triggered\r\n  action: (entity: Entity) => void;\r\n  // if specified the trigger will only fire on a specific entity and overrides any filter\r\n  target: Entity;\r\n  // Returns true if the triggers should fire on the collided entity\r\n  filter: (entity: Entity) => boolean;\r\n  // -1 if it should repeat forever\r\n  repeat: number;\r\n}\r\n\r\n/**\r\n * Triggers are a method of firing arbitrary code on collision. These are useful\r\n * as 'buttons', 'switches', or to trigger effects in a game. By default triggers\r\n * are invisible, and can only be seen when {@apilink Trigger.visible} is set to `true`.\r\n */\r\nexport class Trigger extends Actor {\r\n  public events = new EventEmitter<TriggerEvents & ActorEvents>();\r\n  public target?: Entity;\r\n  /**\r\n   * Action to fire when triggered by collision\r\n   */\r\n  public action: (entity: Entity) => void;\r\n  /**\r\n   * Filter to add additional granularity to action dispatch, if a filter is specified the action will only fire when\r\n   * filter return true for the collided entity.\r\n   */\r\n  public filter: (entity: Entity) => boolean;\r\n  /**\r\n   * Number of times to repeat before killing the trigger,\r\n   */\r\n  public repeat: number;\r\n\r\n  /**\r\n   * @param options Trigger options\r\n   */\r\n  constructor(options: Partial<TriggerOptions> & ActorArgs) {\r\n    super({ ...options });\r\n\r\n    this.filter = options.filter ?? (() => true);\r\n    this.repeat = options.repeat ?? -1;\r\n    this.action = options.action ?? (() => undefined);\r\n    this.target = options.target;\r\n\r\n    this.graphics.isVisible = options.visible ?? false;\r\n    this.body.collisionType = CollisionType.Passive;\r\n\r\n    this.events.on('collisionstart', ({ other: collider }: CollisionStartEvent) => {\r\n      if (!this._matchesTarget(collider.owner)) {\r\n        return;\r\n      }\r\n\r\n      this.events.emit('enter', new EnterTriggerEvent(this, collider.owner));\r\n      this._dispatchAction(collider.owner);\r\n      // remove trigger if its done, -1 repeat forever\r\n      if (this.repeat === 0) {\r\n        this.kill();\r\n      }\r\n    });\r\n\r\n    this.events.on('collisionend', ({ other: collider }: CollisionEndEvent) => {\r\n      if (this._matchesTarget(collider.owner)) {\r\n        this.events.emit('exit', new ExitTriggerEvent(this, collider.owner));\r\n      }\r\n    });\r\n  }\r\n\r\n  private _matchesTarget(entity: Entity): boolean {\r\n    return this.filter(entity) && (this.target === undefined || this.target === entity);\r\n  }\r\n\r\n  private _dispatchAction(target: Entity) {\r\n    if (this.repeat !== 0) {\r\n      this.action.call(this, target);\r\n      this.repeat--;\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Higher priorities run earlier than others in the system update\r\n */\r\nexport const SystemPriority = {\r\n  Highest: -Infinity,\r\n  Higher: -5,\r\n  Average: 0,\r\n  Lower: 5,\r\n  Lowest: Infinity\r\n} as const;\r\n","import { Scene } from '../Scene';\r\nimport { SystemPriority } from './Priority';\r\nimport { World } from './World';\r\n\r\n/**\r\n * Enum that determines whether to run the system in the update or draw phase\r\n */\r\nexport enum SystemType {\r\n  Update = 'update',\r\n  Draw = 'draw'\r\n}\r\n\r\n/**\r\n * An Excalibur {@apilink System} that updates entities of certain types.\r\n * Systems are scene specific\r\n *\r\n *\r\n *\r\n * Excalibur Systems currently require at least 1 Component type to operated\r\n *\r\n * Multiple types are declared as a type union\r\n * For example:\r\n *\r\n * ```typescript\r\n * class MySystem extends System {\r\n *   static priority = SystemPriority.Lowest;\r\n *   public readonly systemType = SystemType.Update;\r\n *   public query: Query<typeof TransformComponent>;\r\n *   constructor(public world: World) {\r\n *   super();\r\n *      this.query = this.world.query([TransformComponent]);\r\n *   }\r\n *   public update(elapsed: number) {\r\n *      ...\r\n *   }\r\n * }\r\n * ```\r\n */\r\nexport abstract class System {\r\n  /**\r\n   * Determine whether the system is called in the {@apilink SystemType.Update} or the {@apilink SystemType.Draw} phase. Update is first, then Draw.\r\n   */\r\n  abstract readonly systemType: SystemType;\r\n\r\n  /**\r\n   * System can execute in priority order, by default all systems are priority 0. Lower values indicated higher priority.\r\n   * For a system to execute before all other a lower priority value (-1 for example) must be set.\r\n   * For a system to execute after all other a higher priority value (10 for example) must be set.\r\n   */\r\n  public static priority: number = SystemPriority.Average;\r\n\r\n  /**\r\n   * Optionally specify an initialize handler\r\n   * @param scene\r\n   */\r\n  initialize?(world: World, scene: Scene): void;\r\n\r\n  /**\r\n   * Update all entities that match this system's types\r\n   * @param elapsed Time in milliseconds\r\n   */\r\n  abstract update(elapsed: number): void;\r\n\r\n  /**\r\n   * Optionally run a preupdate before the system processes matching entities\r\n   * @param scene\r\n   * @param elapsed Time in milliseconds since the last frame\r\n   */\r\n  preupdate?(scene: Scene, elapsed: number): void;\r\n\r\n  /**\r\n   * Optionally run a postupdate after the system processes matching entities\r\n   * @param scene\r\n   * @param elapsed Time in milliseconds since the last frame\r\n   */\r\n  postupdate?(scene: Scene, elapsed: number): void;\r\n}\r\n","import { Entity } from './Entity';\r\nimport { World } from './World';\r\nimport { removeItemFromArray } from '../Util/Util';\r\nimport { Scene } from '../Scene';\r\n\r\n// Add/Remove entities and components\r\n\r\nexport class EntityManager {\r\n  public entities: Entity[] = [];\r\n  public _entityIndex: { [entityId: string]: Entity } = {};\r\n  private _childAddedHandlerMap = new Map<Entity, (entity: Entity) => void>();\r\n  private _childRemovedHandlerMap = new Map<Entity, (entity: Entity) => void>();\r\n\r\n  constructor(private _world: World) {}\r\n\r\n  /**\r\n   * Runs the entity lifecycle\r\n   * @param scene\r\n   * @param elapsed\r\n   */\r\n  public updateEntities(scene: Scene, elapsed: number) {\r\n    for (let entityIndex = 0; entityIndex < this.entities.length; entityIndex++) {\r\n      const entity = this.entities[entityIndex];\r\n      entity.update(scene.engine, elapsed);\r\n      if (!entity.isActive) {\r\n        this.removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  public findEntitiesForRemoval() {\r\n    for (let entityIndex = 0; entityIndex < this.entities.length; entityIndex++) {\r\n      const entity = this.entities[entityIndex];\r\n      if (!entity.isActive) {\r\n        this.removeEntity(entity);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _createChildAddedHandler = () => (e: Entity) => {\r\n    this.addEntity(e);\r\n  };\r\n\r\n  private _createChildRemovedHandler = () => (e: Entity) => {\r\n    this.removeEntity(e, false);\r\n  };\r\n\r\n  /**\r\n   * Adds an entity to be tracked by the EntityManager\r\n   * @param entity\r\n   */\r\n  public addEntity(entity: Entity): void {\r\n    entity.isActive = true;\r\n    entity.scene = this._world.scene;\r\n    if (entity && !this._entityIndex[entity.id]) {\r\n      this._entityIndex[entity.id] = entity;\r\n      this.entities.push(entity);\r\n      this._world.queryManager.addEntity(entity);\r\n\r\n      // if entity has children\r\n      entity.children.forEach((c) => {\r\n        c.scene = entity.scene;\r\n        this.addEntity(c);\r\n      });\r\n      const childAdded = this._createChildAddedHandler();\r\n      this._childAddedHandlerMap.set(entity, childAdded);\r\n      const childRemoved = this._createChildRemovedHandler();\r\n      this._childRemovedHandlerMap.set(entity, childRemoved);\r\n      entity.childrenAdded$.subscribe(childAdded);\r\n      entity.childrenRemoved$.subscribe(childRemoved);\r\n    }\r\n  }\r\n\r\n  public removeEntity(entity: Entity, deferred?: boolean): void;\r\n  public removeEntity(id: number, deferred?: boolean): void;\r\n  public removeEntity(idOrEntity: number | Entity, deferred = true): void {\r\n    let id = 0;\r\n    if (idOrEntity instanceof Entity) {\r\n      id = idOrEntity.id;\r\n    } else {\r\n      id = idOrEntity;\r\n    }\r\n    const entity = this._entityIndex[id];\r\n    if (entity && entity.isActive) {\r\n      entity.isActive = false;\r\n    }\r\n\r\n    if (entity && deferred) {\r\n      this._entitiesToRemove.push(entity);\r\n      return;\r\n    }\r\n\r\n    delete this._entityIndex[id];\r\n    if (entity) {\r\n      entity.scene = null;\r\n      removeItemFromArray(entity, this.entities);\r\n      this._world.queryManager.removeEntity(entity);\r\n\r\n      // if entity has children\r\n      entity.children.forEach((c) => {\r\n        c.scene = null;\r\n        this.removeEntity(c, deferred);\r\n      });\r\n      const childAddedHandler = this._childAddedHandlerMap.get(entity);\r\n      if (childAddedHandler) {\r\n        entity.childrenAdded$.unsubscribe(childAddedHandler);\r\n      }\r\n      const childRemovedHandler = this._childRemovedHandlerMap.get(entity);\r\n      if (childRemovedHandler) {\r\n        entity.childrenRemoved$.unsubscribe(childRemovedHandler);\r\n      }\r\n\r\n      // stats\r\n      if (this._world?.scene?.engine) {\r\n        this._world.scene.engine.stats.currFrame.actors.killed++;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _entitiesToRemove: Entity[] = [];\r\n  public processEntityRemovals(): void {\r\n    for (let entityIndex = 0; entityIndex < this._entitiesToRemove.length; entityIndex++) {\r\n      const entity = this._entitiesToRemove[entityIndex];\r\n      if (entity.isActive) {\r\n        continue;\r\n      }\r\n      this.removeEntity(entity, false);\r\n    }\r\n    this._entitiesToRemove.length = 0;\r\n  }\r\n\r\n  public processComponentRemovals(): void {\r\n    for (let entityIndex = 0; entityIndex < this.entities.length; entityIndex++) {\r\n      const entity = this.entities[entityIndex];\r\n      entity.processComponentRemoval();\r\n    }\r\n  }\r\n\r\n  public getById(id: number): Entity | undefined {\r\n    return this._entityIndex[id];\r\n  }\r\n\r\n  public getByName(name: string): Entity[] {\r\n    return this.entities.filter((e) => e.name === name);\r\n  }\r\n\r\n  public clear(): void {\r\n    for (let i = this.entities.length - 1; i >= 0; i--) {\r\n      this.removeEntity(this.entities[i]);\r\n    }\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { Observable } from '../Util/Observable';\r\nimport { Component, ComponentCtor } from '../EntityComponentSystem/Component';\r\n\r\nexport type ComponentInstance<T> = T extends ComponentCtor<infer R> ? R : never;\r\n\r\n/**\r\n * Represents query for entities that match a list of types that is cached and observable\r\n *\r\n * Queries can be strongly typed by supplying a type union in the optional type parameter\r\n * ```typescript\r\n * const queryAB = new ex.Query<ComponentTypeA | ComponentTypeB>(['A', 'B']);\r\n * ```\r\n */\r\nexport class Query<TKnownComponentCtors extends ComponentCtor<Component> = never> {\r\n  public readonly id: string;\r\n  public components = new Set<TKnownComponentCtors>();\r\n  public entities: Entity<ComponentInstance<TKnownComponentCtors>>[] = [];\r\n  /**\r\n   * This fires right after the component is added\r\n   */\r\n  public entityAdded$ = new Observable<Entity<ComponentInstance<TKnownComponentCtors>>>();\r\n  /**\r\n   * This fires right before the component is actually removed from the entity, it will still be available for cleanup purposes\r\n   */\r\n  public entityRemoved$ = new Observable<Entity<ComponentInstance<TKnownComponentCtors>>>();\r\n\r\n  constructor(public readonly requiredComponents: TKnownComponentCtors[]) {\r\n    if (requiredComponents.length === 0) {\r\n      throw new Error('Cannot create query without components');\r\n    }\r\n    for (const type of requiredComponents) {\r\n      this.components.add(type);\r\n    }\r\n\r\n    this.id = Query.createId(requiredComponents);\r\n  }\r\n\r\n  static createId(requiredComponents: Function[]) {\r\n    // TODO what happens if a user defines the same type name as a built in type\r\n    // ! TODO this could be dangerous depending on the bundler's settings for names\r\n    // Maybe some kind of hash function is better here?\r\n    return requiredComponents\r\n      .slice()\r\n      .map((c) => c.name)\r\n      .sort()\r\n      .join('-');\r\n  }\r\n\r\n  /**\r\n   * Potentially adds an entity to a query index, returns true if added, false if not\r\n   * @param entity\r\n   */\r\n  checkAndAdd(entity: Entity) {\r\n    if (!this.entities.includes(entity) && entity.hasAll(Array.from(this.components))) {\r\n      this.entities.push(entity);\r\n      this.entityAdded$.notifyAll(entity);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  removeEntity(entity: Entity) {\r\n    const index = this.entities.indexOf(entity);\r\n    if (index > -1) {\r\n      this.entities.splice(index, 1);\r\n      this.entityRemoved$.notifyAll(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a list of entities that match the query\r\n   * @param sort Optional sorting function to sort entities returned from the query\r\n   */\r\n  public getEntities(sort?: (a: Entity, b: Entity) => number): Entity<ComponentInstance<TKnownComponentCtors>>[] {\r\n    if (sort) {\r\n      this.entities.sort(sort);\r\n    }\r\n    return this.entities;\r\n  }\r\n}\r\n","import { Observable } from '../Util/Observable';\r\nimport { Entity } from './Entity';\r\n\r\nexport class TagQuery<TKnownTags extends string = never> {\r\n  public readonly id: string;\r\n  public tags = new Set<TKnownTags>();\r\n  public entities: Entity<any>[] = [];\r\n  /**\r\n   * This fires right after the component is added\r\n   */\r\n  public entityAdded$ = new Observable<Entity<any>>();\r\n  /**\r\n   * This fires right before the component is actually removed from the entity, it will still be available for cleanup purposes\r\n   */\r\n  public entityRemoved$ = new Observable<Entity<any>>();\r\n\r\n  constructor(public readonly requiredTags: TKnownTags[]) {\r\n    if (requiredTags.length === 0) {\r\n      throw new Error('Cannot create tag query without tags');\r\n    }\r\n    for (const tag of requiredTags) {\r\n      this.tags.add(tag);\r\n    }\r\n\r\n    this.id = TagQuery.createId(requiredTags);\r\n  }\r\n\r\n  static createId(requiredComponents: string[]) {\r\n    return requiredComponents.slice().sort().join('-');\r\n  }\r\n\r\n  checkAndAdd(entity: Entity) {\r\n    if (!this.entities.includes(entity) && entity.hasAllTags(Array.from(this.tags))) {\r\n      this.entities.push(entity);\r\n      this.entityAdded$.notifyAll(entity);\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  removeEntity(entity: Entity) {\r\n    const index = this.entities.indexOf(entity);\r\n    if (index > -1) {\r\n      this.entities.splice(index, 1);\r\n      this.entityRemoved$.notifyAll(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns a list of entities that match the query\r\n   * @param sort Optional sorting function to sort entities returned from the query\r\n   */\r\n  public getEntities(sort?: (a: Entity, b: Entity) => number): Entity<any>[] {\r\n    if (sort) {\r\n      this.entities.sort(sort);\r\n    }\r\n    return this.entities;\r\n  }\r\n}\r\n","import { Entity } from './Entity';\r\nimport { Query } from './Query';\r\nimport { Component, ComponentCtor } from './Component';\r\nimport { World } from './World';\r\nimport { TagQuery } from './TagQuery';\r\n\r\n/**\r\n * The query manager is responsible for updating all queries when entities/components change\r\n */\r\nexport class QueryManager {\r\n  private _queries = new Map<string, Query<any>>();\r\n  private _addComponentHandlers = new Map<Entity, (c: Component) => any>();\r\n  private _removeComponentHandlers = new Map<Entity, (c: Component) => any>();\r\n  private _componentToQueriesIndex = new Map<ComponentCtor<any>, Query<any>[]>();\r\n\r\n  private _tagQueries = new Map<string, TagQuery<any>>();\r\n  private _addTagHandlers = new Map<Entity, (tag: string) => any>();\r\n  private _removeTagHandlers = new Map<Entity, (tag: string) => any>();\r\n  private _tagToQueriesIndex = new Map<string, TagQuery<any>[]>();\r\n\r\n  constructor(private _world: World) {}\r\n\r\n  public createQuery<TKnownComponentCtors extends ComponentCtor<Component>>(\r\n    requiredComponents: TKnownComponentCtors[]\r\n  ): Query<TKnownComponentCtors> {\r\n    const id = Query.createId(requiredComponents);\r\n    if (this._queries.has(id)) {\r\n      // short circuit if query is already created\r\n      return this._queries.get(id) as Query<TKnownComponentCtors>;\r\n    }\r\n\r\n    const query = new Query(requiredComponents);\r\n\r\n    this._queries.set(query.id, query);\r\n\r\n    // index maintenance\r\n    for (const component of requiredComponents) {\r\n      const queries = this._componentToQueriesIndex.get(component);\r\n      if (!queries) {\r\n        this._componentToQueriesIndex.set(component, [query]);\r\n      } else {\r\n        queries.push(query);\r\n      }\r\n    }\r\n\r\n    for (const entity of this._world.entities) {\r\n      this.addEntity(entity);\r\n    }\r\n\r\n    return query;\r\n  }\r\n\r\n  public createTagQuery<TKnownTags extends string>(requiredTags: TKnownTags[]): TagQuery<TKnownTags> {\r\n    const id = TagQuery.createId(requiredTags);\r\n    if (this._tagQueries.has(id)) {\r\n      // short circuit if query is already created\r\n      return this._tagQueries.get(id) as TagQuery<TKnownTags>;\r\n    }\r\n\r\n    const query = new TagQuery(requiredTags);\r\n\r\n    this._tagQueries.set(query.id, query);\r\n\r\n    // index maintenance\r\n    for (const tag of requiredTags) {\r\n      const queries = this._tagToQueriesIndex.get(tag);\r\n      if (!queries) {\r\n        this._tagToQueriesIndex.set(tag, [query]);\r\n      } else {\r\n        queries.push(query);\r\n      }\r\n    }\r\n\r\n    for (const entity of this._world.entities) {\r\n      this.addEntity(entity);\r\n    }\r\n\r\n    return query;\r\n  }\r\n\r\n  private _createAddComponentHandler = (entity: Entity) => (c: Component) => {\r\n    this.addComponent(entity, c);\r\n  };\r\n\r\n  private _createRemoveComponentHandler = (entity: Entity) => (c: Component) => {\r\n    this.removeComponent(entity, c);\r\n  };\r\n\r\n  private _createAddTagHandler = (entity: Entity) => (tag: string) => {\r\n    this.addTag(entity, tag);\r\n  };\r\n\r\n  private _createRemoveTagHandler = (entity: Entity) => (tag: string) => {\r\n    this.removeTag(entity, tag);\r\n  };\r\n\r\n  /**\r\n   * Scans queries and locates any that need this entity added\r\n   * @param entity\r\n   */\r\n  addEntity(entity: Entity) {\r\n    const maybeAddComponent = this._addComponentHandlers.get(entity);\r\n    const maybeRemoveComponent = this._removeComponentHandlers.get(entity);\r\n    const addComponent = maybeAddComponent ?? this._createAddComponentHandler(entity);\r\n    const removeComponent = maybeRemoveComponent ?? this._createRemoveComponentHandler(entity);\r\n    this._addComponentHandlers.set(entity, addComponent);\r\n    this._removeComponentHandlers.set(entity, removeComponent);\r\n\r\n    const maybeAddTag = this._addTagHandlers.get(entity);\r\n    const maybeRemoveTag = this._removeTagHandlers.get(entity);\r\n    const addTag = maybeAddTag ?? this._createAddTagHandler(entity);\r\n    const removeTag = maybeRemoveTag ?? this._createRemoveTagHandler(entity);\r\n    this._addTagHandlers.set(entity, addTag);\r\n    this._removeTagHandlers.set(entity, removeTag);\r\n\r\n    for (const query of this._queries.values()) {\r\n      query.checkAndAdd(entity);\r\n    }\r\n    for (const tagQuery of this._tagQueries.values()) {\r\n      tagQuery.checkAndAdd(entity);\r\n    }\r\n    entity.componentAdded$.subscribe(addComponent);\r\n    entity.componentRemoved$.subscribe(removeComponent);\r\n    entity.tagAdded$.subscribe(addTag);\r\n    entity.tagRemoved$.subscribe(removeTag);\r\n  }\r\n\r\n  /**\r\n   * Scans queries and locates any that need this entity removed\r\n   * @param entity\r\n   */\r\n  removeEntity(entity: Entity) {\r\n    // Handle components\r\n    const addComponent = this._addComponentHandlers.get(entity);\r\n    const removeComponent = this._removeComponentHandlers.get(entity);\r\n    for (const query of this._queries.values()) {\r\n      query.removeEntity(entity);\r\n    }\r\n    if (addComponent) {\r\n      entity.componentAdded$.unsubscribe(addComponent);\r\n    }\r\n    if (removeComponent) {\r\n      entity.componentRemoved$.unsubscribe(removeComponent);\r\n    }\r\n\r\n    // Handle tags\r\n    const addTag = this._addTagHandlers.get(entity);\r\n    const removeTag = this._removeTagHandlers.get(entity);\r\n    for (const tagQuery of this._tagQueries.values()) {\r\n      tagQuery.removeEntity(entity);\r\n    }\r\n\r\n    if (addTag) {\r\n      entity.tagAdded$.unsubscribe(addTag);\r\n    }\r\n    if (removeTag) {\r\n      entity.tagRemoved$.unsubscribe(removeTag);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a component is added to an entity\r\n   * @param entity\r\n   * @param component\r\n   */\r\n  addComponent(entity: Entity, component: Component) {\r\n    const queries = this._componentToQueriesIndex.get(component.constructor as ComponentCtor<any>) ?? [];\r\n    for (const query of queries) {\r\n      query.checkAndAdd(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a component is removed from an entity\r\n   * @param entity\r\n   * @param component\r\n   */\r\n  removeComponent(entity: Entity, component: Component) {\r\n    const queries = this._componentToQueriesIndex.get(component.constructor as ComponentCtor<any>) ?? [];\r\n    for (const query of queries) {\r\n      query.removeEntity(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a tag is added to an entity\r\n   * @param entity\r\n   * @param tag\r\n   */\r\n  addTag(entity: Entity, tag: string) {\r\n    const queries = this._tagToQueriesIndex.get(tag) ?? [];\r\n    for (const query of queries) {\r\n      query.checkAndAdd(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates any queries when a component is removed from an entity\r\n   * @param entity\r\n   * @param tag\r\n   */\r\n  removeTag(entity: Entity, tag: string) {\r\n    const queries = this._tagToQueriesIndex.get(tag) ?? [];\r\n    for (const query of queries) {\r\n      query.removeEntity(entity);\r\n    }\r\n  }\r\n}\r\n","import { System, SystemType } from './System';\r\nimport { Scene } from '../Scene';\r\nimport { World } from './World';\r\nimport { removeItemFromArray } from '../Util/Util';\r\n\r\nexport interface SystemCtor<T extends System> {\r\n  new (...args: any[]): T;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function isSystemConstructor(x: any): x is SystemCtor<System> {\r\n  return !!x?.prototype && !!x?.prototype?.constructor?.name;\r\n}\r\n\r\n/**\r\n * The SystemManager is responsible for keeping track of all systems in a scene.\r\n * Systems are scene specific\r\n */\r\nexport class SystemManager {\r\n  /**\r\n   * List of systems, to add a new system call {@apilink SystemManager.addSystem}\r\n   */\r\n  public systems: System[] = [];\r\n  public initialized = false;\r\n  constructor(private _world: World) {}\r\n\r\n  /**\r\n   * Get a system registered in the manager by type\r\n   * @param systemType\r\n   */\r\n  public get<T extends System>(systemType: SystemCtor<T>): T | null {\r\n    return this.systems.find((s) => s instanceof systemType) as unknown as T;\r\n  }\r\n\r\n  /**\r\n   * Adds a system to the manager, it will now be updated every frame\r\n   * @param systemOrCtor\r\n   */\r\n  public addSystem(systemOrCtor: SystemCtor<System> | System): void {\r\n    let system: System;\r\n    if (systemOrCtor instanceof System) {\r\n      system = systemOrCtor;\r\n    } else {\r\n      system = new systemOrCtor(this._world);\r\n    }\r\n\r\n    this.systems.push(system);\r\n    this.systems.sort((a, b) => (a.constructor as typeof System).priority - (b.constructor as typeof System).priority);\r\n    // If systems are added and the manager has already been init'd\r\n    // then immediately init the system\r\n    if (this.initialized && system.initialize) {\r\n      system.initialize(this._world, this._world.scene);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a system from the manager, it will no longer be updated\r\n   * @param system\r\n   */\r\n  public removeSystem(system: System) {\r\n    removeItemFromArray(system, this.systems);\r\n  }\r\n\r\n  /**\r\n   * Initialize all systems in the manager\r\n   *\r\n   * Systems added after initialize() will be initialized on add\r\n   */\r\n  public initialize() {\r\n    if (!this.initialized) {\r\n      this.initialized = true;\r\n      for (const s of this.systems) {\r\n        if (s.initialize) {\r\n          s.initialize(this._world, this._world.scene);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates all systems\r\n   * @param type whether this is an update or draw system\r\n   * @param scene context reference\r\n   * @param elapsed time in milliseconds\r\n   */\r\n  public updateSystems(type: SystemType, scene: Scene, elapsed: number) {\r\n    const systems = this.systems.filter((s) => s.systemType === type);\r\n    for (const s of systems) {\r\n      if (s.preupdate) {\r\n        s.preupdate(scene, elapsed);\r\n      }\r\n    }\r\n\r\n    for (const s of systems) {\r\n      s.update(elapsed);\r\n    }\r\n\r\n    for (const s of systems) {\r\n      if (s.postupdate) {\r\n        s.postupdate(scene, elapsed);\r\n      }\r\n    }\r\n  }\r\n\r\n  public clear(): void {\r\n    for (let i = this.systems.length - 1; i >= 0; i--) {\r\n      this.removeSystem(this.systems[i]);\r\n    }\r\n  }\r\n}\r\n","import { Scene } from '../Scene';\r\nimport { Logger } from '../Util/Log';\r\nimport { Component, ComponentCtor } from './Component';\r\nimport { Entity } from './Entity';\r\nimport { EntityManager } from './EntityManager';\r\nimport { Query } from './Query';\r\nimport { QueryManager } from './QueryManager';\r\nimport { System, SystemType } from './System';\r\nimport { SystemCtor, SystemManager, isSystemConstructor } from './SystemManager';\r\nimport { TagQuery } from './TagQuery';\r\n\r\n/**\r\n * The World is a self-contained entity component system for a particular context.\r\n */\r\nexport class World {\r\n  private _logger = Logger.getInstance();\r\n  public queryManager: QueryManager = new QueryManager(this);\r\n  public entityManager: EntityManager = new EntityManager(this);\r\n  public systemManager: SystemManager = new SystemManager(this);\r\n\r\n  /**\r\n   * The context type is passed to the system updates\r\n   * @param scene\r\n   */\r\n  constructor(public scene: Scene) {}\r\n\r\n  /**\r\n   * Query the ECS world for entities that match your components\r\n   * @param requiredTypes\r\n   */\r\n  query<TKnownComponentCtors extends ComponentCtor<Component>>(requiredTypes: TKnownComponentCtors[]): Query<TKnownComponentCtors> {\r\n    return this.queryManager.createQuery(requiredTypes);\r\n  }\r\n\r\n  queryTags<TKnownTags extends string>(requiredTags: TKnownTags[]): TagQuery<TKnownTags> {\r\n    return this.queryManager.createTagQuery(requiredTags);\r\n  }\r\n\r\n  /**\r\n   * Update systems by type and time elapsed in milliseconds\r\n   */\r\n  update(type: SystemType, elapsed: number) {\r\n    if (type === SystemType.Update) {\r\n      this.entityManager.updateEntities(this.scene, elapsed);\r\n    }\r\n    this.systemManager.updateSystems(type, this.scene, elapsed);\r\n    this.entityManager.findEntitiesForRemoval();\r\n    this.entityManager.processComponentRemovals();\r\n    this.entityManager.processEntityRemovals();\r\n  }\r\n\r\n  /**\r\n   * Add an entity to the ECS world\r\n   * @param entity\r\n   */\r\n  add(entity: Entity): void;\r\n  /**\r\n   * Add a system to the ECS world\r\n   * @param system\r\n   */\r\n  add(system: System): void;\r\n  add(system: SystemCtor<System>): void;\r\n  add(entityOrSystem: Entity | System | SystemCtor<System>): void {\r\n    if (entityOrSystem instanceof Entity) {\r\n      this.entityManager.addEntity(entityOrSystem);\r\n      return;\r\n    }\r\n\r\n    if (entityOrSystem instanceof System || isSystemConstructor(entityOrSystem)) {\r\n      this.systemManager.addSystem(entityOrSystem);\r\n      return;\r\n    }\r\n\r\n    this._logger.warn(\r\n      `Could not add entity/system ${(entityOrSystem as any).constructor.name} to Excalibur!\\n\\n` +\r\n        `If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.\\n\\n` +\r\n        `Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get a system out of the ECS world\r\n   */\r\n  get(system: SystemCtor<System>) {\r\n    return this.systemManager.get(system);\r\n  }\r\n\r\n  /**\r\n   * Remove an entity from the ECS world\r\n   * @param entity\r\n   */\r\n  remove(entity: Entity, deferred?: boolean): void;\r\n  /**\r\n   * Remove a system from the ECS world\r\n   * @param system\r\n   */\r\n  remove(system: System): void;\r\n  remove(entityOrSystem: Entity | System, deferred = true): void {\r\n    if (entityOrSystem instanceof Entity) {\r\n      this.entityManager.removeEntity(entityOrSystem, deferred);\r\n      return;\r\n    }\r\n\r\n    if (entityOrSystem instanceof System) {\r\n      this.systemManager.removeSystem(entityOrSystem);\r\n      return;\r\n    }\r\n\r\n    this._logger.warn(\r\n      `Could not remove entity/system ${(entityOrSystem as any).constructor.name} to Excalibur!\\n\\n` +\r\n        `If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.\\n\\n` +\r\n        `Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`\r\n    );\r\n  }\r\n\r\n  get entities() {\r\n    return this.entityManager.entities;\r\n  }\r\n\r\n  clearEntities(): void {\r\n    this.entityManager.clear();\r\n  }\r\n\r\n  clearSystems(): void {\r\n    this.systemManager.clear();\r\n  }\r\n}\r\n","import { Entity, Query, SystemPriority, World } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { BodyComponent } from './BodyComponent';\r\nimport { CollisionType } from './CollisionType';\r\nimport { EulerIntegrator } from './Integrator';\r\nimport { PhysicsWorld } from './PhysicsWorld';\r\n\r\nexport class MotionSystem extends System {\r\n  static priority = SystemPriority.Higher;\r\n\r\n  public systemType = SystemType.Update;\r\n  private _physicsConfigDirty = false;\r\n  query: Query<typeof TransformComponent | typeof MotionComponent>;\r\n  constructor(\r\n    public world: World,\r\n    public physics: PhysicsWorld\r\n  ) {\r\n    super();\r\n    physics.$configUpdate.subscribe(() => (this._physicsConfigDirty = true));\r\n    this.query = this.world.query([TransformComponent, MotionComponent]);\r\n  }\r\n\r\n  update(elapsed: number): void {\r\n    let transform: TransformComponent;\r\n    let motion: MotionComponent;\r\n    const entities = this.query.entities;\r\n    const substep = this.physics.config.substep;\r\n\r\n    for (let i = 0; i < entities.length; i++) {\r\n      transform = entities[i].get(TransformComponent);\r\n      motion = entities[i].get(MotionComponent);\r\n\r\n      const optionalBody = entities[i].get(BodyComponent);\r\n      if (this._physicsConfigDirty && optionalBody) {\r\n        optionalBody.updatePhysicsConfig(this.physics.config.bodies);\r\n      }\r\n\r\n      if (optionalBody?.isSleeping) {\r\n        continue;\r\n      }\r\n\r\n      const totalAcc = motion.acc.clone();\r\n      if (optionalBody?.collisionType === CollisionType.Active && optionalBody?.useGravity) {\r\n        totalAcc.addEqual(this.physics.config.gravity);\r\n      }\r\n\r\n      // capture old transform of this entity and all of its children so that\r\n      // any transform properties that derived from their parents are properly captured\r\n      if (!entities[i].parent) {\r\n        this.captureOldTransformWithChildren(entities[i]);\r\n      }\r\n\r\n      // Update transform and motion based on Euler linear algebra\r\n      EulerIntegrator.integrate(transform, motion, totalAcc, elapsed / substep);\r\n    }\r\n    this._physicsConfigDirty = false;\r\n  }\r\n\r\n  captureOldTransformWithChildren(entity: Entity) {\r\n    entity.get(BodyComponent)?.captureOldTransform();\r\n\r\n    for (let i = 0; i < entity.children.length; i++) {\r\n      this.captureOldTransformWithChildren(entity.children[i]);\r\n    }\r\n  }\r\n}\r\n","import { PostCollisionEvent, PreCollisionEvent } from '../../Events';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { Side } from '../Side';\r\nimport { CollisionSolver } from './Solver';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { ContactBias, ContactSolveBias, HorizontalFirst, None, VerticalFirst } from './ContactBias';\r\nimport { PhysicsConfig } from '../PhysicsConfig';\r\nimport { DeepRequired } from '../../Util/Required';\r\n\r\n/**\r\n * ArcadeSolver is the default in Excalibur. It solves collisions so that there is no overlap between contacts,\r\n * and negates velocity along the collision normal.\r\n *\r\n * This is usually the type of collisions used for 2D games that don't need a more realistic collision simulation.\r\n *\r\n */\r\nexport class ArcadeSolver implements CollisionSolver {\r\n  directionMap = new Map<string, 'horizontal' | 'vertical'>();\r\n  distanceMap = new Map<string, number>();\r\n\r\n  constructor(public config: DeepRequired<Pick<PhysicsConfig, 'arcade'>['arcade']>) {}\r\n\r\n  public solve(contacts: CollisionContact[]): CollisionContact[] {\r\n    // Events and init\r\n    this.preSolve(contacts);\r\n\r\n    // Remove any canceled contacts\r\n    contacts = contacts.filter((c) => !c.isCanceled());\r\n\r\n    // Locate collision bias order\r\n    let bias: ContactBias;\r\n    switch (this.config.contactSolveBias) {\r\n      case ContactSolveBias.HorizontalFirst: {\r\n        bias = HorizontalFirst;\r\n        break;\r\n      }\r\n      case ContactSolveBias.VerticalFirst: {\r\n        bias = VerticalFirst;\r\n        break;\r\n      }\r\n      default: {\r\n        bias = None;\r\n      }\r\n    }\r\n\r\n    // Sort by bias (None, VerticalFirst, HorizontalFirst) to avoid artifacts with seams\r\n    // Sort contacts by distance to avoid artifacts with seams\r\n    // It's important to solve in a specific order\r\n    contacts.sort((a, b) => {\r\n      const aDir = this.directionMap.get(a.id);\r\n      const bDir = this.directionMap.get(b.id);\r\n      const aDist = this.distanceMap.get(a.id);\r\n      const bDist = this.distanceMap.get(b.id);\r\n      return bias[aDir] - bias[bDir] || aDist - bDist;\r\n    });\r\n\r\n    for (const contact of contacts) {\r\n      // Solve position first in arcade\r\n      this.solvePosition(contact);\r\n\r\n      // Solve velocity second in arcade\r\n      this.solveVelocity(contact);\r\n    }\r\n\r\n    // Events and any contact house-keeping the solver needs\r\n    this.postSolve(contacts);\r\n\r\n    return contacts;\r\n  }\r\n\r\n  public preSolve(contacts: CollisionContact[]) {\r\n    const epsilon = 0.0001;\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const contact = contacts[i];\r\n      if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n        // Cancel near 0 mtv collisions\r\n        contact.cancel();\r\n        continue;\r\n      }\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const mtv = contact.mtv.negate();\r\n\r\n      const distance = Math.abs(contact.info.separation);\r\n      this.distanceMap.set(contact.id, distance);\r\n\r\n      this.directionMap.set(contact.id, side === Side.Left || side === Side.Right ? 'horizontal' : 'vertical');\r\n\r\n      // Publish collision events on both participants\r\n      contact.colliderA.events.emit('precollision', new PreCollisionEvent(contact.colliderA, contact.colliderB, side, mtv, contact));\r\n      contact.colliderB.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), mtv.negate(), contact)\r\n      );\r\n    }\r\n  }\r\n\r\n  public postSolve(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const contact = contacts[i];\r\n      if (contact.isCanceled()) {\r\n        continue;\r\n      }\r\n      const colliderA = contact.colliderA;\r\n      const colliderB = contact.colliderB;\r\n      const bodyA = colliderA.owner?.get(BodyComponent);\r\n      const bodyB = colliderB.owner?.get(BodyComponent);\r\n      if (bodyA && bodyB) {\r\n        if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const mtv = contact.mtv.negate();\r\n      // Publish collision events on both participants\r\n      contact.colliderA.events.emit('postcollision', new PostCollisionEvent(contact.colliderA, contact.colliderB, side, mtv, contact));\r\n      contact.colliderB.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), mtv.negate(), contact)\r\n      );\r\n    }\r\n  }\r\n\r\n  public solvePosition(contact: CollisionContact) {\r\n    const epsilon = 0.0001;\r\n    // if bounds no longer intersect skip to the next\r\n    // this removes jitter from overlapping/stacked solid tiles or a wall of solid tiles\r\n    if (!contact.colliderA.bounds.overlaps(contact.colliderB.bounds, epsilon)) {\r\n      // Cancel the contact to prevent and solving\r\n      contact.cancel();\r\n      return;\r\n    }\r\n\r\n    if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n      // Cancel near 0 mtv collisions\r\n      contact.cancel();\r\n      return;\r\n    }\r\n\r\n    let mtv = contact.mtv;\r\n    const colliderA = contact.colliderA;\r\n    const colliderB = contact.colliderB;\r\n    const bodyA = colliderA.owner?.get(BodyComponent);\r\n    const bodyB = colliderB.owner?.get(BodyComponent);\r\n    if (bodyA && bodyB) {\r\n      if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n        return;\r\n      }\r\n\r\n      if (bodyA.collisionType === CollisionType.Active && bodyB.collisionType === CollisionType.Active) {\r\n        // split overlaps if both are Active\r\n        mtv = mtv.scale(0.5);\r\n      }\r\n\r\n      // Resolve overlaps\r\n      if (bodyA.collisionType === CollisionType.Active) {\r\n        bodyA.globalPos.x -= mtv.x;\r\n        bodyA.globalPos.y -= mtv.y;\r\n        colliderA.update(bodyA.transform.get());\r\n      }\r\n\r\n      if (bodyB.collisionType === CollisionType.Active) {\r\n        bodyB.globalPos.x += mtv.x;\r\n        bodyB.globalPos.y += mtv.y;\r\n        colliderB.update(bodyB.transform.get());\r\n      }\r\n    }\r\n  }\r\n\r\n  public solveVelocity(contact: CollisionContact) {\r\n    if (contact.isCanceled()) {\r\n      return;\r\n    }\r\n\r\n    const colliderA = contact.colliderA;\r\n    const colliderB = contact.colliderB;\r\n    const bodyA = colliderA.owner?.get(BodyComponent);\r\n    const bodyB = colliderB.owner?.get(BodyComponent);\r\n\r\n    if (bodyA && bodyB) {\r\n      if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n        return;\r\n      }\r\n\r\n      const normal = contact.normal;\r\n      const opposite = normal.negate();\r\n\r\n      if (bodyA.collisionType === CollisionType.Active) {\r\n        // only adjust velocity if the contact normal is opposite to the current velocity\r\n        // this avoids catching edges on a platform when sliding off\r\n        if (bodyA.vel.normalize().dot(opposite) < 0) {\r\n          // Cancel out velocity opposite direction of collision normal\r\n          const velAdj = normal.scale(normal.dot(bodyA.vel.negate()));\r\n          bodyA.vel = bodyA.vel.add(velAdj);\r\n        }\r\n      }\r\n\r\n      if (bodyB.collisionType === CollisionType.Active) {\r\n        // only adjust velocity if the contact normal is opposite to the current velocity\r\n        // this avoids catching edges on a platform\r\n        if (bodyB.vel.normalize().dot(normal) < 0) {\r\n          const velAdj = opposite.scale(opposite.dot(bodyB.vel.negate()));\r\n          bodyB.vel = bodyB.vel.add(velAdj);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\n\r\n/**\r\n * Holds information about contact points, meant to be reused over multiple frames of contact\r\n */\r\nexport class ContactConstraintPoint {\r\n  constructor(\r\n    public point: Vector,\r\n    public local: Vector,\r\n    public contact: CollisionContact\r\n  ) {\r\n    this.update();\r\n  }\r\n\r\n  /**\r\n   * Updates the contact information\r\n   */\r\n  update() {\r\n    const bodyA = this.contact.bodyA;\r\n    const colliderA = this.contact.colliderA;\r\n    const bodyB = this.contact.bodyB;\r\n    const colliderB = this.contact.colliderB;\r\n\r\n    if (bodyA && bodyB) {\r\n      const normal = this.contact.normal;\r\n      const tangent = this.contact.tangent;\r\n\r\n      this.aToContact = this.point.sub(colliderA.center);\r\n      this.bToContact = this.point.sub(colliderB.center);\r\n\r\n      const aToContactNormal = this.aToContact.cross(normal);\r\n      const bToContactNormal = this.bToContact.cross(normal);\r\n\r\n      this.normalMass =\r\n        bodyA.inverseMass +\r\n        bodyB.inverseMass +\r\n        bodyA.inverseInertia * aToContactNormal * aToContactNormal +\r\n        bodyB.inverseInertia * bToContactNormal * bToContactNormal;\r\n\r\n      const aToContactTangent = this.aToContact.cross(tangent);\r\n      const bToContactTangent = this.bToContact.cross(tangent);\r\n\r\n      this.tangentMass =\r\n        bodyA.inverseMass +\r\n        bodyB.inverseMass +\r\n        bodyA.inverseInertia * aToContactTangent * aToContactTangent +\r\n        bodyB.inverseInertia * bToContactTangent * bToContactTangent;\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Returns the relative velocity between bodyA and bodyB\r\n   */\r\n  public getRelativeVelocity() {\r\n    const bodyA = this.contact.bodyA;\r\n    const bodyB = this.contact.bodyB;\r\n    if (bodyA && bodyB) {\r\n      // Relative velocity in linear terms\r\n      // Angular to linear velocity formula -> omega = velocity/radius so omega x radius = velocity\r\n      const velA = bodyA.vel.add(Vector.cross(bodyA.angularVelocity, this.aToContact));\r\n      const velB = bodyB.vel.add(Vector.cross(bodyB.angularVelocity, this.bToContact));\r\n      return velB.sub(velA);\r\n    }\r\n    return Vector.Zero;\r\n  }\r\n\r\n  /**\r\n   * Impulse accumulated over time in normal direction\r\n   */\r\n  public normalImpulse: number = 0;\r\n\r\n  /**\r\n   * Impulse accumulated over time in the tangent direction\r\n   */\r\n  public tangentImpulse: number = 0;\r\n\r\n  /**\r\n   * Effective mass seen in the normal direction\r\n   */\r\n  public normalMass: number = 0;\r\n\r\n  /**\r\n   * Effective mass seen in the tangent direction\r\n   */\r\n  public tangentMass: number = 0;\r\n\r\n  /**\r\n   * Direction from center of mass of bodyA to contact point\r\n   */\r\n  public aToContact: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Direction from center of mass of bodyB to contact point\r\n   */\r\n  public bToContact: Vector = new Vector(0, 0);\r\n\r\n  /**\r\n   * Original contact velocity combined with bounciness\r\n   */\r\n  public originalVelocityAndRestitution: number = 0;\r\n}\r\n","import { CollisionPostSolveEvent, CollisionPreSolveEvent, PostCollisionEvent, PreCollisionEvent } from '../../Events';\r\nimport { clamp } from '../../Math/util';\r\nimport { CollisionContact } from '../Detection/CollisionContact';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { ContactConstraintPoint } from './ContactConstraintPoint';\r\nimport { Side } from '../Side';\r\nimport { CollisionSolver } from './Solver';\r\nimport { DegreeOfFreedom } from '../BodyComponent';\r\nimport { CollisionJumpTable } from '../Colliders/CollisionJumpTable';\r\nimport { DeepRequired } from '../../Util/Required';\r\nimport { PhysicsConfig } from '../PhysicsConfig';\r\nimport { ContactBias, ContactSolveBias, HorizontalFirst, None, VerticalFirst } from './ContactBias';\r\n\r\nexport class RealisticSolver implements CollisionSolver {\r\n  directionMap = new Map<string, 'horizontal' | 'vertical'>();\r\n  distanceMap = new Map<string, number>();\r\n\r\n  constructor(public config: DeepRequired<Pick<PhysicsConfig, 'realistic'>['realistic']>) {}\r\n  lastFrameContacts: Map<string, CollisionContact> = new Map();\r\n\r\n  // map contact id to contact points\r\n  idToContactConstraint: Map<string, ContactConstraintPoint[]> = new Map();\r\n\r\n  getContactConstraints(id: string) {\r\n    return this.idToContactConstraint.get(id) ?? [];\r\n  }\r\n\r\n  public solve(contacts: CollisionContact[]): CollisionContact[] {\r\n    // Events and init\r\n    this.preSolve(contacts);\r\n\r\n    // Remove any canceled contacts\r\n    contacts = contacts.filter((c) => !c.isCanceled());\r\n    // Locate collision bias order\r\n    let bias: ContactBias;\r\n    switch (this.config.contactSolveBias) {\r\n      case ContactSolveBias.HorizontalFirst: {\r\n        bias = HorizontalFirst;\r\n        break;\r\n      }\r\n      case ContactSolveBias.VerticalFirst: {\r\n        bias = VerticalFirst;\r\n        break;\r\n      }\r\n      default: {\r\n        bias = None;\r\n      }\r\n    }\r\n\r\n    // Sort by bias (None, VerticalFirst, HorizontalFirst) to avoid artifacts with seams\r\n    // Sort contacts by distance to avoid artifacts with seams\r\n    // It's important to solve in a specific order\r\n    contacts.sort((a, b) => {\r\n      const aDir = this.directionMap.get(a.id);\r\n      const bDir = this.directionMap.get(b.id);\r\n      const aDist = this.distanceMap.get(a.id);\r\n      const bDist = this.distanceMap.get(b.id);\r\n      return bias[aDir] - bias[bDir] || aDist - bDist;\r\n    });\r\n\r\n    // Solve velocity first\r\n    this.solveVelocity(contacts);\r\n\r\n    // Solve position last because non-overlap is the most important\r\n    this.solvePosition(contacts);\r\n\r\n    // Events and any contact house-keeping the solver needs\r\n    this.postSolve(contacts);\r\n\r\n    return contacts;\r\n  }\r\n\r\n  preSolve(contacts: CollisionContact[]) {\r\n    const epsilon = 0.0001;\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const contact = contacts[i];\r\n      if (Math.abs(contact.mtv.x) < epsilon && Math.abs(contact.mtv.y) < epsilon) {\r\n        // Cancel near 0 mtv collisions\r\n        contact.cancel();\r\n        continue;\r\n      }\r\n      // Publish collision events on both participants\r\n      const side = Side.fromDirection(contact.mtv);\r\n      const distance = Math.abs(contact?.info?.separation || 0);\r\n\r\n      this.distanceMap.set(contact.id, distance);\r\n      this.directionMap.set(contact.id, side === Side.Left || side === Side.Right ? 'horizontal' : 'vertical');\r\n\r\n      contact.colliderA.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact)\r\n      );\r\n      contact.colliderA.events.emit(\r\n        'beforecollisionresolve',\r\n        new CollisionPreSolveEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact) as any\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'precollision',\r\n        new PreCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact)\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'beforecollisionresolve',\r\n        new CollisionPreSolveEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact) as any\r\n      );\r\n\r\n      // Match awake state for sleeping\r\n      contact.matchAwake();\r\n    }\r\n\r\n    // Keep track of contacts that done\r\n    const finishedContactIds = Array.from(this.idToContactConstraint.keys());\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const contact = contacts[i];\r\n      // Remove all current contacts that are not done\r\n      const index = finishedContactIds.indexOf(contact.id);\r\n      if (index > -1) {\r\n        finishedContactIds.splice(index, 1);\r\n      }\r\n      const contactPoints = this.idToContactConstraint.get(contact.id) ?? [];\r\n\r\n      let pointIndex = 0;\r\n      const bodyA = contact.bodyA;\r\n      const colliderA = contact.colliderA;\r\n      const bodyB = contact.bodyB;\r\n      const colliderB = contact.colliderB;\r\n      if (bodyA && bodyB) {\r\n        for (let j = 0; j < contact.points.length; j++) {\r\n          const point = contact.points[j];\r\n          const normal = contact.normal;\r\n          const tangent = contact.tangent;\r\n\r\n          const aToContact = point.sub(colliderA.center);\r\n          const bToContact = point.sub(colliderB.center);\r\n\r\n          const aToContactNormal = aToContact.cross(normal);\r\n          const bToContactNormal = bToContact.cross(normal);\r\n\r\n          const normalMass =\r\n            bodyA.inverseMass +\r\n            bodyB.inverseMass +\r\n            bodyA.inverseInertia * aToContactNormal * aToContactNormal +\r\n            bodyB.inverseInertia * bToContactNormal * bToContactNormal;\r\n\r\n          const aToContactTangent = aToContact.cross(tangent);\r\n          const bToContactTangent = bToContact.cross(tangent);\r\n\r\n          const tangentMass =\r\n            bodyA.inverseMass +\r\n            bodyB.inverseMass +\r\n            bodyA.inverseInertia * aToContactTangent * aToContactTangent +\r\n            bodyB.inverseInertia * bToContactTangent * bToContactTangent;\r\n\r\n          // Preserve normal/tangent impulse by re-using the contact point if it's close\r\n          if (contactPoints[pointIndex] && contactPoints[pointIndex]?.point?.squareDistance(point) < 4) {\r\n            contactPoints[pointIndex].point = point;\r\n            contactPoints[pointIndex].local = contact.localPoints[pointIndex];\r\n          } else {\r\n            // new contact if it's not close or doesn't exist\r\n            contactPoints[pointIndex] = new ContactConstraintPoint(point, contact.localPoints[pointIndex], contact);\r\n          }\r\n\r\n          // Update contact point calculations\r\n          contactPoints[pointIndex].aToContact = aToContact;\r\n          contactPoints[pointIndex].bToContact = bToContact;\r\n          contactPoints[pointIndex].normalMass = 1.0 / normalMass;\r\n          contactPoints[pointIndex].tangentMass = 1.0 / tangentMass;\r\n\r\n          // Calculate relative velocity before solving to accurately do restitution\r\n          const restitution = bodyA.bounciness > bodyB.bounciness ? bodyA.bounciness : bodyB.bounciness;\r\n          const relativeVelocity = contact.normal.dot(contactPoints[pointIndex].getRelativeVelocity());\r\n          contactPoints[pointIndex].originalVelocityAndRestitution = 0;\r\n          if (relativeVelocity < -0.1) {\r\n            // TODO what's a good threshold here?\r\n            contactPoints[pointIndex].originalVelocityAndRestitution = -restitution * relativeVelocity;\r\n          }\r\n          pointIndex++;\r\n        }\r\n      }\r\n      this.idToContactConstraint.set(contact.id, contactPoints);\r\n    }\r\n\r\n    // Clean up any contacts that did not occur last frame\r\n    for (const id of finishedContactIds) {\r\n      this.idToContactConstraint.delete(id);\r\n    }\r\n\r\n    // Warm contacts with accumulated impulse\r\n    // Useful for tall stacks\r\n    if (this.config.warmStart) {\r\n      this.warmStart(contacts);\r\n    } else {\r\n      for (let i = 0; i < contacts.length; i++) {\r\n        const contact = contacts[i];\r\n        const contactPoints = this.getContactConstraints(contact.id);\r\n        for (const point of contactPoints) {\r\n          point.normalImpulse = 0;\r\n          point.tangentImpulse = 0;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  postSolve(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const contact = contacts[i];\r\n      const bodyA = contact.bodyA;\r\n      const bodyB = contact.bodyB;\r\n\r\n      if (bodyA && bodyB) {\r\n        // Skip post solve for active+passive collisions\r\n        if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n          continue;\r\n        }\r\n\r\n        // Update motion values for sleeping\r\n        bodyA.updateMotion();\r\n        bodyB.updateMotion();\r\n      }\r\n\r\n      // Publish collision events on both participants\r\n      const side = Side.fromDirection(contact.mtv);\r\n      contact.colliderA.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact)\r\n      );\r\n      contact.colliderA.events.emit(\r\n        'aftercollisionresolve',\r\n        new CollisionPostSolveEvent(contact.colliderA, contact.colliderB, side, contact.mtv, contact) as any\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'postcollision',\r\n        new PostCollisionEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact)\r\n      );\r\n      contact.colliderB.events.emit(\r\n        'aftercollisionresolve',\r\n        new CollisionPostSolveEvent(contact.colliderB, contact.colliderA, Side.getOpposite(side), contact.mtv.negate(), contact) as any\r\n      );\r\n    }\r\n\r\n    // Store contacts\r\n    this.lastFrameContacts.clear();\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const c = contacts[i];\r\n      this.lastFrameContacts.set(c.id, c);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Warm up body's based on previous frame contact points\r\n   * @param contacts\r\n   */\r\n  warmStart(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < contacts.length; i++) {\r\n      const contact = contacts[i];\r\n      const bodyA = contact.bodyA;\r\n      const bodyB = contact.bodyB;\r\n      if (bodyA && bodyB) {\r\n        const contactPoints = this.idToContactConstraint.get(contact.id) ?? [];\r\n        for (const point of contactPoints) {\r\n          if (this.config.warmStart) {\r\n            const normalImpulse = contact.normal.scale(point.normalImpulse);\r\n            const tangentImpulse = contact.tangent.scale(point.tangentImpulse);\r\n            const impulse = normalImpulse.add(tangentImpulse);\r\n\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          } else {\r\n            point.normalImpulse = 0;\r\n            point.tangentImpulse = 0;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Iteratively solve the position overlap constraint\r\n   * @param contacts\r\n   */\r\n  solvePosition(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < this.config.positionIterations; i++) {\r\n      for (let i = 0; i < contacts.length; i++) {\r\n        const contact = contacts[i];\r\n        const bodyA = contact.bodyA;\r\n        const bodyB = contact.bodyB;\r\n\r\n        if (bodyA && bodyB) {\r\n          // Skip solving active+passive\r\n          if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n            continue;\r\n          }\r\n\r\n          const constraints = this.idToContactConstraint.get(contact.id) ?? [];\r\n          for (const point of constraints) {\r\n            const normal = contact.normal;\r\n            const separation = CollisionJumpTable.FindContactSeparation(contact, point.local);\r\n\r\n            const steeringConstant = this.config.steeringFactor; //0.2;\r\n            const maxCorrection = -5;\r\n            const slop = this.config.slop; //1;\r\n\r\n            // Clamp to avoid over-correction\r\n            // Remember that we are shooting for 0 overlap in the end\r\n            const steeringForce = clamp(steeringConstant * (separation + slop), maxCorrection, 0);\r\n            const impulse = normal.scale(-steeringForce * point.normalMass);\r\n\r\n            // This is a pseudo impulse, meaning we aren't doing a real impulse calculation\r\n            // We adjust position and rotation instead of doing the velocity\r\n            if (bodyA.collisionType === CollisionType.Active) {\r\n              // TODO make applyPseudoImpulse function?\r\n              const impulseForce = impulse.negate().scale(bodyA.inverseMass);\r\n              if (bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n                impulseForce.x = 0;\r\n              }\r\n              if (bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n                impulseForce.y = 0;\r\n              }\r\n\r\n              bodyA.globalPos = bodyA.globalPos.add(impulseForce);\r\n              if (!bodyA.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n                bodyA.rotation -= point.aToContact.cross(impulse) * bodyA.inverseInertia;\r\n              }\r\n            }\r\n\r\n            if (bodyB.collisionType === CollisionType.Active) {\r\n              const impulseForce = impulse.scale(bodyB.inverseMass);\r\n              if (bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)) {\r\n                impulseForce.x = 0;\r\n              }\r\n              if (bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)) {\r\n                impulseForce.y = 0;\r\n              }\r\n\r\n              bodyB.globalPos = bodyB.globalPos.add(impulseForce);\r\n              if (!bodyB.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)) {\r\n                bodyB.rotation += point.bToContact.cross(impulse) * bodyB.inverseInertia;\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  solveVelocity(contacts: CollisionContact[]) {\r\n    for (let i = 0; i < this.config.velocityIterations; i++) {\r\n      for (let i = 0; i < contacts.length; i++) {\r\n        const contact = contacts[i];\r\n        const bodyA = contact.bodyA;\r\n        const bodyB = contact.bodyB;\r\n\r\n        if (bodyA && bodyB) {\r\n          // Skip solving active+passive\r\n          if (bodyA.collisionType === CollisionType.Passive || bodyB.collisionType === CollisionType.Passive) {\r\n            continue;\r\n          }\r\n\r\n          const friction = Math.min(bodyA.friction, bodyB.friction);\r\n\r\n          const constraints = this.idToContactConstraint.get(contact.id) ?? [];\r\n\r\n          // Friction constraint\r\n          for (const point of constraints) {\r\n            const relativeVelocity = point.getRelativeVelocity();\r\n\r\n            // Negate velocity in tangent direction to simulate friction\r\n            const tangentVelocity = -relativeVelocity.dot(contact.tangent);\r\n            let impulseDelta = tangentVelocity * point.tangentMass;\r\n\r\n            // Clamping based in Erin Catto's GDC 2006 talk\r\n            // Correct clamping https://github.com/erincatto/box2d-lite/blob/master/docs/GDC2006_Catto_Erin_PhysicsTutorial.pdf\r\n            // Accumulated fiction impulse is always between -uMaxFriction < dT < uMaxFriction\r\n            // But deltas can vary\r\n            const maxFriction = friction * point.normalImpulse;\r\n            const newImpulse = clamp(point.tangentImpulse + impulseDelta, -maxFriction, maxFriction);\r\n            impulseDelta = newImpulse - point.tangentImpulse;\r\n            point.tangentImpulse = newImpulse;\r\n\r\n            const impulse = contact.tangent.scale(impulseDelta);\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          }\r\n\r\n          // Bounce constraint\r\n          for (const point of constraints) {\r\n            // Need to recalc relative velocity because the previous step could have changed vel\r\n            const relativeVelocity = point.getRelativeVelocity();\r\n\r\n            // Compute impulse in normal direction\r\n            const normalVelocity = relativeVelocity.dot(contact.normal);\r\n\r\n            // Per Erin it is a mistake to apply the restitution inside the iteration\r\n            // From Erin Catto's Box2D we keep original contact velocity and adjust by small impulses\r\n            let impulseDelta = -point.normalMass * (normalVelocity - point.originalVelocityAndRestitution);\r\n\r\n            // Clamping based in Erin Catto's GDC 2014 talk\r\n            // Accumulated impulse stored in the contact is always positive (dV > 0)\r\n            // But deltas can be negative\r\n            const newImpulse = Math.max(point.normalImpulse + impulseDelta, 0);\r\n            impulseDelta = newImpulse - point.normalImpulse;\r\n            point.normalImpulse = newImpulse;\r\n\r\n            const impulse = contact.normal.scale(impulseDelta);\r\n            bodyA.applyImpulse(point.point, impulse.negate());\r\n            bodyB.applyImpulse(point.point, impulse);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { ComponentCtor, Query, SystemPriority, World } from '../EntityComponentSystem';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { CollisionEndEvent, CollisionStartEvent, ContactEndEvent, ContactStartEvent } from '../Events';\r\nimport { SolverStrategy } from './SolverStrategy';\r\nimport { ArcadeSolver } from './Solver/ArcadeSolver';\r\nimport { Collider } from './Colliders/Collider';\r\nimport { CollisionContact } from './Detection/CollisionContact';\r\nimport { RealisticSolver } from './Solver/RealisticSolver';\r\nimport { CollisionSolver } from './Solver/Solver';\r\nimport { ColliderComponent } from './ColliderComponent';\r\nimport { CompositeCollider } from './Colliders/CompositeCollider';\r\nimport { Engine } from '../Engine';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Scene } from '../Scene';\r\nimport { Side } from '../Collision/Side';\r\nimport { PhysicsWorld } from './PhysicsWorld';\r\nimport { CollisionProcessor } from './Detection/CollisionProcessor';\r\nimport { SeparatingAxis } from './Colliders/SeparatingAxis';\r\nimport { MotionSystem } from './MotionSystem';\r\nimport { Pair } from './Detection/Pair';\r\nexport class CollisionSystem extends System {\r\n  static priority = SystemPriority.Higher;\r\n\r\n  public systemType = SystemType.Update;\r\n  public query: Query<ComponentCtor<TransformComponent> | ComponentCtor<MotionComponent> | ComponentCtor<ColliderComponent>>;\r\n\r\n  private _engine: Engine;\r\n  private _configDirty = false;\r\n  private _realisticSolver: RealisticSolver;\r\n  private _arcadeSolver: ArcadeSolver;\r\n  private _lastFrameContacts = new Map<string, CollisionContact>();\r\n  private _currentFrameContacts = new Map<string, CollisionContact>();\r\n  private _motionSystem: MotionSystem;\r\n  private get _processor(): CollisionProcessor {\r\n    return this._physics.collisionProcessor;\r\n  }\r\n\r\n  private _trackCollider: (c: Collider) => void;\r\n  private _untrackCollider: (c: Collider) => void;\r\n\r\n  constructor(\r\n    world: World,\r\n    private _physics: PhysicsWorld\r\n  ) {\r\n    super();\r\n    this._arcadeSolver = new ArcadeSolver(_physics.config.arcade);\r\n    this._realisticSolver = new RealisticSolver(_physics.config.realistic);\r\n    this._physics.$configUpdate.subscribe(() => (this._configDirty = true));\r\n    this._trackCollider = (c: Collider) => this._processor.track(c);\r\n    this._untrackCollider = (c: Collider) => this._processor.untrack(c);\r\n    this.query = world.query([TransformComponent, MotionComponent, ColliderComponent]);\r\n    this.query.entityAdded$.subscribe((e) => {\r\n      const colliderComponent = e.get(ColliderComponent);\r\n      colliderComponent.$colliderAdded.subscribe(this._trackCollider);\r\n      colliderComponent.$colliderRemoved.subscribe(this._untrackCollider);\r\n      const collider = colliderComponent.get();\r\n      if (collider) {\r\n        this._processor.track(collider);\r\n      }\r\n    });\r\n    this.query.entityRemoved$.subscribe((e) => {\r\n      const colliderComponent = e.get(ColliderComponent);\r\n      const collider = colliderComponent.get();\r\n      if (colliderComponent && collider) {\r\n        this._processor.untrack(collider);\r\n      }\r\n    });\r\n    this._motionSystem = world.get(MotionSystem) as MotionSystem;\r\n  }\r\n\r\n  initialize(world: World, scene: Scene) {\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  update(elapsed: number): void {\r\n    if (!this._physics.config.enabled) {\r\n      return;\r\n    }\r\n\r\n    // TODO do we need to do this every frame?\r\n    // Collect up all the colliders and update them\r\n    let colliders: Collider[] = [];\r\n    for (let entityIndex = 0; entityIndex < this.query.entities.length; entityIndex++) {\r\n      const entity = this.query.entities[entityIndex];\r\n      const colliderComp = entity.get(ColliderComponent);\r\n      const collider = colliderComp?.get();\r\n      if (colliderComp && colliderComp.owner?.isActive && collider) {\r\n        colliderComp.update();\r\n\r\n        // Flatten composite colliders\r\n        if (collider instanceof CompositeCollider) {\r\n          const compositeColliders = collider.getColliders();\r\n          if (!collider.compositeStrategy) {\r\n            collider.compositeStrategy = this._physics.config.colliders.compositeStrategy;\r\n          }\r\n          colliders = colliders.concat(compositeColliders);\r\n        } else {\r\n          colliders.push(collider);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update the spatial partitioning data structures\r\n    // TODO if collider invalid it will break the processor\r\n    // TODO rename \"update\" to something more specific\r\n    this._processor.update(colliders, elapsed);\r\n\r\n    // Run broadphase on all colliders and locates potential collisions\r\n    let pairs = this._processor.broadphase(colliders, elapsed);\r\n\r\n    this._currentFrameContacts.clear();\r\n\r\n    // Given possible pairs find actual contacts\r\n    let contacts: CollisionContact[] = []; // = this._processor.narrowphase(pairs, this._engine?.debug?.stats?.currFrame);\r\n\r\n    const solver: CollisionSolver = this.getSolver();\r\n\r\n    // Solve, this resolves the position/velocity so entities aren't overlapping\r\n    const substep = this._physics.config.substep;\r\n    for (let step = 0; step < substep; step++) {\r\n      if (step > 0) {\r\n        // first step is run by the MotionSystem when configured, so skip\r\n        this._motionSystem.update(elapsed);\r\n      }\r\n      // Re-use pairs from previous collision\r\n      if (contacts.length) {\r\n        pairs = contacts.map((c) => new Pair(c.colliderA, c.colliderB));\r\n      }\r\n\r\n      if (pairs.length) {\r\n        contacts = this._processor.narrowphase(pairs, this._engine?.debug?.stats?.currFrame);\r\n        contacts = solver.solve(contacts);\r\n\r\n        // Record contacts for start/end\r\n        for (const contact of contacts) {\r\n          if (contact.isCanceled()) {\r\n            continue;\r\n          }\r\n          // Process composite ids, things with the same composite id are treated as the same collider for start/end\r\n          const index = contact.id.indexOf('|');\r\n          if (index > 0) {\r\n            const compositeId = contact.id.substring(index + 1);\r\n            this._currentFrameContacts.set(compositeId, contact);\r\n          } else {\r\n            this._currentFrameContacts.set(contact.id, contact);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Emit contact start/end events\r\n    this.runContactStartEnd();\r\n\r\n    // reset the last frame cache\r\n    this._lastFrameContacts.clear();\r\n\r\n    // Keep track of collisions contacts that have started or ended\r\n    this._lastFrameContacts = new Map(this._currentFrameContacts);\r\n\r\n    // Process deferred collider removals\r\n    for (const entity of this.query.entities) {\r\n      const collider = entity.get(ColliderComponent);\r\n      if (collider) {\r\n        collider.processColliderRemoval();\r\n      }\r\n    }\r\n  }\r\n\r\n  postupdate(): void {\r\n    SeparatingAxis.SeparationPool.done();\r\n  }\r\n\r\n  getSolver(): CollisionSolver {\r\n    if (this._configDirty) {\r\n      this._configDirty = false;\r\n      this._arcadeSolver = new ArcadeSolver(this._physics.config.arcade);\r\n      this._realisticSolver = new RealisticSolver(this._physics.config.realistic);\r\n    }\r\n    return this._physics.config.solver === SolverStrategy.Realistic ? this._realisticSolver : this._arcadeSolver;\r\n  }\r\n\r\n  debug(ex: ExcaliburGraphicsContext) {\r\n    this._processor.debug(ex, 0);\r\n  }\r\n\r\n  public runContactStartEnd() {\r\n    // If composite colliders are 'together' collisions may have a duplicate id because we want to treat those as a singular start/end\r\n    for (const [id, c] of this._currentFrameContacts) {\r\n      // find all new contacts\r\n      if (!this._lastFrameContacts.has(id)) {\r\n        const colliderA = c.colliderA;\r\n        const colliderB = c.colliderB;\r\n        const side = Side.fromDirection(c.mtv);\r\n        const opposite = Side.getOpposite(side);\r\n        colliderA.events.emit('collisionstart', new CollisionStartEvent(colliderA, colliderB, side, c));\r\n        colliderA.events.emit('contactstart', new ContactStartEvent(colliderA, colliderB, side, c) as any);\r\n        colliderB.events.emit('collisionstart', new CollisionStartEvent(colliderB, colliderA, opposite, c));\r\n        colliderB.events.emit('contactstart', new ContactStartEvent(colliderB, colliderA, opposite, c) as any);\r\n      }\r\n    }\r\n\r\n    // find all contacts that have ceased\r\n    for (const [id, c] of this._lastFrameContacts) {\r\n      if (!this._currentFrameContacts.has(id)) {\r\n        const colliderA = c.colliderA;\r\n        const colliderB = c.colliderB;\r\n        const side = Side.fromDirection(c.mtv);\r\n        const opposite = Side.getOpposite(side);\r\n        colliderA.events.emit('collisionend', new CollisionEndEvent(colliderA, colliderB, side, c));\r\n        colliderA.events.emit('contactend', new ContactEndEvent(colliderA, colliderB, side, c) as any);\r\n        colliderB.events.emit('collisionend', new CollisionEndEvent(colliderB, colliderA, opposite, c));\r\n        colliderB.events.emit('contactend', new ContactEndEvent(colliderB, colliderA, opposite, c) as any);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Transform } from '../Math/transform';\r\n\r\n/**\r\n * Blend 2 transforms for interpolation, will interpolate from the context of newTx's parent if it exists\r\n */\r\nexport function blendTransform(oldTx: Transform, newTx: Transform, blend: number, target?: Transform): Transform {\r\n  if (oldTx.parent !== newTx.parent) {\r\n    // Caller expects a local transform\r\n    // Adjust old tx to be local to the new parent whatever that is\r\n    const oldTxWithNewParent = oldTx.clone();\r\n    const oldGlobalPos = oldTx.globalPos.clone();\r\n    const oldGlobalScale = oldTx.globalScale.clone();\r\n    const oldGlobalRotation = oldTx.globalRotation;\r\n    oldTxWithNewParent.parent = newTx.parent;\r\n    oldTxWithNewParent.globalPos = oldGlobalPos;\r\n    oldTxWithNewParent.globalScale = oldGlobalScale;\r\n    oldTxWithNewParent.globalRotation = oldGlobalRotation;\r\n    oldTx = oldTxWithNewParent;\r\n  }\r\n  let interpolatedPos = newTx.pos;\r\n  let interpolatedScale = newTx.scale;\r\n  let interpolatedRotation = newTx.rotation;\r\n\r\n  interpolatedPos = newTx.pos.scale(blend).add(oldTx.pos.scale(1.0 - blend));\r\n  interpolatedScale = newTx.scale.scale(blend).add(oldTx.scale.scale(1.0 - blend));\r\n  // Rotational lerp https://stackoverflow.com/a/30129248\r\n  const cosine = (1.0 - blend) * Math.cos(oldTx.rotation) + blend * Math.cos(newTx.rotation);\r\n  const sine = (1.0 - blend) * Math.sin(oldTx.rotation) + blend * Math.sin(newTx.rotation);\r\n  interpolatedRotation = Math.atan2(sine, cosine);\r\n\r\n  const tx = target ?? new Transform();\r\n  tx.setTransform(interpolatedPos, interpolatedRotation, interpolatedScale);\r\n  return tx;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function blendGlobalTransform(oldTx: Transform, newTx: Transform, blend: number, target?: Transform): Transform {\r\n  let interpolatedPos = newTx.globalPos;\r\n  let interpolatedScale = newTx.globalScale;\r\n  let interpolatedRotation = newTx.globalRotation;\r\n\r\n  interpolatedPos = newTx.globalPos.scale(blend).add(oldTx.globalPos.scale(1.0 - blend));\r\n  interpolatedScale = newTx.globalScale.scale(blend).add(oldTx.globalScale.scale(1.0 - blend));\r\n  // Rotational lerp https://stackoverflow.com/a/30129248\r\n  const cosine = (1.0 - blend) * Math.cos(oldTx.globalRotation) + blend * Math.cos(newTx.globalRotation);\r\n  const sine = (1.0 - blend) * Math.sin(oldTx.globalRotation) + blend * Math.sin(newTx.globalRotation);\r\n  interpolatedRotation = Math.atan2(sine, cosine);\r\n\r\n  const tx = target ?? new Transform();\r\n  tx.setTransform(interpolatedPos, interpolatedRotation, interpolatedScale);\r\n  return tx;\r\n}\r\n","import { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Scene } from '../Scene';\r\nimport { GraphicsComponent } from './GraphicsComponent';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity } from '../EntityComponentSystem/Entity';\r\nimport { Camera } from '../Camera';\r\nimport { Query, System, SystemPriority, SystemType, World } from '../EntityComponentSystem';\r\nimport { Engine } from '../Engine';\r\nimport { GraphicsGroup } from './GraphicsGroup';\r\nimport { ParallaxComponent } from './ParallaxComponent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { FontCache } from './FontCache';\r\nimport { PostDrawEvent, PostTransformDrawEvent, PreDrawEvent, PreTransformDrawEvent } from '../Events';\r\nimport { Transform } from '../Math/transform';\r\nimport { blendTransform } from './TransformInterpolation';\r\nimport { Graphic } from './Graphic';\r\n\r\nexport class GraphicsSystem extends System {\r\n  static priority = SystemPriority.Average;\r\n\r\n  public readonly systemType = SystemType.Draw;\r\n  private _token = 0;\r\n  // Set in the initialize\r\n  private _graphicsContext!: ExcaliburGraphicsContext;\r\n  private _camera!: Camera;\r\n  private _engine!: Engine;\r\n  private _sortedTransforms: TransformComponent[] = [];\r\n  query: Query<typeof TransformComponent | typeof GraphicsComponent>;\r\n  public get sortedTransforms() {\r\n    return this._sortedTransforms;\r\n  }\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, GraphicsComponent]);\r\n    this.query.entityAdded$.subscribe((e) => {\r\n      const tx = e.get(TransformComponent);\r\n      this._sortedTransforms.push(tx);\r\n      tx.zIndexChanged$.subscribe(this._zIndexUpdate);\r\n      this._zHasChanged = true;\r\n    });\r\n    this.query.entityRemoved$.subscribe((e) => {\r\n      const tx = e.get(TransformComponent);\r\n      tx.zIndexChanged$.unsubscribe(this._zIndexUpdate);\r\n      const index = this._sortedTransforms.indexOf(tx);\r\n      if (index > -1) {\r\n        this._sortedTransforms.splice(index, 1);\r\n      }\r\n    });\r\n  }\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._camera = scene.camera;\r\n    this._engine = scene.engine;\r\n  }\r\n\r\n  private _zHasChanged = false;\r\n  private _zIndexUpdate = () => {\r\n    this._zHasChanged = true;\r\n  };\r\n\r\n  public preupdate(): void {\r\n    // Graphics context could be switched to fallback in a new frame\r\n    this._graphicsContext = this._engine.graphicsContext;\r\n    if (this._zHasChanged) {\r\n      this._sortedTransforms.sort((a, b) => {\r\n        return a.globalZ - b.globalZ;\r\n      });\r\n      this._zHasChanged = false;\r\n    }\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    this._token++;\r\n    let graphics: GraphicsComponent;\r\n    FontCache.checkAndClearCache();\r\n\r\n    // This is a performance enhancement, most things are in world space\r\n    // so if we can only do this once saves a ton of transform updates\r\n    this._graphicsContext.save();\r\n    if (this._camera) {\r\n      this._camera.draw(this._graphicsContext);\r\n    }\r\n    for (let transformIndex = 0; transformIndex < this._sortedTransforms.length; transformIndex++) {\r\n      const transform = this._sortedTransforms[transformIndex];\r\n      const entity = transform.owner as Entity;\r\n\r\n      // If the entity is offscreen skip\r\n      if (entity.hasTag('ex.offscreen')) {\r\n        continue;\r\n      }\r\n\r\n      graphics = entity.get(GraphicsComponent);\r\n      // Exit if graphics set to not visible\r\n      if (!graphics.isVisible) {\r\n        continue;\r\n      }\r\n\r\n      // Optionally run the onPreTransformDraw graphics lifecycle draw\r\n      if (graphics.onPreTransformDraw) {\r\n        graphics.onPreTransformDraw(this._graphicsContext, elapsed);\r\n      }\r\n      entity.events.emit('pretransformdraw', new PreTransformDrawEvent(this._graphicsContext, elapsed, entity));\r\n\r\n      // This optionally sets our camera based on the entity coord plan (world vs. screen)\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.restore();\r\n      }\r\n\r\n      this._graphicsContext.save();\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.translate(this._engine.screen.contentArea.left, this._engine.screen.contentArea.top);\r\n      }\r\n\r\n      // Tick any graphics state (but only once) for animations and graphics groups\r\n      graphics.update(elapsed, this._token);\r\n\r\n      // Apply parallax\r\n      const parallax = entity.get(ParallaxComponent);\r\n      if (parallax) {\r\n        // We use the Tiled formula\r\n        // https://doc.mapeditor.org/en/latest/manual/layers/#parallax-scrolling-factor\r\n        // cameraPos * (1 - parallaxFactor)\r\n        const oneMinusFactor = Vector.One.sub(parallax.parallaxFactor);\r\n        const parallaxOffset = this._camera.drawPos.scale(oneMinusFactor);\r\n        this._graphicsContext.translate(parallaxOffset.x, parallaxOffset.y);\r\n      }\r\n\r\n      // Position the entity + estimate lag\r\n      this._applyTransform(entity);\r\n\r\n      // If there is a material enable it on the context\r\n      if (graphics.material) {\r\n        this._graphicsContext.material = graphics.material;\r\n      }\r\n\r\n      // Optionally run the onPreDraw graphics lifecycle draw\r\n      if (graphics.onPreDraw) {\r\n        graphics.onPreDraw(this._graphicsContext, elapsed);\r\n      }\r\n      entity.events.emit('predraw', new PreDrawEvent(this._graphicsContext, elapsed, entity));\r\n\r\n      // this._graphicsContext.opacity *= graphics.opacity;\r\n      this._applyOpacity(entity);\r\n\r\n      // Draw the graphics component\r\n      this._drawGraphicsComponent(graphics, transform);\r\n\r\n      // Optionally run the onPostDraw graphics lifecycle draw\r\n      if (graphics.onPostDraw) {\r\n        graphics.onPostDraw(this._graphicsContext, elapsed);\r\n      }\r\n      entity.events.emit('postdraw', new PostDrawEvent(this._graphicsContext, elapsed, entity));\r\n\r\n      this._graphicsContext.restore();\r\n\r\n      // Reset the transform back to the original world space\r\n      if (transform.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.save();\r\n        if (this._camera) {\r\n          this._camera.draw(this._graphicsContext);\r\n        }\r\n      }\r\n\r\n      // Optionally run the onPreTransformDraw graphics lifecycle draw\r\n      if (graphics.onPostTransformDraw) {\r\n        graphics.onPostTransformDraw(this._graphicsContext, elapsed);\r\n      }\r\n      entity.events.emit('posttransformdraw', new PostTransformDrawEvent(this._graphicsContext, elapsed, entity));\r\n    }\r\n    this._graphicsContext.restore();\r\n  }\r\n\r\n  private _drawGraphicsComponent(graphicsComponent: GraphicsComponent, transformComponent: TransformComponent) {\r\n    if (graphicsComponent.isVisible) {\r\n      const flipHorizontal = graphicsComponent.flipHorizontal;\r\n      const flipVertical = graphicsComponent.flipVertical;\r\n\r\n      const graphic = graphicsComponent.current;\r\n      const options = graphicsComponent.currentOptions ?? {};\r\n\r\n      if (graphic) {\r\n        let anchor = graphicsComponent.anchor;\r\n        let offset = graphicsComponent.offset;\r\n        let scaleX = 1;\r\n        let scaleY = 1;\r\n        // handle specific overrides\r\n        if (options?.anchor) {\r\n          anchor = options.anchor;\r\n        }\r\n        if (options?.offset) {\r\n          offset = options.offset;\r\n        }\r\n        const globalScale = transformComponent.globalScale;\r\n        scaleX *= graphic.scale.x * globalScale.x;\r\n        scaleY *= graphic.scale.y * globalScale.y;\r\n\r\n        // See https://github.com/excaliburjs/Excalibur/pull/619 for discussion on this formula\r\n        const offsetX = -graphic.width * anchor.x + offset.x * scaleX;\r\n        const offsetY = -graphic.height * anchor.y + offset.y * scaleY;\r\n\r\n        const oldFlipHorizontal = graphic.flipHorizontal;\r\n        const oldFlipVertical = graphic.flipVertical;\r\n        if (flipHorizontal || flipVertical) {\r\n          // flip any currently flipped graphics\r\n          graphic.flipHorizontal = flipHorizontal ? !oldFlipHorizontal : oldFlipHorizontal;\r\n          graphic.flipVertical = flipVertical ? !oldFlipVertical : oldFlipVertical;\r\n        }\r\n\r\n        graphic?.draw(this._graphicsContext, offsetX, offsetY);\r\n\r\n        if (flipHorizontal || flipVertical) {\r\n          graphic.flipHorizontal = oldFlipHorizontal;\r\n          graphic.flipVertical = oldFlipVertical;\r\n        }\r\n\r\n        // TODO move debug code out?\r\n        if (this._engine?.isDebug && this._engine.debug.graphics.showBounds) {\r\n          const offset = vec(offsetX, offsetY);\r\n          if (graphic instanceof GraphicsGroup) {\r\n            for (const member of graphic.members) {\r\n              let g: Graphic;\r\n              let pos: Vector = Vector.Zero;\r\n              if (member instanceof Graphic) {\r\n                g = member;\r\n              } else {\r\n                g = member.graphic;\r\n                pos = member.offset;\r\n              }\r\n\r\n              if (graphic.useAnchor) {\r\n                g?.localBounds.translate(offset.add(pos)).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n              } else {\r\n                g?.localBounds.translate(pos).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n              }\r\n            }\r\n          } else {\r\n            /* istanbul ignore next */\r\n            graphic?.localBounds.translate(offset).draw(this._graphicsContext, this._engine.debug.graphics.boundsColor);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private _targetInterpolationTransform = new Transform();\r\n  /**\r\n   * This applies the current entity transform to the graphics context\r\n   * @param entity\r\n   */\r\n  private _applyTransform(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (let i = 0; i < ancestors.length; i++) {\r\n      const ancestor = ancestors[i];\r\n      const transform = ancestor?.get(TransformComponent);\r\n      const optionalBody = ancestor?.get(BodyComponent);\r\n      if (transform) {\r\n        let tx = transform.get();\r\n        if (optionalBody) {\r\n          if (this._engine.fixedUpdateTimestep && optionalBody.__oldTransformCaptured && optionalBody.enableFixedUpdateInterpolate) {\r\n            // Interpolate graphics if needed\r\n            const blend = this._engine.currentFrameLagMs / this._engine.fixedUpdateTimestep;\r\n            tx = blendTransform(optionalBody.oldTransform, transform.get(), blend, this._targetInterpolationTransform);\r\n          }\r\n        }\r\n        this._graphicsContext.z = transform.globalZ;\r\n        this._graphicsContext.translate(tx.pos.x, tx.pos.y);\r\n        this._graphicsContext.scale(tx.scale.x, tx.scale.y);\r\n        this._graphicsContext.rotate(tx.rotation);\r\n      }\r\n    }\r\n  }\r\n\r\n  private _applyOpacity(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (let i = 0; i < ancestors.length; i++) {\r\n      const ancestor = ancestors[i];\r\n      const maybeGraphics = ancestor?.get(GraphicsComponent);\r\n      this._graphicsContext.opacity *= maybeGraphics?.opacity ?? 1;\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Camera } from '../Camera';\r\nimport { MotionComponent } from '../EntityComponentSystem/Components/MotionComponent';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Entity, Query, SystemPriority, TransformComponent, World } from '../EntityComponentSystem';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ExcaliburGraphicsContext } from '../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { toDegrees } from '../Math/util';\r\nimport { BodyComponent } from '../Collision/BodyComponent';\r\nimport { CollisionSystem } from '../Collision/CollisionSystem';\r\nimport { CompositeCollider } from '../Collision/Colliders/CompositeCollider';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Particle } from '../Particles/Particles';\r\nimport { DebugGraphicsComponent } from '../Graphics/DebugGraphicsComponent';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { Debug } from '../Graphics/Debug';\r\n\r\nexport class DebugSystem extends System {\r\n  static priority = SystemPriority.Lowest;\r\n\r\n  public readonly systemType = SystemType.Draw;\r\n  private _graphicsContext: ExcaliburGraphicsContext;\r\n  private _collisionSystem: CollisionSystem;\r\n  private _camera: Camera;\r\n  private _engine: Engine;\r\n  query: Query<typeof TransformComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent]);\r\n  }\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._graphicsContext = scene.engine.graphicsContext;\r\n    this._camera = scene.camera;\r\n    this._engine = scene.engine;\r\n    this._collisionSystem = world.systemManager.get(CollisionSystem);\r\n  }\r\n\r\n  update(): void {\r\n    if (!this._engine.isDebug) {\r\n      return;\r\n    }\r\n\r\n    const filterSettings = this._engine.debug.filter;\r\n\r\n    let id: number;\r\n    let name: string;\r\n    const entitySettings = this._engine.debug.entity;\r\n\r\n    let tx: TransformComponent;\r\n    const txSettings = this._engine.debug.transform;\r\n\r\n    let motion: MotionComponent;\r\n    const motionSettings = this._engine.debug.motion;\r\n\r\n    let colliderComp: ColliderComponent;\r\n    const colliderSettings = this._engine.debug.collider;\r\n\r\n    const physicsSettings = this._engine.debug.physics;\r\n\r\n    let graphics: GraphicsComponent;\r\n    const graphicsSettings = this._engine.debug.graphics;\r\n\r\n    let debugDraw: DebugGraphicsComponent;\r\n\r\n    let body: BodyComponent;\r\n    const bodySettings = this._engine.debug.body;\r\n\r\n    const cameraSettings = this._engine.debug.camera;\r\n    for (let i = 0; i < this.query.entities.length; i++) {\r\n      const entity = this.query.entities[i];\r\n      if (entity.hasTag('offscreen')) {\r\n        // skip offscreen entities\r\n        continue;\r\n      }\r\n      if (entity instanceof Particle) {\r\n        // Particles crush the renderer :(\r\n        continue;\r\n      }\r\n      if (filterSettings.useFilter) {\r\n        const allIds = filterSettings.ids.length === 0;\r\n        const idMatch = allIds || filterSettings.ids.includes(entity.id);\r\n        if (!idMatch) {\r\n          continue;\r\n        }\r\n        const allNames = filterSettings.nameQuery === '';\r\n        const nameMatch = allNames || entity.name.includes(filterSettings.nameQuery);\r\n        if (!nameMatch) {\r\n          continue;\r\n        }\r\n      }\r\n\r\n      let cursor = Vector.Zero;\r\n      const lineHeight = vec(0, 16);\r\n      id = entity.id;\r\n      name = entity.name;\r\n      tx = entity.get(TransformComponent);\r\n\r\n      // This optionally sets our camera based on the entity coord plan (world vs. screen)\r\n      this._pushCameraTransform(tx);\r\n\r\n      this._graphicsContext.save();\r\n      if (tx.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.translate(this._engine.screen.contentArea.left, this._engine.screen.contentArea.top);\r\n      }\r\n      this._graphicsContext.z = txSettings.debugZIndex;\r\n\r\n      this._applyTransform(entity);\r\n      if (tx) {\r\n        if (txSettings.showAll || txSettings.showPosition) {\r\n          this._graphicsContext.debug.drawPoint(Vector.Zero, { size: 4, color: txSettings.positionColor });\r\n        }\r\n        if (txSettings.showAll || txSettings.showPositionLabel) {\r\n          this._graphicsContext.debug.drawText(`pos${tx.pos.toString(2)}`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n        if (txSettings.showAll || txSettings.showZIndex) {\r\n          this._graphicsContext.debug.drawText(`z(${tx.z.toFixed(1)})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (entitySettings.showAll || entitySettings.showId) {\r\n          this._graphicsContext.debug.drawText(`id(${id}) ${entity.parent ? 'child of id(' + entity.parent?.id + ')' : ''}`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (entitySettings.showAll || entitySettings.showName) {\r\n          this._graphicsContext.debug.drawText(`name(${name})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (txSettings.showAll || txSettings.showRotation) {\r\n          this._graphicsContext.drawLine(\r\n            Vector.Zero,\r\n            Vector.fromAngle(tx.rotation).scale(50).add(Vector.Zero),\r\n            txSettings.rotationColor,\r\n            2\r\n          );\r\n          this._graphicsContext.debug.drawText(`rot deg(${toDegrees(tx.rotation).toFixed(2)})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (txSettings.showAll || txSettings.showScale) {\r\n          this._graphicsContext.drawLine(Vector.Zero, tx.scale.add(Vector.Zero), txSettings.scaleColor, 2);\r\n        }\r\n      }\r\n\r\n      graphics = entity.get(GraphicsComponent);\r\n      if (graphics) {\r\n        if (graphicsSettings.showAll || graphicsSettings.showBounds) {\r\n          const bounds = graphics.localBounds;\r\n          bounds.draw(this._graphicsContext, graphicsSettings.boundsColor);\r\n        }\r\n      }\r\n\r\n      debugDraw = entity.get(DebugGraphicsComponent);\r\n      if (debugDraw) {\r\n        if (!debugDraw.useTransform) {\r\n          this._graphicsContext.restore();\r\n        }\r\n        debugDraw.draw(this._graphicsContext, this._engine.debug);\r\n        if (!debugDraw.useTransform) {\r\n          this._graphicsContext.save();\r\n          this._applyTransform(entity);\r\n        }\r\n      }\r\n\r\n      body = entity.get(BodyComponent);\r\n      if (body) {\r\n        if (bodySettings.showAll || bodySettings.showCollisionGroup) {\r\n          this._graphicsContext.debug.drawText(`collision group(${body.group.name})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showCollisionType) {\r\n          this._graphicsContext.debug.drawText(`collision type(${body.collisionType})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showMass) {\r\n          this._graphicsContext.debug.drawText(`mass(${body.mass})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showMotion) {\r\n          this._graphicsContext.debug.drawText(`motion(${body.sleepMotion})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (bodySettings.showAll || bodySettings.showSleeping) {\r\n          this._graphicsContext.debug.drawText(`sleeping(${body.canSleep ? body.isSleeping : 'cant sleep'})`, cursor);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n      }\r\n\r\n      this._graphicsContext.restore();\r\n\r\n      // World space\r\n      this._graphicsContext.save();\r\n      if (tx.coordPlane === CoordPlane.Screen) {\r\n        this._graphicsContext.translate(this._engine.screen.contentArea.left, this._engine.screen.contentArea.top);\r\n      }\r\n      this._graphicsContext.z = txSettings.debugZIndex;\r\n      motion = entity.get(MotionComponent);\r\n      if (motion) {\r\n        if (motionSettings.showAll || motionSettings.showVelocity) {\r\n          this._graphicsContext.debug.drawText(`vel${motion.vel.toString(2)}`, cursor.add(tx.globalPos));\r\n          this._graphicsContext.drawLine(tx.globalPos, tx.globalPos.add(motion.vel), motionSettings.velocityColor, 2);\r\n          cursor = cursor.add(lineHeight);\r\n        }\r\n\r\n        if (motionSettings.showAll || motionSettings.showAcceleration) {\r\n          this._graphicsContext.drawLine(tx.globalPos, tx.globalPos.add(motion.acc), motionSettings.accelerationColor, 2);\r\n        }\r\n      }\r\n\r\n      // Colliders live in world space already so after the restore()\r\n      colliderComp = entity.get(ColliderComponent);\r\n      if (colliderComp) {\r\n        const collider = colliderComp.get();\r\n        if ((colliderSettings.showAll || colliderSettings.showGeometry) && collider) {\r\n          collider.debug(this._graphicsContext, colliderSettings.geometryColor, {\r\n            lineWidth: colliderSettings.geometryLineWidth,\r\n            pointSize: colliderSettings.geometryPointSize\r\n          });\r\n        }\r\n        if (colliderSettings.showAll || colliderSettings.showBounds) {\r\n          if (collider instanceof CompositeCollider) {\r\n            const colliders = collider.getColliders();\r\n            for (const collider of colliders) {\r\n              const bounds = collider.bounds;\r\n              const pos = vec(bounds.left, bounds.top);\r\n              this._graphicsContext.debug.drawRect(pos.x, pos.y, bounds.width, bounds.height, { color: colliderSettings.boundsColor });\r\n              if (colliderSettings.showAll || colliderSettings.showOwner) {\r\n                this._graphicsContext.debug.drawText(`owner id(${collider.owner.id})`, pos);\r\n              }\r\n            }\r\n            colliderComp.bounds.draw(this._graphicsContext, colliderSettings.boundsColor);\r\n          } else if (collider) {\r\n            const bounds = colliderComp.bounds;\r\n            const pos = vec(bounds.left, bounds.top);\r\n            this._graphicsContext.debug.drawRect(pos.x, pos.y, bounds.width, bounds.height, { color: colliderSettings.boundsColor });\r\n            if (colliderSettings.showAll || colliderSettings.showOwner) {\r\n              this._graphicsContext.debug.drawText(`owner id(${colliderComp.owner.id})`, pos);\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      this._graphicsContext.restore();\r\n      this._popCameraTransform(tx);\r\n    }\r\n\r\n    this._graphicsContext.save();\r\n    this._camera.draw(this._graphicsContext);\r\n    if (physicsSettings.showAll || physicsSettings.showBroadphaseSpacePartitionDebug) {\r\n      this._collisionSystem.debug(this._graphicsContext);\r\n    }\r\n    if (physicsSettings.showAll || physicsSettings.showCollisionContacts || physicsSettings.showCollisionNormals) {\r\n      for (const [_, contact] of this._engine.debug.stats.currFrame.physics.contacts) {\r\n        if (physicsSettings.showAll || physicsSettings.showCollisionContacts) {\r\n          for (const point of contact.points) {\r\n            this._graphicsContext.debug.drawPoint(point, {\r\n              size: physicsSettings.contactSize,\r\n              color: physicsSettings.collisionContactColor\r\n            });\r\n          }\r\n        }\r\n\r\n        if (physicsSettings.showAll || physicsSettings.showCollisionNormals) {\r\n          for (const point of contact.points) {\r\n            this._graphicsContext.debug.drawLine(point, contact.normal.scale(30).add(point), {\r\n              color: physicsSettings.collisionNormalColor\r\n            });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    this._graphicsContext.restore();\r\n\r\n    if (cameraSettings) {\r\n      this._graphicsContext.save();\r\n      this._camera.draw(this._graphicsContext);\r\n      if (cameraSettings.showAll || cameraSettings.showFocus) {\r\n        this._graphicsContext.drawCircle(this._camera.pos, 4, cameraSettings.focusColor);\r\n      }\r\n      if (cameraSettings.showAll || cameraSettings.showZoom) {\r\n        this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`, this._camera.pos);\r\n      }\r\n      this._graphicsContext.restore();\r\n    }\r\n\r\n    this._graphicsContext.flush();\r\n  }\r\n\r\n  postupdate(engine: Scene<unknown>, elapsed: number): void {\r\n    if (this._engine.isDebug) {\r\n      this._graphicsContext.save();\r\n      if (this._camera) {\r\n        this._camera.draw(this._graphicsContext);\r\n      }\r\n      Debug.flush(this._graphicsContext);\r\n      this._graphicsContext.restore();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This applies the current entity transform to the graphics context\r\n   * @param entity\r\n   */\r\n  private _applyTransform(entity: Entity): void {\r\n    const ancestors = entity.getAncestors();\r\n    for (const ancestor of ancestors) {\r\n      const transform = ancestor?.get(TransformComponent);\r\n      if (transform) {\r\n        this._graphicsContext.translate(transform.pos.x, transform.pos.y);\r\n        this._graphicsContext.scale(transform.scale.x, transform.scale.y);\r\n        this._graphicsContext.rotate(transform.rotation);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Applies the current camera transform if in world coordinates\r\n   * @param transform\r\n   */\r\n  private _pushCameraTransform(transform: TransformComponent) {\r\n    // Establish camera offset per entity\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      this._graphicsContext.save();\r\n      if (this._camera) {\r\n        this._camera.draw(this._graphicsContext);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Resets the current camera transform if in world coordinates\r\n   * @param transform\r\n   */\r\n  private _popCameraTransform(transform: TransformComponent) {\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      // Apply camera world offset\r\n      this._graphicsContext.restore();\r\n    }\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { RentalPool } from '../../Util/RentalPool';\r\nimport { BoundingBox } from '../BoundingBox';\r\n\r\nexport class HashGridProxy<T extends { bounds: BoundingBox }> {\r\n  id: number = -1;\r\n  /**\r\n   * left bounds x hash coordinate\r\n   */\r\n  leftX: number;\r\n  /**\r\n   * right bounds x hash coordinate\r\n   */\r\n  rightX: number;\r\n  /**\r\n   * bottom bounds y hash coordinate\r\n   */\r\n  bottomY: number;\r\n  /**\r\n   * top bounds y hash coordinate\r\n   */\r\n  topY: number;\r\n\r\n  bounds: BoundingBox;\r\n\r\n  cells: HashGridCell<T>[] = [];\r\n  hasZeroBounds = false;\r\n  /**\r\n   * Grid size in pixels\r\n   */\r\n  readonly gridSize: number;\r\n  constructor(\r\n    public object: T,\r\n    gridSize: number\r\n  ) {\r\n    this.gridSize = gridSize;\r\n    this.bounds = object.bounds;\r\n    this.hasZeroBounds = this.bounds.hasZeroDimensions();\r\n    this.leftX = Math.floor(this.bounds.left / this.gridSize);\r\n    this.rightX = Math.floor(this.bounds.right / this.gridSize);\r\n    this.bottomY = Math.floor(this.bounds.bottom / this.gridSize);\r\n    this.topY = Math.floor(this.bounds.top / this.gridSize);\r\n  }\r\n\r\n  /**\r\n   * Has the hashed bounds changed\r\n   */\r\n  hasChanged(): boolean {\r\n    const bounds = this.object.bounds;\r\n    const leftX = Math.floor(bounds.left / this.gridSize);\r\n    const rightX = Math.floor(bounds.right / this.gridSize);\r\n    const bottomY = Math.floor(bounds.bottom / this.gridSize);\r\n    const topY = Math.floor(bounds.top / this.gridSize);\r\n    if (this.leftX !== leftX || this.rightX !== rightX || this.bottomY !== bottomY || this.topY !== topY) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Clears all collider references\r\n   */\r\n  clear(): void {\r\n    for (const cell of this.cells) {\r\n      const index = cell.proxies.indexOf(this);\r\n      if (index > -1) {\r\n        cell.proxies.splice(index, 1);\r\n      }\r\n      // TODO reclaim cell in pool if empty?\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update bounds of the proxy\r\n   */\r\n  updateBounds(): void {\r\n    this.bounds = this.object.bounds;\r\n  }\r\n\r\n  /**\r\n   * Updates the hashed bounds coordinates\r\n   */\r\n  update(): void {\r\n    this.bounds = this.object.bounds;\r\n\r\n    this.leftX = Math.floor(this.bounds.left / this.gridSize);\r\n    this.rightX = Math.floor(this.bounds.right / this.gridSize);\r\n    this.bottomY = Math.floor(this.bounds.bottom / this.gridSize);\r\n    this.topY = Math.floor(this.bounds.top / this.gridSize);\r\n    this.hasZeroBounds = this.object.bounds.hasZeroDimensions();\r\n  }\r\n}\r\n\r\nexport class HashGridCell<TObject extends { bounds: BoundingBox }, TProxy extends HashGridProxy<TObject> = HashGridProxy<TObject>> {\r\n  proxies: TProxy[] = [];\r\n  key: string;\r\n  x: number;\r\n  y: number;\r\n\r\n  configure(x: number, y: number) {\r\n    this.x = x;\r\n    this.y = y;\r\n    this.key = HashGridCell.calculateHashKey(x, y);\r\n  }\r\n\r\n  static calculateHashKey(x: number, y: number) {\r\n    return `${x}+${y}`;\r\n  }\r\n}\r\n\r\nexport class SparseHashGrid<TObject extends { bounds: BoundingBox }, TProxy extends HashGridProxy<TObject> = HashGridProxy<TObject>> {\r\n  readonly gridSize: number;\r\n  readonly sparseHashGrid: Map<string, HashGridCell<TObject, TProxy>>;\r\n  readonly objectToProxy: Map<TObject, TProxy>;\r\n\r\n  public bounds = new BoundingBox();\r\n\r\n  private _hashGridCellPool = new RentalPool<HashGridCell<TObject, TProxy>>(\r\n    () => new HashGridCell(),\r\n    (instance) => {\r\n      instance.configure(0, 0);\r\n      instance.proxies.length = 0;\r\n      return instance;\r\n    },\r\n    1000\r\n  );\r\n\r\n  private _buildProxy: (object: TObject) => TProxy;\r\n\r\n  constructor(options: { size: number; proxyFactory?: (object: TObject, gridSize: number) => TProxy }) {\r\n    this.gridSize = options.size;\r\n    this.sparseHashGrid = new Map<string, HashGridCell<TObject, TProxy>>();\r\n    this.objectToProxy = new Map<TObject, TProxy>();\r\n    if (options.proxyFactory) {\r\n      this._buildProxy = (object: TObject) => options.proxyFactory(object, this.gridSize);\r\n    } else {\r\n      this._buildProxy = (object: TObject) => new HashGridProxy(object, this.gridSize) as TProxy;\r\n    }\r\n\r\n    // TODO dynamic grid size potentially larger than the largest collider\r\n    // TODO Re-hash the objects if the median proves to be different\r\n  }\r\n\r\n  query(point: Vector): TObject[];\r\n  query(bounds: BoundingBox): TObject[];\r\n  query(boundsOrPoint: BoundingBox | Vector): TObject[] {\r\n    const results = new Set<TObject>();\r\n    if (boundsOrPoint instanceof BoundingBox) {\r\n      const bounds = boundsOrPoint;\r\n      const leftX = Math.floor(bounds.left / this.gridSize);\r\n      const rightX = Math.floor(bounds.right / this.gridSize);\r\n      const bottomY = Math.floor(bounds.bottom / this.gridSize);\r\n      const topY = Math.floor(bounds.top / this.gridSize);\r\n      for (let x = leftX; x <= rightX; x++) {\r\n        for (let y = topY; y <= bottomY; y++) {\r\n          const key = HashGridCell.calculateHashKey(x, y);\r\n          // Hash bounds into appropriate cell\r\n          const cell = this.sparseHashGrid.get(key);\r\n          if (cell) {\r\n            for (let i = 0; i < cell.proxies.length; i++) {\r\n              cell.proxies[i].updateBounds();\r\n              if (cell.proxies[i].bounds.intersect(bounds)) {\r\n                results.add(cell.proxies[i].object);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    } else {\r\n      const point = boundsOrPoint;\r\n      const key = HashGridCell.calculateHashKey(Math.floor(point.x / this.gridSize), Math.floor(point.y / this.gridSize));\r\n      // Hash points into appropriate cell\r\n      const cell = this.sparseHashGrid.get(key);\r\n      if (cell) {\r\n        for (let i = 0; i < cell.proxies.length; i++) {\r\n          cell.proxies[i].updateBounds();\r\n          if (cell.proxies[i].bounds.contains(point)) {\r\n            results.add(cell.proxies[i].object);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return Array.from(results);\r\n  }\r\n\r\n  get(xCoord: number, yCoord: number): HashGridCell<TObject> {\r\n    const key = HashGridCell.calculateHashKey(xCoord, yCoord);\r\n    const cell = this.sparseHashGrid.get(key);\r\n    return cell;\r\n  }\r\n\r\n  private _insert(x: number, y: number, proxy: TProxy): void {\r\n    const key = HashGridCell.calculateHashKey(x, y);\r\n    // Hash collider into appropriate cell\r\n    let cell = this.sparseHashGrid.get(key);\r\n    if (!cell) {\r\n      cell = this._hashGridCellPool.rent();\r\n      cell.configure(x, y);\r\n      this.sparseHashGrid.set(cell.key, cell);\r\n    }\r\n    cell.proxies.push(proxy);\r\n    proxy.cells.push(cell); // TODO dupes, doesn't seem to be a problem\r\n    this.bounds.combine(proxy.bounds, this.bounds);\r\n  }\r\n\r\n  private _remove(x: number, y: number, proxy: TProxy): void {\r\n    const key = HashGridCell.calculateHashKey(x, y);\r\n    // Hash collider into appropriate cell\r\n    const cell = this.sparseHashGrid.get(key);\r\n    if (cell) {\r\n      const proxyIndex = cell.proxies.indexOf(proxy);\r\n      if (proxyIndex > -1) {\r\n        cell.proxies.splice(proxyIndex, 1);\r\n      }\r\n      const cellIndex = proxy.cells.indexOf(cell);\r\n      if (cellIndex > -1) {\r\n        proxy.cells.splice(cellIndex, 1);\r\n      }\r\n      if (cell.proxies.length === 0) {\r\n        this._hashGridCellPool.return(cell);\r\n        this.sparseHashGrid.delete(key);\r\n      }\r\n    }\r\n  }\r\n\r\n  track(target: TObject): void {\r\n    const proxy = this._buildProxy(target);\r\n    this.objectToProxy.set(target, proxy);\r\n    for (let x = proxy.leftX; x <= proxy.rightX; x++) {\r\n      for (let y = proxy.topY; y <= proxy.bottomY; y++) {\r\n        this._insert(x, y, proxy);\r\n      }\r\n    }\r\n  }\r\n\r\n  untrack(target: TObject): void {\r\n    const proxy = this.objectToProxy.get(target);\r\n    if (proxy) {\r\n      proxy.clear();\r\n      this.objectToProxy.delete(target);\r\n    }\r\n  }\r\n\r\n  update(targets: TObject[]): number {\r\n    let updated = 0;\r\n    // FIXME resetting bounds is wrong, if nothing has updated then\r\n    // the bounds stay 0\r\n    // this.bounds.reset();\r\n    for (const target of targets) {\r\n      const proxy = this.objectToProxy.get(target);\r\n      if (!proxy) {\r\n        continue;\r\n      }\r\n      if (proxy.hasChanged()) {\r\n        // TODO slightly wasteful only remove from changed\r\n        for (let x = proxy.leftX; x <= proxy.rightX; x++) {\r\n          for (let y = proxy.topY; y <= proxy.bottomY; y++) {\r\n            this._remove(x, y, proxy);\r\n          }\r\n        }\r\n        proxy.update();\r\n        // TODO slightly wasteful only add new\r\n        for (let x = proxy.leftX; x <= proxy.rightX; x++) {\r\n          for (let y = proxy.topY; y <= proxy.bottomY; y++) {\r\n            this._insert(x, y, proxy);\r\n          }\r\n        }\r\n        updated++;\r\n      }\r\n    }\r\n    return updated;\r\n  }\r\n\r\n  debug(ex: ExcaliburGraphicsContext, elapsed: number): void {\r\n    const transparent = Color.Transparent;\r\n    const color = Color.White;\r\n    for (const cell of this.sparseHashGrid.values()) {\r\n      ex.drawRectangle(vec(cell.x * this.gridSize, cell.y * this.gridSize), this.gridSize, this.gridSize, transparent, color, 2);\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { System, TransformComponent, SystemType, Entity, World, Query, SystemPriority } from '../EntityComponentSystem';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Scene } from '../Scene';\r\nimport { PointerComponent } from './PointerComponent';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { SparseHashGrid } from '../Collision/Detection/SparseHashGrid';\r\nimport { PointerEventsToObjectDispatcher } from './PointerEventsToObjectDispatcher';\r\n\r\n/**\r\n * The PointerSystem is responsible for dispatching pointer events to entities\r\n * that need them.\r\n *\r\n * The PointerSystem can be optionally configured by the {@apilink PointerComponent}, by default Entities use\r\n * the {@apilink Collider}'s shape for pointer events.\r\n */\r\nexport class PointerSystem extends System {\r\n  static priority = SystemPriority.Higher;\r\n\r\n  public readonly systemType = SystemType.Update;\r\n\r\n  private _engine: Engine;\r\n  private _receivers: PointerEventReceiver[];\r\n  private _engineReceiver: PointerEventReceiver;\r\n  private _graphicsHashGrid = new SparseHashGrid<GraphicsComponent>({ size: 100 });\r\n  private _graphics: GraphicsComponent[] = [];\r\n  private _entityToPointer = new Map<Entity, PointerComponent>();\r\n  private _pointerEventDispatcher = new PointerEventsToObjectDispatcher();\r\n\r\n  query: Query<typeof TransformComponent | typeof PointerComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, PointerComponent]);\r\n\r\n    this.query.entityAdded$.subscribe((e) => {\r\n      const tx = e.get(TransformComponent);\r\n      const pointer = e.get(PointerComponent);\r\n      this._pointerEventDispatcher.addObject(\r\n        e,\r\n        (pos) => {\r\n          // If pointer bounds defined\r\n          if (pointer && pointer.localBounds) {\r\n            const pointerBounds = pointer.localBounds.transform(tx.get().matrix);\r\n            return pointerBounds.contains(tx.coordPlane === CoordPlane.World ? pos.worldPos : pos.screenPos);\r\n          }\r\n          return false;\r\n        },\r\n        () => e.isActive\r\n      );\r\n      this._entityToPointer.set(e, pointer);\r\n      const maybeGfx = e.get(GraphicsComponent);\r\n      if (maybeGfx) {\r\n        this._graphics.push(maybeGfx);\r\n        this._graphicsHashGrid.track(maybeGfx);\r\n      }\r\n      this._sortedTransforms.push(tx);\r\n      this._sortedEntities.push(tx.owner);\r\n      tx.zIndexChanged$.subscribe(this._zIndexUpdate);\r\n      this._zHasChanged = true;\r\n    });\r\n\r\n    this.query.entityRemoved$.subscribe((e) => {\r\n      this._pointerEventDispatcher.removeObject(e);\r\n      const tx = e.get(TransformComponent);\r\n      this._entityToPointer.delete(e);\r\n      const maybeGfx = e.get(GraphicsComponent);\r\n      if (maybeGfx) {\r\n        const index = this._graphics.indexOf(maybeGfx);\r\n        if (index > -1) {\r\n          this._graphics.splice(index, 1);\r\n        }\r\n        this._graphicsHashGrid.untrack(maybeGfx);\r\n      }\r\n      tx.zIndexChanged$.unsubscribe(this._zIndexUpdate);\r\n      const index = this._sortedTransforms.indexOf(tx);\r\n      if (index > -1) {\r\n        this._sortedTransforms.splice(index, 1);\r\n        this._sortedEntities.splice(index, 1);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Optionally override component configuration for all entities\r\n   */\r\n  public overrideUseColliderShape = false;\r\n  /**\r\n   * Optionally override component configuration for all entities\r\n   */\r\n  public overrideUseGraphicsBounds = false;\r\n\r\n  private _scene: Scene<unknown>;\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._engine = scene.engine;\r\n    this._scene = scene;\r\n  }\r\n\r\n  private _sortedTransforms: TransformComponent[] = [];\r\n  private _sortedEntities: Entity[] = [];\r\n\r\n  private _zHasChanged = false;\r\n  private _zIndexUpdate = () => {\r\n    this._zHasChanged = true;\r\n  };\r\n\r\n  public preupdate(): void {\r\n    if (this._scene.camera.hasChanged()) {\r\n      // if the camera has changed we want to force a transform update so pointers can be correctly calc'd\r\n      this._scene.camera.updateTransform(this._scene.camera.pos);\r\n    }\r\n\r\n    // event receiver might change per frame\r\n    this._receivers = [this._engine.input.pointers, this._scene.input.pointers];\r\n    this._engineReceiver = this._engine.input.pointers;\r\n    if (this._zHasChanged) {\r\n      this._sortedTransforms.sort((a, b) => {\r\n        return b.z - a.z;\r\n      });\r\n      this._sortedEntities = this._sortedTransforms.map((t) => t.owner);\r\n      this._zHasChanged = false;\r\n    }\r\n  }\r\n\r\n  public update(): void {\r\n    // Update graphics\r\n    this._graphicsHashGrid.update(this._graphics);\r\n\r\n    // Locate all the pointer/entity mappings\r\n    for (const [pointerId, pos] of this._engineReceiver.currentFramePointerCoords.entries()) {\r\n      const colliders = this._scene.physics.query(pos.worldPos);\r\n      for (let i = 0; i < colliders.length; i++) {\r\n        const collider = colliders[i];\r\n        const maybePointer = this._entityToPointer.get(collider.owner);\r\n        if (maybePointer && (maybePointer.useColliderShape || this.overrideUseColliderShape)) {\r\n          this._pointerEventDispatcher.addPointerToObject(collider.owner, pointerId);\r\n        }\r\n      }\r\n\r\n      const graphics = this._graphicsHashGrid.query(pos.worldPos);\r\n      for (let i = 0; i < graphics.length; i++) {\r\n        const graphic = graphics[i];\r\n        const maybePointer = this._entityToPointer.get(graphic.owner);\r\n        if (maybePointer && (maybePointer.useGraphicsBounds || this.overrideUseGraphicsBounds)) {\r\n          this._pointerEventDispatcher.addPointerToObject(graphic.owner, pointerId);\r\n        }\r\n      }\r\n    }\r\n\r\n    this._pointerEventDispatcher.processPointerToObject(this._engineReceiver, this._sortedEntities);\r\n\r\n    // Dispatch pointer events on entities\r\n    this._pointerEventDispatcher.dispatchEvents(this._engineReceiver, this._sortedEntities);\r\n\r\n    // Dispatch pointer events on top level pointers\r\n    this._receivers.forEach((r) => r.update());\r\n\r\n    // Clear last frame's events\r\n    this._pointerEventDispatcher.clear();\r\n\r\n    this._receivers.forEach((r) => r.clear());\r\n  }\r\n}\r\n","import { Query, SystemPriority, World } from '../EntityComponentSystem';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ActionsComponent } from './ActionsComponent';\r\n\r\nexport class ActionsSystem extends System {\r\n  static priority = SystemPriority.Higher;\r\n\r\n  systemType = SystemType.Update;\r\n  private _actions: ActionsComponent[] = [];\r\n  query: Query<typeof ActionsComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([ActionsComponent]);\r\n\r\n    this.query.entityAdded$.subscribe((e) => this._actions.push(e.get(ActionsComponent)));\r\n    this.query.entityRemoved$.subscribe((e) => {\r\n      const action = e.get(ActionsComponent);\r\n      const index = this._actions.indexOf(action);\r\n      if (index > -1) {\r\n        this._actions.splice(index, 1);\r\n      }\r\n    });\r\n  }\r\n  update(elapsed: number): void {\r\n    for (let i = 0; i < this._actions.length; i++) {\r\n      const action = this._actions[i];\r\n      action.update(elapsed);\r\n    }\r\n  }\r\n}\r\n","import { Component } from '../EntityComponentSystem/Component';\r\nimport { IsometricMap } from './IsometricMap';\r\n\r\nexport interface IsometricEntityComponentOptions {\r\n  columns: number;\r\n  rows: number;\r\n  tileWidth: number;\r\n  tileHeight: number;\r\n}\r\n\r\nexport class IsometricEntityComponent extends Component {\r\n  /**\r\n   * Vertical \"height\" in the isometric world\r\n   */\r\n  public elevation: number = 0;\r\n\r\n  public readonly columns: number;\r\n  public readonly rows: number;\r\n  public readonly tileWidth: number;\r\n  public readonly tileHeight: number;\r\n\r\n  /**\r\n   * Specify the isometric map to use to position this entity's z-index\r\n   * @param mapOrOptions\r\n   */\r\n  constructor(mapOrOptions: IsometricMap | IsometricEntityComponentOptions) {\r\n    super();\r\n    this.columns = mapOrOptions.columns;\r\n    this.rows = mapOrOptions.rows;\r\n    this.tileWidth = mapOrOptions.tileWidth;\r\n    this.tileHeight = mapOrOptions.tileHeight;\r\n  }\r\n}\r\n","import { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { IsometricEntityComponent } from './IsometricEntityComponent';\r\nimport { Query, SystemPriority, World } from '../EntityComponentSystem';\r\n\r\nexport class IsometricEntitySystem extends System {\r\n  static priority: number = SystemPriority.Lower;\r\n\r\n  public readonly systemType = SystemType.Update;\r\n  query: Query<typeof TransformComponent | typeof IsometricEntityComponent>;\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, IsometricEntityComponent]);\r\n  }\r\n\r\n  update(): void {\r\n    let transform: TransformComponent;\r\n    let iso: IsometricEntityComponent;\r\n    for (let i = 0; i < this.query.entities.length; i++) {\r\n      const entity = this.query.entities[i];\r\n      transform = entity.get(TransformComponent);\r\n      iso = entity.get(IsometricEntityComponent);\r\n\r\n      const maxZindexPerElevation = Math.max(iso.columns * iso.tileWidth, iso.rows * iso.tileHeight);\r\n\r\n      const newZ = maxZindexPerElevation * iso.elevation + transform.pos.y;\r\n      transform.z = newZ;\r\n    }\r\n  }\r\n}\r\n","import { GraphicsComponent } from './GraphicsComponent';\r\nimport { EnterViewPortEvent, ExitViewPortEvent } from '../Events';\r\nimport { Scene } from '../Scene';\r\nimport { Screen } from '../Screen';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Camera } from '../Camera';\r\nimport { System, SystemType } from '../EntityComponentSystem/System';\r\nimport { ParallaxComponent } from './ParallaxComponent';\r\nimport { Vector } from '../Math/vector';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Query, SystemPriority, World } from '../EntityComponentSystem';\r\n\r\nexport class OffscreenSystem extends System {\r\n  static priority: number = SystemPriority.Higher;\r\n\r\n  public systemType = SystemType.Draw;\r\n  private _camera!: Camera;\r\n  private _screen!: Screen;\r\n  private _worldBounds!: BoundingBox;\r\n  query: Query<typeof TransformComponent | typeof GraphicsComponent>;\r\n\r\n  constructor(public world: World) {\r\n    super();\r\n    this.query = this.world.query([TransformComponent, GraphicsComponent]);\r\n  }\r\n\r\n  public initialize(world: World, scene: Scene): void {\r\n    this._camera = scene.camera;\r\n    this._screen = scene.engine.screen;\r\n  }\r\n\r\n  update(): void {\r\n    this._worldBounds = this._screen.getWorldBounds();\r\n    let transform: TransformComponent;\r\n    let graphics: GraphicsComponent;\r\n    let maybeParallax: ParallaxComponent | undefined;\r\n\r\n    for (let i = 0; i < this.query.entities.length; i++) {\r\n      const entity = this.query.entities[i];\r\n      graphics = entity.get(GraphicsComponent);\r\n      transform = entity.get(TransformComponent);\r\n      maybeParallax = entity.get(ParallaxComponent);\r\n\r\n      let parallaxOffset: Vector | undefined;\r\n      if (maybeParallax) {\r\n        // We use the Tiled formula\r\n        // https://doc.mapeditor.org/en/latest/manual/layers/#parallax-scrolling-factor\r\n        // cameraPos * (1 - parallaxFactor)\r\n        const oneMinusFactor = Vector.One.sub(maybeParallax.parallaxFactor);\r\n        parallaxOffset = this._camera.pos.scale(oneMinusFactor);\r\n      }\r\n\r\n      // Figure out if entities are offscreen\r\n      const entityOffscreen = this._isOffscreen(transform, graphics, parallaxOffset);\r\n      if (entityOffscreen && !entity.hasTag('ex.offscreen')) {\r\n        entity.events.emit('exitviewport', new ExitViewPortEvent(entity));\r\n        entity.addTag('ex.offscreen');\r\n      }\r\n\r\n      if (!entityOffscreen && entity.hasTag('ex.offscreen')) {\r\n        entity.events.emit('enterviewport', new EnterViewPortEvent(entity));\r\n        entity.removeTag('ex.offscreen');\r\n      }\r\n    }\r\n  }\r\n\r\n  private _isOffscreen(transform: TransformComponent, graphics: GraphicsComponent, parallaxOffset: Vector | undefined) {\r\n    if (graphics.forceOnScreen) {\r\n      return false;\r\n    }\r\n    if (transform.coordPlane === CoordPlane.World) {\r\n      let bounds = graphics.localBounds;\r\n      if (parallaxOffset) {\r\n        bounds = bounds.translate(parallaxOffset);\r\n      }\r\n      const transformedBounds = bounds.transform(transform.get().matrix);\r\n      const graphicsOffscreen = !this._worldBounds.overlaps(transformedBounds);\r\n      return graphicsOffscreen;\r\n    } else {\r\n      // TODO screen coordinates\r\n      return false;\r\n    }\r\n  }\r\n}\r\n","import { FrameStats } from '../../Debug/DebugConfig';\r\nimport { Entity } from '../../EntityComponentSystem';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics/Context/ExcaliburGraphicsContext';\r\nimport { createId } from '../../Id';\r\nimport { Ray } from '../../Math/ray';\r\nimport { Vector, vec } from '../../Math/vector';\r\nimport { Pool } from '../../Util/Pool';\r\nimport { BodyComponent } from '../BodyComponent';\r\nimport { BoundingBox } from '../BoundingBox';\r\nimport { Collider } from '../Colliders/Collider';\r\nimport { CompositeCollider } from '../Colliders/CompositeCollider';\r\nimport { CollisionType } from '../CollisionType';\r\nimport { CollisionGroup } from '../Group/CollisionGroup';\r\nimport { CollisionContact } from './CollisionContact';\r\nimport { CollisionProcessor } from './CollisionProcessor';\r\nimport { Pair } from './Pair';\r\nimport { RayCastHit } from './RayCastHit';\r\nimport { RayCastOptions } from './RayCastOptions';\r\nimport { HashGridCell, HashGridProxy, SparseHashGrid } from './SparseHashGrid';\r\n\r\n/**\r\n * Proxy type to stash collision info\r\n */\r\nexport class HashColliderProxy extends HashGridProxy<Collider> {\r\n  id: number = -1;\r\n  owner: Entity;\r\n  body: BodyComponent;\r\n  collisionType: CollisionType;\r\n  hasZeroBounds = false;\r\n  /**\r\n   * left bounds x hash coordinate\r\n   */\r\n  leftX: number;\r\n  /**\r\n   * right bounds x hash coordinate\r\n   */\r\n  rightX: number;\r\n  /**\r\n   * bottom bounds y hash coordinate\r\n   */\r\n  bottomY: number;\r\n  /**\r\n   * top bounds y hash coordinate\r\n   */\r\n  topY: number;\r\n  /**\r\n   * References to the hash cell the collider is a current member of\r\n   */\r\n  cells: HashGridCell<Collider, HashColliderProxy>[] = [];\r\n  /**\r\n   * Grid size in pixels\r\n   */\r\n  readonly gridSize: number;\r\n  constructor(\r\n    public collider: Collider,\r\n    gridSize: number\r\n  ) {\r\n    super(collider, gridSize);\r\n    this.gridSize = gridSize;\r\n    const bounds = collider.bounds;\r\n    this.hasZeroBounds = bounds.hasZeroDimensions();\r\n    this.leftX = Math.floor(bounds.left / this.gridSize);\r\n    this.rightX = Math.floor(bounds.right / this.gridSize);\r\n    this.bottomY = Math.floor(bounds.bottom / this.gridSize);\r\n    this.topY = Math.floor(bounds.top / this.gridSize);\r\n    this.owner = collider.owner;\r\n    this.body = this.owner?.get(BodyComponent);\r\n    this.collisionType = this.body.collisionType ?? CollisionType.PreventCollision;\r\n  }\r\n\r\n  /**\r\n   * Updates the hashed bounds coordinates\r\n   */\r\n  update(): void {\r\n    super.update();\r\n    this.body = this.owner?.get(BodyComponent);\r\n    this.collisionType = this.body.collisionType ?? CollisionType.PreventCollision;\r\n    this.hasZeroBounds = this.collider.localBounds.hasZeroDimensions();\r\n  }\r\n}\r\n\r\n/**\r\n * This collision processor uses a sparsely populated grid of uniform cells to bucket potential\r\n * colliders together for the purpose of detecting collision pairs and collisions.\r\n */\r\nexport class SparseHashGridCollisionProcessor implements CollisionProcessor {\r\n  readonly gridSize: number;\r\n  readonly hashGrid: SparseHashGrid<Collider, HashColliderProxy>;\r\n\r\n  private _pairs = new Set<string>();\r\n  private _nonPairs = new Set<string>();\r\n\r\n  public _pairPool = new Pool<Pair>(\r\n    () => new Pair({ id: createId('collider', 0) } as Collider, { id: createId('collider', 0) } as Collider),\r\n    (instance) => {\r\n      instance.colliderA = null;\r\n      instance.colliderB = null;\r\n      return instance;\r\n    },\r\n    200\r\n  );\r\n\r\n  constructor(options: { size: number }) {\r\n    this.gridSize = options.size;\r\n    this.hashGrid = new SparseHashGrid<Collider, HashColliderProxy>({\r\n      size: this.gridSize,\r\n      proxyFactory: (collider, size) => new HashColliderProxy(collider, size)\r\n    });\r\n    this._pairPool.disableWarnings = true;\r\n\r\n    // TODO dynamic grid size potentially larger than the largest collider\r\n    // TODO Re-hash the objects if the median proves to be different\r\n  }\r\n\r\n  getColliders(): readonly Collider[] {\r\n    return Array.from(this.hashGrid.objectToProxy.keys());\r\n  }\r\n\r\n  query(point: Vector): Collider[];\r\n  query(bound: BoundingBox): Collider[];\r\n  query(boundsOrPoint: Vector | BoundingBox): Collider[] {\r\n    // FIXME workaround TS: https://github.com/microsoft/TypeScript/issues/14107\r\n    return this.hashGrid.query(boundsOrPoint as any);\r\n  }\r\n\r\n  rayCast(ray: Ray, options?: RayCastOptions): RayCastHit[] {\r\n    // DDA raycast algo\r\n    const results: RayCastHit[] = [];\r\n    const maxDistance = options?.maxDistance ?? Infinity;\r\n    const collisionGroup = options?.collisionGroup;\r\n    const collisionMask = !collisionGroup ? options?.collisionMask ?? CollisionGroup.All.category : collisionGroup.category;\r\n    const searchAllColliders = options?.searchAllColliders ?? false;\r\n\r\n    const unitRay = ray.dir.normalize();\r\n\r\n    const dydx = unitRay.y / unitRay.x;\r\n    const dxdy = unitRay.x / unitRay.y;\r\n\r\n    const unitStepX = Math.sqrt(1 + dydx * dydx) * this.gridSize;\r\n    const unitStepY = Math.sqrt(1 + dxdy * dxdy) * this.gridSize;\r\n\r\n    const startXCoord = ray.pos.x / this.gridSize;\r\n    const startYCoord = ray.pos.y / this.gridSize;\r\n\r\n    const stepDir = vec(1, 1);\r\n\r\n    let currentXCoord = ~~startXCoord;\r\n    let currentYCoord = ~~startYCoord;\r\n    let currentRayLengthX = 0;\r\n    let currentRayLengthY = 0;\r\n\r\n    if (unitRay.x < 0) {\r\n      stepDir.x = -1;\r\n      currentRayLengthX = (startXCoord - currentXCoord) * unitStepX;\r\n    } else {\r\n      stepDir.x = 1;\r\n      currentRayLengthX = (currentXCoord + 1 - startXCoord) * unitStepX;\r\n    }\r\n\r\n    if (unitRay.y < 0) {\r\n      stepDir.y = -1;\r\n      currentRayLengthY = (startYCoord - currentYCoord) * unitStepY;\r\n    } else {\r\n      stepDir.y = 1;\r\n      currentRayLengthY = (currentYCoord + 1 - startYCoord) * unitStepY;\r\n    }\r\n\r\n    const collidersVisited = new Set<number>();\r\n\r\n    let done = false;\r\n    let maxIterations = 9999;\r\n    while (!done && maxIterations > 0) {\r\n      maxIterations--; // safety exit\r\n      // exit if exhausted max hash grid coordinate, bounds of the sparse grid\r\n      if (!this.hashGrid.bounds.contains(vec(currentXCoord * this.gridSize, currentYCoord * this.gridSize))) {\r\n        break;\r\n      }\r\n      // Test colliders at cell\r\n      const key = HashGridCell.calculateHashKey(currentXCoord, currentYCoord);\r\n      const cell = this.hashGrid.sparseHashGrid.get(key);\r\n      if (cell) {\r\n        const cellHits: RayCastHit[] = [];\r\n        for (let colliderIndex = 0; colliderIndex < cell.proxies.length; colliderIndex++) {\r\n          const collider = cell.proxies[colliderIndex];\r\n          if (!collidersVisited.has(collider.collider.id.value)) {\r\n            collidersVisited.add(collider.collider.id.value);\r\n\r\n            if (options?.ignoreCollisionGroupAll && collider.body.group === CollisionGroup.All) {\r\n              continue;\r\n            }\r\n\r\n            const canCollide = (collisionMask & collider.body.group.category) !== 0;\r\n\r\n            // Early exit if not the right group\r\n            if (collider.body.group && !canCollide) {\r\n              continue;\r\n            }\r\n\r\n            const hit = collider.collider.rayCast(ray, maxDistance);\r\n\r\n            // Collect up all the colliders that hit inside a cell\r\n            // they can be in any order so we need to sort them next\r\n            if (hit) {\r\n              cellHits.push(hit);\r\n            }\r\n          }\r\n        }\r\n        cellHits.sort((hit1, hit2) => hit1.distance - hit2.distance);\r\n        for (let i = 0; i < cellHits.length; i++) {\r\n          const hit = cellHits[i];\r\n          if (options?.filter) {\r\n            if (options.filter(hit)) {\r\n              results.push(hit);\r\n              if (!searchAllColliders) {\r\n                done = true;\r\n                break;\r\n              }\r\n            }\r\n          } else {\r\n            results.push(hit);\r\n            if (!searchAllColliders) {\r\n              done = true;\r\n              break;\r\n            }\r\n          }\r\n        }\r\n      }\r\n\r\n      if (currentRayLengthX < currentRayLengthY) {\r\n        currentXCoord += stepDir.x;\r\n        currentRayLengthX += unitStepX;\r\n      } else {\r\n        currentYCoord += stepDir.y;\r\n        currentRayLengthY += unitStepY;\r\n      }\r\n    }\r\n\r\n    // Sort by distance\r\n    results.sort((hit1, hit2) => hit1.distance - hit2.distance);\r\n    if (!searchAllColliders && results.length) {\r\n      return [results[0]];\r\n    }\r\n    return results;\r\n  }\r\n\r\n  /**\r\n   * Adds the collider to the internal data structure for collision tracking\r\n   * @param target\r\n   */\r\n  track(target: Collider): void {\r\n    let colliders = [target];\r\n    if (target instanceof CompositeCollider) {\r\n      const compColliders = target.getColliders();\r\n      for (const c of compColliders) {\r\n        c.owner = target.owner;\r\n      }\r\n      colliders = compColliders;\r\n    }\r\n\r\n    for (const target of colliders) {\r\n      this.hashGrid.track(target);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the internal data structure for tracking collisions\r\n   * @param target\r\n   */\r\n  untrack(target: Collider): void {\r\n    let colliders = [target];\r\n    if (target instanceof CompositeCollider) {\r\n      colliders = target.getColliders();\r\n    }\r\n\r\n    for (const target of colliders) {\r\n      this.hashGrid.untrack(target);\r\n    }\r\n  }\r\n\r\n  private _canCollide(colliderA: HashColliderProxy, colliderB: HashColliderProxy) {\r\n    // Prevent self collision\r\n    if (colliderA.collider.id === colliderB.collider.id) {\r\n      return false;\r\n    }\r\n\r\n    // Colliders with the same owner do not collide (composite colliders)\r\n    if (colliderA.owner && colliderB.owner && colliderA.owner.id === colliderB.owner.id) {\r\n      return false;\r\n    }\r\n\r\n    // if the pair has a member with zero dimension don't collide\r\n    if (colliderA.hasZeroBounds || colliderB.hasZeroBounds) {\r\n      return false;\r\n    }\r\n\r\n    // If both are in the same collision group short circuit\r\n    if (!colliderA.body.group.canCollide(colliderB.body.group)) {\r\n      return false;\r\n    }\r\n\r\n    // if both are fixed short circuit\r\n    if (colliderA.collisionType === CollisionType.Fixed && colliderB.collisionType === CollisionType.Fixed) {\r\n      return false;\r\n    }\r\n\r\n    // if the either is prevent collision short circuit\r\n    if (colliderA.collisionType === CollisionType.PreventCollision || colliderB.collisionType === CollisionType.PreventCollision) {\r\n      return false;\r\n    }\r\n\r\n    // if either is dead short circuit\r\n    if (!colliderA.owner.isActive || !colliderB.owner.isActive) {\r\n      return false;\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Runs the broadphase sweep over tracked colliders and returns possible collision pairs\r\n   * @param targets\r\n   * @param elapsed\r\n   */\r\n  broadphase(targets: Collider[], elapsed: number): Pair[] {\r\n    const pairs: Pair[] = [];\r\n    this._pairs.clear();\r\n    this._nonPairs.clear();\r\n\r\n    let proxyId = 0;\r\n    for (const proxy of this.hashGrid.objectToProxy.values()) {\r\n      proxy.id = proxyId++; // track proxies we've already processed\r\n      if (!proxy.owner.isActive || proxy.collisionType === CollisionType.PreventCollision) {\r\n        continue;\r\n      }\r\n      // for every cell proxy collider is member of\r\n      for (let cellIndex = 0; cellIndex < proxy.cells.length; cellIndex++) {\r\n        const cell = proxy.cells[cellIndex];\r\n        // TODO Can we skip any cells or make this iteration faster?\r\n        // maybe a linked list here\r\n        for (let otherIndex = 0; otherIndex < cell.proxies.length; otherIndex++) {\r\n          const other = cell.proxies[otherIndex];\r\n          if (other.id === proxy.id) {\r\n            // skip duplicates\r\n            continue;\r\n          }\r\n          const id = Pair.calculatePairHash(proxy.collider.id, other.collider.id);\r\n          if (this._nonPairs.has(id)) {\r\n            continue; // Is there a way we can re-use the non-pair cache\r\n          }\r\n          if (!this._pairs.has(id) && this._canCollide(proxy, other) && proxy.object.bounds.overlaps(other.object.bounds)) {\r\n            const pair = this._pairPool.get();\r\n            pair.colliderA = proxy.collider;\r\n            pair.colliderB = other.collider;\r\n            pair.id = id;\r\n            this._pairs.add(id);\r\n            pairs.push(pair);\r\n          } else {\r\n            this._nonPairs.add(id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return pairs;\r\n  }\r\n\r\n  /**\r\n   * Runs a fine grain pass on collision pairs and does geometry intersection tests producing any contacts\r\n   * @param pairs\r\n   * @param stats\r\n   */\r\n  narrowphase(pairs: Pair[], stats?: FrameStats): CollisionContact[] {\r\n    const contacts: CollisionContact[] = [];\r\n    for (let i = 0; i < pairs.length; i++) {\r\n      const newContacts = pairs[i].collide();\r\n      for (let j = 0; j < newContacts.length; j++) {\r\n        const c = newContacts[j];\r\n        contacts.push(c);\r\n        if (stats) {\r\n          stats.physics.contacts.set(c.id, c);\r\n        }\r\n      }\r\n    }\r\n    this._pairPool.done();\r\n    if (stats) {\r\n      stats.physics.collisions += contacts.length;\r\n    }\r\n    return contacts; // TODO maybe we can re-use contacts as likely pairs next frame\r\n  }\r\n\r\n  /**\r\n   * Perform data structure maintenance, returns number of colliders updated\r\n   */\r\n  update(targets: Collider[], elapsed: number): number {\r\n    return this.hashGrid.update(targets);\r\n  }\r\n\r\n  /**\r\n   * Draws the internal data structure\r\n   * @param ex\r\n   * @param elapsed\r\n   */\r\n  debug(ex: ExcaliburGraphicsContext, elapsed: number): void {\r\n    this.hashGrid.debug(ex, elapsed);\r\n  }\r\n}\r\n","import { Ray } from '../Math/ray';\r\nimport { DeepRequired } from '../Util/Required';\r\nimport { Observable } from '../Util/Observable';\r\nimport {\r\n  BoundingBox,\r\n  Collider,\r\n  CollisionProcessor,\r\n  DynamicTreeCollisionProcessor,\r\n  RayCastHit,\r\n  RayCastOptions,\r\n  SparseHashGridCollisionProcessor\r\n} from './Index';\r\nimport { BodyComponent } from './BodyComponent';\r\nimport { PhysicsConfig } from './PhysicsConfig';\r\nimport { watchDeep } from '../Util/Watch';\r\nimport { Vector } from '../Math/vector';\r\nimport { SpatialPartitionStrategy } from './Detection/SpatialPartitionStrategy';\r\n\r\nexport class PhysicsWorld {\r\n  $configUpdate = new Observable<DeepRequired<PhysicsConfig>>();\r\n\r\n  private _configDirty = false;\r\n  private _config: DeepRequired<PhysicsConfig>;\r\n  get config(): DeepRequired<PhysicsConfig> {\r\n    return watchDeep(this._config, (change) => {\r\n      this.$configUpdate.notifyAll(change);\r\n    });\r\n  }\r\n  set config(newConfig: DeepRequired<PhysicsConfig>) {\r\n    this._config = newConfig;\r\n    this.$configUpdate.notifyAll(newConfig);\r\n  }\r\n\r\n  private _collisionProcessor: CollisionProcessor;\r\n  /**\r\n   * Spatial data structure for locating potential collision pairs and ray casts\r\n   */\r\n  public get collisionProcessor(): CollisionProcessor {\r\n    if (this._configDirty) {\r\n      this._configDirty = false;\r\n      // preserve tracked colliders if config updates\r\n      const colliders = this._collisionProcessor.getColliders();\r\n      if (this._config.spatialPartition === SpatialPartitionStrategy.SparseHashGrid) {\r\n        this._collisionProcessor = new SparseHashGridCollisionProcessor(this._config.sparseHashGrid);\r\n      } else {\r\n        this._collisionProcessor = new DynamicTreeCollisionProcessor(this._config);\r\n      }\r\n      for (const collider of colliders) {\r\n        this._collisionProcessor.track(collider);\r\n      }\r\n    }\r\n    return this._collisionProcessor;\r\n  }\r\n  constructor(config: DeepRequired<PhysicsConfig>) {\r\n    this.config = config;\r\n    this.$configUpdate.subscribe((config) => {\r\n      this._configDirty = true;\r\n      BodyComponent.updateDefaultPhysicsConfig(config.bodies);\r\n    });\r\n    if (this._config.spatialPartition === SpatialPartitionStrategy.SparseHashGrid) {\r\n      this._collisionProcessor = new SparseHashGridCollisionProcessor(this._config.sparseHashGrid);\r\n    } else {\r\n      this._collisionProcessor = new DynamicTreeCollisionProcessor(this._config);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Raycast into the scene's physics world\r\n   * @param ray\r\n   * @param options\r\n   */\r\n  public rayCast(ray: Ray, options?: RayCastOptions): RayCastHit[] {\r\n    return this.collisionProcessor.rayCast(ray, options);\r\n  }\r\n\r\n  /**\r\n   * Query for colliders in the scene's physics world\r\n   * @param point\r\n   */\r\n  public query(point: Vector): Collider[];\r\n  public query(bounds: BoundingBox): Collider[];\r\n  public query(pointOrBounds: Vector | BoundingBox): Collider[] {\r\n    // FIXME workaround TS: https://github.com/microsoft/TypeScript/issues/14107\r\n    return this._collisionProcessor.query(pointOrBounds as any);\r\n  }\r\n}\r\n","import { GamepadConnectEvent, GamepadDisconnectEvent, GamepadButtonEvent, GamepadAxisEvent } from '../Events';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\n\r\nexport type GamepadEvents = {\r\n  connect: GamepadConnectEvent;\r\n  disconnect: GamepadDisconnectEvent;\r\n  button: GamepadButtonEvent;\r\n  axis: GamepadAxisEvent;\r\n};\r\n\r\nexport const GamepadEvents = {\r\n  GamepadConnect: 'connect',\r\n  GamepadDisconnect: 'disconnect',\r\n  GamepadButton: 'button',\r\n  GamepadAxis: 'axis'\r\n};\r\n\r\n/**\r\n * Excalibur leverages the HTML5 Gamepad API [where it is supported](http://caniuse.com/#feat=gamepad)\r\n * to provide controller support for your games.\r\n */\r\nexport class Gamepads {\r\n  public events = new EventEmitter<GamepadEvents>();\r\n  /**\r\n   * Whether or not to poll for Gamepad input (default: `false`)\r\n   */\r\n  public enabled = false;\r\n\r\n  /**\r\n   * Whether or not Gamepad API is supported\r\n   */\r\n  public supported = !!(<any>navigator).getGamepads;\r\n\r\n  /**\r\n   * The minimum value an axis has to move before considering it a change\r\n   */\r\n  public static MinAxisMoveThreshold = 0.05;\r\n\r\n  private _gamePadTimeStamps = [0, 0, 0, 0];\r\n  private _oldPads: Gamepad[] = [];\r\n  private _pads: Gamepad[] = [];\r\n  private _initSuccess: boolean = false;\r\n  private _navigator: NavigatorGamepads = <any>navigator;\r\n  private _minimumConfiguration: GamepadConfiguration = null;\r\n  private _enabled = true;\r\n\r\n  public init() {\r\n    if (!this.supported) {\r\n      return;\r\n    }\r\n    if (this._initSuccess) {\r\n      return;\r\n    }\r\n\r\n    // In Chrome, this will return 4 undefined items until a button is pressed\r\n    // In FF, this will not return any items until a button is pressed\r\n    this._oldPads = this._clonePads(this._navigator.getGamepads());\r\n    if (this._oldPads.length && this._oldPads[0]) {\r\n      this._initSuccess = true;\r\n    }\r\n  }\r\n\r\n  public toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n  }\r\n\r\n  /**\r\n   * Sets the minimum gamepad configuration, for example {axis: 4, buttons: 4} means\r\n   * this game requires at minimum 4 axis inputs and 4 buttons, this is not restrictive\r\n   * all other controllers with more axis or buttons are valid as well. If no minimum\r\n   * configuration is set all pads are valid.\r\n   */\r\n  public setMinimumGamepadConfiguration(config: GamepadConfiguration): void {\r\n    this._enableAndUpdate(); // if config is used, implicitly enable\r\n    this._minimumConfiguration = config;\r\n  }\r\n\r\n  /**\r\n   * When implicitly enabled, set the enabled flag and run an update so information is updated\r\n   */\r\n  private _enableAndUpdate() {\r\n    if (!this.enabled) {\r\n      this.enabled = true;\r\n      this.update();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Checks a navigator gamepad against the minimum configuration if present.\r\n   */\r\n  private _isGamepadValid(pad: NavigatorGamepad): boolean {\r\n    if (!this._minimumConfiguration) {\r\n      return true;\r\n    }\r\n    if (!pad) {\r\n      return false;\r\n    }\r\n    const axesLength = pad.axes.filter((value) => {\r\n      return typeof value !== undefined;\r\n    }).length;\r\n\r\n    const buttonLength = pad.buttons.filter((value) => {\r\n      return typeof value !== undefined;\r\n    }).length;\r\n    return axesLength >= this._minimumConfiguration.axis && buttonLength >= this._minimumConfiguration.buttons && pad.connected;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, event: GamepadEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this._enableAndUpdate(); // implicitly enable\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Updates Gamepad state and publishes Gamepad events\r\n   */\r\n  public update() {\r\n    if (!this.enabled || !this.supported) {\r\n      return;\r\n    }\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    this.init();\r\n\r\n    const gamepads = this._navigator.getGamepads();\r\n    for (let i = 0; i < gamepads.length; i++) {\r\n      if (!gamepads[i]) {\r\n        const gamepad = this.at(i);\r\n        // If was connected, but now isn't emit the disconnect event\r\n        if (gamepad.connected) {\r\n          this.events.emit('disconnect', new GamepadDisconnectEvent(i, gamepad));\r\n          gamepad.events.unpipe(this.events);\r\n        }\r\n        // Reset connection status\r\n        gamepad.connected = false;\r\n        continue;\r\n      } else {\r\n        const gamepad = this.at(i);\r\n        if (!this.at(i).connected && this._isGamepadValid(gamepads[i])) {\r\n          gamepad.events.pipe(this.events);\r\n          this.events.emit('connect', new GamepadConnectEvent(i, this.at(i)));\r\n        }\r\n        // Set connection status\r\n        this.at(i).connected = true;\r\n      }\r\n\r\n      this.at(i).update();\r\n\r\n      // Only supported in Chrome\r\n      if (gamepads[i].timestamp && gamepads[i].timestamp === this._gamePadTimeStamps[i]) {\r\n        continue;\r\n      }\r\n\r\n      this._gamePadTimeStamps[i] = gamepads[i].timestamp;\r\n\r\n      // Add reference to navigator gamepad\r\n      this.at(i).navigatorGamepad = gamepads[i];\r\n\r\n      // Buttons\r\n\r\n      const gamepad = gamepads[i];\r\n      // gamepads are a list that might be null\r\n      if (gamepad) {\r\n        for (let buttonIndex = 0; buttonIndex < gamepad.buttons.length; buttonIndex++) {\r\n          const button = gamepad.buttons[buttonIndex];\r\n          const value = button?.value;\r\n          if (value !== this._oldPads[i]?.getButton(buttonIndex)) {\r\n            if (button?.pressed) {\r\n              this.at(i).updateButton(buttonIndex, value);\r\n              // Fallback to unknown if not mapped\r\n              // prettier-ignore\r\n              this.at(i).events.emit('button', new GamepadButtonEvent(\r\n                buttonIndex in Buttons ? buttonIndex as Buttons : Buttons.Unknown,\r\n                buttonIndex,\r\n                value,\r\n                this.at(i))\r\n              );\r\n            } else {\r\n              this.at(i).updateButton(buttonIndex, 0);\r\n            }\r\n          }\r\n        }\r\n\r\n        for (let axesIndex = 0; axesIndex < gamepad.axes.length; axesIndex++) {\r\n          const axis = gamepad.axes[axesIndex];\r\n          if (axis !== this._oldPads[i]?.getAxes(axesIndex)) {\r\n            this.at(i).updateAxes(axesIndex, axis);\r\n            this.at(i).events.emit('axis', new GamepadAxisEvent(axesIndex, axis, this.at(i)));\r\n          }\r\n        }\r\n      }\r\n      this._oldPads[i] = this._clonePad(gamepads[i]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Safely retrieves a Gamepad at a specific index and creates one if it doesn't yet exist\r\n   */\r\n  public at(index: number): Gamepad {\r\n    this._enableAndUpdate(); // implicitly enable gamepads when at() is called\r\n    if (index >= this._pads.length) {\r\n      // Ensure there is a pad to retrieve\r\n      for (let i = this._pads.length - 1, max = index; i < max; i++) {\r\n        this._pads.push(new Gamepad());\r\n        this._oldPads.push(new Gamepad());\r\n      }\r\n    }\r\n\r\n    return this._pads[index];\r\n  }\r\n\r\n  /**\r\n   * Returns a list of all valid gamepads that meet the minimum configuration requirement.\r\n   */\r\n  public getValidGamepads(): Gamepad[] {\r\n    this._enableAndUpdate();\r\n    const result: Gamepad[] = [];\r\n    for (let i = 0; i < this._pads.length; i++) {\r\n      if (this._isGamepadValid(this.at(i).navigatorGamepad) && this.at(i).connected) {\r\n        result.push(this.at(i));\r\n      }\r\n    }\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Gets the number of connected gamepads\r\n   */\r\n  public count() {\r\n    return this._pads.filter((p) => p.connected).length;\r\n  }\r\n\r\n  private _clonePads(pads: NavigatorGamepad[]): Gamepad[] {\r\n    const arr = [];\r\n    for (let i = 0, len = pads.length; i < len; i++) {\r\n      arr.push(this._clonePad(pads[i]));\r\n    }\r\n    return arr;\r\n  }\r\n\r\n  /**\r\n   * Fastest way to clone a known object is to do it yourself\r\n   */\r\n  private _clonePad(pad: NavigatorGamepad): Gamepad {\r\n    let i, len;\r\n    const clonedPad = new Gamepad();\r\n\r\n    if (!pad) {\r\n      return clonedPad;\r\n    }\r\n\r\n    for (i = 0, len = pad.buttons.length; i < len; i++) {\r\n      if (pad.buttons[i]) {\r\n        clonedPad.updateButton(i, pad.buttons[i].value);\r\n      }\r\n    }\r\n    for (i = 0, len = pad.axes.length; i < len; i++) {\r\n      clonedPad.updateAxes(i, pad.axes[i]);\r\n    }\r\n\r\n    return clonedPad;\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad holds state information for a connected controller. See {@apilink Gamepads}\r\n * for more information on handling controller input.\r\n */\r\nexport class Gamepad {\r\n  public events = new EventEmitter<GamepadEvents>();\r\n  public connected = false;\r\n  public navigatorGamepad: NavigatorGamepad;\r\n  private _axes: number[] = new Array(4);\r\n  private _buttons: number[] = new Array(16);\r\n  private _buttonsUp: number[] = new Array(16);\r\n  private _buttonsDown: number[] = new Array(16);\r\n\r\n  constructor() {\r\n    for (let i = 0; i < this._buttons.length; i++) {\r\n      this._buttons[i] = 0;\r\n    }\r\n    for (let i = 0; i < this._axes.length; i++) {\r\n      this._axes[i] = 0;\r\n    }\r\n  }\r\n\r\n  public update() {\r\n    // Reset buttonsDown and buttonsUp after update is complete\r\n    this._buttonsDown = new Array(16);\r\n    this._buttonsUp = new Array(16);\r\n  }\r\n\r\n  /**\r\n   * Whether or not the given button is pressed\r\n   * @deprecated will be removed in v0.28.0. Use isButtonHeld instead\r\n   * @param button     The button to query\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public isButtonPressed(button: Buttons | number, threshold: number = 1) {\r\n    return this._buttons[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain button is held down. This is persisted between frames.\r\n   * @param button     The button to query\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public isButtonHeld(button: Buttons | number, threshold: number = 1) {\r\n    return this._buttons[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain button was just pressed this frame. This is cleared at the end of the update frame.\r\n   * @param button Test whether a button was just pressed\r\n   * @param threshold  The threshold over which the button is considered to be pressed\r\n   */\r\n  public wasButtonPressed(button: Buttons | number, threshold: number = 1) {\r\n    return this._buttonsDown[button] >= threshold;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain button was just released this frame. This is cleared at the end of the update frame.\r\n   * @param button  Test whether a button was just released\r\n   */\r\n  public wasButtonReleased(button: Buttons | number) {\r\n    return Boolean(this._buttonsUp[button]);\r\n  }\r\n\r\n  /**\r\n   * Gets the given button value between 0 and 1\r\n   */\r\n  public getButton(button: Buttons | number) {\r\n    return this._buttons[button];\r\n  }\r\n\r\n  /**\r\n   * Gets the given axis value between -1 and 1. Values below\r\n   * {@apilink MinAxisMoveThreshold} are considered 0.\r\n   */\r\n  public getAxes(axes: Axes | number) {\r\n    const value = this._axes[axes];\r\n\r\n    if (Math.abs(value) < Gamepads.MinAxisMoveThreshold) {\r\n      return 0;\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  public updateButton(buttonIndex: number, value: number) {\r\n    // button was just released\r\n    if (value === 0 && this._buttons[buttonIndex]) {\r\n      this._buttonsUp[buttonIndex] = 1;\r\n\r\n      // button was just pressed\r\n    } else {\r\n      this._buttonsDown[buttonIndex] = value;\r\n    }\r\n\r\n    this._buttons[buttonIndex] = value;\r\n  }\r\n\r\n  public updateAxes(axesIndex: number, value: number) {\r\n    this._axes[axesIndex] = value;\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, event: GamepadEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<GamepadEvents>>(eventName: TEventName, handler: Handler<GamepadEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<GamepadEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n}\r\n\r\n/**\r\n * Gamepad Buttons enumeration\r\n */\r\nexport enum Buttons {\r\n  /**\r\n   * Any button that isn't explicity known by excalibur\r\n   */\r\n  Unknown = -1,\r\n  /**\r\n   * Face 1 button (e.g. A)\r\n   */\r\n  Face1 = 0,\r\n  /**\r\n   * Face 2 button (e.g. B)\r\n   */\r\n  Face2 = 1,\r\n  /**\r\n   * Face 3 button (e.g. X)\r\n   */\r\n  Face3 = 2,\r\n  /**\r\n   * Face 4 button (e.g. Y)\r\n   */\r\n  Face4 = 3,\r\n  /**\r\n   * Left bumper button\r\n   */\r\n  LeftBumper = 4,\r\n  /**\r\n   * Right bumper button\r\n   */\r\n  RightBumper = 5,\r\n  /**\r\n   * Left trigger button\r\n   */\r\n  LeftTrigger = 6,\r\n  /**\r\n   * Right trigger button\r\n   */\r\n  RightTrigger = 7,\r\n  /**\r\n   * Select button\r\n   */\r\n  Select = 8,\r\n  /**\r\n   * Start button\r\n   */\r\n  Start = 9,\r\n  /**\r\n   * Left analog stick press (e.g. L3)\r\n   */\r\n  LeftStick = 10,\r\n  /**\r\n   * Right analog stick press (e.g. R3)\r\n   */\r\n  RightStick = 11,\r\n  /**\r\n   * D-pad up\r\n   */\r\n  DpadUp = 12,\r\n  /**\r\n   * D-pad down\r\n   */\r\n  DpadDown = 13,\r\n  /**\r\n   * D-pad left\r\n   */\r\n  DpadLeft = 14,\r\n  /**\r\n   * D-pad right\r\n   */\r\n  DpadRight = 15,\r\n  /**\r\n   * Center button (e.g. the Nintendo Home Button)\r\n   */\r\n  CenterButton = 16,\r\n  /**\r\n   * Misc button 1 (e.g. Xbox Series X share button, PS5 microphone button, Nintendo Switch Pro capture button, Amazon Luna microphone button)\r\n   * defacto standard not listed on the w3c spec for a standard gamepad https://w3c.github.io/gamepad/#dfn-standard-gamepad\r\n   */\r\n  MiscButton1 = 17\r\n}\r\n\r\n/**\r\n * Gamepad Axes enumeration\r\n */\r\nexport enum Axes {\r\n  /**\r\n   * Left analogue stick X direction\r\n   */\r\n  LeftStickX = 0,\r\n  /**\r\n   * Left analogue stick Y direction\r\n   */\r\n  LeftStickY = 1,\r\n  /**\r\n   * Right analogue stick X direction\r\n   */\r\n  RightStickX = 2,\r\n  /**\r\n   * Right analogue stick Y direction\r\n   */\r\n  RightStickY = 3\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepads {\r\n  getGamepads(): (NavigatorGamepad | undefined)[];\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepad {\r\n  axes: number[];\r\n  buttons: NavigatorGamepadButton[];\r\n  connected: boolean;\r\n  id: string;\r\n  index: number;\r\n  mapping: string;\r\n  timestamp: number;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepadButton {\r\n  pressed: boolean;\r\n  value: number;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface NavigatorGamepadEvent {\r\n  gamepad: NavigatorGamepad;\r\n}\r\n\r\n/**\r\n * @internal\r\n */\r\nexport interface GamepadConfiguration {\r\n  axis: number;\r\n  buttons: number;\r\n}\r\n","import { Logger } from '../Util/Log';\r\nimport * as Events from '../Events';\r\nimport { isCrossOriginIframe } from '../Util/IFrame';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\n\r\n/**\r\n * Enum representing physical input key codes\r\n *\r\n * Spec: https://w3c.github.io/uievents-code/#key-alphanumeric-section\r\n */\r\nexport enum Keys {\r\n  // Writing System Keys https://w3c.github.io/uievents-code/#key-alphanumeric-writing-system\r\n  Backquote = 'Backquote',\r\n  Backslash = 'Backslash',\r\n  BracketLeft = 'BracketLeft',\r\n  BracketRight = 'BracketRight',\r\n  Comma = 'Comma',\r\n\r\n  // NUMBERS\r\n  Key0 = 'Digit0',\r\n  Key1 = 'Digit1',\r\n  Key2 = 'Digit2',\r\n  Key3 = 'Digit3',\r\n  Key4 = 'Digit4',\r\n  Key5 = 'Digit5',\r\n  Key6 = 'Digit6',\r\n  Key7 = 'Digit7',\r\n  Key8 = 'Digit8',\r\n  Key9 = 'Digit9',\r\n  Digit0 = 'Digit0',\r\n  Digit1 = 'Digit1',\r\n  Digit2 = 'Digit2',\r\n  Digit3 = 'Digit3',\r\n  Digit4 = 'Digit4',\r\n  Digit5 = 'Digit5',\r\n  Digit6 = 'Digit6',\r\n  Digit7 = 'Digit7',\r\n  Digit8 = 'Digit8',\r\n  Digit9 = 'Digit9',\r\n\r\n  Equal = 'Equal',\r\n\r\n  IntlBackslash = 'IntlBackslash',\r\n  IntlRo = 'IntlRo',\r\n  IntlYen = 'IntlYen',\r\n\r\n  // LETTERS\r\n  A = 'KeyA',\r\n  B = 'KeyB',\r\n  C = 'KeyC',\r\n  D = 'KeyD',\r\n  E = 'KeyE',\r\n  F = 'KeyF',\r\n  G = 'KeyG',\r\n  H = 'KeyH',\r\n  I = 'KeyI',\r\n  J = 'KeyJ',\r\n  K = 'KeyK',\r\n  L = 'KeyL',\r\n  M = 'KeyM',\r\n  N = 'KeyN',\r\n  O = 'KeyO',\r\n  P = 'KeyP',\r\n  Q = 'KeyQ',\r\n  R = 'KeyR',\r\n  S = 'KeyS',\r\n  T = 'KeyT',\r\n  U = 'KeyU',\r\n  V = 'KeyV',\r\n  W = 'KeyW',\r\n  X = 'KeyX',\r\n  Y = 'KeyY',\r\n  Z = 'KeyZ',\r\n  KeyA = 'KeyA',\r\n  KeyB = 'KeyB',\r\n  KeyC = 'KeyC',\r\n  KeyD = 'KeyD',\r\n  KeyE = 'KeyE',\r\n  KeyF = 'KeyF',\r\n  KeyG = 'KeyG',\r\n  KeyH = 'KeyH',\r\n  KeyI = 'KeyI',\r\n  KeyJ = 'KeyJ',\r\n  KeyK = 'KeyK',\r\n  KeyL = 'KeyL',\r\n  KeyM = 'KeyM',\r\n  KeyN = 'KeyN',\r\n  KeyO = 'KeyO',\r\n  KeyP = 'KeyP',\r\n  KeyQ = 'KeyQ',\r\n  KeyR = 'KeyR',\r\n  KeyS = 'KeyS',\r\n  KeyT = 'KeyT',\r\n  KeyU = 'KeyU',\r\n  KeyV = 'KeyV',\r\n  KeyW = 'KeyW',\r\n  KeyX = 'KeyX',\r\n  KeyY = 'KeyY',\r\n  KeyZ = 'KeyZ',\r\n\r\n  // SYMBOLS\r\n  Minus = 'Minus',\r\n  Period = 'Period',\r\n  Quote = 'Quote',\r\n  Semicolon = 'Semicolon',\r\n  Slash = 'Slash',\r\n\r\n  // Functional keys https://w3c.github.io/uievents-code/#key-alphanumeric-functional\r\n  AltLeft = 'AltLeft',\r\n  AltRight = 'AltRight',\r\n  Alt = 'Alt',\r\n  AltGraph = 'AltGraph',\r\n  Backspace = 'Backspace',\r\n  CapsLock = 'CapsLock',\r\n  ContextMenu = 'ContextMenu',\r\n  ControlLeft = 'ControlLeft',\r\n  ControlRight = 'ControlRight',\r\n  Enter = 'Enter',\r\n  MetaLeft = 'MetaLeft',\r\n  MetaRight = 'MetaRight',\r\n  ShiftLeft = 'ShiftLeft',\r\n  ShiftRight = 'ShiftRight',\r\n  Space = 'Space',\r\n  Tab = 'Tab',\r\n\r\n  Convert = 'Convert',\r\n  KanaMode = 'KanaMode',\r\n  NonConvert = 'NonConvert',\r\n\r\n  // Control Pad https://w3c.github.io/uievents-code/#key-controlpad-section\r\n  Delete = 'Delete',\r\n  End = 'End',\r\n  Help = 'Help',\r\n  Home = 'Home',\r\n  Insert = 'Insert',\r\n  PageDown = 'PageDown',\r\n  PageUp = 'PageUp',\r\n\r\n  // Arrow Pad https://w3c.github.io/uievents-code/#key-arrowpad-section\r\n  Up = 'ArrowUp',\r\n  Down = 'ArrowDown',\r\n  Left = 'ArrowLeft',\r\n  Right = 'ArrowRight',\r\n\r\n  ArrowUp = 'ArrowUp',\r\n  ArrowDown = 'ArrowDown',\r\n  ArrowLeft = 'ArrowLeft',\r\n  ArrowRight = 'ArrowRight',\r\n\r\n  // Numpad Section https://w3c.github.io/uievents-code/#key-numpad-section\r\n  NumLock = 'NumLock',\r\n  Numpad0 = 'Numpad0',\r\n  Numpad1 = 'Numpad1',\r\n  Numpad2 = 'Numpad2',\r\n  Numpad3 = 'Numpad3',\r\n  Numpad4 = 'Numpad4',\r\n  Numpad5 = 'Numpad5',\r\n  Numpad6 = 'Numpad6',\r\n  Numpad7 = 'Numpad7',\r\n  Numpad8 = 'Numpad8',\r\n  Numpad9 = 'Numpad9',\r\n  Num0 = 'Numpad0',\r\n  Num1 = 'Numpad1',\r\n  Num2 = 'Numpad2',\r\n  Num3 = 'Numpad3',\r\n  Num4 = 'Numpad4',\r\n  Num5 = 'Numpad5',\r\n  Num6 = 'Numpad6',\r\n  Num7 = 'Numpad7',\r\n  Num8 = 'Numpad8',\r\n  Num9 = 'Numpad9',\r\n\r\n  NumAdd = 'NumpadAdd',\r\n  NumpadAdd = 'NumpadAdd',\r\n\r\n  NumDecimal = 'NumpadDecimal',\r\n  NumpadDecimal = 'NumpadDecimal',\r\n\r\n  NumDivide = 'NumpadDivide',\r\n  NumpadDivide = 'NumpadDivide',\r\n\r\n  NumEnter = 'NumpadEnter',\r\n  NumpadEnter = 'NumpadEnter',\r\n\r\n  NumMultiply = 'NumpadMultiply',\r\n  NumpadMultiply = 'NumpadMultiply',\r\n\r\n  NumSubtract = 'NumpadSubtract',\r\n  NumpadSubtract = 'NumpadSubtract',\r\n  // NumComma = 'NumpadComma', // not x-browser\r\n  // NumpadComma = 'NumpadComma', // not x-browser\r\n\r\n  // Function section https://w3c.github.io/uievents-code/#key-function-section\r\n  Esc = 'Escape',\r\n  Escape = 'Escape',\r\n  F1 = 'F1',\r\n  F2 = 'F2',\r\n  F3 = 'F3',\r\n  F4 = 'F4',\r\n  F5 = 'F5',\r\n  F6 = 'F6',\r\n  F7 = 'F7',\r\n  F8 = 'F8',\r\n  F9 = 'F9',\r\n  F10 = 'F10',\r\n  F11 = 'F11',\r\n  F12 = 'F12',\r\n  F13 = 'F13',\r\n  F14 = 'F14',\r\n  F15 = 'F15',\r\n  F16 = 'F16',\r\n  F17 = 'F17',\r\n  F18 = 'F18',\r\n  F19 = 'F19',\r\n  F20 = 'F20',\r\n  PrintScreen = 'PrintScreen',\r\n  ScrollLock = 'ScrollLock',\r\n  Pause = 'Pause',\r\n\r\n  Unidentified = 'Unidentified'\r\n}\r\n\r\n/**\r\n * Event thrown on a game object for a key event\r\n */\r\nexport class KeyEvent extends Events.GameEvent<any> {\r\n  /**\r\n   * @param key  The key responsible for throwing the event\r\n   * @param value The key's typed value the browser detected\r\n   * @param originalEvent The original keyboard event that Excalibur handled\r\n   */\r\n  constructor(\r\n    public key: Keys,\r\n    public value?: string,\r\n    public originalEvent?: KeyboardEvent\r\n  ) {\r\n    super();\r\n  }\r\n}\r\n\r\nexport interface KeyboardInitOptions {\r\n  global?: GlobalEventHandlers;\r\n  grabWindowFocus?: boolean;\r\n}\r\n\r\nexport type KeyEvents = {\r\n  press: KeyEvent;\r\n  hold: KeyEvent;\r\n  release: KeyEvent;\r\n};\r\n\r\nexport const KeyEvents = {\r\n  Press: 'press',\r\n  Hold: 'hold',\r\n  Release: 'release'\r\n};\r\n\r\n/**\r\n * Provides keyboard support for Excalibur.\r\n */\r\nexport class Keyboard {\r\n  public events = new EventEmitter<KeyEvents>();\r\n  private _enabled = true;\r\n  /**\r\n   * Keys that are currently held down\r\n   */\r\n  private _keys: Keys[] = [];\r\n  /**\r\n   * Keys up in the current frame\r\n   */\r\n  private _keysUp: Keys[] = [];\r\n  /**\r\n   * Keys down in the current frame\r\n   */\r\n  private _keysDown: Keys[] = [];\r\n\r\n  public emit<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, event: KeyEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, handler: Handler<KeyEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, handler: Handler<KeyEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<KeyEvents>>(eventName: TEventName, handler: Handler<KeyEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<KeyEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Initialize Keyboard event listeners\r\n   */\r\n  init(keyboardOptions?: KeyboardInitOptions): void {\r\n    let { global } = keyboardOptions;\r\n    const { grabWindowFocus } = keyboardOptions;\r\n    if (!global) {\r\n      if (isCrossOriginIframe()) {\r\n        global = window;\r\n        // Workaround for iframes like for itch.io or codesandbox\r\n        // https://www.reddit.com/r/gamemaker/comments/kfs5cs/keyboard_inputs_no_longer_working_in_html5_game/\r\n        // https://forum.gamemaker.io/index.php?threads/solved-keyboard-issue-on-itch-io.87336/\r\n        if (grabWindowFocus) {\r\n          window.focus();\r\n        }\r\n\r\n        Logger.getInstance().warn('Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus');\r\n      } else {\r\n        global = window.top;\r\n      }\r\n    }\r\n\r\n    global.addEventListener('blur', () => {\r\n      this._keys.length = 0; // empties array efficiently\r\n    });\r\n\r\n    // key up is on window because canvas cannot have focus\r\n    global.addEventListener('keyup', this._handleKeyUp);\r\n\r\n    // key down is on window because canvas cannot have focus\r\n    global.addEventListener('keydown', this._handleKeyDown);\r\n  }\r\n\r\n  toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n  }\r\n\r\n  private _releaseAllKeys = (ev: KeyboardEvent) => {\r\n    for (const code of this._keys) {\r\n      const keyEvent = new KeyEvent(code, ev.key, ev);\r\n      this.events.emit('up', keyEvent);\r\n      this.events.emit('release', keyEvent);\r\n    }\r\n    this._keysUp = Array.from(new Set(this._keys.concat(this._keysUp)));\r\n    this._keys.length = 0;\r\n  };\r\n\r\n  public clear() {\r\n    this._keysDown.length = 0;\r\n    this._keysUp.length = 0;\r\n    this._keys.length = 0;\r\n  }\r\n\r\n  private _handleKeyDown = (ev: KeyboardEvent) => {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n\r\n    // handle macos meta key issue\r\n    // https://github.com/excaliburjs/Excalibur/issues/2608\r\n    if (!ev.metaKey && (this._keys.includes(Keys.MetaLeft) || this._keys.includes(Keys.MetaRight))) {\r\n      this._releaseAllKeys(ev);\r\n    }\r\n\r\n    const code = ev.code as Keys;\r\n    if (this._keys.indexOf(code) === -1) {\r\n      this._keys.push(code);\r\n      this._keysDown.push(code);\r\n      const keyEvent = new KeyEvent(code, ev.key, ev);\r\n      this.events.emit('down', keyEvent);\r\n      this.events.emit('press', keyEvent);\r\n    }\r\n  };\r\n\r\n  private _handleKeyUp = (ev: KeyboardEvent) => {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    const code = ev.code as Keys;\r\n    const key = this._keys.indexOf(code);\r\n    this._keys.splice(key, 1);\r\n    this._keysUp.push(code);\r\n    const keyEvent = new KeyEvent(code, ev.key, ev);\r\n\r\n    // alias the old api, we may want to deprecate this in the future\r\n    this.events.emit('up', keyEvent);\r\n    this.events.emit('release', keyEvent);\r\n\r\n    // handle macos meta key issue\r\n    // https://github.com/excaliburjs/Excalibur/issues/2608\r\n    if (ev.key === 'Meta') {\r\n      this._releaseAllKeys(ev);\r\n    }\r\n  };\r\n\r\n  public update() {\r\n    // Reset keysDown and keysUp after update is complete\r\n    this._keysDown.length = 0;\r\n    this._keysUp.length = 0;\r\n\r\n    // Emit synthetic \"hold\" event\r\n    for (let i = 0; i < this._keys.length; i++) {\r\n      this.events.emit('hold', new KeyEvent(this._keys[i]));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets list of keys being pressed down\r\n   */\r\n  public getKeys(): Keys[] {\r\n    return this._keys;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key was just pressed this frame. This is cleared at the end of the update frame.\r\n   * @param key Test whether a key was just pressed\r\n   */\r\n  public wasPressed(key: Keys): boolean {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this._keysDown.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key is held down. This is persisted between frames.\r\n   * @param key  Test whether a key is held down\r\n   */\r\n  public isHeld(key: Keys): boolean {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this._keys.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Tests if a certain key was just released this frame. This is cleared at the end of the update frame.\r\n   * @param key  Test whether a key was just released\r\n   */\r\n  public wasReleased(key: Keys): boolean {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this._keysUp.indexOf(key) > -1;\r\n  }\r\n\r\n  /**\r\n   * Trigger a manual key event\r\n   * @param type\r\n   * @param key\r\n   * @param character\r\n   */\r\n  public triggerEvent(type: 'down' | 'up', key: Keys, character?: string) {\r\n    if (type === 'down') {\r\n      this._handleKeyDown(\r\n        new KeyboardEvent('keydown', {\r\n          code: key,\r\n          key: character ?? null\r\n        })\r\n      );\r\n    }\r\n    if (type === 'up') {\r\n      this._handleKeyUp(\r\n        new KeyboardEvent('keyup', {\r\n          code: key,\r\n          key: character ?? null\r\n        })\r\n      );\r\n    }\r\n  }\r\n}\r\n","import { Gamepads } from './Gamepad';\r\nimport { Keyboard } from './Keyboard';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\n\r\nexport interface InputsOptions {\r\n  keyboard: Keyboard;\r\n  gamepads: Gamepads;\r\n  pointers: PointerEventReceiver;\r\n}\r\n\r\n/**\r\n * This allows you to map multiple inputs to specific commands! This is especially useful when\r\n * you need to allow multiple input sources to control a specific action.\r\n */\r\nexport class InputMapper {\r\n  private _handlers = new Map<any, any>();\r\n  constructor(public inputs: InputsOptions) {}\r\n\r\n  /**\r\n   * Executes the input map, called internally by Excalibur\r\n   */\r\n  execute() {\r\n    for (const [input, command] of this._handlers.entries()) {\r\n      const results = input(this.inputs);\r\n      if (results) {\r\n        command(results);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * This allows you to map multiple inputs to specific commands! This is useful\r\n   *\r\n   * The inputHandler should return a truthy value if you wish the commandHandler to fire.\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * const moveRight = (amount: number) => { actor.vel.x = 100 * amount }\r\n   * const moveLeft = (amount: number) => { actor.vel.x = -100 * amount }\r\n   * const moveUp = (amount: number) => { actor.vel.y = -100 * amount }\r\n   * const moveDown = (amount: number) => { actor.vel.y = 100 * amount }\r\n   *\r\n   * engine.inputMapper.on(({keyboard}) => keyboard.isHeld(ex.Keys.ArrowRight) ? 1 : 0, moveRight);\r\n   * engine.inputMapper.on(({gamepads}) => gamepads.at(0).isButtonPressed(ex.Buttons.DpadRight) ? 1 : 0, moveRight);\r\n   * engine.inputMapper.on(({gamepads}) => gamepads.at(0).getAxes(ex.Axes.LeftStickX) > 0 ?\r\n   *  gamepads.at(0).getAxes(ex.Axes.LeftStickX) : 0, moveRight);\r\n   * ```\r\n   * @param inputHandler\r\n   * @param commandHandler\r\n   */\r\n  on<TInputHandlerData>(\r\n    inputHandler: (inputs: InputsOptions) => TInputHandlerData | false,\r\n    commandHandler: (data: TInputHandlerData) => any\r\n  ) {\r\n    this._handlers.set(inputHandler, commandHandler);\r\n  }\r\n}\r\n","/**\r\n * Checks if excalibur is in a x-origin iframe\r\n */\r\nexport function isCrossOriginIframe() {\r\n  try {\r\n    // Try and listen to events on top window frame if within an iframe.\r\n    //\r\n    // See https://github.com/excaliburjs/Excalibur/issues/1294\r\n    //\r\n    // Attempt to add an event listener, which triggers a DOMException on\r\n    // cross-origin iframes\r\n    const noop = () => {\r\n      return;\r\n    };\r\n    window.top.addEventListener('blur', noop);\r\n    window.top.removeEventListener('blur', noop);\r\n  } catch {\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Vector } from './vector';\r\n\r\nexport class GlobalCoordinates {\r\n  public static fromPagePosition(x: number, y: number, engine: Engine): GlobalCoordinates;\r\n  public static fromPagePosition(pos: Vector, engine: Engine): GlobalCoordinates;\r\n  public static fromPagePosition(xOrPos: number | Vector, yOrEngine: number | Engine, engineOrUndefined?: Engine): GlobalCoordinates {\r\n    let pageX: number;\r\n    let pageY: number;\r\n    let pagePos: Vector;\r\n    let engine: Engine;\r\n\r\n    if (arguments.length === 3) {\r\n      pageX = <number>xOrPos;\r\n      pageY = <number>yOrEngine;\r\n      pagePos = new Vector(pageX, pageY);\r\n      engine = engineOrUndefined;\r\n    } else {\r\n      pagePos = <Vector>xOrPos;\r\n      pageX = pagePos.x;\r\n      pageY = pagePos.y;\r\n      engine = <Engine>yOrEngine;\r\n    }\r\n\r\n    const screenPos = engine.screen.pageToScreenCoordinates(pagePos);\r\n    const worldPos = engine.screen.screenToWorldCoordinates(screenPos);\r\n\r\n    return new GlobalCoordinates(worldPos, pagePos, screenPos);\r\n  }\r\n\r\n  constructor(\r\n    public worldPos: Vector,\r\n    public pagePos: Vector,\r\n    public screenPos: Vector\r\n  ) {}\r\n}\r\n","import { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { Vector } from '../Math/vector';\r\nimport { PointerButton } from './PointerButton';\r\nimport { PointerType } from './PointerType';\r\n\r\nexport class PointerEvent {\r\n  public active = true;\r\n  public cancel() {\r\n    this.active = false;\r\n  }\r\n\r\n  get pagePos(): Vector {\r\n    return this.coordinates.pagePos;\r\n  }\r\n\r\n  get screenPos(): Vector {\r\n    return this.coordinates.screenPos;\r\n  }\r\n\r\n  get worldPos(): Vector {\r\n    return this.coordinates.worldPos;\r\n  }\r\n\r\n  constructor(\r\n    public type: 'down' | 'up' | 'move' | 'cancel',\r\n    public pointerId: number,\r\n    public button: PointerButton,\r\n    public pointerType: PointerType,\r\n    public coordinates: GlobalCoordinates,\r\n    public nativeEvent: Event\r\n  ) {}\r\n}\r\n","import { WheelDeltaMode } from './WheelDeltaMode';\r\n\r\nexport class WheelEvent {\r\n  public active = true;\r\n  public cancel() {\r\n    this.active = false;\r\n  }\r\n  constructor(\r\n    public x: number,\r\n    public y: number,\r\n    public pageX: number,\r\n    public pageY: number,\r\n    public screenX: number,\r\n    public screenY: number,\r\n    public index: number,\r\n    public deltaX: number,\r\n    public deltaY: number,\r\n    public deltaZ: number,\r\n    public deltaMode: WheelDeltaMode,\r\n    public ev: Event\r\n  ) {}\r\n}\r\n","import { Vector } from '../Math/vector';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\nimport { PointerEvents } from './PointerEventReceiver';\r\nimport { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { Engine } from '../Engine';\r\n\r\nexport class PointerAbstraction {\r\n  public events = new EventEmitter<PointerEvents>();\r\n  /**\r\n   * The last position on the document this pointer was at. Can be `null` if pointer was never active.\r\n   */\r\n  public lastPagePos: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The last position on the screen this pointer was at. Can be `null` if pointer was never active.\r\n   */\r\n  public lastScreenPos: Vector = Vector.Zero;\r\n\r\n  /**\r\n   * The last position in the game world coordinates this pointer was at. Can be `null` if pointer was never active.\r\n   */\r\n  public lastWorldPos: Vector = Vector.Zero;\r\n\r\n  constructor() {\r\n    this.on('move', this._onPointerMove);\r\n    this.on('down', this._onPointerDown);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, event: PointerEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Called internally by excalibur to keep pointers up to date\r\n   * @internal\r\n   * @param engine\r\n   */\r\n  public _updateWorldPosition(engine: Engine) {\r\n    const coord = GlobalCoordinates.fromPagePosition(this.lastPagePos, engine);\r\n    this.lastScreenPos = coord.screenPos;\r\n    this.lastWorldPos = coord.worldPos;\r\n  }\r\n\r\n  private _onPointerMove = (ev: PointerEvent): void => {\r\n    this.lastPagePos = new Vector(ev.pagePos.x, ev.pagePos.y);\r\n    this.lastScreenPos = new Vector(ev.screenPos.x, ev.screenPos.y);\r\n    this.lastWorldPos = new Vector(ev.worldPos.x, ev.worldPos.y);\r\n  };\r\n\r\n  private _onPointerDown = (ev: PointerEvent): void => {\r\n    this.lastPagePos = new Vector(ev.pagePos.x, ev.pagePos.y);\r\n    this.lastScreenPos = new Vector(ev.screenPos.x, ev.screenPos.y);\r\n    this.lastWorldPos = new Vector(ev.worldPos.x, ev.worldPos.y);\r\n  };\r\n}\r\n","export enum WheelDeltaMode {\r\n  Pixel = 'Pixel',\r\n  Line = 'Line',\r\n  Page = 'Page'\r\n}\r\n","/**\n * Native browser button enumeration\n */\nexport enum NativePointerButton {\n  NoButton = -1,\n  Left = 0,\n  Middle = 1,\n  Right = 2,\n  Unknown = 3\n}\n","/**\n * The mouse button being pressed.\n */\nexport enum PointerButton {\n  Left = 'Left',\n  Middle = 'Middle',\n  Right = 'Right',\n  Unknown = 'Unknown',\n  NoButton = 'NoButton'\n}\n","/**\r\n * The type of pointer for a {@apilink PointerEvent}.\r\n */\r\nexport enum PointerType {\r\n  Touch = 'Touch',\r\n  Mouse = 'Mouse',\r\n  Pen = 'Pen',\r\n  Unknown = 'Unknown'\r\n}\r\n","import { Engine, ScrollPreventionMode } from '../Engine';\r\nimport { GlobalCoordinates } from '../Math/global-coordinates';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { PointerEvent } from './PointerEvent';\r\nimport { WheelEvent } from './WheelEvent';\r\nimport { PointerAbstraction } from './PointerAbstraction';\r\n\r\nimport { WheelDeltaMode } from './WheelDeltaMode';\r\nimport { PointerSystem } from './PointerSystem';\r\nimport { NativePointerButton } from './NativePointerButton';\r\nimport { PointerButton } from './PointerButton';\r\nimport { fail } from '../Util/Util';\r\nimport { PointerType } from './PointerType';\r\nimport { isCrossOriginIframe } from '../Util/IFrame';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from '../EventEmitter';\r\n\r\nexport type NativePointerEvent = globalThis.PointerEvent;\r\nexport type NativeMouseEvent = globalThis.MouseEvent;\r\nexport type NativeTouchEvent = globalThis.TouchEvent;\r\nexport type NativeWheelEvent = globalThis.WheelEvent;\r\n\r\nexport type PointerEvents = {\r\n  move: PointerEvent;\r\n  down: PointerEvent;\r\n  up: PointerEvent;\r\n  wheel: WheelEvent;\r\n};\r\n\r\nexport const PointerEvents = {\r\n  Move: 'move',\r\n  Down: 'down',\r\n  Up: 'up',\r\n  Wheel: 'wheel'\r\n};\r\n\r\n/**\r\n * Is this event a native touch event?\r\n */\r\nfunction isTouchEvent(value: any): value is NativeTouchEvent {\r\n  // Guard for Safari <= 13.1\r\n  return globalThis.TouchEvent && value instanceof globalThis.TouchEvent;\r\n}\r\n\r\n/**\r\n * Is this event a native pointer event\r\n */\r\nfunction isPointerEvent(value: any): value is NativePointerEvent {\r\n  // Guard for Safari <= 13.1\r\n  return globalThis.PointerEvent && value instanceof globalThis.PointerEvent;\r\n}\r\n\r\nexport interface PointerInitOptions {\r\n  grabWindowFocus?: boolean;\r\n}\r\n\r\n/**\r\n * The PointerEventProcessor is responsible for collecting all the events from the canvas and transforming them into GlobalCoordinates\r\n */\r\nexport class PointerEventReceiver {\r\n  public events = new EventEmitter<PointerEvents>();\r\n  public primary: PointerAbstraction = new PointerAbstraction();\r\n\r\n  private _activeNativePointerIdsToNormalized = new Map<number, number>();\r\n  public lastFramePointerCoords = new Map<number, GlobalCoordinates>();\r\n  public currentFramePointerCoords = new Map<number, GlobalCoordinates>();\r\n\r\n  public currentFramePointerDown = new Map<number, boolean>();\r\n  public lastFramePointerDown = new Map<number, boolean>();\r\n\r\n  public currentFrameDown: PointerEvent[] = [];\r\n  public currentFrameUp: PointerEvent[] = [];\r\n  public currentFrameMove: PointerEvent[] = [];\r\n  public currentFrameCancel: PointerEvent[] = [];\r\n  public currentFrameWheel: WheelEvent[] = [];\r\n\r\n  private _enabled = true;\r\n\r\n  constructor(\r\n    public readonly target: GlobalEventHandlers & EventTarget,\r\n    public engine: Engine\r\n  ) {}\r\n\r\n  public toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n  }\r\n\r\n  /**\r\n   * Creates a new PointerEventReceiver with a new target and engine while preserving existing pointer event\r\n   * handlers.\r\n   * @param target\r\n   * @param engine\r\n   */\r\n  public recreate(target: GlobalEventHandlers & EventTarget, engine: Engine) {\r\n    const eventReceiver = new PointerEventReceiver(target, engine);\r\n    eventReceiver.primary = this.primary;\r\n    eventReceiver._pointers = this._pointers;\r\n    return eventReceiver;\r\n  }\r\n\r\n  private _pointers: PointerAbstraction[] = [this.primary];\r\n  /**\r\n   * Locates a specific pointer by id, creates it if it doesn't exist\r\n   * @param index\r\n   */\r\n  public at(index: number): PointerAbstraction {\r\n    if (index >= this._pointers.length) {\r\n      // Ensure there is a pointer to retrieve\r\n      for (let i = this._pointers.length - 1, max = index; i < max; i++) {\r\n        this._pointers.push(new PointerAbstraction());\r\n      }\r\n    }\r\n    return this._pointers[index];\r\n  }\r\n\r\n  /**\r\n   * The number of pointers currently being tracked by excalibur\r\n   */\r\n  public count(): number {\r\n    return this._pointers.length;\r\n  }\r\n\r\n  /**\r\n   * Is the specified pointer id down this frame\r\n   * @param pointerId\r\n   */\r\n  public isDown(pointerId: number) {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this.currentFramePointerDown.get(pointerId) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Was the specified pointer id down last frame\r\n   * @param pointerId\r\n   */\r\n  public wasDown(pointerId: number) {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this.lastFramePointerDown.get(pointerId) ?? false;\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer is currently dragging.\r\n   */\r\n  public isDragging(pointerId: number): boolean {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this.isDown(pointerId);\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer just started dragging.\r\n   */\r\n  public isDragStart(pointerId: number): boolean {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return this.isDown(pointerId) && !this.wasDown(pointerId);\r\n  }\r\n\r\n  /**\r\n   * Whether the Pointer just ended dragging.\r\n   */\r\n  public isDragEnd(pointerId: number): boolean {\r\n    if (!this._enabled) {\r\n      return false;\r\n    }\r\n    return !this.isDown(pointerId) && this.wasDown(pointerId);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, event: PointerEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<PointerEvents>>(eventName: TEventName, handler: Handler<PointerEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<PointerEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Called internally by excalibur\r\n   *\r\n   * Updates the current frame pointer info and emits raw pointer events\r\n   *\r\n   * This does not emit events to entities, see PointerSystem\r\n   * @internal\r\n   */\r\n  public update() {\r\n    this.lastFramePointerDown = new Map(this.currentFramePointerDown);\r\n    this.lastFramePointerCoords = new Map(this.currentFramePointerCoords);\r\n\r\n    for (const event of this.currentFrameDown) {\r\n      if (!event.active) {\r\n        continue;\r\n      }\r\n      this.emit('down', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('down', event);\r\n      this.primary.emit('pointerdown', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameUp) {\r\n      if (!event.active) {\r\n        continue;\r\n      }\r\n      this.emit('up', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('up', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameMove) {\r\n      if (!event.active) {\r\n        continue;\r\n      }\r\n      this.emit('move', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('move', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameCancel) {\r\n      if (!event.active) {\r\n        continue;\r\n      }\r\n      this.emit('cancel', event);\r\n      const pointer = this.at(event.pointerId);\r\n      pointer.emit('cancel', event);\r\n    }\r\n\r\n    for (const event of this.currentFrameWheel) {\r\n      if (!event.active) {\r\n        continue;\r\n      }\r\n      this.emit('pointerwheel', event);\r\n      this.emit('wheel', event);\r\n      this.primary.emit('pointerwheel', event);\r\n      this.primary.emit('wheel', event);\r\n    }\r\n\r\n    if (this.engine.currentScene.camera.hasChanged()) {\r\n      for (const pointer of this._pointers) {\r\n        pointer._updateWorldPosition(this.engine);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clears the current frame event and pointer data\r\n   */\r\n  public clear() {\r\n    for (const event of this.currentFrameUp) {\r\n      this.currentFramePointerCoords.delete(event.pointerId);\r\n      const ids = this._activeNativePointerIdsToNormalized.entries();\r\n      for (const [native, normalized] of ids) {\r\n        if (normalized === event.pointerId) {\r\n          this._activeNativePointerIdsToNormalized.delete(native);\r\n        }\r\n      }\r\n    }\r\n    this.currentFrameDown.length = 0;\r\n    this.currentFrameUp.length = 0;\r\n    this.currentFrameMove.length = 0;\r\n    this.currentFrameCancel.length = 0;\r\n    this.currentFrameWheel.length = 0;\r\n  }\r\n\r\n  private _boundHandle = this._handle.bind(this);\r\n  private _boundWheel = this._handleWheel.bind(this);\r\n  /**\r\n   * Initializes the pointer event receiver so that it can start listening to native\r\n   * browser events.\r\n   */\r\n  public init(options?: PointerInitOptions) {\r\n    if (this.engine.isDisposed()) {\r\n      return;\r\n    }\r\n    // Disabling the touch action avoids browser/platform gestures from firing on the canvas\r\n    // It is important on mobile to have touch action 'none'\r\n    // https://stackoverflow.com/questions/48124372/pointermove-event-not-working-with-touch-why-not\r\n    if (this.target === this.engine.canvas) {\r\n      this.engine.canvas.style.touchAction = 'none';\r\n    } else {\r\n      document.body.style.touchAction = 'none';\r\n    }\r\n    // Preferred pointer events\r\n    if (window.PointerEvent) {\r\n      this.target.addEventListener('pointerdown', this._boundHandle);\r\n      this.target.addEventListener('pointerup', this._boundHandle);\r\n      this.target.addEventListener('pointermove', this._boundHandle);\r\n      this.target.addEventListener('pointercancel', this._boundHandle);\r\n    } else {\r\n      // Touch Events\r\n      this.target.addEventListener('touchstart', this._boundHandle);\r\n      this.target.addEventListener('touchend', this._boundHandle);\r\n      this.target.addEventListener('touchmove', this._boundHandle);\r\n      this.target.addEventListener('touchcancel', this._boundHandle);\r\n\r\n      // Mouse Events\r\n      this.target.addEventListener('mousedown', this._boundHandle);\r\n      this.target.addEventListener('mouseup', this._boundHandle);\r\n      this.target.addEventListener('mousemove', this._boundHandle);\r\n    }\r\n\r\n    // MDN MouseWheelEvent\r\n    const wheelOptions = {\r\n      passive: !(\r\n        this.engine.pageScrollPreventionMode === ScrollPreventionMode.All ||\r\n        this.engine.pageScrollPreventionMode === ScrollPreventionMode.Canvas\r\n      )\r\n    };\r\n    if ('onwheel' in document.createElement('div')) {\r\n      // Modern Browsers\r\n      this.target.addEventListener('wheel', this._boundWheel, wheelOptions);\r\n    } else if (document.onmousewheel !== undefined) {\r\n      // Webkit and IE\r\n      this.target.addEventListener('mousewheel', this._boundWheel, wheelOptions);\r\n    } else {\r\n      // Remaining browser and older Firefox\r\n      this.target.addEventListener('MozMousePixelScroll', this._boundWheel, wheelOptions);\r\n    }\r\n\r\n    const grabWindowFocus = options?.grabWindowFocus ?? true;\r\n    // Handle cross origin iframe\r\n    if (grabWindowFocus && isCrossOriginIframe()) {\r\n      const grabFocus = () => {\r\n        window.focus();\r\n      };\r\n      // Preferred pointer events\r\n      if (window.PointerEvent) {\r\n        this.target.addEventListener('pointerdown', grabFocus);\r\n      } else {\r\n        // Touch Events\r\n        this.target.addEventListener('touchstart', grabFocus);\r\n\r\n        // Mouse Events\r\n        this.target.addEventListener('mousedown', grabFocus);\r\n      }\r\n    }\r\n  }\r\n\r\n  public detach() {\r\n    // Preferred pointer events\r\n    if (window.PointerEvent) {\r\n      this.target.removeEventListener('pointerdown', this._boundHandle);\r\n      this.target.removeEventListener('pointerup', this._boundHandle);\r\n      this.target.removeEventListener('pointermove', this._boundHandle);\r\n      this.target.removeEventListener('pointercancel', this._boundHandle);\r\n    } else {\r\n      // Touch Events\r\n      this.target.removeEventListener('touchstart', this._boundHandle);\r\n      this.target.removeEventListener('touchend', this._boundHandle);\r\n      this.target.removeEventListener('touchmove', this._boundHandle);\r\n      this.target.removeEventListener('touchcancel', this._boundHandle);\r\n\r\n      // Mouse Events\r\n      this.target.removeEventListener('mousedown', this._boundHandle);\r\n      this.target.removeEventListener('mouseup', this._boundHandle);\r\n      this.target.removeEventListener('mousemove', this._boundHandle);\r\n    }\r\n\r\n    if ('onwheel' in document.createElement('div')) {\r\n      // Modern Browsers\r\n      this.target.removeEventListener('wheel', this._boundWheel);\r\n    } else if (document.onmousewheel !== undefined) {\r\n      // Webkit and IE\r\n      this.target.addEventListener('mousewheel', this._boundWheel);\r\n    } else {\r\n      // Remaining browser and older Firefox\r\n      this.target.addEventListener('MozMousePixelScroll', this._boundWheel);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Take native pointer id and map it to index in active pointers\r\n   * @param nativePointerId\r\n   */\r\n  private _normalizePointerId(nativePointerId: number) {\r\n    // Add to the the native pointer set id\r\n    this._activeNativePointerIdsToNormalized.set(nativePointerId, -1);\r\n\r\n    // Native pointer ids in ascending order\r\n    const currentPointerIds = Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((a, b) => a - b);\r\n\r\n    // The index into sorted ids will be the new id, will always have an id\r\n    const id = currentPointerIds.findIndex((p) => p === nativePointerId);\r\n\r\n    // Save the mapping so we can reverse it later\r\n    this._activeNativePointerIdsToNormalized.set(nativePointerId, id);\r\n\r\n    // ignore pointer because game isn't watching\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Responsible for handling and parsing pointer events\r\n   */\r\n  private _handle(ev: NativeTouchEvent | NativePointerEvent | NativeMouseEvent) {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    ev.preventDefault();\r\n    const eventCoords = new Map<number, GlobalCoordinates>();\r\n    let button: PointerButton;\r\n    let pointerType: PointerType;\r\n    if (isTouchEvent(ev)) {\r\n      button = PointerButton.Unknown;\r\n      pointerType = PointerType.Touch;\r\n      // https://developer.mozilla.org/en-US/docs/Web/API/TouchEvent\r\n      for (let i = 0; i < ev.changedTouches.length; i++) {\r\n        const touch = ev.changedTouches[i];\r\n        const coordinates = GlobalCoordinates.fromPagePosition(touch.pageX, touch.pageY, this.engine);\r\n        const nativePointerId = i + 1;\r\n        const pointerId = this._normalizePointerId(nativePointerId);\r\n        this.currentFramePointerCoords.set(pointerId, coordinates);\r\n        eventCoords.set(pointerId, coordinates);\r\n      }\r\n    } else {\r\n      button = this._nativeButtonToPointerButton(ev.button);\r\n      pointerType = PointerType.Mouse;\r\n      const coordinates = GlobalCoordinates.fromPagePosition(ev.pageX, ev.pageY, this.engine);\r\n      let nativePointerId = 1;\r\n      if (isPointerEvent(ev)) {\r\n        nativePointerId = ev.pointerId;\r\n        pointerType = this._stringToPointerType(ev.pointerType);\r\n      }\r\n      const pointerId = this._normalizePointerId(nativePointerId);\r\n      this.currentFramePointerCoords.set(pointerId, coordinates);\r\n      eventCoords.set(pointerId, coordinates);\r\n    }\r\n\r\n    for (const [pointerId, coord] of eventCoords.entries()) {\r\n      switch (ev.type) {\r\n        case 'mousedown':\r\n        case 'pointerdown':\r\n        case 'touchstart':\r\n          this.currentFrameDown.push(new PointerEvent('down', pointerId, button, pointerType, coord, ev));\r\n          this.currentFramePointerDown.set(pointerId, true);\r\n          break;\r\n        case 'mouseup':\r\n        case 'pointerup':\r\n        case 'touchend':\r\n          this.currentFrameUp.push(new PointerEvent('up', pointerId, button, pointerType, coord, ev));\r\n          this.currentFramePointerDown.set(pointerId, false);\r\n          break;\r\n        case 'mousemove':\r\n        case 'pointermove':\r\n        case 'touchmove':\r\n          this.currentFrameMove.push(new PointerEvent('move', pointerId, button, pointerType, coord, ev));\r\n          break;\r\n        case 'touchcancel':\r\n        case 'pointercancel':\r\n          this.currentFrameCancel.push(new PointerEvent('cancel', pointerId, button, pointerType, coord, ev));\r\n          break;\r\n      }\r\n    }\r\n  }\r\n\r\n  private _handleWheel(ev: NativeWheelEvent) {\r\n    if (!this._enabled) {\r\n      return;\r\n    }\r\n    // Should we prevent page scroll because of this event\r\n    if (\r\n      this.engine.pageScrollPreventionMode === ScrollPreventionMode.All ||\r\n      (this.engine.pageScrollPreventionMode === ScrollPreventionMode.Canvas && ev.target === this.engine.canvas)\r\n    ) {\r\n      ev.preventDefault();\r\n    }\r\n    const screen = this.engine.screen.pageToScreenCoordinates(vec(ev.pageX, ev.pageY));\r\n    const world = this.engine.screen.screenToWorldCoordinates(screen);\r\n\r\n    /**\r\n     * A constant used to normalize wheel events across different browsers\r\n     *\r\n     * This normalization factor is pulled from\r\n     * https://developer.mozilla.org/en-US/docs/Web/Events/wheel#Listening_to_this_event_across_browser\r\n     */\r\n    const ScrollWheelNormalizationFactor = -1 / 40;\r\n\r\n    const deltaX = ev.deltaX || ev.wheelDeltaX * ScrollWheelNormalizationFactor || 0;\r\n    const deltaY =\r\n      ev.deltaY || ev.wheelDeltaY * ScrollWheelNormalizationFactor || ev.wheelDelta * ScrollWheelNormalizationFactor || ev.detail || 0;\r\n    const deltaZ = ev.deltaZ || 0;\r\n    let deltaMode = WheelDeltaMode.Pixel;\r\n\r\n    if (ev.deltaMode) {\r\n      if (ev.deltaMode === 1) {\r\n        deltaMode = WheelDeltaMode.Line;\r\n      } else if (ev.deltaMode === 2) {\r\n        deltaMode = WheelDeltaMode.Page;\r\n      }\r\n    }\r\n\r\n    const we = new WheelEvent(world.x, world.y, ev.pageX, ev.pageY, screen.x, screen.y, 0, deltaX, deltaY, deltaZ, deltaMode, ev);\r\n    this.currentFrameWheel.push(we);\r\n  }\r\n\r\n  /**\r\n   * Triggers an excalibur pointer event in a world space pos\r\n   *\r\n   * Useful for testing pointers in excalibur\r\n   * @param type\r\n   * @param pos\r\n   */\r\n  public triggerEvent(type: 'down' | 'up' | 'move' | 'cancel', pos: Vector) {\r\n    const page = this.engine.screen.worldToPageCoordinates(pos);\r\n    // Send an event to the event receiver\r\n    if (window.PointerEvent) {\r\n      this._handle(\r\n        new window.PointerEvent('pointer' + type, {\r\n          pointerId: 0,\r\n          clientX: page.x,\r\n          clientY: page.y\r\n        })\r\n      );\r\n    } else {\r\n      // Safari hack\r\n      this._handle(\r\n        new window.MouseEvent('mouse' + type, {\r\n          clientX: page.x,\r\n          clientY: page.y\r\n        })\r\n      );\r\n    }\r\n\r\n    // Force update pointer system\r\n    const pointerSystem = this.engine.currentScene.world.get(PointerSystem);\r\n    pointerSystem.preupdate(this.engine.currentScene, 1);\r\n    pointerSystem.update(1);\r\n  }\r\n\r\n  private _nativeButtonToPointerButton(s: NativePointerButton): PointerButton {\r\n    switch (s) {\r\n      case NativePointerButton.NoButton:\r\n        return PointerButton.NoButton;\r\n      case NativePointerButton.Left:\r\n        return PointerButton.Left;\r\n      case NativePointerButton.Middle:\r\n        return PointerButton.Middle;\r\n      case NativePointerButton.Right:\r\n        return PointerButton.Right;\r\n      case NativePointerButton.Unknown:\r\n        return PointerButton.Unknown;\r\n      default:\r\n        return fail(s);\r\n    }\r\n  }\r\n\r\n  private _stringToPointerType(s: string) {\r\n    switch (s) {\r\n      case 'touch':\r\n        return PointerType.Touch;\r\n      case 'mouse':\r\n        return PointerType.Mouse;\r\n      case 'pen':\r\n        return PointerType.Pen;\r\n      default:\r\n        return PointerType.Unknown;\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Gamepads } from './Gamepad';\r\nimport { InputMapper } from './InputMapper';\r\nimport { Keyboard } from './Keyboard';\r\nimport { PointerEventReceiver } from './PointerEventReceiver';\r\n\r\nexport interface InputHostOptions {\r\n  pointerTarget: Document | HTMLCanvasElement;\r\n  grabWindowFocus: boolean;\r\n  engine: Engine;\r\n}\r\n\r\nexport class InputHost {\r\n  private _enabled = true;\r\n\r\n  keyboard: Keyboard;\r\n  pointers: PointerEventReceiver;\r\n  gamepads: Gamepads;\r\n  inputMapper: InputMapper;\r\n\r\n  constructor(options: InputHostOptions) {\r\n    const { pointerTarget, grabWindowFocus, engine } = options;\r\n    this.keyboard = new Keyboard();\r\n    this.pointers = new PointerEventReceiver(pointerTarget, engine);\r\n    this.gamepads = new Gamepads();\r\n\r\n    this.keyboard.init({ grabWindowFocus });\r\n    this.pointers.init({ grabWindowFocus });\r\n    this.gamepads.init();\r\n    this.inputMapper = new InputMapper({\r\n      keyboard: this.keyboard,\r\n      pointers: this.pointers,\r\n      gamepads: this.gamepads\r\n    });\r\n  }\r\n\r\n  get enabled() {\r\n    return this._enabled;\r\n  }\r\n\r\n  toggleEnabled(enabled: boolean) {\r\n    this._enabled = enabled;\r\n    this.keyboard.toggleEnabled(this._enabled);\r\n    this.pointers.toggleEnabled(this._enabled);\r\n    this.gamepads.toggleEnabled(this._enabled);\r\n  }\r\n\r\n  update() {\r\n    if (this._enabled) {\r\n      this.inputMapper.execute();\r\n      this.keyboard.update();\r\n      this.gamepads.update();\r\n    }\r\n  }\r\n\r\n  clear() {\r\n    this.keyboard.clear();\r\n    this.pointers.clear();\r\n    // this.gamepads.clear();\r\n  }\r\n}\r\n","import { isScreenElement, ScreenElement } from './ScreenElement';\r\nimport {\r\n  InitializeEvent,\r\n  ActivateEvent,\r\n  DeactivateEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  PreDebugDrawEvent,\r\n  PostDebugDrawEvent\r\n} from './Events';\r\nimport { Logger } from './Util/Log';\r\nimport { Timer } from './Timer';\r\nimport { Engine } from './Engine';\r\nimport { TileMap } from './TileMap';\r\nimport { Camera } from './Camera';\r\nimport { Actor } from './Actor';\r\nimport { CanInitialize, CanActivate, CanDeactivate, CanUpdate, CanDraw, SceneActivationContext } from './Interfaces/LifecycleEvents';\r\nimport * as Util from './Util/Util';\r\nimport { Trigger } from './Trigger';\r\nimport { SystemType } from './EntityComponentSystem/System';\r\nimport { World } from './EntityComponentSystem/World';\r\nimport { MotionSystem } from './Collision/MotionSystem';\r\nimport { CollisionSystem } from './Collision/CollisionSystem';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { GraphicsSystem } from './Graphics/GraphicsSystem';\r\nimport { DebugSystem } from './Debug/DebugSystem';\r\nimport { PointerSystem } from './Input/PointerSystem';\r\nimport { ActionsSystem } from './Actions/ActionsSystem';\r\nimport { IsometricEntitySystem } from './TileMap/IsometricEntitySystem';\r\nimport { OffscreenSystem } from './Graphics/OffscreenSystem';\r\nimport { ExcaliburGraphicsContext } from './Graphics';\r\nimport { PhysicsWorld } from './Collision/PhysicsWorld';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { Color } from './Color';\r\nimport { DefaultLoader } from './Director/DefaultLoader';\r\nimport { Transition } from './Director';\r\nimport { InputHost } from './Input/InputHost';\r\nimport { PointerScope } from './Input/PointerScope';\r\nimport { getDefaultPhysicsConfig } from './Collision/PhysicsConfig';\r\n\r\nexport class PreLoadEvent {\r\n  loader: DefaultLoader;\r\n}\r\n\r\nexport type SceneEvents = {\r\n  initialize: InitializeEvent<Scene>;\r\n  activate: ActivateEvent;\r\n  deactivate: DeactivateEvent;\r\n  preupdate: PreUpdateEvent;\r\n  postupdate: PostUpdateEvent;\r\n  predraw: PreDrawEvent;\r\n  postdraw: PostDrawEvent;\r\n  predebugdraw: PreDebugDrawEvent;\r\n  postdebugdraw: PostDebugDrawEvent;\r\n  preload: PreLoadEvent;\r\n};\r\n\r\nexport const SceneEvents = {\r\n  Initialize: 'initialize',\r\n  Activate: 'activate',\r\n  Deactivate: 'deactivate',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw',\r\n  PreDebugDraw: 'predebugdraw',\r\n  PostDebugDraw: 'postdebugdraw',\r\n  PreLoad: 'preload'\r\n};\r\n\r\nexport type SceneConstructor = new (...args: any[]) => Scene;\r\n/**\r\n *\r\n */\r\nexport function isSceneConstructor(x: any): x is SceneConstructor {\r\n  return !!x?.prototype && !!x?.prototype?.constructor?.name;\r\n}\r\n\r\n/**\r\n * {@apilink Actor | `Actors`} are composed together into groupings called Scenes in\r\n * Excalibur. The metaphor models the same idea behind real world\r\n * actors in a scene. Only actors in scenes will be updated and drawn.\r\n *\r\n * Typical usages of a scene include: levels, menus, loading screens, etc.\r\n */\r\nexport class Scene<TActivationData = unknown> implements CanInitialize, CanActivate<TActivationData>, CanDeactivate, CanUpdate, CanDraw {\r\n  private _logger: Logger = Logger.getInstance();\r\n  public events = new EventEmitter<SceneEvents>();\r\n\r\n  /**\r\n   * Gets or sets the current camera for the scene\r\n   */\r\n  public camera: Camera = new Camera();\r\n\r\n  /**\r\n   * Scene specific background color\r\n   */\r\n  public backgroundColor?: Color;\r\n\r\n  /**\r\n   * The ECS world for the scene\r\n   */\r\n  public world: World = new World(this);\r\n\r\n  /**\r\n   * The Excalibur physics world for the scene. Used to interact\r\n   * with colliders included in the scene.\r\n   *\r\n   * Can be used to perform scene ray casts, track colliders, broadphase, and narrowphase.\r\n   */\r\n  public physics = new PhysicsWorld(getDefaultPhysicsConfig());\r\n\r\n  /**\r\n   * The actors in the current scene\r\n   */\r\n  public get actors(): readonly Actor[] {\r\n    return this.world.entityManager.entities.filter((e: Entity<any>) => {\r\n      return e instanceof Actor;\r\n    }) as Actor[];\r\n  }\r\n\r\n  /**\r\n   * The entities in the current scene\r\n   */\r\n  public get entities(): readonly Entity[] {\r\n    return this.world.entityManager.entities;\r\n  }\r\n\r\n  /**\r\n   * The triggers in the current scene\r\n   */\r\n  public get triggers(): readonly Trigger[] {\r\n    return this.world.entityManager.entities.filter((e: Entity<any>) => {\r\n      return e instanceof Trigger;\r\n    }) as Trigger[];\r\n  }\r\n\r\n  /**\r\n   * The {@apilink TileMap}s in the scene, if any\r\n   */\r\n  public get tileMaps(): readonly TileMap[] {\r\n    return this.world.entityManager.entities.filter((e: Entity<any>) => {\r\n      return e instanceof TileMap;\r\n    }) as TileMap[];\r\n  }\r\n\r\n  /**\r\n   * Access to the Excalibur engine\r\n   */\r\n  public engine: Engine;\r\n\r\n  /**\r\n   * Access scene specific input, handlers on this only fire when this scene is active.\r\n   */\r\n  public input: InputHost;\r\n\r\n  private _isInitialized: boolean = false;\r\n  private _timers: Timer[] = [];\r\n  public get timers(): readonly Timer[] {\r\n    return this._timers;\r\n  }\r\n  private _cancelQueue: Timer[] = [];\r\n\r\n  constructor() {\r\n    // Initialize systems\r\n\r\n    // Update\r\n    this.world.add(ActionsSystem);\r\n    this.world.add(new MotionSystem(this.world, this.physics));\r\n    this.world.add(new CollisionSystem(this.world, this.physics));\r\n    this.world.add(PointerSystem);\r\n    this.world.add(IsometricEntitySystem);\r\n    // Draw\r\n    this.world.add(OffscreenSystem);\r\n    this.world.add(GraphicsSystem);\r\n    this.world.add(DebugSystem);\r\n  }\r\n\r\n  public emit<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, event: SceneEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, handler: Handler<SceneEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, handler: Handler<SceneEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<SceneEvents>>(eventName: TEventName, handler: Handler<SceneEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<SceneEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Event hook to provide Scenes a way of loading scene specific resources.\r\n   *\r\n   * This is called before the Scene.onInitialize during scene transition. It will only ever fire once for a scene.\r\n   * @param loader\r\n   */\r\n  public onPreLoad(loader: DefaultLoader) {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Event hook fired directly before transition, either \"in\" or \"out\" of the scene\r\n   *\r\n   * This overrides the Engine scene definition. However transitions specified in goToScene take highest precedence\r\n   *\r\n   * ```typescript\r\n   * // Overrides all\r\n   * Engine.goToScene('scene', { destinationIn: ..., sourceOut: ... });\r\n   * ```\r\n   *\r\n   * This can be used to configure custom transitions for a scene dynamically\r\n   */\r\n  public onTransition(direction: 'in' | 'out'): Transition | undefined {\r\n    // will be overridden\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * This is called before the first update of the {@apilink Scene}. Initializes scene members like the camera. This method is meant to be\r\n   * overridden. This is where initialization of child actors should take place.\r\n   */\r\n  public onInitialize(engine: Engine): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * This is called when the scene is made active and started. It is meant to be overridden,\r\n   * this is where you should setup any DOM UI or event handlers needed for the scene.\r\n   */\r\n  public onActivate(context: SceneActivationContext<TActivationData>): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * This is called when the scene is made transitioned away from and stopped. It is meant to be overridden,\r\n   * this is where you should cleanup any DOM UI or event handlers needed for the scene.\r\n   */\r\n  public onDeactivate(context: SceneActivationContext): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreUpdate` is called directly before a scene is updated.\r\n   * @param engine reference to the engine\r\n   * @param elapsed  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  public onPreUpdate(engine: Engine, elapsed: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostUpdate lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostUpdate` is called directly after a scene is updated.\r\n   * @param engine reference to the engine\r\n   * @param elapsed  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  public onPostUpdate(engine: Engine, elapsed: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPreDraw lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPreDraw` is called directly before a scene is drawn.\r\n   *\r\n   */\r\n  public onPreDraw(ctx: ExcaliburGraphicsContext, elapsed: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Safe to override onPostDraw lifecycle event handler. Synonymous with `.on('preupdate', (evt) =>{...})`\r\n   *\r\n   * `onPostDraw` is called directly after a scene is drawn.\r\n   *\r\n   */\r\n  public onPostDraw(ctx: ExcaliburGraphicsContext, elapsed: number): void {\r\n    // will be overridden\r\n  }\r\n\r\n  /**\r\n   * Initializes actors in the scene\r\n   */\r\n  private _initializeChildren() {\r\n    for (const child of this.entities) {\r\n      child._initialize(this.engine);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Gets whether or not the {@apilink Scene} has been initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Initializes the scene before the first update, meant to be called by engine not by users of\r\n   * Excalibur\r\n   * @internal\r\n   */\r\n  public async _initialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      try {\r\n        this.engine = engine;\r\n        // PhysicsWorld config is watched so things will automagically update\r\n        this.physics.config = this.engine.physics;\r\n        this.input = new InputHost({\r\n          pointerTarget: engine.pointerScope === PointerScope.Canvas ? engine.canvas : document,\r\n          grabWindowFocus: engine.grabWindowFocus,\r\n          engine\r\n        });\r\n        // Initialize camera first\r\n        this.camera._initialize(engine);\r\n\r\n        this.world.systemManager.initialize();\r\n\r\n        // This order is important! we want to be sure any custom init that add actors\r\n        // fire before the actor init\r\n        await this.onInitialize(engine);\r\n        this._initializeChildren();\r\n\r\n        this._logger.debug('Scene.onInitialize', this, engine);\r\n        this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      } catch (e) {\r\n        this._logger.error(`Error during scene initialization for scene ${engine.director?.getSceneName(this)}!`);\r\n        throw e;\r\n      }\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Activates the scene with the base behavior, then calls the overridable `onActivate` implementation.\r\n   * @internal\r\n   */\r\n  public async _activate(context: SceneActivationContext<TActivationData>) {\r\n    try {\r\n      this._logger.debug('Scene.onActivate', this);\r\n      this.input.toggleEnabled(true);\r\n      await this.onActivate(context);\r\n    } catch (e) {\r\n      this._logger.error(`Error during scene activation for scene ${this.engine?.director?.getSceneName(this)}!`);\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Deactivates the scene with the base behavior, then calls the overridable `onDeactivate` implementation.\r\n   * @internal\r\n   */\r\n  public async _deactivate(context: SceneActivationContext<never>) {\r\n    this._logger.debug('Scene.onDeactivate', this);\r\n    this.input.toggleEnabled(false);\r\n    await this.onDeactivate(context);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPreUpdate} lifecycle event\r\n   * @internal\r\n   */\r\n  public _preupdate(engine: Engine, elapsed: number): void {\r\n    this.emit('preupdate', new PreUpdateEvent(engine, elapsed, this));\r\n    this.onPreUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   *  It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _preupdate handler for {@apilink onPostUpdate} lifecycle event\r\n   * @internal\r\n   */\r\n  public _postupdate(engine: Engine, elapsed: number): void {\r\n    this.emit('postupdate', new PostUpdateEvent(engine, elapsed, this));\r\n    this.onPostUpdate(engine, elapsed);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _predraw handler for {@apilink onPreDraw} lifecycle event\r\n   * @internal\r\n   */\r\n  public _predraw(ctx: ExcaliburGraphicsContext, elapsed: number): void {\r\n    this.emit('predraw', new PreDrawEvent(ctx, elapsed, this));\r\n    this.onPreDraw(ctx, elapsed);\r\n  }\r\n\r\n  /**\r\n   * It is not recommended that internal excalibur methods be overridden, do so at your own risk.\r\n   *\r\n   * Internal _postdraw handler for {@apilink onPostDraw} lifecycle event\r\n   * @internal\r\n   */\r\n  public _postdraw(ctx: ExcaliburGraphicsContext, elapsed: number): void {\r\n    this.emit('postdraw', new PostDrawEvent(ctx, elapsed, this));\r\n    this.onPostDraw(ctx, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Updates all the actors and timers in the scene. Called by the {@apilink Engine}.\r\n   * @param engine  Reference to the current Engine\r\n   * @param elapsed   The number of milliseconds since the last update\r\n   */\r\n  public update(engine: Engine, elapsed: number) {\r\n    if (!this.isInitialized) {\r\n      this._logger.warnOnce(`Scene update called before initialize for scene ${engine.director?.getSceneName(this)}!`);\r\n      return;\r\n    }\r\n    this._preupdate(engine, elapsed);\r\n\r\n    // TODO differed entity removal for timers\r\n    let i: number, len: number;\r\n    // Remove timers in the cancel queue before updating them\r\n    for (i = 0, len = this._cancelQueue.length; i < len; i++) {\r\n      this.removeTimer(this._cancelQueue[i]);\r\n    }\r\n    this._cancelQueue.length = 0;\r\n\r\n    // Cycle through timers updating timers\r\n    for (const timer of this._timers) {\r\n      timer.update(elapsed);\r\n    }\r\n\r\n    this.world.update(SystemType.Update, elapsed);\r\n\r\n    // Camera last keeps renders smooth that are based on entity/actor\r\n    if (this.camera) {\r\n      this.camera.update(engine, elapsed);\r\n    }\r\n\r\n    this._collectActorStats(engine);\r\n\r\n    this._postupdate(engine, elapsed);\r\n\r\n    this.input.update();\r\n  }\r\n\r\n  /**\r\n   * Draws all the actors in the Scene. Called by the {@apilink Engine}.\r\n   * @param ctx    The current rendering context\r\n   * @param elapsed  The number of milliseconds since the last draw\r\n   */\r\n  public draw(ctx: ExcaliburGraphicsContext, elapsed: number) {\r\n    if (!this.isInitialized) {\r\n      this._logger.warnOnce(`Scene draw called before initialize!`);\r\n      return;\r\n    }\r\n    this._predraw(ctx, elapsed);\r\n\r\n    this.world.update(SystemType.Draw, elapsed);\r\n\r\n    if (this.engine?.isDebug) {\r\n      this.debugDraw(ctx);\r\n    }\r\n    this._postdraw(ctx, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Draws all the actors' debug information in the Scene. Called by the {@apilink Engine}.\r\n   * @param ctx  The current rendering context\r\n   */\r\n  /* istanbul ignore next */\r\n  public debugDraw(ctx: ExcaliburGraphicsContext) {\r\n    this.emit('predebugdraw', new PreDebugDrawEvent(ctx, this));\r\n    // pass\r\n    this.emit('postdebugdraw', new PostDebugDrawEvent(ctx, this));\r\n  }\r\n\r\n  /**\r\n   * Checks whether an actor is contained in this scene or not\r\n   */\r\n  public contains(actor: Actor): boolean {\r\n    return this.actors.indexOf(actor) > -1;\r\n  }\r\n\r\n  /**\r\n   * Adds a {@apilink Timer} to the current {@apilink Scene}.\r\n   * @param timer  The timer to add to the current {@apilink Scene}.\r\n   */\r\n  public add(timer: Timer): void;\r\n\r\n  /**\r\n   * Adds a {@apilink TileMap} to the {@apilink Scene}, once this is done the {@apilink TileMap} will be drawn and updated.\r\n   */\r\n  public add(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Adds a {@apilink Trigger} to the {@apilink Scene}, once this is done the {@apilink Trigger} will listen for interactions with other actors.\r\n   * @param trigger\r\n   */\r\n  public add(trigger: Trigger): void;\r\n\r\n  /**\r\n   * Adds an actor to the scene, once this is done the {@apilink Actor} will be drawn and updated.\r\n   * @param actor  The actor to add to the current scene\r\n   */\r\n  public add(actor: Actor): void;\r\n\r\n  /**\r\n   * Adds an {@apilink Entity} to the scene, once this is done the {@apilink Actor} will be drawn and updated.\r\n   * @param entity The entity to add to the current scene\r\n   */\r\n  public add(entity: Entity): void;\r\n\r\n  /**\r\n   * Adds a {@apilink ScreenElement} to the scene.\r\n   * @param screenElement  The ScreenElement to add to the current scene\r\n   */\r\n  public add(screenElement: ScreenElement): void;\r\n  public add(entity: any): void {\r\n    this.emit('entityadded', { target: entity } as any);\r\n    if (entity instanceof Timer) {\r\n      if (!Util.contains(this._timers, entity)) {\r\n        this.addTimer(entity);\r\n      }\r\n      return;\r\n    }\r\n    this.world.add(entity);\r\n    entity.scene = this;\r\n  }\r\n\r\n  /**\r\n   * Removes a {@apilink Timer} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param timer The Timer to transfer to the current scene\r\n   */\r\n  public transfer(timer: Timer): void;\r\n\r\n  /**\r\n   * Removes a {@apilink TileMap} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param tileMap The TileMap to transfer to the current scene\r\n   */\r\n  public transfer(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Removes a {@apilink Trigger} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param trigger The Trigger to transfer to the current scene\r\n   */\r\n  public transfer(trigger: Trigger): void;\r\n\r\n  /**\r\n   * Removes an {@apilink Actor} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param actor The Actor to transfer to the current scene\r\n   */\r\n  public transfer(actor: Actor): void;\r\n\r\n  /**\r\n   * Removes an {@apilink Entity} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param entity The Entity to transfer to the current scene\r\n   */\r\n  public transfer(entity: Entity): void;\r\n\r\n  /**\r\n   * Removes a {@apilink ScreenElement} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param screenElement The ScreenElement to transfer to the current scene\r\n   */\r\n  public transfer(screenElement: ScreenElement): void;\r\n\r\n  /**\r\n   * Removes an {@apilink Entity} (Actor, TileMap, Trigger, etc) or {@apilink Timer} from it's current scene\r\n   * and adds it to this scene.\r\n   *\r\n   * Useful if you want to have an object be present in only 1 scene at a time.\r\n   * @param entity\r\n   */\r\n  public transfer(entity: any): void {\r\n    let scene: Scene;\r\n    if (entity instanceof Entity && entity.scene && entity.scene !== this) {\r\n      scene = entity.scene;\r\n      entity.scene.world.remove(entity, false);\r\n    }\r\n    if (entity instanceof Timer && entity.scene) {\r\n      scene = entity.scene;\r\n      entity.scene.removeTimer(entity);\r\n    }\r\n\r\n    scene?.emit('entityremoved', { target: entity } as any);\r\n    this.add(entity);\r\n  }\r\n\r\n  /**\r\n   * Removes a {@apilink Timer} from the current scene, it will no longer be updated.\r\n   * @param timer  The timer to remove to the current scene.\r\n   */\r\n  public remove(timer: Timer): void;\r\n\r\n  /**\r\n   * Removes a {@apilink TileMap} from the scene, it will no longer be drawn or updated.\r\n   * @param tileMap {TileMap}\r\n   */\r\n  public remove(tileMap: TileMap): void;\r\n\r\n  /**\r\n   * Removes an actor from the scene, it will no longer be drawn or updated.\r\n   * @param actor  The actor to remove from the current scene.\r\n   */\r\n  public remove(actor: Actor): void;\r\n\r\n  public remove(entity: Entity): void;\r\n\r\n  /**\r\n   * Removes a {@apilink ScreenElement} to the scene, it will no longer be drawn or updated\r\n   * @param screenElement  The ScreenElement to remove from the current scene\r\n   */\r\n  public remove(screenElement: ScreenElement): void;\r\n  public remove(entity: any): void {\r\n    this.emit('entityremoved', { target: entity } as any);\r\n    if (entity instanceof Entity) {\r\n      if (entity.isActive) {\r\n        entity.kill();\r\n      }\r\n      this.world.remove(entity);\r\n    }\r\n    if (entity instanceof Timer) {\r\n      this.removeTimer(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes all entities and timers from the scene, optionally indicate whether deferred should or shouldn't be used.\r\n   *\r\n   * By default entities use deferred removal\r\n   * @param deferred\r\n   */\r\n  public clear(deferred: boolean = true): void {\r\n    for (let i = this.entities.length - 1; i >= 0; i--) {\r\n      this.world.remove(this.entities[i], deferred);\r\n    }\r\n    for (let i = this.timers.length - 1; i >= 0; i--) {\r\n      this.removeTimer(this.timers[i]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adds a {@apilink Timer} to the scene\r\n   * @param timer  The timer to add\r\n   */\r\n  public addTimer(timer: Timer): Timer {\r\n    this._timers.push(timer);\r\n    timer.scene = this;\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Removes a {@apilink Timer} from the scene.\r\n   * @warning Can be dangerous, use {@apilink cancelTimer} instead\r\n   * @param timer  The timer to remove\r\n   */\r\n  public removeTimer(timer: Timer): Timer {\r\n    const i = this._timers.indexOf(timer);\r\n    if (i !== -1) {\r\n      this._timers.splice(i, 1);\r\n    }\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Cancels a {@apilink Timer}, removing it from the scene nicely\r\n   * @param timer  The timer to cancel\r\n   */\r\n  public cancelTimer(timer: Timer): Timer {\r\n    this._cancelQueue.push(timer);\r\n    return timer;\r\n  }\r\n\r\n  /**\r\n   * Tests whether a {@apilink Timer} is active in the scene\r\n   */\r\n  public isTimerActive(timer: Timer): boolean {\r\n    return this._timers.indexOf(timer) > -1 && !timer.complete;\r\n  }\r\n\r\n  public isCurrentScene(): boolean {\r\n    if (this.engine) {\r\n      return this.engine.currentScene === this;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private _collectActorStats(engine: Engine) {\r\n    const actors = this.actors;\r\n    for (let i = 0; i < actors.length; i++) {\r\n      const actor = actors[i];\r\n      if (actor instanceof ScreenElement) {\r\n        engine.stats.currFrame.actors.ui++;\r\n      }\r\n      engine.stats.currFrame.actors.alive++;\r\n      for (let j = 0; j < actor.children.length; j++) {\r\n        const child = actor.children[j];\r\n        if (isScreenElement(child as Actor)) {\r\n          // TODO not true\r\n          engine.stats.currFrame.actors.ui++;\r\n        } else {\r\n          engine.stats.currFrame.actors.alive++;\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n","export enum ColorBlindnessMode {\r\n  Protanope = 'Protanope',\r\n  Deuteranope = 'Deuteranope',\r\n  Tritanope = 'Tritanope'\r\n}\r\n","import { Logger } from '../../Util/Log';\r\nimport { Shader } from '../Context/shader';\r\nimport { VertexBuffer } from '../Context/vertex-buffer';\r\nimport { VertexLayout } from '../Context/vertex-layout';\r\n\r\n/**\r\n * Helper that defines a whole screen renderer, just provide a fragment source!\r\n *\r\n * Currently supports 1 varying\r\n * - vec2 a_texcoord between 0-1 which corresponds to screen position\r\n */\r\nexport class ScreenShader {\r\n  private _shader: Shader;\r\n  private _buffer: VertexBuffer;\r\n  private _layout: VertexLayout;\r\n  constructor(gl: WebGL2RenderingContext, fragmentSource: string) {\r\n    if (process.env.NODE_ENV === 'development') {\r\n      if (fragmentSource.includes('v_texcoord')) {\r\n        Logger.getInstance().warn(\r\n          `ScreenShader: \"v_texcoord\" is deprecated in postprocessing fragment shaders will be removed in v1.0,` +\r\n            ` use \"v_uv\" instead. Source [${fragmentSource}]`\r\n        );\r\n      }\r\n    }\r\n    this._shader = new Shader({\r\n      gl,\r\n      vertexSource: `#version 300 es\r\n      in vec2 a_position;\r\n      in vec2 a_uv;\r\n      out vec2 v_texcoord;\r\n      out vec2 v_uv;\r\n\r\n      void main() {\r\n        gl_Position = vec4(a_position, 0.0, 1.0);\r\n        // Pass the texcoord to the fragment shader.\r\n        v_texcoord = a_uv;\r\n        v_uv = a_uv;\r\n      }`,\r\n      fragmentSource: fragmentSource\r\n    });\r\n    this._shader.compile();\r\n    // Setup memory layout\r\n    this._buffer = new VertexBuffer({\r\n      gl,\r\n      type: 'static',\r\n      // clip space quad + uv since we don't need a camera\r\n      data: new Float32Array([\r\n        -1, -1, 0, 0, -1, 1, 0, 1, 1, -1, 1, 0,\r\n\r\n        1, -1, 1, 0, -1, 1, 0, 1, 1, 1, 1, 1\r\n      ])\r\n    });\r\n    this._layout = new VertexLayout({\r\n      gl,\r\n      shader: this._shader,\r\n      vertexBuffer: this._buffer,\r\n      attributes: [\r\n        ['a_position', 2],\r\n        ['a_uv', 2]\r\n      ]\r\n    });\r\n    this._buffer.upload();\r\n  }\r\n\r\n  public getShader() {\r\n    return this._shader;\r\n  }\r\n  public getLayout() {\r\n    return this._layout;\r\n  }\r\n}\r\n","import colorBlindCorrectSource from './color-blind-fragment.glsl';\r\nimport { PostProcessor } from './PostProcessor';\r\nimport { ColorBlindnessMode } from './ColorBlindnessMode';\r\nimport { Shader } from '../Context/shader';\r\nimport { VertexLayout } from '../Context/vertex-layout';\r\nimport { ScreenShader } from './ScreenShader';\r\n\r\nexport class ColorBlindnessPostProcessor implements PostProcessor {\r\n  private _shader!: ScreenShader;\r\n  private _simulate = false;\r\n  constructor(\r\n    private _colorBlindnessMode: ColorBlindnessMode,\r\n    simulate = false\r\n  ) {\r\n    this._simulate = simulate;\r\n  }\r\n\r\n  initialize(gl: WebGL2RenderingContext): void {\r\n    this._shader = new ScreenShader(gl, colorBlindCorrectSource);\r\n    this.simulate = this._simulate;\r\n    this.colorBlindnessMode = this._colorBlindnessMode;\r\n  }\r\n\r\n  getShader(): Shader {\r\n    return this._shader.getShader();\r\n  }\r\n\r\n  getLayout(): VertexLayout {\r\n    return this._shader.getLayout();\r\n  }\r\n\r\n  set colorBlindnessMode(colorBlindMode: ColorBlindnessMode) {\r\n    this._colorBlindnessMode = colorBlindMode;\r\n    if (this._shader) {\r\n      const shader = this._shader.getShader();\r\n      shader.use();\r\n      if (this._colorBlindnessMode === ColorBlindnessMode.Protanope) {\r\n        shader.setUniformInt('u_type', 0);\r\n      } else if (this._colorBlindnessMode === ColorBlindnessMode.Deuteranope) {\r\n        shader.setUniformInt('u_type', 1);\r\n      } else if (this._colorBlindnessMode === ColorBlindnessMode.Tritanope) {\r\n        shader.setUniformInt('u_type', 2);\r\n      }\r\n    }\r\n  }\r\n\r\n  get colorBlindnessMode(): ColorBlindnessMode {\r\n    return this._colorBlindnessMode;\r\n  }\r\n\r\n  set simulate(value: boolean) {\r\n    this._simulate = value;\r\n    if (this._shader) {\r\n      const shader = this._shader.getShader();\r\n      shader.use();\r\n      shader.setUniformBoolean('u_simulate', value);\r\n    }\r\n  }\r\n\r\n  get simulate(): boolean {\r\n    return this._simulate;\r\n  }\r\n}\r\n","export default \"#version 300 es\\r\\nprecision mediump float;\\r\\n// our texture\\r\\nuniform sampler2D u_image;\\r\\n// the texCoords passed in from the vertex shader.\\r\\nin vec2 v_texcoord;\\r\\n\\r\\n// color blind type\\r\\nuniform int u_type;\\r\\n\\r\\n// simulation?\\r\\nuniform bool u_simulate;\\r\\n\\r\\nout vec4 fragColor;\\r\\n\\r\\nvoid main() {\\r\\n  vec4 o =  texture(u_image, v_texcoord);\\r\\n  // RGB to LMS matrix conversion\\r\\n  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\\r\\n  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\\r\\n  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\\r\\n  // Simulate color blindness\\r\\n  float l;\\r\\n  float m;\\r\\n  float s;\\r\\n  //MODE CODE//\\r\\n  if (u_type == 0) {\\r\\n    // Protanope\\r\\n    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\\r\\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\\r\\n    s = 0.0 * L + 0.0 * M + 1.0 * S;;\\r\\n  } else if (u_type == 1) {\\r\\n    // Deuteranope\\r\\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\\r\\n    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\\r\\n    s = 0.0 * L + 0.0 * M + 1.0 * S;\\r\\n  } else if (u_type == 2) {\\r\\n    // Tritanope\\r\\n    l = 1.0 * L + 0.0 * M + 0.0 * S;\\r\\n    m = 0.0 * L + 1.0 * M + 0.0 * S;\\r\\n    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\\r\\n  }\\r\\n\\r\\n  // LMS to RGB matrix conversion\\r\\n  vec4 error; // simulate the colors\\r\\n  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\\r\\n  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\\r\\n  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\\r\\n  error.a = 1.0;\\r\\n  vec4 diff = o - error;\\r\\n  vec4 correction; // correct the colors\\r\\n  correction.r = 0.0;\\r\\n  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\\r\\n  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\\r\\n  correction = o + correction;\\r\\n  correction.a = o.a;\\r\\n  //SIMULATE//\\r\\n\\r\\n  // sim \\r\\n  if (u_simulate) {\\r\\n    fragColor = error.rgba;\\r\\n  } else {\\r\\n    fragColor = correction.rgba;\\r\\n  }\\r\\n}\";","import { ColorBlindnessMode } from '../Graphics/PostProcessor/ColorBlindnessMode';\nimport { ColorBlindnessPostProcessor } from '../Graphics/PostProcessor/ColorBlindnessPostProcessor';\nimport { Engine } from '../Engine';\nimport { ExcaliburGraphicsContextWebGL } from '../Graphics/Context/ExcaliburGraphicsContextWebGL';\n\nexport class ColorBlindFlags {\n  private _engine: Engine;\n  private _colorBlindPostProcessor: ColorBlindnessPostProcessor;\n\n  constructor(engine: Engine) {\n    this._engine = engine;\n    this._colorBlindPostProcessor = new ColorBlindnessPostProcessor(ColorBlindnessMode.Protanope);\n  }\n\n  /**\n   * Correct colors for a specified color blindness\n   * @param colorBlindness\n   */\n  public correct(colorBlindness: ColorBlindnessMode) {\n    if (this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\n      this.clear();\n      this._colorBlindPostProcessor.colorBlindnessMode = colorBlindness;\n      this._colorBlindPostProcessor.simulate = false;\n      this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor);\n    }\n  }\n\n  /**\n   * Simulate colors for a specified color blindness\n   * @param colorBlindness\n   */\n  public simulate(colorBlindness: ColorBlindnessMode) {\n    if (this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL) {\n      this.clear();\n      this._colorBlindPostProcessor.colorBlindnessMode = colorBlindness;\n      this._colorBlindPostProcessor.simulate = true;\n      this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor);\n    }\n  }\n\n  /**\n   * Remove color blindness post processor\n   */\n  public clear() {\n    this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor);\n  }\n}\n","import { ColorBlindFlags } from './DebugFlags';\r\nimport { Engine } from '../Engine';\r\nimport { Color } from '../Color';\r\nimport { CollisionContact } from '../Collision/Detection/CollisionContact';\r\nimport { StandardClock, TestClock } from '../Util/Clock';\r\n\r\n/**\r\n * Debug stats containing current and previous frame statistics\r\n */\r\nexport interface DebugStats {\r\n  currFrame: FrameStats;\r\n  prevFrame: FrameStats;\r\n}\r\n\r\n/**\r\n * Represents a frame's individual statistics\r\n */\r\nexport interface FrameStatistics {\r\n  /**\r\n   * The number of the frame\r\n   */\r\n  id: number;\r\n\r\n  /**\r\n   * Gets the frame's delta (time since last frame scaled by {@apilink Engine.timescale}) (in ms)\r\n   *\r\n   * Excalibur extension depends on this\r\n   */\r\n  elapsedMs: number;\r\n\r\n  /**\r\n   * Gets the frame's frames-per-second (FPS)\r\n   */\r\n  fps: number;\r\n\r\n  /**\r\n   * Duration statistics (in ms)\r\n   */\r\n  duration: FrameDurationStats;\r\n\r\n  /**\r\n   * Actor statistics\r\n   */\r\n  actors: FrameActorStats;\r\n\r\n  /**\r\n   * Physics statistics\r\n   */\r\n  physics: PhysicsStatistics;\r\n\r\n  /**\r\n   * Graphics statistics\r\n   */\r\n  graphics: GraphicsStatistics;\r\n}\r\n\r\n/**\r\n * Represents actor stats for a frame\r\n */\r\nexport interface FrameActorStats {\r\n  /**\r\n   * Gets the frame's number of actors (alive)\r\n   */\r\n  alive: number;\r\n\r\n  /**\r\n   * Gets the frame's number of actors (killed)\r\n   */\r\n  killed: number;\r\n\r\n  /**\r\n   * Gets the frame's number of remaining actors (alive - killed)\r\n   */\r\n  remaining: number;\r\n\r\n  /**\r\n   * Gets the frame's number of UI actors\r\n   */\r\n  ui: number;\r\n\r\n  /**\r\n   * Gets the frame's number of total actors (remaining + UI)\r\n   */\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Represents duration stats for a frame\r\n */\r\nexport interface FrameDurationStats {\r\n  /**\r\n   * Gets the frame's total time to run the update function (in ms)\r\n   */\r\n  update: number;\r\n\r\n  /**\r\n   * Gets the frame's total time to run the draw function (in ms)\r\n   */\r\n  draw: number;\r\n\r\n  /**\r\n   * Gets the frame's total render duration (update + draw duration) (in ms)\r\n   */\r\n  total: number;\r\n}\r\n\r\n/**\r\n * Represents physics stats for the current frame\r\n */\r\nexport interface PhysicsStatistics {\r\n  /**\r\n   * Gets the number of broadphase collision pairs which\r\n   */\r\n  pairs: number;\r\n\r\n  /**\r\n   * Gets the number of actual collisions\r\n   */\r\n  collisions: number;\r\n\r\n  /**\r\n   * Copy of the current frame contacts (only updated if debug is toggled on)\r\n   */\r\n  contacts: Map<string, CollisionContact>;\r\n\r\n  /**\r\n   * Gets the number of fast moving bodies using raycast continuous collisions in the scene\r\n   */\r\n  fastBodies: number;\r\n\r\n  /**\r\n   * Gets the number of bodies that had a fast body collision resolution\r\n   */\r\n  fastBodyCollisions: number;\r\n\r\n  /**\r\n   * Gets the time it took to calculate the broadphase pairs\r\n   */\r\n  broadphase: number;\r\n\r\n  /**\r\n   * Gets the time it took to calculate the narrowphase\r\n   */\r\n  narrowphase: number;\r\n}\r\n\r\nexport interface GraphicsStatistics {\r\n  drawCalls: number;\r\n  drawnImages: number;\r\n}\r\n\r\n/**\r\n * Debug statistics and flags for Excalibur. If polling these values, it would be\r\n * best to do so on the `postupdate` event for {@apilink Engine}, after all values have been\r\n * updated during a frame.\r\n */\r\nexport class DebugConfig {\r\n  private _engine: Engine;\r\n\r\n  constructor(engine: Engine) {\r\n    this._engine = engine;\r\n\r\n    this.colorBlindMode = new ColorBlindFlags(this._engine);\r\n  }\r\n\r\n  /**\r\n   * Switch the current excalibur clock with the {@apilink TestClock} and return\r\n   * it in the same running state.\r\n   *\r\n   * This is useful when you need to debug frame by frame.\r\n   */\r\n  public useTestClock(): TestClock {\r\n    const clock = this._engine.clock;\r\n    const wasRunning = clock.isRunning();\r\n    clock.stop();\r\n\r\n    const testClock = clock.toTestClock();\r\n    if (wasRunning) {\r\n      testClock.start();\r\n    }\r\n    this._engine.clock = testClock;\r\n    return testClock;\r\n  }\r\n\r\n  /**\r\n   * Switch the current excalibur clock with the {@apilink StandardClock} and\r\n   * return it in the same running state.\r\n   *\r\n   * This is useful when you need to switch back to normal mode after\r\n   * debugging.\r\n   */\r\n  public useStandardClock(): StandardClock {\r\n    const currentClock = this._engine.clock;\r\n    const wasRunning = currentClock.isRunning();\r\n    currentClock.stop();\r\n\r\n    const standardClock = currentClock.toStandardClock();\r\n    if (wasRunning) {\r\n      standardClock.start();\r\n    }\r\n    this._engine.clock = standardClock;\r\n    return standardClock;\r\n  }\r\n\r\n  /**\r\n   * Performance statistics\r\n   */\r\n  public stats: DebugStats = {\r\n    /**\r\n     * Current frame statistics. Engine reuses this instance, use {@apilink FrameStats.clone} to copy frame stats.\r\n     * Best accessed on {@apilink postframe} event. See {@apilink FrameStats}\r\n     */\r\n    currFrame: new FrameStats(),\r\n\r\n    /**\r\n     * Previous frame statistics. Engine reuses this instance, use {@apilink FrameStats.clone} to copy frame stats.\r\n     * Best accessed on {@apilink preframe} event. Best inspected on engine event `preframe`. See {@apilink FrameStats}\r\n     */\r\n    prevFrame: new FrameStats()\r\n  };\r\n\r\n  /**\r\n   * Correct or simulate color blindness using {@apilink ColorBlindnessPostProcessor}.\r\n   * @warning Will reduce FPS.\r\n   */\r\n  public colorBlindMode: ColorBlindFlags;\r\n\r\n  /**\r\n   * Filter debug context to named entities or entity ids\r\n   */\r\n  public filter: { useFilter: boolean; nameQuery: string; ids: number[] } = {\r\n    /**\r\n     * Toggle filter on or off (default off) must be on for DebugDraw to use filters\r\n     */\r\n    useFilter: false,\r\n    /**\r\n     * Query for entities by name, if the entity name contains `nameQuery` it will be included\r\n     */\r\n    nameQuery: '',\r\n    /**\r\n     * Query for Entity ids, if the id matches it will be included\r\n     */\r\n    ids: []\r\n  };\r\n\r\n  /**\r\n   * Entity debug settings\r\n   */\r\n  public entity = {\r\n    showAll: false,\r\n    showId: false,\r\n    showName: false\r\n  };\r\n\r\n  /**\r\n   * Transform component debug settings\r\n   */\r\n  public transform = {\r\n    showAll: false,\r\n\r\n    debugZIndex: 10_000_000,\r\n    showPosition: false,\r\n    showPositionLabel: false,\r\n    positionColor: Color.Yellow,\r\n\r\n    showZIndex: false,\r\n\r\n    showScale: false,\r\n    scaleColor: Color.Green,\r\n\r\n    showRotation: false,\r\n    rotationColor: Color.Blue\r\n  };\r\n\r\n  /**\r\n   * Graphics component debug settings\r\n   */\r\n  public graphics = {\r\n    showAll: false,\r\n\r\n    showBounds: false,\r\n    boundsColor: Color.Yellow\r\n  };\r\n\r\n  /**\r\n   * Collider component debug settings\r\n   */\r\n  public collider = {\r\n    showAll: false,\r\n\r\n    showBounds: false,\r\n    boundsColor: Color.Blue,\r\n\r\n    showOwner: false,\r\n\r\n    showGeometry: true,\r\n    geometryColor: Color.Green,\r\n    geometryLineWidth: 1,\r\n    geometryPointSize: 0.5\r\n  };\r\n\r\n  /**\r\n   * Physics simulation debug settings\r\n   */\r\n  public physics = {\r\n    showAll: false,\r\n\r\n    showBroadphaseSpacePartitionDebug: false,\r\n\r\n    showCollisionNormals: false,\r\n    collisionNormalColor: Color.Cyan,\r\n\r\n    showCollisionContacts: true,\r\n    contactSize: 2,\r\n    collisionContactColor: Color.Red\r\n  };\r\n\r\n  /**\r\n   * Motion component debug settings\r\n   */\r\n  public motion = {\r\n    showAll: false,\r\n\r\n    showVelocity: false,\r\n    velocityColor: Color.Yellow,\r\n\r\n    showAcceleration: false,\r\n    accelerationColor: Color.Red\r\n  };\r\n\r\n  /**\r\n   * Body component debug settings\r\n   */\r\n  public body = {\r\n    showAll: false,\r\n\r\n    showCollisionGroup: false,\r\n    showCollisionType: false,\r\n    showSleeping: false,\r\n    showMotion: false,\r\n    showMass: false\r\n  };\r\n\r\n  /**\r\n   * Camera debug settings\r\n   */\r\n  public camera = {\r\n    showAll: false,\r\n\r\n    showFocus: false,\r\n    focusColor: Color.Red,\r\n\r\n    showZoom: false\r\n  };\r\n\r\n  public tilemap = {\r\n    showAll: false,\r\n\r\n    showGrid: false,\r\n    gridColor: Color.Red,\r\n    gridWidth: 0.5,\r\n    showSolidBounds: false,\r\n    solidBoundsColor: Color.fromHex('#8080807F'), // grayish\r\n    showColliderGeometry: true\r\n  };\r\n\r\n  public isometric = {\r\n    showAll: false,\r\n    showPosition: false,\r\n    positionColor: Color.Yellow,\r\n    positionSize: 1,\r\n    showGrid: false,\r\n    gridColor: Color.Red,\r\n    gridWidth: 1,\r\n    showColliderGeometry: true\r\n  };\r\n}\r\n\r\n/**\r\n * Implementation of a frame's stats. Meant to have values copied via {@apilink FrameStats.reset}, avoid\r\n * creating instances of this every frame.\r\n */\r\nexport class FrameStats implements FrameStatistics {\r\n  private _id: number = 0;\r\n  private _elapsedMs: number = 0;\r\n  private _fps: number = 0;\r\n  private _actorStats: FrameActorStats = {\r\n    alive: 0,\r\n    killed: 0,\r\n    ui: 0,\r\n    get remaining() {\r\n      return this.alive - this.killed;\r\n    },\r\n    get total() {\r\n      return this.remaining + this.ui;\r\n    }\r\n  };\r\n  private _durationStats: FrameDurationStats = {\r\n    update: 0,\r\n    draw: 0,\r\n    get total() {\r\n      return this.update + this.draw;\r\n    }\r\n  };\r\n\r\n  private _physicsStats: PhysicsStats = new PhysicsStats();\r\n\r\n  private _graphicsStats: GraphicsStatistics = {\r\n    drawCalls: 0,\r\n    drawnImages: 0\r\n  };\r\n\r\n  /**\r\n   * Zero out values or clone other IFrameStat stats. Allows instance reuse.\r\n   * @param [otherStats] Optional stats to clone\r\n   */\r\n  public reset(otherStats?: FrameStatistics) {\r\n    if (otherStats) {\r\n      this.id = otherStats.id;\r\n      this.elapsedMs = otherStats.elapsedMs;\r\n      this.fps = otherStats.fps;\r\n      this.actors.alive = otherStats.actors.alive;\r\n      this.actors.killed = otherStats.actors.killed;\r\n      this.actors.ui = otherStats.actors.ui;\r\n      this.duration.update = otherStats.duration.update;\r\n      this.duration.draw = otherStats.duration.draw;\r\n      this._physicsStats.reset(otherStats.physics);\r\n      this.graphics.drawCalls = otherStats.graphics.drawCalls;\r\n      this.graphics.drawnImages = otherStats.graphics.drawnImages;\r\n    } else {\r\n      this.id = this.elapsedMs = this.fps = 0;\r\n      this.actors.alive = this.actors.killed = this.actors.ui = 0;\r\n      this.duration.update = this.duration.draw = 0;\r\n      this._physicsStats.reset();\r\n      this.graphics.drawnImages = this.graphics.drawCalls = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provides a clone of this instance.\r\n   */\r\n  public clone(): FrameStats {\r\n    const fs = new FrameStats();\r\n\r\n    fs.reset(this);\r\n\r\n    return fs;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's id\r\n   */\r\n  public get id() {\r\n    return this._id;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's id\r\n   */\r\n  public set id(value: number) {\r\n    this._id = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's delta (time since last frame)\r\n   */\r\n  public get elapsedMs() {\r\n    return this._elapsedMs;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's delta (time since last frame). Internal use only.\r\n   * @internal\r\n   */\r\n  public set elapsedMs(value: number) {\r\n    this._elapsedMs = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's frames-per-second (FPS)\r\n   */\r\n  public get fps() {\r\n    return this._fps;\r\n  }\r\n\r\n  /**\r\n   * Sets the frame's frames-per-second (FPS). Internal use only.\r\n   * @internal\r\n   */\r\n  public set fps(value: number) {\r\n    this._fps = value;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's actor statistics\r\n   */\r\n  public get actors() {\r\n    return this._actorStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's duration statistics\r\n   */\r\n  public get duration() {\r\n    return this._durationStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's physics statistics\r\n   */\r\n  public get physics() {\r\n    return this._physicsStats;\r\n  }\r\n\r\n  /**\r\n   * Gets the frame's graphics statistics\r\n   */\r\n  public get graphics() {\r\n    return this._graphicsStats;\r\n  }\r\n}\r\n\r\nexport class PhysicsStats implements PhysicsStatistics {\r\n  private _pairs: number = 0;\r\n  private _collisions: number = 0;\r\n  private _contacts: Map<string, CollisionContact> = new Map();\r\n  private _fastBodies: number = 0;\r\n  private _fastBodyCollisions: number = 0;\r\n  private _broadphase: number = 0;\r\n  private _narrowphase: number = 0;\r\n\r\n  /**\r\n   * Zero out values or clone other IPhysicsStats stats. Allows instance reuse.\r\n   * @param [otherStats] Optional stats to clone\r\n   */\r\n  public reset(otherStats?: PhysicsStatistics) {\r\n    if (otherStats) {\r\n      this.pairs = otherStats.pairs;\r\n      this.collisions = otherStats.collisions;\r\n      this.contacts = otherStats.contacts;\r\n      this.fastBodies = otherStats.fastBodies;\r\n      this.fastBodyCollisions = otherStats.fastBodyCollisions;\r\n      this.broadphase = otherStats.broadphase;\r\n      this.narrowphase = otherStats.narrowphase;\r\n    } else {\r\n      this.pairs = this.collisions = this.fastBodies = 0;\r\n      this.fastBodyCollisions = this.broadphase = this.narrowphase = 0;\r\n      this.contacts.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Provides a clone of this instance.\r\n   */\r\n  public clone(): PhysicsStatistics {\r\n    const ps = new PhysicsStats();\r\n\r\n    ps.reset(this);\r\n\r\n    return ps;\r\n  }\r\n\r\n  public get pairs(): number {\r\n    return this._pairs;\r\n  }\r\n\r\n  public set pairs(value: number) {\r\n    this._pairs = value;\r\n  }\r\n\r\n  public get collisions(): number {\r\n    return this._collisions;\r\n  }\r\n\r\n  public set collisions(value: number) {\r\n    this._collisions = value;\r\n  }\r\n\r\n  public get contacts(): Map<string, CollisionContact> {\r\n    return this._contacts;\r\n  }\r\n\r\n  public set contacts(contacts: Map<string, CollisionContact>) {\r\n    this._contacts = contacts;\r\n  }\r\n\r\n  public get fastBodies(): number {\r\n    return this._fastBodies;\r\n  }\r\n\r\n  public set fastBodies(value: number) {\r\n    this._fastBodies = value;\r\n  }\r\n\r\n  public get fastBodyCollisions(): number {\r\n    return this._fastBodyCollisions;\r\n  }\r\n\r\n  public set fastBodyCollisions(value: number) {\r\n    this._fastBodyCollisions = value;\r\n  }\r\n\r\n  public get broadphase(): number {\r\n    return this._broadphase;\r\n  }\r\n\r\n  public set broadphase(value: number) {\r\n    this._broadphase = value;\r\n  }\r\n\r\n  public get narrowphase(): number {\r\n    return this._narrowphase;\r\n  }\r\n\r\n  public set narrowphase(value: number) {\r\n    this._narrowphase = value;\r\n  }\r\n}\r\n","export interface NativeEventable {\r\n  addEventListener(name: string, handler: (...any: any[]) => any): any;\r\n  removeEventListener(name: string, handler: (...any: any[]) => any): any;\r\n}\r\n\r\nexport class BrowserComponent<T extends NativeEventable> {\r\n  private _paused = false;\r\n  private _nativeHandlers: { [key: string]: (handler: any) => void } = {};\r\n\r\n  on(eventName: string, handler: (evt: any) => void): void {\r\n    if (this._nativeHandlers[eventName]) {\r\n      this.off(eventName, this._nativeHandlers[eventName]);\r\n    }\r\n    this._nativeHandlers[eventName] = this._decorate(handler);\r\n    this.nativeComponent.addEventListener(eventName, this._nativeHandlers[eventName]);\r\n  }\r\n  off(eventName: string, handler?: (event: any) => void): void {\r\n    if (!handler) {\r\n      handler = this._nativeHandlers[eventName];\r\n    }\r\n    this.nativeComponent.removeEventListener(eventName, handler);\r\n    this._nativeHandlers[eventName] = null;\r\n  }\r\n\r\n  private _decorate(handler: (evt: any) => void): (evt: any) => void {\r\n    return (evt: any) => {\r\n      if (!this._paused) {\r\n        handler(evt);\r\n      }\r\n    };\r\n  }\r\n\r\n  public pause() {\r\n    this._paused = true;\r\n  }\r\n\r\n  public resume() {\r\n    this._paused = false;\r\n  }\r\n\r\n  public clear() {\r\n    for (const event in this._nativeHandlers) {\r\n      this.off(event);\r\n    }\r\n  }\r\n\r\n  constructor(public nativeComponent: T) {}\r\n}\r\n\r\nexport class BrowserEvents {\r\n  private _windowComponent: BrowserComponent<Window>;\r\n  private _documentComponent: BrowserComponent<Document>;\r\n  constructor(\r\n    private _windowGlobal: Window,\r\n    private _documentGlobal: Document\r\n  ) {\r\n    this._windowComponent = new BrowserComponent(this._windowGlobal);\r\n    this._documentComponent = new BrowserComponent(this._documentGlobal);\r\n  }\r\n\r\n  public get window(): BrowserComponent<Window> {\r\n    return this._windowComponent;\r\n  }\r\n\r\n  public get document(): BrowserComponent<Document> {\r\n    return this._documentComponent;\r\n  }\r\n\r\n  public pause() {\r\n    this.window.pause();\r\n    this.document.pause();\r\n  }\r\n\r\n  public resume() {\r\n    this.window.resume();\r\n    this.document.resume();\r\n  }\r\n\r\n  public clear() {\r\n    this.window.clear();\r\n    this.document.clear();\r\n  }\r\n}\r\n","import { Vector } from '../../Math/vector';\r\nimport { Color } from '../../Color';\r\nimport { Resolution } from '../../Screen';\r\nimport { PostProcessor } from '../PostProcessor/PostProcessor';\r\nimport { AffineMatrix } from '../../Math/affine-matrix';\r\nimport { Material, MaterialOptions } from './material';\r\nimport { ImageFiltering } from '../Filtering';\r\n\r\nexport type HTMLImageSource = HTMLImageElement | HTMLCanvasElement;\r\n\r\nexport interface AntialiasOptions {\r\n  /**\r\n   * Turns on the special pixel art sampler in excalibur's image shader for sub pixel\r\n   * anti-aliasing\r\n   *\r\n   * Default false\r\n   */\r\n  pixelArtSampler?: boolean;\r\n  /**\r\n   * Configures the webgl's getContext('webgl2', {antialias: true | false}) or configures\r\n   * Canvas2D imageSmoothing = true;\r\n   *\r\n   * **Note** this option is incompatible with `multiSampleAntialiasing`\r\n   *\r\n   * Default false\r\n   */\r\n  nativeContextAntialiasing?: boolean;\r\n  /**\r\n   * Configures the internal render buffer multi-sampling settings\r\n   *\r\n   * Default true, with max samples that the platform supports\r\n   */\r\n  multiSampleAntialiasing?:\r\n    | boolean\r\n    | {\r\n        /**\r\n         * Optionally specify number of samples (will be clamped to the max the platform supports)\r\n         *\r\n         * Default most platforms are 16 samples\r\n         */\r\n        samples: number;\r\n      };\r\n  /**\r\n   * Sets the default image filtering for excalibur\r\n   *\r\n   * Default {@apilink ImageFiltering.Blended}\r\n   */\r\n  filtering?: ImageFiltering;\r\n  /**\r\n   * Sets the canvas image rendering CSS style\r\n   *\r\n   * Default 'auto'\r\n   */\r\n  canvasImageRendering?: 'pixelated' | 'auto';\r\n}\r\n\r\nexport const DefaultAntialiasOptions: Required<AntialiasOptions> = {\r\n  pixelArtSampler: false,\r\n  nativeContextAntialiasing: false,\r\n  multiSampleAntialiasing: true,\r\n  filtering: ImageFiltering.Blended,\r\n  canvasImageRendering: 'auto'\r\n};\r\n\r\nexport const DefaultPixelArtOptions: Required<AntialiasOptions> = {\r\n  pixelArtSampler: true,\r\n  nativeContextAntialiasing: false,\r\n  multiSampleAntialiasing: true,\r\n  filtering: ImageFiltering.Blended,\r\n  canvasImageRendering: 'auto'\r\n};\r\n\r\nexport interface ExcaliburGraphicsContextOptions {\r\n  /**\r\n   * Target existing html canvas element\r\n   */\r\n  canvasElement: HTMLCanvasElement;\r\n  /**\r\n   * Enables antialiasing on the canvas context (smooths pixels with default canvas sampling)\r\n   */\r\n  antialiasing?: boolean;\r\n  /**\r\n   * Enable the sub pixel antialiasing pixel art sampler for nice looking pixel art\r\n   */\r\n  pixelArtSampler?: boolean;\r\n  /**\r\n   * Enable canvas transparency\r\n   */\r\n  enableTransparency?: boolean;\r\n  /**\r\n   * Enable or disable multi-sample antialiasing in the internal render buffer.\r\n   *\r\n   * If true the max number of samples will be used\r\n   *\r\n   * By default enabled\r\n   */\r\n  multiSampleAntialiasing?:\r\n    | boolean\r\n    | {\r\n        /**\r\n         * Specify number of samples to use during the multi sample anti-alias, if not specified the max will be used.\r\n         * Limited by the hardware (usually 16)\r\n         */\r\n        samples: number;\r\n      };\r\n  /**\r\n   * UV padding in pixels to use in the internal image rendering\r\n   *\r\n   * Recommended .25 - .5 of a pixel\r\n   */\r\n  uvPadding?: number;\r\n  /**\r\n   * Hint the power preference to the graphics context\r\n   */\r\n  powerPreference?: 'default' | 'high-performance' | 'low-power';\r\n  /**\r\n   * Snaps the pixel to an integer value (floor)\r\n   */\r\n  snapToPixel?: boolean;\r\n  /**\r\n   * Current clearing color of the context\r\n   */\r\n  backgroundColor?: Color;\r\n  /**\r\n   * Feature flag that enables draw sorting will removed in v0.29\r\n   */\r\n  useDrawSorting?: boolean;\r\n}\r\n\r\nexport interface ExcaliburGraphicsContextState {\r\n  opacity: number;\r\n  z: number;\r\n  tint: Color | null | undefined;\r\n  material: Material | null | undefined;\r\n}\r\nexport interface LineGraphicsOptions {\r\n  color?: Color;\r\n}\r\n\r\nexport interface RectGraphicsOptions {\r\n  color?: Color;\r\n}\r\n\r\nexport interface PointGraphicsOptions {\r\n  color: Color;\r\n  size: number;\r\n}\r\n\r\nexport interface DebugDraw {\r\n  /**\r\n   * Draw a debugging rectangle to the screen\r\n   * @param x\r\n   * @param y\r\n   * @param width\r\n   * @param height\r\n   * @param rectOptions\r\n   */\r\n  drawRect(x: number, y: number, width: number, height: number, rectOptions?: RectGraphicsOptions): void;\r\n  /**\r\n   * Draw a debugging line to the screen\r\n   * @param start '\r\n   * @param end\r\n   * @param lineOptions\r\n   */\r\n  drawLine(start: Vector, end: Vector, lineOptions?: LineGraphicsOptions): void;\r\n  /**\r\n   * Draw a debugging point to the screen\r\n   * @param point\r\n   * @param pointOptions\r\n   */\r\n  drawPoint(point: Vector, pointOptions?: PointGraphicsOptions): void;\r\n\r\n  /**\r\n   * Draw debug text\r\n   * @param text\r\n   * @param pos\r\n   */\r\n  drawText(text: string, pos: Vector): void;\r\n}\r\n\r\nexport interface ExcaliburGraphicsContext {\r\n  width: number;\r\n  height: number;\r\n\r\n  /**\r\n   * Excalibur will automatically sort draw calls by z and priority for maximal draw performance,\r\n   * this can disrupt a specific desired painter order.\r\n   *\r\n   * To force a specific draw call order, use {@apilink ExcaliburGraphicsContext.z}\r\n   *\r\n   * By default `useDrawSorting` is `true`, to opt out set this to `false`\r\n   */\r\n  useDrawSorting: boolean;\r\n\r\n  /**\r\n   * Set the current z context for the graphics context. Draw calls issued to the context will use this z\r\n   * to inform their sort order.\r\n   *\r\n   * Note it is important to all {@apilink ExcaliburGraphicsContext.save} and {@apilink ExcaliburGraphicsContext.restore} when modifying state.\r\n   */\r\n  z: number;\r\n\r\n  /**\r\n   * Snaps all drawings to the nearest pixel truncated down, by default false\r\n   */\r\n  snapToPixel: boolean;\r\n\r\n  /**\r\n   * Enable smoothed drawing (also known as anti-aliasing), by default true\r\n   */\r\n  smoothing: boolean;\r\n\r\n  /**\r\n   * Set the background color of the graphics context, default is {@apilink Color.ExcaliburBlue}\r\n   */\r\n  backgroundColor: Color;\r\n\r\n  /**\r\n   * Sets the opacity of the current {@apilink Graphic} being drawn, default is 1\r\n   */\r\n  opacity: number;\r\n\r\n  /**\r\n   * Sets the tint color to be multiplied by any images drawn, default is black 0xFFFFFFFF\r\n   */\r\n  tint: Color | null | undefined;\r\n\r\n  /**\r\n   * Resets the current transform to the identity matrix\r\n   */\r\n  resetTransform(): void;\r\n\r\n  /**\r\n   * Gets the current transform\r\n   */\r\n  getTransform(): AffineMatrix;\r\n\r\n  /**\r\n   * Multiplies the current transform by a matrix\r\n   * @param m\r\n   */\r\n  multiply(m: AffineMatrix): void;\r\n\r\n  /**\r\n   * Update the context with the current viewport dimensions (used in resizing)\r\n   */\r\n  updateViewport(resolution: Resolution): void;\r\n\r\n  /**\r\n   * Access the debug drawing api\r\n   */\r\n  debug: DebugDraw;\r\n\r\n  /**\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate using the images width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context at an x and y coordinate with a specific width and height\r\n   */\r\n  drawImage(image: HTMLImageSource, x: number, y: number, width: number, height: number): void;\r\n  /**\r\n   *\r\n   * Draw an image to the Excalibur Graphics context specifying the source image coordinates (sx, sy, swidth, sheight)\r\n   * and to a specific destination on the context (dx, dy, dwidth, dheight)\r\n   */\r\n  drawImage(\r\n    image: HTMLImageSource,\r\n    sx: number,\r\n    sy: number,\r\n    swidth?: number,\r\n    sheight?: number,\r\n    dx?: number,\r\n    dy?: number,\r\n    dwidth?: number,\r\n    dheight?: number\r\n  ): void;\r\n\r\n  /**\r\n   * Draw a solid line to the Excalibur Graphics context\r\n   * @param start\r\n   * @param end\r\n   * @param color\r\n   * @param thickness\r\n   */\r\n  drawLine(start: Vector, end: Vector, color: Color, thickness: number): void;\r\n\r\n  /**\r\n   * Draw a solid rectangle to the Excalibur Graphics context\r\n   * @param pos\r\n   * @param width\r\n   * @param height\r\n   * @param color\r\n   */\r\n  drawRectangle(pos: Vector, width: number, height: number, color: Color, stroke?: Color, strokeThickness?: number): void;\r\n\r\n  /**\r\n   * Draw a circle to the Excalibur Graphics context\r\n   * @param pos\r\n   * @param radius\r\n   * @param color\r\n   * @param stroke Optionally specify the stroke color\r\n   * @param thickness\r\n   */\r\n  drawCircle(pos: Vector, radius: number, color: Color, stroke?: Color, thickness?: number): void;\r\n\r\n  /**\r\n   * Save the current state of the canvas to the stack (transforms and opacity)\r\n   */\r\n  save(): void;\r\n\r\n  /**\r\n   * Restore the state of the canvas from the stack\r\n   */\r\n  restore(): void;\r\n\r\n  /**\r\n   * Translate the origin of the context by an x and y\r\n   * @param x\r\n   * @param y\r\n   */\r\n  translate(x: number, y: number): void;\r\n\r\n  /**\r\n   * Rotate the context about the current origin\r\n   */\r\n  rotate(angle: number): void;\r\n\r\n  /**\r\n   * Scale the context by an x and y factor\r\n   * @param x\r\n   * @param y\r\n   */\r\n  scale(x: number, y: number): void;\r\n\r\n  /**\r\n   * Add a post processor to the graphics context\r\n   *\r\n   * Post processors are run in the order they were added.\r\n   * @param postprocessor\r\n   */\r\n  addPostProcessor(postprocessor: PostProcessor): void;\r\n\r\n  /**\r\n   * Remove a specific post processor from the graphics context\r\n   * @param postprocessor\r\n   */\r\n  removePostProcessor(postprocessor: PostProcessor): void;\r\n\r\n  /**\r\n   * Remove all post processors from the graphics context\r\n   */\r\n  clearPostProcessors(): void;\r\n\r\n  /**\r\n   * Updates all post processors in the graphics context\r\n   *\r\n   * Called internally by Excalibur\r\n   * @param elapsed\r\n   * @internal\r\n   */\r\n  updatePostProcessors(elapsed: number): void;\r\n\r\n  /**\r\n   * Gets or sets the material to be used in the current context's drawings\r\n   *\r\n   * This allows customs shaders to be used but draw calls are no longer batched by default.\r\n   * @param material\r\n   */\r\n  material: Material | null | undefined;\r\n\r\n  /**\r\n   * Creates and initializes the material which compiles the internal shader\r\n   * @param options\r\n   * @returns\r\n   */\r\n  createMaterial(options: Omit<MaterialOptions, 'graphicsContext'>): Material;\r\n\r\n  /**\r\n   * Clears the screen with the current background color\r\n   */\r\n  clear(): void;\r\n\r\n  /**\r\n   * Flushes the batched draw calls to the screen\r\n   */\r\n  flush(): void;\r\n\r\n  beginDrawLifecycle(): void;\r\n\r\n  endDrawLifecycle(): void;\r\n\r\n  dispose(): void;\r\n}\r\n","export interface FpsSamplerOptions {\r\n  /**\r\n   * Specify the sampling period in milliseconds (default 100)\r\n   */\r\n  samplePeriod?: number;\r\n  /**\r\n   * Specify the initial FPS\r\n   */\r\n  initialFps: number;\r\n\r\n  /**\r\n   * Specify the function used to return the current time (in milliseconds)\r\n   */\r\n  nowFn: () => number;\r\n}\r\n\r\nexport class FpsSampler {\r\n  private _fps: number;\r\n  private _samplePeriod: number = 100;\r\n  private _currentFrameTime: number = 0;\r\n  private _frames: number = 0;\r\n  private _previousSampleTime: number = 0;\r\n  private _beginFrameTime: number = 0;\r\n  private _nowFn: () => number;\r\n\r\n  constructor(options: FpsSamplerOptions) {\r\n    this._fps = options.initialFps;\r\n    this._samplePeriod = options.samplePeriod ?? this._samplePeriod;\r\n    this._currentFrameTime = 1000 / options.initialFps;\r\n    this._nowFn = options.nowFn;\r\n    this._previousSampleTime = this._nowFn();\r\n  }\r\n\r\n  /**\r\n   * Start of code block to sample FPS for\r\n   */\r\n  start() {\r\n    this._beginFrameTime = this._nowFn();\r\n  }\r\n\r\n  /**\r\n   * End of code block to sample FPS for\r\n   */\r\n  end() {\r\n    this._frames++;\r\n    const time = this._nowFn();\r\n\r\n    this._currentFrameTime = time - this._beginFrameTime;\r\n\r\n    if (time >= this._previousSampleTime + this._samplePeriod) {\r\n      this._fps = (this._frames * 1000) / (time - this._previousSampleTime);\r\n      this._previousSampleTime = time;\r\n      this._frames = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the currently sampled fps over the last sample period, by default every 100ms\r\n   */\r\n  get fps() {\r\n    return this._fps;\r\n  }\r\n\r\n  /**\r\n   * Return the instantaneous fps, this can be less useful because it will fluctuate given the current frames time\r\n   */\r\n  get instant() {\r\n    return 1000 / this._currentFrameTime;\r\n  }\r\n}\r\n","import { Logger } from '../Util/Log';\r\nimport { FpsSampler } from './Fps';\r\n\r\nexport type ScheduledCallbackTiming = 'preframe' | 'postframe' | 'preupdate' | 'postupdate' | 'predraw' | 'postdraw';\r\n\r\nexport interface ClockOptions {\r\n  /**\r\n   * Define the function you'd like the clock to tick when it is started\r\n   */\r\n  tick: (elapsed: number) => any;\r\n  /**\r\n   * Optionally define the fatal exception handler, used if an error is thrown in tick\r\n   */\r\n  onFatalException?: (e: unknown) => any;\r\n  /**\r\n   * Optionally limit the maximum FPS of the clock\r\n   */\r\n  maxFps?: number;\r\n}\r\n\r\n/**\r\n * Abstract Clock is the base type of all Clocks\r\n *\r\n * It has a few opinions\r\n * 1. It manages the calculation of what \"elapsed\" time means and thus maximum fps\r\n * 2. The default timing api is implemented in now()\r\n *\r\n * To implement your own clock, extend Clock and override start/stop to start and stop the clock, then call update() with whatever\r\n * method is unique to your clock implementation.\r\n */\r\nexport abstract class Clock {\r\n  protected tick: (elapsed: number) => any;\r\n  private _onFatalException: (e: unknown) => any = () => {\r\n    /* default nothing */\r\n  };\r\n  private _maxFps: number = Infinity;\r\n  private _lastTime: number = 0;\r\n  public fpsSampler: FpsSampler;\r\n  private _options: ClockOptions;\r\n  private _elapsed: number = 1;\r\n  private _scheduledCbs: [cb: (elapsed: number) => any, scheduledTime: number, timing: ScheduledCallbackTiming][] = [];\r\n  private _totalElapsed: number = 0;\r\n  constructor(options: ClockOptions) {\r\n    this._options = options;\r\n    this.tick = options.tick;\r\n    this._lastTime = this.now() ?? 0;\r\n    this._maxFps = options.maxFps ?? this._maxFps;\r\n    this._onFatalException = options.onFatalException ?? this._onFatalException;\r\n    this.fpsSampler = new FpsSampler({\r\n      initialFps: 60,\r\n      nowFn: () => this.now()\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get the elapsed time for the last completed frame\r\n   */\r\n  public elapsed(): number {\r\n    return this._elapsed;\r\n  }\r\n\r\n  /**\r\n   * Get the current time in milliseconds\r\n   */\r\n  public now(): number {\r\n    return performance.now();\r\n  }\r\n\r\n  public toTestClock() {\r\n    const testClock = new TestClock({\r\n      ...this._options,\r\n      defaultUpdateMs: 16.6\r\n    });\r\n    return testClock;\r\n  }\r\n\r\n  public toStandardClock() {\r\n    const clock = new StandardClock({\r\n      ...this._options\r\n    });\r\n    return clock;\r\n  }\r\n\r\n  public setFatalExceptionHandler(handler: (e: unknown) => any) {\r\n    this._onFatalException = handler;\r\n  }\r\n\r\n  /**\r\n   * Schedule a callback to fire given a timeout in milliseconds using the excalibur {@apilink Clock}\r\n   *\r\n   * This is useful to use over the built in browser `setTimeout` because callbacks will be tied to the\r\n   * excalibur update clock, instead of browser time, this means that callbacks wont fire if the game is\r\n   * stopped or paused.\r\n   * @param cb callback to fire\r\n   * @param timeoutMs Optionally specify a timeout in milliseconds from now, default is 0ms which means the next possible tick\r\n   * @param timing Optionally specify a timeout in milliseconds from now, default is 0ms which means the next possible tick\r\n   */\r\n  public schedule(cb: (elapsed: number) => any, timeoutMs: number = 0, timing: ScheduledCallbackTiming = 'preframe') {\r\n    // Scheduled based on internal elapsed time\r\n    const scheduledTime = this._totalElapsed + timeoutMs;\r\n    this._scheduledCbs.push([cb, scheduledTime, timing]);\r\n  }\r\n\r\n  /**\r\n   * Called internally to trigger scheduled callbacks in the clock\r\n   * @param timing\r\n   * @internal\r\n   */\r\n  public __runScheduledCbs(timing: ScheduledCallbackTiming = 'preframe') {\r\n    // walk backwards to delete items as we loop\r\n    for (let i = this._scheduledCbs.length - 1; i > -1; i--) {\r\n      if (timing === this._scheduledCbs[i][2] && this._scheduledCbs[i][1] <= this._totalElapsed) {\r\n        this._scheduledCbs[i][0](this._elapsed);\r\n        this._scheduledCbs.splice(i, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  protected update(overrideUpdateMs?: number): void {\r\n    try {\r\n      this.fpsSampler.start();\r\n      // Get the time to calculate time-elapsed\r\n      const now = this.now();\r\n      let elapsed = now - this._lastTime || 1; // first frame\r\n\r\n      // Constrain fps\r\n      const fpsInterval = 1000 / this._maxFps;\r\n\r\n      // only run frame if enough time has elapsed\r\n      if (elapsed >= fpsInterval) {\r\n        let leftover = 0;\r\n        if (fpsInterval !== 0) {\r\n          leftover = elapsed % fpsInterval;\r\n          elapsed = elapsed - leftover; // shift elapsed to be \"in phase\" with the current loop fps\r\n        }\r\n\r\n        // Resolves issue #138 if the game has been paused, or blurred for\r\n        // more than a 200 milliseconds, reset elapsed time to 1. This improves reliability\r\n        // and provides more expected behavior when the engine comes back\r\n        // into focus\r\n        if (elapsed > 200) {\r\n          elapsed = 1;\r\n        }\r\n\r\n        // tick the mainloop and run scheduled callbacks\r\n        this._elapsed = overrideUpdateMs || elapsed;\r\n        this._totalElapsed += this._elapsed;\r\n        this.__runScheduledCbs('preframe');\r\n        this.tick(overrideUpdateMs || elapsed);\r\n        this.__runScheduledCbs('postframe');\r\n\r\n        if (fpsInterval !== 0) {\r\n          this._lastTime = now - leftover;\r\n        } else {\r\n          this._lastTime = now;\r\n        }\r\n        this.fpsSampler.end();\r\n      }\r\n    } catch (e) {\r\n      this._onFatalException(e);\r\n      this.stop();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns if the clock is currently running\r\n   */\r\n  public abstract isRunning(): boolean;\r\n\r\n  /**\r\n   * Start the clock, it will then periodically call the tick(elapsedMilliseconds) since the last tick\r\n   */\r\n  public abstract start(): void;\r\n\r\n  /**\r\n   * Stop the clock, tick() is no longer called\r\n   */\r\n  public abstract stop(): void;\r\n}\r\n\r\n/**\r\n * The {@apilink StandardClock} implements the requestAnimationFrame browser api to run the tick()\r\n */\r\nexport class StandardClock extends Clock {\r\n  private _running = false;\r\n  private _requestId: number;\r\n  constructor(options: ClockOptions) {\r\n    super(options);\r\n  }\r\n\r\n  public isRunning(): boolean {\r\n    return this._running;\r\n  }\r\n\r\n  public start(): void {\r\n    if (this._running) {\r\n      return;\r\n    }\r\n    this._running = true;\r\n    const mainloop = () => {\r\n      // stop the loop\r\n      if (!this._running) {\r\n        return;\r\n      }\r\n      try {\r\n        // request next loop\r\n        this._requestId = window.requestAnimationFrame(mainloop);\r\n        this.update();\r\n      } catch (e) {\r\n        window.cancelAnimationFrame(this._requestId);\r\n        throw e;\r\n      }\r\n    };\r\n\r\n    // begin the first frame\r\n    mainloop();\r\n  }\r\n\r\n  public stop(): void {\r\n    window.cancelAnimationFrame(this._requestId);\r\n    this._running = false;\r\n  }\r\n}\r\n\r\nexport interface TestClockOptions {\r\n  /**\r\n   * Specify the update milliseconds to use for each manual step()\r\n   */\r\n  defaultUpdateMs: number;\r\n}\r\n\r\n/**\r\n * The TestClock is meant for debugging interactions in excalibur that require precise timing to replicate or test\r\n */\r\nexport class TestClock extends Clock {\r\n  private _logger = Logger.getInstance();\r\n  private _updateMs: number;\r\n  private _running: boolean = false;\r\n  private _currentTime = 0;\r\n  constructor(options: ClockOptions & TestClockOptions) {\r\n    super({\r\n      ...options\r\n    });\r\n    this._updateMs = options.defaultUpdateMs;\r\n  }\r\n\r\n  /**\r\n   * Get the current time in milliseconds\r\n   */\r\n  public override now() {\r\n    return this._currentTime ?? 0;\r\n  }\r\n\r\n  public isRunning(): boolean {\r\n    return this._running;\r\n  }\r\n  public start(): void {\r\n    this._running = true;\r\n  }\r\n  public stop(): void {\r\n    this._running = false;\r\n  }\r\n\r\n  /**\r\n   * Manually step the clock forward 1 tick, optionally specify an elapsed time in milliseconds\r\n   * @param overrideUpdateMs\r\n   */\r\n  step(overrideUpdateMs?: number): void {\r\n    const time = overrideUpdateMs ?? this._updateMs;\r\n\r\n    if (this._running) {\r\n      // to be comparable to RAF this needs to be a full blown Task\r\n      // For example, images cannot decode synchronously in a single step\r\n      this.update(time);\r\n      this._currentTime += time;\r\n    } else {\r\n      this._logger.warn('The clock is not running, no step will be performed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Run a number of steps that tick the clock, optionally specify an elapsed time in milliseconds\r\n   * @param numberOfSteps\r\n   * @param overrideUpdateMs\r\n   */\r\n  run(numberOfSteps: number, overrideUpdateMs?: number): void {\r\n    for (let i = 0; i < numberOfSteps; i++) {\r\n      this.step(overrideUpdateMs ?? this._updateMs);\r\n    }\r\n  }\r\n}\r\n","import toasterCss from './Toaster.css';\r\n\r\n/**\r\n * The Toaster is only meant to be called from inside Excalibur to display messages to players\r\n */\r\nexport class Toaster {\r\n  private _styleBlock: HTMLStyleElement;\r\n  private _container: HTMLDivElement;\r\n  private _toasterCss: string = toasterCss.toString();\r\n\r\n  private _isInitialized = false;\r\n  private _initialize() {\r\n    if (!this._isInitialized) {\r\n      this._container = document.createElement('div');\r\n      this._container.id = 'ex-toast-container';\r\n      document.body.appendChild(this._container);\r\n      this._isInitialized = true;\r\n\r\n      this._styleBlock = document.createElement('style');\r\n      this._styleBlock.textContent = this._toasterCss;\r\n      document.head.appendChild(this._styleBlock);\r\n    }\r\n  }\r\n\r\n  public dispose() {\r\n    this._container.parentElement.removeChild(this._container);\r\n\r\n    this._styleBlock.parentElement.removeChild(this._styleBlock);\r\n\r\n    this._isInitialized = false;\r\n  }\r\n\r\n  private _createFragment(message: string) {\r\n    const toastMessage = document.createElement('span');\r\n    toastMessage.innerText = message;\r\n    return toastMessage;\r\n  }\r\n\r\n  /**\r\n   * Display a toast message to a player\r\n   * @param message Text of the message, messages may have a single \"[LINK]\" to influence placement\r\n   * @param linkTarget Optionally specify a link location\r\n   * @param linkName Optionally specify a name for that link location\r\n   */\r\n  public toast(message: string, linkTarget?: string, linkName?: string) {\r\n    this._initialize();\r\n    const toast = document.createElement('div');\r\n    toast.className = 'ex-toast-message';\r\n\r\n    const messageFragments: HTMLElement[] = message.split('[LINK]').map((message) => this._createFragment(message));\r\n\r\n    if (linkTarget) {\r\n      const link = document.createElement('a');\r\n      link.href = linkTarget;\r\n      if (linkName) {\r\n        link.innerText = linkName;\r\n      } else {\r\n        link.innerText = linkTarget;\r\n      }\r\n      messageFragments.splice(1, 0, link);\r\n    }\r\n\r\n    // Assembly message\r\n    const finalMessage = document.createElement('div');\r\n    messageFragments.forEach((message) => {\r\n      finalMessage.appendChild(message);\r\n    });\r\n    toast.appendChild(finalMessage);\r\n\r\n    // Dismiss button\r\n    const dismissBtn = document.createElement('button');\r\n    dismissBtn.innerText = 'x';\r\n    dismissBtn.addEventListener('click', () => {\r\n      this._container.removeChild(toast);\r\n    });\r\n    toast.appendChild(dismissBtn);\r\n\r\n    // Escape to dismiss\r\n    const keydownHandler = (evt: KeyboardEvent) => {\r\n      if (evt.key === 'Escape') {\r\n        try {\r\n          this._container.removeChild(toast);\r\n        } catch {\r\n          // pass\r\n        }\r\n      }\r\n      document.removeEventListener('keydown', keydownHandler);\r\n    };\r\n    document.addEventListener('keydown', keydownHandler);\r\n\r\n    // Insert into container\r\n    const first = this._container.firstChild;\r\n    this._container.insertBefore(toast, first);\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { DefaultLoader, LoaderConstructor, isLoaderConstructor } from './DefaultLoader';\r\nimport { Scene, SceneConstructor, isSceneConstructor } from '../Scene';\r\nimport { Transition } from './Transition';\r\nimport { Loader } from './Loader';\r\nimport { Logger } from '../Util/Log';\r\nimport { ActivateEvent, DeactivateEvent } from '../Events';\r\nimport { EventEmitter } from '../EventEmitter';\r\n\r\nexport interface DirectorNavigationEvent {\r\n  sourceName: string;\r\n  sourceScene: Scene;\r\n  destinationName: string;\r\n  destinationScene: Scene;\r\n}\r\n\r\nexport type DirectorEvents = {\r\n  navigationstart: DirectorNavigationEvent;\r\n  navigation: DirectorNavigationEvent;\r\n  navigationend: DirectorNavigationEvent;\r\n};\r\n\r\nexport const DirectorEvents = {\r\n  NavigationStart: 'navigationstart',\r\n  Navigation: 'navigation',\r\n  NavigationEnd: 'navigationend'\r\n};\r\n\r\nexport interface SceneWithOptions {\r\n  /**\r\n   * Scene associated with this route\r\n   *\r\n   * If a constructor is provided it will not be constructed until navigation is requested\r\n   */\r\n  scene: Scene | SceneConstructor;\r\n  /**\r\n   * Specify scene transitions\r\n   */\r\n  transitions?: {\r\n    /**\r\n     * Optionally specify a transition when going \"in\" to this scene\r\n     */\r\n    in?: Transition;\r\n    /**\r\n     * Optionally specify a transition when going \"out\" of this scene\r\n     */\r\n    out?: Transition;\r\n  };\r\n  /**\r\n   * Optionally specify a loader for the scene\r\n   */\r\n  loader?: DefaultLoader | LoaderConstructor;\r\n}\r\n\r\nexport type WithRoot<TScenes> = TScenes | 'root';\r\n\r\nexport type SceneMap<TKnownScenes extends string = any> = Record<TKnownScenes, Scene | SceneConstructor | SceneWithOptions>;\r\n\r\nexport interface StartOptions {\r\n  /**\r\n   * Optionally provide first transition from the game start screen\r\n   */\r\n  inTransition?: Transition;\r\n  /**\r\n   * Optionally provide a main loader to run before the game starts\r\n   */\r\n  loader?: DefaultLoader | LoaderConstructor;\r\n}\r\n\r\n/**\r\n * Provide scene activation data and override any existing configured route transitions or loaders\r\n */\r\nexport interface GoToOptions<TActivationData = any> {\r\n  /**\r\n   * Optionally supply scene activation data passed to Scene.onActivate\r\n   */\r\n  sceneActivationData?: TActivationData;\r\n  /**\r\n   * Optionally supply destination scene \"in\" transition, this will override any previously defined transition\r\n   */\r\n  destinationIn?: Transition;\r\n  /**\r\n   * Optionally supply source scene \"out\" transition, this will override any previously defined transition\r\n   */\r\n  sourceOut?: Transition;\r\n  /**\r\n   * Optionally supply a different loader for the destination scene, this will override any previously defined loader\r\n   */\r\n  loader?: DefaultLoader;\r\n}\r\n\r\n/**\r\n * The Director is responsible for managing scenes and changing scenes in Excalibur.\r\n *\r\n * It deals with transitions, scene loaders, switching scenes\r\n *\r\n * This is used internally by Excalibur, generally not mean to\r\n * be instantiated end users directly.\r\n */\r\nexport class Director<TKnownScenes extends string = any> {\r\n  public events = new EventEmitter<DirectorEvents>();\r\n  private _logger = Logger.getInstance();\r\n  private _deferredGoto?: string;\r\n  private _deferredTransition?: Transition;\r\n  private _initialized = false;\r\n\r\n  /**\r\n   * Current scene's name\r\n   */\r\n  currentSceneName: string;\r\n  /**\r\n   * Current scene playing in excalibur\r\n   */\r\n  currentScene: Scene;\r\n  /**\r\n   * Current transition if any\r\n   */\r\n  currentTransition?: Transition;\r\n\r\n  /**\r\n   * All registered scenes in Excalibur\r\n   */\r\n  public readonly scenes: SceneMap<WithRoot<TKnownScenes>> = {} as SceneMap<WithRoot<TKnownScenes>>;\r\n\r\n  /**\r\n   * Holds all instantiated scenes\r\n   */\r\n  private _sceneToInstance = new Map<string, Scene>();\r\n\r\n  startScene?: string;\r\n  mainLoader?: DefaultLoader;\r\n\r\n  /**\r\n   * The default {@apilink Scene} of the game, use {@apilink Engine.goToScene} to transition to different scenes.\r\n   */\r\n  public readonly rootScene: Scene;\r\n\r\n  private _sceneToLoader = new Map<string, DefaultLoader>();\r\n  private _sceneToTransition = new Map<string, { in?: Transition; out?: Transition }>();\r\n  /**\r\n   * Used to keep track of scenes that have already been loaded so we don't load multiple times\r\n   */\r\n  private _loadedScenes = new Set<Scene>();\r\n\r\n  private _isTransitioning = false;\r\n\r\n  /**\r\n   * Gets whether the director currently transitioning between scenes\r\n   *\r\n   * Useful if you need to block behavior during transition\r\n   */\r\n  public get isTransitioning() {\r\n    return this._isTransitioning;\r\n  }\r\n\r\n  constructor(\r\n    private _engine: Engine,\r\n    scenes: SceneMap<TKnownScenes>\r\n  ) {\r\n    this.rootScene = this.currentScene = new Scene();\r\n    this.add('root', this.rootScene);\r\n    this.currentScene = this.rootScene;\r\n    this.currentSceneName = 'root';\r\n    for (const sceneKey in scenes) {\r\n      const sceneOrOptions = scenes[sceneKey];\r\n      this.add(sceneKey, sceneOrOptions);\r\n      if (sceneKey === 'root') {\r\n        this.rootScene = this.getSceneInstance('root')!; // always a root scene\r\n        this.currentScene = this.rootScene;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the director's internal state\r\n   */\r\n  async onInitialize() {\r\n    if (!this._initialized) {\r\n      this._initialized = true;\r\n      if (this._deferredGoto) {\r\n        const deferredScene = this._deferredGoto;\r\n        this._deferredGoto = undefined;\r\n        const deferredTransition = this._deferredTransition;\r\n        this._deferredTransition = undefined;\r\n        const deferredSceneInstance = this.getSceneInstance(deferredScene);\r\n        if (deferredSceneInstance && deferredTransition) {\r\n          deferredTransition._addToTargetScene(this._engine, deferredSceneInstance);\r\n        }\r\n        await this.swapScene(deferredScene);\r\n        if (deferredSceneInstance && deferredTransition) {\r\n          await this.playTransition(deferredTransition, deferredSceneInstance);\r\n        }\r\n      } else {\r\n        await this.swapScene('root');\r\n      }\r\n    }\r\n  }\r\n\r\n  get isInitialized() {\r\n    return this._initialized;\r\n  }\r\n\r\n  /**\r\n   * Configures the start scene, and optionally the transition & loader for the director\r\n   *\r\n   * Typically this is called at the beginning of the game to the start scene and transition and never again.\r\n   * @param startScene\r\n   * @param options\r\n   */\r\n  configureStart(startScene: WithRoot<TKnownScenes>, options?: StartOptions) {\r\n    const maybeLoaderOrCtor = options?.loader;\r\n    if (maybeLoaderOrCtor instanceof DefaultLoader) {\r\n      this.mainLoader = maybeLoaderOrCtor;\r\n    } else if (isLoaderConstructor(maybeLoaderOrCtor)) {\r\n      this.mainLoader = new maybeLoaderOrCtor();\r\n    } else {\r\n      this.mainLoader = new Loader();\r\n    }\r\n\r\n    let maybeStartTransition: Transition | undefined;\r\n\r\n    if (options?.inTransition) {\r\n      const { inTransition } = options;\r\n      maybeStartTransition = inTransition;\r\n    }\r\n\r\n    this.startScene = startScene;\r\n\r\n    // Fire and forget promise for the initial scene\r\n    if (maybeStartTransition) {\r\n      const startSceneInstance = this.getSceneInstance(this.startScene);\r\n      if (startSceneInstance) {\r\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n        maybeStartTransition._addToTargetScene(this._engine, startSceneInstance);\r\n        this.swapScene(this.startScene).then(() => {\r\n          // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n          return this.playTransition(maybeStartTransition, startSceneInstance);\r\n        });\r\n      }\r\n    } else {\r\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n      this.swapScene(this.startScene);\r\n    }\r\n\r\n    this.currentSceneName = this.startScene;\r\n  }\r\n\r\n  private _getLoader(sceneName: string) {\r\n    return this._sceneToLoader.get(sceneName);\r\n  }\r\n\r\n  private _getInTransition(sceneName: string): Transition | undefined {\r\n    const sceneOrRoute = this.scenes[sceneName as TKnownScenes];\r\n    if (sceneOrRoute instanceof Scene || isSceneConstructor(sceneOrRoute)) {\r\n      return undefined;\r\n    }\r\n    return sceneOrRoute?.transitions?.in;\r\n  }\r\n\r\n  private _getOutTransition(sceneName: string): Transition | undefined {\r\n    const sceneOrRoute = this.scenes[sceneName as TKnownScenes];\r\n    if (sceneOrRoute instanceof Scene || isSceneConstructor(sceneOrRoute)) {\r\n      return undefined;\r\n    }\r\n    return sceneOrRoute?.transitions?.out;\r\n  }\r\n\r\n  getDeferredScene() {\r\n    const maybeDeferred = this.getSceneDefinition(this._deferredGoto);\r\n    if (this._deferredGoto && maybeDeferred) {\r\n      return maybeDeferred;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns a scene by name if it exists, might be the constructor and not the instance of a scene\r\n   * @param name\r\n   */\r\n  getSceneDefinition(name?: string): Scene | SceneConstructor | undefined {\r\n    const maybeScene = this.scenes[name as TKnownScenes];\r\n    if (maybeScene instanceof Scene || isSceneConstructor(maybeScene)) {\r\n      return maybeScene;\r\n    } else if (maybeScene) {\r\n      return maybeScene.scene;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Returns the name of the registered scene, null if none can be found\r\n   * @param scene\r\n   */\r\n  getSceneName(scene: Scene): string | null {\r\n    for (const [name, maybeScene] of Object.entries(this.scenes)) {\r\n      if (maybeScene instanceof Scene) {\r\n        if (scene === maybeScene) {\r\n          return name;\r\n        }\r\n      } else if (!isSceneConstructor(maybeScene)) {\r\n        if (scene === maybeScene.scene) {\r\n          return name;\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const [name, maybeScene] of Object.entries(this.scenes)) {\r\n      if (isSceneConstructor(maybeScene)) {\r\n        if (scene.constructor === maybeScene) {\r\n          return name;\r\n        }\r\n      } else if (!(maybeScene instanceof Scene)) {\r\n        if (scene.constructor === maybeScene.scene) {\r\n          return name;\r\n        }\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Returns the same Director, but asserts a scene DOES exist to the type system\r\n   * @param name\r\n   */\r\n  assertAdded<TScene extends string>(name: TScene): Director<TKnownScenes | TScene> {\r\n    return this as Director<TKnownScenes | TScene>;\r\n  }\r\n\r\n  /**\r\n   * Returns the same Director, but asserts a scene DOES NOT exist to the type system\r\n   * @param name\r\n   */\r\n  assertRemoved<TScene extends string>(name: TScene): Director<Exclude<TKnownScenes, TScene>> {\r\n    return this as Director<Exclude<TKnownScenes, TScene>>;\r\n  }\r\n\r\n  /**\r\n   * Adds additional Scenes to the game!\r\n   * @param name\r\n   * @param sceneOrRoute\r\n   */\r\n  add<TScene extends string>(name: TScene, sceneOrRoute: Scene | SceneConstructor | SceneWithOptions): Director<TKnownScenes | TScene> {\r\n    if (!(sceneOrRoute instanceof Scene) && !isSceneConstructor(sceneOrRoute)) {\r\n      const { loader, transitions } = sceneOrRoute;\r\n      const { in: inTransition, out: outTransition } = transitions ?? {};\r\n      this._sceneToTransition.set(name, { in: inTransition, out: outTransition });\r\n\r\n      if (isLoaderConstructor(loader)) {\r\n        this._sceneToLoader.set(name, new loader());\r\n      } else if (loader) {\r\n        this._sceneToLoader.set(name, loader);\r\n      }\r\n    }\r\n\r\n    if (this.scenes[name as unknown as TKnownScenes]) {\r\n      this._logger.warn('Scene', name, 'already exists overwriting');\r\n    }\r\n    this.scenes[name as unknown as TKnownScenes] = sceneOrRoute;\r\n    return this.assertAdded(name);\r\n  }\r\n\r\n  remove(scene: Scene): void;\r\n  remove(sceneCtor: SceneConstructor): void;\r\n  remove(name: WithRoot<TKnownScenes>): void;\r\n  remove(nameOrScene: TKnownScenes | Scene | SceneConstructor | string) {\r\n    if (nameOrScene instanceof Scene || isSceneConstructor(nameOrScene)) {\r\n      const sceneOrCtor = nameOrScene;\r\n      // remove scene\r\n      for (const key in this.scenes) {\r\n        if (this.scenes.hasOwnProperty(key)) {\r\n          const potentialSceneOrOptions = this.scenes[key as TKnownScenes];\r\n          let scene: Scene | SceneConstructor;\r\n          if (potentialSceneOrOptions instanceof Scene || isSceneConstructor(potentialSceneOrOptions)) {\r\n            scene = potentialSceneOrOptions;\r\n          } else {\r\n            scene = potentialSceneOrOptions.scene;\r\n          }\r\n\r\n          if (scene === sceneOrCtor) {\r\n            if (key === this.currentSceneName) {\r\n              throw new Error(`Cannot remove a currently active scene: ${key}`);\r\n            }\r\n\r\n            this._sceneToInstance.delete(key);\r\n            this._sceneToTransition.delete(key);\r\n            this._sceneToLoader.delete(key);\r\n            delete this.scenes[key as TKnownScenes];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (typeof nameOrScene === 'string') {\r\n      if (nameOrScene === this.currentSceneName) {\r\n        throw new Error(`Cannot remove a currently active scene: ${nameOrScene}`);\r\n      }\r\n\r\n      // remove scene\r\n      this._sceneToInstance.delete(nameOrScene);\r\n      this._sceneToTransition.delete(nameOrScene);\r\n      this._sceneToLoader.delete(nameOrScene);\r\n      delete this.scenes[nameOrScene as TKnownScenes];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Go to a specific scene, and optionally override loaders and transitions\r\n   * @param destinationScene\r\n   * @param options\r\n   */\r\n  async goToScene(destinationScene: TKnownScenes | string, options?: GoToOptions) {\r\n    const maybeDest = this.getSceneInstance(destinationScene);\r\n    if (!maybeDest) {\r\n      this._logger.warn(`Scene ${destinationScene} does not exist! Check the name, are you sure you added it?`);\r\n      return;\r\n    }\r\n    const sourceSceneInstance = this.currentScene;\r\n    const sourceScene = this.currentSceneName;\r\n    const engineInputEnabled = this._engine.input?.enabled ?? true;\r\n    this._isTransitioning = true;\r\n\r\n    const maybeSourceOut = this.getSceneInstance(sourceScene)?.onTransition('out');\r\n    const maybeDestinationIn = maybeDest?.onTransition('in');\r\n\r\n    options = {\r\n      // Engine configuration then dynamic scene transitions\r\n      ...{ sourceOut: this._getOutTransition(this.currentSceneName) ?? maybeSourceOut },\r\n      ...{ destinationIn: this._getInTransition(destinationScene) ?? maybeDestinationIn },\r\n      // Goto options\r\n      ...options\r\n    };\r\n\r\n    const { sourceOut, destinationIn, sceneActivationData } = options;\r\n\r\n    const outTransition = sourceOut ?? this._getOutTransition(this.currentSceneName);\r\n    const inTransition = destinationIn ?? this._getInTransition(destinationScene);\r\n\r\n    const hideLoader = outTransition?.hideLoader || inTransition?.hideLoader;\r\n    if (hideLoader) {\r\n      // Start hidden loader early and take advantage of the transition\r\n      // Don't await and block on a hidden loader\r\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n      this.maybeLoadScene(destinationScene, hideLoader);\r\n    }\r\n\r\n    this._emitEvent('navigationstart', sourceScene, destinationScene);\r\n\r\n    // Run the out transition on the current scene if present\r\n    if (outTransition) {\r\n      await this.playTransition(outTransition, sourceSceneInstance);\r\n    }\r\n\r\n    // Run the loader if present\r\n    await this.maybeLoadScene(destinationScene, hideLoader);\r\n\r\n    // Give incoming transition a chance to grab info from previous\r\n    if (inTransition) {\r\n      await inTransition.onPreviousSceneDeactivate(this.currentScene);\r\n    }\r\n\r\n    // Setup the in transition on the destination scene if present\r\n    // this is important to it can be initialized with the\r\n    if (inTransition) {\r\n      inTransition._addToTargetScene(this._engine, maybeDest);\r\n    }\r\n\r\n    // Swap to the new scene\r\n    // Runs scene lifecycle init and activate\r\n    await this.swapScene(destinationScene, sceneActivationData);\r\n    this._emitEvent('navigation', sourceScene, destinationScene);\r\n\r\n    // Run the in transition on the new scene if present\r\n    if (inTransition) {\r\n      await this.playTransition(inTransition, maybeDest);\r\n    }\r\n    this._emitEvent('navigationend', sourceScene, destinationScene);\r\n\r\n    this._engine.input?.toggleEnabled(engineInputEnabled);\r\n    this._isTransitioning = false;\r\n  }\r\n\r\n  /**\r\n   * Retrieves a scene instance by key if it's registered.\r\n   *\r\n   * This will call any constructors that were given as a definition\r\n   * @param scene\r\n   */\r\n  getSceneInstance(scene: string): Scene | undefined {\r\n    const sceneDefinition = this.getSceneDefinition(scene);\r\n    if (!sceneDefinition) {\r\n      return undefined;\r\n    }\r\n    if (this._sceneToInstance.has(scene)) {\r\n      return this._sceneToInstance.get(scene) as Scene;\r\n    }\r\n    if (sceneDefinition instanceof Scene) {\r\n      this._sceneToInstance.set(scene, sceneDefinition);\r\n      return sceneDefinition;\r\n    }\r\n    const newScene = new sceneDefinition();\r\n    this._sceneToInstance.set(scene, newScene);\r\n    return newScene;\r\n  }\r\n\r\n  /**\r\n   * Triggers scene loading if has not already been loaded\r\n   * @param scene\r\n   * @param hideLoader\r\n   */\r\n  async maybeLoadScene(scene: string, hideLoader = false) {\r\n    const loader = this._getLoader(scene) ?? new DefaultLoader();\r\n    const sceneToLoad = this.getSceneDefinition(scene);\r\n    const sceneToLoadInstance = this.getSceneInstance(scene);\r\n    if (sceneToLoad && sceneToLoadInstance && !this._loadedScenes.has(sceneToLoadInstance)) {\r\n      sceneToLoadInstance.onPreLoad(loader);\r\n      sceneToLoadInstance.events.emit('preload', { loader });\r\n      if (hideLoader) {\r\n        // Don't await a hidden loader\r\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises\r\n        this._engine.load(loader, hideLoader);\r\n      } else {\r\n        await this._engine.load(loader);\r\n      }\r\n      this._loadedScenes.add(sceneToLoadInstance);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Plays a transition in the current scene and does book keeping for input.\r\n   * @param transition\r\n   */\r\n  async playTransition(transition: Transition, targetScene: Scene) {\r\n    if (!this.isInitialized) {\r\n      this._deferredTransition = transition;\r\n      return;\r\n    }\r\n\r\n    if (transition) {\r\n      this.currentTransition = transition;\r\n      const sceneInputEnabled = targetScene.input?.enabled ?? true;\r\n\r\n      targetScene.input?.toggleEnabled(!transition.blockInput);\r\n      this._engine.input?.toggleEnabled(!transition.blockInput);\r\n\r\n      this.currentTransition._addToTargetScene(this._engine, targetScene);\r\n      await this.currentTransition._play();\r\n\r\n      targetScene.input?.toggleEnabled(sceneInputEnabled);\r\n    }\r\n    this.currentTransition?.kill();\r\n    this.currentTransition?.reset();\r\n    this.currentTransition = undefined;\r\n  }\r\n\r\n  /**\r\n   * Swaps the current and destination scene after performing required lifecycle events\r\n   * @param destinationScene\r\n   * @param data\r\n   */\r\n  async swapScene<TData = undefined>(destinationScene: string, data?: TData): Promise<void> {\r\n    const engine = this._engine;\r\n    // if not yet initialized defer goToScene\r\n    if (!this.isInitialized) {\r\n      this._deferredGoto = destinationScene;\r\n      return;\r\n    }\r\n\r\n    const maybeDest = this.getSceneInstance(destinationScene);\r\n\r\n    if (maybeDest) {\r\n      const previousScene = this.currentScene;\r\n      const nextScene = maybeDest;\r\n\r\n      this._logger.debug('Going to scene:', destinationScene);\r\n      // only deactivate when initialized\r\n      if (this.currentScene.isInitialized) {\r\n        const context = { engine, previousScene, nextScene };\r\n        await this.currentScene._deactivate(context);\r\n        this.currentScene.events.emit('deactivate', new DeactivateEvent(context, this.currentScene));\r\n        this.currentScene.input.clear();\r\n      }\r\n\r\n      // wait for the scene to be loaded if needed\r\n      const destLoader = this._sceneToLoader.get(destinationScene);\r\n      await destLoader?.areResourcesLoaded();\r\n\r\n      // set current scene to new one\r\n      this.currentScene = nextScene;\r\n      this.currentSceneName = destinationScene;\r\n      engine.screen.setCurrentCamera(nextScene.camera);\r\n\r\n      // initialize the current scene if has not been already\r\n      await this.currentScene._initialize(engine);\r\n\r\n      const context = { engine, previousScene, nextScene, data };\r\n      await this.currentScene._activate(context);\r\n      this.currentScene.events.emit('activate', new ActivateEvent(context, this.currentScene));\r\n    } else {\r\n      this._logger.error('Scene', destinationScene, 'does not exist!');\r\n    }\r\n  }\r\n\r\n  private _emitEvent(eventName: keyof DirectorEvents, sourceScene: string, destinationScene: string) {\r\n    const source = this.getSceneDefinition(sourceScene)!;\r\n    const dest = this.getSceneDefinition(destinationScene)!;\r\n    this.events.emit(eventName, {\r\n      sourceScene: source,\r\n      sourceName: sourceScene,\r\n      destinationScene: dest,\r\n      destinationName: destinationScene\r\n    } as DirectorNavigationEvent);\r\n  }\r\n}\r\n","export interface Context<TValue> {\r\n  /**\r\n   * Run the callback before popping the context value\r\n   * @param value\r\n   * @param cb\r\n   */\r\n  scope: <TReturn>(value: TValue, cb: () => TReturn) => TReturn;\r\n  value: TValue;\r\n}\r\n\r\n/**\r\n * Creates a injectable context that can be retrieved later with `useContext(context)`\r\n *\r\n * Example\r\n * ```typescript\r\n *\r\n * const AppContext = createContext({some: 'value'});\r\n * context.scope(val, () => {\r\n *    const value = useContext(AppContext);\r\n * })\r\n *\r\n * ```\r\n */\r\nexport function createContext<TValue>() {\r\n  const ctx: Context<TValue> = {\r\n    scope: (value, cb) => {\r\n      const old = ctx.value;\r\n      ctx.value = value;\r\n      try {\r\n        return cb();\r\n      } catch (e) {\r\n        throw e;\r\n      } finally {\r\n        ctx.value = old;\r\n      }\r\n    },\r\n    value: undefined\r\n  };\r\n  return ctx;\r\n}\r\n\r\n/**\r\n * Retrieves the value from the current context\r\n */\r\nexport function useContext<TValue>(context: Context<TValue>): TValue {\r\n  return context.value;\r\n}\r\n","export interface GarbageCollectionOptions {\r\n  /**\r\n   * Textures that aren't drawn after a certain number of milliseconds are unloaded from the GPU\r\n   * Default 60_000 ms\r\n   */\r\n  textureCollectInterval?: number; // default 60_000 ms\r\n  // TODO future work to integrate the font and text configuration, refactor existing collection mechanism\r\n  // /**\r\n  //  * Font pre-renders that aren't drawn after a certain number of milliseconds are unloaded from the GPU\r\n  //  * Default 60_000 ms\r\n  //  */\r\n  // fontCollectInterval: number; // default 60_000 ms\r\n  // /**\r\n  //  * Text measurements that aren't used after a certain number of milliseconds are unloaded from the GPU\r\n  //  * Default 60_000 ms\r\n  //  */\r\n  // textMeasurementCollectInterval: number; // default 60_000 ms\r\n}\r\n\r\nexport const DefaultGarbageCollectionOptions: GarbageCollectionOptions = {\r\n  textureCollectInterval: 60_000\r\n  // TODO future work to integrate the font and text configuration, refactor existing collection mechanism\r\n  // fontCollectInterval: 60_000,\r\n  // textMeasurementCollectInterval: 60_000,\r\n};\r\n\r\nexport interface GarbageCollectorOptions {\r\n  /**\r\n   * Returns a timestamp in milliseconds representing now\r\n   */\r\n  getTimestamp: () => number;\r\n}\r\n\r\nexport class GarbageCollector {\r\n  private _collectHandle: number;\r\n  private _running = false;\r\n  private _collectionMap = new Map<any, [type: string, time: number]>();\r\n  private _collectors = new Map<string, [(resource: any) => boolean, interval: number]>();\r\n\r\n  constructor(public options: GarbageCollectorOptions) {}\r\n\r\n  /**\r\n   *\r\n   * @param type Resource type\r\n   * @param timeoutInterval If resource type exceeds interval in milliseconds collect() is called\r\n   * @param collect Collection implementation, returns true if collected\r\n   */\r\n  registerCollector(type: string, timeoutInterval: number, collect: (resource: any) => boolean) {\r\n    this._collectors.set(type, [collect, timeoutInterval]);\r\n  }\r\n\r\n  /**\r\n   * Add a resource to be tracked for collection\r\n   * @param type\r\n   * @param resource\r\n   */\r\n  addCollectableResource(type: string, resource: any) {\r\n    this._collectionMap.set(resource, [type, this.options.getTimestamp()]);\r\n  }\r\n\r\n  /**\r\n   * Update the resource last used timestamp preventing collection\r\n   * @param resource\r\n   */\r\n  touch(resource: any) {\r\n    const collectionData = this._collectionMap.get(resource);\r\n    if (collectionData) {\r\n      this._collectionMap.set(resource, [collectionData[0], this.options.getTimestamp()]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Runs the collection loop to cleanup any stale resources given the registered collect handlers\r\n   */\r\n  public collectStaleResources = (deadline?: IdleDeadline) => {\r\n    if (!this._running) {\r\n      return;\r\n    }\r\n    for (const [type, [collector, timeoutInterval]] of this._collectors.entries()) {\r\n      const now = this.options.getTimestamp();\r\n      for (const [resource, [resourceType, time]] of this._collectionMap.entries()) {\r\n        if (type !== resourceType || time + timeoutInterval >= now) {\r\n          continue;\r\n        }\r\n\r\n        const collected = collector(resource);\r\n        if (collected) {\r\n          this._collectionMap.delete(resource);\r\n        }\r\n      }\r\n    }\r\n\r\n    this._collectHandle = requestIdleCallback(this.collectStaleResources);\r\n  };\r\n\r\n  /**\r\n   * Force collect all resources, useful for shutting down a game\r\n   * or if you know that you will not use anything you've allocated before now\r\n   */\r\n  public forceCollectAll() {\r\n    for (const [_, [collector]] of this._collectors.entries()) {\r\n      for (const [resource] of this._collectionMap.entries()) {\r\n        const collected = collector(resource);\r\n        if (collected) {\r\n          this._collectionMap.delete(resource);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Starts the garbage collection loop\r\n   */\r\n  start() {\r\n    this._running = true;\r\n    this.collectStaleResources();\r\n  }\r\n\r\n  /**\r\n   * Stops the garbage collection loop\r\n   */\r\n  stop() {\r\n    this._running = false;\r\n    cancelIdleCallback(this._collectHandle);\r\n  }\r\n}\r\n","import { EX_VERSION } from './';\r\nimport { Future } from './Util/Future';\r\nimport { EventEmitter, EventKey, Handler, Subscription } from './EventEmitter';\r\nimport { PointerScope } from './Input/PointerScope';\r\nimport { Flags } from './Flags';\r\nimport { polyfill } from './Polyfill';\r\npolyfill();\r\nimport { CanUpdate, CanDraw, CanInitialize } from './Interfaces/LifecycleEvents';\r\nimport { Vector } from './Math/vector';\r\nimport { Screen, DisplayMode, Resolution, ViewportDimension } from './Screen';\r\nimport { ScreenElement } from './ScreenElement';\r\nimport { Actor } from './Actor';\r\nimport { Timer } from './Timer';\r\nimport { TileMap } from './TileMap';\r\nimport { DefaultLoader } from './Director/DefaultLoader';\r\nimport { Loader } from './Director/Loader';\r\nimport { Detector } from './Util/Detector';\r\nimport {\r\n  VisibleEvent,\r\n  HiddenEvent,\r\n  GameStartEvent,\r\n  GameStopEvent,\r\n  PreUpdateEvent,\r\n  PostUpdateEvent,\r\n  PreFrameEvent,\r\n  PostFrameEvent,\r\n  PreDrawEvent,\r\n  PostDrawEvent,\r\n  InitializeEvent\r\n} from './Events';\r\nimport { Logger, LogLevel } from './Util/Log';\r\nimport { Color } from './Color';\r\nimport { Scene, SceneConstructor, isSceneConstructor } from './Scene';\r\nimport { Entity } from './EntityComponentSystem/Entity';\r\nimport { DebugConfig, DebugStats } from './Debug/DebugConfig';\r\nimport { BrowserEvents } from './Util/Browser';\r\nimport {\r\n  AntialiasOptions,\r\n  DefaultAntialiasOptions,\r\n  DefaultPixelArtOptions,\r\n  ExcaliburGraphicsContext,\r\n  ExcaliburGraphicsContext2DCanvas,\r\n  ExcaliburGraphicsContextWebGL,\r\n  TextureLoader\r\n} from './Graphics';\r\nimport { Clock, StandardClock } from './Util/Clock';\r\nimport { ImageFiltering } from './Graphics/Filtering';\r\nimport { GraphicsDiagnostics } from './Graphics/GraphicsDiagnostics';\r\nimport { Toaster } from './Util/Toaster';\r\nimport { InputMapper } from './Input/InputMapper';\r\nimport { GoToOptions, SceneMap, Director, StartOptions, SceneWithOptions, WithRoot } from './Director/Director';\r\nimport { InputHost } from './Input/InputHost';\r\nimport { getDefaultPhysicsConfig, PhysicsConfig } from './Collision/PhysicsConfig';\r\nimport { DeepRequired } from './Util/Required';\r\nimport { Context, createContext, useContext } from './Context';\r\nimport { DefaultGarbageCollectionOptions, GarbageCollectionOptions, GarbageCollector } from './GarbageCollector';\r\nimport { mergeDeep } from './Util/Util';\r\n\r\nexport type EngineEvents = {\r\n  fallbackgraphicscontext: ExcaliburGraphicsContext2DCanvas;\r\n  initialize: InitializeEvent<Engine>;\r\n  visible: VisibleEvent;\r\n  hidden: HiddenEvent;\r\n  start: GameStartEvent;\r\n  stop: GameStopEvent;\r\n  preupdate: PreUpdateEvent<Engine>;\r\n  postupdate: PostUpdateEvent<Engine>;\r\n  preframe: PreFrameEvent;\r\n  postframe: PostFrameEvent;\r\n  predraw: PreDrawEvent;\r\n  postdraw: PostDrawEvent;\r\n};\r\n\r\nexport const EngineEvents = {\r\n  FallbackGraphicsContext: 'fallbackgraphicscontext',\r\n  Initialize: 'initialize',\r\n  Visible: 'visible',\r\n  Hidden: 'hidden',\r\n  Start: 'start',\r\n  Stop: 'stop',\r\n  PreUpdate: 'preupdate',\r\n  PostUpdate: 'postupdate',\r\n  PreFrame: 'preframe',\r\n  PostFrame: 'postframe',\r\n  PreDraw: 'predraw',\r\n  PostDraw: 'postdraw'\r\n} as const;\r\n\r\n/**\r\n * Enum representing the different mousewheel event bubble prevention\r\n */\r\nexport enum ScrollPreventionMode {\r\n  /**\r\n   * Do not prevent any page scrolling\r\n   */\r\n  None,\r\n  /**\r\n   * Prevent page scroll if mouse is over the game canvas\r\n   */\r\n  Canvas,\r\n  /**\r\n   * Prevent all page scrolling via mouse wheel\r\n   */\r\n  All\r\n}\r\n\r\n/**\r\n * Defines the available options to configure the Excalibur engine at constructor time.\r\n */\r\nexport interface EngineOptions<TKnownScenes extends string = any> {\r\n  /**\r\n   * Optionally configure the width of the viewport in css pixels\r\n   */\r\n  width?: number;\r\n\r\n  /**\r\n   * Optionally configure the height of the viewport in css pixels\r\n   */\r\n  height?: number;\r\n\r\n  /**\r\n   * Optionally configure the width & height of the viewport in css pixels.\r\n   * Use `viewport` instead of {@apilink EngineOptions.width} and {@apilink EngineOptions.height}, or vice versa.\r\n   */\r\n  viewport?: ViewportDimension;\r\n\r\n  /**\r\n   * Optionally specify the size the logical pixel resolution, if not specified it will be width x height.\r\n   * See {@apilink Resolution} for common presets.\r\n   */\r\n  resolution?: Resolution;\r\n\r\n  /**\r\n   * Optionally specify antialiasing (smoothing), by default true (smooth pixels)\r\n   *\r\n   *  * `true` - useful for high resolution art work you would like smoothed, this also hints excalibur to load images\r\n   * with default blending {@apilink ImageFiltering.Blended}\r\n   *\r\n   *  * `false` - useful for pixel art style art work you would like sharp, this also hints excalibur to load images\r\n   * with default blending {@apilink ImageFiltering.Pixel}\r\n   *\r\n   * * {@apilink AntialiasOptions} Optionally deeply configure the different antialiasing settings, **WARNING** thar be dragons here.\r\n   * It is recommended you stick to `true` or `false` unless you understand what you're doing and need to control rendering to\r\n   * a high degree.\r\n   */\r\n  antialiasing?: boolean | AntialiasOptions;\r\n\r\n  /**\r\n   * Optionally specify excalibur garbage collection, by default true.\r\n   *\r\n   * * `true` - garbage collection defaults are enabled (default)\r\n   *\r\n   * * `false` - garbage collection is completely disabled (not recommended)\r\n   *\r\n   * * {@apilink GarbageCollectionOptions} Optionally deeply configure garbage collection settings, **WARNING** thar be dragons here.\r\n   * It is recommended you stick to `true` or `false` unless you understand what you're doing, it is possible to get into a downward\r\n   * spiral if collection timings are set too low where you are stuck in repeated collection.\r\n   */\r\n  garbageCollection?: boolean | GarbageCollectionOptions;\r\n\r\n  /**\r\n   * Quick convenience property to configure Excalibur to use special settings for \"pretty\" anti-aliased pixel art\r\n   *\r\n   * 1. Turns on special shader condition to blend for pixel art and enables various antialiasing settings,\r\n   *  notice blending is ON for this special mode.\r\n   *\r\n   * Equivalent to:\r\n   * ```javascript\r\n   * antialiasing: {\r\n   *  pixelArtSampler: true,\r\n   *  canvasImageRendering: 'auto',\r\n   *  filtering: ImageFiltering.Blended,\r\n   *  webglAntialiasing: true\r\n   * }\r\n   * ```\r\n   */\r\n  pixelArt?: boolean;\r\n\r\n  /**\r\n   * Specify any UV padding you want use in pixels, this brings sampling into the texture if you're using\r\n   * a sprite sheet in one image to prevent sampling bleed.\r\n   *\r\n   * Defaults:\r\n   * * `antialiasing: false` or `filtering: ImageFiltering.Pixel` - 0.0;\r\n   * * `pixelArt: true` - 0.25\r\n   * * All else 0.01\r\n   */\r\n  uvPadding?: number;\r\n\r\n  /**\r\n   * Optionally hint the graphics context into a specific power profile\r\n   *\r\n   * Default \"high-performance\"\r\n   */\r\n  powerPreference?: 'default' | 'high-performance' | 'low-power';\r\n\r\n  /**\r\n   * Optionally upscale the number of pixels in the canvas. Normally only useful if you need a smoother look to your assets, especially\r\n   * {@apilink Text} or Pixel Art assets.\r\n   *\r\n   * **WARNING** It is recommended you try using `antialiasing: true` before adjusting pixel ratio. Pixel ratio will consume more memory\r\n   * and on mobile may break if the internal size of the canvas exceeds 4k pixels in width or height.\r\n   *\r\n   * Default is based the display's pixel ratio, for example a HiDPI screen might have the value 2;\r\n   */\r\n  pixelRatio?: number;\r\n\r\n  /**\r\n   * Optionally configure the native canvas transparent backdrop\r\n   */\r\n  enableCanvasTransparency?: boolean;\r\n\r\n  /**\r\n   * Optionally specify the target canvas DOM element to render the game in\r\n   */\r\n  canvasElementId?: string;\r\n\r\n  /**\r\n   * Optionally specify the target canvas DOM element directly\r\n   */\r\n  canvasElement?: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Optionally enable the right click context menu on the canvas\r\n   *\r\n   * Default if unset is false\r\n   */\r\n  enableCanvasContextMenu?: boolean;\r\n\r\n  /**\r\n   * Optionally snap graphics to nearest pixel, default is false\r\n   */\r\n  snapToPixel?: boolean;\r\n\r\n  /**\r\n   * The {@apilink DisplayMode} of the game, by default {@apilink DisplayMode.FitScreen} with aspect ratio 4:3 (800x600).\r\n   * Depending on this value, {@apilink width} and {@apilink height} may be ignored.\r\n   */\r\n  displayMode?: DisplayMode;\r\n\r\n  /**\r\n   * Configures the pointer scope. Pointers scoped to the 'Canvas' can only fire events within the canvas viewport; whereas, 'Document'\r\n   * (default) scoped will fire anywhere on the page.\r\n   */\r\n  pointerScope?: PointerScope;\r\n\r\n  /**\r\n   * Suppress boot up console message, which contains the \"powered by Excalibur message\"\r\n   */\r\n  suppressConsoleBootMessage?: boolean;\r\n\r\n  /**\r\n   * Suppress minimum browser feature detection, it is not recommended users of excalibur switch this off. This feature ensures that\r\n   * the currently running browser meets the minimum requirements for running excalibur. This can be useful if running on non-standard\r\n   * browsers or if there is a bug in excalibur preventing execution.\r\n   */\r\n  suppressMinimumBrowserFeatureDetection?: boolean;\r\n\r\n  /**\r\n   * Suppress HiDPI auto detection and scaling, it is not recommended users of excalibur switch off this feature. This feature detects\r\n   * and scales the drawing canvas appropriately to accommodate HiDPI screens.\r\n   */\r\n  suppressHiDPIScaling?: boolean;\r\n\r\n  /**\r\n   * Suppress play button, it is not recommended users of excalibur switch this feature. Some browsers require a user gesture (like a click)\r\n   * for certain browser features to work like web audio.\r\n   */\r\n  suppressPlayButton?: boolean;\r\n\r\n  /**\r\n   * Sets the focus of the window, this is needed when hosting excalibur in a cross-origin iframe in order for certain events\r\n   * (like keyboard) to work.\r\n   * For example: itch.io or codesandbox.io\r\n   *\r\n   * By default set to true,\r\n   */\r\n  grabWindowFocus?: boolean;\r\n\r\n  /**\r\n   * Scroll prevention method.\r\n   */\r\n  scrollPreventionMode?: ScrollPreventionMode;\r\n\r\n  /**\r\n   * Optionally set the background color\r\n   */\r\n  backgroundColor?: Color;\r\n\r\n  /**\r\n   * Optionally set the maximum fps if not set Excalibur will go as fast as the device allows.\r\n   *\r\n   * You may want to constrain max fps if your game cannot maintain fps consistently, it can look and feel better to have a 30fps game than\r\n   * one that bounces between 30fps and 60fps\r\n   */\r\n  maxFps?: number;\r\n\r\n  /**\r\n   * Optionally configure a fixed update timestep in milliseconds, this can be desirable if you need the physics simulation to be very stable. When\r\n   * set the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   *\r\n   * **WARN:** `fixedUpdateTimestep` takes precedence over `fixedUpdateFps` use whichever is most convenient.\r\n   */\r\n  fixedUpdateTimestep?: number;\r\n\r\n  /**\r\n   * Optionally configure a fixed update fps, this can be desirable if you need the physics simulation to be very stable. When set\r\n   * the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   *\r\n   * **WARN:** `fixedUpdateTimestep` takes precedence over `fixedUpdateFps` use whichever is most convenient.\r\n   */\r\n  fixedUpdateFps?: number;\r\n\r\n  /**\r\n   * Default `true`, optionally configure excalibur to use optimal draw call sorting, to opt out set this to `false`.\r\n   *\r\n   * Excalibur will automatically sort draw calls by z and priority into renderer batches for maximal draw performance,\r\n   * this can disrupt a specific desired painter order.\r\n   *\r\n   */\r\n  useDrawSorting?: boolean;\r\n\r\n  /**\r\n   * Optionally provide a custom handler for the webgl context lost event\r\n   */\r\n  handleContextLost?: (e: Event) => void;\r\n\r\n  /**\r\n   * Optionally provide a custom handler for the webgl context restored event\r\n   */\r\n  handleContextRestored?: (e: Event) => void;\r\n\r\n  /**\r\n   * Optionally configure how excalibur handles poor performance on a player's browser\r\n   */\r\n  configurePerformanceCanvas2DFallback?: {\r\n    /**\r\n     * By default `false`, this will switch the internal graphics context to Canvas2D which can improve performance on non hardware\r\n     * accelerated browsers.\r\n     */\r\n    allow: boolean;\r\n    /**\r\n     * By default `false`, if set to `true` a dialogue will be presented to the player about their browser and how to potentially\r\n     * address any issues.\r\n     */\r\n    showPlayerMessage?: boolean;\r\n    /**\r\n     * Default `{ numberOfFrames: 100, fps: 20 }`, optionally configure excalibur to fallback to the 2D Canvas renderer\r\n     * if bad performance is detected.\r\n     *\r\n     * In this example of the default if excalibur is running at 20fps or less for 100 frames it will trigger the fallback to the 2D\r\n     * Canvas renderer.\r\n     */\r\n    threshold?: { numberOfFrames: number; fps: number };\r\n  };\r\n\r\n  /**\r\n   * Optionally configure the physics simulation in excalibur\r\n   *\r\n   * If false, Excalibur will not produce a physics simulation.\r\n   *\r\n   * Default is configured to use {@apilink SolverStrategy.Arcade} physics simulation\r\n   */\r\n  physics?: boolean | PhysicsConfig;\r\n\r\n  /**\r\n   * Optionally specify scenes with their transitions and loaders to excalibur's scene {@apilink Director}\r\n   *\r\n   * Scene transitions can can overridden dynamically by the `Scene` or by the call to `.goToScene`\r\n   */\r\n  scenes?: SceneMap<TKnownScenes>;\r\n}\r\n\r\n/**\r\n * The Excalibur Engine\r\n *\r\n * The {@apilink Engine} is the main driver for a game. It is responsible for\r\n * starting/stopping the game, maintaining state, transmitting events,\r\n * loading resources, and managing the scene.\r\n */\r\nexport class Engine<TKnownScenes extends string = any> implements CanInitialize, CanUpdate, CanDraw {\r\n  static Context: Context<Engine | null> = createContext<Engine | null>();\r\n  static useEngine(): Engine {\r\n    const value = useContext(Engine.Context);\r\n\r\n    if (!value) {\r\n      throw new Error('Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.');\r\n    }\r\n\r\n    return value;\r\n  }\r\n  static InstanceCount = 0;\r\n\r\n  /**\r\n   * Anything run under scope can use `useEngine()` to inject the current engine\r\n   * @param cb\r\n   */\r\n  scope = <TReturn>(cb: () => TReturn) => Engine.Context.scope(this, cb);\r\n\r\n  private _garbageCollector: GarbageCollector;\r\n\r\n  public readonly garbageCollectorConfig: GarbageCollectionOptions | null;\r\n\r\n  /**\r\n   * Current Excalibur version string\r\n   *\r\n   * Useful for plugins or other tools that need to know what features are available\r\n   */\r\n  public readonly version = EX_VERSION;\r\n\r\n  /**\r\n   * Listen to and emit events on the Engine\r\n   */\r\n  public events = new EventEmitter<EngineEvents>();\r\n\r\n  /**\r\n   * Excalibur browser events abstraction used for wiring to native browser events safely\r\n   */\r\n  public browser: BrowserEvents;\r\n\r\n  /**\r\n   * Screen abstraction\r\n   */\r\n  public screen: Screen;\r\n\r\n  /**\r\n   * Scene director, manages all scenes, scene transitions, and loaders in excalibur\r\n   */\r\n  public director: Director<TKnownScenes>;\r\n\r\n  /**\r\n   * Direct access to the engine's canvas element\r\n   */\r\n  public canvas: HTMLCanvasElement;\r\n\r\n  /**\r\n   * Direct access to the ExcaliburGraphicsContext used for drawing things to the screen\r\n   */\r\n  public graphicsContext: ExcaliburGraphicsContext;\r\n\r\n  /**\r\n   * Direct access to the canvas element ID, if an ID exists\r\n   */\r\n  public canvasElementId: string;\r\n\r\n  /**\r\n   * Direct access to the physics configuration for excalibur\r\n   */\r\n  public physics: DeepRequired<PhysicsConfig>;\r\n\r\n  /**\r\n   * Optionally set the maximum fps if not set Excalibur will go as fast as the device allows.\r\n   *\r\n   * You may want to constrain max fps if your game cannot maintain fps consistently, it can look and feel better to have a 30fps game than\r\n   * one that bounces between 30fps and 60fps\r\n   */\r\n  public maxFps: number = Number.POSITIVE_INFINITY;\r\n\r\n  /**\r\n   * Optionally configure a fixed update fps, this can be desirable if you need the physics simulation to be very stable. When set\r\n   * the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   *\r\n   * **WARN:** `fixedUpdateTimestep` takes precedence over `fixedUpdateFps` use whichever is most convenient.\r\n   */\r\n  public readonly fixedUpdateFps?: number;\r\n\r\n  /**\r\n   * Optionally configure a fixed update timestep in milliseconds, this can be desirable if you need the physics simulation to be very stable. When\r\n   * set the update step and physics will use the same elapsed time for each tick even if the graphical framerate drops. In order for the\r\n   * simulation to be correct, excalibur will run multiple updates in a row (at the configured update elapsed) to catch up, for example\r\n   * there could be X updates and 1 draw each clock step.\r\n   *\r\n   * **NOTE:** This does come at a potential perf cost because each catch-up update will need to be run if the fixed rate is greater than\r\n   * the current instantaneous framerate, or perf gain if the fixed rate is less than the current framerate.\r\n   *\r\n   * By default is unset and updates will use the current instantaneous framerate with 1 update and 1 draw each clock step.\r\n   *\r\n   * **WARN:** `fixedUpdateTimestep` takes precedence over `fixedUpdateFps` use whichever is most convenient.\r\n   */\r\n  public readonly fixedUpdateTimestep?: number;\r\n\r\n  /**\r\n   * Direct access to the excalibur clock\r\n   */\r\n  public clock: Clock;\r\n\r\n  public readonly pointerScope: PointerScope;\r\n  public readonly grabWindowFocus: boolean;\r\n\r\n  /**\r\n   * The width of the game canvas in pixels (physical width component of the\r\n   * resolution of the canvas element)\r\n   */\r\n  public get canvasWidth(): number {\r\n    return this.screen.canvasWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns half width of the game canvas in pixels (half physical width component)\r\n   */\r\n  public get halfCanvasWidth(): number {\r\n    return this.screen.halfCanvasWidth;\r\n  }\r\n\r\n  /**\r\n   * The height of the game canvas in pixels, (physical height component of\r\n   * the resolution of the canvas element)\r\n   */\r\n  public get canvasHeight(): number {\r\n    return this.screen.canvasHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns half height of the game canvas in pixels (half physical height component)\r\n   */\r\n  public get halfCanvasHeight(): number {\r\n    return this.screen.halfCanvasHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawWidth(): number {\r\n    return this.screen.drawWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns half the width of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawWidth(): number {\r\n    return this.screen.halfDrawWidth;\r\n  }\r\n\r\n  /**\r\n   * Returns the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get drawHeight(): number {\r\n    return this.screen.drawHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns half the height of the engine's visible drawing surface in pixels including zoom and device pixel ratio.\r\n   */\r\n  public get halfDrawHeight(): number {\r\n    return this.screen.halfDrawHeight;\r\n  }\r\n\r\n  /**\r\n   * Returns whether excalibur detects the current screen to be HiDPI\r\n   */\r\n  public get isHiDpi(): boolean {\r\n    return this.screen.isHiDpi;\r\n  }\r\n\r\n  /**\r\n   * Access engine input like pointer, keyboard, or gamepad\r\n   */\r\n  public input: InputHost;\r\n\r\n  /**\r\n   * Map multiple input sources to specific game actions actions\r\n   */\r\n  public inputMapper: InputMapper;\r\n\r\n  private _inputEnabled: boolean = true;\r\n\r\n  /**\r\n   * Access Excalibur debugging functionality.\r\n   *\r\n   * Useful when you want to debug different aspects of built in engine features like\r\n   *   * Transform\r\n   *   * Graphics\r\n   *   * Colliders\r\n   */\r\n  public debug: DebugConfig;\r\n\r\n  /**\r\n   * Access {@apilink stats} that holds frame statistics.\r\n   */\r\n  public get stats(): DebugStats {\r\n    return this.debug.stats;\r\n  }\r\n\r\n  /**\r\n   * The current {@apilink Scene} being drawn and updated on screen\r\n   */\r\n  public get currentScene(): Scene {\r\n    return this.director.currentScene;\r\n  }\r\n\r\n  /**\r\n   * The current {@apilink Scene} being drawn and updated on screen\r\n   */\r\n  public get currentSceneName(): string {\r\n    return this.director.currentSceneName;\r\n  }\r\n\r\n  /**\r\n   * The default {@apilink Scene} of the game, use {@apilink Engine.goToScene} to transition to different scenes.\r\n   */\r\n  public get rootScene(): Scene {\r\n    return this.director.rootScene;\r\n  }\r\n\r\n  /**\r\n   * Contains all the scenes currently registered with Excalibur\r\n   */\r\n  public get scenes(): { [key: string]: Scene | SceneConstructor | SceneWithOptions } {\r\n    return this.director.scenes;\r\n  }\r\n\r\n  /**\r\n   * Indicates whether the engine is set to fullscreen or not\r\n   */\r\n  public get isFullscreen(): boolean {\r\n    return this.screen.isFullScreen;\r\n  }\r\n\r\n  /**\r\n   * Indicates the current {@apilink DisplayMode} of the engine.\r\n   */\r\n  public get displayMode(): DisplayMode {\r\n    return this.screen.displayMode;\r\n  }\r\n\r\n  private _suppressPlayButton: boolean = false;\r\n  /**\r\n   * Returns the calculated pixel ration for use in rendering\r\n   */\r\n  public get pixelRatio(): number {\r\n    return this.screen.pixelRatio;\r\n  }\r\n\r\n  /**\r\n   * Indicates whether audio should be paused when the game is no longer visible.\r\n   */\r\n  public pauseAudioWhenHidden: boolean = true;\r\n\r\n  /**\r\n   * Indicates whether the engine should draw with debug information\r\n   */\r\n  private _isDebug: boolean = false;\r\n  public get isDebug(): boolean {\r\n    return this._isDebug;\r\n  }\r\n\r\n  /**\r\n   * Sets the background color for the engine.\r\n   */\r\n  public backgroundColor: Color;\r\n\r\n  /**\r\n   * Sets the Transparency for the engine.\r\n   */\r\n  public enableCanvasTransparency: boolean = true;\r\n\r\n  /**\r\n   * Hints the graphics context to truncate fractional world space coordinates\r\n   */\r\n  public get snapToPixel(): boolean {\r\n    return this.graphicsContext.snapToPixel;\r\n  }\r\n\r\n  public set snapToPixel(shouldSnapToPixel: boolean) {\r\n    this.graphicsContext.snapToPixel = shouldSnapToPixel;\r\n  }\r\n\r\n  /**\r\n   * The action to take when a fatal exception is thrown\r\n   */\r\n  public onFatalException = (e: any) => {\r\n    Logger.getInstance().fatal(e, e.stack);\r\n  };\r\n\r\n  /**\r\n   * The mouse wheel scroll prevention mode\r\n   */\r\n  public pageScrollPreventionMode: ScrollPreventionMode;\r\n\r\n  private _logger: Logger;\r\n\r\n  private _toaster: Toaster = new Toaster();\r\n\r\n  // this determines whether excalibur is compatible with your browser\r\n  private _compatible: boolean;\r\n\r\n  private _timescale: number = 1.0;\r\n\r\n  // loading\r\n  private _loader: DefaultLoader;\r\n\r\n  private _isInitialized: boolean = false;\r\n\r\n  public emit<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, event: EngineEvents[TEventName]): void;\r\n  public emit(eventName: string, event?: any): void;\r\n  public emit<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, event?: any): void {\r\n    this.events.emit(eventName, event);\r\n  }\r\n\r\n  public on<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, handler: Handler<EngineEvents[TEventName]>): Subscription;\r\n  public on(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public on<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.on(eventName, handler);\r\n  }\r\n\r\n  public once<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, handler: Handler<EngineEvents[TEventName]>): Subscription;\r\n  public once(eventName: string, handler: Handler<unknown>): Subscription;\r\n  public once<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, handler: Handler<any>): Subscription {\r\n    return this.events.once(eventName, handler);\r\n  }\r\n\r\n  public off<TEventName extends EventKey<EngineEvents>>(eventName: TEventName, handler: Handler<EngineEvents[TEventName]>): void;\r\n  public off(eventName: string, handler: Handler<unknown>): void;\r\n  public off(eventName: string): void;\r\n  public off<TEventName extends EventKey<EngineEvents> | string>(eventName: TEventName, handler?: Handler<any>): void {\r\n    this.events.off(eventName, handler);\r\n  }\r\n\r\n  /**\r\n   * Default {@apilink EngineOptions}\r\n   */\r\n  private static _DEFAULT_ENGINE_OPTIONS: EngineOptions = {\r\n    width: 0,\r\n    height: 0,\r\n    enableCanvasTransparency: true,\r\n    useDrawSorting: true,\r\n    configurePerformanceCanvas2DFallback: {\r\n      allow: false,\r\n      showPlayerMessage: false,\r\n      threshold: { fps: 20, numberOfFrames: 100 }\r\n    },\r\n    canvasElementId: '',\r\n    canvasElement: undefined,\r\n    enableCanvasContextMenu: false,\r\n    snapToPixel: false,\r\n    antialiasing: true,\r\n    pixelArt: false,\r\n    garbageCollection: true,\r\n    powerPreference: 'high-performance',\r\n    pointerScope: PointerScope.Canvas,\r\n    suppressConsoleBootMessage: null,\r\n    suppressMinimumBrowserFeatureDetection: null,\r\n    suppressHiDPIScaling: null,\r\n    suppressPlayButton: null,\r\n    grabWindowFocus: true,\r\n    scrollPreventionMode: ScrollPreventionMode.Canvas,\r\n    backgroundColor: Color.fromHex('#2185d0') // Excalibur blue\r\n  };\r\n\r\n  private _originalOptions: EngineOptions = {};\r\n  public readonly _originalDisplayMode: DisplayMode;\r\n\r\n  /**\r\n   * Creates a new game using the given {@apilink EngineOptions}. By default, if no options are provided,\r\n   * the game will be rendered full screen (taking up all available browser window space).\r\n   * You can customize the game rendering through {@apilink EngineOptions}.\r\n   *\r\n   * Example:\r\n   *\r\n   * ```js\r\n   * var game = new ex.Engine({\r\n   *   width: 0, // the width of the canvas\r\n   *   height: 0, // the height of the canvas\r\n   *   enableCanvasTransparency: true, // the transparencySection of the canvas\r\n   *   canvasElementId: '', // the DOM canvas element ID, if you are providing your own\r\n   *   displayMode: ex.DisplayMode.FullScreen, // the display mode\r\n   *   pointerScope: ex.PointerScope.Document, // the scope of capturing pointer (mouse/touch) events\r\n   *   backgroundColor: ex.Color.fromHex('#2185d0') // background color of the engine\r\n   * });\r\n   *\r\n   * // call game.start, which is a Promise\r\n   * game.start().then(function () {\r\n   *   // ready, set, go!\r\n   * });\r\n   * ```\r\n   */\r\n  constructor(options?: EngineOptions<TKnownScenes>) {\r\n    options = { ...Engine._DEFAULT_ENGINE_OPTIONS, ...options };\r\n    this._originalOptions = options;\r\n\r\n    Flags.freeze();\r\n\r\n    // Initialize browser events facade\r\n    this.browser = new BrowserEvents(window, document);\r\n\r\n    // Check compatibility\r\n    const detector = new Detector();\r\n    if (!options.suppressMinimumBrowserFeatureDetection && !(this._compatible = detector.test())) {\r\n      const message = document.createElement('div');\r\n      message.innerText = 'Sorry, your browser does not support all the features needed for Excalibur';\r\n      document.body.appendChild(message);\r\n\r\n      detector.failedTests.forEach(function (test) {\r\n        const testMessage = document.createElement('div');\r\n        testMessage.innerText = 'Browser feature missing ' + test;\r\n        document.body.appendChild(testMessage);\r\n      });\r\n\r\n      if (options.canvasElementId) {\r\n        const canvas = document.getElementById(options.canvasElementId);\r\n        if (canvas) {\r\n          canvas.parentElement.removeChild(canvas);\r\n        }\r\n      }\r\n\r\n      return;\r\n    } else {\r\n      this._compatible = true;\r\n    }\r\n\r\n    // Use native console API for color fun\r\n    // eslint-disable-next-line no-console\r\n    if (console.log && !options.suppressConsoleBootMessage) {\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        `%cPowered by Excalibur.js (v${EX_VERSION})`,\r\n        'background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;'\r\n      );\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        '\\n\\\r\n      /| ________________\\n\\\r\nO|===|* >________________>\\n\\\r\n      \\\\|'\r\n      );\r\n      // eslint-disable-next-line no-console\r\n      console.log('Visit', 'http://excaliburjs.com', 'for more information');\r\n    }\r\n\r\n    // Suppress play button\r\n    if (options.suppressPlayButton) {\r\n      this._suppressPlayButton = true;\r\n    }\r\n\r\n    this._logger = Logger.getInstance();\r\n\r\n    // If debug is enabled, let's log browser features to the console.\r\n    if (this._logger.defaultLevel === LogLevel.Debug) {\r\n      detector.logBrowserFeatures();\r\n    }\r\n\r\n    this._logger.debug('Building engine...');\r\n    if (options.garbageCollection === true) {\r\n      this.garbageCollectorConfig = {\r\n        ...DefaultGarbageCollectionOptions\r\n      };\r\n    } else if (options.garbageCollection === false) {\r\n      this._logger.warn(\r\n        'WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted'\r\n      );\r\n      this.garbageCollectorConfig = null;\r\n    } else {\r\n      this.garbageCollectorConfig = {\r\n        ...DefaultGarbageCollectionOptions,\r\n        ...options.garbageCollection\r\n      };\r\n    }\r\n    this._garbageCollector = new GarbageCollector({ getTimestamp: Date.now });\r\n\r\n    this.canvasElementId = options.canvasElementId;\r\n\r\n    if (options.canvasElementId) {\r\n      this._logger.debug('Using Canvas element specified: ' + options.canvasElementId);\r\n\r\n      //test for existence of element\r\n      if (document.getElementById(options.canvasElementId) === null) {\r\n        throw new Error('Cannot find existing element in the DOM, please ensure element is created prior to engine creation.');\r\n      }\r\n\r\n      this.canvas = <HTMLCanvasElement>document.getElementById(options.canvasElementId);\r\n    } else if (options.canvasElement) {\r\n      this._logger.debug('Using Canvas element specified:', options.canvasElement);\r\n      this.canvas = options.canvasElement;\r\n    } else {\r\n      this._logger.debug('Using generated canvas element');\r\n      this.canvas = <HTMLCanvasElement>document.createElement('canvas');\r\n    }\r\n\r\n    if (this.canvas && !options.enableCanvasContextMenu) {\r\n      this.canvas.addEventListener('contextmenu', (evt) => {\r\n        evt.preventDefault();\r\n      });\r\n    }\r\n\r\n    let displayMode = options.displayMode ?? DisplayMode.Fixed;\r\n    if ((options.width && options.height) || options.viewport) {\r\n      if (options.displayMode === undefined) {\r\n        displayMode = DisplayMode.Fixed;\r\n      }\r\n      this._logger.debug('Engine viewport is size ' + options.width + ' x ' + options.height);\r\n    } else if (!options.displayMode) {\r\n      this._logger.debug('Engine viewport is fit');\r\n      displayMode = DisplayMode.FitScreen;\r\n    }\r\n\r\n    this.grabWindowFocus = options.grabWindowFocus;\r\n    this.pointerScope = options.pointerScope;\r\n\r\n    this._originalDisplayMode = displayMode;\r\n\r\n    let pixelArtSampler: boolean;\r\n    let uvPadding: number;\r\n    let nativeContextAntialiasing: boolean;\r\n    let canvasImageRendering: 'pixelated' | 'auto';\r\n    let filtering: ImageFiltering;\r\n    let multiSampleAntialiasing: boolean | { samples: number };\r\n    if (typeof options.antialiasing === 'object') {\r\n      ({ pixelArtSampler, nativeContextAntialiasing, multiSampleAntialiasing, filtering, canvasImageRendering } = {\r\n        ...(options.pixelArt ? DefaultPixelArtOptions : DefaultAntialiasOptions),\r\n        ...options.antialiasing\r\n      });\r\n    } else {\r\n      pixelArtSampler = !!options.pixelArt;\r\n      nativeContextAntialiasing = false;\r\n      multiSampleAntialiasing = options.antialiasing;\r\n      canvasImageRendering = options.antialiasing ? 'auto' : 'pixelated';\r\n      filtering = options.antialiasing ? ImageFiltering.Blended : ImageFiltering.Pixel;\r\n    }\r\n\r\n    if (nativeContextAntialiasing && multiSampleAntialiasing) {\r\n      this._logger.warnOnce(\r\n        `Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing` +\r\n          ` at the same time, they are incompatible settings. If you aren\\'t sure use multiSampleAntialiasing`\r\n      );\r\n    }\r\n\r\n    if (options.pixelArt) {\r\n      uvPadding = 0.25;\r\n    }\r\n\r\n    if (!options.antialiasing || filtering === ImageFiltering.Pixel) {\r\n      uvPadding = 0;\r\n    }\r\n\r\n    // Override with any user option, if non default to .25 for pixel art, 0.01 for everything else\r\n    uvPadding = options.uvPadding ?? uvPadding ?? 0.01;\r\n\r\n    // Canvas 2D fallback can be flagged on\r\n    let useCanvasGraphicsContext = Flags.isEnabled('use-canvas-context');\r\n    if (!useCanvasGraphicsContext) {\r\n      // Attempt webgl first\r\n      try {\r\n        this.graphicsContext = new ExcaliburGraphicsContextWebGL({\r\n          canvasElement: this.canvas,\r\n          enableTransparency: this.enableCanvasTransparency,\r\n          pixelArtSampler: pixelArtSampler,\r\n          antialiasing: nativeContextAntialiasing,\r\n          multiSampleAntialiasing: multiSampleAntialiasing,\r\n          uvPadding: uvPadding,\r\n          powerPreference: options.powerPreference,\r\n          backgroundColor: options.backgroundColor,\r\n          snapToPixel: options.snapToPixel,\r\n          useDrawSorting: options.useDrawSorting,\r\n          garbageCollector: this.garbageCollectorConfig\r\n            ? {\r\n                garbageCollector: this._garbageCollector,\r\n                collectionInterval: this.garbageCollectorConfig.textureCollectInterval\r\n              }\r\n            : null,\r\n          handleContextLost: options.handleContextLost ?? this._handleWebGLContextLost,\r\n          handleContextRestored: options.handleContextRestored\r\n        });\r\n      } catch (e) {\r\n        this._logger.warn(\r\n          `Excalibur could not load webgl for some reason (${(e as Error).message}) and loaded a Canvas 2D fallback. ` +\r\n            `Some features of Excalibur will not work in this mode. \\n\\n` +\r\n            'Read more about this issue at https://excaliburjs.com/docs/performance'\r\n        );\r\n        // fallback to canvas in case of failure\r\n        useCanvasGraphicsContext = true;\r\n      }\r\n    }\r\n\r\n    if (useCanvasGraphicsContext) {\r\n      this.graphicsContext = new ExcaliburGraphicsContext2DCanvas({\r\n        canvasElement: this.canvas,\r\n        enableTransparency: this.enableCanvasTransparency,\r\n        antialiasing: nativeContextAntialiasing,\r\n        backgroundColor: options.backgroundColor,\r\n        snapToPixel: options.snapToPixel,\r\n        useDrawSorting: options.useDrawSorting\r\n      });\r\n    }\r\n\r\n    this.screen = new Screen({\r\n      canvas: this.canvas,\r\n      context: this.graphicsContext,\r\n      antialiasing: nativeContextAntialiasing,\r\n      canvasImageRendering: canvasImageRendering,\r\n      browser: this.browser,\r\n      viewport: options.viewport ?? (options.width && options.height ? { width: options.width, height: options.height } : Resolution.SVGA),\r\n      resolution: options.resolution,\r\n      displayMode,\r\n      pixelRatio: options.suppressHiDPIScaling ? 1 : options.pixelRatio ?? null\r\n    });\r\n\r\n    // TODO REMOVE STATIC!!!\r\n    // Set default filtering based on antialiasing\r\n    TextureLoader.filtering = filtering;\r\n\r\n    if (options.backgroundColor) {\r\n      this.backgroundColor = options.backgroundColor.clone();\r\n    }\r\n\r\n    this.maxFps = options.maxFps ?? this.maxFps;\r\n\r\n    this.fixedUpdateTimestep = options.fixedUpdateTimestep ?? this.fixedUpdateTimestep;\r\n    this.fixedUpdateFps = options.fixedUpdateFps ?? this.fixedUpdateFps;\r\n    this.fixedUpdateTimestep = this.fixedUpdateTimestep || 1000 / this.fixedUpdateFps;\r\n\r\n    this.clock = new StandardClock({\r\n      maxFps: this.maxFps,\r\n      tick: this._mainloop.bind(this),\r\n      onFatalException: (e) => this.onFatalException(e)\r\n    });\r\n\r\n    this.enableCanvasTransparency = options.enableCanvasTransparency;\r\n\r\n    if (typeof options.physics === 'boolean') {\r\n      this.physics = {\r\n        ...getDefaultPhysicsConfig(),\r\n        enabled: options.physics\r\n      };\r\n    } else {\r\n      this.physics = {\r\n        ...getDefaultPhysicsConfig()\r\n      };\r\n      mergeDeep(this.physics, options.physics);\r\n    }\r\n\r\n    this.debug = new DebugConfig(this);\r\n\r\n    this.director = new Director(this, options.scenes);\r\n\r\n    this._initialize(options);\r\n\r\n    (window as any).___EXCALIBUR_DEVTOOL = this;\r\n    Engine.InstanceCount++;\r\n  }\r\n\r\n  private _handleWebGLContextLost = (e: Event) => {\r\n    e.preventDefault();\r\n    this.clock.stop();\r\n    this._logger.fatalOnce('WebGL Graphics Lost', e);\r\n    const container = document.createElement('div');\r\n    container.id = 'ex-webgl-graphics-context-lost';\r\n    container.style.position = 'absolute';\r\n    container.style.zIndex = '99';\r\n    container.style.left = '50%';\r\n    container.style.top = '50%';\r\n    container.style.display = 'flex';\r\n    container.style.flexDirection = 'column';\r\n    container.style.transform = 'translate(-50%, -50%)';\r\n    container.style.backgroundColor = 'white';\r\n    container.style.padding = '10px';\r\n    container.style.borderStyle = 'solid 1px';\r\n\r\n    const div = document.createElement('div');\r\n    div.innerHTML = `\r\n      <h1>There was an issue rendering, please refresh the page.</h1>\r\n      <div>\r\n        <p>WebGL Graphics Context Lost</p>\r\n\r\n        <button id=\"ex-webgl-graphics-reload\">Refresh Page</button>\r\n\r\n        <p>There are a few reasons this might happen:</p>\r\n        <ul>\r\n          <li>Two or more pages are placing a high demand on the GPU</li>\r\n          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>\r\n          <li>The computer has multiple GPUs and the user has switched between them</li>\r\n          <li>Graphics driver has crashed or restarted</li>\r\n          <li>Graphics driver was updated</li>\r\n        </ul>\r\n      </div>\r\n    `;\r\n    container.appendChild(div);\r\n    if (this.canvas?.parentElement) {\r\n      this.canvas.parentElement.appendChild(container);\r\n      const button = div.querySelector('#ex-webgl-graphics-reload');\r\n      button?.addEventListener('click', () => location.reload());\r\n    }\r\n  };\r\n\r\n  private _performanceThresholdTriggered = false;\r\n  private _fpsSamples: number[] = [];\r\n  private _monitorPerformanceThresholdAndTriggerFallback() {\r\n    const { allow } = this._originalOptions.configurePerformanceCanvas2DFallback;\r\n    let { threshold, showPlayerMessage } = this._originalOptions.configurePerformanceCanvas2DFallback;\r\n    if (threshold === undefined) {\r\n      threshold = Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold;\r\n    }\r\n    if (showPlayerMessage === undefined) {\r\n      showPlayerMessage = Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage;\r\n    }\r\n    if (!Flags.isEnabled('use-canvas-context') && allow && this.ready && !this._performanceThresholdTriggered) {\r\n      // Calculate Average fps for last X number of frames after start\r\n      if (this._fpsSamples.length === threshold.numberOfFrames) {\r\n        this._fpsSamples.splice(0, 1);\r\n      }\r\n      this._fpsSamples.push(this.clock.fpsSampler.fps);\r\n      let total = 0;\r\n      for (let i = 0; i < this._fpsSamples.length; i++) {\r\n        total += this._fpsSamples[i];\r\n      }\r\n      const average = total / this._fpsSamples.length;\r\n\r\n      if (this._fpsSamples.length === threshold.numberOfFrames) {\r\n        if (average <= threshold.fps) {\r\n          this._performanceThresholdTriggered = true;\r\n          this._logger.warn(\r\n            `Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.\\n` +\r\n              \"this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.\\n\\n\" +\r\n              'If in Chrome:\\n' +\r\n              '  * Visit Settings > Advanced > System, and ensure \"Use Hardware Acceleration\" is checked.\\n' +\r\n              '  * Visit chrome://flags/#ignore-gpu-blocklist and ensure \"Override software rendering list\" is \"enabled\"\\n' +\r\n              'If in Firefox, visit about:config\\n' +\r\n              '  * Ensure webgl.disabled = false\\n' +\r\n              '  * Ensure webgl.force-enabled = true\\n' +\r\n              '  * Ensure layers.acceleration.force-enabled = true\\n\\n' +\r\n              'Read more about this issue at https://excaliburjs.com/docs/performance'\r\n          );\r\n\r\n          if (showPlayerMessage) {\r\n            this._toaster.toast(\r\n              'Excalibur is encountering performance issues. ' +\r\n                \"It's possible that your browser doesn't have hardware acceleration enabled. \" +\r\n                'Visit [LINK] for more information and potential solutions.',\r\n              'https://excaliburjs.com/docs/performance'\r\n            );\r\n          }\r\n          this.useCanvas2DFallback();\r\n          this.emit('fallbackgraphicscontext', this.graphicsContext);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Switches the engine's graphics context to the 2D Canvas.\r\n   * @warning Some features of Excalibur will not work in this mode.\r\n   */\r\n  public useCanvas2DFallback() {\r\n    // Swap out the canvas\r\n    const newCanvas = this.canvas.cloneNode(false) as HTMLCanvasElement;\r\n    this.canvas.parentNode.replaceChild(newCanvas, this.canvas);\r\n    this.canvas = newCanvas;\r\n\r\n    const options = { ...this._originalOptions, antialiasing: this.screen.antialiasing };\r\n    const displayMode = this._originalDisplayMode;\r\n\r\n    // New graphics context\r\n    this.graphicsContext = new ExcaliburGraphicsContext2DCanvas({\r\n      canvasElement: this.canvas,\r\n      enableTransparency: this.enableCanvasTransparency,\r\n      antialiasing: options.antialiasing,\r\n      backgroundColor: options.backgroundColor,\r\n      snapToPixel: options.snapToPixel,\r\n      useDrawSorting: options.useDrawSorting\r\n    });\r\n\r\n    // Reset screen\r\n    if (this.screen) {\r\n      this.screen.dispose();\r\n    }\r\n\r\n    this.screen = new Screen({\r\n      canvas: this.canvas,\r\n      context: this.graphicsContext,\r\n      antialiasing: options.antialiasing ?? true,\r\n      browser: this.browser,\r\n      viewport: options.viewport ?? (options.width && options.height ? { width: options.width, height: options.height } : Resolution.SVGA),\r\n      resolution: options.resolution,\r\n      displayMode,\r\n      pixelRatio: options.suppressHiDPIScaling ? 1 : options.pixelRatio ?? null\r\n    });\r\n    this.screen.setCurrentCamera(this.currentScene.camera);\r\n\r\n    // Reset pointers\r\n    this.input.pointers.detach();\r\n    const pointerTarget = options && options.pointerScope === PointerScope.Document ? document : this.canvas;\r\n    this.input.pointers = this.input.pointers.recreate(pointerTarget, this);\r\n    this.input.pointers.init();\r\n  }\r\n\r\n  private _disposed = false;\r\n  /**\r\n   * Attempts to completely clean up excalibur resources, including removing the canvas from the dom.\r\n   *\r\n   * To start again you will need to new up an Engine.\r\n   */\r\n  public dispose() {\r\n    if (!this._disposed) {\r\n      this._disposed = true;\r\n      this.stop();\r\n      this._garbageCollector.forceCollectAll();\r\n      this.input.toggleEnabled(false);\r\n      this.canvas.parentNode.removeChild(this.canvas);\r\n      this.canvas = null;\r\n      this.screen.dispose();\r\n      this.graphicsContext.dispose();\r\n      this.graphicsContext = null;\r\n      Engine.InstanceCount--;\r\n    }\r\n  }\r\n\r\n  public isDisposed() {\r\n    return this._disposed;\r\n  }\r\n\r\n  /**\r\n   * Returns a BoundingBox of the top left corner of the screen\r\n   * and the bottom right corner of the screen.\r\n   */\r\n  public getWorldBounds() {\r\n    return this.screen.getWorldBounds();\r\n  }\r\n\r\n  /**\r\n   * Gets the current engine timescale factor (default is 1.0 which is 1:1 time)\r\n   */\r\n  public get timescale() {\r\n    return this._timescale;\r\n  }\r\n\r\n  /**\r\n   * Sets the current engine timescale factor. Useful for creating slow-motion effects or fast-forward effects\r\n   * when using time-based movement.\r\n   */\r\n  public set timescale(value: number) {\r\n    if (value < 0) {\r\n      Logger.getInstance().warnOnce('engine.timescale to a value less than 0 are ignored');\r\n      return;\r\n    }\r\n\r\n    this._timescale = value;\r\n  }\r\n\r\n  /**\r\n   * Adds a {@apilink Timer} to the {@apilink currentScene}.\r\n   * @param timer  The timer to add to the {@apilink currentScene}.\r\n   */\r\n  public addTimer(timer: Timer): Timer {\r\n    return this.currentScene.addTimer(timer);\r\n  }\r\n\r\n  /**\r\n   * Removes a {@apilink Timer} from the {@apilink currentScene}.\r\n   * @param timer  The timer to remove to the {@apilink currentScene}.\r\n   */\r\n  public removeTimer(timer: Timer): Timer {\r\n    return this.currentScene.removeTimer(timer);\r\n  }\r\n\r\n  /**\r\n   * Adds a {@apilink Scene} to the engine, think of scenes in Excalibur as you\r\n   * would levels or menus.\r\n   * @param key  The name of the scene, must be unique\r\n   * @param scene The scene to add to the engine\r\n   */\r\n  public addScene<TScene extends string>(key: TScene, scene: Scene | SceneConstructor | SceneWithOptions): Engine<TKnownScenes | TScene> {\r\n    this.director.add(key, scene);\r\n    return this as Engine<TKnownScenes | TScene>;\r\n  }\r\n\r\n  /**\r\n   * Removes a {@apilink Scene} instance from the engine\r\n   * @param scene  The scene to remove\r\n   */\r\n  public removeScene(scene: Scene | SceneConstructor): void;\r\n  /**\r\n   * Removes a scene from the engine by key\r\n   * @param key  The scene key to remove\r\n   */\r\n  public removeScene(key: string): void;\r\n  /**\r\n   * @internal\r\n   */\r\n  public removeScene(entity: any): void {\r\n    this.director.remove(entity);\r\n  }\r\n\r\n  /**\r\n   * Adds a {@apilink Scene} to the engine, think of scenes in Excalibur as you\r\n   * would levels or menus.\r\n   * @param sceneKey  The key of the scene, must be unique\r\n   * @param scene     The scene to add to the engine\r\n   */\r\n  public add(sceneKey: string, scene: Scene | SceneConstructor | SceneWithOptions): void;\r\n  /**\r\n   * Adds a {@apilink Timer} to the {@apilink currentScene}.\r\n   * @param timer  The timer to add to the {@apilink currentScene}.\r\n   */\r\n  public add(timer: Timer): void;\r\n  /**\r\n   * Adds a {@apilink TileMap} to the {@apilink currentScene}, once this is done the TileMap\r\n   * will be drawn and updated.\r\n   */\r\n  public add(tileMap: TileMap): void;\r\n  /**\r\n   * Adds an actor to the {@apilink currentScene} of the game. This is synonymous\r\n   * to calling `engine.currentScene.add(actor)`.\r\n   *\r\n   * Actors can only be drawn if they are a member of a scene, and only\r\n   * the {@apilink currentScene} may be drawn or updated.\r\n   * @param actor  The actor to add to the {@apilink currentScene}\r\n   */\r\n  public add(actor: Actor): void;\r\n\r\n  public add(entity: Entity): void;\r\n\r\n  /**\r\n   * Adds a {@apilink ScreenElement} to the {@apilink currentScene} of the game,\r\n   * ScreenElements do not participate in collisions, instead the\r\n   * remain in the same place on the screen.\r\n   * @param screenElement  The ScreenElement to add to the {@apilink currentScene}\r\n   */\r\n  public add(screenElement: ScreenElement): void;\r\n  public add(entity: any): void {\r\n    if (arguments.length === 2) {\r\n      this.director.add(<string>arguments[0], <Scene | SceneConstructor | SceneWithOptions>arguments[1]);\r\n      return;\r\n    }\r\n    const maybeDeferred = this.director.getDeferredScene();\r\n    if (maybeDeferred instanceof Scene) {\r\n      maybeDeferred.add(entity);\r\n    } else {\r\n      this.currentScene.add(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Removes a scene instance from the engine\r\n   * @param scene  The scene to remove\r\n   */\r\n  public remove(scene: Scene | SceneConstructor): void;\r\n  /**\r\n   * Removes a scene from the engine by key\r\n   * @param sceneKey  The scene to remove\r\n   */\r\n  public remove(sceneKey: string): void;\r\n  /**\r\n   * Removes a {@apilink Timer} from the {@apilink currentScene}.\r\n   * @param timer  The timer to remove to the {@apilink currentScene}.\r\n   */\r\n  public remove(timer: Timer): void;\r\n  /**\r\n   * Removes a {@apilink TileMap} from the {@apilink currentScene}, it will no longer be drawn or updated.\r\n   */\r\n  public remove(tileMap: TileMap): void;\r\n  /**\r\n   * Removes an actor from the {@apilink currentScene} of the game. This is synonymous\r\n   * to calling `engine.currentScene.removeChild(actor)`.\r\n   * Actors that are removed from a scene will no longer be drawn or updated.\r\n   * @param actor  The actor to remove from the {@apilink currentScene}.\r\n   */\r\n  public remove(actor: Actor): void;\r\n  /**\r\n   * Removes a {@apilink ScreenElement} to the scene, it will no longer be drawn or updated\r\n   * @param screenElement  The ScreenElement to remove from the {@apilink currentScene}\r\n   */\r\n  public remove(screenElement: ScreenElement): void;\r\n  public remove(entity: any): void {\r\n    if (entity instanceof Entity) {\r\n      this.currentScene.remove(entity);\r\n    }\r\n\r\n    if (entity instanceof Scene || isSceneConstructor(entity)) {\r\n      this.removeScene(entity);\r\n    }\r\n\r\n    if (typeof entity === 'string') {\r\n      this.removeScene(entity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Changes the current scene with optionally supplied:\r\n   * * Activation data\r\n   * * Transitions\r\n   * * Loaders\r\n   *\r\n   * Example:\r\n   * ```typescript\r\n   * game.goToScene('myScene', {\r\n   *   sceneActivationData: {any: 'thing at all'},\r\n   *   destinationIn: new FadeInOut({duration: 1000, direction: 'in'}),\r\n   *   sourceOut: new FadeInOut({duration: 1000, direction: 'out'}),\r\n   *   loader: MyLoader\r\n   * });\r\n   * ```\r\n   *\r\n   * Scenes are defined in the Engine constructor\r\n   * ```typescript\r\n   * const engine = new ex.Engine({\r\n      scenes: {...}\r\n    });\r\n   * ```\r\n   * Or by adding dynamically\r\n   *\r\n   * ```typescript\r\n   * engine.addScene('myScene', new ex.Scene());\r\n   * ```\r\n   * @param destinationScene\r\n   * @param options\r\n   */\r\n  public async goToScene<TData = undefined>(destinationScene: WithRoot<TKnownScenes>, options?: GoToOptions<TData>): Promise<void> {\r\n    await this.scope(async () => {\r\n      await this.director.goToScene(destinationScene, options);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Transforms the current x, y from screen coordinates to world coordinates\r\n   * @param point  Screen coordinate to convert\r\n   */\r\n  public screenToWorldCoordinates(point: Vector): Vector {\r\n    return this.screen.screenToWorldCoordinates(point);\r\n  }\r\n\r\n  /**\r\n   * Transforms a world coordinate, to a screen coordinate\r\n   * @param point  World coordinate to convert\r\n   */\r\n  public worldToScreenCoordinates(point: Vector): Vector {\r\n    return this.screen.worldToScreenCoordinates(point);\r\n  }\r\n\r\n  /**\r\n   * Initializes the internal canvas, rendering context, display mode, and native event listeners\r\n   */\r\n  private _initialize(options?: EngineOptions) {\r\n    this.pageScrollPreventionMode = options.scrollPreventionMode;\r\n\r\n    // initialize inputs\r\n    const pointerTarget = options && options.pointerScope === PointerScope.Document ? document : this.canvas;\r\n    const grabWindowFocus = this._originalOptions?.grabWindowFocus ?? true;\r\n    this.input = new InputHost({\r\n      pointerTarget,\r\n      grabWindowFocus,\r\n      engine: this\r\n    });\r\n    this.inputMapper = this.input.inputMapper;\r\n\r\n    // Issue #385 make use of the visibility api\r\n    // https://developer.mozilla.org/en-US/docs/Web/Guide/User_experience/Using_the_Page_Visibility_API\r\n\r\n    this.browser.document.on('visibilitychange', () => {\r\n      if (document.visibilityState === 'hidden') {\r\n        this.events.emit('hidden', new HiddenEvent(this));\r\n        this._logger.debug('Window hidden');\r\n      } else if (document.visibilityState === 'visible') {\r\n        this.events.emit('visible', new VisibleEvent(this));\r\n        this._logger.debug('Window visible');\r\n      }\r\n    });\r\n\r\n    if (!this.canvasElementId && !options.canvasElement) {\r\n      document.body.appendChild(this.canvas);\r\n    }\r\n  }\r\n\r\n  public toggleInputEnabled(enabled: boolean) {\r\n    this._inputEnabled = enabled;\r\n    this.input.toggleEnabled(this._inputEnabled);\r\n  }\r\n\r\n  public onInitialize(engine: Engine) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Gets whether the actor is Initialized\r\n   */\r\n  public get isInitialized(): boolean {\r\n    return this._isInitialized;\r\n  }\r\n\r\n  private async _overrideInitialize(engine: Engine) {\r\n    if (!this.isInitialized) {\r\n      await this.director.onInitialize();\r\n      await this.onInitialize(engine);\r\n      this.events.emit('initialize', new InitializeEvent(engine, this));\r\n      this._isInitialized = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Updates the entire state of the game\r\n   * @param elapsed  Number of milliseconds elapsed since the last update.\r\n   */\r\n  private _update(elapsed: number) {\r\n    if (this._isLoading) {\r\n      // suspend updates until loading is finished\r\n      this._loader?.onUpdate(this, elapsed);\r\n      // Update input listeners\r\n      this.input.update();\r\n      return;\r\n    }\r\n\r\n    // Publish preupdate events\r\n    this.clock.__runScheduledCbs('preupdate');\r\n    this._preupdate(elapsed);\r\n\r\n    // process engine level events\r\n    this.currentScene.update(this, elapsed);\r\n\r\n    // Update graphics postprocessors\r\n    this.graphicsContext.updatePostProcessors(elapsed);\r\n\r\n    // Publish update event\r\n    this.clock.__runScheduledCbs('postupdate');\r\n    this._postupdate(elapsed);\r\n\r\n    // Update input listeners\r\n    this.input.update();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _preupdate(elapsed: number) {\r\n    this.emit('preupdate', new PreUpdateEvent(this, elapsed, this));\r\n    this.onPreUpdate(this, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Safe to override method\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public onPreUpdate(engine: Engine, elapsed: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _postupdate(elapsed: number) {\r\n    this.emit('postupdate', new PostUpdateEvent(this, elapsed, this));\r\n    this.onPostUpdate(this, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Safe to override method\r\n   * @param engine The reference to the current game engine\r\n   * @param elapsed  The time elapsed since the last update in milliseconds\r\n   */\r\n  public onPostUpdate(engine: Engine, elapsed: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Draws the entire game\r\n   * @param elapsed  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  private _draw(elapsed: number) {\r\n    // Use scene background color if present, fallback to engine\r\n    this.graphicsContext.backgroundColor = this.currentScene.backgroundColor ?? this.backgroundColor;\r\n    this.graphicsContext.beginDrawLifecycle();\r\n    this.graphicsContext.clear();\r\n    this.clock.__runScheduledCbs('predraw');\r\n    this._predraw(this.graphicsContext, elapsed);\r\n\r\n    // Drawing nothing else while loading\r\n    if (this._isLoading) {\r\n      if (!this._hideLoader) {\r\n        this._loader?.canvas.draw(this.graphicsContext, 0, 0);\r\n        this.clock.__runScheduledCbs('postdraw');\r\n        this.graphicsContext.flush();\r\n        this.graphicsContext.endDrawLifecycle();\r\n      }\r\n      return;\r\n    }\r\n\r\n    this.currentScene.draw(this.graphicsContext, elapsed);\r\n\r\n    this.clock.__runScheduledCbs('postdraw');\r\n    this._postdraw(this.graphicsContext, elapsed);\r\n\r\n    // Flush any pending drawings\r\n    this.graphicsContext.flush();\r\n    this.graphicsContext.endDrawLifecycle();\r\n\r\n    this._checkForScreenShots();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _predraw(ctx: ExcaliburGraphicsContext, elapsed: number) {\r\n    this.emit('predraw', new PreDrawEvent(ctx, elapsed, this));\r\n    this.onPreDraw(ctx, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Safe to override method to hook into pre draw\r\n   * @param ctx {@link ExcaliburGraphicsContext} for drawing\r\n   * @param elapsed  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  public onPreDraw(ctx: ExcaliburGraphicsContext, elapsed: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _postdraw(ctx: ExcaliburGraphicsContext, elapsed: number) {\r\n    this.emit('postdraw', new PostDrawEvent(ctx, elapsed, this));\r\n    this.onPostDraw(ctx, elapsed);\r\n  }\r\n\r\n  /**\r\n   * Safe to override method to hook into pre draw\r\n   * @param ctx {@link ExcaliburGraphicsContext} for drawing\r\n   * @param elapsed  Number of milliseconds elapsed since the last draw.\r\n   */\r\n  public onPostDraw(ctx: ExcaliburGraphicsContext, elapsed: number) {\r\n    // Override me\r\n  }\r\n\r\n  /**\r\n   * Enable or disable Excalibur debugging functionality.\r\n   * @param toggle a value that debug drawing will be changed to\r\n   */\r\n  public showDebug(toggle: boolean): void {\r\n    this._isDebug = toggle;\r\n  }\r\n\r\n  /**\r\n   * Toggle Excalibur debugging functionality.\r\n   */\r\n  public toggleDebug(): boolean {\r\n    this._isDebug = !this._isDebug;\r\n    return this._isDebug;\r\n  }\r\n\r\n  /**\r\n   * Returns true when loading is totally complete and the player has clicked start\r\n   */\r\n  public get loadingComplete() {\r\n    return !this._isLoading;\r\n  }\r\n\r\n  private _isLoading = false;\r\n  private _hideLoader = false;\r\n  private _isReadyFuture = new Future<void>();\r\n  public get ready() {\r\n    return this._isReadyFuture.isCompleted;\r\n  }\r\n  public isReady(): Promise<void> {\r\n    return this._isReadyFuture.promise;\r\n  }\r\n\r\n  /**\r\n   * Starts the internal game loop for Excalibur after loading\r\n   * any provided assets.\r\n   * @param loader  Optional {@apilink Loader} to use to load resources. The default loader is {@apilink Loader},\r\n   * override to provide your own custom loader.\r\n   *\r\n   * Note: start() only resolves AFTER the user has clicked the play button\r\n   */\r\n  public async start(loader?: DefaultLoader): Promise<void>;\r\n  /**\r\n   * Starts the internal game loop for Excalibur after configuring any routes, loaders, or transitions\r\n   * @param startOptions Optional {@apilink StartOptions} to configure the routes for scenes in Excalibur\r\n   *\r\n   * Note: start() only resolves AFTER the user has clicked the play button\r\n   */\r\n  public async start(sceneName: WithRoot<TKnownScenes>, options?: StartOptions): Promise<void>;\r\n  /**\r\n   * Starts the internal game loop after any loader is finished\r\n   * @param loader\r\n   */\r\n  public async start(loader?: DefaultLoader): Promise<void>;\r\n  public async start(sceneNameOrLoader?: WithRoot<TKnownScenes> | DefaultLoader, options?: StartOptions): Promise<void> {\r\n    await this.scope(async () => {\r\n      if (!this._compatible) {\r\n        throw new Error('Excalibur is incompatible with your browser');\r\n      }\r\n      this._isLoading = true;\r\n      let loader: DefaultLoader;\r\n      if (sceneNameOrLoader instanceof DefaultLoader) {\r\n        loader = sceneNameOrLoader;\r\n      } else if (typeof sceneNameOrLoader === 'string') {\r\n        this.director.configureStart(sceneNameOrLoader, options);\r\n        loader = this.director.mainLoader;\r\n      }\r\n\r\n      // Start the excalibur clock which drives the mainloop\r\n      this._logger.debug('Starting game clock...');\r\n      this.browser.resume();\r\n      this.clock.start();\r\n      if (this.garbageCollectorConfig) {\r\n        this._garbageCollector.start();\r\n      }\r\n      this._logger.debug('Game clock started');\r\n\r\n      await this.load(loader ?? new Loader());\r\n\r\n      // Initialize before ready\r\n      await this._overrideInitialize(this);\r\n\r\n      this._isReadyFuture.resolve();\r\n      this.emit('start', new GameStartEvent(this));\r\n      return this._isReadyFuture.promise;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Returns the current frames elapsed milliseconds\r\n   */\r\n  public currentFrameElapsedMs = 0;\r\n\r\n  /**\r\n   * Returns the current frame lag when in fixed update mode\r\n   */\r\n  public currentFrameLagMs = 0;\r\n\r\n  private _lagMs = 0;\r\n  private _mainloop(elapsed: number) {\r\n    this.scope(() => {\r\n      this.emit('preframe', new PreFrameEvent(this, this.stats.prevFrame));\r\n      const elapsedMs = elapsed * this.timescale;\r\n      this.currentFrameElapsedMs = elapsedMs;\r\n\r\n      // reset frame stats (reuse existing instances)\r\n      const frameId = this.stats.prevFrame.id + 1;\r\n      this.stats.currFrame.reset();\r\n      this.stats.currFrame.id = frameId;\r\n      this.stats.currFrame.elapsedMs = elapsedMs;\r\n      this.stats.currFrame.fps = this.clock.fpsSampler.fps;\r\n      GraphicsDiagnostics.clear();\r\n\r\n      const beforeUpdate = this.clock.now();\r\n      const fixedTimestepMs = this.fixedUpdateTimestep;\r\n      if (this.fixedUpdateTimestep) {\r\n        this._lagMs += elapsedMs;\r\n        while (this._lagMs >= fixedTimestepMs) {\r\n          this._update(fixedTimestepMs);\r\n          this._lagMs -= fixedTimestepMs;\r\n        }\r\n      } else {\r\n        this._update(elapsedMs);\r\n      }\r\n      const afterUpdate = this.clock.now();\r\n      this.currentFrameLagMs = this._lagMs;\r\n      this._draw(elapsedMs);\r\n      const afterDraw = this.clock.now();\r\n\r\n      this.stats.currFrame.duration.update = afterUpdate - beforeUpdate;\r\n      this.stats.currFrame.duration.draw = afterDraw - afterUpdate;\r\n      this.stats.currFrame.graphics.drawnImages = GraphicsDiagnostics.DrawnImagesCount;\r\n      this.stats.currFrame.graphics.drawCalls = GraphicsDiagnostics.DrawCallCount;\r\n\r\n      this.emit('postframe', new PostFrameEvent(this, this.stats.currFrame));\r\n      this.stats.prevFrame.reset(this.stats.currFrame);\r\n\r\n      this._monitorPerformanceThresholdAndTriggerFallback();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stops Excalibur's main loop, useful for pausing the game.\r\n   */\r\n  public stop() {\r\n    if (this.clock.isRunning()) {\r\n      this.emit('stop', new GameStopEvent(this));\r\n      this.browser.pause();\r\n      this.clock.stop();\r\n      this._garbageCollector.stop();\r\n      this._logger.debug('Game stopped');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the Engine's running status, Useful for checking whether engine is running or paused.\r\n   */\r\n  public isRunning() {\r\n    return this.clock.isRunning();\r\n  }\r\n\r\n  private _screenShotRequests: { preserveHiDPIResolution: boolean; resolve: (image: HTMLImageElement) => void }[] = [];\r\n  /**\r\n   * Takes a screen shot of the current viewport and returns it as an\r\n   * HTML Image Element.\r\n   * @param preserveHiDPIResolution in the case of HiDPI return the full scaled backing image, by default false\r\n   */\r\n  public screenshot(preserveHiDPIResolution = false): Promise<HTMLImageElement> {\r\n    const screenShotPromise = new Promise<HTMLImageElement>((resolve) => {\r\n      this._screenShotRequests.push({ preserveHiDPIResolution, resolve });\r\n    });\r\n    return screenShotPromise;\r\n  }\r\n\r\n  private _checkForScreenShots() {\r\n    // We must grab the draw buffer before we yield to the browser\r\n    // the draw buffer is cleared after compositing\r\n    // the reason for the asynchrony is setting `preserveDrawingBuffer: true`\r\n    // forces the browser to copy buffers which can have a mass perf impact on mobile\r\n    for (const request of this._screenShotRequests) {\r\n      const finalWidth = request.preserveHiDPIResolution ? this.canvas.width : this.screen.resolution.width;\r\n      const finalHeight = request.preserveHiDPIResolution ? this.canvas.height : this.screen.resolution.height;\r\n      const screenshot = document.createElement('canvas');\r\n      screenshot.width = finalWidth;\r\n      screenshot.height = finalHeight;\r\n      const ctx = screenshot.getContext('2d');\r\n      ctx.imageSmoothingEnabled = this.screen.antialiasing;\r\n      ctx.drawImage(this.canvas, 0, 0, finalWidth, finalHeight);\r\n\r\n      const result = new Image();\r\n      const raw = screenshot.toDataURL('image/png');\r\n      result.onload = () => {\r\n        request.resolve(result);\r\n      };\r\n      result.src = raw;\r\n    }\r\n    // Reset state\r\n    this._screenShotRequests.length = 0;\r\n  }\r\n\r\n  /**\r\n   * Another option available to you to load resources into the game.\r\n   * Immediately after calling this the game will pause and the loading screen\r\n   * will appear.\r\n   * @param loader  Some {@apilink Loadable} such as a {@apilink Loader} collection, {@apilink Sound}, or {@apilink Texture}.\r\n   */\r\n  public async load(loader: DefaultLoader, hideLoader = false): Promise<void> {\r\n    await this.scope(async () => {\r\n      try {\r\n        // early exit if loaded\r\n        if (loader.isLoaded()) {\r\n          return;\r\n        }\r\n        this._loader = loader;\r\n        this._isLoading = true;\r\n        this._hideLoader = hideLoader;\r\n\r\n        if (loader instanceof Loader) {\r\n          loader.suppressPlayButton = loader.suppressPlayButton || this._suppressPlayButton;\r\n        }\r\n        this._loader.onInitialize(this);\r\n\r\n        await loader.load();\r\n      } catch (e) {\r\n        this._logger.error('Error loading resources, things may not behave properly', e);\r\n        await Promise.resolve();\r\n      } finally {\r\n        this._isLoading = false;\r\n        this._hideLoader = false;\r\n        this._loader = null;\r\n      }\r\n    });\r\n  }\r\n}\r\n","/**\r\n * An enum that represents the types of emitter nozzles\r\n */\r\nexport enum EmitterType {\r\n  /**\r\n   * Constant for the circular emitter type\r\n   */\r\n  Circle = 'circle',\r\n  /**\r\n   * Constant for the rectangular emitter type\r\n   */\r\n  Rectangle = 'rectangle'\r\n}\r\n","import { Engine } from './Engine';\r\nimport { Color } from './Color';\r\nimport { vec, Vector } from './Math/vector';\r\nimport { Text } from './Graphics/Text';\r\nimport { GraphicsComponent, SpriteFont } from './Graphics';\r\nimport { Font } from './Graphics/Font';\r\nimport { Actor } from './Actor';\r\nimport { ActorArgs } from './Actor';\r\n\r\n/**\r\n * Option for creating a label\r\n */\r\nexport interface LabelOptions {\r\n  /**\r\n   * Specify the label text\r\n   */\r\n  text?: string;\r\n\r\n  /**\r\n   * Specify a max width for the text in pixels, if specified the text will wrap.\r\n   *\r\n   * **Not supported in SpriteFont**\r\n   */\r\n  maxWidth?: number;\r\n  /**\r\n   * Specify the color of the text (does not apply to SpriteFonts)\r\n   */\r\n  color?: Color;\r\n  x?: number;\r\n  y?: number;\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally specify a sprite font, will take precedence over any other {@apilink Font}\r\n   */\r\n  spriteFont?: SpriteFont;\r\n  /**\r\n   * Specify a custom font\r\n   */\r\n  font?: Font;\r\n}\r\n\r\n/**\r\n * Labels are the way to draw small amounts of text to the screen. They are\r\n * actors and inherit all of the benefits and capabilities.\r\n */\r\nexport class Label extends Actor {\r\n  private _font: Font = new Font();\r\n  private _text: Text = new Text({ text: '', font: this._font });\r\n\r\n  public set maxWidth(width: number | undefined) {\r\n    this._text.maxWidth = width;\r\n  }\r\n\r\n  public get maxWidth(): number | undefined {\r\n    return this._text.maxWidth;\r\n  }\r\n\r\n  public get font(): Font {\r\n    return this._font;\r\n  }\r\n\r\n  public set font(newFont: Font) {\r\n    this._font = newFont;\r\n    this._text.font = newFont;\r\n  }\r\n\r\n  /**\r\n   * The text to draw.\r\n   */\r\n  public get text(): string {\r\n    return this._text.text;\r\n  }\r\n\r\n  public set text(text: string) {\r\n    this._text.text = text;\r\n  }\r\n\r\n  public override get color(): Color {\r\n    return this._text.color;\r\n  }\r\n\r\n  public override set color(color: Color) {\r\n    if (this._text) {\r\n      this._text.color = color;\r\n    }\r\n  }\r\n\r\n  public get opacity(): number {\r\n    return this.graphics.opacity;\r\n  }\r\n\r\n  public set opacity(opacity: number) {\r\n    this.graphics.opacity = opacity;\r\n  }\r\n\r\n  private _spriteFont: SpriteFont;\r\n  /**\r\n   * The {@apilink SpriteFont} to use, if any. Overrides {@apilink Font | `font`} if present.\r\n   */\r\n  public get spriteFont(): SpriteFont {\r\n    return this._spriteFont;\r\n  }\r\n\r\n  public set spriteFont(sf: SpriteFont) {\r\n    if (sf) {\r\n      this._spriteFont = sf;\r\n      this._text.font = this._spriteFont;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build a new label\r\n   * @param options\r\n   */\r\n  constructor(options?: LabelOptions & ActorArgs) {\r\n    super(options);\r\n    const { text, pos, x, y, spriteFont, font, color, maxWidth } = { text: '', ...options };\r\n\r\n    this.pos = pos ?? (x && y ? vec(x, y) : this.pos);\r\n    this.text = text ?? this.text;\r\n    this.font = font ?? this.font;\r\n    this.maxWidth = maxWidth ?? this.maxWidth;\r\n    this.spriteFont = spriteFont ?? this.spriteFont;\r\n    this._text.color = color ?? this.color;\r\n    const gfx = this.get(GraphicsComponent);\r\n    gfx.anchor = Vector.Zero;\r\n    gfx.use(this._text);\r\n  }\r\n\r\n  public _initialize(engine: Engine) {\r\n    super._initialize(engine);\r\n  }\r\n\r\n  /**\r\n   * Returns the width of the text in the label (in pixels);\r\n   */\r\n  public getTextWidth(): number {\r\n    return this._text.width;\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Actor } from '../Actor';\r\nimport { vec } from '../Math/vector';\r\nimport { Random } from '../Math/Random';\r\nimport { CollisionType } from '../Collision/CollisionType';\r\nimport { randomInRange } from '../Math/util';\r\nimport { EmitterType } from './EmitterType';\r\nimport { Particle, ParticleTransform, ParticleEmitterArgs, ParticleConfig } from './Particles';\r\nimport { RentalPool } from '../Util/RentalPool';\r\n\r\n/**\r\n * Using a particle emitter is a great way to create interesting effects\r\n * in your game, like smoke, fire, water, explosions, etc. `ParticleEmitter`\r\n * extend {@apilink Actor} allowing you to use all of the features that come with.\r\n *\r\n * These particles are simulated on the CPU in JavaScript\r\n */\r\nexport class ParticleEmitter extends Actor {\r\n  private _particlesToEmit: number = 0;\r\n\r\n  private _particlePool = new RentalPool(\r\n    () => new Particle({}),\r\n    (p) => p,\r\n    500\r\n  );\r\n\r\n  public numParticles: number = 0;\r\n\r\n  /**\r\n   * Random number generator\r\n   */\r\n  public random: Random;\r\n\r\n  /**\r\n   * Gets or sets the isEmitting flag\r\n   */\r\n  public isEmitting: boolean = true;\r\n\r\n  /**\r\n   * Gets or sets the backing deadParticle collection\r\n   */\r\n  public deadParticles: Particle[] = [];\r\n\r\n  /**\r\n   * Gets or sets the emission rate for particles (particles/sec)\r\n   */\r\n  public emitRate: number = 1; //particles/sec\r\n\r\n  /**\r\n   * Gets or sets the emitter type for the particle emitter\r\n   */\r\n  public emitterType: EmitterType = EmitterType.Rectangle;\r\n\r\n  /**\r\n   * Gets or sets the emitter radius, only takes effect when the {@apilink emitterType} is {@apilink EmitterType.Circle}\r\n   */\r\n  public radius: number = 0;\r\n\r\n  public particle: ParticleConfig = {\r\n    /**\r\n     * Gets or sets the life of each particle in milliseconds\r\n     */\r\n    life: 2000,\r\n    transform: ParticleTransform.Global,\r\n    graphic: undefined,\r\n    opacity: 1,\r\n    angularVelocity: 0,\r\n    focus: undefined,\r\n    focusAccel: undefined,\r\n    randomRotation: false\r\n  };\r\n\r\n  /**\r\n   * @param config particle emitter options bag\r\n   */\r\n  constructor(config: ParticleEmitterArgs) {\r\n    super({ width: config.width ?? 0, height: config.height ?? 0 });\r\n\r\n    const { particle, x, y, z, pos, isEmitting, emitRate, emitterType, radius, random } = { ...config };\r\n\r\n    this.particle = { ...this.particle, ...particle };\r\n\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n    this.z = z ?? 0;\r\n    this.isEmitting = isEmitting ?? this.isEmitting;\r\n    this.emitRate = emitRate ?? this.emitRate;\r\n    this.emitterType = emitterType ?? this.emitterType;\r\n    this.radius = radius ?? this.radius;\r\n\r\n    this.body.collisionType = CollisionType.PreventCollision;\r\n\r\n    this.random = random ?? new Random();\r\n  }\r\n\r\n  public removeParticle(particle: Particle) {\r\n    this.deadParticles.push(particle);\r\n  }\r\n\r\n  private _activeParticles: Particle[] = [];\r\n\r\n  /**\r\n   * Causes the emitter to emit particles\r\n   * @param particleCount  Number of particles to emit right now\r\n   */\r\n  public emitParticles(particleCount: number) {\r\n    if (particleCount <= 0) {\r\n      return;\r\n    }\r\n    particleCount = particleCount | 0; // coerce to int\r\n    for (let i = 0; i < particleCount; i++) {\r\n      const p = this._createParticle();\r\n      if (this?.scene?.world) {\r\n        if (this.particle.transform === ParticleTransform.Global) {\r\n          this.scene.world.add(p);\r\n        } else {\r\n          this.addChild(p);\r\n        }\r\n      }\r\n      this._activeParticles.push(p);\r\n    }\r\n  }\r\n\r\n  public clearParticles() {\r\n    for (let i = 0; i < this._activeParticles.length; i++) {\r\n      this.removeParticle(this._activeParticles[i]);\r\n    }\r\n  }\r\n\r\n  // Creates a new particle given the constraints of the emitter\r\n  private _createParticle(): Particle {\r\n    let ranX = 0;\r\n    let ranY = 0;\r\n\r\n    const angle = randomInRange(this.particle.minAngle || 0, this.particle.maxAngle || Math.PI * 2, this.random);\r\n    const vel = randomInRange(this.particle.minSpeed || 0, this.particle.maxSpeed || 0, this.random);\r\n    const size = this.particle.startSize || randomInRange(this.particle.minSize || 5, this.particle.maxSize || 5, this.random);\r\n    const dx = vel * Math.cos(angle);\r\n    const dy = vel * Math.sin(angle);\r\n\r\n    if (this.emitterType === EmitterType.Rectangle) {\r\n      ranX = randomInRange(0, this.width, this.random);\r\n      ranY = randomInRange(0, this.height, this.random);\r\n    } else if (this.emitterType === EmitterType.Circle) {\r\n      const radius = randomInRange(0, this.radius, this.random);\r\n      ranX = radius * Math.cos(angle);\r\n      ranY = radius * Math.sin(angle);\r\n    }\r\n\r\n    const p = this._particlePool.rent();\r\n    p.configure({\r\n      life: this.particle.life,\r\n      opacity: this.particle.opacity,\r\n      beginColor: this.particle.beginColor,\r\n      endColor: this.particle.endColor,\r\n      pos: vec(ranX, ranY),\r\n      vel: vec(dx, dy),\r\n      acc: this.particle.acc,\r\n      angularVelocity: this.particle.angularVelocity,\r\n      startSize: this.particle.startSize,\r\n      endSize: this.particle.endSize,\r\n      size: size,\r\n      graphic: this.particle.graphic,\r\n      fade: this.particle.fade\r\n    });\r\n    p.registerEmitter(this);\r\n    if (this.particle.randomRotation) {\r\n      p.transform.rotation = randomInRange(0, Math.PI * 2, this.random);\r\n    }\r\n    if (this.particle.focus) {\r\n      p.focus = this.particle.focus.add(vec(this.pos.x, this.pos.y));\r\n      p.focusAccel = this.particle.focusAccel;\r\n    }\r\n    return p;\r\n  }\r\n\r\n  public update(engine: Engine, elapsed: number) {\r\n    super.update(engine, elapsed);\r\n\r\n    if (this.isEmitting) {\r\n      this._particlesToEmit += this.emitRate * (elapsed / 1000);\r\n      if (this._particlesToEmit > 1.0) {\r\n        this.emitParticles(Math.floor(this._particlesToEmit));\r\n        this._particlesToEmit = this._particlesToEmit - Math.floor(this._particlesToEmit);\r\n      }\r\n    }\r\n\r\n    // deferred removal\r\n    for (let i = 0; i < this.deadParticles.length; i++) {\r\n      if (this?.scene?.world) {\r\n        this.scene.world.remove(this.deadParticles[i], false);\r\n        this._particlePool.return(this.deadParticles[i]);\r\n      }\r\n      const index = this._activeParticles.indexOf(this.deadParticles[i]);\r\n      if (index > -1) {\r\n        this._activeParticles.splice(index, 1);\r\n      }\r\n    }\r\n    this.deadParticles.length = 0;\r\n  }\r\n}\r\n","/**\r\n * Asserts will throw in `process.env.NODE_ENV === 'development'` builds if the expression evaluates false\r\n */\r\nexport function assert(message: string, expression: () => boolean) {\r\n  if (process.env.NODE_ENV === 'development') {\r\n    if (!expression()) {\r\n      throw new Error(message);\r\n    }\r\n  }\r\n}\r\n","import { randomInRange, TwoPI } from '../Math/util';\r\nimport { ExcaliburGraphicsContextWebGL } from '../Graphics/Context/ExcaliburGraphicsContextWebGL';\r\nimport { GpuParticleEmitter } from './GpuParticleEmitter';\r\nimport { ParticleConfig, ParticleTransform } from './Particles';\r\nimport { Random } from '../Math/Random';\r\nimport { Sprite } from '../Graphics/Sprite';\r\nimport { EmitterType } from './EmitterType';\r\nimport { assert } from '../Util/Assert';\r\nimport { vec } from '../Math/vector';\r\n\r\nexport interface GpuParticleConfig extends ParticleConfig {\r\n  /**\r\n   * Only Sprite graphics are supported in GPU particles at the moment\r\n   */\r\n  graphic?: Sprite;\r\n  /**\r\n   * Set the maximum particles to use for this emitter\r\n   */\r\n  maxParticles?: number;\r\n}\r\n\r\n/**\r\n * Container for the GPU Particle State contains the internal state needed for the GPU\r\n * to render particles and maintain state.\r\n */\r\nexport class GpuParticleRenderer {\r\n  static readonly GPU_MAX_PARTICLES: number = 100_000;\r\n  emitter: GpuParticleEmitter;\r\n  emitRate: number = 1;\r\n  particle: GpuParticleConfig;\r\n\r\n  private _initialized: boolean = false;\r\n  private _vaos: WebGLVertexArrayObject[] = [];\r\n  private _buffers: WebGLBuffer[] = [];\r\n  private _random: Random;\r\n\r\n  private _drawIndex = 0;\r\n  private _currentVao!: WebGLVertexArrayObject;\r\n  private _currentBuffer!: WebGLBuffer;\r\n\r\n  private _numInputFloats = 2 + 2 + 1 + 1 + 1;\r\n  private _particleData: Float32Array;\r\n  private _particleIndex = 0;\r\n  private _uploadIndex: number = 0;\r\n\r\n  private _wrappedLife = 0;\r\n  private _wrappedParticles = 0;\r\n  private _particleLife = 0;\r\n\r\n  constructor(emitter: GpuParticleEmitter, random: Random, options: GpuParticleConfig) {\r\n    this.emitter = emitter;\r\n    this.particle = options;\r\n    this._particleData = new Float32Array(this.emitter.maxParticles * this._numInputFloats);\r\n    this._random = random;\r\n    this._particleLife = this.particle.life ?? 2000;\r\n  }\r\n\r\n  public get isInitialized() {\r\n    return this._initialized;\r\n  }\r\n\r\n  public get maxParticles(): number {\r\n    return this.emitter.maxParticles;\r\n  }\r\n\r\n  initialize(gl: WebGL2RenderingContext, context: ExcaliburGraphicsContextWebGL) {\r\n    if (this._initialized) {\r\n      return;\r\n    }\r\n\r\n    const numParticles = this.emitter.maxParticles;\r\n    const numInputFloats = this._numInputFloats;\r\n    const particleData = this._particleData;\r\n    const bytesPerFloat = 4;\r\n\r\n    const particleDataBuffer1 = gl.createBuffer()!;\r\n    const vao1 = gl.createVertexArray()!;\r\n    gl.bindVertexArray(vao1);\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, particleDataBuffer1);\r\n    gl.bufferData(gl.ARRAY_BUFFER, numParticles * numInputFloats * bytesPerFloat, gl.DYNAMIC_DRAW);\r\n    gl.bufferSubData(gl.ARRAY_BUFFER, 0, particleData);\r\n    let offset = 0;\r\n    // position\r\n    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, numInputFloats * bytesPerFloat, 0);\r\n    offset += bytesPerFloat * 2;\r\n    // velocity\r\n    gl.vertexAttribPointer(1, 2, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 2;\r\n    // rotation\r\n    gl.vertexAttribPointer(2, 1, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 1;\r\n    // angularVelocity\r\n    gl.vertexAttribPointer(3, 1, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 1;\r\n    // life\r\n    gl.vertexAttribPointer(4, 1, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 1;\r\n\r\n    // enable attributes\r\n    gl.enableVertexAttribArray(0);\r\n    gl.enableVertexAttribArray(1);\r\n    gl.enableVertexAttribArray(2);\r\n    gl.enableVertexAttribArray(3);\r\n    gl.enableVertexAttribArray(4);\r\n\r\n    this._vaos.push(vao1);\r\n    this._buffers.push(particleDataBuffer1);\r\n    // Clean up\r\n    gl.bindVertexArray(null);\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\n    const particleDataBuffer2 = gl.createBuffer()!;\r\n    const vao2 = gl.createVertexArray()!;\r\n    gl.bindVertexArray(vao2);\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, particleDataBuffer2);\r\n    gl.bufferData(gl.ARRAY_BUFFER, numParticles * numInputFloats * bytesPerFloat, gl.DYNAMIC_DRAW);\r\n    offset = 0;\r\n    // position\r\n    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, numInputFloats * bytesPerFloat, 0);\r\n    offset += bytesPerFloat * 2;\r\n    // velocity\r\n    gl.vertexAttribPointer(1, 2, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 2;\r\n    // rotation\r\n    gl.vertexAttribPointer(2, 1, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 1;\r\n    // angularVelocity\r\n    gl.vertexAttribPointer(3, 1, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 1;\r\n    // life\r\n    gl.vertexAttribPointer(4, 1, gl.FLOAT, false, numInputFloats * bytesPerFloat, offset);\r\n    offset += bytesPerFloat * 1;\r\n\r\n    // enable attributes\r\n    gl.enableVertexAttribArray(0);\r\n    gl.enableVertexAttribArray(1);\r\n    gl.enableVertexAttribArray(2);\r\n    gl.enableVertexAttribArray(3);\r\n    gl.enableVertexAttribArray(4);\r\n\r\n    this._vaos.push(vao2);\r\n    this._buffers.push(particleDataBuffer2);\r\n\r\n    // Clean up\r\n    gl.bindVertexArray(null);\r\n    gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n\r\n    this._currentVao = this._vaos[this._drawIndex % 2];\r\n    this._currentBuffer = this._buffers[(this._drawIndex + 1) % 2];\r\n\r\n    this._initialized = true;\r\n  }\r\n\r\n  private _clearRequested = false;\r\n  clearParticles() {\r\n    this._particleData.fill(0);\r\n    this._clearRequested = true;\r\n  }\r\n\r\n  private _emitted: [life: number, index: number][] = [];\r\n  emitParticles(particleCount: number) {\r\n    const startIndex = this._particleIndex;\r\n    const maxSize = this.maxParticles * this._numInputFloats;\r\n    const endIndex = particleCount * this._numInputFloats + startIndex;\r\n    let countParticle = 0;\r\n    for (let i = startIndex; i < endIndex; i += this._numInputFloats) {\r\n      const angle = this._random.floating(this.particle.minAngle || 0, this.particle.maxAngle || TwoPI);\r\n      const speedX = this._random.floating(this.particle.minSpeed || 0, this.particle.maxSpeed || 0);\r\n      const speedY = this._random.floating(this.particle.minSpeed || 0, this.particle.maxSpeed || 0);\r\n      const dx = speedX * Math.cos(angle);\r\n      const dy = speedY * Math.sin(angle);\r\n      let ranX: number = 0;\r\n      let ranY: number = 0;\r\n      if (this.emitter.emitterType === EmitterType.Rectangle) {\r\n        ranX = this._random.floating(-0.5, 0.5) * this.emitter.width;\r\n        ranY = this._random.floating(-0.5, 0.5) * this.emitter.height;\r\n      } else {\r\n        const radius = this._random.floating(0, this.emitter.radius);\r\n        ranX = radius * Math.cos(angle);\r\n        ranY = radius * Math.sin(angle);\r\n      }\r\n      const tx = this.emitter.transform.apply(vec(ranX, ranY));\r\n      const data = [\r\n        this.particle.transform === ParticleTransform.Local ? ranX : tx.x,\r\n        this.particle.transform === ParticleTransform.Local ? ranY : tx.y, // pos in world space\r\n        dx,\r\n        dy, // velocity\r\n        this.particle.randomRotation ? randomInRange(0, TwoPI, this._random) : this.particle.rotation || 0, // rotation\r\n        this.particle.angularVelocity || 0, // angular velocity\r\n        this._particleLife // life\r\n      ];\r\n\r\n      countParticle++;\r\n      this._particleData.set(data, i % this._particleData.length);\r\n    }\r\n\r\n    if (endIndex >= maxSize) {\r\n      this._wrappedParticles += (endIndex - maxSize) / this._numInputFloats;\r\n      this._wrappedLife = this._particleLife;\r\n    } else if (this._wrappedLife > 0) {\r\n      this._wrappedParticles += particleCount;\r\n    }\r\n\r\n    this._particleIndex = endIndex % maxSize;\r\n    this._emitted.push([this._particleLife, startIndex]);\r\n  }\r\n\r\n  private _uploadEmitted(gl: WebGL2RenderingContext) {\r\n    // upload index is the index of the previous upload\r\n    // particle index is the current index of modification\r\n    if (this._particleIndex !== this._uploadIndex) {\r\n      // Bind one buffer to ARRAY_BUFFER and the other to TFB\r\n      gl.bindBuffer(gl.ARRAY_BUFFER, this._buffers[(this._drawIndex + 1) % 2]);\r\n      if (this._particleIndex >= this._uploadIndex) {\r\n        gl.bufferSubData(\r\n          gl.ARRAY_BUFFER,\r\n          this._uploadIndex * 4, // dst byte offset 4 bytes per float\r\n          this._particleData,\r\n          this._uploadIndex,\r\n          this._particleIndex - this._uploadIndex\r\n        );\r\n      } else {\r\n        // upload before the wrap\r\n        // prettier-ignore\r\n        gl.bufferSubData(\r\n          gl.ARRAY_BUFFER,\r\n          this._uploadIndex * 4,\r\n          this._particleData,\r\n          this._uploadIndex,\r\n          this._particleData.length - this._uploadIndex\r\n        );\r\n        // upload after the wrap if there are any\r\n        if (this._wrappedParticles) {\r\n          // prettier-ignore\r\n          gl.bufferSubData(\r\n            gl.ARRAY_BUFFER,\r\n            0,\r\n            this._particleData,\r\n            0,\r\n            this._wrappedParticles * this._numInputFloats\r\n          );\r\n        }\r\n        this._wrappedLife = this._particleLife;\r\n      }\r\n      gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n    }\r\n    this._uploadIndex = this._particleIndex % (this.maxParticles * this._numInputFloats);\r\n  }\r\n\r\n  update(elapsed: number) {\r\n    this._particleLife = this.particle.life ?? this._particleLife;\r\n    if (this._wrappedLife > 0) {\r\n      this._wrappedLife -= elapsed;\r\n    } else {\r\n      this._wrappedLife = 0;\r\n      this._wrappedParticles = 0;\r\n    }\r\n    if (!this._emitted.length) {\r\n      return;\r\n    }\r\n    for (let i = this._emitted.length - 1; i >= 0; i--) {\r\n      const particle = this._emitted[i];\r\n      particle[0] -= elapsed;\r\n      const life = particle[0];\r\n      if (life <= 0) {\r\n        this._emitted.splice(i, 1);\r\n      }\r\n    }\r\n\r\n    this._emitted.sort((a, b) => a[0] - b[0]);\r\n  }\r\n\r\n  draw(gl: WebGL2RenderingContext) {\r\n    if (this._initialized) {\r\n      // Emit\r\n      if (this._clearRequested) {\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, this._buffers[(this._drawIndex + 1) % 2]);\r\n        gl.bufferSubData(gl.ARRAY_BUFFER, 0, this._particleData);\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n        this._clearRequested = false;\r\n      } else {\r\n        this._uploadEmitted(gl);\r\n      }\r\n\r\n      // Bind one buffer to ARRAY_BUFFER and the other to transform feedback buffer\r\n      gl.bindVertexArray(this._currentVao);\r\n      gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, this._currentBuffer);\r\n\r\n      // Perform transform feedback (run the simulation) and the draw call all at once\r\n      if (this._wrappedLife && this._emitted[0] && this._emitted[0][1] > 0) {\r\n        const midpoint = this._emitted[0][1] / this._numInputFloats;\r\n        // draw oldest first (maybe make configurable)\r\n        assert(`midpoint greater than 0, actual: ${midpoint}`, () => midpoint > 0);\r\n        assert(`midpoint is less than max, actual: ${midpoint}`, () => midpoint < this.maxParticles);\r\n        gl.bindBufferRange(\r\n          gl.TRANSFORM_FEEDBACK_BUFFER,\r\n          0,\r\n          this._currentBuffer,\r\n          this._emitted[0][1] * 4,\r\n          (this.maxParticles - midpoint) * this._numInputFloats * 4\r\n        );\r\n        gl.beginTransformFeedback(gl.POINTS);\r\n        gl.drawArrays(gl.POINTS, midpoint, this.maxParticles - midpoint);\r\n        gl.endTransformFeedback();\r\n\r\n        // then draw newer particles\r\n        gl.bindBufferRange(gl.TRANSFORM_FEEDBACK_BUFFER, 0, this._currentBuffer, 0, this._emitted[0][1] * 4);\r\n        gl.beginTransformFeedback(gl.POINTS);\r\n        gl.drawArrays(gl.POINTS, 0, midpoint);\r\n        gl.endTransformFeedback();\r\n      } else {\r\n        gl.bindBufferRange(gl.TRANSFORM_FEEDBACK_BUFFER, 0, this._currentBuffer, 0, this._particleData.length * 4);\r\n        gl.beginTransformFeedback(gl.POINTS);\r\n        gl.drawArrays(gl.POINTS, 0, this.maxParticles);\r\n        gl.endTransformFeedback();\r\n      }\r\n\r\n      // Clean up after ourselves to avoid errors.\r\n      gl.bindVertexArray(null);\r\n      gl.bindBufferBase(gl.TRANSFORM_FEEDBACK_BUFFER, 0, null);\r\n\r\n      // flip flop buffers, one will be draw the other simulation\r\n      this._currentVao = this._vaos[this._drawIndex % 2];\r\n      this._currentBuffer = this._buffers[(this._drawIndex + 1) % 2];\r\n      this._drawIndex = (this._drawIndex + 1) % 2;\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Actor } from '../Actor';\r\nimport { EmitterType } from './EmitterType';\r\nimport { ParticleEmitterArgs, ParticleTransform } from './Particles';\r\nimport { GpuParticleConfig, GpuParticleRenderer } from './GpuParticleRenderer';\r\nimport { GraphicsComponent } from '../Graphics/GraphicsComponent';\r\nimport { Random } from '../Math/Random';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { clamp } from '../Math';\r\nimport { ExcaliburGraphicsContextWebGL } from '../Graphics/Context/ExcaliburGraphicsContextWebGL';\r\nimport { ParticleRenderer } from '../Graphics/Context/particle-renderer/particle-renderer';\r\n\r\nexport class GpuParticleEmitter extends Actor {\r\n  public particle: GpuParticleConfig = {\r\n    /**\r\n     * Gets or sets the life of each particle in milliseconds\r\n     */\r\n    life: 2000,\r\n    transform: ParticleTransform.Global,\r\n    graphic: undefined,\r\n    opacity: 1,\r\n    angularVelocity: 0,\r\n    focus: undefined,\r\n    focusAccel: undefined,\r\n    randomRotation: false\r\n  };\r\n\r\n  public graphics = new GraphicsComponent();\r\n  public renderer: GpuParticleRenderer;\r\n  public isEmitting: boolean = false;\r\n  public emitRate: number = 1;\r\n  public emitterType: EmitterType = EmitterType.Rectangle;\r\n  public radius: number = 0;\r\n  public readonly maxParticles: number = 2000;\r\n  random: Random;\r\n\r\n  public get pos() {\r\n    return this.transform.pos;\r\n  }\r\n\r\n  public set pos(pos: Vector) {\r\n    this.transform.pos = pos;\r\n  }\r\n\r\n  public get z() {\r\n    return this.transform.z;\r\n  }\r\n\r\n  public set z(z: number) {\r\n    this.transform.z = z;\r\n  }\r\n\r\n  constructor(config: ParticleEmitterArgs & { maxParticles?: number; particle?: GpuParticleConfig }) {\r\n    super({ name: `GpuParticleEmitter`, width: config.width, height: config.height }); // somewhat goofy way of doing width/height\r\n    this.addComponent(this.graphics, true);\r\n    (this.graphics.onPostDraw as any) = this.draw.bind(this);\r\n\r\n    const { particle, maxParticles, x, y, z, pos, isEmitting, emitRate, emitterType, radius, random } = { ...config };\r\n\r\n    this.maxParticles = clamp(maxParticles ?? this.maxParticles, 0, GpuParticleRenderer.GPU_MAX_PARTICLES);\r\n\r\n    this.pos = pos ?? vec(x ?? 0, y ?? 0);\r\n\r\n    this.z = z ?? 0;\r\n\r\n    this.isEmitting = isEmitting ?? this.isEmitting;\r\n\r\n    this.emitRate = emitRate ?? this.emitRate;\r\n\r\n    this.emitterType = emitterType ?? this.emitterType;\r\n\r\n    this.radius = radius ?? this.radius;\r\n\r\n    this.particle = { ...this.particle, ...particle };\r\n\r\n    this.random = random ?? new Random();\r\n\r\n    this.renderer = new GpuParticleRenderer(this, this.random, this.particle);\r\n  }\r\n\r\n  public _initialize(engine: Engine): void {\r\n    super._initialize(engine);\r\n    const context = engine.graphicsContext as ExcaliburGraphicsContextWebGL;\r\n    this.renderer.initialize(context.__gl, context);\r\n  }\r\n\r\n  private _particlesToEmit = 0;\r\n  public update(engine: Engine, elapsed: number): void {\r\n    super.update(engine, elapsed);\r\n\r\n    if (this.isEmitting) {\r\n      this._particlesToEmit += this.emitRate * (elapsed / 1000);\r\n      if (this._particlesToEmit > 1.0) {\r\n        this.emitParticles(Math.floor(this._particlesToEmit));\r\n        this._particlesToEmit = this._particlesToEmit - Math.floor(this._particlesToEmit);\r\n      }\r\n    }\r\n    this.renderer.update(elapsed);\r\n  }\r\n\r\n  public emitParticles(particleCount: number) {\r\n    if (particleCount <= 0) {\r\n      return;\r\n    }\r\n    this.renderer.emitParticles(particleCount | 0); // coerce to integer\r\n  }\r\n\r\n  public clearParticles() {\r\n    this.renderer.clearParticles();\r\n  }\r\n\r\n  draw(ctx: ExcaliburGraphicsContextWebGL, elapsed: number) {\r\n    ctx.draw<ParticleRenderer>('ex.particle', this.renderer, elapsed);\r\n  }\r\n}\r\n","import { BodyComponent } from '../Collision/BodyComponent';\r\nimport { BoundingBox } from '../Collision/BoundingBox';\r\nimport { ColliderComponent } from '../Collision/ColliderComponent';\r\nimport { Collider } from '../Collision/Colliders/Collider';\r\nimport { CollisionType } from '../Collision/CollisionType';\r\nimport { CompositeCollider } from '../Collision/Colliders/CompositeCollider';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { TransformComponent } from '../EntityComponentSystem/Components/TransformComponent';\r\nimport { Entity, EntityEvents } from '../EntityComponentSystem/Entity';\r\nimport { DebugGraphicsComponent, ExcaliburGraphicsContext, Graphic, GraphicsComponent } from '../Graphics';\r\nimport { IsometricEntityComponent } from './IsometricEntityComponent';\r\nimport { DebugConfig } from '../Debug';\r\nimport { PointerComponent } from '../Input/PointerComponent';\r\nimport { PointerEvent } from '../Input/PointerEvent';\r\nimport { EventEmitter } from '../EventEmitter';\r\nimport { HasNestedPointerEvents, PointerEventsToObjectDispatcher } from '../Input/PointerEventsToObjectDispatcher';\r\nimport { PointerEventReceiver } from '../Input/PointerEventReceiver';\r\n\r\nexport type IsometricTilePointerEvents = {\r\n  pointerup: PointerEvent;\r\n  pointerdown: PointerEvent;\r\n  pointermove: PointerEvent;\r\n  pointercancel: PointerEvent;\r\n  pointerenter: PointerEvent;\r\n  pointerleave: PointerEvent;\r\n};\r\n\r\nexport class IsometricTile extends Entity {\r\n  /**\r\n   * Indicates whether this tile is solid\r\n   */\r\n  public solid: boolean = false;\r\n\r\n  public events = new EventEmitter<EntityEvents & IsometricTilePointerEvents>();\r\n\r\n  private _gfx: GraphicsComponent;\r\n  private _tileBounds = new BoundingBox();\r\n  private _graphics: Graphic[] = [];\r\n  public getGraphics(): readonly Graphic[] {\r\n    return this._graphics;\r\n  }\r\n  /**\r\n   * Tile graphics\r\n   */\r\n  public addGraphic(graphic: Graphic, options?: { offset?: Vector }) {\r\n    this._graphics.push(graphic);\r\n    this._gfx.isVisible = this.map.isVisible;\r\n    this._gfx.opacity = this.map.opacity;\r\n    if (options?.offset) {\r\n      this._gfx.offset = options.offset;\r\n    }\r\n    // TODO detect when this changes on the map and apply to all tiles\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  private _recalculateBounds(): BoundingBox {\r\n    let bounds = this._tileBounds.clone();\r\n    for (const graphic of this._graphics) {\r\n      const offset = vec(\r\n        this.map.graphicsOffset.x - this.map.tileWidth / 2,\r\n        this.map.graphicsOffset.y - (this.map.renderFromTopOfGraphic ? 0 : graphic.height - this.map.tileHeight)\r\n      );\r\n      bounds = bounds.combine(graphic.localBounds.translate(offset));\r\n    }\r\n    return bounds;\r\n  }\r\n\r\n  public removeGraphic(graphic: Graphic) {\r\n    const index = this._graphics.indexOf(graphic);\r\n    if (index > -1) {\r\n      this._graphics.splice(index, 1);\r\n    }\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  public clearGraphics() {\r\n    this._graphics.length = 0;\r\n    this._gfx.isVisible = false;\r\n    this._gfx.localBounds = this._recalculateBounds();\r\n  }\r\n\r\n  /**\r\n   * Tile colliders\r\n   */\r\n  private _colliders: Collider[] = [];\r\n  public getColliders(): readonly Collider[] {\r\n    return this._colliders;\r\n  }\r\n\r\n  /**\r\n   * Adds a collider to the IsometricTile\r\n   *\r\n   * **Note!** the {@apilink Tile.solid} must be set to true for it to act as a \"fixed\" collider\r\n   * @param collider\r\n   */\r\n  public addCollider(collider: Collider) {\r\n    this._colliders.push(collider);\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Removes a collider from the IsometricTile\r\n   * @param collider\r\n   */\r\n  public removeCollider(collider: Collider) {\r\n    const index = this._colliders.indexOf(collider);\r\n    if (index > -1) {\r\n      this._colliders.splice(index, 1);\r\n    }\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Clears all colliders from the IsometricTile\r\n   */\r\n  public clearColliders(): void {\r\n    this._colliders.length = 0;\r\n    this.map.flagCollidersDirty();\r\n  }\r\n\r\n  /**\r\n   * Integer tile x coordinate\r\n   */\r\n  public readonly x: number;\r\n  /**\r\n   * Integer tile y coordinate\r\n   */\r\n  public readonly y: number;\r\n  /**\r\n   * Reference to the {@apilink IsometricMap} this tile is part of\r\n   */\r\n  public readonly map: IsometricMap;\r\n\r\n  private _transform: TransformComponent;\r\n  private _isometricEntityComponent: IsometricEntityComponent;\r\n\r\n  /**\r\n   * Returns the top left corner of the {@apilink IsometricTile} in world space\r\n   */\r\n  public get pos(): Vector {\r\n    return this.map.tileToWorld(vec(this.x, this.y));\r\n  }\r\n\r\n  /**\r\n   * Returns the center of the {@apilink IsometricTile}\r\n   */\r\n  public get center(): Vector {\r\n    return this.pos.add(vec(0, this.map.tileHeight / 2));\r\n  }\r\n\r\n  /**\r\n   * Arbitrary data storage per tile, useful for any game specific data\r\n   */\r\n  public data = new Map<string, any>();\r\n\r\n  /**\r\n   * Construct a new IsometricTile\r\n   * @param x tile coordinate in x (not world position)\r\n   * @param y tile coordinate in y (not world position)\r\n   * @param graphicsOffset offset that tile should be shifted by (default (0, 0))\r\n   * @param map reference to owning IsometricMap\r\n   */\r\n  constructor(x: number, y: number, graphicsOffset: Vector | null, map: IsometricMap) {\r\n    super([\r\n      new TransformComponent(),\r\n      new GraphicsComponent({\r\n        offset: graphicsOffset ?? Vector.Zero,\r\n        onPostDraw: (gfx, elapsed) => this.draw(gfx, elapsed)\r\n      }),\r\n      new IsometricEntityComponent(map)\r\n    ]);\r\n    this.x = x;\r\n    this.y = y;\r\n    this.map = map;\r\n    this._transform = this.get(TransformComponent);\r\n    this._isometricEntityComponent = this.get(IsometricEntityComponent);\r\n\r\n    const halfTileWidth = this.map.tileWidth / 2;\r\n    const halfTileHeight = this.map.tileHeight / 2;\r\n    // See https://clintbellanger.net/articles/isometric_math/ for formula\r\n    // The x position shifts left with every y step\r\n    const xPos = (this.x - this.y) * halfTileWidth;\r\n    // The y position needs to go down with every x step\r\n    const yPos = (this.x + this.y) * halfTileHeight;\r\n    this._transform.pos = vec(xPos, yPos);\r\n    this._isometricEntityComponent.elevation = map.elevation;\r\n\r\n    this._gfx = this.get(GraphicsComponent);\r\n    this._gfx.isVisible = false; // start not visible\r\n    const totalWidth = this.map.tileWidth;\r\n    const totalHeight = this.map.tileHeight;\r\n\r\n    // initial guess at gfx bounds based on the tile\r\n    const offset = vec(0, this.map.renderFromTopOfGraphic ? totalHeight : 0);\r\n    this._gfx.localBounds = this._tileBounds = new BoundingBox({\r\n      left: -totalWidth / 2,\r\n      top: -totalHeight,\r\n      right: totalWidth / 2,\r\n      bottom: totalHeight\r\n    }).translate(offset);\r\n  }\r\n\r\n  draw(gfx: ExcaliburGraphicsContext, _elapsed: number) {\r\n    const halfTileWidth = this.map.tileWidth / 2;\r\n    gfx.save();\r\n    // shift left origin to corner of map, not the left corner of the first sprite\r\n    gfx.translate(-halfTileWidth, 0);\r\n    for (const graphic of this._graphics) {\r\n      graphic.draw(\r\n        gfx,\r\n        this.map.graphicsOffset.x,\r\n        this.map.graphicsOffset.y - (this.map.renderFromTopOfGraphic ? 0 : graphic.height - this.map.tileHeight)\r\n      );\r\n    }\r\n    gfx.restore();\r\n  }\r\n}\r\n\r\nexport interface IsometricMapOptions {\r\n  /**\r\n   * Optionally name the isometric tile map\r\n   */\r\n  name?: string;\r\n  /**\r\n   * Optionally specify the position of the isometric tile map\r\n   */\r\n  pos?: Vector;\r\n  /**\r\n   * Optionally render from the top of the graphic, by default tiles are rendered from the bottom\r\n   */\r\n  renderFromTopOfGraphic?: boolean;\r\n  /**\r\n   * Optionally present a graphics offset, this can be useful depending on your tile graphics\r\n   */\r\n  graphicsOffset?: Vector;\r\n  /**\r\n   * Width of an individual tile in pixels, this should be the width of the parallelogram of the base of the tile art asset.\r\n   */\r\n  tileWidth: number;\r\n  /**\r\n   * Height of an individual tile in pixels, this should be the height of the parallelogram of the base of the tile art asset.\r\n   */\r\n  tileHeight: number;\r\n  /**\r\n   * The number of tile columns, or the number of tiles wide\r\n   */\r\n  columns: number;\r\n  /**\r\n   * The number of tile  rows, or the number of tiles high\r\n   */\r\n  rows: number;\r\n\r\n  elevation?: number;\r\n}\r\n\r\n/**\r\n * The IsometricMap is a special tile map that provides isometric rendering support to Excalibur\r\n *\r\n * The tileWidth and tileHeight should be the height and width in pixels of the parallelogram of the base of the tile art asset.\r\n * The tileWidth and tileHeight is not necessarily the same as your graphic pixel width and height.\r\n *\r\n * Please refer to the docs https://excaliburjs.com for more details calculating what your tile width and height should be given\r\n * your art assets.\r\n */\r\nexport class IsometricMap extends Entity implements HasNestedPointerEvents {\r\n  public readonly elevation: number = 0;\r\n\r\n  /**\r\n   * Width of individual tile in pixels\r\n   */\r\n  public readonly tileWidth: number;\r\n  /**\r\n   * Height of individual tile in pixels\r\n   */\r\n  public readonly tileHeight: number;\r\n  /**\r\n   * Number of tiles wide\r\n   */\r\n  public readonly columns: number;\r\n  /**\r\n   * Number of tiles high\r\n   */\r\n  public readonly rows: number;\r\n  /**\r\n   * List containing all of the tiles in IsometricMap\r\n   */\r\n  public readonly tiles: IsometricTile[];\r\n\r\n  /**\r\n   * Whether tiles should be visible\r\n   * @deprecated use isVisible\r\n   */\r\n  public get visible(): boolean {\r\n    return this.isVisible;\r\n  }\r\n\r\n  /**\r\n   * Whether tiles should be visible\r\n   * @deprecated use isVisible\r\n   */\r\n  public set visible(val: boolean) {\r\n    this.isVisible = val;\r\n  }\r\n\r\n  /**\r\n   * Whether tiles should be visible\r\n   */\r\n  public isVisible = true;\r\n\r\n  /**\r\n   * Opacity of tiles\r\n   */\r\n  public opacity = 1.0;\r\n\r\n  /**\r\n   * Render the tile graphic from the top instead of the bottom\r\n   *\r\n   * default is `false` meaning rendering from the bottom\r\n   */\r\n  public renderFromTopOfGraphic: boolean = false;\r\n  public graphicsOffset: Vector = vec(0, 0);\r\n\r\n  /**\r\n   * Isometric map {@apilink TransformComponent}\r\n   */\r\n  public transform: TransformComponent;\r\n\r\n  /**\r\n   * Isometric map {@apilink ColliderComponent}\r\n   */\r\n  public collider: ColliderComponent;\r\n\r\n  public pointer: PointerComponent;\r\n\r\n  private _composite!: CompositeCollider;\r\n  private _pointerEventDispatcher: PointerEventsToObjectDispatcher<IsometricTile>;\r\n\r\n  constructor(options: IsometricMapOptions) {\r\n    super(\r\n      [\r\n        new TransformComponent(),\r\n        new BodyComponent({\r\n          type: CollisionType.Fixed\r\n        }),\r\n        new ColliderComponent(),\r\n        new PointerComponent(),\r\n        new DebugGraphicsComponent((ctx, debugFlags) => this.debug(ctx, debugFlags), false)\r\n      ],\r\n      options.name\r\n    );\r\n    const { pos, tileWidth, tileHeight, columns: width, rows: height, renderFromTopOfGraphic, graphicsOffset, elevation } = options;\r\n\r\n    this.transform = this.get(TransformComponent);\r\n    if (pos) {\r\n      this.transform.pos = pos;\r\n    }\r\n\r\n    this.collider = this.get(ColliderComponent);\r\n    if (this.collider) {\r\n      this.collider.set((this._composite = new CompositeCollider([])));\r\n    }\r\n\r\n    this.pointer = this.get(PointerComponent);\r\n\r\n    this.renderFromTopOfGraphic = renderFromTopOfGraphic ?? this.renderFromTopOfGraphic;\r\n    this.graphicsOffset = graphicsOffset ?? this.graphicsOffset;\r\n\r\n    this.elevation = elevation ?? this.elevation;\r\n    this.tileWidth = tileWidth;\r\n    this.tileHeight = tileHeight;\r\n    this.columns = width;\r\n    this.rows = height;\r\n\r\n    this._pointerEventDispatcher = new PointerEventsToObjectDispatcher();\r\n\r\n    this.tiles = new Array(width * height);\r\n\r\n    // build up tile representation\r\n    for (let y = 0; y < height; y++) {\r\n      for (let x = 0; x < width; x++) {\r\n        const tile = new IsometricTile(x, y, this.graphicsOffset, this);\r\n        this.tiles[x + y * width] = tile;\r\n        this.addChild(tile);\r\n        this._pointerEventDispatcher.addObject(\r\n          tile,\r\n          (p) => this.getTileByPoint(p.worldPos) === tile,\r\n          () => true\r\n        );\r\n      }\r\n    }\r\n\r\n    this.pointer.localBounds = BoundingBox.fromDimension(\r\n      tileWidth * width * this.transform.scale.x,\r\n      tileHeight * height * this.transform.scale.y,\r\n      vec(0.5, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _processPointerToObject(receiver: PointerEventReceiver) {\r\n    this._pointerEventDispatcher.processPointerToObject(receiver, this.tiles);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  public _dispatchPointerEvents(receiver: PointerEventReceiver) {\r\n    this._pointerEventDispatcher.dispatchEvents(receiver, this.tiles);\r\n  }\r\n\r\n  public update(): void {\r\n    if (this._collidersDirty) {\r\n      this.updateColliders();\r\n      this._collidersDirty = false;\r\n    }\r\n\r\n    this._pointerEventDispatcher.clear();\r\n  }\r\n\r\n  private _collidersDirty = false;\r\n  public flagCollidersDirty() {\r\n    this._collidersDirty = true;\r\n  }\r\n\r\n  private _originalOffsets = new WeakMap<Collider, Vector>();\r\n  private _getOrSetColliderOriginalOffset(collider: Collider): Vector {\r\n    if (!this._originalOffsets.has(collider)) {\r\n      const originalOffset = collider.offset;\r\n      this._originalOffsets.set(collider, originalOffset);\r\n      return originalOffset;\r\n    } else {\r\n      return this._originalOffsets.get(collider) ?? Vector.Zero;\r\n    }\r\n  }\r\n  public updateColliders() {\r\n    this._composite.clearColliders();\r\n    const pos = this.get(TransformComponent).pos;\r\n    for (const tile of this.tiles) {\r\n      if (tile.solid) {\r\n        for (const collider of tile.getColliders()) {\r\n          const originalOffset = this._getOrSetColliderOriginalOffset(collider);\r\n          collider.offset = this.tileToWorld(vec(tile.x, tile.y))\r\n            .sub(pos)\r\n            .add(originalOffset)\r\n            .sub(vec(this.tileWidth / 2, this.tileHeight)); // We need to unshift height based on drawing\r\n          collider.owner = this;\r\n          this._composite.addCollider(collider);\r\n        }\r\n      }\r\n    }\r\n    this.collider.update();\r\n  }\r\n\r\n  /**\r\n   * Convert world space coordinates to the tile x, y coordinate\r\n   * @param worldCoordinate\r\n   */\r\n  public worldToTile(worldCoordinate: Vector): Vector {\r\n    // TODO I don't think this handles parent transform see TileMap\r\n    worldCoordinate = worldCoordinate.sub(this.transform.globalPos);\r\n\r\n    const halfTileWidth = this.tileWidth / 2;\r\n    const halfTileHeight = this.tileHeight / 2;\r\n    // See https://clintbellanger.net/articles/isometric_math/ for formula\r\n    return vec(\r\n      ~~((worldCoordinate.x / halfTileWidth + worldCoordinate.y / halfTileHeight) / 2),\r\n      ~~((worldCoordinate.y / halfTileHeight - worldCoordinate.x / halfTileWidth) / 2)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Given a tile coordinate, return the top left corner in world space\r\n   * @param tileCoordinate\r\n   */\r\n  public tileToWorld(tileCoordinate: Vector): Vector {\r\n    const halfTileWidth = this.tileWidth / 2;\r\n    const halfTileHeight = this.tileHeight / 2;\r\n    // The x position shifts left with every y step\r\n    const xPos = (tileCoordinate.x - tileCoordinate.y) * halfTileWidth;\r\n    // The y position needs to go down with every x step\r\n    const yPos = (tileCoordinate.x + tileCoordinate.y) * halfTileHeight;\r\n    return vec(xPos, yPos).add(this.transform.pos);\r\n  }\r\n\r\n  /**\r\n   * Returns the {@apilink IsometricTile} by its x and y coordinates\r\n   */\r\n  public getTile(x: number, y: number): IsometricTile | null {\r\n    if (x < 0 || y < 0 || x >= this.columns || y >= this.rows) {\r\n      return null;\r\n    }\r\n    return this.tiles[x + y * this.columns];\r\n  }\r\n\r\n  /**\r\n   * Returns the {@apilink IsometricTile} by testing a point in world coordinates,\r\n   * returns `null` if no Tile was found.\r\n   */\r\n  public getTileByPoint(point: Vector): IsometricTile | null {\r\n    const tileCoord = this.worldToTile(point);\r\n    const tile = this.getTile(tileCoord.x, tileCoord.y);\r\n    return tile;\r\n  }\r\n\r\n  private _getMaxZIndex(): number {\r\n    let maxZ = Number.NEGATIVE_INFINITY;\r\n    for (const tile of this.tiles) {\r\n      const currentZ = tile.get(TransformComponent).z;\r\n      if (currentZ > maxZ) {\r\n        maxZ = currentZ;\r\n      }\r\n    }\r\n    return maxZ;\r\n  }\r\n\r\n  /**\r\n   * Debug draw for IsometricMap, called internally by excalibur when debug mode is toggled on\r\n   * @param gfx\r\n   */\r\n  public debug(gfx: ExcaliburGraphicsContext, debugFlags: DebugConfig) {\r\n    const { showAll, showPosition, positionColor, positionSize, showGrid, gridColor, gridWidth, showColliderGeometry } =\r\n      debugFlags.isometric;\r\n\r\n    const { geometryColor, geometryLineWidth, geometryPointSize } = debugFlags.collider;\r\n    gfx.save();\r\n    gfx.z = this._getMaxZIndex() + 0.5;\r\n    if (showAll || showGrid) {\r\n      for (let y = 0; y < this.rows + 1; y++) {\r\n        const left = this.tileToWorld(vec(0, y));\r\n        const right = this.tileToWorld(vec(this.columns, y));\r\n        gfx.drawLine(left, right, gridColor, gridWidth);\r\n      }\r\n\r\n      for (let x = 0; x < this.columns + 1; x++) {\r\n        const top = this.tileToWorld(vec(x, 0));\r\n        const bottom = this.tileToWorld(vec(x, this.rows));\r\n        gfx.drawLine(top, bottom, gridColor, gridWidth);\r\n      }\r\n    }\r\n\r\n    if (showAll || showPosition) {\r\n      for (const tile of this.tiles) {\r\n        gfx.drawCircle(this.tileToWorld(vec(tile.x, tile.y)), positionSize, positionColor);\r\n      }\r\n    }\r\n    if (showAll || showColliderGeometry) {\r\n      for (const tile of this.tiles) {\r\n        if (tile.solid) {\r\n          // only draw solid tiles\r\n          for (const collider of tile.getColliders()) {\r\n            collider.debug(gfx, geometryColor, { lineWidth: geometryLineWidth, pointSize: geometryPointSize });\r\n          }\r\n        }\r\n      }\r\n    }\r\n    gfx.restore();\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem';\r\nimport { Action, nextActionId } from '../Action';\r\nimport { ActionContext } from '../ActionContext';\r\nimport { ActionQueue } from '../ActionQueue';\r\n\r\n/**\r\n * Action that can represent a sequence of actions, this can be useful in conjunction with\r\n * {@apilink ParallelActions} to run multiple sequences in parallel.\r\n */\r\nexport class ActionSequence implements Action {\r\n  id = nextActionId();\r\n  private _actionQueue: ActionQueue;\r\n  private _stopped: boolean = false;\r\n  private _sequenceContext: ActionContext;\r\n  private _sequenceBuilder: (actionContext: ActionContext) => any;\r\n  constructor(entity: Entity, actionBuilder: (actionContext: ActionContext) => any) {\r\n    this._sequenceBuilder = actionBuilder;\r\n    this._sequenceContext = new ActionContext(entity);\r\n    this._actionQueue = this._sequenceContext.getQueue();\r\n    this._sequenceBuilder(this._sequenceContext);\r\n  }\r\n\r\n  public update(elapsed: number): void {\r\n    this._actionQueue.update(elapsed);\r\n  }\r\n\r\n  public isComplete(): boolean {\r\n    return this._stopped || this._actionQueue.isComplete();\r\n  }\r\n\r\n  public stop(): void {\r\n    this._stopped = true;\r\n  }\r\n\r\n  public reset(): void {\r\n    this._stopped = false;\r\n    this._actionQueue.reset();\r\n  }\r\n\r\n  public clone(entity: Entity) {\r\n    return new ActionSequence(entity, this._sequenceBuilder);\r\n  }\r\n}\r\n","import { Entity } from '../../EntityComponentSystem';\r\nimport { Action, nextActionId } from '../Action';\r\n\r\n/**\r\n * Action that can run multiple {@apilink Action}s or {@apilink ActionSequence}s at the same time\r\n */\r\nexport class ParallelActions implements Action {\r\n  id = nextActionId();\r\n  private _actions: Action[];\r\n\r\n  constructor(parallelActions: Action[]) {\r\n    this._actions = parallelActions;\r\n  }\r\n\r\n  update(elapsed: number): void {\r\n    for (let i = 0; i < this._actions.length; i++) {\r\n      this._actions[i].update(elapsed);\r\n    }\r\n  }\r\n  isComplete(entity: Entity): boolean {\r\n    return this._actions.every((a) => a.isComplete(entity));\r\n  }\r\n  reset(): void {\r\n    this._actions.forEach((a) => a.reset());\r\n  }\r\n  stop(): void {\r\n    this._actions.forEach((a) => a.stop());\r\n  }\r\n}\r\n","import { Color } from '../../Color';\r\nimport { ExcaliburGraphicsContext } from '../../Graphics';\r\nimport { BoundingBox } from '../BoundingBox';\r\n\r\nexport interface QuadTreeItem {\r\n  bounds: BoundingBox;\r\n}\r\n\r\nexport interface QuadTreeOptions {\r\n  maxDepth?: number;\r\n  capacity: number;\r\n  level?: number;\r\n}\r\n\r\n/**\r\n * QuadTree spatial data structure. Useful for quickly retrieving all objects that might\r\n * be in a specific location.\r\n */\r\nexport class QuadTree<TItem extends QuadTreeItem> {\r\n  private _defaultOptions: QuadTreeOptions = {\r\n    maxDepth: 10,\r\n    capacity: 10,\r\n    level: 0\r\n  };\r\n\r\n  public halfWidth: number;\r\n  public halfHeight: number;\r\n  public items: TItem[] = [];\r\n  private _isDivided = false;\r\n\r\n  public topLeft: QuadTree<TItem> | null = null;\r\n  public topRight: QuadTree<TItem> | null = null;\r\n  public bottomLeft: QuadTree<TItem> | null = null;\r\n  public bottomRight: QuadTree<TItem> | null = null;\r\n\r\n  constructor(\r\n    public bounds: BoundingBox,\r\n    public options?: QuadTreeOptions\r\n  ) {\r\n    this.options = { ...this._defaultOptions, ...options };\r\n    this.halfWidth = bounds.width / 2;\r\n    this.halfHeight = bounds.height / 2;\r\n  }\r\n\r\n  /**\r\n   * Splits the quad tree one level deeper\r\n   */\r\n  private _split() {\r\n    this._isDivided = true;\r\n    const newLevelOptions = {\r\n      maxDepth: this.options.maxDepth,\r\n      capacity: this.options.capacity,\r\n      level: this.options.level + 1\r\n    };\r\n    this.topLeft = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left,\r\n        top: this.bounds.top,\r\n        right: this.bounds.left + this.halfWidth,\r\n        bottom: this.bounds.top + this.halfHeight\r\n      }),\r\n      newLevelOptions\r\n    );\r\n    this.topRight = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left + this.halfWidth,\r\n        top: this.bounds.top,\r\n        right: this.bounds.right,\r\n        bottom: this.bounds.top + this.halfHeight\r\n      }),\r\n      newLevelOptions\r\n    );\r\n    this.bottomLeft = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left,\r\n        top: this.bounds.top + this.halfHeight,\r\n        right: this.bounds.left + this.halfWidth,\r\n        bottom: this.bounds.bottom\r\n      }),\r\n      newLevelOptions\r\n    );\r\n    this.bottomRight = new QuadTree<TItem>(\r\n      new BoundingBox({\r\n        left: this.bounds.left + this.halfWidth,\r\n        top: this.bounds.top + this.halfHeight,\r\n        right: this.bounds.right,\r\n        bottom: this.bounds.bottom\r\n      }),\r\n      newLevelOptions\r\n    );\r\n  }\r\n\r\n  private _insertIntoSubNodes(item: TItem) {\r\n    if (this.topLeft?.bounds.overlaps(item.bounds)) {\r\n      this.topLeft.insert(item);\r\n    }\r\n\r\n    if (this.topRight?.bounds.overlaps(item.bounds)) {\r\n      this.topRight.insert(item);\r\n    }\r\n\r\n    if (this.bottomLeft?.bounds.overlaps(item.bounds)) {\r\n      this.bottomLeft.insert(item);\r\n    }\r\n\r\n    if (this.bottomRight?.bounds.overlaps(item.bounds)) {\r\n      this.bottomRight.insert(item);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Insert an item to be tracked in the QuadTree\r\n   * @param item\r\n   */\r\n  insert(item: TItem): void {\r\n    // add to subnodes if it matches\r\n    if (this._isDivided) {\r\n      this._insertIntoSubNodes(item);\r\n      return;\r\n    }\r\n\r\n    // leaf case\r\n    this.items.push(item);\r\n\r\n    // capacity\r\n    if (this.items.length > this.options.capacity && this.options.level < this.options.maxDepth) {\r\n      if (!this._isDivided) {\r\n        this._split();\r\n      }\r\n      // divide this level's items into it's subnodes\r\n      for (const item of this.items) {\r\n        this._insertIntoSubNodes(item);\r\n      }\r\n      // clear this level\r\n      this.items.length = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a tracked item in the QuadTree\r\n   * @param item\r\n   */\r\n  remove(item: TItem): void {\r\n    if (!this.bounds.overlaps(item.bounds)) {\r\n      return;\r\n    }\r\n\r\n    if (!this._isDivided) {\r\n      const index = this.items.indexOf(item);\r\n      if (index > -1) {\r\n        this.items.splice(index, 1);\r\n      }\r\n      return;\r\n    }\r\n\r\n    if (this.topLeft?.bounds.overlaps(item.bounds)) {\r\n      this.topLeft.remove(item);\r\n    }\r\n\r\n    if (this.topRight?.bounds.overlaps(item.bounds)) {\r\n      this.topRight.remove(item);\r\n    }\r\n\r\n    if (this.bottomLeft?.bounds.overlaps(item.bounds)) {\r\n      this.bottomLeft.remove(item);\r\n    }\r\n\r\n    if (this.bottomRight?.bounds.overlaps(item.bounds)) {\r\n      this.bottomRight.remove(item);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query the structure for all objects that intersect the bounding box\r\n   * @param boundingBox\r\n   * @returns items\r\n   */\r\n  query(boundingBox: BoundingBox): TItem[] {\r\n    let results = this.items;\r\n\r\n    if (this._isDivided) {\r\n      if (this.topLeft.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.topLeft.query(boundingBox));\r\n      }\r\n      if (this.topRight.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.topRight.query(boundingBox));\r\n      }\r\n      if (this.bottomLeft.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.bottomLeft.query(boundingBox));\r\n      }\r\n      if (this.bottomRight.bounds.overlaps(boundingBox)) {\r\n        results = results.concat(this.bottomRight.query(boundingBox));\r\n      }\r\n    }\r\n\r\n    results = results.filter((item, index) => {\r\n      return results.indexOf(item) >= index;\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  clear() {\r\n    this.items = [];\r\n    this._isDivided = false;\r\n\r\n    this.topLeft = null;\r\n    this.topRight = null;\r\n    this.bottomLeft = null;\r\n    this.bottomRight = null;\r\n  }\r\n\r\n  getAllItems(): TItem[] {\r\n    let results = this.items;\r\n\r\n    if (this._isDivided) {\r\n      results = results.concat(this.topLeft.getAllItems());\r\n      results = results.concat(this.topRight.getAllItems());\r\n      results = results.concat(this.bottomLeft.getAllItems());\r\n      results = results.concat(this.bottomRight.getAllItems());\r\n    }\r\n\r\n    results = results.filter((item, index) => {\r\n      return results.indexOf(item) >= index;\r\n    });\r\n\r\n    return results;\r\n  }\r\n\r\n  getTreeDepth(): number {\r\n    if (!this._isDivided) {\r\n      return 0;\r\n    }\r\n\r\n    return (\r\n      1 +\r\n      Math.max(this.topLeft.getTreeDepth(), this.topRight.getTreeDepth(), this.bottomLeft.getTreeDepth(), this.bottomRight.getTreeDepth())\r\n    );\r\n  }\r\n\r\n  debug(ctx: ExcaliburGraphicsContext) {\r\n    this.bounds.draw(ctx, Color.Yellow);\r\n    if (this._isDivided) {\r\n      this.topLeft.bounds.draw(ctx, Color.Yellow);\r\n      this.topRight.bounds.draw(ctx, Color.Yellow);\r\n      this.bottomLeft.bounds.draw(ctx, Color.Yellow);\r\n      this.bottomRight.bounds.draw(ctx, Color.Yellow);\r\n    }\r\n  }\r\n}\r\n","import { Engine } from './../Engine';\r\nimport * as Events from './../Events';\r\nimport { Scene } from '../Scene';\r\nimport { ExcaliburGraphicsContext } from '../Graphics';\r\n\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _initialize {\r\n  _initialize(engine: Engine): void;\r\n}\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _add {\r\n  onAdd(scene: Scene): void;\r\n}\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _remove {\r\n  onRemove(engine: Engine): void;\r\n}\r\n\r\n/**\r\n * Type guard checking for internal initialize method\r\n * @internal\r\n * @param a\r\n */\r\nexport function has_initialize(a: any): a is _initialize {\r\n  return !!a._initialize;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function has_add(a: any): a is _add {\r\n  return !!a.onAdd;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function has_remove(a: any): a is _remove {\r\n  return !!a.onRemove;\r\n}\r\n\r\nexport interface OnInitialize {\r\n  onInitialize(engine: Engine): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnInitialize(a: any): a is OnInitialize {\r\n  return !!a.onInitialize;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _preupdate {\r\n  _preupdate(engine: Engine, elapsed: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function has_preupdate(a: any): a is _preupdate {\r\n  return !!a._preupdate;\r\n}\r\n\r\nexport interface OnPreUpdate {\r\n  onPreUpdate(engine: Engine, elapsed: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnPreUpdate(a: any): a is OnPreUpdate {\r\n  return !!a.onPreUpdate;\r\n}\r\n\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport interface _postupdate {\r\n  _postupdate(engine: Engine, elapsed: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function has_postupdate(a: any): a is _postupdate {\r\n  return !!a.onPostUpdate;\r\n}\r\n\r\nexport interface OnPostUpdate {\r\n  onPostUpdate(engine: Engine, elapsed: number): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnPostUpdate(a: any): a is OnPostUpdate {\r\n  return !!a.onPostUpdate;\r\n}\r\n\r\nexport interface CanInitialize {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onInitialize(engine: Engine): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.initialize, handler: (event: Events.InitializeEvent<any>) => void): void;\r\n  once(eventName: Events.initialize, handler: (event: Events.InitializeEvent<any>) => void): void;\r\n  off(eventName: Events.initialize, handler?: (event: Events.InitializeEvent<any>) => void): void;\r\n}\r\n\r\nexport interface OnAdd {\r\n  onAdd(engine: Engine): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnAdd(a: any): a is OnAdd {\r\n  return !!a.onAdd;\r\n}\r\n\r\nexport interface CanAdd {\r\n  onAdd(engine: Engine): void;\r\n\r\n  on(eventName: Events.add, handler: (event: Events.AddEvent<any>) => void): void;\r\n  once(eventName: Events.add, handler: (event: Events.AddEvent<any>) => void): void;\r\n  off(eventName: Events.add, handler?: (event: Events.AddEvent<any>) => void): void;\r\n}\r\n\r\nexport interface OnRemove {\r\n  onRemove(engine: Engine): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasOnRemove(a: any): a is OnRemove {\r\n  return !!a.onRemove;\r\n}\r\n\r\nexport interface CanRemove {\r\n  onRemove(engine: Engine): void;\r\n\r\n  on(eventName: Events.remove, handler: (event: Events.RemoveEvent<any>) => void): void;\r\n  once(eventName: Events.remove, handler: (event: Events.RemoveEvent<any>) => void): void;\r\n  off(eventName: Events.remove, handler?: (event: Events.RemoveEvent<any>) => void): void;\r\n}\r\n\r\nexport interface SceneActivationContext<TData = undefined> {\r\n  data?: TData;\r\n  previousScene: Scene;\r\n  nextScene: Scene;\r\n  engine: Engine;\r\n}\r\n\r\nexport interface CanActivate<TData = undefined> {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onActivate(context: SceneActivationContext<TData>): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.activate, handler: (event: Events.ActivateEvent) => void): void;\r\n  once(eventName: Events.activate, handler: (event: Events.ActivateEvent) => void): void;\r\n  off(eventName: Events.activate, handler?: (event: Events.ActivateEvent) => void): void;\r\n}\r\n\r\nexport interface CanDeactivate {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onDeactivate(context: SceneActivationContext<never>): void;\r\n\r\n  /**\r\n   * Event signature\r\n   */\r\n  on(eventName: Events.deactivate, handler: (event: Events.DeactivateEvent) => void): void;\r\n  once(eventName: Events.deactivate, handler: (event: Events.DeactivateEvent) => void): void;\r\n  off(eventName: Events.deactivate, handler?: (event: Events.DeactivateEvent) => void): void;\r\n}\r\n\r\nexport interface CanUpdate {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPreUpdate(engine: Engine, elapsed: number): void;\r\n\r\n  /**\r\n   * Event signature\r\n   */\r\n  on(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<any>) => void): void;\r\n  once(eventName: Events.preupdate, handler: (event: Events.PreUpdateEvent<any>) => void): void;\r\n  off(eventName: Events.preupdate, handler?: (event: Events.PreUpdateEvent<any>) => void): void;\r\n\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPostUpdate(engine: Engine, elapsed: number): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<any>) => void): void;\r\n  once(eventName: Events.postupdate, handler: (event: Events.PostUpdateEvent<any>) => void): void;\r\n  off(eventName: Events.postupdate, handler?: (event: Events.PostUpdateEvent<any>) => void): void;\r\n}\r\n\r\nexport interface OnPreDraw {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPreDraw(ctx: ExcaliburGraphicsContext, elapsed: number): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  once(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  off(eventName: Events.predraw, handler?: (event: Events.PreDrawEvent) => void): void;\r\n}\r\n\r\nexport interface OnPostDraw {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPostDraw(ctx: ExcaliburGraphicsContext, elapsed: number): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n  once(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n  off(eventName: Events.postdraw, handler?: (event: Events.PostDrawEvent) => void): void;\r\n}\r\n\r\nexport interface CanDraw extends OnPreDraw, OnPostDraw {\r\n  on(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  on(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n\r\n  once(eventName: Events.predraw, handler: (event: Events.PreDrawEvent) => void): void;\r\n  once(eventName: Events.postdraw, handler: (event: Events.PostDrawEvent) => void): void;\r\n\r\n  off(eventName: Events.predraw, handler?: (event: Events.PreDrawEvent) => void): void;\r\n  off(eventName: Events.postdraw, handler?: (event: Events.PostDrawEvent) => void): void;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasPreDraw(a: any): a is OnPreDraw {\r\n  return !!a.onPreDraw;\r\n}\r\n\r\n/**\r\n *\r\n */\r\nexport function hasPostDraw(a: any): a is OnPostDraw {\r\n  return !!a.onPostDraw;\r\n}\r\n\r\nexport interface CanBeKilled {\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPreKill(_scene: Scene): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\r\n  once(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\r\n  off(eventName: Events.prekill, handler: (event: Events.PreKillEvent) => void): void;\r\n\r\n  /**\r\n   * Overridable implementation\r\n   */\r\n  onPostKill(_scene: Scene): void;\r\n\r\n  /**\r\n   * Event signatures\r\n   */\r\n  on(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\r\n  once(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\r\n  off(eventName: Events.postkill, handler: (event: Events.PostKillEvent) => void): void;\r\n}\r\n","import { Resource } from './Resource';\r\nimport { Sprite } from '../Graphics/Sprite';\r\nimport { SpriteSheet } from '../Graphics/SpriteSheet';\r\nimport { Animation } from '../Graphics/Animation';\r\nimport { Loadable } from '../Interfaces/Index';\r\nimport { ImageSource } from '../Graphics/ImageSource';\r\n/**\r\n * The {@apilink Texture} object allows games built in Excalibur to load image resources.\r\n * {@apilink Texture} is an {@apilink Loadable} which means it can be passed to a {@apilink Loader}\r\n * to pre-load before starting a level or game.\r\n */\r\nexport class Gif implements Loadable<ImageSource[]> {\r\n  private _resource: Resource<ArrayBuffer>;\r\n\r\n  /**\r\n   * The width of the texture in pixels\r\n   */\r\n  public width: number = 0;\r\n\r\n  /**\r\n   * The height of the texture in pixels\r\n   */\r\n  public height: number = 0;\r\n\r\n  private _stream?: Stream;\r\n  private _gif?: GifParser;\r\n  private _images: ImageSource[] = [];\r\n  private _animation?: Animation;\r\n\r\n  public data: ImageSource[] = [];\r\n  private _sprites: Sprite[] = [];\r\n\r\n  /**\r\n   * @param path       Path to the image resource\r\n   * @param bustCache  Optionally load texture with cache busting\r\n   */\r\n  constructor(\r\n    public path: string,\r\n    bustCache = false\r\n  ) {\r\n    this._resource = new Resource(path, 'arraybuffer', bustCache);\r\n  }\r\n\r\n  /**\r\n   * Should excalibur add a cache busting querystring? By default false.\r\n   * Must be set before loading\r\n   */\r\n  public get bustCache() {\r\n    return this._resource.bustCache;\r\n  }\r\n\r\n  public set bustCache(val: boolean) {\r\n    this._resource.bustCache = val;\r\n  }\r\n\r\n  /**\r\n   * Begins loading the texture and returns a promise to be resolved on completion\r\n   */\r\n  public async load(): Promise<ImageSource[]> {\r\n    const arraybuffer = await this._resource.load();\r\n    this._stream = new Stream(arraybuffer);\r\n    this._gif = new GifParser(this._stream);\r\n    const images = this._gif.images.map((i) => new ImageSource(i.src, false));\r\n    // Load all textures\r\n    await Promise.all(images.map((t) => t.load()));\r\n    this.data = this._images = images;\r\n    this._sprites = this._images.map((image) => {\r\n      return image.toSprite();\r\n    });\r\n    return this.data;\r\n  }\r\n\r\n  public isLoaded() {\r\n    return !!this.data;\r\n  }\r\n\r\n  /**\r\n   * Return a frame of the gif as a sprite by id\r\n   * @param id\r\n   */\r\n  public toSprite(id: number = 0): Sprite | null {\r\n    return this._sprites[id] ?? null;\r\n  }\r\n\r\n  /**\r\n   * Return the gif as a spritesheet\r\n   */\r\n  public toSpriteSheet(): SpriteSheet | null {\r\n    const sprites: Sprite[] = this._sprites;\r\n    if (sprites.length) {\r\n      return new SpriteSheet({ sprites });\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Transform the GIF into an animation with duration per frame\r\n   * @param durationPerFrame Optionally override duration per frame\r\n   */\r\n  public toAnimation(durationPerFrame?: number): Animation | null {\r\n    const images = this._gif?.images;\r\n    if (images?.length) {\r\n      const frames = images.map((image, index) => {\r\n        return {\r\n          graphic: this._sprites[index],\r\n          duration: this._gif?.frames[index].delayMs || undefined\r\n        };\r\n      });\r\n      this._animation = new Animation({\r\n        frames,\r\n        frameDuration: durationPerFrame\r\n      });\r\n\r\n      return this._animation;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  public get readCheckBytes(): number[] {\r\n    return this._gif?.checkBytes ?? [];\r\n  }\r\n}\r\n\r\nexport interface GifFrame {\r\n  sentinel: number;\r\n  type: string;\r\n  leftPos: number;\r\n  topPos: number;\r\n  width: number;\r\n  height: number;\r\n  lctFlag: boolean;\r\n  lctBytes: [number, number, number][];\r\n  interlaced: boolean;\r\n  sorted: boolean;\r\n  reserved: boolean[];\r\n  lctSize: number;\r\n  lzwMinCodeSize: number;\r\n  pixels: number[];\r\n  delayTime: number;\r\n  delayMs: number;\r\n}\r\n\r\nconst bitsToNum = (ba: any) => {\r\n  return ba.reduce(function (s: number, n: number) {\r\n    return s * 2 + n;\r\n  }, 0);\r\n};\r\n\r\nconst byteToBitArr = (bite: number) => {\r\n  const a = [];\r\n  for (let i = 7; i >= 0; i--) {\r\n    a.push(!!(bite & (1 << i)));\r\n  }\r\n  return a as [boolean, boolean, boolean, boolean, boolean, boolean, boolean, boolean];\r\n};\r\n\r\nexport class Stream {\r\n  data: Uint8Array;\r\n  len: number = 0;\r\n  position: number = 0;\r\n\r\n  constructor(dataArray: ArrayBuffer) {\r\n    this.data = new Uint8Array(dataArray);\r\n    this.len = this.data.byteLength;\r\n    if (this.len === 0) {\r\n      throw new Error('No data loaded from file');\r\n    }\r\n  }\r\n\r\n  public readByte = () => {\r\n    if (this.position >= this.data.byteLength) {\r\n      throw new Error('Attempted to read past end of stream.');\r\n    }\r\n    return this.data[this.position++];\r\n  };\r\n\r\n  public readBytes = (n: number) => {\r\n    const bytes = [];\r\n    for (let i = 0; i < n; i++) {\r\n      bytes.push(this.readByte());\r\n    }\r\n    return bytes;\r\n  };\r\n\r\n  public read = (n: number) => {\r\n    let s = '';\r\n    for (let i = 0; i < n; i++) {\r\n      s += String.fromCharCode(this.readByte());\r\n    }\r\n    return s;\r\n  };\r\n\r\n  public readUnsigned = () => {\r\n    // Little-endian.\r\n    const a = this.readBytes(2);\r\n    return (a[1] << 8) + a[0];\r\n  };\r\n}\r\n\r\nconst lzwDecode = function (minCodeSize: number, data: any) {\r\n  // TODO: Now that the GIF parser is a bit different, maybe this should get an array of bytes instead of a String?\r\n  let pos = 0; // Maybe this streaming thing should be merged with the Stream?\r\n\r\n  const readCode = function (size: number) {\r\n    let code = 0;\r\n    for (let i = 0; i < size; i++) {\r\n      if (data.charCodeAt(pos >> 3) & (1 << (pos & 7))) {\r\n        code |= 1 << i;\r\n      }\r\n      pos++;\r\n    }\r\n    return code;\r\n  };\r\n\r\n  const output: any[] = [];\r\n\r\n  const clearCode = 1 << minCodeSize;\r\n  const eoiCode = clearCode + 1;\r\n\r\n  let codeSize = minCodeSize + 1;\r\n\r\n  let dict: any[] = [];\r\n\r\n  const clear = function () {\r\n    dict = [];\r\n    codeSize = minCodeSize + 1;\r\n    for (let i = 0; i < clearCode; i++) {\r\n      dict[i] = [i];\r\n    }\r\n    dict[clearCode] = [];\r\n    dict[eoiCode] = null;\r\n  };\r\n\r\n  let code = 0;\r\n  let last = 0;\r\n\r\n  while (true) {\r\n    last = code;\r\n    code = readCode(codeSize);\r\n    if (code === clearCode) {\r\n      clear();\r\n      continue;\r\n    }\r\n    if (code === eoiCode) {\r\n      break;\r\n    }\r\n\r\n    if (code < dict.length) {\r\n      if (last !== clearCode) {\r\n        dict.push(dict[last].concat(dict[code][0]));\r\n      }\r\n    } else {\r\n      if (code !== dict.length) {\r\n        throw new Error('Invalid LZW code.');\r\n      }\r\n      dict.push(dict[last].concat(dict[last][0]));\r\n    }\r\n    output.push.apply(output, dict[code]);\r\n\r\n    if (dict.length === 1 << codeSize && codeSize < 12) {\r\n      // If we're at the last code and codeSize is 12, the next code will be a clearCode, and it'll be 12 bits long.\r\n      codeSize++;\r\n    }\r\n  }\r\n\r\n  // I don't know if this is technically an error, but some GIFs do it.\r\n  //if (Math.ceil(pos / 8) !== data.length) throw new Error('Extraneous LZW bytes.');\r\n  return output;\r\n};\r\n\r\ninterface GifBlock {\r\n  sentinel: number;\r\n  type: string;\r\n}\r\n\r\ninterface GifHeader {\r\n  sig: string;\r\n  ver: string;\r\n  width: number;\r\n  height: number;\r\n  colorResolution: number;\r\n  globalColorTableSize: number;\r\n  gctFlag: boolean;\r\n  sortedFlag: boolean;\r\n  globalColorTable: [number, number, number][];\r\n  backgroundColorIndex: number;\r\n  pixelAspectRatio: number; // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n}\r\n\r\ninterface GCExtBlock extends GifBlock {\r\n  type: 'ext';\r\n  label: number;\r\n  extType: string;\r\n  reserved: boolean[];\r\n  disposalMethod: number;\r\n  userInputFlag: boolean;\r\n  transparentColorFlag: boolean;\r\n  delayTime: number;\r\n  transparentColorIndex: number;\r\n  terminator: number;\r\n}\r\n\r\n/**\r\n * GifParser for binary format\r\n *\r\n * Roughly based on the documentation https://giflib.sourceforge.net/whatsinagif/index.html\r\n */\r\nexport class GifParser {\r\n  private _st: Stream;\r\n  private _handler: any = {};\r\n  public frames: GifFrame[] = [];\r\n  public images: HTMLImageElement[] = [];\r\n  private _currentFrameCanvas: HTMLCanvasElement;\r\n  private _currentFrameContext: CanvasRenderingContext2D;\r\n  public globalColorTableBytes: [number, number, number][] = [];\r\n  public checkBytes: number[] = [];\r\n  private _gce?: GCExtBlock;\r\n  private _hdr?: GifHeader;\r\n\r\n  constructor(stream: Stream) {\r\n    this._st = stream;\r\n    this._handler = {};\r\n    this._currentFrameCanvas = document.createElement('canvas');\r\n    this._currentFrameContext = this._currentFrameCanvas.getContext('2d')!;\r\n    this.parseHeader();\r\n    this.parseBlocks();\r\n  }\r\n\r\n  parseColorTableBytes = (entries: number) => {\r\n    // Each entry is 3 bytes, for RGB.\r\n    const colorTable: [number, number, number][] = [];\r\n    for (let i = 0; i < entries; i++) {\r\n      const rgb = this._st.readBytes(3) as [number, number, number];\r\n      colorTable.push(rgb);\r\n    }\r\n    return colorTable;\r\n  };\r\n\r\n  readSubBlocks = () => {\r\n    let size, data;\r\n    data = '';\r\n    do {\r\n      size = this._st.readByte();\r\n      data += this._st.read(size);\r\n    } while (size !== 0);\r\n    return data;\r\n  };\r\n\r\n  parseHeader = () => {\r\n    const hdr: GifHeader = {\r\n      sig: '',\r\n      ver: '',\r\n      width: 0,\r\n      height: 0,\r\n      colorResolution: 0,\r\n      globalColorTableSize: 0,\r\n      gctFlag: false,\r\n      sortedFlag: false,\r\n      globalColorTable: [],\r\n      backgroundColorIndex: 0,\r\n      pixelAspectRatio: 0 // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n    };\r\n\r\n    hdr.sig = this._st.read(3);\r\n    hdr.ver = this._st.read(3);\r\n    if (hdr.sig !== 'GIF') {\r\n      throw new Error('Not a GIF file.'); // XXX: This should probably be handled more nicely.\r\n    }\r\n\r\n    hdr.width = this._st.readUnsigned();\r\n    hdr.height = this._st.readUnsigned();\r\n\r\n    this._currentFrameCanvas.width = hdr.width;\r\n    this._currentFrameCanvas.height = hdr.height;\r\n\r\n    const bits = byteToBitArr(this._st.readByte());\r\n    hdr.gctFlag = bits.shift()!;\r\n    hdr.colorResolution = bitsToNum(bits.splice(0, 3));\r\n    hdr.sortedFlag = bits.shift()!;\r\n    hdr.globalColorTableSize = bitsToNum(bits.splice(0, 3));\r\n\r\n    hdr.backgroundColorIndex = this._st.readByte();\r\n    hdr.pixelAspectRatio = this._st.readByte(); // if not 0, aspectRatio = (pixelAspectRatio + 15) / 64\r\n\r\n    if (hdr.gctFlag) {\r\n      // hdr.globalColorTable = this.parseColorTable(1 << (hdr.globalColorTableSize + 1));\r\n      this.globalColorTableBytes = this.parseColorTableBytes(1 << (hdr.globalColorTableSize + 1));\r\n    }\r\n    if (this._handler.hdr && this._handler.hdr(hdr)) {\r\n      this.checkBytes.push(this._handler.hdr);\r\n    }\r\n  };\r\n\r\n  parseExt = (block: GCExtBlock) => {\r\n    const parseGCExt = (block: GCExtBlock) => {\r\n      this.checkBytes.push(this._st.readByte()); // Always 4\r\n\r\n      const bits = byteToBitArr(this._st.readByte());\r\n      block.reserved = bits.splice(0, 3); // Reserved; should be 000.\r\n      block.disposalMethod = bitsToNum(bits.splice(0, 3));\r\n      block.userInputFlag = bits.shift()!;\r\n      block.transparentColorFlag = bits.shift()!;\r\n\r\n      block.delayTime = this._st.readUnsigned();\r\n\r\n      block.transparentColorIndex = this._st.readByte();\r\n\r\n      block.terminator = this._st.readByte(); // always 0\r\n\r\n      if (this._handler.gce && this._handler.gce(block)) {\r\n        this.checkBytes.push(this._handler.gce);\r\n      }\r\n      return block;\r\n    };\r\n\r\n    const parseComExt = (block: any) => {\r\n      block.comment = this.readSubBlocks();\r\n      if (this._handler.com && this._handler.com(block)) {\r\n        this.checkBytes.push(this._handler.com);\r\n      }\r\n    };\r\n\r\n    const parsePTExt = (block: any) => {\r\n      this.checkBytes.push(this._st.readByte()); // Always 12\r\n      block.ptHeader = this._st.readBytes(12);\r\n      block.ptData = this.readSubBlocks();\r\n      if (this._handler.pte && this._handler.pte(block)) {\r\n        this.checkBytes.push(this._handler.pte);\r\n      }\r\n    };\r\n\r\n    const parseAppExt = (block: any) => {\r\n      const parseNetscapeExt = (block: any) => {\r\n        this.checkBytes.push(this._st.readByte()); // Always 3\r\n        block.unknown = this._st.readByte(); // Q: Always 1? What is this?\r\n        block.iterations = this._st.readUnsigned();\r\n        block.terminator = this._st.readByte();\r\n        if (this._handler.app && this._handler.app.NETSCAPE && this._handler.app.NETSCAPE(block)) {\r\n          this.checkBytes.push(this._handler.app);\r\n        }\r\n      };\r\n\r\n      const parseUnknownAppExt = (block: any) => {\r\n        block.appData = this.readSubBlocks();\r\n        // FIXME: This won't work if a handler wants to match on any identifier.\r\n        if (this._handler.app && this._handler.app[block.identifier] && this._handler.app[block.identifier](block)) {\r\n          this.checkBytes.push(this._handler.app[block.identifier]);\r\n        }\r\n      };\r\n\r\n      this.checkBytes.push(this._st.readByte()); // Always 11\r\n      block.identifier = this._st.read(8);\r\n      block.authCode = this._st.read(3);\r\n      switch (block.identifier) {\r\n        case 'NETSCAPE':\r\n          parseNetscapeExt(block);\r\n          break;\r\n        default:\r\n          parseUnknownAppExt(block);\r\n          break;\r\n      }\r\n    };\r\n\r\n    const parseUnknownExt = (block: any) => {\r\n      block.data = this.readSubBlocks();\r\n      if (this._handler.unknown && this._handler.unknown(block)) {\r\n        this.checkBytes.push(this._handler.unknown);\r\n      }\r\n    };\r\n\r\n    block.label = this._st.readByte();\r\n    switch (block.label) {\r\n      case 0xf9:\r\n        block.extType = 'gce';\r\n        this._gce = parseGCExt(block);\r\n        break;\r\n      case 0xfe:\r\n        block.extType = 'com';\r\n        parseComExt(block);\r\n        break;\r\n      case 0x01:\r\n        block.extType = 'pte';\r\n        parsePTExt(block);\r\n        break;\r\n      case 0xff:\r\n        block.extType = 'app';\r\n        parseAppExt(block);\r\n        break;\r\n      default:\r\n        block.extType = 'unknown';\r\n        parseUnknownExt(block);\r\n        break;\r\n    }\r\n  };\r\n\r\n  parseImg = (img: GifFrame) => {\r\n    const deinterlace = (pixels: number[], width: number) => {\r\n      // Of course this defeats the purpose of interlacing. And it's *probably*\r\n      // the least efficient way it's ever been implemented. But nevertheless...\r\n\r\n      const newPixels: number[] = new Array(pixels.length);\r\n      const rows = pixels.length / width;\r\n      const cpRow = (toRow: number, fromRow: number) => {\r\n        const fromPixels = pixels.slice(fromRow * width, (fromRow + 1) * width);\r\n        newPixels.splice.apply(newPixels, [toRow * width, width].concat(fromPixels) as any);\r\n      };\r\n\r\n      const offsets = [0, 4, 2, 1];\r\n      const steps = [8, 8, 4, 2];\r\n\r\n      let fromRow = 0;\r\n      for (let pass = 0; pass < 4; pass++) {\r\n        for (let toRow = offsets[pass]; toRow < rows; toRow += steps[pass]) {\r\n          cpRow(toRow, fromRow);\r\n          fromRow++;\r\n        }\r\n      }\r\n\r\n      return newPixels;\r\n    };\r\n\r\n    img.leftPos = this._st.readUnsigned();\r\n    img.topPos = this._st.readUnsigned();\r\n    img.width = this._st.readUnsigned();\r\n    img.height = this._st.readUnsigned();\r\n\r\n    const bits = byteToBitArr(this._st.readByte());\r\n    img.lctFlag = bits.shift()!;\r\n    img.interlaced = bits.shift()!;\r\n    img.sorted = bits.shift()!;\r\n    img.reserved = bits.splice(0, 2);\r\n    img.lctSize = bitsToNum(bits.splice(0, 3));\r\n\r\n    if (img.lctFlag) {\r\n      img.lctBytes = this.parseColorTableBytes(1 << (img.lctSize + 1));\r\n    }\r\n\r\n    img.lzwMinCodeSize = this._st.readByte();\r\n\r\n    const lzwData = this.readSubBlocks();\r\n\r\n    img.pixels = lzwDecode(img.lzwMinCodeSize, lzwData);\r\n\r\n    if (img.interlaced) {\r\n      // Move\r\n      img.pixels = deinterlace(img.pixels, img.width);\r\n    }\r\n\r\n    if (this._gce?.delayTime) {\r\n      img.delayMs = this._gce.delayTime * 10;\r\n    }\r\n\r\n    this.frames.push(img);\r\n    this.arrayToImage(img, img.lctFlag ? img.lctBytes : this.globalColorTableBytes);\r\n    if (this._handler.img && this._handler.img(img)) {\r\n      this.checkBytes.push(this._handler);\r\n    }\r\n  };\r\n\r\n  public parseBlocks = () => {\r\n    const block: GifBlock = {\r\n      sentinel: this._st.readByte(),\r\n      type: ''\r\n    };\r\n    const blockChar = String.fromCharCode(block.sentinel);\r\n    switch (blockChar) {\r\n      case '!':\r\n        block.type = 'ext';\r\n        this.parseExt(block as GCExtBlock);\r\n        break;\r\n      case ',':\r\n        block.type = 'img';\r\n        this.parseImg(block as any);\r\n        break;\r\n      case ';':\r\n        block.type = 'eof';\r\n        if (this._handler.eof && this._handler.eof(block)) {\r\n          this.checkBytes.push(this._handler.eof);\r\n        }\r\n        break;\r\n      default:\r\n        throw new Error('Unknown block: 0x' + block.sentinel.toString(16));\r\n    }\r\n\r\n    if (block.type !== 'eof') {\r\n      this.parseBlocks();\r\n    }\r\n  };\r\n\r\n  arrayToImage = (frame: GifFrame, colorTable: [number, number, number][]) => {\r\n    const canvas = document.createElement('canvas')!;\r\n    canvas.width = frame.width;\r\n    canvas.height = frame.height;\r\n    const context = canvas.getContext('2d')!;\r\n    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);\r\n\r\n    let transparentColorIndex = -1;\r\n    if (this._gce?.transparentColorFlag) {\r\n      transparentColorIndex = this._gce.transparentColorIndex;\r\n    }\r\n\r\n    for (let pixel = 0; pixel < frame.pixels.length; pixel++) {\r\n      const colorIndex = frame.pixels[pixel];\r\n      const color = colorTable[colorIndex];\r\n      if (colorIndex === transparentColorIndex) {\r\n        imageData.data.set([0, 0, 0, 0], pixel * 4);\r\n      } else {\r\n        imageData.data.set([...color, 255], pixel * 4);\r\n      }\r\n    }\r\n    context.putImageData(imageData, 0, 0);\r\n\r\n    // A value of 1 which tells the decoder to leave the image in place and draw the next image on top of it.\r\n    // A value of 2 would have meant that the canvas should be restored to the background color (as indicated by the logical screen descriptor).\r\n    // A value of 3 is defined to mean that the decoder should restore the canvas to its previous state before the current image was drawn.\r\n    // The behavior for values 4-7 are yet to be defined.\r\n    if (this._gce?.disposalMethod === 1 && this.images.length) {\r\n      this._currentFrameContext.drawImage(this.images[this.images.length - 1]!, 0, 0);\r\n    } else if (this._gce?.disposalMethod === 2 && this._hdr?.gctFlag) {\r\n      const bg = colorTable[this._hdr.backgroundColorIndex];\r\n      this._currentFrameContext.fillStyle = `rgb(${bg[0]}, ${bg[1]}, ${bg[2]})`;\r\n      this._currentFrameContext.fillRect(0, 0, this._hdr.width, this._hdr.height);\r\n    } else {\r\n      this._currentFrameContext.clearRect(0, 0, this._currentFrameCanvas.width, this._currentFrameCanvas.height);\r\n    }\r\n\r\n    this._currentFrameContext.drawImage(canvas, frame.leftPos, frame.topPos, frame.width, frame.height);\r\n\r\n    const img = new Image();\r\n    img.src = this._currentFrameCanvas.toDataURL(); // default is png\r\n    this.images.push(img);\r\n  };\r\n}\r\n","import { Font } from '../Graphics/Font';\r\nimport { FontOptions } from '../Graphics/FontCommon';\r\nimport { GraphicOptions, RasterOptions } from '../Graphics';\r\nimport { Loadable } from '../Interfaces/Loadable';\r\nimport { Resource } from './Resource';\r\n\r\nexport interface FontSourceOptions extends Omit<FontOptions, 'family'>, GraphicOptions, RasterOptions {\r\n  /**\r\n   * Whether or not to cache-bust requests\r\n   */\r\n  bustCache?: boolean;\r\n}\r\n\r\nexport class FontSource implements Loadable<FontFace> {\r\n  private _resource: Resource<Blob>;\r\n  private _isLoaded = false;\r\n  private _options: FontSourceOptions;\r\n\r\n  data!: FontFace;\r\n\r\n  constructor(\r\n    /**\r\n     * Path to the font resource relative from the HTML document hosting the game, or absolute\r\n     */\r\n    public readonly path: string,\r\n    /**\r\n     * The font family name\r\n     */\r\n    public readonly family: string,\r\n    { bustCache, ...options }: FontSourceOptions = {}\r\n  ) {\r\n    this._resource = new Resource(path, 'blob', bustCache);\r\n    this._options = options;\r\n  }\r\n\r\n  async load(): Promise<FontFace> {\r\n    if (this.isLoaded()) {\r\n      return this.data;\r\n    }\r\n\r\n    try {\r\n      const blob = await this._resource.load();\r\n      const url = URL.createObjectURL(blob);\r\n\r\n      if (!this.data) {\r\n        this.data = new FontFace(this.family, `url(${url})`);\r\n        document.fonts.add(this.data);\r\n      }\r\n\r\n      await this.data.load();\r\n      this._isLoaded = true;\r\n    } catch (error) {\r\n      throw `Error loading FontSource from path '${this.path}' with error [${(error as Error).message}]`;\r\n    }\r\n    return this.data;\r\n  }\r\n\r\n  isLoaded(): boolean {\r\n    return this._isLoaded;\r\n  }\r\n\r\n  /**\r\n   * Build a font from this FontSource.\r\n   * @param options {FontOptions} Override the font options\r\n   */\r\n  toFont(options?: FontOptions & GraphicOptions & RasterOptions): Font {\r\n    return new Font({ family: this.family, ...this._options, ...options });\r\n  }\r\n}\r\n","import { createContext, useContext } from '../Context';\r\nimport { Engine } from '../Engine';\r\nimport { ScheduledCallbackTiming } from './Clock';\r\nimport { Logger } from './Log';\r\nexport type CoroutineGenerator = () => Generator<any | number | Promise<any> | undefined, void, number>;\r\n\r\nconst InsideCoroutineContext = createContext<boolean>();\r\n\r\nconst generatorFunctionDeclaration = /^\\s*(?:function)?\\*/;\r\n/**\r\n *\r\n */\r\nfunction isCoroutineGenerator(x: any): x is CoroutineGenerator {\r\n  if (typeof x !== 'function') {\r\n    return false;\r\n  }\r\n  if (generatorFunctionDeclaration.test(Function.prototype.toString.call(x))) {\r\n    return true;\r\n  }\r\n  if (!Object.getPrototypeOf) {\r\n    return false;\r\n  }\r\n  return Object.getPrototypeOf(x) === Object.getPrototypeOf(new Function('return function * () {}')());\r\n}\r\n\r\nexport interface CoroutineOptions {\r\n  /**\r\n   * Coroutines run preframe in the clock by default.\r\n   */\r\n  timing?: ScheduledCallbackTiming;\r\n  /**\r\n   * Coroutines auto start by default, set to false to require play();\r\n   */\r\n  autostart?: boolean;\r\n}\r\n\r\ntype Thenable = PromiseLike<void>['then'];\r\n\r\nexport interface CoroutineInstance extends PromiseLike<void> {\r\n  isRunning(): boolean;\r\n  isComplete(): boolean;\r\n  done: Promise<void>;\r\n  generator: Generator<CoroutineInstance | number | Promise<any> | undefined, void, number>;\r\n  start: () => CoroutineInstance;\r\n  cancel: () => void;\r\n  then: Thenable;\r\n  [Symbol.iterator]: () => Generator<CoroutineInstance | number | Promise<any> | undefined, void, number>;\r\n}\r\n\r\n/**\r\n * Excalibur coroutine helper, returns a [[CoroutineInstance]] which is promise-like when complete. Coroutines run before frame update by default.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param thisArg set the \"this\" context of the generator, by default is globalThis\r\n * @param engine pass a specific engine to use for running the coroutine\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(\r\n  thisArg: any,\r\n  engine: Engine,\r\n  coroutineGenerator: CoroutineGenerator,\r\n  options?: CoroutineOptions\r\n): CoroutineInstance;\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param engine pass a specific engine to use for running the coroutine\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n/**\r\n * Excalibur coroutine helper, returns a promise when complete. Coroutines run before frame update.\r\n *\r\n * Each coroutine yield is 1 excalibur frame. Coroutines get passed the elapsed time our of yield. Coroutines\r\n * run internally on the excalibur clock.\r\n *\r\n * If you yield a promise it will be awaited before resumed\r\n * If you yield a number it will wait that many ms before resumed\r\n * @param thisArg set the \"this\" context of the generator, by default is globalThis\r\n * @param coroutineGenerator coroutine generator function\r\n * @param {CoroutineOptions} options optionally schedule coroutine pre/post update\r\n */\r\nexport function coroutine(thisArg: any, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n/**\r\n *\r\n */\r\nexport function coroutine(...args: any[]): CoroutineInstance {\r\n  const logger = Logger.getInstance();\r\n  let coroutineGenerator: CoroutineGenerator;\r\n  let thisArg: any;\r\n  let options: CoroutineOptions | undefined;\r\n  let passedEngine: Engine | undefined;\r\n\r\n  // coroutine(coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n  if (isCoroutineGenerator(args[0])) {\r\n    thisArg = globalThis;\r\n    coroutineGenerator = args[0];\r\n    options = args[1];\r\n  }\r\n\r\n  // coroutine(thisArg: any, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n  if (isCoroutineGenerator(args[1])) {\r\n    thisArg = args[0];\r\n    coroutineGenerator = args[1];\r\n    options = args[2];\r\n  }\r\n\r\n  // coroutine(thisArg: any, engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n  if (args[1] instanceof Engine) {\r\n    thisArg = args[0];\r\n    passedEngine = args[1];\r\n    coroutineGenerator = args[2];\r\n    options = args[3];\r\n  }\r\n\r\n  // coroutine(engine: Engine, coroutineGenerator: CoroutineGenerator, options?: CoroutineOptions): CoroutineInstance;\r\n  if (args[0] instanceof Engine) {\r\n    thisArg = globalThis;\r\n    passedEngine = args[0];\r\n    coroutineGenerator = args[1];\r\n    options = args[2];\r\n  }\r\n\r\n  const inside = useContext(InsideCoroutineContext);\r\n  const schedule = options?.timing;\r\n  const autostart = inside ? false : options?.autostart ?? true;\r\n  let engine: Engine;\r\n  try {\r\n    engine = passedEngine ?? Engine.useEngine();\r\n  } catch (_) {\r\n    throw Error(\r\n      'Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.\\n' +\r\n        'Pass an engine parameter to ex.coroutine(engine, function * {...})'\r\n    );\r\n  }\r\n\r\n  let started = false;\r\n  let completed = false;\r\n  let cancelled = false;\r\n  const generatorFcn = coroutineGenerator.bind(thisArg) as CoroutineGenerator;\r\n  const generator = generatorFcn();\r\n  let loop: (elapsed: number) => void;\r\n  const complete = new Promise<void>((resolve, reject) => {\r\n    loop = (elapsed: number) => {\r\n      try {\r\n        if (cancelled) {\r\n          completed = true;\r\n          resolve();\r\n          return;\r\n        }\r\n        const { done, value } = InsideCoroutineContext.scope(true, () => generator.next(elapsed));\r\n        if (done || cancelled) {\r\n          completed = true;\r\n          resolve();\r\n          return;\r\n        }\r\n\r\n        if (value instanceof Promise) {\r\n          value.then(() => {\r\n            // schedule next loop\r\n            engine.clock.schedule(loop, 0, schedule);\r\n          });\r\n        } else if (value === undefined || value === void 0) {\r\n          // schedule next frame\r\n          engine.clock.schedule(loop, 0, schedule);\r\n        } else {\r\n          // schedule value milliseconds from now\r\n          engine.clock.schedule(loop, value || 0, schedule);\r\n        }\r\n      } catch (e) {\r\n        reject(e);\r\n        return;\r\n      }\r\n    };\r\n    if (autostart) {\r\n      started = true;\r\n      loop(engine.clock.elapsed()); // run first frame immediately\r\n    }\r\n  });\r\n\r\n  const co: CoroutineInstance = {\r\n    isRunning: () => {\r\n      return started && !cancelled && !completed;\r\n    },\r\n    isComplete: () => {\r\n      return completed;\r\n    },\r\n    cancel: () => {\r\n      cancelled = true;\r\n    },\r\n    start: () => {\r\n      if (!started) {\r\n        started = true;\r\n        loop(engine.clock.elapsed());\r\n      } else {\r\n        logger.warn(\r\n          '.start() was called on a coroutine that was already started, this is probably a bug:\\n',\r\n          Function.prototype.toString.call(generatorFcn)\r\n        );\r\n      }\r\n      return co;\r\n    },\r\n    generator,\r\n    done: complete,\r\n    then: complete.then.bind(complete),\r\n    [Symbol.iterator]: () => {\r\n      // TODO warn if a coroutine is already running\r\n      // TODO warn if a coroutine is cancelled\r\n      return generator;\r\n    }\r\n  };\r\n\r\n  return co;\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Future } from '../Util/Future';\r\nimport { Entity, TransformComponent } from '../EntityComponentSystem';\r\nimport { GraphicsComponent } from '../Graphics';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\nimport { Vector } from '../Math/vector';\r\nimport { clamp } from '../Math/util';\r\nimport { EasingFunction, EasingFunctions } from '../Util/EasingFunctions';\r\nimport { coroutine, CoroutineInstance } from '../Util/Coroutine';\r\nimport { Logger } from '../Util/Log';\r\n\r\nexport interface TransitionOptions {\r\n  /**\r\n   * Transition duration in milliseconds\r\n   */\r\n  duration: number;\r\n\r\n  /**\r\n   * Optionally hides the loader during the transition\r\n   *\r\n   * If either the out or in transition have this set to true, then the loader will be hidden.\r\n   *\r\n   * Default false\r\n   */\r\n  hideLoader?: boolean;\r\n\r\n  /**\r\n   * Optionally blocks user input during a transition\r\n   *\r\n   * Default false\r\n   */\r\n  blockInput?: boolean;\r\n\r\n  /**\r\n   * Optionally specify a easing function, by default linear\r\n   */\r\n  easing?: EasingFunction;\r\n  /**\r\n   * Optionally specify a transition direction, by default 'out'\r\n   *\r\n   * * For 'in' direction transitions start at 1 and complete is at 0\r\n   * * For 'out' direction transitions start at 0 and complete is at 1\r\n   */\r\n  direction?: 'out' | 'in';\r\n}\r\n\r\n/**\r\n * Base Transition that can be extended to provide custom scene transitions in Excalibur.\r\n */\r\nexport class Transition extends Entity {\r\n  private _logger: Logger = Logger.getInstance();\r\n  transform = new TransformComponent();\r\n  graphics = new GraphicsComponent();\r\n  readonly hideLoader: boolean;\r\n  readonly blockInput: boolean;\r\n  readonly duration: number;\r\n  readonly easing: EasingFunction;\r\n  readonly direction: 'out' | 'in';\r\n  private _completeFuture = new Future<void>();\r\n  protected _engine?: Engine;\r\n  private _co?: CoroutineInstance;\r\n\r\n  // State needs to be reset between uses\r\n  public started = false;\r\n  private _currentDistance: number = 0;\r\n  private _currentProgress: number = 0;\r\n\r\n  public done = this._completeFuture.promise;\r\n\r\n  /**\r\n   * Returns a number between [0, 1] indicating what state the transition is in.\r\n   *\r\n   * * For 'out' direction transitions start at 0 and end at 1\r\n   * * For 'in' direction transitions start at 1 and end at 0\r\n   */\r\n  get progress(): number {\r\n    return this._currentProgress;\r\n  }\r\n\r\n  get complete(): boolean {\r\n    if (this.direction === 'out') {\r\n      return this.progress >= 1;\r\n    } else {\r\n      return this.progress <= 0;\r\n    }\r\n  }\r\n\r\n  constructor(options: TransitionOptions) {\r\n    super();\r\n    this.name = `Transition#${this.id}`;\r\n    this.duration = options.duration;\r\n    this.easing = options.easing ?? EasingFunctions.Linear;\r\n    this.direction = options.direction ?? 'out';\r\n    this.hideLoader = options.hideLoader ?? false;\r\n    this.blockInput = options.blockInput ?? false;\r\n    this.transform.coordPlane = CoordPlane.Screen;\r\n    this.transform.pos = Vector.Zero;\r\n    this.transform.z = Infinity; // Transitions sit on top of everything\r\n    this.graphics.anchor = Vector.Zero;\r\n    this.addComponent(this.transform);\r\n    this.addComponent(this.graphics);\r\n\r\n    if (this.direction === 'out') {\r\n      this._currentProgress = 0;\r\n    } else {\r\n      this._currentProgress = 1;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called before each update.\r\n   *\r\n   * **WARNING BE SURE** to call `super.updateTransition()` if overriding in your own custom implementation\r\n   * @param engine\r\n   * @param elapsed\r\n   */\r\n  public updateTransition(engine: Engine, elapsed: number): void {\r\n    if (this.complete) {\r\n      return;\r\n    }\r\n\r\n    this._currentDistance += clamp(elapsed / this.duration, 0, 1);\r\n    if (this._currentDistance >= 1) {\r\n      this._currentDistance = 1;\r\n    }\r\n\r\n    if (this.direction === 'out') {\r\n      this._currentProgress = clamp(this.easing(this._currentDistance, 0, 1, 1), 0, 1);\r\n    } else {\r\n      this._currentProgress = clamp(this.easing(this._currentDistance, 1, 0, 1), 0, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called right before the previous scene has deactivated.\r\n   *\r\n   * This gives incoming transition a chance to grab info from previous scene if desired\r\n   * @param scene\r\n   */\r\n  async onPreviousSceneDeactivate(scene: Scene) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called once at the beginning of the transition\r\n   *\r\n   * `progress` is given between 0 and 1\r\n   * @param progress\r\n   */\r\n  onStart(progress: number) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called every frame of the transition\r\n   *\r\n   * `progress` is given between 0 and 1\r\n   * @param progress\r\n   */\r\n  onUpdate(progress: number) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called at the end of the transition,\r\n   *\r\n   * `progress` is given between 0 and 1\r\n   * @param progress\r\n   */\r\n  onEnd(progress: number) {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * Overridable lifecycle method, called when the transition is reset\r\n   *\r\n   * Use this to override and provide your own reset logic for internal state in custom transition implementations\r\n   */\r\n  onReset() {\r\n    // override me\r\n  }\r\n\r\n  /**\r\n   * reset() is called by the engine to reset transitions\r\n   */\r\n  reset() {\r\n    this.started = false;\r\n    this._completeFuture = new Future<void>();\r\n    this.done = this._completeFuture.promise;\r\n    this._currentDistance = 0;\r\n    if (this.direction === 'out') {\r\n      this._currentProgress = 0;\r\n    } else {\r\n      this._currentProgress = 1;\r\n    }\r\n    this.onReset();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  _addToTargetScene(engine: Engine, targetScene: Scene): CoroutineInstance {\r\n    const currentScene = targetScene;\r\n    if (this.started) {\r\n      this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`);\r\n    }\r\n\r\n    if (currentScene.world.entityManager.getById(this.id)) {\r\n      return this._co!;\r\n    }\r\n    this._engine = engine;\r\n    currentScene.add(this);\r\n    const self = this;\r\n    this._co = coroutine(\r\n      engine,\r\n      function* () {\r\n        while (!self.complete) {\r\n          const elapsed = yield; // per frame\r\n          self.updateTransition(self._engine!, elapsed);\r\n          self._execute();\r\n        }\r\n      },\r\n      {\r\n        autostart: false\r\n      }\r\n    );\r\n    return this._co;\r\n  }\r\n\r\n  /**\r\n   * Called internally by excalibur to swap scenes with transition\r\n   * @internal\r\n   */\r\n  async _play() {\r\n    if (this.started) {\r\n      this.reset();\r\n      this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`);\r\n    }\r\n\r\n    if (!this._engine || !this._co) {\r\n      this.reset();\r\n      this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`);\r\n    }\r\n\r\n    if (this._co) {\r\n      await this._co.start();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * execute() is called by the engine every frame to update the Transition lifecycle onStart/onUpdate/onEnd\r\n   * @internal\r\n   */\r\n  _execute() {\r\n    if (!this.isInitialized) {\r\n      return;\r\n    }\r\n\r\n    if (!this.started) {\r\n      this.started = true;\r\n      this.onStart(this.progress);\r\n    }\r\n\r\n    this.onUpdate(this.progress);\r\n\r\n    if (this.complete && !this._completeFuture.isCompleted) {\r\n      this.onEnd(this.progress);\r\n      this._completeFuture.resolve();\r\n    }\r\n  }\r\n}\r\n","import { Engine } from '../Engine';\r\nimport { Color } from '../Color';\r\nimport { Rectangle } from '../Graphics';\r\nimport { Transition, TransitionOptions } from './Transition';\r\n\r\nexport interface FadeOptions {\r\n  duration?: number;\r\n  color?: Color;\r\n}\r\n\r\nexport class FadeInOut extends Transition {\r\n  screenCover!: Rectangle;\r\n  color: Color;\r\n  constructor(options: FadeOptions & TransitionOptions) {\r\n    super({\r\n      ...options,\r\n      duration: options.duration ?? 2000\r\n    });\r\n    this.name = `FadeInOut#${this.id}`;\r\n    this.color = options.color ?? Color.Black;\r\n  }\r\n\r\n  public onInitialize(engine: Engine): void {\r\n    this.transform.pos = engine.screen.unsafeArea.topLeft;\r\n    this.screenCover = new Rectangle({\r\n      width: engine.screen.resolution.width,\r\n      height: engine.screen.resolution.height,\r\n      color: this.color\r\n    });\r\n    this.graphics.add(this.screenCover);\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onReset() {\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onStart(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n\r\n  override onEnd(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n\r\n  override onUpdate(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n}\r\n","import { ImageSource, Sprite } from '../Graphics';\r\nimport { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Transition, TransitionOptions } from './Transition';\r\nimport { vec } from '../Math/vector';\r\n\r\nexport interface CrossFadeOptions {\r\n  duration: number;\r\n}\r\n\r\n/**\r\n * CrossFades between the previous scene and the destination scene\r\n *\r\n * Note: CrossFade only works as an \"in\" transition\r\n */\r\nexport class CrossFade extends Transition {\r\n  engine!: Engine;\r\n  image!: HTMLImageElement;\r\n  screenCover!: Sprite;\r\n  constructor(options: TransitionOptions & CrossFadeOptions) {\r\n    super({ direction: 'in', ...options }); // default the correct direction\r\n    this.name = `CrossFade#${this.id}`;\r\n  }\r\n\r\n  override async onPreviousSceneDeactivate(scene: Scene<unknown>) {\r\n    this.image = await scene.engine.screenshot(true);\r\n    // Firefox is particularly slow\r\n    // needed in case the image isn't ready yet\r\n    await this.image.decode();\r\n  }\r\n\r\n  override onInitialize(engine: Engine): void {\r\n    this.engine = engine;\r\n    this.transform.pos = engine.screen.unsafeArea.topLeft;\r\n    this.screenCover = ImageSource.fromHtmlImageElement(this.image).toSprite();\r\n    this.graphics.add(this.screenCover);\r\n\r\n    // This is because we preserve hidpi res on the screen shot which COULD be bigger than the logical resolution\r\n    this.transform.scale = vec(1 / engine.screen.pixelRatio, 1 / engine.screen.pixelRatio);\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onStart(_progress: number): void {\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onReset() {\r\n    this.graphics.opacity = this.progress;\r\n  }\r\n\r\n  override onEnd(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n\r\n  override onUpdate(progress: number): void {\r\n    this.graphics.opacity = progress;\r\n  }\r\n}\r\n","import { ImageSource, Sprite } from '../Graphics';\r\nimport { Engine } from '../Engine';\r\nimport { Scene } from '../Scene';\r\nimport { Transition, TransitionOptions } from './Transition';\r\nimport { vec, Vector } from '../Math/vector';\r\nimport { Camera } from '../Camera';\r\nimport { EasingFunction, EasingFunctions } from '../Util/EasingFunctions';\r\nimport { CoordPlane } from '../Math/coord-plane';\r\n\r\nexport interface SlideOptions {\r\n  /**\r\n   * Duration of the transition in milliseconds\r\n   */\r\n  duration: number;\r\n  /**\r\n   * Slide direction for the previous scene to move: up, down, left, right\r\n   */\r\n  slideDirection: 'up' | 'down' | 'left' | 'right';\r\n  /**\r\n   * Optionally select an easing function, by default linear (aka lerp)\r\n   */\r\n  easingFunction?: EasingFunction;\r\n}\r\n\r\n/**\r\n * Slide`s between the previous scene and the destination scene\r\n *\r\n * Note: Slide` only works as an \"in\" transition\r\n */\r\nexport class Slide extends Transition {\r\n  private _image!: HTMLImageElement;\r\n  private _screenCover!: Sprite;\r\n  private _easing = EasingFunctions.Linear;\r\n  private _vectorEasing: EasingFunction<Vector>;\r\n  readonly slideDirection: 'up' | 'down' | 'left' | 'right';\r\n  constructor(options: TransitionOptions & SlideOptions) {\r\n    super({ direction: 'in', ...options }); // default the correct direction\r\n    this.name = `Slide#${this.id}`;\r\n    this.slideDirection = options.slideDirection;\r\n    this.transform.coordPlane = CoordPlane.World;\r\n    this.graphics.forceOnScreen = true;\r\n    this._easing = options.easingFunction ?? this._easing;\r\n    this._vectorEasing = EasingFunctions.CreateVectorEasingFunction(this._easing);\r\n  }\r\n\r\n  override async onPreviousSceneDeactivate(scene: Scene<unknown>) {\r\n    this._image = await scene.engine.screenshot(true);\r\n    // Firefox is particularly slow\r\n    // needed in case the image isn't ready yet\r\n    await this._image.decode();\r\n    this._screenCover = ImageSource.fromHtmlImageElement(this._image).toSprite();\r\n  }\r\n\r\n  private _destinationCameraPosition!: Vector;\r\n  private _startCameraPosition!: Vector;\r\n  private _camera!: Camera;\r\n  private _directionOffset!: Vector;\r\n  override onInitialize(engine: Engine): void {\r\n    this._engine = engine;\r\n    switch (this.slideDirection) {\r\n      case 'up': {\r\n        this._directionOffset = vec(0, -engine.screen.resolution.height);\r\n        break;\r\n      }\r\n      case 'down': {\r\n        this._directionOffset = vec(0, engine.screen.resolution.height);\r\n        break;\r\n      }\r\n      case 'left': {\r\n        this._directionOffset = vec(-engine.screen.resolution.width, 0);\r\n        break;\r\n      }\r\n      case 'right': {\r\n        this._directionOffset = vec(engine.screen.resolution.width, 0);\r\n        break;\r\n      }\r\n    }\r\n\r\n    this._camera = this._engine.currentScene.camera;\r\n    this._destinationCameraPosition = this._camera.pos.clone();\r\n\r\n    // For sliding shift the camera and the transition slide by offset\r\n    this._camera.pos = this._camera.pos.add(this._directionOffset);\r\n    this.transform.pos = this.transform.pos.add(this._directionOffset);\r\n\r\n    this._startCameraPosition = this._camera.pos.clone();\r\n\r\n    this.graphics.use(this._screenCover);\r\n\r\n    // This is because we preserve hidpi res on the screen shot which COULD be bigger than the logical resolution\r\n    this.transform.scale = vec(1 / engine.screen.pixelRatio, 1 / engine.screen.pixelRatio);\r\n  }\r\n\r\n  override onUpdate(progress: number): void {\r\n    // in-transitions count down from 1 -> 0, so our \"end\" is swapped\r\n    this._camera.pos = this._vectorEasing(progress, this._destinationCameraPosition, this._startCameraPosition, 1);\r\n  }\r\n}\r\n","import { BoundingBox } from '../Collision/BoundingBox';\r\nimport { Color } from '../Color';\r\nimport { Vector } from '../Math/vector';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { Graphic } from './Graphic';\r\n\r\nexport interface LineOptions {\r\n  start: Vector;\r\n  end: Vector;\r\n  color?: Color;\r\n  thickness?: number;\r\n}\r\nexport class Line extends Graphic {\r\n  readonly start: Vector;\r\n  readonly end: Vector;\r\n  color: Color = Color.Black;\r\n  thickness: number = 1;\r\n  private _localBounds: BoundingBox;\r\n  constructor(options: LineOptions) {\r\n    super();\r\n    const { start, end, color, thickness } = options;\r\n    this.start = start;\r\n    this.end = end;\r\n    this.color = color ?? this.color;\r\n    this.thickness = thickness ?? this.thickness;\r\n    this._localBounds = this._calculateBounds();\r\n    const { width, height } = this._localBounds;\r\n\r\n    this.width = width;\r\n    this.height = height;\r\n  }\r\n\r\n  public get localBounds() {\r\n    return this._localBounds;\r\n  }\r\n\r\n  private _calculateBounds(): BoundingBox {\r\n    const lineNormal = this.end.sub(this.start).normal();\r\n\r\n    const halfThickness = this.thickness / 2;\r\n\r\n    const points = [\r\n      this.start.add(lineNormal.scale(halfThickness)),\r\n      this.end.add(lineNormal.scale(halfThickness)),\r\n      this.end.add(lineNormal.scale(-halfThickness)),\r\n      this.start.add(lineNormal.scale(-halfThickness))\r\n    ];\r\n\r\n    return BoundingBox.fromPoints(points);\r\n  }\r\n\r\n  protected _drawImage(ctx: ExcaliburGraphicsContext, _x: number, _y: number): void {\r\n    ctx.drawLine(this.start, this.end, this.color, this.thickness);\r\n  }\r\n\r\n  clone(): Line {\r\n    return new Line({\r\n      start: this.start,\r\n      end: this.end,\r\n      color: this.color,\r\n      thickness: this.thickness\r\n    });\r\n  }\r\n}\r\n","import { ImageFiltering } from './Filtering';\r\nimport { Vector, vec } from '../Math/vector';\r\nimport { Raster, RasterOptions } from './Raster';\r\n\r\nexport interface PolygonOptions {\r\n  points: Vector[];\r\n}\r\n\r\n/**\r\n * A polygon {@apilink Graphic} for drawing arbitrary polygons to the {@apilink ExcaliburGraphicsContext}\r\n *\r\n * Polygons default to {@apilink ImageFiltering.Blended}\r\n */\r\nexport class Polygon extends Raster {\r\n  private _points: Vector[] = [];\r\n  public get points(): Vector[] {\r\n    return this._points;\r\n  }\r\n  public set points(points: Vector[]) {\r\n    this._points = points;\r\n    const min = this.minPoint;\r\n    this.width = this._points.reduce((max, p) => Math.max(p.x, max), 0) - min.x;\r\n    this.height = this._points.reduce((max, p) => Math.max(p.y, max), 0) - min.y;\r\n    this.flagDirty();\r\n  }\r\n\r\n  public get minPoint() {\r\n    const minX = this._points.reduce((min, p) => Math.min(p.x, min), Infinity);\r\n    const minY = this._points.reduce((min, p) => Math.min(p.y, min), Infinity);\r\n    return vec(minX, minY);\r\n  }\r\n\r\n  constructor(options: RasterOptions & PolygonOptions) {\r\n    super(options);\r\n    this.points = options.points;\r\n    this.filtering = ImageFiltering.Blended;\r\n    this.rasterize();\r\n  }\r\n\r\n  public clone(): Polygon {\r\n    return new Polygon({\r\n      points: this.points.map((p) => p.clone()),\r\n      ...this.cloneGraphicOptions(),\r\n      ...this.cloneRasterOptions()\r\n    });\r\n  }\r\n\r\n  execute(ctx: CanvasRenderingContext2D): void {\r\n    if (this.points && this.points.length) {\r\n      ctx.beginPath();\r\n      // Iterate through the supplied points and construct a 'polygon'\r\n      const min = this.minPoint.negate();\r\n      const firstPoint = this.points[0].add(min);\r\n      ctx.moveTo(firstPoint.x, firstPoint.y);\r\n      this.points.forEach((point) => {\r\n        ctx.lineTo(point.x + min.x, point.y + min.y);\r\n      });\r\n      ctx.lineTo(firstPoint.x, firstPoint.y);\r\n      ctx.closePath();\r\n      if (this.color) {\r\n        ctx.fill();\r\n      }\r\n      if (this.strokeColor) {\r\n        ctx.stroke();\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { Graphic, GraphicOptions } from './Graphic';\r\nimport { ExcaliburGraphicsContext } from './Context/ExcaliburGraphicsContext';\r\nimport { ImageSource } from './ImageSource';\r\nimport { Logger } from '../Util/Log';\r\nimport { Vector } from '../Math/vector';\r\n\r\n/**\r\n * Nine slice stretch mode\r\n */\r\nexport enum NineSliceStretch {\r\n  /**\r\n   * Stretch the image across a dimension\r\n   */\r\n  Stretch = 'stretch',\r\n  /**\r\n   * Tile the image across a dimension\r\n   */\r\n  Tile = 'tile',\r\n  /**\r\n   * Tile the image across a dimension but only by whole image amounts\r\n   */\r\n  TileFit = 'tile-fit'\r\n}\r\n\r\nexport type NineSliceConfig = GraphicOptions & {\r\n  /**\r\n   * Final width of the nine slice graphic\r\n   */\r\n  width: number;\r\n  /**\r\n   * Final height of the nine slice graphic\r\n   */\r\n  height: number;\r\n  /**\r\n   *  Image source that's loaded from a Loader or individually\r\n   *\r\n   */\r\n  source: ImageSource;\r\n\r\n  /**\r\n   *  Configuration for the source\r\n   *\r\n   *  Details for the source image, including:\r\n   *\r\n   *  width and height as numbers of the source image\r\n   *\r\n   *  and the 9 slice margins\r\n   */\r\n  sourceConfig: {\r\n    width: number;\r\n    height: number;\r\n    topMargin: number;\r\n    leftMargin: number;\r\n    bottomMargin: number;\r\n    rightMargin: number;\r\n  };\r\n\r\n  /**\r\n   *  Configuration for the destination\r\n   *\r\n   *  Details for the destination image, including:\r\n   *\r\n   *  stretching strategies for horizontal and vertical stretching\r\n   *\r\n   *  and flag for drawing the center tile if desired\r\n   */\r\n  destinationConfig: {\r\n    /**\r\n     * Draw the center part of the nine slice, if false it's a completely transparent gap\r\n     */\r\n    drawCenter: boolean;\r\n    /**\r\n     * Horizontal stretch configuration\r\n     */\r\n    horizontalStretch: NineSliceStretch;\r\n    /**\r\n     * Vertical stretch configuration\r\n     */\r\n    verticalStretch: NineSliceStretch;\r\n  };\r\n};\r\n\r\nexport class NineSlice extends Graphic {\r\n  private _imgSource: ImageSource;\r\n  private _sourceSprite?: HTMLImageElement;\r\n  private _canvasA: HTMLCanvasElement;\r\n  private _canvasB: HTMLCanvasElement;\r\n  private _canvasC: HTMLCanvasElement;\r\n  private _canvasD: HTMLCanvasElement;\r\n  private _canvasE: HTMLCanvasElement;\r\n  private _canvasF: HTMLCanvasElement;\r\n  private _canvasG: HTMLCanvasElement;\r\n  private _canvasH: HTMLCanvasElement;\r\n  private _canvasI: HTMLCanvasElement;\r\n\r\n  private _logger = Logger.getInstance();\r\n\r\n  private _config: NineSliceConfig;\r\n  constructor(config: NineSliceConfig) {\r\n    super(config);\r\n    this._config = config;\r\n    this._imgSource = config.source;\r\n\r\n    this._canvasA = document.createElement('canvas');\r\n    this._canvasB = document.createElement('canvas');\r\n    this._canvasC = document.createElement('canvas');\r\n    this._canvasD = document.createElement('canvas');\r\n    this._canvasE = document.createElement('canvas');\r\n    this._canvasF = document.createElement('canvas');\r\n    this._canvasG = document.createElement('canvas');\r\n    this._canvasH = document.createElement('canvas');\r\n    this._canvasI = document.createElement('canvas');\r\n\r\n    this._initialize();\r\n\r\n    this._imgSource.ready.then(() => {\r\n      this._initialize();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sets the target width of the 9 slice (pixels), and recalculates the 9 slice if desired (auto)\r\n   * @param newWidth\r\n   * @param auto\r\n   */\r\n  setTargetWidth(newWidth: number, auto: boolean = false) {\r\n    this._config.width = newWidth;\r\n    if (auto) {\r\n      this._initialize();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Sets the target height of the 9 slice (pixels), and recalculates the 9 slice if desired (auto)\r\n   * @param newHeight\r\n   * @param auto\r\n   */\r\n  setTargetHeight(newHeight: number, auto: boolean = false) {\r\n    this._config.height = newHeight;\r\n    if (auto) {\r\n      this._initialize();\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  Sets the 9 slice margins (pixels), and recalculates the 9 slice if desired (auto)\r\n   */\r\n  setMargins(left: number, top: number, right: number, bottom: number, auto: boolean = false) {\r\n    this._config.sourceConfig.leftMargin = left;\r\n    this._config.sourceConfig.topMargin = top;\r\n    this._config.sourceConfig.rightMargin = right;\r\n    this._config.sourceConfig.bottomMargin = bottom;\r\n    if (auto) {\r\n      this._initialize();\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  Sets the stretching strategy for the 9 slice, and recalculates the 9 slice if desired (auto)\r\n   *\r\n   */\r\n  setStretch(type: 'horizontal' | 'vertical' | 'both', stretch: NineSliceStretch, auto: boolean = false) {\r\n    if (type === 'horizontal') {\r\n      this._config.destinationConfig.horizontalStretch = stretch;\r\n    } else if (type === 'vertical') {\r\n      this._config.destinationConfig.verticalStretch = stretch;\r\n    } else {\r\n      this._config.destinationConfig.horizontalStretch = stretch;\r\n      this._config.destinationConfig.verticalStretch = stretch;\r\n    }\r\n    if (auto) {\r\n      this._initialize();\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  Returns the config of the 9 slice\r\n   */\r\n  getConfig(): NineSliceConfig {\r\n    return this._config;\r\n  }\r\n\r\n  /**\r\n   * Draws 1 of the 9 tiles based on parameters passed in\r\n   * context is the ExcaliburGraphicsContext from the _drawImage function\r\n   * destinationSize is the size of the destination image as a vector (width,height)\r\n   * targetCanvas is the canvas to draw to\r\n   * horizontalStretch and verticalStretch are the horizontal and vertical stretching strategies\r\n   * marginW and marginH are optional margins for the 9 slice for positioning\r\n   * @param context\r\n   * @param targetCanvas\r\n   * @param destinationSize\r\n   * @param horizontalStretch\r\n   * @param verticalStretch\r\n   * @param marginWidth\r\n   * @param marginHeight\r\n   */\r\n  protected _drawTile(\r\n    context: ExcaliburGraphicsContext,\r\n    targetCanvas: HTMLCanvasElement,\r\n    destinationSize: Vector,\r\n    horizontalStretch: NineSliceStretch,\r\n    verticalStretch: NineSliceStretch,\r\n    marginWidth?: number,\r\n    marginHeight?: number\r\n  ) {\r\n    const tempMarginW = marginWidth || 0;\r\n    const tempMarginH = marginHeight || 0;\r\n    let tempSizeX: number, tempPositionX: number, tempSizeY: number, tempPositionY: number;\r\n    const numTilesX = this._getNumberOfTiles(targetCanvas.width, destinationSize.x, horizontalStretch);\r\n    const numTilesY = this._getNumberOfTiles(targetCanvas.height, destinationSize.y, verticalStretch);\r\n\r\n    for (let i = 0; i < numTilesX; i++) {\r\n      for (let j = 0; j < numTilesY; j++) {\r\n        let { tempSize, tempPosition } = this._calculateParams(\r\n          i,\r\n          numTilesX,\r\n          targetCanvas.width,\r\n          destinationSize.x,\r\n          this._config.destinationConfig.horizontalStretch\r\n        );\r\n        tempSizeX = tempSize;\r\n        tempPositionX = tempPosition;\r\n\r\n        ({ tempSize, tempPosition } = this._calculateParams(\r\n          j,\r\n          numTilesY,\r\n          targetCanvas.height,\r\n          destinationSize.y,\r\n          this._config.destinationConfig.verticalStretch\r\n        ));\r\n        tempSizeY = tempSize;\r\n        tempPositionY = tempPosition;\r\n\r\n        context.drawImage(\r\n          targetCanvas,\r\n          0,\r\n          0,\r\n          targetCanvas.width,\r\n          targetCanvas.height,\r\n          tempMarginW + tempPositionX,\r\n          tempMarginH + tempPositionY,\r\n          tempSizeX,\r\n          tempSizeY\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   *  Draws the 9 slices to the canvas\r\n   */\r\n  protected _drawImage(ex: ExcaliburGraphicsContext, x: number, y: number): void {\r\n    if (this._imgSource.isLoaded()) {\r\n      // Top left, no stretching\r\n\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasA,\r\n\r\n        new Vector(this._config.sourceConfig.leftMargin, this._config.sourceConfig.topMargin),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch\r\n      );\r\n\r\n      // Top, middle, horizontal stretching\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasB,\r\n\r\n        new Vector(\r\n          this._config.width - this._config.sourceConfig.leftMargin - this._config.sourceConfig.rightMargin,\r\n          this._config.sourceConfig.topMargin\r\n        ),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n        this._config.sourceConfig.leftMargin,\r\n        0\r\n      );\r\n\r\n      // Top right, no stretching\r\n\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasC,\r\n\r\n        new Vector(this._config.sourceConfig.rightMargin, this._config.sourceConfig.topMargin),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n\r\n        this._config.width - this._config.sourceConfig.rightMargin,\r\n        0\r\n      );\r\n\r\n      // middle, left, vertical stretching\r\n\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasD,\r\n        new Vector(\r\n          this._config.sourceConfig.leftMargin,\r\n\r\n          this._config.height - this._config.sourceConfig.bottomMargin - this._config.sourceConfig.topMargin\r\n        ),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n        0,\r\n        this._config.sourceConfig.topMargin\r\n      );\r\n\r\n      // center, both stretching\r\n      if (this._config.destinationConfig.drawCenter) {\r\n        this._drawTile(\r\n          ex,\r\n          this._canvasE,\r\n          new Vector(\r\n            this._config.width - this._config.sourceConfig.leftMargin - this._config.sourceConfig.rightMargin,\r\n\r\n            this._config.height - this._config.sourceConfig.bottomMargin - this._config.sourceConfig.topMargin\r\n          ),\r\n          this._config.destinationConfig.horizontalStretch,\r\n          this._config.destinationConfig.verticalStretch,\r\n          this._config.sourceConfig.leftMargin,\r\n          this._config.sourceConfig.topMargin\r\n        );\r\n      }\r\n      // middle, right, vertical stretching\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasF,\r\n\r\n        new Vector(\r\n          this._config.sourceConfig.rightMargin,\r\n\r\n          this._config.height - this._config.sourceConfig.bottomMargin - this._config.sourceConfig.topMargin\r\n        ),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n\r\n        this._config.width - this._config.sourceConfig.rightMargin,\r\n        this._config.sourceConfig.topMargin\r\n      );\r\n\r\n      // bottom left, no stretching\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasG,\r\n        new Vector(this._config.sourceConfig.leftMargin, this._config.sourceConfig.bottomMargin),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n        0,\r\n\r\n        this._config.height - this._config.sourceConfig.bottomMargin\r\n      );\r\n\r\n      // bottom middle, horizontal stretching\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasH,\r\n\r\n        new Vector(\r\n          this._config.width - this._config.sourceConfig.leftMargin - this._config.sourceConfig.rightMargin,\r\n          this._config.sourceConfig.bottomMargin\r\n        ),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n        this._config.sourceConfig.leftMargin,\r\n\r\n        this._config.height - this._config.sourceConfig.bottomMargin\r\n      );\r\n\r\n      // bottom right, no stretching\r\n      this._drawTile(\r\n        ex,\r\n        this._canvasI,\r\n        new Vector(this._config.sourceConfig.rightMargin, this._config.sourceConfig.bottomMargin),\r\n        this._config.destinationConfig.horizontalStretch,\r\n        this._config.destinationConfig.verticalStretch,\r\n\r\n        this._config.width - this._config.sourceConfig.rightMargin,\r\n\r\n        this._config.height - this._config.sourceConfig.bottomMargin\r\n      );\r\n    } else {\r\n      this._logger.warnOnce(\r\n        `NineSlice ImageSource ${this._imgSource.path}` +\r\n          ` is not yet loaded and won't be drawn. Please call .load() or include in a Loader.\\n\\n` +\r\n          `Read https://excaliburjs.com/docs/imagesource for more information.`\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Slices the source sprite into the 9 slice canvases internally\r\n   */\r\n  protected _initialize() {\r\n    this._sourceSprite = this._imgSource.image;\r\n\r\n    // top left slice\r\n    this._canvasA.width = this._config.sourceConfig.leftMargin;\r\n    this._canvasA.height = this._config.sourceConfig.topMargin;\r\n    const aCtx = this._canvasA.getContext('2d');\r\n\r\n    aCtx?.drawImage(this._sourceSprite, 0, 0, this._canvasA.width, this._canvasA.height, 0, 0, this._canvasA.width, this._canvasA.height);\r\n\r\n    // top slice\r\n\r\n    this._canvasB.width = this._config.sourceConfig.width - this._config.sourceConfig.leftMargin - this._config.sourceConfig.rightMargin;\r\n    this._canvasB.height = this._config.sourceConfig.topMargin;\r\n\r\n    const bCtx = this._canvasB.getContext('2d');\r\n    bCtx?.drawImage(\r\n      this._sourceSprite,\r\n      this._config.sourceConfig.leftMargin,\r\n      0,\r\n      this._canvasB.width,\r\n      this._canvasB.height,\r\n      0,\r\n      0,\r\n      this._canvasB.width,\r\n      this._canvasB.height\r\n    );\r\n\r\n    // top right slice\r\n    this._canvasC.width = this._config.sourceConfig.rightMargin;\r\n    this._canvasC.height = this._config.sourceConfig.topMargin;\r\n    const cCtx = this._canvasC.getContext('2d');\r\n    cCtx?.drawImage(\r\n      this._sourceSprite,\r\n      this._sourceSprite.width - this._config.sourceConfig.rightMargin,\r\n      0,\r\n      this._canvasC.width,\r\n      this._canvasC.height,\r\n      0,\r\n      0,\r\n      this._canvasC.width,\r\n      this._canvasC.height\r\n    );\r\n\r\n    // middle left slice\r\n    this._canvasD.width = this._config.sourceConfig.leftMargin;\r\n    this._canvasD.height = this._config.sourceConfig.height - this._config.sourceConfig.topMargin - this._config.sourceConfig.bottomMargin;\r\n    const dCtx = this._canvasD.getContext('2d');\r\n    dCtx?.drawImage(\r\n      this._sourceSprite,\r\n      0,\r\n      this._config.sourceConfig.topMargin,\r\n      this._canvasD.width,\r\n      this._canvasD.height,\r\n      0,\r\n      0,\r\n      this._canvasD.width,\r\n      this._canvasD.height\r\n    );\r\n\r\n    // middle slice\r\n    this._canvasE.width = this._config.sourceConfig.width - this._config.sourceConfig.leftMargin - this._config.sourceConfig.rightMargin;\r\n    this._canvasE.height = this._config.sourceConfig.height - this._config.sourceConfig.topMargin - this._config.sourceConfig.bottomMargin;\r\n    const eCtx = this._canvasE.getContext('2d');\r\n    eCtx?.drawImage(\r\n      this._sourceSprite,\r\n      this._config.sourceConfig.leftMargin,\r\n      this._config.sourceConfig.topMargin,\r\n      this._canvasE.width,\r\n      this._canvasE.height,\r\n      0,\r\n      0,\r\n      this._canvasE.width,\r\n      this._canvasE.height\r\n    );\r\n\r\n    // middle right slice\r\n    this._canvasF.width = this._config.sourceConfig.rightMargin;\r\n    this._canvasF.height = this._config.sourceConfig.height - this._config.sourceConfig.topMargin - this._config.sourceConfig.bottomMargin;\r\n    const fCtx = this._canvasF.getContext('2d');\r\n    fCtx?.drawImage(\r\n      this._sourceSprite,\r\n\r\n      this._config.sourceConfig.width - this._config.sourceConfig.rightMargin,\r\n      this._config.sourceConfig.topMargin,\r\n      this._canvasF.width,\r\n      this._canvasF.height,\r\n      0,\r\n      0,\r\n      this._canvasF.width,\r\n      this._canvasF.height\r\n    );\r\n\r\n    // bottom left slice\r\n    this._canvasG.width = this._config.sourceConfig.leftMargin;\r\n    this._canvasG.height = this._config.sourceConfig.bottomMargin;\r\n    const gCtx = this._canvasG.getContext('2d');\r\n    gCtx?.drawImage(\r\n      this._sourceSprite,\r\n      0,\r\n      this._config.sourceConfig.height - this._config.sourceConfig.bottomMargin,\r\n      this._canvasG.width,\r\n      this._canvasG.height,\r\n      0,\r\n      0,\r\n      this._canvasG.width,\r\n      this._canvasG.height\r\n    );\r\n\r\n    // bottom slice\r\n    this._canvasH.width = this._config.sourceConfig.width - this._config.sourceConfig.leftMargin - this._config.sourceConfig.rightMargin;\r\n    this._canvasH.height = this._config.sourceConfig.bottomMargin;\r\n    const hCtx = this._canvasH.getContext('2d');\r\n    hCtx?.drawImage(\r\n      this._sourceSprite,\r\n      this._config.sourceConfig.leftMargin,\r\n      this._config.sourceConfig.height - this._config.sourceConfig.bottomMargin,\r\n      this._canvasH.width,\r\n      this._canvasH.height,\r\n      0,\r\n      0,\r\n      this._canvasH.width,\r\n      this._canvasH.height\r\n    );\r\n\r\n    // bottom right slice\r\n    this._canvasI.width = this._config.sourceConfig.rightMargin;\r\n    this._canvasI.height = this._config.sourceConfig.bottomMargin;\r\n    const iCtx = this._canvasI.getContext('2d');\r\n    iCtx?.drawImage(\r\n      this._sourceSprite,\r\n      this._sourceSprite.width - this._config.sourceConfig.rightMargin,\r\n      this._config.sourceConfig.height - this._config.sourceConfig.bottomMargin,\r\n      this._canvasI.width,\r\n      this._canvasI.height,\r\n      0,\r\n      0,\r\n      this._canvasI.width,\r\n      this._canvasI.height\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Clones the 9 slice\r\n   */\r\n\r\n  clone(): NineSlice {\r\n    return new NineSlice(this._config);\r\n  }\r\n\r\n  /**\r\n   * Returns the number of tiles\r\n   */\r\n  protected _getNumberOfTiles(tileSize: number, destinationSize: number, strategy: NineSliceStretch): number {\r\n    switch (strategy) {\r\n      case NineSliceStretch.Stretch:\r\n        return 1;\r\n      case NineSliceStretch.Tile:\r\n        return Math.ceil(destinationSize / tileSize);\r\n      case NineSliceStretch.TileFit:\r\n        return Math.ceil(destinationSize / tileSize);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the position and size of the tile\r\n   */\r\n  protected _calculateParams(\r\n    tileNum: number,\r\n    numTiles: number,\r\n    tileSize: number,\r\n    destinationSize: number,\r\n    strategy: NineSliceStretch\r\n  ): { tempPosition: number; tempSize: number } {\r\n    switch (strategy) {\r\n      case NineSliceStretch.Stretch:\r\n        return {\r\n          tempPosition: 0,\r\n          tempSize: destinationSize\r\n        };\r\n      case NineSliceStretch.Tile:\r\n        // if last tile, adjust size\r\n        if (tileNum === numTiles - 1) {\r\n          //last tile\r\n          return {\r\n            tempPosition: tileNum * tileSize,\r\n            tempSize: tileSize - (numTiles * tileSize - destinationSize)\r\n          };\r\n        } else {\r\n          return {\r\n            tempPosition: tileNum * tileSize,\r\n            tempSize: tileSize\r\n          };\r\n        }\r\n\r\n      case NineSliceStretch.TileFit:\r\n        const reducedTileSize = destinationSize / numTiles;\r\n        const position = tileNum * reducedTileSize;\r\n        return {\r\n          tempPosition: position,\r\n          tempSize: reducedTileSize\r\n        };\r\n    }\r\n  }\r\n}\r\n","import { ImageFiltering } from './Filtering';\r\nimport { ImageWrapConfiguration } from './ImageSource';\r\nimport { SourceView, Sprite } from './Sprite';\r\nimport { ImageWrapping } from './Wrapping';\r\nimport { Animation, AnimationOptions } from './Animation';\r\nimport { GraphicOptions } from './Graphic';\r\nimport { TiledSprite } from './TiledSprite';\r\nimport { watch } from '../Util/Watch';\r\nimport { Future } from '../Util/Future';\r\n\r\nexport interface TiledAnimationOptions {\r\n  /**\r\n   * Animation to tile\r\n   */\r\n  animation: Animation;\r\n  /**\r\n   * Optionally override source view on frame graphics\r\n   */\r\n  sourceView?: Partial<SourceView>;\r\n  /**\r\n   * Optionally override filtering options\r\n   */\r\n  filtering?: ImageFiltering;\r\n  /**\r\n   * Default wrapping is Repeat for TiledAnimation\r\n   */\r\n  wrapping?: ImageWrapConfiguration | ImageWrapping;\r\n  /**\r\n   * Total width in pixels for the tiling to take place\r\n   */\r\n  width: number;\r\n  /**\r\n   * Total height in pixels for the tiling to take place\r\n   */\r\n  height: number;\r\n}\r\n\r\nexport class TiledAnimation extends Animation {\r\n  private _ready = new Future<void>();\r\n  public ready = this._ready.promise;\r\n  private _tiledWidth: number = 0;\r\n  private _tiledHeight: number = 0;\r\n  private _sourceView: Partial<SourceView> = {};\r\n  constructor(options: GraphicOptions & Omit<AnimationOptions, 'frames'> & TiledAnimationOptions) {\r\n    super({\r\n      ...options,\r\n      frames: options.animation.frames.slice(),\r\n      strategy: options.animation.strategy,\r\n      frameDuration: options.animation.frameDuration,\r\n      speed: options.animation.speed,\r\n      reverse: options.animation.isReversed\r\n    });\r\n    this._sourceView = { ...options.sourceView };\r\n    this._tiledWidth = options.width;\r\n    this._tiledHeight = options.height;\r\n\r\n    const promises: Promise<void>[] = [];\r\n    for (let i = 0; i < this.frames.length; i++) {\r\n      const graphic = this.frames[i].graphic;\r\n      if (graphic && graphic instanceof Sprite) {\r\n        const tiledSprite = new TiledSprite({\r\n          image: graphic.image,\r\n          width: options.width,\r\n          height: options.height,\r\n          sourceView: { ...graphic.sourceView },\r\n          wrapping: options.wrapping,\r\n          filtering: options.filtering\r\n        });\r\n        this.frames[i].graphic = tiledSprite;\r\n\r\n        // There is a new calc'd sourceView when ready\r\n        tiledSprite.ready.then(() => {\r\n          tiledSprite.sourceView = { ...tiledSprite.sourceView, ...this._sourceView };\r\n        });\r\n        promises.push(tiledSprite.ready);\r\n      }\r\n    }\r\n    Promise.all(promises).then(() => this._ready.resolve());\r\n  }\r\n\r\n  public static fromAnimation(animation: Animation, options?: Omit<TiledAnimationOptions, 'animation'>): TiledAnimation {\r\n    return new TiledAnimation({\r\n      width: animation.width,\r\n      height: animation.height,\r\n      ...options,\r\n      animation\r\n    });\r\n  }\r\n\r\n  private _updateSourceView() {\r\n    for (let i = 0; i < this.frames.length; i++) {\r\n      const graphic = this.frames[i].graphic;\r\n      if (graphic && graphic instanceof Sprite) {\r\n        graphic.sourceView = { ...graphic.sourceView, ...this._sourceView };\r\n      }\r\n    }\r\n  }\r\n\r\n  get sourceView(): Partial<SourceView> {\r\n    return watch(this._sourceView, () => this._updateSourceView());\r\n  }\r\n\r\n  set sourceView(sourceView: Partial<SourceView>) {\r\n    this._sourceView = watch(sourceView, () => this._updateSourceView());\r\n    this._updateSourceView();\r\n  }\r\n\r\n  private _updateWidthHeight() {\r\n    for (let i = 0; i < this.frames.length; i++) {\r\n      const graphic = this.frames[i].graphic;\r\n      if (graphic && graphic instanceof Sprite) {\r\n        graphic.sourceView.height = this._tiledHeight || graphic.height;\r\n        graphic.destSize.height = this._tiledHeight || graphic.height;\r\n        graphic.sourceView.width = this._tiledWidth || graphic.width;\r\n        graphic.destSize.width = this._tiledWidth || graphic.width;\r\n      }\r\n    }\r\n  }\r\n\r\n  get width() {\r\n    return this._tiledWidth;\r\n  }\r\n\r\n  get height() {\r\n    return this._tiledHeight;\r\n  }\r\n\r\n  override set width(width: number) {\r\n    this._tiledWidth = width;\r\n    this._updateWidthHeight();\r\n  }\r\n\r\n  override set height(height: number) {\r\n    this._tiledHeight = height;\r\n    this._updateWidthHeight();\r\n  }\r\n}\r\n","import { Flags } from '../Flags';\nimport { Logger } from './Log';\n\n/**\n * Obsolete decorator options\n */\nexport interface ObsoleteOptions {\n  // Optionally specify a custom message\n  message?: string;\n  // Optionally indicate that an alternate method to the obsolete one exists\n  alternateMethod?: string;\n  // Optional show stack trace, by default off\n  showStackTrace?: boolean;\n}\n\nexport const maxMessages = 5;\nconst obsoleteMessage: { [messageCount: string]: number } = {};\nexport const resetObsoleteCounter = () => {\n  for (const message in obsoleteMessage) {\n    obsoleteMessage[message] = 0;\n  }\n};\n\nconst logMessage = (message: string, options: ObsoleteOptions) => {\n  const suppressObsoleteMessages = Flags.isEnabled('suppress-obsolete-message');\n  if (obsoleteMessage[message] < maxMessages && !suppressObsoleteMessages) {\n    Logger.getInstance().warn(message);\n\n    // tslint:disable-next-line: no-console\n    if (console.trace && options.showStackTrace) {\n      // tslint:disable-next-line: no-console\n      console.trace();\n    }\n  }\n  obsoleteMessage[message]++;\n};\n\n/**\n * Obsolete decorator for marking Excalibur methods obsolete, you can optionally specify a custom message and/or alternate replacement\n * method do the deprecated one. Inspired by https://github.com/jayphelps/core-decorators.js\n */\nexport function obsolete(options?: ObsoleteOptions): any {\n  options = {\n    message: 'This feature will be removed in future versions of Excalibur.',\n    alternateMethod: null,\n    showStackTrace: false,\n    ...options\n  };\n\n  return function (target: any, property: string, descriptor: PropertyDescriptor): any {\n    if (\n      descriptor &&\n      !(typeof descriptor.value === 'function' || typeof descriptor.get === 'function' || typeof descriptor.set === 'function')\n    ) {\n      throw new SyntaxError('Only classes/functions/getters/setters can be marked as obsolete');\n    }\n    const methodSignature = `${target.name || ''}${target.name && property ? '.' : ''}${property ? property : ''}`;\n\n    const message =\n      `${methodSignature} is marked obsolete: ${options.message}` +\n      (options.alternateMethod ? ` Use ${options.alternateMethod} instead` : '');\n\n    if (!obsoleteMessage[message]) {\n      obsoleteMessage[message] = 0;\n    }\n\n    // If descriptor is null it is a class\n    const method = descriptor ? { ...descriptor } : target;\n    if (!descriptor) {\n      // with es2015 classes we need to change our decoration tactic\n      class DecoratedClass extends method {\n        constructor(...args: any) {\n          logMessage(message, options);\n          super(...args);\n        }\n      }\n      return DecoratedClass;\n    }\n\n    if (descriptor && descriptor.value) {\n      method.value = function (this: any) {\n        logMessage(message, options);\n        return descriptor.value.apply(this, arguments);\n      };\n      return method;\n    }\n\n    if (descriptor && descriptor.get) {\n      method.get = function (this: any) {\n        logMessage(message, options);\n        return descriptor.get.apply(this, arguments);\n      };\n    }\n\n    if (descriptor && descriptor.set) {\n      method.set = function (this: any) {\n        logMessage(message, options);\n        return descriptor.set.apply(this, arguments);\n      };\n    }\n    return method;\n  };\n}\n","import { Future } from './Future';\r\n\r\nclass AsyncWaitQueue<T> {\r\n  // Code from StephenCleary https://gist.github.com/StephenCleary/ba50b2da419c03b9cba1d20cb4654d5e\r\n  private _queue: Future<T>[] = [];\r\n\r\n  public get length(): number {\r\n    return this._queue.length;\r\n  }\r\n\r\n  public enqueue(): Promise<T> {\r\n    const future = new Future<T>();\r\n    this._queue.push(future);\r\n    return future.promise;\r\n  }\r\n\r\n  public dequeue(value: T): void {\r\n    const future = this._queue.shift();\r\n    future.resolve(value);\r\n  }\r\n}\r\n\r\n/**\r\n * Semaphore allows you to limit the amount of async calls happening between `enter()` and `exit()`\r\n *\r\n * This can be useful when limiting the number of http calls, browser api calls, etc either for performance or to work\r\n * around browser limitations like max Image.decode() calls in chromium being 256.\r\n */\r\nexport class Semaphore {\r\n  private _waitQueue = new AsyncWaitQueue();\r\n  constructor(private _count: number) {}\r\n\r\n  public get count() {\r\n    return this._count;\r\n  }\r\n\r\n  public get waiting() {\r\n    return this._waitQueue.length;\r\n  }\r\n\r\n  // eslint-disable-next-line require-await\r\n  public async enter() {\r\n    if (this._count !== 0) {\r\n      this._count--;\r\n      return Promise.resolve();\r\n    }\r\n    return this._waitQueue.enqueue();\r\n  }\r\n\r\n  public exit(count: number = 1) {\r\n    if (count === 0) {\r\n      return;\r\n    }\r\n    while (count !== 0 && this._waitQueue.length !== 0) {\r\n      this._waitQueue.dequeue(null);\r\n      count--;\r\n    }\r\n    this._count += count;\r\n  }\r\n}\r\n","/**\r\n * The current Excalibur version string\r\n * @description `process.env.__EX_VERSION` gets replaced by Webpack on build\r\n */\r\nexport const EX_VERSION = process.env.__EX_VERSION;\r\nimport { polyfill } from './Polyfill';\r\npolyfill();\r\n\r\n// This file is used as the bundle entry point and exports everything\r\n// that will be exposed as the `ex` global variable.\r\nexport * from './Flags';\r\nexport * from './Id';\r\nexport * from './Engine';\r\nexport * from './GarbageCollector';\r\nexport * from './Screen';\r\nexport * from './Actor';\r\nexport * from './Math/index';\r\nexport * from './Camera';\r\nexport * from './Debug/index';\r\nexport * from './EventEmitter';\r\nexport * from './Events/MediaEvents';\r\nexport * from './Events';\r\nexport * from './Label';\r\nexport { FontStyle, FontUnit, TextAlign, BaseAlign } from './Graphics/FontCommon';\r\nexport * from './Particles/index';\r\nexport * from './Scene';\r\n\r\nexport * from './TileMap/index';\r\n\r\nexport * from './Timer';\r\nexport * from './Trigger';\r\nexport * from './ScreenElement';\r\n\r\nexport * from './Actions/index';\r\nexport * from './Collision/Index';\r\n\r\nexport * from './Interfaces/Index';\r\nexport * from './Resources/Index';\r\n\r\nexport * from './EntityComponentSystem/index';\r\n\r\nexport * from './Director/index';\r\n\r\nexport * from './Color';\r\n\r\nexport * from './Graphics/index';\r\n\r\n// ex.Events namespace\r\nimport * as events from './Events';\r\nexport { events as Events };\r\n\r\nexport { WheelEvent } from './Input/WheelEvent';\r\n\r\nexport { PointerEvent } from './Input/PointerEvent';\r\n\r\nexport { WheelDeltaMode } from './Input/WheelDeltaMode';\r\n\r\nexport { PointerButton } from './Input/PointerButton';\r\n\r\nexport { NativePointerButton } from './Input/NativePointerButton';\r\n\r\nexport { CapturePointerConfig } from './Input/CapturePointerConfig';\r\n\r\nexport {\r\n  NativePointerEvent,\r\n  NativeMouseEvent,\r\n  NativeTouchEvent,\r\n  NativeWheelEvent,\r\n  PointerInitOptions,\r\n  PointerEventReceiver\r\n} from './Input/PointerEventReceiver';\r\n\r\nexport { PointerAbstraction } from './Input/PointerAbstraction';\r\nexport { PointerComponent } from './Input/PointerComponent';\r\nexport { PointerSystem } from './Input/PointerSystem';\r\nexport { PointerType } from './Input/PointerType';\r\nexport { PointerScope } from './Input/PointerScope';\r\n\r\nexport {\r\n  Gamepads,\r\n  Gamepad,\r\n  Buttons,\r\n  Axes,\r\n  NavigatorGamepads,\r\n  NavigatorGamepad,\r\n  NavigatorGamepadButton,\r\n  NavigatorGamepadEvent,\r\n  GamepadConfiguration\r\n} from './Input/Gamepad';\r\n\r\nexport { Keys, KeyEvent, KeyboardInitOptions, Keyboard } from './Input/Keyboard';\r\nexport * from './Input/InputHost';\r\nexport * from './Input/InputMapper';\r\n\r\n// ex.Util namespaces\r\nimport * as util from './Util/Index';\r\nexport { util as Util };\r\n\r\nexport * from './Util/Browser';\r\nexport * from './Util/Decorators';\r\nexport * from './Util/Detector';\r\nexport * from './Util/EasingFunctions';\r\nexport * from './Util/Observable';\r\nexport * from './Util/Log';\r\nexport * from './Util/Pool';\r\nexport * from './Util/Fps';\r\nexport * from './Util/Clock';\r\nexport * from './Util/WebAudio';\r\nexport * from './Util/Toaster';\r\nexport * from './Util/StateMachine';\r\nexport * from './Util/Future';\r\nexport * from './Util/Semaphore';\r\nexport * from './Util/Coroutine';\r\nexport * from './Util/Assert';\r\n\r\n// ex.Deprecated\r\n// import * as deprecated from './Deprecated';\r\n// export { deprecated as Deprecated };\r\n// export * from './Deprecated';\r\n"],"names":["root","factory","exports","module","define","amd","self","___CSS_LOADER_EXPORT___","push","id","cssWithMappingToString","list","toString","this","map","item","content","needLayer","concat","length","join","i","modules","media","dedupe","supports","layer","undefined","alreadyImportedModules","k","_k","cssMapping","btoa","base64","unescape","encodeURIComponent","JSON","stringify","data","sourceMapping","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","n","getter","__esModule","d","a","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","r","Symbol","toStringTag","value","PointerScope","RotationType","polyfill","window","audioContext","requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","callback","setInterval","cancelAnimationFrame","webkitCancelAnimationFrame","mozCancelAnimationFrame","AudioContext","webkitAudioContext","replaceMe","decodeAudioData","arrayBuffer","Promise","resolve","reject","mozAudioContext","msAudioContext","oAudioContext","devicePixelRatio","requestIdleCallback","cb","start","Date","now","setTimeout","didTimeout","timeRemaining","Math","max","cancelIdleCallback","clearTimeout","Flags","useCanvasGraphicsContext","enable","useLegacyImageRenderer","freeze","_FROZEN","_reset","_FLAGS","flagName","Error","disable","isEnabled","show","keys","createId","type","Future","constructor","_isCompleted","promise","_resolver","_rejecter","isCompleted","error","EventEmitter","_paused","_empty","_listeners","_listenersOnce","_pipes","clear","on","eventName","handler","close","off","once","newListeners","filter","h","newOnceListeners","emit","event","listeners","onces","pipe","emitter","indexOf","splice","unpipe","pause","unpause","BITMASK32","Random","seed","_lowerMask","_upperMask","_w","_n","_m","_a","_u","_s","_b","_t","_c","_l","_f","_mt","Array","s","_index","_twist","mag01","y","nextInt","next","floating","min","integer","floor","bool","likelihood","pickOne","array","pickSet","numPicks","allowDuplicates","_pickSetWithDuplicates","_pickSetWithoutDuplicates","result","currentPick","tempArray","slice","index","shuffle","swap","randomIndex","range","d4","d6","d8","d10","d12","d20","TwoPI","PI","frac","x","ceil","sign","val","clamp","approximatelyEqual","val1","val2","tolerance","abs","canonicalizeAngle","angle","tmpAngle","toDegrees","radians","toRadians","degrees","from","to","_x","randomInRange","random","randomIntInRange","round","Vector","Zero","One","Half","Up","Down","Left","Right","fromAngle","cos","sin","isValid","vec","isNaN","Infinity","distance","vec1","vec2","sqrt","pow","_y","setTo","equals","vector","EQUALS_EPSILON","v","deltaX","deltaY","squareDistance","clampMagnitude","magnitude","newSize","size","newLength","normalize","scale","newMagnitude","average","add","sizeOrScale","dest","sub","addEqual","subEqual","scaleEqual","dot","cross","num","perpendicular","normal","negate","toAngle","atan2","angleBetween","rotationType","startAngleRadians","endAngleRadians","rotationClockwise","rotationAntiClockwise","ShortestPath","LongestPath","Clockwise","CounterClockwise","rotate","anchor","sinAngle","cosAngle","clone","fixed","toFixed","Color","g","b","fromRGB","fromRGBString","string","match","parseInt","parseFloat","fromHex","hex","fromHSL","l","HSLColor","toRGBA","lighten","factor","temp","fromRGBA","darken","saturate","desaturate","multiply","color","newR","newG","newB","newA","screen","color1","invert","color2","equal","format","toHSLA","toHex","_componentToHex","c","hexRepresentation","String","fillStyle","Black","White","Gray","LightGray","DarkGray","Yellow","Orange","Red","Vermilion","Rose","Pink","Magenta","Violet","Purple","Blue","Azure","Cyan","Viridian","Teal","Green","Chartreuse","Transparent","ExcaliburBlue","Brown","hue2rgb","p","q","t","LogLevel","Side","MatrixLocations","Logger","_appenders","defaultLevel","Info","_logOnceSet","Set","_INSTANCE","addAppender","ConsoleAppender","getInstance","appender","clearAppenders","_log","level","args","len","log","_logOnce","serialized","has","debug","Debug","debugOnce","info","infoOnce","warn","Warn","warnOnce","errorOnce","fatal","Fatal","fatalOnce","console","consoleArgs","unshift","apply","ScreenAppender","options","_messages","_pos","_color","_options","canvas","document","createElement","_ctx","getContext","style","position","zIndex","body","appendChild","_positionScreenAppenderCanvas","engine","events","width","resolution","height","pagePos","screenToPageCoordinates","left","top","xPos","message","clearRect","pos","fillText","getOpposite","side","Top","Bottom","None","fromDirection","direction","BoundingBox","leftOrOptions","right","bottom","_points","reset","getSideFromIntersection","intersection","fromPoints","points","minX","minY","maxX","maxY","fromDimension","hasZeroDimensions","center","topLeft","bottomRight","topRight","bottomLeft","translate","point","getPoints","shifted","transform","matrix","xa1","xa2","xb1","xb2","ya1","ya2","yb1","yb2","matrixPos","getPosition","getPerimeter","_left","_right","_top","_bottom","rayCast","ray","farClipDistance","tMin","tMax","xInv","dir","Number","MAX_VALUE","yInv","tx1","tx2","ty1","ty2","rayCastTime","contains","combine","other","compositeBB","dimensions","overlaps","epsilon","e","totalBoundingBox","intersect","overlapX","overlapY","intersectWithSide","bb","draw","ex","drawRect","el","getBoundingClientRect","rect","scrollX","scrollY","addItemToArray","removeItemFromArray","fail","delay","milliseconds","clock","future","schedule","bind","omit","object","newObj","includes","isObject","isArray","mergeDeep","target","sources","source","shift","assign","Matrix","Float32Array","_scaleX","_scaleSignX","_scaleY","_scaleSignY","ortho","near","far","mat","toDOMMatrix","DOMMatrix","fromFloat32Array","identity","translation","sx","sy","rotation","vectorOrMatrix","resultX","resultY","a11","a21","a31","a41","a12","a22","a32","a42","a13","a23","a33","a43","a14","a24","a34","a44","b11","b21","b31","b41","b12","b22","b32","b42","b13","b23","b33","b43","b14","b24","b34","b44","getScale","setPosition","sine","cosine","setRotation","currentScale","getRotation","getScaleY","getScaleX","xscale","yscale","setScaleX","setScaleY","setScale","getBasisDeterminant","getAffineInverse","inverseDet","m","tx","ty","isIdentity","AffineMatrix","Float64Array","_scale","determinant","inverse","det","signX","signY","multiplyQuadInPlace","quad","resultTopLeftX","resultTopLeftY","resultTopRightX","resultTopRightY","resultBottomLeftX","resultBottomLeftY","resultBottomRightX","resultBottomRightY","to4x4","xScaleSq","yScaleSq","RentalPool","builder","cleaner","preAllocate","_pool","_size","grow","amount","rent","clean","pop","TransformStack","_transforms","_currentTransform","save","restore","return","current","ContextState","opacity","z","tint","material","StateStack","_states","_cloneState","ResourceEvents","Complete","Load","LoadStart","Progress","Resource","path","responseType","bustCache","logger","isLoaded","_cacheBust","uri","test","load","request","XMLHttpRequest","open","addEventListener","status","response","statusText","Blob","errorText","send","watch","change","__isProxy","Proxy","set","createHandler","typeType","Graphic","isStale","_transformStale","flipHorizontal","_flipHorizontal","flipVertical","_flipVertical","_rotation","origin","_origin","_ID","showDebug","_width","_height","cloneGraphicOptions","localBounds","_preDraw","_drawImage","_postDraw","_rotate","_flip","scaleDirX","scaleDirY","Sprite","image","super","_logger","_dirty","sourceView","destSize","_updateSpriteDimensions","ready","then","newWidth","newHeight","nativeWidth","nativeHeight","drawImage","ImageFiltering","ImageWrapping","parseImageFiltering","Pixel","Blended","parseImageWrapping","Clamp","Repeat","Mirror","TextureLoader","gl","_garbageCollector","_textureMap","Map","_collect","_gl","name","dataset","originalSrc","_LOGGER","delete","_MAX_TEXTURE_SIZE","getParameter","MAX_TEXTURE_SIZE","collectionInterval","garbageCollector","registerCollector","dispose","forceUpdate","filtering","wrapping","wrappingConfig","tex","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","touch","createTexture","checkImageSizeSupportedAndLog","pixelStorei","UNPACK_PREMULTIPLY_ALPHA_WEBGL","xWrap","yWrap","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","REPEAT","MIRRORED_REPEAT","TEXTURE_WRAP_T","filterMode","TEXTURE_MIN_FILTER","NEAREST","LINEAR","TEXTURE_MAG_FILTER","addCollectableResource","texture","deleteTexture","ImageSourceAttributeConstants","Filtering","WrappingX","WrappingY","ImageSource","naturalWidth","naturalHeight","_src","src","pathOrBase64","bustCacheOrOptions","Image","_readyFuture","_resource","endsWith","fromHtmlImageElement","imageSource","setAttribute","fromHtmlCanvasElement","toBlob","blob","url","URL","createObjectURL","onload","revokeObjectURL","fromSvgString","svgSource","loadedFuture","toSprite","unload","SpriteFont","_text","alphabet","shadow","caseInsensitive","spacing","lineHeight","spriteSheet","_getCharacterSprites","text","results","textToRender","toLocaleLowerCase","letterIndex","letter","spriteIndex","letterSprite","sprites","measureText","maxWidth","lines","_getLinesFromText","maxWidthLine","reduce","sprite","xCursor","yCursor","line","render","bounds","offset","_cachedText","_cachedRenderWidth","_cachedLines","split","newLine","TiledSprite","_ready","_applyTiling","fromSprite","spriteCanvas","tiledImageSource","SpriteSheet","rows","columns","getSprite","spriteWithOptions","getTiledSprite","fromImageSourceWithSourceViews","sourceViews","fromImageSource","grid","cols","spriteWidth","spriteHeight","originOffset","margin","offsetDefaults","marginDefaults","DebugText","fontSheet","_imageSource","_spriteSheet","_spriteFont","write","ctx","RenderSource","_texture","use","activeTexture","TEXTURE0","RenderTarget","antialias","samples","transparency","MAX_SAMPLES","drawingBufferFormat","bufferFormat","RGBA8","RGB8","_setupRenderBuffer","_setupFramebuffer","setResolution","_frameTexture","_renderBuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorageMultisample","renderBuffer","renderFrameBuffer","_renderFrameBuffer","frameBuffer","_frameBuffer","frameTexture","createRenderbuffer","createFramebuffer","bindFramebuffer","FRAMEBUFFER","framebufferRenderbuffer","COLOR_ATTACHMENT0","attachmentPoint","framebufferTexture2D","toRenderSource","blitRenderBufferToFrameBuffer","blitToScreen","READ_FRAMEBUFFER","DRAW_FRAMEBUFFER","clearBufferfv","COLOR","blitFramebuffer","COLOR_BUFFER_BIT","copyToTexture","copyTexImage2D","viewport","getGlTypeSizeBytes","INT","UNSIGNED_INT","FLOAT","SHORT","UNSIGNED_SHORT","BYTE","isAttributeInSource","variable","matches","RegExp","exec","getGLTypeFromSource","groups","BOOL","getAttributeComponentSize","LOW_FLOAT","HIGH_FLOAT","FLOAT_VEC2","FLOAT_VEC3","FLOAT_VEC4","getAttributePointerType","getMaxShaderComplexity","numIfs","assembleTestShader","testShader","testComplexity","replace","canCompile","shader","createShader","FRAGMENT_SHADER","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","Shader","compiled","_compiled","uniforms","attributes","vertexSource","fragmentSource","onPreLink","onPostCompile","_onPreLink","_onPostCompile","deleteProgram","program","useProgram","_ACTIVE_SHADER_INSTANCE","isCurrentlyBound","compile","vertexShader","_compileShader","VERTEX_SHADER","fragmentShader","_createProgram","getAttributes","attribute","getUniforms","uniform","uniformCount","getProgramParameter","ACTIVE_UNIFORMS","getActiveUniform","uniformLocation","getUniformLocation","glType","location","attributeCount","ACTIVE_ATTRIBUTES","getActiveAttrib","attributeLocation","getAttribLocation","normalized","setTexture","slotNumber","setUniformInt","setUniform","trySetUniformInt","trySetUniform","setUniformIntArray","trySetUniformIntArray","setUniformBoolean","trySetUniformBoolean","setUniformFloat","trySetUniformFloat","setUniformFloatArray","trySetUniformFloatArray","setUniformFloatVector","trySetUniformFloatVector","setUniformFloatColor","trySetUniformFloatColor","setUniformMatrix","setUniformAffineMatrix","trySetUniformMatrix","uniformType","createProgram","attachShader","linkProgram","LINK_STATUS","getProgramInfoLog","typeName","errorInfo","getShaderInfoLog","_processSourceForError","errorLineStart","search","errorLineEnd","_","error2","VertexBuffer","buffer","createBuffer","bufferData","bindBuffer","ARRAY_BUFFER","STATIC_DRAW","DYNAMIC_DRAW","unbind","upload","count","bufferSubData","deleteBuffer","VertexLayout","vertexBuffer","_vertexBuffer","_attributes","_suppressWarnings","_layout","_vertexTotalSizeBytes","_initialized","suppressWarnings","_shader","initialize","totalVertexSizeBytes","shaderAttributes","attrib","componentsPerVertex","vertAttribute","typeSize","_vao","createVertexArray","bindVertexArray","vert","vertexAttribIPointer","vertexAttribPointer","enableVertexAttribArray","uploadBuffer","GraphicsDiagnostics","DrawCallCount","DrawnImagesCount","LineRenderer","priority","_maxLines","_vertexIndex","_lineCount","_startScratch","_endScratch","context","_context","end","_isFull","flush","getTransform","finalStart","finalEnd","hasPendingDraws","drawArrays","LINES","PointRenderer","_maxPoints","_pointCount","_buffer","snapToPixel","finalPoint","pixelSnapEpsilon","POINTS","ScreenPassPainter","renderWithPostProcessor","postprocessor","getShader","getLayout","onDraw","TRIANGLES","renderToScreen","QuadIndexBuffer","numberOfQuads","useUint16","ELEMENT_ARRAY_BUFFER","totalVertices","maxUint16","maxUint16Index","bufferGlType","Uint16Array","Uint32Array","currentQuad","ImageRenderer","_maxImages","_maxTextures","_imageCount","_textures","_textureIndex","_textureToIndex","_images","_imageToWidth","_imageToHeight","_view","_dest","_quad","_defaultTint","pixelArtSampler","uvPadding","maxTexture","MAX_TEXTURE_IMAGE_UNITS","maxComplexity","transformedFrag","_transformFragmentSource","_quads","maxTextures","newSource","texturePickerBuilder","_addImageAsTexture","maybeFiltering","getAttribute","wrapX","wrapY","force","textureLoader","removeAttribute","_bindTextures","_getTextureIdForImage","maybeTexture","_getImageWidth","maybeWidth","_getImageHeight","maybeHeight","swidth","sheight","dx","dy","dwidth","dheight","maybeImageWidth","maybeImageHeight","sw","sh","textureId","imageWidth","imageHeight","uvx0","uvy0","uvx1","uvy1","txWidth","txHeight","drawElements","RectangleRenderer","_maxRectangles","_rectangleCount","_transparent","_scratch1","_scratch2","_scratch3","_scratch4","drawLine","drawRectangle","thickness","halfThick","startTop","startBottom","endTop","endBottom","stroke","strokeThickness","CircleRenderer","_maxCircles","_circleCount","radius","Pool","recycler","maxObjects","totalAllocations","objects","disableWarnings","preallocate","using","done","borrow","poolIndex","DrawCall","renderer","state","Material","graphicsContext","images","_name","_vertexSource","_fragmentSource","ExcaliburGraphicsContextWebGL","_graphicsContext","_initialize","addImageSource","graphicsContextWebGL","__gl","_maxTextureSlots","isUsingScreenTexture","update","textureUniformName","removeImageSource","textureName","_loadImageSource","imageElement","uploadAndBind","startingTextureSlot","textureSlot","entries","MaterialRenderer","vertexIndex","view","topLeftScreen","bottomRightScreen","screenUVX0","screenUVY0","screenUVX1","screenUVY1","performance","materialScreenTexture","CoordPlane","AnimationDirection","AnimationStrategy","VectorView","_getX","getX","_getY","getY","_setX","setX","_setY","setY","WatchVector","original","newX","newY","_parent","_children","flagDirty","_globalPos","parent","_globalScale","globalScaleX","globalScale","globalScaleY","_z","_isDirty","_isInverseDirty","_matrix","_inverse","_scratch","children","globalPos","localPos","canonRotation","globalRotation","inverseRotation","inverseScale","globalZ","_calculateMatrix","applyInverse","setTransform","isMirrored","cloneWithParent","isComponentCtor","Component","owner","newComponent","Observable","observers","subscriptions","register","observer","subscribe","func","unregister","unsubscribe","notifyAll","observersLength","notify","subscriptionsLength","TransformComponent","_parentComponent","_transform","_addChildTransform","child","childTxComponent","zIndexChanged$","_coordPlane","World","onAdd","childrenAdded$","childrenRemoved$","onRemove","_previousOwner","oldz","coordPlane","component","AnimationEvents","Frame","Loop","End","Animation","frames","strategy","frameDuration","_idempotencyToken","_firstTick","_currentFrame","_timeLeftInFrame","_pingPongDirection","_done","_playing","_speed","_reversed","speed","totalDuration","reverse","goToFrame","f","maybeFrame","currentFrame","graphic","fromSpriteSheet","spriteSheetIndex","durationPerFrame","maxIndex","invalidIndices","duration","fromSpriteSheetCoordinates","frameCoordinates","durationPerFrameMs","defaultDuration","coord","currentFrameIndex","currentFrameTimeLeft","isPlaying","isReversed","Backward","Forward","play","canFinish","Freeze","frameNumber","frameIndex","_nextFrame","PingPong","tick","elapsed","idempotencyToken","GraphicsGroup","useAnchor","members","_updateDimensions","member","useBounds","_isAnimationOrGroup","Raster","lineCap","quality","_smoothing","_lineWidth","_lineDash","_padding","strokeColor","smoothing","lineWidth","lineDash","padding","_bitmap","bitmapWidth","bitmapHeight","maybeCtx","cloneRasterOptions","dirty","_getTotalWidth","_originalWidth","_getTotalHeight","_originalHeight","_strokeColor","rasterize","_applyRasterProperties","execute","imageSmoothingEnabled","setLineDash","getLineDash","strokeStyle","FontUnit","TextAlign","BaseAlign","FontStyle","Direction","EventTypes","x1","y1","x2","y2","cap","beginPath","moveTo","lineTo","closePath","arc","roundRect","fill","br","tl","tr","bl","defaultRadius","quadraticCurveTo","circle","FontTextInstance","font","_textFragments","disposed","_setDimension","_lastHashCode","getHashCode","_applyFont","metrics","textHeight","actualBoundingBoxAscent","actualBoundingBoxDescent","lineAdjustedHeight","bottomBounds","actualBoundingBoxLeft","actualBoundingBoxRight","textBounds","bitmap","lineHeightRatio","fontString","textAlign","baseAlign","includeColor","resetTransform","textBaseline","shadowColor","blur","shadowBlur","shadowOffsetX","shadowOffsetY","_drawText","strokeText","_splitTextBitmap","textImages","currentX","currentY","_ex","hashCode","frag","FontCache","hash","_MEASURE_CACHE","measurement","measureTextWithoutCache","getTextInstance","textInstance","_TEXT_CACHE","_TEXT_USAGE","checkAndClearCache","deferred","currentHashCodes","time","FONT_TIMEOUT","forEach","newTextMeasurementCache","cacheSize","clearCache","Font","family","Normal","bold","unit","Px","LeftToRight","_textBounds","_textMeasurement","colorOverride","Text","_textWidth","_textHeight","_calculateDimension","_font","hasGraphicsTick","GraphicsComponent","visible","isVisible","_offset","recalculateBounds","_anchor","currentGraphic","graphics","_current","_graphics","forceOnScreen","copyGraphics","onPreDraw","onPostDraw","onPreTransformDraw","onPostTransformDraw","graphicOrOptions","getGraphic","getOptions","getNames","currentOptions","nameOrGraphic","optionsToSet","graphicToSet","remove","hide","_localBounds","offsetX","offsetY","GameEvent","_bubbles","bubbles","stopPropagation","KillEvent","PreKillEvent","PostKillEvent","GameStartEvent","GameStopEvent","PreDrawEvent","PostDrawEvent","PreTransformDrawEvent","PostTransformDrawEvent","PreDebugDrawEvent","PostDebugDrawEvent","PreUpdateEvent","PostUpdateEvent","PreFrameEvent","prevStats","PostFrameEvent","stats","GamepadConnectEvent","gamepad","GamepadDisconnectEvent","GamepadButtonEvent","button","GamepadAxisEvent","axis","VisibleEvent","HiddenEvent","PreCollisionEvent","contact","PostCollisionEvent","ContactStartEvent","ContactEndEvent","lastContact","CollisionPreSolveEvent","CollisionPostSolveEvent","CollisionStartEvent","CollisionEndEvent","InitializeEvent","ActivateEvent","DeactivateEvent","ExitViewPortEvent","EnterViewPortEvent","EnterTriggerEvent","entity","ExitTriggerEvent","ActionStartEvent","action","ActionCompleteEvent","AddEvent","RemoveEvent","AddedComponent","isAddedComponent","RemovedComponent","isRemovedComponent","EntityEvents","Add","Remove","Initialize","PreUpdate","PostUpdate","Kill","Entity","componentsOrOptions","componentsToAdd","nameToAdd","_tags","componentAdded$","componentRemoved$","tagAdded$","tagRemoved$","components","componentValues","_componentsToRemove","scene","isActive","_isInitialized","_isAdded","silence","silenceWarnings","addComponent","active","kill","unparent","isKilled","tags","hasTag","tag","addTag","removeTag","types","getComponents","values","hasAll","requiredTypes","hasAllTags","requiredTags","removeChild","addChild","getAncestors","removeAllChildren","getDescendants","queue","curr","newEntity","componentInstance","addTemplate","templateEntity","_getClassHierarchyRoot","componentType","getPrototypeOf","removeComponent","dependencies","ctor","rootComponent","typeOrInstance","componentToRemove","componentIndex","clearComponents","processComponentRemoval","isInitialized","isAdded","onInitialize","_add","_remove","_preupdate","onPreUpdate","_postupdate","onPostUpdate","MotionComponent","vel","acc","scaleFactor","angularVelocity","torque","inertia","EulerIntegrator","integrate","motion","totalAcc","seconds","_ACC","_VEL","_POS","_VEL_ACC","_SCALE_FACTOR","_SCALE","Particle","beginColor","endColor","life","fade","_rRate","_gRate","_bRate","_aRate","_currentColor","sizeRate","isOffscreen","particleTransform","ParticleTransform","Global","configure","registerEmitter","_emitter","startSize","endSize","drawPoint","removeParticle","accel","focus","focusAccel","DefaultConfig","ParticleRenderer","transformFeedbackVaryings","INTERLEAVED_ATTRIBS","_getTexture","particle","Local","ImageRendererV2","_components","_quadMesh","_meshBuffer","_transformData","totalSize","vertexAttribDivisor","_bindData","drawArraysInstanced","ExcaliburGraphicsContextWebGLDebug","_webglCtx","_debugText","rectOptions","lineOptions","pointOptions","drawText","_state","_ortho","checkIfResolutionSupported","dim","supported","_renderers","_lazyRenderersFactory","imageRenderer","_isDrawLifecycle","useDrawSorting","_drawCallPool","_drawCallIndex","_drawCalls","_postProcessTargets","_postprocessors","backgroundColor","multiSampleAntialiasing","_isContextLost","_disposed","_totalPostProcessorTime","canvasElement","enableTransparency","antialiasing","powerPreference","handleContextLost","handleContextRestored","premultipliedAlpha","alpha","depth","_init","clearColor","BLEND","blendEquation","FUNC_ADD","blendFunc","ONE","ONE_MINUS_SRC_ALPHA","blendEquationSeparate","blendFuncSeparate","depthMask","lazyRegister","_screenRenderer","_renderTarget","_msaaTarget","rendererName","maybeRenderer","lazyFactory","_isCurrentRenderer","_currentRenderer","beginDrawLifecycle","endDrawLifecycle","drawCall","updateViewport","trace","drawCircle","addPostProcessor","removePostProcessor","clearPostProcessors","updatePostProcessors","find","u","onUpdate","createMaterial","currentTarget","originalSort","firstIndex","sort","originalSortOrder","oldTransform","oldState","currentRendererName","currentRenderer","ExcaliburGraphicsContext2DCanvasDebug","__ctx","strokeRect","ExcaliburGraphicsContext2DCanvas","_resolution","globalAlpha","fillRect","_postprocessor","DisplayMode","Resolution","SVGA","Standard","Atari2600","GameBoy","GameBoyAdvance","NintendoDS","NES","SNES","ScreenEvents","ScreenResize","PixelRatioChange","FullScreenChange","Screen","_antialiasing","_canvasImageRendering","_resolutionStack","_viewportStack","_pixelRatioOverride","_isFullscreen","_isDisposed","_fullscreenChangeHandler","fullscreen","isFullscreen","_pixelRatioChangeHandler","_listenForPixelRatio","_devicePixelRatio","_calculateDevicePixelRatio","applyResolutionAndViewport","pixelRatio","_resizeHandler","_setResolutionAndViewportByDisplayMode","_contentArea","_unsafeArea","_contentResolution","_displayMode","displayMode","Fixed","_canvas","canvasImageRendering","_browser","browser","_applyDisplayMode","_mediaQueryList","removeListener","nativeComponent","matchMedia","addListener","_resizeObserver","disconnect","removeEventListener","worldToPagePixelRatio","pageOrigin","worldToPageCoordinates","pixelRatioOverride","isHiDpi","FillContainer","FitContainer","FitContainerAndFill","FitContainerAndZoom","parentElement","_viewport","aspectRatio","scaledWidth","scaledHeight","setCurrentCamera","camera","_camera","pushResolutionAndViewport","peekViewport","peekResolution","popResolutionAndViewport","currentPixelRatio","newResolutionSupported","imageRendering","widthUnit","heightUnit","documentElement","setProperty","isSmooth","isFullScreen","goFullScreen","elementId","enterFullscreen","maybeElement","getElementById","requestFullscreen","webkitRequestFullscreen","exitFullScreen","exitFullscreen","_viewportToPixels","offsetWidth","offsetHeight","pageToScreenCoordinates","innerWidth","innerHeight","screenHeight","screenWidth","contentArea","screenMarginY","screenMarginX","screenToWorldCoordinates","worldToScreenCoordinates","pageToWorldCoordinates","getWorldBounds","zoom","drawPos","getScreenBounds","canvasWidth","halfCanvasWidth","canvasHeight","halfCanvasHeight","drawWidth","halfDrawWidth","drawHeight","halfDrawHeight","unsafeArea","_computeFit","overflow","aspect","adjustedWidth","adjustedHeight","_computeFitScreenAndFill","vw","vh","_computeFitAndFill","_computeFitContainerAndFill","clip","_computeFitScreenAndZoom","_computeFitAndZoom","_computeFitContainerAndZoom","scaleX","scaleY","maxScaleFactor","zoomedWidth","zoomedHeight","_computeFitContainer","clientWidth","clientHeight","Window","ResizeObserver","observe","FillScreen","FitScreen","FitScreenAndFill","FitScreenAndZoom","AudioContextFactory","create","WebAudio","unlock","_UNLOCKED","unlockTimeoutTimer","resume","createBufferSource","ended","connect","destination","onended","playbackState","isLegacyWebAudioSource","currentTime","PLAYING_STATE","FINISHED_STATE","isUnlocked","Canvas","cache","ExResponse","any","json","arraybuffer","StateMachine","states","currentState","_currentState","machineDescription","machine","stateName","transitionState","transitions","startState","go","eventData","potentialNewState","onExit","onEnter","onState","saveKey","localStorage","setItem","parse","getItem","WebAudioInstance","_createNewBufferSource","_instance","_audioContext","loop","playbackRate","_playbackRate","_volumeNode","_handleEnd","_playingFuture","_loop","volume","_volume","_stateMachine","in","gain","setTargetAtTime","_duration","getTotalPlaybackDuration","createGain","PLAYING","pausedAt","startedAt","_playStarted","stop","SEEK","STOPPED","PAUSED","isPaused","isStopped","playStarted","seek","getPlaybackPosition","MediaEvent","_value","_path","_val","propagate","layPath","_actor","NativeSoundEvent","track","NativeSoundProcessedEvent","_processedData","canPlayFile","file","Audio","filetype","canPlayType","SoundEvents","VolumeChange","Processed","Pause","Stop","PlaybackEnd","Resume","PlaybackStart","Sound","_tracks","instances","paths","_isStopped","_wasPlayingOnHidden","audiobuffer","decodeAudio","wireEngine","_engine","pauseAudioWhenHidden","instanceCount","some","_resumePlayback","_startPlayback","trackId","_getTrackInstance","getTrackId","resumed","all","complete","newTrack","LoaderEvents","BeforeLoad","AfterLoad","UserAction","LoadResourceStart","LoadResourceEnd","isLoaderConstructor","DefaultLoader","resources","_resources","_numLoaded","_totalTimeMs","_loadingFuture","loadables","addResources","onUserAction","onBeforeLoad","onAfterLoad","addResource","loadable","markResourceComplete","progress","total","textbox","areResourcesLoaded","async","finally","resource","Loader","_image","_imageElement","_imageLoaded","logo","playButtonRootElement","_playButtonRootElement","playButtonElement","_playButtonElement","_playButton","existingRoot","_styleBlock","textContent","_playButtonStyles","head","startButtonFactory","loadablesOrOptions","_originalOptions","_playButtonShown","logoWidth","logoHeight","loadingBarColor","suppressPlayButton","playButtonText","buttonElement","display","_DEFAULT_LOADER_OPTIONS","showPlayButton","resizeHandler","_positionPlayButton","evt","click","playButtonClicked","startButtonHandler","hidePlayButton","fullscreenAfterLoad","fullscreenContainer","HTMLElement","input","gamepads","Event","decode","buttonWidth","buttonHeight","playButtonPosition","logoY","logoX","logoPosition","oldAntialias","loadingX","loadingY","loadingBarPosition","progressWidth","REPORTED_FEATURES","webgl","webaudio","gamepadapi","Detector","_features","failedTests","_criticalTests","canvasSupport","elem","arrayBufferSupport","xhr","dataUrlSupport","toDataURL","objectUrlSupport","rgbaSupport","cssText","_warningTest","webAudioSupport","webglSupport","_loadBrowserFeatures","getBrowserFeatures","logBrowserFeatures","msg","feature","dataurl","objecturl","rgba","navigator","getGamepads","failedCritical","warning","CollisionType","SolverStrategy","ContactSolveBias","CollisionGroupManager","mask","_CURRENT_GROUP","_MAX_GROUPS","_GROUPS","existingGroup","group","CollisionGroup","_CURRENT_BIT","groupByName","_STARTING_BIT","category","_category","_mask","canCollide","overlap1","overlap2","collisionGroups","combinedName","combinedMask","collidesWith","padStart","All","Pair","colliderA","colliderB","calculatePairHash","bodyA","BodyComponent","bodyB","collisionType","PreventCollision","collide","hasCollider","collider","idA","idB","Projection","projection","getOverlap","TreeNode","isLeaf","DynamicTree","_config","worldBounds","nodes","_insert","leaf","leafAABB","currentRoot","area","combinedArea","cost","inheritanceCost","leftCost","leftCombined","newArea","oldArea","rightCost","rightCombined","oldParent","newParent","currentNode","_balance","grandParent","sibling","trackCollider","node","updateCollider","untrackCollider","boundsPadding","multdx","velocityMultiplier","multdy","balance","getHeight","query","helper","rayCastQuery","getNodes","Ray","numerator","begin","getSlope","divisor","getLength","intersectPoint","getPoint","DynamicTreeCollisionProcessor","_pairs","_collisionPairCache","_colliders","_dynamicCollisionTree","dynamicTree","getColliders","pointOrBounds","maxDistance","collisionGroup","collisionMask","searchAllColliders","maybeBody","ignoreCollisionGroupAll","hit","CompositeCollider","colliders","untrack","_pairExists","broadphase","targets","potentialColliders","j","pair","physics","pairs","continuous","checkForFastBodies","Active","updateDistance","minDimension","disableMinimumSpeedForFastBody","fastBodies","updateVec","oldPos","centerPoint","furthestPoint","getFurthestPoint","minCollider","surfaceEpsilon","minTranslate","fastBodyCollisions","narrowphase","contacts","newContacts","collisions","updated","Collider","composite","touching","VerticalFirst","vertical","horizontal","HorizontalFirst","SpatialPartitionStrategy","getDefaultPhysicsConfig","enabled","gravity","solver","Arcade","substep","compositeStrategy","bodies","canSleepByDefault","sleepEpsilon","wakeThreshold","sleepBias","defaultMass","spatialPartition","SparseHashGrid","sparseHashGrid","arcade","contactSolveBias","realistic","positionIterations","velocityIterations","slop","steeringFactor","warmStart","_compositeStrategy","_collisionProcessor","_dynamicAABBTree","addCollider","clearColliders","removeCollider","worldPos","axes","furthestPoints","bestPoint","getInertia","mass","totalInertia","otherColliders","potentialCollider","getClosestLineBetween","maybeLine","minLength","minLine","hits","minHit","minDistance","project","projections","proj","newProjection","LineSegment","slope","intercept","_normal","_dir","_slope","getEdge","midpoint","flip","below","sideVector","clipTime","distanceToPoint","signed","x0","y0","findVectorToPoint","aMinusP","findPoint","hasPoint","currPoint","threshold","arguments","dxc","dyc","dx1","dy1","ClosestLine","line1","line2","EPSILON","line1Dir","line2Dir","d1Squared","d2Squared","closestPoint","denom","closestPointOnLine1","closestPointOnLine2","ClosestLineJumpTable","PolygonPolygonClosestLine","polygonA","polygonB","aSides","getSides","bSides","closestLine","PolygonEdgeClosestLine","polygon","edge","otherDirection","rayTowardsOther","thisPoint","thisFace","getClosestFace","edgeLine","asLine","face","PolygonCircleClosestLine","otherWorldPos","p0","circlex","circley","CircleCircleClosestLine","circleA","circleB","thisDirection","rayTowardsThis","otherPoint","CircleEdgeClosestLine","circleWorldPos","EdgeEdgeClosestLine","edgeA","edgeB","CircleCollider","_globalMatrix","_radius","_naturalRadius","_localBoundsDirty","orig","u1","toi","discriminant","toi1","toi2","positiveToi","minToi","shape","PolygonCollider","EdgeCollider","CollisionJumpTable","CollideCircleCircle","CollideCirclePolygon","CollideCircleEdge","getFurthestLocalPoint","scalars","dotProduct","CollisionContact","mtv","tangent","localPoints","_canceled","colliderAId","colliderBId","matchAwake","isSleeping","sleepMotion","isCanceled","cancel","bias","SeparationInfo","localAxis","localSide","localPoint","SeparatingAxis","findPolygonPolygonSeparation","polyA","polyB","findPolygonPolygonSeparationDegenerate","bestSeparation","bestSideIndex","toPolyBSpace","_SCRATCH_MATRIX","toPolyBSpaceRotation","normalsA","normals","pointsA","pointsB","pointsAIndex","_ZERO","_SCRATCH_NORMAL","_SCRATCH_POINT","smallestLocalPoint","smallestPointDistance","pointsBIndex","_SCRATCH_SUB_POINT","bestSide2","separationInfo","SeparationPool","separation","sideId","findCirclePolygonSeparation","polyDir","closestPointOnPoly","minOverlap","minAxis","minIndex","proj1","proj2","overlap","bestSide","bestAxis","bestOtherPoint","sides","localSides","getLocalSides","vertB","vertSeparation","ScratchZero","ScratchNormal","ScratchMatrix","circleAPos","circleBPos","combinedRadius","mvt","local","sameDir","findSide","findLocalSide","cc","edgeWorld","asLocalLine","da","dda","db","ddb","den","pointOnEdge","dd","CollideEdgeEdge","CollidePolygonEdge","pc","linePoly","CollidePolygonPolygon","separationA","separationB","main","toIncidentFrame","toIncidentFrameRotation","referenceEdgeNormal","minEdge","incidentEdgeIndex","referenceSide","referenceDirection","clipRight","clipLeft","clipPoints","FindContactSeparation","shapeA","txA","shapeB","txB","worldPoint","circlePoint","dist","_getTransformedBegin","_getTransformedEnd","transformedBegin","transformedEnd","_boundsFromBeginEnd","edgeNormal","registerGraphicsContext","debugDrawCall","drawLines","drawPolygon","firstPoint","drawBounds","boundingBox","drawRay","_localSidesDirty","_transformedPointsDirty","_sidesDirty","_normals","_checkAndUpdateWinding","_calculateNormals","_transformedPoints","_sides","_localSides","isConvex","suppressConvexWarning","_calculateTransformation","_isCounterClockwiseWinding","sum","oldPoint","newPoint","oldDirection","orientation","angleSum","tessellate","polygons","Shape","Polygon","triangulate","triangles","vertices","vertexCount","getPrevIndex","getNextIndex","prev","va","vb","vc","leftArm","rightArm","convexVertices","isPointInTriangle","ab","bc","ca","ap","bp","cp","cross1","cross2","cross3","findEarTip","isEar","cutEarTip","getTransformedPoints","currentSide","mostDirection","testRay","intersectCount","sideIndex","pts","POSITIVE_INFINITY","faceIndex","_cachedMass","_cachedInertia","denominator","iplusone","crossTerm","contactSide","minContactTime","contactIndex","contactTime","scalar","Box","Circle","Edge","Capsule","ColliderComponent","$colliderAdded","$colliderRemoved","_collidersToRemove","_collider","processColliderRemoval","flipped","precollision","Actor","onPreCollisionResolve","postcollision","onPostCollisionResolve","onCollisionStart","onCollisionEnd","useBoxCollider","usePolygonCollider","poly","useCircleCollider","useEdgeCollider","useCompositeCollider","DegreeOfFreedom","__oldTransformCaptured","enableFixedUpdateInterpolate","_sleeping","bounciness","friction","useGravity","limitDegreeOfFreedom","_oldGlobalPos","oldVel","oldAcc","_impulseScratch","_distanceFromCenterScratch","_bodyConfig","config","updatePhysicsConfig","_mass","_DEFAULT_CONFIG","canSleep","updateDefaultPhysicsConfig","newMass","_cachedInverseInertia","inverseMass","sleeping","setSleeping","updateMotion","currentMotion","maybeCollider","inverseInertia","oldGlobalPos","oldRotation","oldScale","applyImpulse","impulse","finalImpulse","X","Y","Rotation","distanceFromCenter","applyLinearImpulse","applyAngularImpulse","captureOldTransform","Rectangle","PointerComponent","useColliderShape","useGraphicsBounds","EasingFunctions","CreateReversibleEasingFunction","easing","CreateVectorEasingFunction","Linear","startValue","endValue","EaseInQuad","EaseOutQuad","EaseInOutQuad","EaseInCubic","EaseOutCubic","EaseInOutCubic","ActionQueue","_actions","_currentAction","_completedActions","_entity","clearActions","getActions","getIncompleteActions","getCurrentAction","hasNext","isComplete","_ACTION_ID","nextActionId","repeatBuilder","repeat","_stopped","_repeatBuilder","_repeatContext","ActionContext","_actionQueue","getQueue","_repeat","_originalRepeat","RepeatForever","lerp","lerpAngle","startAngle","endAngle","shortestPathIsPositive","distance1","distance2","shortDistance","longDistance","lerpVector","inverseLerp","inverseLerpVector","remap","minSource","maxSource","minDestination","maxDestination","remapVector","isMoveByOptions","MoveByWithOptions","_started","_easing","_tx","_motion","_durationMs","_currentMs","_start","_end","currentPos","newPosX","newPosY","velX","velY","MoveBy","_distance","isMoveToOptions","MoveToWithOptions","MoveTo","destX","destY","isRotateToOptions","RotateToWithOptions","_endAngle","_startAngle","_rotationType","rx","RotateTo","_currentNonCannonAngle","_shortDistance","_longDistance","_shortestPathIsPositive","_direction","distanceTraveled","isRotateByOptions","angleRadiansOffset","RotateByWithOptions","RotateBy","isScaleToOptions","ScaleToWithOptions","_endScale","_startScale","newScale","ScaleTo","speedX","speedY","_endX","_endY","_speedX","_speedY","_startX","_startY","_distanceX","_distanceY","directionX","directionY","isScaleByOptions","scaleOffset","ScaleByWithOptions","_scaleOffset","ScaleBy","scaleOffsetX","scaleOffsetY","_directionX","_directionY","CallMethod","method","_hasBeenCalled","_method","EaseTo","easingFcn","_currentLerpTime","_lerpDuration","_lerpStart","_lerpEnd","EaseBy","Blink","timeVisible","timeNotVisible","numBlinks","_timeVisible","_timeNotVisible","_elapsedTime","_totalTime","Fade","endOpacity","_multiplier","_endOpacity","_remainingTime","_originalTime","Delay","_delay","Die","ActionsComponent","Follow","entityToFollow","followDistance","_followTx","_followMotion","_maximumDistance","_distanceBetween","actorToFollowSpeed","Meet","actor","actorToMeet","_speedWasSpecified","_meetTx","_meetMotion","actorToMeetSpeed","Flash","_total","_currentDuration","_material","BezierCurve","_distLookup","controlPoints","_controlPoints","_calculateLookup","arcLength","_arcLength","setControlPoint","totalLength","pt","_getTimeGivenDistance","getTangent","timeSquared","p1","p2","p3","getUniformTangent","desiredDistance","uniformTime","getNormal","getUniformNormal","getUniformPoint","CurveTo","_mode","_curve","mode","CurveBy","_queue","runAction","curveBy","curveTo","easeTo","easeBy","xOrPosOrOptions","yOrSpeed","speedOrUndefined","moveBy","xOffsetOrVectorOrOptions","yOffsetOrSpeed","xOffset","yOffset","rotateTo","angleRadiansOrOptions","rotateBy","angleRadiansOffsetOrOptions","scaleTo","sizeXOrVectorOrOptions","sizeYOrSpeed","speedXOrUndefined","speedYOrUndefined","sizeX","sizeY","scaleBy","sizeOffsetXOrVectorOrOptions","sizeOffsetYOrSpeed","sizeOffsetX","sizeOffsetY","blink","flash","die","callMethod","times","repeatForever","follow","meet","toPromise","_getCtx","xOffsetOrVectorOptions","isActor","ActorEvents","CollisionStart","CollisionEnd","PreCollision","PostCollision","PreKill","PostKill","PreDraw","PostDraw","PreTransformDraw","PostTransformDraw","PreDebugDraw","PostDebugDraw","PointerUp","PointerDown","PointerEnter","PointerLeave","PointerMove","PointerCancel","Wheel","PointerDrag","PointerDragEnd","PointerDragEnter","PointerDragLeave","PointerDragMove","EnterViewPort","ExitViewPort","ActionStart","ActionComplete","thePos","theVel","theAcc","theAngle","_handleAnchorChange","_handleOffsetChange","isOffScreen","draggable","_draggable","isDraggable","_pointerDragStartHandler","_pointerDragEndHandler","_pointerDragMoveHandler","_pointerDragLeaveHandler","_dragging","pe","defaults","_silenceWarnings","pointer","actions","Passive","builtInComponents","_prekill","onPreKill","_postkill","onPostKill","unkill","newZ","getGlobalPos","localCenter","getGlobalScale","getGlobalRotation","recurse","geom","containment","within","otherCollider","me","isScreenElement","ScreenElement","useWorld","coords","Timer","_complete","_totalTimeAlive","_running","_numberOfTicks","interval","repeats","maxNumberOfRepeats","randomRange","_baseInterval","_generateRandomInterval","fcn","numberOfRepeats","_MAX_ID","_callbacks","newInterval","newNumberOfRepeats","timesRepeated","getTimeRunning","timeToNextAction","timeElapsedTowardNextAction","isRunning","cancelTimer","ParallaxComponent","parallaxFactor","DebugGraphicsComponent","useTransform","hasNestedEvents","_dispatchPointerEvents","_processPointerToObject","PointerTargetObjectProxy","init","PointerEventsToObjectDispatcher","_proxyPool","_objectToProxy","_proxies","_lastFrameObjectToPointers","_currentFrameObjectToPointers","addObject","proxy","_getProxy","removeObject","_objectCurrentlyUnderPointer","pointerId","_objectWasUnderPointer","_entered","addPointerToObject","maybeProxy","_addPointerToProxy","pointers","dispatchEvents","receiver","sortedObjects","lastFrameEntities","currentFrameEntities","lastMovePerPointer","lastUpPerPointer","lastDownPerPointer","_processDownAndEmit","_processUpAndEmit","_processMoveAndEmit","lastUpDownMoveEvents","_processEnterLeaveAndEmit","_processCancelAndEmit","_processWheelAndEmit","processPointerToObject","objectIndex","currentFramePointerCoords","currentFrameDown","isDragStart","currentFrameUp","isDragEnd","currentFrameMove","isDragging","currentFrameCancel","currentFrameWheel","TileMapEvents","TileMap","flagCollidersDirty","_collidersDirty","flagTilesDirty","tiles","tileWidth","tileHeight","_token","_rows","_cols","renderFromTopOfGraphic","meshingLookBehind","_oldRotation","_originalOffsets","WeakMap","debugFlags","_composite","_oldPos","_oldScale","_pointerEventDispatcher","currentCol","tile","Tile","_getOrSetColliderOriginalOffset","originalOffset","_updateColliders","shareEdges","checkAndCombine","maxLookBack","solid","defaultGeometry","getTileByIndex","getTile","getTileByPoint","_getTileCoordinates","getRows","getColumns","getOnScreenTiles","maybeParallax","oneMinusFactor","parallaxOffset","currentScene","tileStartX","tileStartY","tileEndX","tileEndY","graphicsIndex","graphicsLen","offsets","getGraphicsOffsets","getGraphics","gfx","showAll","showGrid","gridColor","gridWidth","showSolidBounds","showColliderBounds","solidBoundsColor","colliderBoundsColor","showColliderGeometry","tilemap","geometryColor","geometryLineWidth","geometryPointSize","pointSize","_posDirty","_recalculate","_solid","_offsets","addGraphic","removeGraphic","clearGraphics","geometryPos","_geometry","_bounds","StrategyContainer","lockToActor","addStrategy","LockCameraToActorStrategy","lockToActorAxis","LockCameraToActorAxisStrategy","elasticToActor","cameraElasticity","cameraFriction","ElasticToActorStrategy","radiusAroundActor","RadiusAroundActorStrategy","limitCameraBounds","box","LimitCameraBoundsStrategy","Axis","cam","_eng","currentFocus","getFocus","cameraVel","stretch","boundSizeChecked","focusX","focusY","CameraEvents","Camera","_cameraStrategies","dz","az","_angularVelocity","_posChanged","_cameraMoving","_isShaking","_shakeMagnitudeX","_shakeMagnitudeY","_shakeDuration","_elapsedShakeTime","_xShake","_yShake","_isZooming","_zoomStart","_zoomEnd","_currentZoomTime","_zoomDuration","_zoomEasing","_halfWidth","_halfHeight","_snapPos","hasChanged","_follow","ax","ay","move","easingFn","_lerpPromise","_lerpResolve","shake","magnitudeX","magnitudeY","zoomOverTime","_zoomPromise","_zoomResolve","cameraStrategy","removeStrategy","clearAllStrategies","_screen","currentRes","loadingComplete","res","updateTransform","runStrategies","newZoom","zoomEasing","lerpPoint","moveEasing","_isDoneShaking","fixedUpdateTimestep","blend","currentFrameLagMs","interpolatedPos","snapPos","newCanvasWidth","newCanvasHeight","cameraPos","TriggerEvents","ExitTrigger","EnterTrigger","Trigger","_matchesTarget","_dispatchAction","SystemPriority","Highest","Higher","Average","Lower","Lowest","SystemType","System","EntityManager","_world","entities","_entityIndex","_childAddedHandlerMap","_childRemovedHandlerMap","_createChildAddedHandler","addEntity","_createChildRemovedHandler","removeEntity","_entitiesToRemove","updateEntities","entityIndex","findEntitiesForRemoval","queryManager","childAdded","childRemoved","idOrEntity","childAddedHandler","childRemovedHandler","currFrame","actors","killed","processEntityRemovals","processComponentRemovals","getById","getByName","Query","requiredComponents","entityAdded$","entityRemoved$","checkAndAdd","getEntities","TagQuery","QueryManager","_queries","_addComponentHandlers","_removeComponentHandlers","_componentToQueriesIndex","_tagQueries","_addTagHandlers","_removeTagHandlers","_tagToQueriesIndex","_createAddComponentHandler","_createRemoveComponentHandler","_createAddTagHandler","_createRemoveTagHandler","createQuery","queries","createTagQuery","maybeAddComponent","maybeRemoveComponent","maybeAddTag","maybeRemoveTag","tagQuery","isSystemConstructor","SystemManager","systems","initialized","systemType","addSystem","systemOrCtor","system","removeSystem","updateSystems","preupdate","postupdate","entityManager","systemManager","queryTags","Update","entityOrSystem","clearEntities","clearSystems","MotionSystem","world","_physicsConfigDirty","$configUpdate","optionalBody","captureOldTransformWithChildren","ArcadeSolver","directionMap","distanceMap","solve","preSolve","aDir","bDir","aDist","bDist","solvePosition","solveVelocity","postSolve","opposite","velAdj","ContactConstraintPoint","normalImpulse","tangentImpulse","normalMass","tangentMass","aToContact","bToContact","originalVelocityAndRestitution","aToContactNormal","bToContactNormal","aToContactTangent","bToContactTangent","getRelativeVelocity","velA","RealisticSolver","lastFrameContacts","idToContactConstraint","getContactConstraints","finishedContactIds","contactPoints","pointIndex","restitution","relativeVelocity","constraints","maxCorrection","steeringForce","impulseForce","impulseDelta","maxFriction","newImpulse","normalVelocity","CollisionSystem","_processor","_physics","collisionProcessor","_configDirty","_lastFrameContacts","_currentFrameContacts","_arcadeSolver","_realisticSolver","_trackCollider","_untrackCollider","colliderComponent","_motionSystem","colliderComp","compositeColliders","getSolver","step","compositeId","substring","runContactStartEnd","Realistic","blendTransform","oldTx","newTx","oldTxWithNewParent","oldGlobalScale","oldGlobalRotation","interpolatedScale","interpolatedRotation","GraphicsSystem","sortedTransforms","_sortedTransforms","Draw","_zHasChanged","_zIndexUpdate","_targetInterpolationTransform","transformIndex","parallax","_applyTransform","_applyOpacity","_drawGraphicsComponent","graphicsComponent","transformComponent","oldFlipHorizontal","oldFlipVertical","isDebug","showBounds","boundsColor","ancestors","ancestor","maybeGraphics","DebugSystem","_collisionSystem","filterSettings","entitySettings","txSettings","motionSettings","colliderSettings","physicsSettings","graphicsSettings","debugDraw","bodySettings","cameraSettings","useFilter","ids","nameQuery","cursor","_pushCameraTransform","debugZIndex","showPosition","positionColor","showPositionLabel","showZIndex","showId","showName","showRotation","rotationColor","showScale","scaleColor","showCollisionGroup","showCollisionType","showMass","showMotion","showSleeping","showVelocity","velocityColor","showAcceleration","accelerationColor","showGeometry","showOwner","_popCameraTransform","showBroadphaseSpacePartitionDebug","showCollisionContacts","showCollisionNormals","contactSize","collisionContactColor","collisionNormalColor","showFocus","focusColor","showZoom","HashGridProxy","gridSize","cells","hasZeroBounds","leftX","rightX","bottomY","topY","cell","proxies","updateBounds","HashGridCell","calculateHashKey","_hashGridCellPool","instance","objectToProxy","proxyFactory","_buildProxy","boundsOrPoint","xCoord","yCoord","proxyIndex","cellIndex","transparent","PointerSystem","_graphicsHashGrid","_entityToPointer","overrideUseColliderShape","overrideUseGraphicsBounds","_sortedEntities","screenPos","maybeGfx","_scene","_receivers","_engineReceiver","maybePointer","ActionsSystem","IsometricEntityComponent","mapOrOptions","elevation","IsometricEntitySystem","iso","OffscreenSystem","_worldBounds","entityOffscreen","_isOffscreen","transformedBounds","HashColliderProxy","SparseHashGridCollisionProcessor","_nonPairs","_pairPool","hashGrid","unitRay","dydx","dxdy","unitStepX","unitStepY","startXCoord","startYCoord","stepDir","currentXCoord","currentYCoord","currentRayLengthX","currentRayLengthY","collidersVisited","maxIterations","cellHits","colliderIndex","hit1","hit2","compColliders","_canCollide","proxyId","otherIndex","PhysicsWorld","newConfig","Gamepads","_gamePadTimeStamps","_oldPads","_pads","_initSuccess","_navigator","_minimumConfiguration","_enabled","_clonePads","toggleEnabled","setMinimumGamepadConfiguration","_enableAndUpdate","_isGamepadValid","pad","axesLength","buttonLength","buttons","connected","at","timestamp","navigatorGamepad","buttonIndex","getButton","pressed","updateButton","Buttons","Unknown","axesIndex","getAxes","updateAxes","_clonePad","Gamepad","getValidGamepads","pads","arr","clonedPad","MinAxisMoveThreshold","_axes","_buttons","_buttonsUp","_buttonsDown","isButtonPressed","isButtonHeld","wasButtonPressed","wasButtonReleased","Boolean","Axes","Keys","InputMapper","inputs","_handlers","command","inputHandler","commandHandler","isCrossOriginIframe","noop","KeyEvent","originalEvent","Keyboard","_keys","_keysUp","_keysDown","_releaseAllKeys","ev","code","keyEvent","_handleKeyDown","metaKey","MetaLeft","MetaRight","_handleKeyUp","keyboardOptions","global","grabWindowFocus","getKeys","wasPressed","isHeld","wasReleased","triggerEvent","character","KeyboardEvent","GlobalCoordinates","fromPagePosition","xOrPos","yOrEngine","engineOrUndefined","pageX","pageY","PointerEvent","coordinates","pointerType","nativeEvent","WheelEvent","screenX","screenY","deltaZ","deltaMode","PointerAbstraction","lastPagePos","lastScreenPos","lastWorldPos","_onPointerMove","_onPointerDown","_updateWorldPosition","WheelDeltaMode","NativePointerButton","PointerButton","PointerType","PointerEventReceiver","primary","_activeNativePointerIdsToNormalized","lastFramePointerCoords","currentFramePointerDown","lastFramePointerDown","_pointers","_boundHandle","_handle","_boundWheel","_handleWheel","recreate","eventReceiver","isDown","wasDown","native","isDisposed","touchAction","wheelOptions","passive","pageScrollPreventionMode","ScrollPreventionMode","onmousewheel","grabFocus","detach","_normalizePointerId","nativePointerId","findIndex","preventDefault","eventCoords","globalThis","TouchEvent","Touch","changedTouches","_nativeButtonToPointerButton","Mouse","isPointerEvent","_stringToPointerType","ScrollWheelNormalizationFactor","wheelDeltaX","wheelDeltaY","wheelDelta","detail","Line","Page","we","page","clientX","clientY","MouseEvent","pointerSystem","NoButton","Middle","Pen","InputHost","pointerTarget","keyboard","inputMapper","PreLoadEvent","SceneEvents","Activate","Deactivate","PreLoad","isSceneConstructor","Scene","triggers","tileMaps","timers","_timers","_cancelQueue","onPreLoad","loader","onTransition","onActivate","onDeactivate","_initializeChildren","pointerScope","director","getSceneName","_activate","_deactivate","_predraw","_postdraw","removeTimer","timer","_collectActorStats","addTimer","transfer","isTimerActive","isCurrentScene","ui","alive","ColorBlindnessMode","ScreenShader","ColorBlindnessPostProcessor","_colorBlindnessMode","simulate","_simulate","colorBlindnessMode","colorBlindMode","Protanope","Deuteranope","Tritanope","ColorBlindFlags","_colorBlindPostProcessor","correct","colorBlindness","DebugConfig","FrameStats","prevFrame","isometric","positionSize","useTestClock","wasRunning","testClock","toTestClock","useStandardClock","currentClock","standardClock","toStandardClock","_id","_elapsedMs","_fps","_actorStats","remaining","_durationStats","_physicsStats","PhysicsStats","_graphicsStats","drawCalls","drawnImages","otherStats","elapsedMs","fps","fs","_collisions","_contacts","_fastBodies","_fastBodyCollisions","_broadphase","_narrowphase","ps","BrowserComponent","_nativeHandlers","_decorate","BrowserEvents","_windowGlobal","_documentGlobal","_windowComponent","_documentComponent","DefaultAntialiasOptions","nativeContextAntialiasing","DefaultPixelArtOptions","FpsSampler","_samplePeriod","_currentFrameTime","_frames","_previousSampleTime","_beginFrameTime","initialFps","samplePeriod","_nowFn","nowFn","instant","Clock","_onFatalException","_maxFps","_lastTime","_elapsed","_scheduledCbs","_totalElapsed","maxFps","onFatalException","fpsSampler","TestClock","defaultUpdateMs","StandardClock","setFatalExceptionHandler","timeoutMs","timing","scheduledTime","__runScheduledCbs","overrideUpdateMs","fpsInterval","leftover","mainloop","_requestId","_currentTime","_updateMs","run","numberOfSteps","Toaster","_toasterCss","_container","_createFragment","toastMessage","innerText","toast","linkTarget","linkName","className","messageFragments","link","href","finalMessage","dismissBtn","keydownHandler","first","firstChild","insertBefore","DirectorEvents","NavigationStart","Navigation","NavigationEnd","Director","isTransitioning","_isTransitioning","scenes","_sceneToInstance","_sceneToLoader","_sceneToTransition","_loadedScenes","rootScene","currentSceneName","sceneKey","sceneOrOptions","getSceneInstance","_deferredGoto","deferredScene","deferredTransition","_deferredTransition","deferredSceneInstance","_addToTargetScene","swapScene","playTransition","configureStart","startScene","maybeLoaderOrCtor","maybeStartTransition","mainLoader","inTransition","startSceneInstance","_getLoader","sceneName","_getInTransition","sceneOrRoute","_getOutTransition","out","getDeferredScene","maybeDeferred","getSceneDefinition","maybeScene","assertAdded","assertRemoved","outTransition","nameOrScene","sceneOrCtor","potentialSceneOrOptions","goToScene","destinationScene","maybeDest","sourceSceneInstance","sourceScene","engineInputEnabled","maybeSourceOut","maybeDestinationIn","sourceOut","destinationIn","sceneActivationData","hideLoader","maybeLoadScene","_emitEvent","onPreviousSceneDeactivate","sceneDefinition","newScene","sceneToLoad","sceneToLoadInstance","transition","targetScene","currentTransition","sceneInputEnabled","blockInput","_play","previousScene","nextScene","destLoader","sourceName","destinationName","createContext","scope","old","useContext","DefaultGarbageCollectionOptions","textureCollectInterval","GarbageCollector","_collectionMap","_collectors","collectStaleResources","deadline","collector","timeoutInterval","getTimestamp","resourceType","_collectHandle","collect","collectionData","forceCollectAll","EngineEvents","FallbackGraphicsContext","Visible","Hidden","Start","PreFrame","PostFrame","EmitterType","Engine","useEngine","Context","_isDebug","shouldSnapToPixel","version","EX_VERSION","_inputEnabled","_suppressPlayButton","enableCanvasTransparency","stack","_toaster","_timescale","_handleWebGLContextLost","container","flexDirection","borderStyle","div","innerHTML","querySelector","reload","_performanceThresholdTriggered","_fpsSamples","_isLoading","_hideLoader","_isReadyFuture","currentFrameElapsedMs","_lagMs","_screenShotRequests","_DEFAULT_ENGINE_OPTIONS","detector","suppressMinimumBrowserFeatureDetection","_compatible","testMessage","canvasElementId","suppressConsoleBootMessage","garbageCollection","garbageCollectorConfig","enableCanvasContextMenu","_originalDisplayMode","pixelArt","suppressHiDPIScaling","fixedUpdateFps","_mainloop","___EXCALIBUR_DEVTOOL","InstanceCount","_monitorPerformanceThresholdAndTriggerFallback","allow","configurePerformanceCanvas2DFallback","showPlayerMessage","numberOfFrames","useCanvas2DFallback","newCanvas","cloneNode","parentNode","replaceChild","Document","timescale","addScene","removeScene","scrollPreventionMode","visibilityState","toggleInputEnabled","_overrideInitialize","_update","_loader","_draw","_checkForScreenShots","toggle","toggleDebug","isReady","sceneNameOrLoader","frameId","beforeUpdate","fixedTimestepMs","afterUpdate","afterDraw","screenshot","preserveHiDPIResolution","finalWidth","finalHeight","raw","Label","newFont","spriteFont","sf","getTextWidth","ParticleEmitter","_particlesToEmit","_particlePool","numParticles","isEmitting","deadParticles","emitRate","emitterType","randomRotation","_activeParticles","emitParticles","particleCount","_createParticle","clearParticles","ranX","ranY","minAngle","maxAngle","minSpeed","maxSpeed","minSize","maxSize","assert","expression","GpuParticleRenderer","_vaos","_buffers","_drawIndex","_numInputFloats","_particleIndex","_uploadIndex","_wrappedLife","_wrappedParticles","_particleLife","_clearRequested","_emitted","_particleData","maxParticles","_random","numInputFloats","particleData","particleDataBuffer1","vao1","bytesPerFloat","particleDataBuffer2","vao2","_currentVao","_currentBuffer","startIndex","endIndex","_uploadEmitted","bindBufferBase","TRANSFORM_FEEDBACK_BUFFER","bindBufferRange","beginTransformFeedback","endTransformFeedback","GPU_MAX_PARTICLES","GpuParticleEmitter","IsometricTile","_gfx","_recalculateBounds","_tileBounds","graphicsOffset","tileToWorld","_isometricEntityComponent","halfTileWidth","halfTileHeight","yPos","totalWidth","totalHeight","IsometricMap","updateColliders","worldToTile","worldCoordinate","tileCoordinate","tileCoord","_getMaxZIndex","maxZ","NEGATIVE_INFINITY","currentZ","ActionSequence","actionBuilder","_sequenceBuilder","_sequenceContext","ParallelActions","parallelActions","every","QuadTree","_defaultOptions","maxDepth","capacity","items","_isDivided","halfWidth","halfHeight","_split","newLevelOptions","_insertIntoSubNodes","insert","getAllItems","getTreeDepth","has_initialize","has_add","has_remove","hasOnInitialize","has_preupdate","hasOnPreUpdate","has_postupdate","hasOnPostUpdate","hasOnAdd","hasOnRemove","hasPreDraw","hasPostDraw","Gif","_sprites","_stream","Stream","_gif","GifParser","toSpriteSheet","toAnimation","delayMs","_animation","readCheckBytes","checkBytes","bitsToNum","ba","byteToBitArr","bite","dataArray","readByte","byteLength","readBytes","bytes","read","fromCharCode","readUnsigned","Uint8Array","stream","_handler","globalColorTableBytes","parseColorTableBytes","colorTable","rgb","_st","readSubBlocks","parseHeader","hdr","sig","ver","colorResolution","globalColorTableSize","gctFlag","sortedFlag","globalColorTable","backgroundColorIndex","pixelAspectRatio","_currentFrameCanvas","bits","parseExt","block","parseGCExt","reserved","disposalMethod","userInputFlag","transparentColorFlag","delayTime","transparentColorIndex","terminator","gce","parseComExt","comment","com","parsePTExt","ptHeader","ptData","pte","parseAppExt","parseNetscapeExt","unknown","iterations","app","NETSCAPE","parseUnknownAppExt","appData","identifier","authCode","parseUnknownExt","label","extType","_gce","parseImg","img","leftPos","topPos","lctFlag","interlaced","sorted","lctSize","lctBytes","lzwMinCodeSize","lzwData","pixels","minCodeSize","readCode","charCodeAt","output","clearCode","eoiCode","codeSize","dict","last","lzwDecode","newPixels","cpRow","toRow","fromRow","fromPixels","steps","pass","deinterlace","arrayToImage","parseBlocks","sentinel","eof","frame","imageData","getImageData","pixel","colorIndex","putImageData","_currentFrameContext","_hdr","bg","FontSource","_isLoaded","FontFace","fonts","toFont","InsideCoroutineContext","generatorFunctionDeclaration","isCoroutineGenerator","Function","coroutine","coroutineGenerator","thisArg","passedEngine","inside","autostart","started","completed","cancelled","generatorFcn","generator","co","iterator","Transition","_currentProgress","_completeFuture","_currentDistance","updateTransition","onStart","onEnd","onReset","_co","_execute","FadeInOut","screenCover","CrossFade","_progress","Slide","slideDirection","easingFunction","_vectorEasing","_screenCover","_directionOffset","_destinationCameraPosition","_startCameraPosition","_calculateBounds","lineNormal","halfThickness","minPoint","NineSliceStretch","NineSlice","_imgSource","_canvasA","_canvasB","_canvasC","_canvasD","_canvasE","_canvasF","_canvasG","_canvasH","_canvasI","setTargetWidth","auto","setTargetHeight","setMargins","sourceConfig","leftMargin","topMargin","rightMargin","bottomMargin","setStretch","destinationConfig","horizontalStretch","verticalStretch","getConfig","_drawTile","targetCanvas","destinationSize","marginWidth","marginHeight","tempMarginW","tempMarginH","tempSizeX","tempPositionX","tempSizeY","tempPositionY","numTilesX","_getNumberOfTiles","numTilesY","tempSize","tempPosition","_calculateParams","drawCenter","_sourceSprite","aCtx","bCtx","cCtx","dCtx","eCtx","fCtx","gCtx","hCtx","iCtx","tileSize","Stretch","TileFit","tileNum","numTiles","reducedTileSize","TiledAnimation","animation","_tiledWidth","_tiledHeight","_sourceView","promises","tiledSprite","fromAnimation","_updateSourceView","_updateWidthHeight","maxMessages","obsoleteMessage","resetObsoleteCounter","logMessage","suppressObsoleteMessages","showStackTrace","obsolete","alternateMethod","property","descriptor","SyntaxError","DecoratedClass","AsyncWaitQueue","enqueue","dequeue","Semaphore","_count","_waitQueue","waiting","enter","exit"],"sourceRoot":""}